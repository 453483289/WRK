<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Windows Research Kernel v1.2: C:/Windows Research Kernel/rtl/sertl.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Windows Research Kernel v1.2
   </div>
   <div id="projectbrief">Have fun :)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d3/d32/a02665_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">sertl.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d3/d32/a02665.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">Copyright (c) Microsoft Corporation. All rights reserved. </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">You may only use this code if you agree to the terms of the Windows Research Kernel Source Code License agreement (see License.txt).</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">If you do not agree to the terms, do not use the code.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">Module Name:</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">    sertl.c</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">Abstract:</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">    This Module implements many security rtl routines defined in ntseapi.h</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/d7d/a02656.html">ntrtlp.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d3/dc5/a02306.html">winerror.h</a>&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../dd/d3b/a02291.html">stdio.h</a>&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../df/d4d/a02285.html">seopaque.h</a>&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/d2d/a02286.html">sertlp.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;..\se\sep.h&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#undef RtlEqualLuid</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<a class="code" href="../../dd/d67/a02230.html#ad2051345e0b0a20c9c5770f56f75278c">NTSYSAPI</a></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a9b3a762f8b8db86e6cb243f4af6d87ac">NTAPI</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<a class="code" href="../../d3/d32/a02665.html#af002fe57526a71b69dcb65d6b21be224">RtlEqualLuid</a> (</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <a class="code" href="../../de/dc8/a00889.html">PLUID</a> Luid1,</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <a class="code" href="../../de/dc8/a00889.html">PLUID</a> Luid2</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    );</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<a class="code" href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833">RtlpConvertAclToAutoInherit</a> (</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ParentAcl <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ChildAcl,</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> *ObjectType OPTIONAL,</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid,</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *NewAcl,</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    );</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<a class="code" href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30">RtlpCopyEffectiveAce</a> (</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce,</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> WillGenerateInheritAce,</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> *AcePosition,</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceLength,</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited OPTIONAL,</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> EffectiveAceMapped,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> AclOverflowed</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    );</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">   70</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc">   71</a></span>&#160;     <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc">CopyInheritedAces</a>,</div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">   72</a></span>&#160;     <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">CopyNonInheritedAces</a>,</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">   73</a></span>&#160;     <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a> } <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">ACE_TYPE_TO_COPY</a>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">ACE_TYPE_TO_COPY</a> AceTypeToCopy,</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> AceFlagsToReset,</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> MapSids,</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> RetainInheritedAceBit,</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAclSizeParam,</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    );</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<a class="code" href="../../d3/d32/a02665.html#aaffde88bf4e473523c3f45c208dd97b3">RtlpGenerateInheritedAce</a> (</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce,</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceLength,</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceExtraLength,</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    );</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a73ffe8bc02593f93e294cf9ceaa9e84a">RtlpGenerateInheritAcl</a>(</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAclSizeParam,</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    );</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<a class="code" href="../../d3/d32/a02665.html#aeaa146ca19ac4714659beabac108326a">RtlpInheritAcl2</a> (</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> DirectoryAcl,</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ChildAcl,</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ChildGenericControl,</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DefaultDescriptorForObject,</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid,</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> AclBufferSize,</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> AclBuffer,</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> NewAclExplicitlyAssigned,</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    );</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<a class="code" href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472">RtlpComputeMergedAcl</a> (</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentAcl,</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CurrentGenericControl,</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ModificationAcl,</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ModificationGenericControl,</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *NewAcl,</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    );</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae38867c753fcc5b5e3a162cec8c60fa1">RtlpComputeMergedAcl2</a> (</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentAcl,</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CurrentGenericControl,</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ModificationAcl,</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ModificationGenericControl,</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> AclBufferSize,</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> AclBuffer,</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    );</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed">RtlpCompareAces</a>(</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> InheritedAce,</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> ChildAce,</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    );</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a98fa21d2d8124ffe917105ea7cd6338b">RtlpCompareKnownObjectAces</a>(</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a> InheritedAce,</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a> ChildAce,</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid OPTIONAL</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    );</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a33f46ef50693a7e87038c3bdb4990aaa">RtlpCompareKnownAces</a>(</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> InheritedAce,</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> ChildAce,</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid OPTIONAL</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    );</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9">RtlpIsDuplicateAce</a>(</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> NewAce</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    );</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<a class="code" href="../../d3/d32/a02665.html#ade7b3318164b177270351c77baa8d79f">RtlpGuidPresentInGuidList</a>(</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> *InheritedObjectType,</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType,</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    );</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0">RtlpCreateServerAcl</a>(</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclUntrusted,</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerSid,</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *ServerAcl,</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *ServerAclAllocated</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    );</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<a class="code" href="../../d3/d32/a02665.html#a8fed5f76147b0dcc56e7926a15807990">RtlpGetDefaultsSubjectContext</a>(</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> ClientToken,</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d0/d78/a01745.html">PTOKEN_OWNER</a> *OwnerInfo,</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d5/dfa/a01746.html">PTOKEN_PRIMARY_GROUP</a> *GroupInfo,</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d0/d4e/a01741.html">PTOKEN_DEFAULT_DACL</a> *DefaultDaclInfo,</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d0/d78/a01745.html">PTOKEN_OWNER</a> *ServerOwner,</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d5/dfa/a01746.html">PTOKEN_PRIMARY_GROUP</a> *ServerGroup</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    );</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> <a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   Offset,</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   <a class="code" href="../../d8/d51/a02244.html#a1eba21559f17793c695f34f7e4787604">Length</a>,</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   MinLength,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> MaxLength</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    );</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<a class="code" href="../../d3/d32/a02665.html#aa7894911d24d33ceed9f7b781bbe81ca">RtlValidRelativeSecurityDescriptor</a> (</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptorInput,</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SecurityDescriptorLength,</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a923cbf88fdb4b0381d8e3c837656c0b2">SECURITY_INFORMATION</a> RequiredInformation</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    );</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<a class="code" href="../../d3/d32/a02665.html#ab4216159656088d3e13d13a6d5f6d1b1">RtlpImpersonateSelfEx</a> (</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a0841cdb9e3ad77ad9a0fe50e05026401">SECURITY_IMPERSONATION_LEVEL</a> ImpersonationLevel,</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> AdditionalAccess,</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a75af6aee35551eeff024eb003e8eee22">PHANDLE</a> ThreadToken <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    );</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">#if defined(ALLOC_PRAGMA)</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlRunEncodeUnicodeString)</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlRunDecodeUnicodeString)</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlEraseUnicodeString)</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlAdjustPrivilege)</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlValidSid)</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlEqualSid)</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlEqualPrefixSid)</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlLengthRequiredSid)</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlInitializeSid)</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlIdentifierAuthoritySid)</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSubAuthoritySid)</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSubAuthorityCountSid)</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlLengthSid)</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCopySid)</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCopySidAndAttributesArray)</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlLengthSidAsUnicodeString)</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlConvertSidToUnicodeString)</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlEqualLuid)</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCopyLuid)</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCopyLuidAndAttributesArray)</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCreateSecurityDescriptor)</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlCreateSecurityDescriptorRelative)</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlValidSecurityDescriptor)</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlLengthSecurityDescriptor)</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetAttributesSecurityDescriptor)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetControlSecurityDescriptor)</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetControlSecurityDescriptor)</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetDaclSecurityDescriptor)</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetDaclSecurityDescriptor)</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetSaclSecurityDescriptor)</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetSaclSecurityDescriptor)</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetOwnerSecurityDescriptor)</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetOwnerSecurityDescriptor)</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetGroupSecurityDescriptor)</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetGroupSecurityDescriptor)</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlAreAllAccessesGranted)</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlAreAnyAccessesGranted)</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlMapGenericMask)</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpImpersonateSelfEx)</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlImpersonateSelf)</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpApplyAclToObject)</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCopyEffectiveAce)</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCopyAces)</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpGuidPresentInGuidList)</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpInheritAcl2)</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpInheritAcl)</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpGenerateInheritedAce)</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpGenerateInheritAcl)</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpComputeMergedAcl2)</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpComputeMergedAcl)</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpConvertToAutoInheritSecurityObject)</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCompareAces)</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCompareKnownAces)</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCompareKnownObjectAces)</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpConvertAclToAutoInherit)</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpIsDuplicateAce)</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpCreateServerAcl)</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpNewSecurityObject)</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpSetSecurityObject)</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlpValidateSDOffsetAndSize)</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlValidRelativeSecurityDescriptor)</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlGetSecurityDescriptorRMControl)</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor">#pragma alloc_text(PAGE,RtlSetSecurityDescriptorRMControl)</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">//    Local Macros and Symbols                                               //</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">  329</a></span>&#160;<span class="preprocessor">#define CREATOR_SID_SIZE 12</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">  331</a></span>&#160;<span class="preprocessor">#define max(a,b)            (((a) &gt; (b)) ? (a) : (b))</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">// Define an array mapping all ACE types to their base type.</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">// For instance, all allowed ACE types are similar.  As are all denied ACE types.</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="preprocessor">#if defined(ALLOC_DATA_PRAGMA)</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="preprocessor">#pragma const_seg(&quot;PAGECONST&quot;)</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div>
<div class="line"><a name="l00343"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">  343</a></span>&#160;<span class="keyword">const</span> <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[] = {</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a>,    <span class="comment">// ACCESS_ALLOWED_ACE_TYPE (0x0)</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a9081b9116c6cf606b4ccbee0ece39f5d">ACCESS_DENIED_ACE_TYPE</a>,     <span class="comment">// ACCESS_DENIED_ACE_TYPE (0x1)</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a497809e531ff71f06a1bd80ae7782d90">SYSTEM_AUDIT_ACE_TYPE</a>,      <span class="comment">// SYSTEM_AUDIT_ACE_TYPE (0x2)</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a7d9e23f817e83da107625e5e40f99cd7">SYSTEM_ALARM_ACE_TYPE</a>,      <span class="comment">// SYSTEM_ALARM_ACE_TYPE (0x3)</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a>,    <span class="comment">// ACCESS_ALLOWED_COMPOUND_ACE_TYPE (0x4)</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a>,    <span class="comment">// ACCESS_ALLOWED_OBJECT_ACE_TYPE (0x5)</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a9081b9116c6cf606b4ccbee0ece39f5d">ACCESS_DENIED_ACE_TYPE</a>,     <span class="comment">// ACCESS_DENIED_OBJECT_ACE_TYPE (0x6)</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a497809e531ff71f06a1bd80ae7782d90">SYSTEM_AUDIT_ACE_TYPE</a>,      <span class="comment">// SYSTEM_AUDIT_OBJECT_ACE_TYPE (0x7)</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    SYSTEM_ALARM_ACE_TYPE       <span class="comment">// SYSTEM_ALARM_OBJECT_ACE_TYPE (0x8)</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;};</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">// Define an array defining whether an ACE is a system ACE</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ab5f13e236f1a3bb478abc2db92920779">  359</a></span>&#160;<span class="keyword">const</span> <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> <a class="code" href="../../d3/d32/a02665.html#ab5f13e236f1a3bb478abc2db92920779">RtlIsSystemAceType</a>[] = {</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,    <span class="comment">// ACCESS_ALLOWED_ACE_TYPE (0x0)</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,    <span class="comment">// ACCESS_DENIED_ACE_TYPE (0x1)</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,     <span class="comment">// SYSTEM_AUDIT_ACE_TYPE (0x2)</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,     <span class="comment">// SYSTEM_ALARM_ACE_TYPE (0x3)</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,    <span class="comment">// ACCESS_ALLOWED_COMPOUND_ACE_TYPE (0x4)</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,    <span class="comment">// ACCESS_ALLOWED_OBJECT_ACE_TYPE (0x5)</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,    <span class="comment">// ACCESS_DENIED_OBJECT_ACE_TYPE (0x6)</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,     <span class="comment">// SYSTEM_AUDIT_OBJECT_ACE_TYPE (0x7)</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    TRUE      <span class="comment">// SYSTEM_ALARM_OBJECT_ACE_TYPE (0x8)</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;};</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> RtlpVerboseConvert = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6279bc5bce1ac234f1c5c921f581508d">  375</a></span>&#160;<span class="preprocessor">#define SE_VALID_CONTROL_BITS ( SE_DACL_UNTRUSTED | \</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="preprocessor">                                SE_SERVER_SECURITY | \</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="preprocessor">                                SE_DACL_AUTO_INHERIT_REQ | \</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="preprocessor">                                SE_SACL_AUTO_INHERIT_REQ | \</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="preprocessor">                                SE_DACL_AUTO_INHERITED | \</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="preprocessor">                                SE_SACL_AUTO_INHERITED | \</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="preprocessor">                                SE_DACL_PROTECTED | \</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="preprocessor">                                SE_SACL_PROTECTED )</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">//    Null DACL assertions                                                   //</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="preprocessor">#define ASSERT_ON_NULL_DACL 1</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="preprocessor">#ifdef ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> RtlpAssertOnNullDacls;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="preprocessor">#endif // ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">//    Exported Procedures                                                    //</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">//                                                                           //</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l00409"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aa5c7194b0c04c14f10ff963771b65daf">  409</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aa5c7194b0c04c14f10ff963771b65daf">RtlRunEncodeUnicodeString</a>(</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>          Seed        <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">PUNICODE_STRING</a> String</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    )</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">    This function performs a trivial XOR run-encoding of a string.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">    The purpose of this run-encoding is to change the character values</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">    to appear somewhat random and typically not printable.  This is</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">    useful for transforming passwords that you don&#39;t want to be easily</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">    distinguishable by visually scanning a paging file or memory dump.</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">    Seed - Points to a seed value to use in the encoding.  If the</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">        pointed to value is zero, then this routine will assign</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">        a value.</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">    String - The string to encode.  This string may be decode</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">        by passing it and the seed value to RtlRunDecodeUnicodeString().</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">    None - Nothing can really go wrong unless the caller passes bogus</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">        parameters.  In this case, the caller can catch the access</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">        violation.</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;{</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <a class="code" href="../../dc/d5e/a00817.html">LARGE_INTEGER</a> Time;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>        LocalSeed;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a>      <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>         i;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <a class="code" href="../../d4/d41/a01661.html">PSTRING</a>       S;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">// Typecast so we can work on bytes rather than WCHARs</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    S = (<a class="code" href="../../dd/d67/a02230.html#a5ec94aadb53d4c45441b96dacfc08379">PSTRING</a>)((<a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a>)String);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">// If a seed wasn&#39;t passed, use the 2nd byte of current time.</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="comment">// This byte seems to be sufficiently random (by observation).</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">if</span> ((*Seed) == 0) {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        Status = <a class="code" href="../../d8/d6f/a02234.html#a5c1da301e64af190fdfe3a264cd83e91">NtQuerySystemTime</a> ( &amp;Time );</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status));</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        LocalSeed = (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)((<a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a>)&amp;Time);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        i = 1;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        (*Seed) = LocalSeed[ i ];</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="comment">// Occasionally, this byte could be zero.  That would cause the</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// string to become un-decodable, since 0 is the magic value that</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="comment">// causes us to re-gen the seed.  This loop makes sure that we</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="comment">// never end up with a zero byte (unless time is zero, as well).</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <span class="keywordflow">while</span> ( ((*Seed) == 0) &amp;&amp; ( i &lt; <span class="keyword">sizeof</span>( Time ) ) )</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        {</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            (*Seed) |= LocalSeed[ i++ ] ;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        }</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="keywordflow">if</span> ( (*Seed) == 0 )</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        {</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            (*Seed) = 1;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        }</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="comment">// Transform the initial byte.</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">// The funny constant just keeps the first byte from propagating</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">// into the second byte in the next step.  Without a funny constant</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">// this would happen for many languages (which typically have every</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// other byte zero.</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">if</span> (S-&gt;<a class="code" href="../../d4/d41/a01661.html#a42053951503fd821638234bd01a1c6c7">Length</a> &gt;= 1) {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[0] ^= ((*Seed) | 0X43);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    }</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="comment">// Now transform the rest of the string</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">for</span> (i=1; i&lt;S-&gt;<a class="code" href="../../d4/d41/a01661.html#a42053951503fd821638234bd01a1c6c7">Length</a>; i++) {</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        <span class="comment">//  There are export issues that cause us to want to</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="comment">//  keep this algorithm simple.</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="comment">// In order to be compatible with zero terminated unicode strings,</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="comment">//  this algorithm is designed to not produce a wide character of</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="comment">//  zero as long a the seed is not zero.</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="comment">// Simple running XOR with the previous byte and the</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <span class="comment">// seed value.</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[i] ^= (S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[i-1]^(*Seed));</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;}</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l00540"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aaa71d897407ea439b802831ac5128bf4">  540</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aaa71d897407ea439b802831ac5128bf4">RtlRunDecodeUnicodeString</a>(</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>           Seed,</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">PUNICODE_STRING</a> String</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    )</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">    This function performs the inverse of the function performed</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">    by RtlRunEncodeUnicodeString().  Please see RtlRunEncodeUnicodeString()</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">    for details.</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">    Seed - The seed value to use in RtlRunEncodeUnicodeString().</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">    String - The string to reveal.</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">    None - Nothing can really go wrong unless the caller passes bogus</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="comment">        parameters.  In this case, the caller can catch the access</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="comment">        violation.</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;{</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        i;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <a class="code" href="../../d4/d41/a01661.html">PSTRING</a></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        S;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="comment">// Typecast so we can work on bytes rather than WCHARs</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    S = (<a class="code" href="../../dd/d67/a02230.html#a5ec94aadb53d4c45441b96dacfc08379">PSTRING</a>)((<a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a>)String);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="comment">// Transform the end of the string</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">for</span> (i=S-&gt;<a class="code" href="../../d4/d41/a01661.html#a42053951503fd821638234bd01a1c6c7">Length</a>; i&gt;1; i--) {</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="comment">// a simple running XOR with the previous byte and the</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="comment">// seed value.</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[i-1] ^= (S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[i-2]^Seed);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    }</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">// Finally, transform the initial byte</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordflow">if</span> (S-&gt;<a class="code" href="../../d4/d41/a01661.html#a42053951503fd821638234bd01a1c6c7">Length</a> &gt;= 1) {</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        S-&gt;<a class="code" href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">Buffer</a>[0] ^= (Seed | 0X43);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;}</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l00616"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aac77f8c085cee324134056c01f2a53db">  616</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aac77f8c085cee324134056c01f2a53db">RtlEraseUnicodeString</a>(</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">PUNICODE_STRING</a> String</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    )</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="comment">    This function scrubs the passed string by over-writing all</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">    characters in the string.  The entire string (i.e., MaximumLength)</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">    is erased, not just the current length.</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="comment">    String - The string to be erased.</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">    None - Nothing can really go wrong unless the caller passes bogus</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">        parameters.  In this case, the caller can catch the access</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">        violation.</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;{</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordflow">if</span> ((String-&gt;<a class="code" href="../../dd/d00/a01776.html#afbc2ba2b7be88d0118e683a2eb289795">Buffer</a> == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (String-&gt;<a class="code" href="../../dd/d00/a01776.html#ae0487ecc173e55918bcee834bd3d107b">MaximumLength</a> == 0)) {</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    }</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( (<a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a>)String-&gt;<a class="code" href="../../dd/d00/a01776.html#afbc2ba2b7be88d0118e683a2eb289795">Buffer</a>, (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)String-&gt;<a class="code" href="../../dd/d00/a01776.html#ae0487ecc173e55918bcee834bd3d107b">MaximumLength</a> );</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    String-&gt;<a class="code" href="../../dd/d00/a01776.html#a3ebb6a85103954fd7fc325ba30c54008">Length</a> = 0;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;}</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00659"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a023bf37e42fdc7e5e8ead3f19f22a690">  659</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a023bf37e42fdc7e5e8ead3f19f22a690">RtlAdjustPrivilege</a>(</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Privilege,</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> Enable,</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> Client,</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> WasEnabled</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    )</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">    This procedure enables or disables a privilege process-wide.</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">    Privilege - The lower 32-bits of the privilege ID to be enabled or</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">        disabled.  The upper 32-bits is assumed to be zero.</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">    Enable - A boolean indicating whether the privilege is to be enabled</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">        or disabled.  TRUE indicates the privilege is to be enabled.</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment">        FALSE indicates the privilege is to be disabled.</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">    Client - A boolean indicating whether the privilege should be adjusted</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">        in a client token or the process&#39;s own token.   TRUE indicates</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">        the client&#39;s token should be used (and an error returned if there</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">        is no client token).  FALSE indicates the process&#39;s token should</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="comment">        be used.</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment">    WasEnabled - points to a boolean to receive an indication of whether</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment">        the privilege was previously enabled or disabled.  TRUE indicates</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">        the privilege was previously enabled.  FALSE indicates the privilege</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment">        was previously disabled.  This value is useful for returning the</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">        privilege to its original state after using it.</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="comment">    STATUS_SUCCESS - The privilege has been successfully enabled or disabled.</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="comment">    STATUS_PRIVILEGE_NOT_HELD - The privilege is not held by the specified context.</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="comment">    Other status values as may be returned by:</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="comment">            NtOpenProcessToken()</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">            NtAdjustPrivilegesToken()</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;{</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>,</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        TmpStatus;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        Token;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <a class="code" href="../../de/dc8/a00889.html">LUID</a></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        LuidPrivilege;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <a class="code" href="../../d7/db4/a01747.html">PTOKEN_PRIVILEGES</a></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        NewPrivileges,</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        OldPrivileges;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <a class="code" href="../../d8/d51/a02244.html#a1eba21559f17793c695f34f7e4787604">Length</a>;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        Buffer1[<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aee95b08affc82550582d1c5421d9cafb">TOKEN_PRIVILEGES</a>)+</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                ((1-<a class="code" href="../../dd/d67/a02230.html#a81b21cd8bf111de2c2c66bb07c1d2654">ANYSIZE_ARRAY</a>)*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#ac9f266100c326d2388dd176464c917cc">LUID_AND_ATTRIBUTES</a>))],</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        Buffer2[<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aee95b08affc82550582d1c5421d9cafb">TOKEN_PRIVILEGES</a>)+</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                ((1-<a class="code" href="../../dd/d67/a02230.html#a81b21cd8bf111de2c2c66bb07c1d2654">ANYSIZE_ARRAY</a>)*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#ac9f266100c326d2388dd176464c917cc">LUID_AND_ATTRIBUTES</a>))];</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    NewPrivileges = (<a class="code" href="../../d3/d3a/a02259.html#a99e85d58654f7a9338b77835298b4689">PTOKEN_PRIVILEGES</a>)Buffer1;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    OldPrivileges = (<a class="code" href="../../d3/d3a/a02259.html#a99e85d58654f7a9338b77835298b4689">PTOKEN_PRIVILEGES</a>)Buffer2;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="comment">// Open the appropriate token...</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">if</span> (Client == <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        Status = <a class="code" href="../../d3/d3a/a02259.html#a3cb6b2ed9abea1f641f5c05f14eb9d2c">NtOpenThreadToken</a>(</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                     <a class="code" href="../../db/d7a/a02253.html#ab24eb59f288b52281cad79f4a3871b1d">NtCurrentThread</a>(),</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                     <a class="code" href="../../d3/d3a/a02259.html#a32d3148156b1ae54bcc5a68c59cc27e7">TOKEN_ADJUST_PRIVILEGES</a> | <a class="code" href="../../d3/d3a/a02259.html#a5584596b6561bf1ef1c462d5032c6e12">TOKEN_QUERY</a>,</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                     <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                     &amp;Token</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                     );</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        Status = <a class="code" href="../../d3/d3a/a02259.html#a28a40ba853d20ecf9ac183c572c2cace">NtOpenProcessToken</a>(</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                     <a class="code" href="../../db/d7a/a02253.html#a719a7ce85358702f11dce2cd31896b4b">NtCurrentProcess</a>(),</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                     <a class="code" href="../../d3/d3a/a02259.html#a32d3148156b1ae54bcc5a68c59cc27e7">TOKEN_ADJUST_PRIVILEGES</a> | <a class="code" href="../../d3/d3a/a02259.html#a5584596b6561bf1ef1c462d5032c6e12">TOKEN_QUERY</a>,</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                     &amp;Token</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                    );</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    }</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">return</span>(Status);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="comment">// Initialize the privilege adjustment structure</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    LuidPrivilege = <a class="code" href="../../de/dc3/a02256.html#a07be44e9f5d9a11211d015d74071c358">RtlConvertUlongToLuid</a>(Privilege);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    NewPrivileges-&gt;<a class="code" href="../../d7/db4/a01747.html#aa6fc51dcc5ae40ab50c8e1e78620d578">PrivilegeCount</a> = 1;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    NewPrivileges-&gt;<a class="code" href="../../d7/db4/a01747.html#aefd3533e806f3225e053dda98b31470b">Privileges</a>[0].<a class="code" href="../../d7/d46/a00890.html#a87ba6ddd98dbc6cb4af380e69d31233a">Luid</a> = LuidPrivilege;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    NewPrivileges-&gt;<a class="code" href="../../d7/db4/a01747.html#aefd3533e806f3225e053dda98b31470b">Privileges</a>[0].<a class="code" href="../../d7/d46/a00890.html#aaa4581db6230461bf219f4e3bc6810c0">Attributes</a> = Enable ? <a class="code" href="../../d3/d3a/a02259.html#abb44b9106133f10d55f863cdaaf972f5">SE_PRIVILEGE_ENABLED</a> : 0;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="comment">// Adjust the privilege</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    Status = <a class="code" href="../../d3/d3a/a02259.html#af1c4d90a73cbb90d64e7539845cec6fe">NtAdjustPrivilegesToken</a>(</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                 Token,                     <span class="comment">// TokenHandle</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                 <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,                     <span class="comment">// DisableAllPrivileges</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                 NewPrivileges,             <span class="comment">// NewPrivileges</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                 <span class="keyword">sizeof</span>(Buffer1),           <span class="comment">// BufferLength</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                 OldPrivileges,             <span class="comment">// PreviousState (OPTIONAL)</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                 &amp;Length                    <span class="comment">// ReturnLength</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                 );</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    TmpStatus = <a class="code" href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a>(Token);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(TmpStatus));</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">// Map the success code NOT_ALL_ASSIGNED to an appropriate error</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">// since we&#39;re only trying to adjust the one privilege.</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keywordflow">if</span> (Status == <a class="code" href="../../dc/d18/a02260.html#a708fc4ea0c51a0fe9b07f924b2e0d0dd">STATUS_NOT_ALL_ASSIGNED</a>) {</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a62f33d4e46ad5b4ca3e889ded4c0f7a1">STATUS_PRIVILEGE_NOT_HELD</a>;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="comment">// If there are no privileges in the previous state, there were</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <span class="comment">// no changes made. The previous state of the privilege</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        <span class="comment">// is whatever we tried to change it to.</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        <span class="keywordflow">if</span> (OldPrivileges-&gt;<a class="code" href="../../d7/db4/a01747.html#aa6fc51dcc5ae40ab50c8e1e78620d578">PrivilegeCount</a> == 0) {</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            (*WasEnabled) = Enable;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            (*WasEnabled) =</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                (OldPrivileges-&gt;<a class="code" href="../../d7/db4/a01747.html#aefd3533e806f3225e053dda98b31470b">Privileges</a>[0].<a class="code" href="../../d7/d46/a00890.html#aaa4581db6230461bf219f4e3bc6810c0">Attributes</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#abb44b9106133f10d55f863cdaaf972f5">SE_PRIVILEGE_ENABLED</a>)</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                ? <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        }</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    }</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keywordflow">return</span>(Status);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;}</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00830"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">  830</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a> (</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    )</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">    This procedure validates an SID&#39;s structure.</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="comment">    Sid - Pointer to the SID structure to validate.</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="comment">    BOOLEAN - TRUE if the structure of Sid is valid.</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;{</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> Isid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>) Sid;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="comment">// Make sure revision is SID_REVISION and sub authority count is not</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="comment">// greater than maximum number of allowed sub-authorities.</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        <span class="keywordflow">if</span> ( Isid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (Isid-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> &amp; 0x0f) == <a class="code" href="../../d3/d3a/a02259.html#ae27969fb295feb91d5951b723325b339">SID_REVISION</a>) {</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            <span class="keywordflow">if</span> (Isid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> &lt;= <a class="code" href="../../d3/d3a/a02259.html#ad0a23f15b31cfde28fd99cd0cee99d20">SID_MAX_SUB_AUTHORITIES</a>) {</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;          }</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        }</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    } <a class="code" href="../../db/d68/a02028.html#a92dd13ee5770a55ecb6128f6d8143939">except</a>(<a class="code" href="../../d5/d4d/a02186.html#a3fece785755a75d4c26022cb6f6a7638">EXCEPTION_EXECUTE_HANDLER</a>) {</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    }</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;}</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00878"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">  878</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a> (</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid1,</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid2</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    )</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="comment">    This procedure tests two SID values for equality.</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment">    Sid1, Sid2 - Supply pointers to the two SID values to compare.</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">        The SID structures are assumed to be valid.</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment">    BOOLEAN - TRUE if the value of Sid1 is equal to Sid2, and FALSE</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="comment">        otherwise.</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;{</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;   <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SidLength;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;   <a class="code" href="../../dd/d67/a02230.html#abf28f80e90bef143796d9dfcf34dd239">C_ASSERT</a> (<a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a> (<a class="code" href="../../de/df9/a01624.html">SID</a>, Revision) + <span class="keyword">sizeof</span> (((<a class="code" href="../../de/df9/a01624.html">SID</a> *)Sid1)-&gt;Revision) == <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a> (<a class="code" href="../../de/df9/a01624.html">SID</a>, SubAuthorityCount));</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;   <a class="code" href="../../dd/d67/a02230.html#abf28f80e90bef143796d9dfcf34dd239">C_ASSERT</a> (<span class="keyword">sizeof</span> (((<a class="code" href="../../de/df9/a01624.html">SID</a> *)Sid1)-&gt;Revision) + <span class="keyword">sizeof</span> (((<a class="code" href="../../de/df9/a01624.html">SID</a> *)Sid1)-&gt;SubAuthorityCount) == <span class="keyword">sizeof</span> (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>));</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;   <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;   <span class="comment">//</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;   <span class="comment">// Make sure they are the same revision. To make this routine faster we make the assumption that</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;   <span class="comment">// the revision and subauthority fields are adjacent.</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;   <span class="comment">//</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;   <span class="keywordflow">if</span> (*(<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> *)&amp;((<a class="code" href="../../de/df9/a01624.html">SID</a> *)Sid1)-&gt;Revision == *(<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> *)&amp;((<a class="code" href="../../de/df9/a01624.html">SID</a> *)Sid2)-&gt;Revision) {</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;       SidLength = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a> (Sid1);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;       <span class="keywordflow">return</span>( (<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)<a class="code" href="../../de/dc3/a02256.html#a6c25a490b42cfa68e593014c864424c8">RtlEqualMemory</a>( Sid1, Sid2, SidLength) );</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;   }</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;   <span class="keywordflow">return</span>( <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> );</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;}</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l00926"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">  926</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a> (</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid1,</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid2</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    )</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment">    This procedure tests two SID prefix values for equality.</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment">    An SID prefix is the entire SID except for the last sub-authority</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment">    value.</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">    Sid1, Sid2 - Supply pointers to the two SID values to compare.</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">        The SID structures are assumed to be valid.</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">    BOOLEAN - TRUE if the prefix value of Sid1 is equal to Sid2, and FALSE</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;<span class="comment">        otherwise.</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;{</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a> <a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="comment">// Typecast to the opaque SID structures.</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <a class="code" href="../../de/df9/a01624.html">SID</a> *ISid1 = Sid1;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <a class="code" href="../../de/df9/a01624.html">SID</a> *ISid2 = Sid2;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="comment">// Make sure they are the same revision</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keywordflow">if</span> (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> == ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> ) {</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <span class="comment">// Compare IdentifierAuthority values</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordflow">if</span> ( (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[0] ==</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[0])  &amp;&amp;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;             (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[1]==</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[1])  &amp;&amp;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;             (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[2] ==</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[2])  &amp;&amp;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;             (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[3] ==</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[3])  &amp;&amp;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;             (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[4] ==</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[4])  &amp;&amp;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;             (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[5] ==</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;              ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[5])</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;            ) {</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="comment">// Compare SubAuthorityCount values</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            <span class="keywordflow">if</span> (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> == ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a>) {</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                <span class="keywordflow">if</span> (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> == 0) {</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                }</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                Index = 0;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                <span class="keywordflow">while</span> (Index &lt; (ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> - 1)) {</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                    <span class="keywordflow">if</span> ((ISid1-&gt;<a class="code" href="../../de/df9/a01624.html#a016791c144978a3390935063f68f1d6b">SubAuthority</a>[Index]) != (ISid2-&gt;<a class="code" href="../../de/df9/a01624.html#a016791c144978a3390935063f68f1d6b">SubAuthority</a>[Index])) {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                        <span class="comment">// Found some SubAuthority values that weren&#39;t equal.</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                    }</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                    Index += 1;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                }</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                <span class="comment">// All SubAuthority values are equal.</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            }</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        }</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    }</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="comment">// Either the Revision, SubAuthorityCount, or IdentifierAuthority values</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="comment">// weren&#39;t equal.</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;}</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div>
<div class="line"><a name="l01032"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074"> 1032</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a> (</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SubAuthorityCount</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    )</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">    This routine returns the length, in bytes, required to store an SID</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">    with the specified number of Sub-Authorities.</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">    SubAuthorityCount - The number of sub-authorities to be stored in the SID.</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="comment">    ULONG - The length, in bytes, required to store the SID.</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;{</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">return</span> (8L + (4 * SubAuthorityCount));</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;}</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01063"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143"> 1063</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>(</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid,</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d90/a01626.html">PSID_IDENTIFIER_AUTHORITY</a> IdentifierAuthority,</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> SubAuthorityCount</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    )</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="comment">    This function initializes an SID data structure.  It does not, however,</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="comment">    set the sub-authority values.  This must be done separately.</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">    Sid - Pointer to the SID data structure to initialize.</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="comment">    IdentifierAuthority - Pointer to the Identifier Authority value to</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment">        set in the SID.</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">    SubAuthorityCount - The number of sub-authorities that will be placed in</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment">        the SID (a separate action).</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;{</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> ISid;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="comment">//  Typecast to the opaque SID</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    ISid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>)Sid;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <span class="keywordflow">if</span> ( SubAuthorityCount &gt; <a class="code" href="../../d3/d3a/a02259.html#ad0a23f15b31cfde28fd99cd0cee99d20">SID_MAX_SUB_AUTHORITIES</a> ) {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#a52c9a508482278e5a91348ba542df15f">STATUS_INVALID_PARAMETER</a> );</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    }</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    ISid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> = (<a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>)SubAuthorityCount;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    ISid-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> = 1;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    ISid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a> = *IdentifierAuthority;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> );</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;}</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<a class="code" href="../../dd/d90/a01626.html">PSID_IDENTIFIER_AUTHORITY</a></div>
<div class="line"><a name="l01114"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a116af4b9237b96e5629c806dc2662161"> 1114</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a116af4b9237b96e5629c806dc2662161">RtlIdentifierAuthoritySid</a>(</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    )</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="comment">    This function returns the address of an SID&#39;s IdentifierAuthority field.</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="comment">    Sid - Pointer to the SID data structure.</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;{</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> ISid;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="comment">//  Typecast to the opaque SID</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    ISid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>)Sid;</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    <span class="keywordflow">return</span> &amp;(ISid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>);</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;}</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a></div>
<div class="line"><a name="l01147"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a596dac518bdbca2e54a67c2e1d8b5f14"> 1147</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a596dac518bdbca2e54a67c2e1d8b5f14">RtlSubAuthoritySid</a>(</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid,</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SubAuthority</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    )</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment">    This function returns the address of a sub-authority array element of</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="comment">    an SID.</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="comment">    Sid - Pointer to the SID data structure.</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="comment">    SubAuthority - An index indicating which sub-authority is being specified.</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="comment">        This value is not compared against the number of sub-authorities in the</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="comment">        SID for validity.</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;{</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( Sid, SubAuthority );</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;}</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a></div>
<div class="line"><a name="l01177"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ad126d04085e16b2aa54a9faceaab13d1"> 1177</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ad126d04085e16b2aa54a9faceaab13d1">RtlSubAuthorityCountSid</a>(</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    )</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;<span class="comment">    This function returns the address of the sub-authority count field of</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;<span class="comment">    an SID.</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="comment">    Sid - Pointer to the SID data structure.</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;{</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> ISid;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    <span class="comment">//  Typecast to the opaque SID</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    ISid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>)Sid;</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    <span class="keywordflow">return</span> &amp;(ISid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a>);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;}</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div>
<div class="line"><a name="l01211"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a7c3f037a28be18be89bb15f8c69bfd3b"> 1211</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a7c3f037a28be18be89bb15f8c69bfd3b">RtlLengthSid</a> (</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    )</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;<span class="comment">    This routine returns the length, in bytes, of a structurally valid SID.</span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="comment">    Sid - Points to the SID whose length is to be returned.  The</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="comment">        SID&#39;s structure is assumed to be valid.</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="comment">    ULONG - The length, in bytes, of the SID.</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;{</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(Sid);</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;}</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01241"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec"> 1241</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a> (</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> DestinationSidLength,</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> DestinationSid,</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SourceSid</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    )</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment">    This routine copies the value of the source SID to the destination</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="comment">    SID.</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="comment">    DestinationSidLength - Indicates the length, in bytes, of the</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;<span class="comment">        destination SID buffer.</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="comment">    DestinationSid - Pointer to a buffer to receive a copy of the</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="comment">        source Sid value.</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="comment">    SourceSid - Supplies the Sid value to be copied.</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the SID was successfully copied.</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - Indicates the target buffer wasn&#39;t</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;<span class="comment">        large enough to receive a copy of the SID.</span></div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;{</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SidLength = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(SourceSid);</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="keywordflow">if</span> (SidLength &gt; DestinationSidLength) {</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a>;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    }</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="comment">// Buffer is large enough</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#adb696f4512c9ed33dd7d571f296b7ebb">RtlMoveMemory</a>( DestinationSid, SourceSid, SidLength );</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;}</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01297"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a79bfbf3d5f194239a70e703aa23d78ae"> 1297</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a79bfbf3d5f194239a70e703aa23d78ae">RtlCopySidAndAttributesArray</a> (</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ArrayLength,</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d2d/a01625.html">PSID_AND_ATTRIBUTES</a> Source,</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> TargetSidBufferSize,</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d2d/a01625.html">PSID_AND_ATTRIBUTES</a> TargetArrayElement,</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> TargetSid,</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> *NextTargetSid,</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> RemainingTargetSidBufferSize</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    )</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="comment">    This routine copies the value of the source SID_AND_ATTRIBUTES array</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">    to the target.  The actual SID values are placed according to a separate</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">    parameter.  This allows multiple arrays to be merged using this service</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">    to copy each.</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="comment">    ArrayLength - Number of elements in the source array to copy.</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="comment">    Source - Pointer to the source array.</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;<span class="comment">    TargetSidBufferSize - Indicates the length, in bytes, of the buffer</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;<span class="comment">        to receive the actual SID values.  If this value is less than</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="comment">        the actual amount needed, then STATUS_BUFFER_TOO_SMALL is returned.</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;<span class="comment">    TargetArrayElement - Indicates where the array elements are to be</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;<span class="comment">        copied to (but not the SID values themselves).</span></div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="comment">    TargetSid - Indicates where the target SID values s are to be copied.  This</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;<span class="comment">        is assumed to be ULONG aligned.  Each SID value will be copied</span></div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="comment">        into this buffer.  Each SID will be ULONG aligned.</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;<span class="comment">    NextTargetSid - On completion, will be set to point to the ULONG</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="comment">        aligned address following the last SID copied.</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;<span class="comment">    RemainingTargetSidBufferSize - On completion, receives an indicatation</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="comment">        of how much of the SID buffer is still unused.</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="comment">    STATUS_SUCCESS - The call completed successfully.</span></div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - Indicates the buffer to receive the SID</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="comment">        values wasn&#39;t large enough.</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;{</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a> = 0;</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NextSid = TargetSid;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NextSidLength;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AlignedSidLength;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> RemainingLength = TargetSidBufferSize;</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    <span class="keywordflow">while</span> (Index &lt; ArrayLength) {</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        NextSidLength = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( Source[Index].Sid );</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        AlignedSidLength = <a class="code" href="../../de/d48/a02167.html#aa53040d6ed85b65dd0ebc79ced7fd547">PtrToUlong</a>(<a class="code" href="../../d3/d28/a02147.html#a0f50d1e6e2813033b8aea6e7912f1c7d">LongAlign</a>(NextSidLength));</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        <span class="keywordflow">if</span> (NextSidLength &gt; RemainingLength) {</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a>;</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        }</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        RemainingLength -= AlignedSidLength;</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        TargetArrayElement[<a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>].Sid = NextSid;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;        TargetArrayElement[<a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>].Attributes = Source[<a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>].Attributes;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;        <a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a>( NextSidLength, NextSid, Source[Index].Sid );</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        NextSid = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)((<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)NextSid + AlignedSidLength);</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        Index += 1;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    } <span class="comment">//end_while</span></div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    (*NextTargetSid) = NextSid;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    (*RemainingTargetSidBufferSize) = RemainingLength;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;}</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01393"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a235054d7359a2e66ba38689cb2793f31"> 1393</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a235054d7359a2e66ba38689cb2793f31">RtlLengthSidAsUnicodeString</a>(</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid,</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> StringLength</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    )</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;<span class="comment">    This function returns the maximum length of the string needed</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;<span class="comment">    to represent the SID supplied.  The actual string may be shorter,</span></div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="comment">    but this is intended to be a quick calculation.</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;<span class="comment">    Sid - Supplies the SID that is to be converted to unicode.</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;<span class="comment">    StringLength - Receives the max length required in bytes.</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;<span class="comment">    SUCCESS - The conversion was successful</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="comment">    STATUS_INVALID_SID - The sid provided does not have a valid structure,</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="comment">        or has too many sub-authorities (more than SID_MAX_SUB_AUTHORITIES).</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;{</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   i ;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a>   iSid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>)Sid;  <span class="comment">// pointer to opaque structure</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( Sid ) != <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    {</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../dc/d18/a02260.html#a5872ceb716a4f69f7f861596e77a016c">STATUS_INVALID_SID</a>);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    }</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="comment">// if the SID&#39;s IA value has 5 or 6 significant bytes, the</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;    <span class="comment">// representation will be in hex, with a 0x preceding.  Otherwise</span></div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    <span class="comment">// it will be in decimal, with at most 10 characters.</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="keywordflow">if</span> (  (iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[0] != 0)  ||</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;          (iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[1] != 0)  )</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    {</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        i = 14 ;    <span class="comment">// 0x665544332211</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    }</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    {</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        i = 10 ;    <span class="comment">// 4294967295 is the max ulong, at 10 chars</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    }</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    i += 4 ;        <span class="comment">// room for the S-1-</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    <span class="comment">// for each sub authority, it is a max of 10 chars (for a ulong),</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <span class="comment">// plus the - separator</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    i += 11 * iSid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> ;</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    *StringLength = i * <span class="keyword">sizeof</span>( <a class="code" href="../../dd/d67/a02230.html#aad61bc3eae1804d8784adebdce0721d3">WCHAR</a> );</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> ;</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;}</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01472"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ad777622d13f820696a40076775ea44f8"> 1472</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ad777622d13f820696a40076775ea44f8">RtlConvertSidToUnicodeString</a>(</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">PUNICODE_STRING</a> UnicodeString,</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Sid,</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AllocateDestinationString</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    )</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment">    This function generates a printable unicode string representation</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">    of a SID.</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">    The resulting string will take one of two forms.  If the</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment">    IdentifierAuthority value is not greater than 2^32, then</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">    the SID will be in the form:</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="comment">        S-1-281736-12-72-9-110</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">              ^    ^^ ^^ ^ ^^^</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;<span class="comment">              |     |  | |  |</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="comment">              +-----+--+-+--+---- Decimal</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;<span class="comment">    Otherwise it will take the form:</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;<span class="comment">        S-1-0x173495281736-12-72-9-110</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;<span class="comment">            ^^^^^^^^^^^^^^ ^^ ^^ ^ ^^^</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;<span class="comment">             Hexadecimal    |  | |  |</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="comment">                            +--+-+--+---- Decimal</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="comment">    UnicodeString - Returns a unicode string that is equivalent to</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="comment">        the SID. The maximum length field is only set if</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="comment">        AllocateDestinationString is TRUE.</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="comment">    Sid - Supplies the SID that is to be converted to unicode.</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;<span class="comment">    AllocateDestinationString - Supplies a flag that controls whether or</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="comment">        not this API allocates the buffer space for the destination</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="comment">        string.  If it does, then the buffer must be deallocated using</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;<span class="comment">        RtlFreeUnicodeString (note that only storage for</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment">        DestinationString-&gt;Buffer is allocated by this API).</span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="comment">    SUCCESS - The conversion was successful</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;<span class="comment">    STATUS_INVALID_SID - The sid provided does not have a valid structure,</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;<span class="comment">        or has too many sub-authorities (more than SID_MAX_SUB_AUTHORITIES).</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;<span class="comment">    STATUS_NO_MEMORY - There was not sufficient memory to allocate the</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;<span class="comment">        target string.  This is returned only if AllocateDestinationString</span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="comment">        is specified as TRUE.</span></div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;<span class="comment">    STATUS_BUFFER_OVERFLOW - This is returned only if</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;<span class="comment">        AllocateDestinationString is specified as FALSE.</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;{</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aad61bc3eae1804d8784adebdce0721d3">WCHAR</a> UniBuffer[ 256 ];</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a92ac059a9f2eebdf70d057eb27709f4a">PWSTR</a> Offset ;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">UNICODE_STRING</a> LocalString ;</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>   i;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   Tmp;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;    <a class="code" href="../../dc/d5e/a00817.html">LARGE_INTEGER</a> Auth ;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a>   iSid = (<a class="code" href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a>)Sid;  <span class="comment">// pointer to opaque structure</span></div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( Sid ) != <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../dc/d18/a02260.html#a5872ceb716a4f69f7f861596e77a016c">STATUS_INVALID_SID</a>);</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    }</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="keywordflow">if</span> ( iSid-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#ae27969fb295feb91d5951b723325b339">SID_REVISION</a> )</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    {</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a5872ceb716a4f69f7f861596e77a016c">STATUS_INVALID_SID</a> ;</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    }</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    <a class="code" href="../../dd/da4/a02295.html#ac9437f211fcbadca93fa8eb40727b2ae">wcscpy</a>( UniBuffer, L<span class="stringliteral">&quot;S-1-&quot;</span> );</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;    Offset = &amp;UniBuffer[ 4 ];</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    <span class="keywordflow">if</span> (  (iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[0] != 0)  ||</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;          (iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[1] != 0)     ){</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="comment">// Ugly hex dump.</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    </div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <a class="code" href="../../dd/da4/a02295.html#a9d2c7dc8b4f88632fdd2cd302e3d6957">wcscat</a>( UniBuffer, L<span class="stringliteral">&quot;0x&quot;</span> );</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    </div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        Offset = &amp;UniBuffer[ 6 ];</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        Auth.<a class="code" href="../../dc/d5e/a00817.html#a9b8939bdf30481e7477d6094c107e65b">HighPart</a> = (<a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a>) (iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[ 0 ] &lt;&lt; 8) +</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                        (<a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a>) iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[ 1 ] ;</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        Auth.<a class="code" href="../../dc/d5e/a00817.html#a8d85c43a1b619b2007d193acce0f1d55">LowPart</a> = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[5]          +</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;                       (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[4] &lt;&lt;  8)  +</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;                       (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[3] &lt;&lt; 16)  +</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                       (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[2] &lt;&lt; 24);</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;        Status = <a class="code" href="../../de/dc3/a02256.html#a09632371bc84fad1dbde91977154b1d8">RtlLargeIntegerToUnicode</a>(</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;                        &amp;Auth,</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;                        16,</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;                        256 - (<a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a>) (Offset - UniBuffer),</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;                        Offset );</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;        Tmp = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[5]          +</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;              (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[4] &lt;&lt;  8)  +</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;              (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[3] &lt;&lt; 16)  +</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;              (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(iSid-&gt;<a class="code" href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">IdentifierAuthority</a>.<a class="code" href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">Value</a>[2] &lt;&lt; 24);</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        Status = <a class="code" href="../../de/dc3/a02256.html#ab00558cf20129feb37af30b11cca45d5">RtlIntegerToUnicode</a>(</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                        Tmp,</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                        10,</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                        256 - (<a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a>) (Offset - UniBuffer),</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                        Offset );</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    }</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status ) )</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;    {</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a> ;</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    }</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    <span class="keywordflow">for</span> (i=0;i&lt;iSid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> ;i++ ) {</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;        <span class="keywordflow">while</span> ( *Offset &amp;&amp; ( Offset &lt; &amp;UniBuffer[ 255 ] ) )</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        {</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;            Offset++ ;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        }</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        *Offset++ = L<span class="charliteral">&#39;-&#39;</span> ;</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        Status = <a class="code" href="../../de/dc3/a02256.html#ab00558cf20129feb37af30b11cca45d5">RtlIntegerToUnicode</a>(</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;                        iSid-&gt;<a class="code" href="../../de/df9/a01624.html#a016791c144978a3390935063f68f1d6b">SubAuthority</a>[ i ],</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;                        10,</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                        256 - (<a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a>) (Offset - UniBuffer),</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                        Offset );</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status ) )</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        {</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a> ;</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        }</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;    }</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;    <span class="keywordflow">if</span> ( AllocateDestinationString )</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;    {</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../de/dc3/a02256.html#a01c770015bc96e494b2ccfc6d9b080e0">RtlCreateUnicodeString</a>( UnicodeString,</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                                         UniBuffer ) )</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        {</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> ;</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        }</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        {</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a> ;</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        }</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    }</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    {</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        <span class="keywordflow">while</span> ( *Offset &amp;&amp; ( Offset &lt; &amp;UniBuffer[ 255 ] ) )</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        {</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;            Offset++ ;</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        }</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        Tmp = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>) (Offset - UniBuffer) * <span class="keyword">sizeof</span>( <a class="code" href="../../dd/d67/a02230.html#aad61bc3eae1804d8784adebdce0721d3">WCHAR</a> );</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;        <span class="keywordflow">if</span> ( Tmp &lt; UnicodeString-&gt;MaximumLength )</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;        {</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;            LocalString.<a class="code" href="../../dd/d00/a01776.html#a3ebb6a85103954fd7fc325ba30c54008">Length</a> = (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>) Tmp ;</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;            LocalString.<a class="code" href="../../dd/d00/a01776.html#ae0487ecc173e55918bcee834bd3d107b">MaximumLength</a> = LocalString.<a class="code" href="../../dd/d00/a01776.html#a3ebb6a85103954fd7fc325ba30c54008">Length</a> + <span class="keyword">sizeof</span>( <a class="code" href="../../dd/d67/a02230.html#aad61bc3eae1804d8784adebdce0721d3">WCHAR</a> );</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;            LocalString.<a class="code" href="../../dd/d00/a01776.html#afbc2ba2b7be88d0118e683a2eb289795">Buffer</a> = UniBuffer ;</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ad3971c6e26e44eb8b7131861a66d1785">RtlCopyUnicodeString</a>(</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                        UnicodeString,</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                        &amp;LocalString );</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> ;</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        }</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        {</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ace23dcb864057a35543fff393324c3f3">STATUS_BUFFER_OVERFLOW</a> ;</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        }</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    }</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;    <span class="keywordflow">return</span>(Status);</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;}</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l01689"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a9d89c952725efb8955f414b549bf4019"> 1689</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#af002fe57526a71b69dcb65d6b21be224">RtlEqualLuid</a> (</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../de/dc8/a00889.html">PLUID</a> Luid1,</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../de/dc8/a00889.html">PLUID</a> Luid2</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;    )</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="comment">    This procedure test two LUID values for equality.</span></div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="comment">    This routine is here for backwards compatibility only. New code</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="comment">    should use the macro.</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="comment">    Luid1, Luid2 - Supply pointers to the two LUID values to compare.</span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="comment">    BOOLEAN - TRUE if the value of Luid1 is equal to Luid2, and FALSE</span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="comment">        otherwise.</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;{</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <a class="code" href="../../de/dc8/a00889.html">LUID</a> <a class="code" href="../../dd/d67/a02230.html#aadbc71070481af70d016fda17ea87109">UNALIGNED</a> * TempLuid1;</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    <a class="code" href="../../de/dc8/a00889.html">LUID</a> <a class="code" href="../../dd/d67/a02230.html#aadbc71070481af70d016fda17ea87109">UNALIGNED</a> * TempLuid2;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    <span class="keywordflow">return</span>((Luid1-&gt;HighPart == Luid2-&gt;HighPart) &amp;&amp;</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;           (Luid1-&gt;LowPart  == Luid2-&gt;LowPart));</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;}</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l01728"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ae339b2cd57aa94d6bf571d636418c02a"> 1728</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae339b2cd57aa94d6bf571d636418c02a">RtlCopyLuid</a> (</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../de/dc8/a00889.html">PLUID</a> DestinationLuid,</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../de/dc8/a00889.html">PLUID</a> SourceLuid</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    )</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;<span class="comment">    This routine copies the value of the source LUID to the</span></div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="comment">    destination LUID.</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="comment">    DestinationLuid - Receives a copy of the source Luid value.</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;<span class="comment">    SourceLuid - Supplies the Luid value to be copied.  This LUID is</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;<span class="comment">                 assumed to be structurally valid.</span></div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;<span class="comment">    None.</span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;{</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    (*DestinationLuid) = (*SourceLuid);</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;}</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l01761"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a9d96ec468d2cb368fef87dfecedbd132"> 1761</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a9d96ec468d2cb368fef87dfecedbd132">RtlCopyLuidAndAttributesArray</a> (</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ArrayLength,</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/d46/a00890.html">PLUID_AND_ATTRIBUTES</a> Source,</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/d46/a00890.html">PLUID_AND_ATTRIBUTES</a> Target</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    )</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="comment">    This routine copies the value of the source LUID_AND_ATTRIBUTES array</span></div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="comment">    to the target.</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="comment">    ArrayLength - Number of elements in the source array to copy.</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">    Source - The source array.</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="comment">    Target - Indicates where the array elements are to be copied to.</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="comment">    None.</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;{</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a> = 0;</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <span class="keywordflow">while</span> (Index &lt; ArrayLength) {</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;        Target[<a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>] = Source[<a class="code" href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a>];</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;        Index += 1;</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    } <span class="comment">//end_while</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;}</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01810"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a456d1320fc92eae0407d43dc33e61448"> 1810</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a456d1320fc92eae0407d43dc33e61448">RtlCreateSecurityDescriptor</a> (</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Revision</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    )</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="comment">    This procedure initializes a new &quot;absolute format&quot; security descriptor.</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="comment">    After the procedure call the security descriptor is initialized with no</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="comment">    system ACL, no discretionary ACL, no owner, no primary group and</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="comment">    all control flags set to false (null).</span></div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor to</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="comment">        initialize.</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="comment">    Revision - Provides the revision level to assign to the security</span></div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="comment">        descriptor.  This should be one (1) for this release.</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision level provided</span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">        is not supported by this routine.</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;{</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    <span class="comment">// Check the requested revision</span></div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    <span class="keywordflow">if</span> (Revision == <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;        <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;        <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( ISecurityDescriptor, <span class="keyword">sizeof</span>(<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a>));</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> = <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>;</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    }</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;}</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l01869"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2"> 1869</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2">RtlCreateSecurityDescriptorRelative</a> (</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d6/d91/a01587.html">PISECURITY_DESCRIPTOR_RELATIVE</a> SecurityDescriptor,</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Revision</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    )</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;<span class="comment">    This procedure initializes a new &quot;relative format&quot; security descriptor.</span></div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="comment">    After the procedure call the security descriptor is initialized with no</span></div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;<span class="comment">    system ACL, no discretionary ACL, no owner, no primary group and</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;<span class="comment">    all control flags set to false (null).</span></div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor to</span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;<span class="comment">        initialize.</span></div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;<span class="comment">    Revision - Provides the revision level to assign to the security</span></div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="comment">        descriptor.  This should be one (1) for this release.</span></div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision level provided</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment">        is not supported by this routine.</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="comment">Note:</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="comment">    Warning, this code assume the caller allocated a relative security</span></div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="comment">    descriptor rather than a relative one.  Absolute is larger on systems</span></div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;<span class="comment">    with 64-bit pointers.</span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;{</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <span class="comment">// Check the requested revision</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <span class="keywordflow">if</span> (Revision == <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( SecurityDescriptor, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>));</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;        SecurityDescriptor-&gt;Revision = <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>;</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;    }</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;}</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l01931"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a476fa7a3fca096253cc03efda08e091d"> 1931</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a476fa7a3fca096253cc03efda08e091d">RtlValidSecurityDescriptor</a> (</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    )</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="comment">    This procedure validates a SecurityDescriptor&#39;s structure.  This</span></div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="comment">    involves validating the revision levels of each component of the</span></div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="comment">    security descriptor.</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="comment">    SecurityDescriptor - Pointer to the SECURITY_DESCRIPTOR structure</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="comment">        to validate.</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">    BOOLEAN - TRUE if the structure of SecurityDescriptor is valid.</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;{</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Owner;</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> <a class="code" href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a>;</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Dacl;</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Sacl;</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        <span class="comment">// known revision ?</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;        }</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;        <span class="comment">// Validate each element contained in the security descriptor</span></div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        Owner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>( ISecurityDescriptor );</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;        <span class="keywordflow">if</span> (Owner != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( Owner )) {</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;            }</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;        }</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;        Group = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>( ISecurityDescriptor );</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        <span class="keywordflow">if</span> (Group != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( Group )) {</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;            }</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        }</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;        Dacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( ISecurityDescriptor );</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        <span class="keywordflow">if</span> (Dacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a>( Dacl )) {</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;            }</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;        }</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;        Sacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( ISecurityDescriptor );</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;        <span class="keywordflow">if</span> ( Sacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a>( Sacl )) {</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;            }</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;        }</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    } <a class="code" href="../../db/d68/a02028.html#a92dd13ee5770a55ecb6128f6d8143939">except</a>(<a class="code" href="../../d5/d4d/a02186.html#a3fece785755a75d4c26022cb6f6a7638">EXCEPTION_EXECUTE_HANDLER</a>) {</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;    }</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;    <span class="comment">// All components are valid</span></div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;}</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div>
<div class="line"><a name="l02030"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a7f27dd5d02917eb83aa6b901c0512fc1"> 2030</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a7f27dd5d02917eb83aa6b901c0512fc1">RtlLengthSecurityDescriptor</a> (</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;    )</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;<span class="comment">    This routine returns the length, in bytes, necessary to capture a</span></div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;<span class="comment">    structurally valid SECURITY_DESCRIPTOR.  The length includes the length</span></div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;<span class="comment">    of all associated data structures (like SIDs and ACLs).  The length also</span></div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;<span class="comment">    takes into account the alignment requirements of each component.</span></div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="comment">    The minimum length of a security descriptor (one which has no associated</span></div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;<span class="comment">    SIDs or ACLs) is SECURITY_DESCRIPTOR_MIN_LENGTH.</span></div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;<span class="comment">    SecurityDescriptor - Points to the SECURITY_DESCRIPTOR whose</span></div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;<span class="comment">        length is to be returned.  The SECURITY_DESCRIPTOR&#39;s</span></div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;<span class="comment">        structure is assumed to be valid.</span></div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;<span class="comment">    ULONG - The length, in bytes, of the SECURITY_DESCRIPTOR.</span></div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;{</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> sum;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> Temp;</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = (<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor;</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;    <span class="comment">// The length is the sum of the following:</span></div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;    <span class="comment">//       SECURITY_DESCRIPTOR_MIN_LENGTH (or sizeof(SECURITY_DESCRIPTOR))</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    <span class="comment">//       length of Owner SID (if present)</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="comment">//       length of Group SID (if present)</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;    <span class="comment">//       length of Discretionary ACL (if present and non-null)</span></div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;    <span class="comment">//       length of System ACL (if present and non-null)</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;    sum = ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a> ?</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                            <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aecc9f2cb4b77c249451b1db76791af53">SECURITY_DESCRIPTOR_RELATIVE</a>) :</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                            <span class="keyword">sizeof</span>(<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a>);</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;    <span class="comment">// Add in length of Owner SID</span></div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;    Temp = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;    <span class="keywordflow">if</span> (Temp != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        sum += <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(Temp));</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;    }</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    <span class="comment">// Add in length of Group SID</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;    Temp = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    <span class="keywordflow">if</span> (Temp != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        sum += <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(Temp));</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;    }</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    <span class="comment">// Add in used length of Discretionary ACL</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    Temp = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;        sum += <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(((<a class="code" href="../../d7/dd4/a00013.html">PACL</a>) Temp)-&gt;AclSize );</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    }</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    <span class="comment">// Add in used length of System Acl</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    Temp = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        sum += <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(((<a class="code" href="../../d7/dd4/a00013.html">PACL</a>) Temp)-&gt;AclSize );</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    }</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;    <span class="keywordflow">return</span> sum;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;}</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02130"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a4ae2a669f4467584a20a7ad54fce92d5"> 2130</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a4ae2a669f4467584a20a7ad54fce92d5">RtlSetAttributesSecurityDescriptor</a>(</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5dcdcb687d0ee6009b792fe98286b02f">SECURITY_DESCRIPTOR_CONTROL</a> Control,</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> Revision</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;    )</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;{</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    <span class="comment">// Always return the revision value - even if this isn&#39;t a valid</span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    <span class="comment">// security descriptor</span></div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;    *Revision = ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor)-&gt;Revision;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    <span class="keywordflow">if</span> ( ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor)-&gt;Revision</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;         != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a> ) {</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    }</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <span class="comment">// This is a worthless API.  There is no way to turn any of the bits off.</span></div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    <span class="comment">// Use the newer RtlSetControlSecurityDescriptor.</span></div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;    Control &amp;= <a class="code" href="../../d3/d32/a02665.html#a6279bc5bce1ac234f1c5c921f581508d">SE_VALID_CONTROL_BITS</a>;</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d3/d32/a02665.html#a9203f363f65ad0d7a697c93d76fcdd0e">RtlSetControlSecurityDescriptor</a> ( SecurityDescriptor, Control, Control );</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;}</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02159"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a241df3175fd3fde04d9808fa527729eb"> 2159</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a241df3175fd3fde04d9808fa527729eb">RtlGetControlSecurityDescriptor</a> (</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#afc7989ff9142b3067e6580ffdfdc5ee0">PSECURITY_DESCRIPTOR_CONTROL</a> Control,</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> Revision</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    )</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;<span class="comment">    This procedure retrieves the control information from a security descriptor.</span></div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;<span class="comment">    Control - Receives the control information.</span></div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;<span class="comment">    Revision - Receives the revision of the security descriptor.</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;<span class="comment">               This value will always be returned, even if an error</span></div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;<span class="comment">               is returned by this routine.</span></div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;{</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;    <span class="comment">// Always return the revision value - even if this isn&#39;t a valid</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;    <span class="comment">// security descriptor</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;    *Revision = ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor)-&gt;Revision;</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;    <span class="keywordflow">if</span> ( ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor)-&gt;Revision</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;         != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a> ) {</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;    }</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    *Control = ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor)-&gt;Control;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;}</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02216"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a9203f363f65ad0d7a697c93d76fcdd0e"> 2216</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a9203f363f65ad0d7a697c93d76fcdd0e">RtlSetControlSecurityDescriptor</a> (</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> pSecurityDescriptor,</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5dcdcb687d0ee6009b792fe98286b02f">SECURITY_DESCRIPTOR_CONTROL</a> ControlBitsOfInterest,</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5dcdcb687d0ee6009b792fe98286b02f">SECURITY_DESCRIPTOR_CONTROL</a> ControlBitsToSet</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;    )</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="comment">    This procedure sets the control information in a security descriptor.</span></div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;<span class="comment">    For instance,</span></div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;<span class="comment">        SetSecurityDescriptorControl( &amp;SecDesc,</span></div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;<span class="comment">                                      SE_DACL_PROTECTED,</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;<span class="comment">                                      SE_DACL_PROTECTED );</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;<span class="comment">    marks the DACL on the security descriptor as protected. And</span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;<span class="comment">        SetSecurityDescriptorControl( &amp;SecDesc,</span></div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;<span class="comment">                                      SE_DACL_PROTECTED,</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;<span class="comment">                                      0 );</span></div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;<span class="comment">    marks the DACL as not protected.</span></div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="comment">    pSecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="comment">    ControlBitsOfInterest - A mask of the control bits being changed, set,</span></div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="comment">        or reset by this call.  The mask is the logical OR of one or more of</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment">        the following flags:</span></div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="comment">            SE_DACL_UNTRUSTED</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="comment">            SE_SERVER_SECURITY</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="comment">            SE_DACL_AUTO_INHERIT_REQ</span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="comment">            SE_SACL_AUTO_INHERIT_REQ</span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;<span class="comment">            SE_DACL_AUTO_INHERITED</span></div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="comment">            SE_SACL_AUTO_INHERITED</span></div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="comment">            SE_DACL_PROTECTED</span></div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="comment">            SE_SACL_PROTECTED</span></div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="comment">    ControlBitsToSet - A mask indicating what the bits specified by ControlBitsOfInterest</span></div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;<span class="comment">        should be set to.</span></div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;<span class="comment">    Returns TRUE for success, FALSE for failure.  Extended error status</span></div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;<span class="comment">    is available using GetLastError.</span></div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;{</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;    <span class="comment">// Ensure the caller passed valid bits.</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    <span class="keywordflow">if</span> ( (ControlBitsOfInterest &amp; ~<a class="code" href="../../d3/d32/a02665.html#a6279bc5bce1ac234f1c5c921f581508d">SE_VALID_CONTROL_BITS</a>) != 0 ||</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;         (ControlBitsToSet &amp; ~ControlBitsOfInterest) != 0 ) {</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a52c9a508482278e5a91348ba542df15f">STATUS_INVALID_PARAMETER</a>;</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    }</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;    ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)pSecurityDescriptor)-&gt;Control &amp;= ~ControlBitsOfInterest;</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)pSecurityDescriptor)-&gt;Control |= ControlBitsToSet;</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;}</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02287"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#afb36f010039d85b0c281e98b73055c37"> 2287</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#afb36f010039d85b0c281e98b73055c37">RtlSetDaclSecurityDescriptor</a> (</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DaclPresent,</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Dacl <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DaclDefaulted OPTIONAL</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    )</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="comment">    This procedure sets the discretionary ACL information of an absolute</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="comment">    format security descriptor.  If there is already a discretionary ACL</span></div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="comment">    present in the security descriptor, it is superseded.</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor to be which</span></div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="comment">        the discretionary ACL is to be added.</span></div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="comment">    DaclPresent - If FALSE, indicates the DaclPresent flag in the</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="comment">        security descriptor should be set to FALSE.  In this case,</span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;<span class="comment">        the remaining optional parameters are ignored.  Otherwise,</span></div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="comment">        the DaclPresent control flag in the security descriptor is</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="comment">        set to TRUE and the remaining optional parameters are not</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;<span class="comment">        ignored.</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="comment">    Dacl - Supplies the discretionary ACL for the security</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;<span class="comment">        descriptor.  If this optional parameter is not passed, then a</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;<span class="comment">        null ACL is assigned to the security descriptor.  A null</span></div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="comment">        discretionary ACL unconditionally grants access.  The ACL is</span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="comment">        referenced by, not copied into, by the security descriptor.</span></div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;<span class="comment">    DaclDefaulted - When set, indicates the discretionary ACL was</span></div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;<span class="comment">        picked up from some default mechanism (rather than explicitly</span></div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;<span class="comment">        specified by a user).  This value is set in the DaclDefaulted</span></div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;<span class="comment">        control flag in the security descriptor.  If this optional</span></div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;<span class="comment">        parameter is not passed, then the DaclDefaulted flag will be</span></div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="comment">        cleared.</span></div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="comment">    STATUS_INVALID_SECURITY_DESCR - Indicates the security descriptor</span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="comment">        is not an absolute format security descriptor.</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;{</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;       <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;    }</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    <span class="comment">// Make sure the descriptor is absolute format</span></div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>) {</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;    }</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;    <span class="comment">// Assign the DaclPresent flag value passed</span></div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;    <span class="keywordflow">if</span> (DaclPresent) {</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;        <span class="comment">// Assign the ACL address if passed, otherwise set to null.</span></div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a6dc4d9f0455e08f4a5158b52b6dd23fc">Dacl</a> = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(Dacl)) {</div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;            ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a6dc4d9f0455e08f4a5158b52b6dd23fc">Dacl</a> = Dacl;</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;        }</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;        <span class="comment">// Assign DaclDefaulted flag if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a>;</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        <span class="keywordflow">if</span> (DaclDefaulted == <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;            ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a>;</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        }</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;    }</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;}</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02409"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a52107cd63fea68e76ce730007c6657a8"> 2409</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a52107cd63fea68e76ce730007c6657a8">RtlGetDaclSecurityDescriptor</a> (</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> DaclPresent,</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *Dacl,</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> DaclDefaulted</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    )</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="comment">    This procedure retrieves the discretionary ACL information of a</span></div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;<span class="comment">    security descriptor.</span></div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="comment">    DaclPresent - If TRUE, indicates that the security descriptor</span></div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;<span class="comment">        does contain a discretionary ACL.  In this case, the</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;<span class="comment">        remaining OUT parameters will receive valid values.</span></div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="comment">        Otherwise, the security descriptor does not contain a</span></div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="comment">        discretionary ACL and the remaining OUT parameters will not</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;<span class="comment">        receive valid values.</span></div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;<span class="comment">    Dacl - This value is returned only if the value returned for the</span></div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;<span class="comment">        DaclPresent flag is TRUE.  In this case, the Dacl parameter</span></div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;<span class="comment">        receives the address of the security descriptor&#39;s</span></div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;<span class="comment">        discretionary ACL.  If this value is returned as null, then</span></div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="comment">        the security descriptor has a null discretionary ACL.</span></div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="comment">    DaclDefaulted - This value is returned only if the value returned</span></div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="comment">        for the DaclPresent flag is TRUE.  In this case, the</span></div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="comment">        DaclDefaulted parameter receives the value of the security</span></div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;<span class="comment">        descriptor&#39;s DaclDefaulted control flag.</span></div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;{</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;    }</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;    <span class="comment">// Assign the DaclPresent flag value</span></div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;    *DaclPresent = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a> );</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;    <span class="keywordflow">if</span> (*DaclPresent) {</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;        <span class="comment">// Assign the ACL address.</span></div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;        *Dacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        <span class="comment">// Assign DaclDefaulted flag.</span></div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;        *DaclDefaulted = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a> );</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;    }</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;}</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02500"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a3f67809168515a00397063627d736340"> 2500</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a3f67809168515a00397063627d736340">RtlSetSaclSecurityDescriptor</a> (</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SaclPresent,</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Sacl <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SaclDefaulted OPTIONAL</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;    )</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;<span class="comment">    This procedure sets the system ACL information of an absolute security</span></div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;<span class="comment">    descriptor.  If there is already a system ACL present in the</span></div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="comment">    security descriptor, it is superseded.</span></div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor to be which</span></div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;<span class="comment">        the system ACL is to be added.</span></div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="comment">    SaclPresent - If FALSE, indicates the SaclPresent flag in the</span></div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;<span class="comment">        security descriptor should be set to FALSE.  In this case,</span></div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;<span class="comment">        the remaining optional parameters are ignored.  Otherwise,</span></div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;<span class="comment">        the SaclPresent control flag in the security descriptor is</span></div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;<span class="comment">        set to TRUE and the remaining optional parameters are not</span></div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;<span class="comment">        ignored.</span></div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;<span class="comment">    Sacl - Supplies the system ACL for the security descriptor.  If</span></div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;<span class="comment">        this optional parameter is not passed, then a null ACL is</span></div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;<span class="comment">        assigned to the security descriptor.  The ACL is referenced</span></div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;<span class="comment">        by, not copied into, by the security descriptor.</span></div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;<span class="comment">    SaclDefaulted - When set, indicates the system ACL was picked up</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;<span class="comment">        from some default mechanism (rather than explicitly specified</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;<span class="comment">        by a user).  This value is set in the SaclDefaulted control</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="comment">        flag in the security descriptor.  If this optional parameter</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;<span class="comment">        is not passed, then the SaclDefaulted flag will be cleared.</span></div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;<span class="comment">    STATUS_INVALID_SECURITY_DESCR - Indicates the security descriptor</span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;<span class="comment">        is not an absolute format security descriptor.</span></div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;{</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;    }</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;    <span class="comment">// Make sure the descriptor is absolute format</span></div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>) {</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;    }</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;    <span class="comment">// Assign the SaclPresent flag value passed</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;    <span class="keywordflow">if</span> (SaclPresent) {</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>;</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;        <span class="comment">// Assign the ACL address if passed, otherwise set to null.</span></div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a0c558ea93c3789c077e444ae677f4d6e">Sacl</a> = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(Sacl)) {</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;           ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a0c558ea93c3789c077e444ae677f4d6e">Sacl</a> = Sacl;</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;        }</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;        <span class="comment">// Assign SaclDefaulted flag if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e"> SE_SACL_DEFAULTED</a>;</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(SaclDefaulted)) {</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;            ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e">SE_SACL_DEFAULTED</a>;</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;        }</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>;</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;    }</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;}</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02615"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a6c0f5054b396ce159d856064b1645d9a"> 2615</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a6c0f5054b396ce159d856064b1645d9a">RtlGetSaclSecurityDescriptor</a> (</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> SaclPresent,</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *Sacl,</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> SaclDefaulted</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    )</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;<span class="comment">    This procedure retrieves the system ACL information of a security</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;<span class="comment">    descriptor.</span></div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;<span class="comment">    SaclPresent - If TRUE, indicates that the security descriptor</span></div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;<span class="comment">        does contain a system ACL.  In this case, the remaining OUT</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;<span class="comment">        parameters will receive valid values.  Otherwise, the</span></div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;<span class="comment">        security descriptor does not contain a system ACL and the</span></div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;<span class="comment">        remaining OUT parameters will not receive valid values.</span></div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;<span class="comment">    Sacl - This value is returned only if the value returned for the</span></div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;<span class="comment">        SaclPresent flag is TRUE.  In this case, the Sacl parameter</span></div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;<span class="comment">        receives the address of the security descriptor&#39;s system ACL.</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;<span class="comment">        If this value is returned as null, then the security</span></div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;<span class="comment">        descriptor has a null system ACL.</span></div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;<span class="comment">    SaclDefaulted - This value is returned only if the value returned</span></div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;<span class="comment">        for the SaclPresent flag is TRUE.  In this case, the</span></div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;<span class="comment">        SaclDefaulted parameter receives the value of the security</span></div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;<span class="comment">        descriptor&#39;s SaclDefaulted control flag.</span></div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;{</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;    }</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;    <span class="comment">// Assign the SaclPresent flag value</span></div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;    *SaclPresent = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a> );</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;    <span class="keywordflow">if</span> (*SaclPresent) {</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;        <span class="comment">// Assign the ACL address.</span></div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;        *Sacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;        <span class="comment">// Assign SaclDefaulted flag.</span></div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;        *SaclDefaulted = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e">SE_SACL_DEFAULTED</a> );</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;    }</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;}</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02707"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a8b44a03dd9ddd7d2fb3abe5a92a38c88"> 2707</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a8b44a03dd9ddd7d2fb3abe5a92a38c88">RtlSetOwnerSecurityDescriptor</a> (</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> Owner <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> OwnerDefaulted OPTIONAL</div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;    )</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;</div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="comment">    This procedure sets the owner information of an absolute security</span></div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;<span class="comment">    descriptor.  If there is already an owner present in the security</span></div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;<span class="comment">    descriptor, it is superseded.</span></div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor in which</span></div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;<span class="comment">        the owner is to be set.  If the security descriptor already</span></div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;<span class="comment">        includes an owner, it will be superseded by the new owner.</span></div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="comment">    Owner - Supplies the owner SID for the security descriptor.  If</span></div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;<span class="comment">        this optional parameter is not passed, then the owner is</span></div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;<span class="comment">        cleared (indicating the security descriptor has no owner).</span></div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;<span class="comment">        The SID is referenced by, not copied into, the security</span></div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;<span class="comment">        descriptor.</span></div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;<span class="comment">    OwnerDefaulted - When set, indicates the owner was picked up from</span></div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;<span class="comment">        some default mechanism (rather than explicitly specified by a</span></div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;<span class="comment">        user).  This value is set in the OwnerDefaulted control flag</span></div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;<span class="comment">        in the security descriptor.  If this optional parameter is</span></div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;<span class="comment">        not passed, then the SaclDefaulted flag will be cleared.</span></div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;<span class="comment">    STATUS_INVALID_SECURITY_DESCR - Indicates the security descriptor</span></div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;<span class="comment">        is not an absolute format security descriptor.</span></div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;{</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;</div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;    }</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;    <span class="comment">// Make sure the descriptor is absolute format</span></div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>) {</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    }</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;    <span class="comment">// Assign the Owner field if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;    ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a70c93c5c3fa5b26ae1cee641896d9b0e">Owner</a> = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(Owner)) {</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a70c93c5c3fa5b26ae1cee641896d9b0e">Owner</a> = Owner;</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    }</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;    <span class="comment">// Assign the OwnerDefaulted flag if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;    ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a>;</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;    <span class="keywordflow">if</span> (OwnerDefaulted == <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a>;</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;    }</div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;}</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02803"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a7709180d5aabe3a5e90ddb1baed750d5"> 2803</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a7709180d5aabe3a5e90ddb1baed750d5">RtlGetOwnerSecurityDescriptor</a> (</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> *Owner,</div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> OwnerDefaulted</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;    )</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;<span class="comment">    This procedure retrieves the owner information of a security</span></div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;<span class="comment">    descriptor.</span></div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;<span class="comment">    Owner - Receives a pointer to the owner SID.  If the security</span></div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;<span class="comment">        descriptor does not currently contain an owner, then this</span></div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;<span class="comment">        value will be returned as null.  In this case, the remaining</span></div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;<span class="comment">        OUT parameters are not given valid return values.  Otherwise,</span></div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;<span class="comment">        this parameter points to an SID and the remaining OUT</span></div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;<span class="comment">        parameters are provided valid return values.</span></div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;<span class="comment">    OwnerDefaulted - This value is returned only if the value</span></div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;<span class="comment">        returned for the Owner parameter is not null.  In this case,</span></div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;<span class="comment">        the OwnerDefaulted parameter receives the value of the</span></div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;<span class="comment">        security descriptor&#39;s OwnerDefaulted control flag.</span></div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;{</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;    }</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;    <span class="comment">// Return the Owner field value.</span></div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;    *Owner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;    <span class="comment">// Return the OwnerDefaulted flag value.</span></div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;    *OwnerDefaulted = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a> );</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;}</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02879"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ae8e993c3bb60d9a0e04837b21c2bb45c"> 2879</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae8e993c3bb60d9a0e04837b21c2bb45c">RtlSetGroupSecurityDescriptor</a> (</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> <a class="code" href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a> <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> GroupDefaulted OPTIONAL</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;    )</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;<span class="comment">    This procedure sets the primary group information of an absolute security</span></div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment">    descriptor.  If there is already an primary group present in the</span></div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;<span class="comment">    security descriptor, it is superseded.</span></div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor in which</span></div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;<span class="comment">        the primary group is to be set.  If the security descriptor</span></div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;<span class="comment">        already includes a primary group, it will be superseded by</span></div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;<span class="comment">        the new group.</span></div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;<span class="comment">    Group - Supplies the primary group SID for the security</span></div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;<span class="comment">        descriptor.  If this optional parameter is not passed, then</span></div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;<span class="comment">        the primary group is cleared (indicating the security</span></div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;<span class="comment">        descriptor has no primary group).  The SID is referenced by,</span></div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;<span class="comment">        not copied into, the security descriptor.</span></div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="comment">    GroupDefaulted - When set, indicates the owner was picked up from</span></div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment">        some default mechanism (rather than explicitly specified by a</span></div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment">        user).  This value is set in the OwnerDefaulted control flag</span></div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;<span class="comment">        in the security descriptor.  If this optional parameter is</span></div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;<span class="comment">        not passed, then the SaclDefaulted flag will be cleared.</span></div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;<span class="comment">    STATUS_INVALID_SECURITY_DESCR - Indicates the security descriptor</span></div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="comment">        is not an absolute format security descriptor.</span></div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;{</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;</div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;</div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor = SecurityDescriptor;</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    }</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    <span class="comment">// Make sure the descriptor is absolute format</span></div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>) {</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    }</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;    <span class="comment">// Assign the Group field if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aed1f892c4fab4b52b60ac0e13a412036">Group</a> = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(<a class="code" href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a>)) {</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aed1f892c4fab4b52b60ac0e13a412036">Group</a> = <a class="code" href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a>;</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;    }</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;    <span class="comment">// Assign the GroupDefaulted flag if passed, otherwise clear it.</span></div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;    ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a>;</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(GroupDefaulted)) {</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a>;</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    }</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;}</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l02976"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#af55de731f3daac1ea87ea3ef7737e1ee"> 2976</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#af55de731f3daac1ea87ea3ef7737e1ee">RtlGetGroupSecurityDescriptor</a> (</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> *<a class="code" href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a>,</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> GroupDefaulted</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;    )</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;<span class="comment">    This procedure retrieves the primary group information of a</span></div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;<span class="comment">    security descriptor.</span></div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;<span class="comment">    SecurityDescriptor - Supplies the security descriptor.</span></div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;<span class="comment">    Group - Receives a pointer to the primary group SID.  If the</span></div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;<span class="comment">        security descriptor does not currently contain a primary</span></div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;<span class="comment">        group, then this value will be returned as null.  In this</span></div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;<span class="comment">        case, the remaining OUT parameters are not given valid return</span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;<span class="comment">        values.  Otherwise, this parameter points to an SID and the</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;<span class="comment">        remaining OUT parameters are provided valid return values.</span></div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;<span class="comment">    GroupDefaulted - This value is returned only if the value</span></div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;<span class="comment">        returned for the Group parameter is not null.  In this case,</span></div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;<span class="comment">        the GroupDefaulted parameter receives the value of the</span></div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;<span class="comment">        security descriptor&#39;s GroupDefaulted control flag.</span></div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;<span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span></div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the revision of the security</span></div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;<span class="comment">        descriptor is not known to the routine.  It may be a newer</span></div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;<span class="comment">        revision than the routine knows about.</span></div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;{</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;    <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span></div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *ISecurityDescriptor =</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;        (<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)SecurityDescriptor;</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;    <span class="comment">// Check the revision</span></div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;    }</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;</div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;    <span class="comment">// Return the Group field value.</span></div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;    *Group = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(ISecurityDescriptor);</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;    <span class="comment">// Return the GroupDefaulted flag value.</span></div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;    *GroupDefaulted = <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( ISecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a> );</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;}</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l03053"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a0efacda5cdc2ad0345fca5f8fde2b155"> 3053</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a0efacda5cdc2ad0345fca5f8fde2b155">RtlAreAllAccessesGranted</a>(</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> GrantedAccess,</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> DesiredAccess</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    )</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;<span class="comment">    This routine is used to check a desired access mask against a</span></div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;<span class="comment">    granted access mask.  It is used by the Object Management</span></div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;<span class="comment">    component when dereferencing a handle.</span></div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;<span class="comment">        GrantedAccess - Specifies the granted access mask.</span></div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;<span class="comment">        DesiredAccess - Specifies the desired access mask.</span></div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;<span class="comment">    BOOLEAN - TRUE if the GrantedAccess mask has all the bits set</span></div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;<span class="comment">        that the DesiredAccess mask has set.  That is, TRUE is</span></div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;<span class="comment">        returned if all of the desired accesses have been granted.</span></div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;{</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;    <span class="keywordflow">return</span> ((<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)((~(GrantedAccess) &amp; (DesiredAccess)) == 0));</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;}</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l03088"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a98ed9bc41b41b1f5f6bd1d4cdb3f2a0d"> 3088</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a98ed9bc41b41b1f5f6bd1d4cdb3f2a0d">RtlAreAnyAccessesGranted</a>(</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> GrantedAccess,</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> DesiredAccess</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    )</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;<span class="comment">    This routine is used to test whether any of a set of desired</span></div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;<span class="comment">    accesses are granted by a granted access mask.  It is used by</span></div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;<span class="comment">    components other than the the Object Management component for</span></div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;<span class="comment">    checking access mask subsets.</span></div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;<span class="comment">        GrantedAccess - Specifies the granted access mask.</span></div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;<span class="comment">        DesiredAccess - Specifies the desired access mask.</span></div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;<span class="comment">    BOOLEAN - TRUE if the GrantedAccess mask contains any of the bits</span></div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;<span class="comment">        specified in the DesiredAccess mask.  That is, if any of the</span></div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;<span class="comment">        desired accesses have been granted, TRUE is returned.</span></div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;{</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;    <span class="keywordflow">return</span> ((<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)(((GrantedAccess) &amp; (DesiredAccess)) != 0));</div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;}</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l03125"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a4463c888f291f366516bb8843732a9a6"> 3125</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a4463c888f291f366516bb8843732a9a6">RtlMapGenericMask</a>(</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a537521ea5f9e4ec4b4288628a0b86d5d">PACCESS_MASK</a> AccessMask,</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;    )</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;<span class="comment">    This routine maps all generic accesses in the provided access mask</span></div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;<span class="comment">    to specific and standard accesses according to the provided</span></div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;<span class="comment">    GenericMapping.</span></div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;<span class="comment">        AccessMask - Points to the access mask to be mapped.</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;<span class="comment">        GenericMapping - The mapping of generic to specific and standard</span></div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;<span class="comment">                         access types.</span></div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;<span class="comment">    None.</span></div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;{</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;</div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;<span class="comment">//    //</span></div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;<span class="comment">//    // Make sure the pointer is properly aligned</span></div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;<span class="comment">//    //</span></div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;    <span class="keywordflow">if</span> (*AccessMask &amp; <a class="code" href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a>) {</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;        *AccessMask |= GenericMapping-&gt;GenericRead;</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;    }</div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;    <span class="keywordflow">if</span> (*AccessMask &amp; <a class="code" href="../../d3/d3a/a02259.html#ae7a3106c6bef5edbff79f9e203c7ccf4">GENERIC_WRITE</a>) {</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;        *AccessMask |= GenericMapping-&gt;GenericWrite;</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;    }</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;    <span class="keywordflow">if</span> (*AccessMask &amp; <a class="code" href="../../d3/d3a/a02259.html#af61ec68f6a67fc6167e4eabd117b2b3b">GENERIC_EXECUTE</a>) {</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;        *AccessMask |= GenericMapping-&gt;GenericExecute;</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;    }</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;</div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;    <span class="keywordflow">if</span> (*AccessMask &amp; <a class="code" href="../../d3/d3a/a02259.html#aad70cf4262d42fc67104c6d9bb407cd4">GENERIC_ALL</a>) {</div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;        *AccessMask |= GenericMapping-&gt;GenericAll;</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;    }</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;</div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;    <span class="comment">// Now clear the generic flags</span></div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;    *AccessMask &amp;= ~(GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | <a class="code" href="../../d3/d3a/a02259.html#aad70cf4262d42fc67104c6d9bb407cd4">GENERIC_ALL</a>);</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;</div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;}</div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;</div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l03189"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ab4216159656088d3e13d13a6d5f6d1b1"> 3189</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ab4216159656088d3e13d13a6d5f6d1b1">RtlpImpersonateSelfEx</a> (</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a0841cdb9e3ad77ad9a0fe50e05026401">SECURITY_IMPERSONATION_LEVEL</a> ImpersonationLevel,</div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> AdditionalAccess,</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a75af6aee35551eeff024eb003e8eee22">PHANDLE</a> ThreadToken <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a></div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;    )</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;<span class="comment">    This routine may be used to obtain an Impersonation token representing</span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="comment">    your own process&#39;s context.  This may be useful for enabling a privilege</span></div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;<span class="comment">    for a single thread rather than for the entire process; or changing</span></div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="comment">    the default DACL for a single thread.</span></div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;<span class="comment">    The token is assigned to the callers thread.</span></div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;<span class="comment">    The caller may optionally request to receive a handle to the token assigned</span></div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;<span class="comment">    to the thread, obviating the need for a subsequent call solely to open the</span></div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;<span class="comment">    thread token.</span></div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;<span class="comment">    ImpersonationLevel - The level to make the impersonation token.</span></div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;<span class="comment">    AdditionalAccess - Additional requested access rights to the thread token </span></div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;<span class="comment">        handle beyond TOKEN_IMPERSONATE. If an output handle is not specified, </span></div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;<span class="comment">        this value must be zero.</span></div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;<span class="comment">    ThreadToken - Optional output pointer which receives a handle to the current </span></div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;<span class="comment">        thread token upon successful completion of this routine.</span></div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;<span class="comment">    NTSTATUS.</span></div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;{</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>, Status1;</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> Token1, Token2;</div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;    <a class="code" href="../../dd/dad/a01235.html">OBJECT_ATTRIBUTES</a> ObjectAttributes;</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;    <a class="code" href="../../d7/d29/a01589.html">SECURITY_QUALITY_OF_SERVICE</a> Qos;</div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a> ();</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a> (ThreadToken) &amp;&amp; (AdditionalAccess != 0)) {</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a5f4f09d62ff51bb9ef6e3dd6f0eb88b4">STATUS_INVALID_PARAMETER_2</a>;</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;    }</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;    </div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a327a7264f49955a340d1b07a90e1c62e">InitializeObjectAttributes</a> (&amp;ObjectAttributes, <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;    Qos.<a class="code" href="../../d7/d29/a01589.html#a8f4e4ca9a25a61e46d5a7bc754f3fb25">Length</a> = <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d3a/a02259.html#a80b600d19cb808f261dd4d305de14927">SECURITY_QUALITY_OF_SERVICE</a>);</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;    Qos.<a class="code" href="../../d7/d29/a01589.html#ae0193db9a6f380415db53c5bc702b4e3">ImpersonationLevel</a> = ImpersonationLevel;</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;    Qos.<a class="code" href="../../d7/d29/a01589.html#a3501dda7ede19670b2b46138cc82707f">ContextTrackingMode</a> = <a class="code" href="../../d3/d3a/a02259.html#af6b2d90a83069813c4ffab10f943a36f">SECURITY_DYNAMIC_TRACKING</a>;</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;    Qos.<a class="code" href="../../d7/d29/a01589.html#ac099321a3499f22a14c36b43ae5fcaf1">EffectiveOnly</a> = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;    ObjectAttributes.<a class="code" href="../../dd/dad/a01235.html#a9fe901e278495c5490b3288d26636482">SecurityQualityOfService</a> = &amp;Qos;</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;    Status = <a class="code" href="../../d3/d3a/a02259.html#a28a40ba853d20ecf9ac183c572c2cace">NtOpenProcessToken</a> (<a class="code" href="../../db/d7a/a02253.html#a719a7ce85358702f11dce2cd31896b4b">NtCurrentProcess</a>(), <a class="code" href="../../d3/d3a/a02259.html#a279babfff7df280bed29afa27c3bc27c">TOKEN_DUPLICATE</a>, &amp;Token1);</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        Status = <a class="code" href="../../d3/d3a/a02259.html#afaa027bcf070507dd737b67c4a404882">NtDuplicateToken</a> (</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;                     Token1,</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;                     <a class="code" href="../../d3/d3a/a02259.html#abb05f20ab4635bb0f610c0d1d3a42c42">TOKEN_IMPERSONATE</a> | AdditionalAccess,</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;                     &amp;ObjectAttributes,</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;                     <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,                 <span class="comment">//EffectiveOnly</span></div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;                     <a class="code" href="../../d3/d3a/a02259.html#a198a439317e2511cd5f3e09472e903eaa13321ee2555d06f3c7dee5fdf2fc36aa">TokenImpersonation</a>,</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;                     &amp;Token2</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;                     );</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;        </div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;            </div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;            Status = <a class="code" href="../../db/d7a/a02253.html#afdbb1a6fd7c93dbb3641b309895bbd59">NtSetInformationThread</a> (</div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;                         <a class="code" href="../../db/d7a/a02253.html#ab24eb59f288b52281cad79f4a3871b1d">NtCurrentThread</a> (),</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;                         <a class="code" href="../../db/d7a/a02253.html#a65780912cd4fb95e0089374e5a58e603a76474afacf68326759d287ada0de8afa">ThreadImpersonationToken</a>,</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;                         &amp;Token2,</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;                         <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a>)</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                         );</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a> (Status) &amp;&amp; <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a> (ThreadToken)) {</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;                *ThreadToken = Token2;</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;                Status1 = <a class="code" href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a> (Token2);</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;                NT_ASSERT (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a> (Status1));</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;            }</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;        }</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;</div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;        Status1 = <a class="code" href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a> (Token1);</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;        NT_ASSERT (<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a> (Status1));</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;    }</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;}</div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;</div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l03284"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a1260d74eed143f5ac73b7028c66d6fef"> 3284</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a1260d74eed143f5ac73b7028c66d6fef">RtlImpersonateSelf</a> (</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a0841cdb9e3ad77ad9a0fe50e05026401">SECURITY_IMPERSONATION_LEVEL</a> ImpersonationLevel</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;    )</div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;<span class="comment">    This routine may be used to obtain an Impersonation token representing</span></div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;<span class="comment">    your own process&#39;s context.  This may be useful for enabling a privilege</span></div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;<span class="comment">    for a single thread rather than for the entire process; or changing</span></div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;<span class="comment">    the default DACL for a single thread.</span></div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;<span class="comment">    N.B. This routine now simply invokes RtlpImpersonateSelfEx.</span></div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;<span class="comment">    ImpersonationLevel - The level to make the impersonation token.</span></div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;<span class="comment">    NSTATUS.</span></div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;{</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a> ();</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d3/d32/a02665.html#ab4216159656088d3e13d13a6d5f6d1b1">RtlpImpersonateSelfEx</a> (ImpersonationLevel, 0, <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;}</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;</div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;</div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l03317"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c"> 3317</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a> (</div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;    )</div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;<span class="comment">    This is a private routine that maps Access Masks of an ACL so that</span></div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;<span class="comment">    they are applicable to the object type the ACL is being applied to.</span></div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;<span class="comment">    Only known DSA ACEs are mapped.  Unknown ACE types are ignored.</span></div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;<span class="comment">    Only access types in the GenericAll mapping for the target object</span></div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;<span class="comment">    type will be non-zero upon return.</span></div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;<span class="comment">    Acl - Supplies the acl being applied.</span></div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;<span class="comment">    None.</span></div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;{</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> Ace;</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;    <span class="comment">//  First check if the acl is null</span></div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;</div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    <span class="keywordflow">if</span> (Acl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;    }</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;    <span class="comment">// Now walk the ACL, mapping each ACE as we go.</span></div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;    <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl);</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;         i &lt; Acl-&gt;AceCount;</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;         i += 1, Ace = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(Ace)) {</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a>( Ace )) {</div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#aea7f07b5b74d7f1bdb529aab026c79c6">RtlApplyAceToObject</a>( Ace, GenericMapping );</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;        }</div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;</div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    }</div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;}</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l03385"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30"> 3385</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30">RtlpCopyEffectiveAce</a> (</div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce,</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> WillGenerateInheritAce,</div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> *AcePosition,</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceLength,</div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited OPTIONAL,</div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> EffectiveAceMapped,</div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> AclOverflowed</div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;    )</div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;<span class="comment">    This routine copy a specified ACE into an ACL as an effective ACE.</span></div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;<span class="comment">    The resultant ACE has all the inheritance bits turned of.</span></div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;<span class="comment">    The resultant ACE has the SID mapped from a generic SID to a specific SID</span></div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;<span class="comment">    (e.g., From &quot;creator owner&quot; to the passed in owner sid).</span></div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;<span class="comment">    OldAce - Supplies the ace being inherited</span></div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;<span class="comment">    AutoInherit - Specifies if the inheritance is an &quot;automatic inheritance&quot;.</span></div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;<span class="comment">        As such, the inherited ACEs will be marked as such.</span></div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;<span class="comment">    WillGenerateInheritAce - Specifies if the caller intends to generate an</span></div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;<span class="comment">        inheritable ACE the corresponds to OldAce.  If TRUE, this routine will</span></div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;<span class="comment">        try to not map the effective ACE (increasing the likelyhood that</span></div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;<span class="comment">        EffectiveAceMapped will return FALSE),</span></div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;<span class="comment">    ClientOwnerSid - Specifies the owner Sid to use</span></div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;<span class="comment">    ClientGroupSid - Specifies the new Group Sid to use</span></div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;<span class="comment">    ServerSid - Optionally specifies the Server Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;<span class="comment">    ClientSid - Optionally specifies the Client Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use</span></div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.  If not </span></div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;<span class="comment">        specified, the object has no object type.</span></div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;<span class="comment">    AcePosition - On entry and exit, specifies location of the next available ACE</span></div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;<span class="comment">        position in NewAcl.</span></div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;<span class="comment">        A NULL ACE position means there is no room at all in NewAcl.</span></div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;<span class="comment">    NewAceLength - Returns the length (in bytes) needed in NewAcl to</span></div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;<span class="comment">        copy the specified ACE. This might be zero to indicate that the ACE</span></div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;<span class="comment">        need not be copied at all.</span></div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;<span class="comment">    NewAcl - Provides a pointer to the ACL into which the ACE is to be</span></div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;<span class="comment">        inherited.</span></div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;<span class="comment">    ObjectAceInherited - Returns true if one or more object ACEs were inherited</span></div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;<span class="comment">        based on NewObjectType</span></div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;<span class="comment">        If NULL, NewObjectType is ignored and the object ACE is always inherited</span></div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;<span class="comment">    EffectiveAceMapped - Return TRUE if the SID, guid, or access mask of Old Ace</span></div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;<span class="comment">        was modifed when copying the ACE.</span></div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;<span class="comment">    AclOverflowed - Returns TRUE if NewAcl wasn&#39;t long enough to contain NewAceLength.</span></div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;<span class="comment">    TRUE - No problem was detected.</span></div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;<span class="comment">    FALSE - Indicates something went wrong preventing</span></div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;<span class="comment">        the ACE from being copied.  This generally represents a bugcheck</span></div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;<span class="comment">        situation when returned from this call.</span></div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;{</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a>;</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> LocalMask;</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> GuidOptimizationPossible = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> LocalServerOwner;</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> LocalServerGroup;</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreatorSid[<a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>];</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;    <a class="code" href="../../dd/d90/a01626.html">SID_IDENTIFIER_AUTHORITY</a>  CreatorSidAuthority = <a class="code" href="../../d3/d3a/a02259.html#ae3bf1a31d65e4d15c09a8cd24dc0c0c2">SECURITY_CREATOR_SID_AUTHORITY</a>;</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    <span class="comment">// Allocate and initialize the universal SIDs we&#39;re going to need</span></div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;    <span class="comment">// to look for inheritable ACEs.</span></div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;</div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a>( 1 ) == <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>);</div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, &amp;CreatorSidAuthority, 1 );</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;</div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;    }</div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;    *(<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, 0 )) = <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>;</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;    LocalServerOwner = <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ServerOwnerSid) ? ServerOwnerSid : ClientOwnerSid;</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    LocalServerGroup = <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ServerGroupSid) ? ServerGroupSid : ClientGroupSid;</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;    <span class="comment">// Initialization</span></div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ObjectAceInherited)) {</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;        *ObjectAceInherited = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;    }</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    *AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    LengthRequired = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)OldAce-&gt;AceSize;</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    <span class="comment">// Process all MS ACE types specially</span></div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    if ( <a class="code" href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a>(OldAce) ) {</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;        <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Rid;</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SidToCopy = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;        <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AceHeaderToCopyLength;</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;        <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> AceHeaderToCopy = OldAce;</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerSidToCopy = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;        <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> DummyAce[<span class="keyword">sizeof</span>(<a class="code" href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a>)+<span class="keyword">sizeof</span>(<a class="code" href="../../db/d44/a00533.html">GUID</a>)];</div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        <span class="comment">// Grab the Sid pointer and access mask as a function of the ACE type</span></div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/d4d/a02285.html#ac8e0a4c85a16a9dc80eecaa9f1ad4139">IsKnownAceType</a>( OldAce ) ) {</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;            SidToCopy = &amp;((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)OldAce)-&gt;SidStart;</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;            AceHeaderToCopyLength = <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>, SidStart);</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a>(OldAce)) {</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;            SidToCopy = <a class="code" href="../../de/dc3/a02256.html#ac2b83a0ab0baf87298094ed858d91248">RtlCompoundAceClientSid</a>( OldAce );</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;            AceHeaderToCopyLength = <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d3/daf/a00790.html">KNOWN_COMPOUND_ACE</a>, SidStart);</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d3/daf/a00790.html">KNOWN_COMPOUND_ACE</a>, Mask) ==</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>, Mask) );</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;            <span class="comment">// Compound ACEs have two SIDs (Map one now).</span></div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;            ServerSidToCopy = <a class="code" href="../../de/dc3/a02256.html#a629256bb2488240a06b6827cc90016a6">RtlCompoundAceServerSid</a>( OldAce );</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a> ( ServerSidToCopy, CreatorSid )) {</div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;                Rid = *<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( ServerSidToCopy, 0 );</div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;                <span class="keywordflow">switch</span> (Rid) {</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>:</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;                    ServerSidToCopy = ClientOwnerSid;</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;                    LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientOwnerSid);</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;                    *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a>:</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;                    <span class="keywordflow">if</span> ( ClientGroupSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;                        ServerSidToCopy = ClientGroupSid;</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;                        LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientGroupSid);</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;                        *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;                    }</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#a97ad0204224abe93ef689dbe8ebabc36">SECURITY_CREATOR_OWNER_SERVER_RID</a>:</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;                    ServerSidToCopy = LocalServerOwner;</div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;                    LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(LocalServerOwner);</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;                    *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#a3e6f1b8d0a078bc25ae7ea3a6b5c3ecb">SECURITY_CREATOR_GROUP_SERVER_RID</a>:</div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;                    ServerSidToCopy = LocalServerGroup;</div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;                    LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(LocalServerGroup);</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;                    *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;                }</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;</div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;                <span class="comment">// If we don&#39;t know what this SID is, just copy the original.</span></div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;                <span class="keywordflow">if</span> ( !*EffectiveAceMapped ) {</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;                    AceHeaderToCopyLength += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( ServerSidToCopy );</div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;                    ServerSidToCopy = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;                }</div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;</div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;                <span class="comment">// We don&#39;t know what this SID is, just copy the original.</span></div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;                AceHeaderToCopyLength += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( ServerSidToCopy );</div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;                ServerSidToCopy = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;            }</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;</div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;        <span class="comment">// Handle Object ACEs</span></div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;            <a class="code" href="../../db/d44/a00533.html">GUID</a> *InheritedObjectType;</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;            SidToCopy = <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>( OldAce );</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;            AceHeaderToCopyLength = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>) ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)SidToCopy - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)OldAce);</div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d4/d45/a00791.html">KNOWN_OBJECT_ACE</a>, Mask) ==</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>, Mask) );</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;            <span class="comment">// Handle ACEs that are only inherited for a specific object type,</span></div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;            InheritedObjectType = <a class="code" href="../../df/d4d/a02285.html#adfcbc9779e90e656630eab7a9e1a2173">RtlObjectAceInheritedObjectType</a>( OldAce );</div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ObjectAceInherited) &amp;&amp; InheritedObjectType != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;                <span class="comment">// If the object type doesn&#39;t match the inherited object type,</span></div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;                <span class="comment">//  don&#39;t inherit the ACE.</span></div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;                <span class="keywordflow">if</span> ( pNewObjectType == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;                     !<a class="code" href="../../d3/d32/a02665.html#ade7b3318164b177270351c77baa8d79f">RtlpGuidPresentInGuidList</a>( InheritedObjectType,</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;                                      pNewObjectType,</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;                                      GuidCount ) ) {</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;                    LengthRequired = 0;</div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;                <span class="comment">// If the object type matches the inherited object type,</span></div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;                <span class="comment">//  Inherit an ACE with no inherited object type.</span></div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;</div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;</div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;                    <span class="comment">// Tell the caller we inherited an object type specific ACE.</span></div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;</div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;                    *ObjectAceInherited = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;</div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;                    <span class="comment">// If the caller is not going to generate an inheritable ACE,</span></div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;                    <span class="comment">//  deleting the inherited object type GUID for the effective ACE.</span></div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;                    <span class="comment">// Otherwise, leave it so the caller can merge the two ACEs.</span></div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;</div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;                    <span class="keywordflow">if</span> ( !WillGenerateInheritAce ) {</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;                        *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;</div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;                        <span class="comment">// If an object type GUID is present,</span></div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;                        <span class="comment">//  simply delete the inherited object type GUID.</span></div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;                        <span class="keywordflow">if</span> ( <a class="code" href="../../df/d4d/a02285.html#ab1f11dd357b660fd4f53cdc00bb14e6f">RtlObjectAceObjectTypePresent</a>( OldAce )) {</div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;                            LengthRequired -= <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>);</div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;                            AceHeaderToCopyLength -= <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>);</div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( DummyAce, OldAce, AceHeaderToCopyLength );</div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;                            AceHeaderToCopy = (<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)DummyAce;</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;                            ((<a class="code" href="../../df/d4d/a02285.html#a78b32f38b2da7b2c358f21a6f32190df">PKNOWN_OBJECT_ACE</a>)AceHeaderToCopy)-&gt;Flags &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a28ecb45729f526c980a209c524cb8eb2">ACE_INHERITED_OBJECT_TYPE_PRESENT</a>;</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;</div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;</div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;                        <span class="comment">// If an object type GUID is not present,</span></div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;                        <span class="comment">//  convert the ACE to non-object type specific.</span></div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;                            AceHeaderToCopyLength = AceHeaderToCopyLength -</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>) +</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>) -</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a>);</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;                            LengthRequired = LengthRequired -</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>) +</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>) -</div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;                                             <span class="keyword">sizeof</span>(<a class="code" href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a>);</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( DummyAce, OldAce, AceHeaderToCopyLength );</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;                            AceHeaderToCopy = (<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)DummyAce;</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;</div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;                            AceHeaderToCopy-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> = <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ OldAce-&gt;AceType ];</div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;</div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;                        }</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;                        GuidOptimizationPossible = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;                    }</div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;                }</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;            }</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;        }</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;</div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;        <span class="comment">// Only proceed if we&#39;ve not already determined to drop the ACE.</span></div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;        <span class="keywordflow">if</span> ( LengthRequired != 0 ) {</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;</div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;            <span class="comment">// If after mapping the access mask, the access mask</span></div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;            <span class="comment">// is empty, then drop the ACE.</span></div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;            <span class="comment">// This is incompatible with NT 4.0 which simply mapped and left</span></div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;            <span class="comment">//  undefined access bits set.</span></div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;            LocalMask = ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(OldAce))-&gt;Mask;</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#a226f8b2aa65758424db1dd0f51011d32">RtlApplyGenericMask</a>( OldAce, &amp;LocalMask, GenericMapping);</div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;            <span class="keywordflow">if</span> ( LocalMask != ((<a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a>)(OldAce))-&gt;Mask ) {</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;                *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;            }</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;            <span class="comment">// Mask off any bits that aren&#39;t meaningful</span></div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;            LocalMask &amp;= ( <a class="code" href="../../d3/d3a/a02259.html#aa7206f38a9d41e461e3a4ab8b03f0836">STANDARD_RIGHTS_ALL</a> | <a class="code" href="../../d3/d3a/a02259.html#a028070e7db6ceff42020d0021d503f92">SPECIFIC_RIGHTS_ALL</a> | <a class="code" href="../../d3/d3a/a02259.html#a411b6515ba148a094881e66e79cfe44f">ACCESS_SYSTEM_SECURITY</a> );</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;            <span class="keywordflow">if</span> (LocalMask == 0) {</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;                LengthRequired = 0;</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;</div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;</div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;                <span class="comment">// See if the SID in the ACE is one of the various CREATOR_* SIDs by</span></div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;                <span class="comment">// comparing identifier authorities.</span></div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a> ( SidToCopy, CreatorSid )) {</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;                    Rid = *<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( SidToCopy, 0 );</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;                    <span class="keywordflow">switch</span> (Rid) {</div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>:</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;                        SidToCopy = ClientOwnerSid;</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;                        LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientOwnerSid);</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;                        *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a>:</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;                        <span class="keywordflow">if</span> ( ClientGroupSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;                            SidToCopy = ClientGroupSid;</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;                            LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientGroupSid);</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;                            *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;                        }</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#a97ad0204224abe93ef689dbe8ebabc36">SECURITY_CREATOR_OWNER_SERVER_RID</a>:</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;                        SidToCopy = LocalServerOwner;</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;                        LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(LocalServerOwner);</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;                        *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#a3e6f1b8d0a078bc25ae7ea3a6b5c3ecb">SECURITY_CREATOR_GROUP_SERVER_RID</a>:</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;                        SidToCopy = LocalServerGroup;</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;                        LengthRequired = LengthRequired - <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a> + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(LocalServerGroup);</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;                        *EffectiveAceMapped = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;                    <span class="keywordflow">default</span> :</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;                        <span class="comment">// We don&#39;t know what this SID is, just copy the original.</span></div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;                    }</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;                }</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;                <span class="comment">// In cases where effective ace has been mapped because of</span></div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;                <span class="comment">//     a. CreatorOwner/Group OR</span></div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;                <span class="comment">//     b. Generic flags</span></div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;                <span class="comment">// AND</span></div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;                <span class="comment">//     this is an object type ace which will generate an IO ace</span></div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;                <span class="comment">// we can save space for a guid.</span></div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;</div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;                <span class="keywordflow">if</span> (GuidOptimizationPossible &amp;&amp; *EffectiveAceMapped) {</div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;                    <span class="comment">// If an object type GUID is present,</span></div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;                    <span class="comment">//  simply delete the inherited object type GUID.</span></div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;</div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;                    <span class="keywordflow">if</span> ( <a class="code" href="../../df/d4d/a02285.html#ab1f11dd357b660fd4f53cdc00bb14e6f">RtlObjectAceObjectTypePresent</a>( OldAce )) {</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;                        LengthRequired -= <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>);</div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                        AceHeaderToCopyLength -= <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>);</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( DummyAce, OldAce, AceHeaderToCopyLength );</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;</div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;                        AceHeaderToCopy = (<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)DummyAce;</div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;                        ((<a class="code" href="../../df/d4d/a02285.html#a78b32f38b2da7b2c358f21a6f32190df">PKNOWN_OBJECT_ACE</a>)AceHeaderToCopy)-&gt;Flags &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a28ecb45729f526c980a209c524cb8eb2">ACE_INHERITED_OBJECT_TYPE_PRESENT</a>;</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;                    <span class="comment">// If an object type GUID is not present,</span></div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;                    <span class="comment">//  convert the ACE to non-object type specific.</span></div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;                        AceHeaderToCopyLength = AceHeaderToCopyLength -</div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>) +</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>) -</div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a>);</div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;                        LengthRequired = LengthRequired -</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a>) +</div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>) -</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;                                         <span class="keyword">sizeof</span>(<a class="code" href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a>);</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( DummyAce, OldAce, AceHeaderToCopyLength );</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;                        AceHeaderToCopy = (<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)DummyAce;</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;                        AceHeaderToCopy-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> = <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ OldAce-&gt;AceType ];</div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;                    }</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;                }</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;                <span class="comment">// If the ACE doesn&#39;t fit,</span></div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;                <span class="comment">//  just note the fact and don&#39;t copy the ACE.</span></div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;                <span class="keywordflow">if</span> ( *AcePosition == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;                     LengthRequired &gt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)NewAcl-&gt;AclSize - ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)(*AcePosition) - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) ) {</div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;                    *AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;</div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> Target;</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;</div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;                    <span class="comment">// Copy individual parts of the ACE separately.</span></div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;</div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;                    Target = (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)*AcePosition;</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;                        Target,</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;                        AceHeaderToCopy,</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;                        AceHeaderToCopyLength );</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;</div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;                    Target += AceHeaderToCopyLength;</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;                    <span class="comment">// Now copy the correct server SID</span></div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;                    <span class="keywordflow">if</span> ( ServerSidToCopy != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;                            Target,</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;                            ServerSidToCopy,</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;                            <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ServerSidToCopy)</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;                            );</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;                        Target += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ServerSidToCopy);</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;                    }</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;</div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;                    <span class="comment">// Now copy the correct SID</span></div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;</div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;                        Target,</div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;                        SidToCopy,</div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;                        <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(SidToCopy)</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;                        );</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;                    Target += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(SidToCopy);</div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;</div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;                    <span class="comment">// Set the size of the ACE accordingly</span></div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;                    <span class="keywordflow">if</span> ( LengthRequired &lt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(Target - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)*AcePosition) ) {</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;                    }</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;                    LengthRequired = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(Target - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)*AcePosition);</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;                    ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)*AcePosition)-&gt;Header.AceSize =</div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;                        (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)LengthRequired;</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;</div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;                    <span class="comment">// Put the mapped access mask in the new ACE</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;</div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;                    ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)*AcePosition)-&gt;Mask = LocalMask;</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                }</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;            }</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;        }</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;</div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;        <span class="comment">// If the ACE doesn&#39;t fit,</span></div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;        <span class="comment">//  just note the fact and don&#39;t copy the ACE.</span></div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;        <span class="keywordflow">if</span> ( LengthRequired &gt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)NewAcl-&gt;AclSize - ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)*AcePosition - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) ) {</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;            *AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;            <span class="comment">// Not a known ACE type, copy ACE as is</span></div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;</div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;                *AcePosition,</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                OldAce,</div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                LengthRequired );</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;         }</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;    }</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;    <span class="comment">// If the ACE was actually kept, clear all the inherit flags</span></div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;    <span class="comment">// and update the ACE count of the ACL.</span></div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;</div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;    <span class="keywordflow">if</span> ( !*AclOverflowed &amp;&amp; LengthRequired != 0 ) {</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;        ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)*AcePosition)-&gt;AceFlags &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#a003d67b3544da7d511ed48f876e2cfc7">VALID_INHERIT_FLAGS</a>;</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;        <span class="keywordflow">if</span> ( AutoInherit ) {</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;            ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)*AcePosition)-&gt;AceFlags |= <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>;</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;        }</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;        NewAcl-&gt;AceCount += 1;</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;    }</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;</div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;    <span class="comment">// We have the length of the new ACE, but we&#39;ve calculated</span></div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;    <span class="comment">// it with a ULONG.  It must fit into a USHORT.  See if it</span></div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;    <span class="comment">// does.</span></div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;    <span class="keywordflow">if</span> (LengthRequired &gt; 0xFFFF) {</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;    }</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;    <span class="comment">// Move the Ace Position to where the next ACE goes.</span></div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;    <span class="keywordflow">if</span> ( !*AclOverflowed ) {</div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;        *AcePosition = ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)*AcePosition) + <a class="code" href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a>;</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;    }</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;</div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;    <span class="comment">//  Now return to our caller</span></div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;    (*NewAceLength) = <a class="code" href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a>;</div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;}</div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;<span class="preprocessor">#ifndef WIN16</span></div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l03935"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98"> 3935</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">ACE_TYPE_TO_COPY</a> AceTypeToCopy,</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> AceFlagsToReset,</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> MapSids,</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> RetainInheritedAceBit,</div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAclSizeParam,</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl</div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;    )</div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;<span class="comment">    Copy ACEs from of an ACL and perform generic mapping.  Only ACEs specified</span></div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;<span class="comment">    by &#39;AceFilter&#39; are copied.</span></div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;<span class="comment">    Acl - Supplies the ACL to copy from.</span></div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;<span class="comment">    AceTypeToCopy - Describes which aces to copy.</span></div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;<span class="comment">    AceFlagsToReset - Bit mask of ACE flags to reset (if set) on each ACE.</span></div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;<span class="comment">    MapSids - TRUE if the SID in the ACE is to be mapped to the corresponding</span></div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;<span class="comment">        actual SID.</span></div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;<span class="comment">    ClientOwnerSid - Specifies the owner Sid to use</span></div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;<span class="comment">    ClientGroupSid - Specifies the new Group Sid to use</span></div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;<span class="comment">    ServerOwnerSid - Optionally specifies the Server Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;<span class="comment">    ServerGroupSid - Optionally specifies the Server group Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;<span class="comment">    IsDirectoryObject - Whether the object is a container or a non-container</span></div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;<span class="comment">    RetainInheritedAceBit - Whether to retain INHERITED_ACE bit for effective aces.</span></div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;<span class="comment">    NewAclSizeParam - Receives the cumulative length of the copies ACEs</span></div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;<span class="comment">    NewAcl - Provides a pointer to the ACL to copy to.</span></div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;<span class="comment">        This ACL must already be initialized.</span></div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;<span class="comment">    STATUS_SUCCESS - An inheritable ACL has been generated.</span></div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl is too small for the</span></div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;<span class="comment">        copied ACEs.  The required size is returned in NewAceLength.</span></div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;</div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;{</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;</div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce;</div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewAclSize, NewAceSize;</div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> CopyAce;</div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> AcePosition;</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> LocalAutoInherit = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;</div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;</div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;    <span class="comment">// Validate the ACL.</span></div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#a91ce2ebf39e0a306fed674324f0637d3">ValidAclRevision</a>(NewAcl) ) {</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;    }</div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;</div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;    <span class="comment">// Find where the first ACE goes.</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#ad7275b209e70848b5ee23af762a1ed5e">RtlFirstFreeAce</a>( NewAcl, &amp;AcePosition )) {</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;    }</div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;</div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;    <span class="comment">// Walk through the original ACL copying ACEs.</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;</div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;    NewAclSize = 0;</div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;    <span class="keywordflow">for</span> (i = 0, OldAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl);</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;         i &lt; Acl-&gt;AceCount;</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;         i += 1, OldAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(OldAce)) {</div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;        <span class="comment">// If the ACE wasn&#39;t inherited,</span></div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;        <span class="comment">//  copy it.</span></div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;        <span class="keywordflow">switch</span> (AceTypeToCopy) {</div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc">CopyInheritedAces</a>:</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;            CopyAce = <a class="code" href="../../df/d4d/a02285.html#ac5fd69aebb752e1bc476afa0d6afa7e0">AceInherited</a>(OldAce);</div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">CopyNonInheritedAces</a>:</div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;            CopyAce = !<a class="code" href="../../df/d4d/a02285.html#ac5fd69aebb752e1bc476afa0d6afa7e0">AceInherited</a>(OldAce);</div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a>:</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;            CopyAce = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;            CopyAce = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;        }</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;</div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;        <span class="keywordflow">if</span> ( CopyAce ) {</div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;</div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;            <span class="comment">// If SIDs are to be mapped,</span></div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;            <span class="comment">//  do so (and potentially create up to two ACEs).</span></div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;</div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;            <span class="keywordflow">if</span> ( MapSids ) {</div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> TempAcePosition;</div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> EffectiveAceSize = 0;</div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EffectiveAceMapped;</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> GenerateInheritAce;</div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;                <span class="comment">// Remember where the next ACE will be copied.</span></div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;                TempAcePosition = AcePosition;</div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;                NewAceSize = 0;</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;                GenerateInheritAce = IsDirectoryObject &amp;&amp;</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;                    ((((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)OldAce)-&gt;AceFlags &amp; (<a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a>|<a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a>)) != 0);</div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;                <span class="comment">// If the original ACE is an effective ACE,</span></div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;                <span class="comment">//  create an effective ACE.</span></div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;</div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;                <span class="keywordflow">if</span> ( !(((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a>)) {</div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> LocalAclOverflowed;</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;</div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;                    <span class="comment">// If the ace has INHERITED_ACE bit and the caller has requested</span></div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;                    <span class="comment">// preservation of the bit, copy the effective ace as an</span></div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;                    <span class="comment">// INHERITED_ACE.</span></div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;                    LocalAutoInherit = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;                    <span class="keywordflow">if</span> ( RetainInheritedAceBit ) {</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;                        <span class="keywordflow">if</span> ( OldAce-&gt;<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>) {</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;                            LocalAutoInherit = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;                        }</div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;                    }</div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;</div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;                    <span class="comment">// Copy the effective ACE into the ACL.</span></div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;                    <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30">RtlpCopyEffectiveAce</a> (</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;                                    OldAce,</div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;                                    LocalAutoInherit,  </div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;                                    GenerateInheritAce,</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;                                    ClientOwnerSid,</div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;                                    ClientGroupSid,</div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;                                    ServerOwnerSid,</div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;                                    ServerGroupSid,</div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;                                    GenericMapping,</div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;                                    <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,   <span class="comment">// Always copy object ACES</span></div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;                                    0,</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;                                    &amp;TempAcePosition,</div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;                                    &amp;EffectiveAceSize,</div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;                                    NewAcl,</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;                                    <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,   <span class="comment">// Always copy object ACES</span></div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;                                    &amp;EffectiveAceMapped,</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;                                    &amp;LocalAclOverflowed ) ) {</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;</div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;                    }</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;                    <span class="keywordflow">if</span> (LocalAclOverflowed) {</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;                        AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;                    }</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;                    NewAceSize += EffectiveAceSize;</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;                    <span class="comment">// Reset any undesirable AceFlags.</span></div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;                    </div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;                    <span class="keywordflow">if</span> ( !AclOverflowed &amp;&amp; EffectiveAceSize != 0 ) {</div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;                        ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;</div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;                    }</div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;</div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;                }</div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;</div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;                <span class="comment">// If the original ACE is inheritable,</span></div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;                <span class="comment">//  create an inheritable ACE.</span></div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;                <span class="comment">// ASSERT: AcePosition points to where the effective ACE was copied</span></div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;                <span class="comment">// ASSERT: TempAcePosition points to where the inheritable ACE should be copied</span></div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;                <span class="keywordflow">if</span> ( GenerateInheritAce ) {</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;</div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;                    <span class="comment">// If a effective ACE was created,</span></div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;                    <span class="comment">//  and it wasn&#39;t mapped,</span></div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;                    <span class="comment">//  avoid generating another ACE and simply merge the inheritance bits into</span></div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;                    <span class="comment">//      the effective ACE.</span></div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;                    <span class="keywordflow">if</span> ( EffectiveAceSize != 0 &amp;&amp; !EffectiveAceMapped ) {</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;                       <span class="comment">//</span></div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;                       <span class="comment">// Copy the inherit bits from the original ACE.</span></div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;                       <span class="comment">//</span></div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;                       <span class="keywordflow">if</span> ( !AclOverflowed ) {</div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;                            ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags |=</div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;                                ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)OldAce)-&gt;AceFlags &amp; (<a class="code" href="../../d3/d3a/a02259.html#a003d67b3544da7d511ed48f876e2cfc7">VALID_INHERIT_FLAGS</a>);</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;                            ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;</div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;                       }</div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;</div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;</div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;                    <span class="comment">// Otherwise, generate an explicit inheritance ACE.</span></div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;                    <span class="comment">// But only if the access mask isn&#39;t zero.</span></div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;</div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a>(OldAce) || ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(OldAce))-&gt;Mask != 0 ) {</div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;                        <span class="comment">// Account for the new ACE being added to the ACL.</span></div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;                        NewAceSize += (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize);</div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;</div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;                        <span class="keywordflow">if</span> (NewAceSize &gt; 0xFFFF) {</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;                            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;                        }</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;</div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;                        <span class="comment">// If the ACE doesn&#39;t fit,</span></div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;                        <span class="comment">//  just note the fact and don&#39;t copy the ACE.</span></div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;</div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;                        <span class="keywordflow">if</span> ( ((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize &gt; NewAcl-&gt;AclSize - ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)TempAcePosition - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) ) {</div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;                            AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;</div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;                            <span class="comment">// copy it as is, but make sure the InheritOnly bit is set.</span></div>
<div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;</div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;                            <span class="keywordflow">if</span> ( !AclOverflowed ) {</div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;                                <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;                                    TempAcePosition,</div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;                                    OldAce,</div>
<div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;                                    ((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize</div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;                                    );</div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;                                ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)TempAcePosition)-&gt;AceFlags |= <a class="code" href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a>;</div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;                                ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)TempAcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;</div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;                                NewAcl-&gt;AceCount += 1;</div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;                            }</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;                        }</div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;                    }</div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;</div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;                }</div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;</div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;                NewAceSize = (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)OldAce-&gt;<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a>;</div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;</div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;                <span class="comment">// If the ACE doesn&#39;t fit,</span></div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;                <span class="comment">//  just note the fact and don&#39;t copy the ACE.</span></div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;</div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;                if ( AcePosition == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;                     NewAceSize &gt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)NewAcl-&gt;AclSize - ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)AcePosition - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) ) {</div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;                    AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !AclOverflowed ) {</div>
<div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;</div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;</div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;                    <span class="comment">// Copy the ACE.</span></div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;</div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;                        AcePosition,</div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;                        OldAce,</div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;                        NewAceSize );</div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;</div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;                    <span class="comment">// Map the generic bits.</span></div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;                    <span class="comment">// Is it really right to map the generic bits on an ACE</span></div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;                    <span class="comment">// that&#39;s both effective and inheritable.  Shouldn&#39;t this</span></div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;                    <span class="comment">// be split into two ACEs in that case?  Or just skip the mapping?</span></div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a>( AcePosition )) {</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#aea7f07b5b74d7f1bdb529aab026c79c6">RtlApplyAceToObject</a>( (<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)AcePosition, GenericMapping );</div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;                    }</div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;</div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;                    <span class="comment">// Reset any undesirable AceFlags.</span></div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;</div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;                    ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;</div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;</div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;                    <span class="comment">// Account for the new ACE.</span></div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;</div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;                    NewAcl-&gt;AceCount += 1;</div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;                }</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;            }</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;            <span class="comment">// Move the Ace Position to where the next ACE goes.</span></div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;            <span class="keywordflow">if</span> ( !AclOverflowed ) {</div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;                AcePosition = ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)AcePosition) + NewAceSize;</div>
<div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;                <span class="comment">// On overflow, ensure no other ACEs are actually output to the buffer</span></div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;                AcePosition = ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) + NewAcl-&gt;AclSize;</div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;            }</div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;            NewAclSize += NewAceSize;</div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;</div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;        }</div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;    }</div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;</div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;</div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;    <span class="comment">// We have the length of the new ACE, but we&#39;ve calculated</span></div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;    <span class="comment">// it with a ULONG.  It must fit into a USHORT.  See if it</span></div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;    <span class="comment">// does.</span></div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;</div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;    <span class="keywordflow">if</span> (NewAclSize &gt; 0xFFFF) {</div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;    }</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;    (*NewAclSizeParam) = NewAclSize;</div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;</div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;    <span class="keywordflow">return</span> AclOverflowed ? <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> : <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;</div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;}</div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;</div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;</div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l04302"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aeaa146ca19ac4714659beabac108326a"> 4302</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aeaa146ca19ac4714659beabac108326a">RtlpInheritAcl2</a> (</div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> DirectoryAcl,</div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ChildAcl,</div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ChildGenericControl,</div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DefaultDescriptorForObject,</div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid,</div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> AclBufferSize,</div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> AclBuffer,</div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> NewAclExplicitlyAssigned,</div>
<div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;    )</div>
<div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;</div>
<div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;<span class="comment">    This is a private routine that produces an inherited acl from</span></div>
<div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;<span class="comment">    a parent acl according to the rules of inheritance</span></div>
<div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;<span class="comment">    DirectoryAcl - Supplies the acl being inherited.</span></div>
<div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;<span class="comment">    ChildAcl - Supplies the acl associated with the object.  This</span></div>
<div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;<span class="comment">        is either the current acl on the object or the acl being assigned</span></div>
<div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;<span class="comment">        to the object.</span></div>
<div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;<span class="comment">    ChildGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;<span class="comment">        describing the ChildAcl:</span></div>
<div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;<span class="comment">        SEP_ACL_PRESENT: Specifies that the child ACL is explictly supplied by</span></div>
<div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;<span class="comment">            the caller.</span></div>
<div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;<span class="comment">        SEP_ACL_DEFAULTED: Specifies that the child ACL was supplied by some</span></div>
<div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;<span class="comment">            defaulting mechanism.</span></div>
<div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;<span class="comment">        SEP_ACL_PROTECTED: Specifies that the child ACL is protected and</span></div>
<div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;<span class="comment">            should not inherit any ACE from the DirectoryACL</span></div>
<div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the new acl is for a directory.</span></div>
<div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;<span class="comment">    AutoInherit - Specifies if the inheritance is an &quot;automatic inheritance&quot;.</span></div>
<div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;<span class="comment">        As such, the non-inherited ACEs from the ChildAcl will be preserved and</span></div>
<div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;<span class="comment">        the inherited ACEs from the DirectoryAcl will be marked as such.</span></div>
<div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;<span class="comment">    DefaultDescriptorForObject - If set, the CreatorDescriptor</span></div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;<span class="comment">        is the default descriptor for ObjectType.  As such, the</span></div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;<span class="comment">        CreatorDescriptor will be ignored if any ObjectType specific</span></div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;<span class="comment">        ACEs are inherited from the parent.  If not such ACEs are inherited,</span></div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;<span class="comment">        the CreatorDescriptor is handled as though this flag were not</span></div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;<span class="comment">        specified.</span></div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;<span class="comment">    IsSacl - True if this is the SACL.  False if this is the DACL.</span></div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.  If not </span></div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;<span class="comment">        specified, the object has no object type.</span></div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;<span class="comment">    AclBufferSize - On input, specifies the size of AclBuffer.</span></div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;<span class="comment">        On output, on success, returns the used size of AclBuffer.</span></div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;<span class="comment">        On output, if the buffer is too small, returns the required size of AclBuffer.</span></div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;<span class="comment">    AclBuffer - Receives a pointer to the new (inherited) acl.</span></div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;<span class="comment">    NewAclExplicitlyAssigned - Returns true to indicate that some portion of</span></div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;<span class="comment">        &quot;NewAcl&quot; was derived from an the explicit ChildAcl</span></div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;<span class="comment">    NewGenericControl - Specifies the control flags for the newly</span></div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;<span class="comment">        generated ACL.</span></div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;<span class="comment">        SEP_ACL_AUTO_INHERITED: Set if the ACL was generated using the</span></div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;<span class="comment">            Automatic Inheritance algorithm.</span></div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;<span class="comment">        SEP_ACL_PROTECTED: Specifies that the ACL is protected and</span></div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;<span class="comment">            was not inherited from the parent ACL.</span></div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;<span class="comment">    STATUS_SUCCESS - An inheritable ACL was successfully generated.</span></div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;<span class="comment">    STATUS_NO_INHERITANCE - An inheritable ACL was not successfully generated.</span></div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;<span class="comment">        This is a warning completion status.  The caller should use the default</span></div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;<span class="comment">        ACL.</span></div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;<span class="comment">    STATUS_BAD_INHERITANCE_ACL - Indicates the acl built was not a valid ACL.</span></div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;<span class="comment">        This can be caused by a number of things.  One of the more probable</span></div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;<span class="comment">        causes is the replacement of a CreatorId with an SID that didn&#39;t fit</span></div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;<span class="comment">        into the ACE or ACL.</span></div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span></div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;<span class="comment">        is unknown to this routine.</span></div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl is too small for the</span></div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;<span class="comment">        inheritance ACEs.  The required size is returned in AclBufferSize.</span></div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;</div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;{</div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ChildNewAclSize = 0;</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> UsedChildNewAclSize = 0;</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> DirectoryNewAclSize = 0;</div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AclRevision;</div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> ChildAceCount;</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> ChildAcePosition;</div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> DirectoryAcePosition;</div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclProtected = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ObjectAceInherited;</div>
<div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;</div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;</div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;</div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;    <span class="comment">// Assume the ACL revision.</span></div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;</div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;    AclRevision = <a class="code" href="../../d3/d3a/a02259.html#abe4a853bae5886ec566c087708e4d2e5">ACL_REVISION</a>;</div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#af4ddb38f27ea43e90252a906ffdd84c1">RtlCreateAcl</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer, *AclBufferSize, AclRevision );</div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;    *NewAclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;    *NewGenericControl = AutoInherit ? <a class="code" href="../../df/d4d/a02285.html#a8f356589d2c645df49484357ca1ae9b1">SEP_ACL_AUTO_INHERITED</a> : 0;</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;    <span class="comment">// If the a current child ACL is not defaulted,</span></div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;    <span class="comment">//  the non-inherited ACEs from the current child ACL are to be preserved.</span></div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;</div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;    <span class="keywordflow">if</span> ( (ChildGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a98554c18dfa57f50b0f0a83aa790a773">SEP_ACL_DEFAULTED</a>) == 0 ) {</div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;</div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;        <span class="comment">// The resultant ACL should be protected if the input ACL is</span></div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;        <span class="comment">//  protected.</span></div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;</div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;        <span class="keywordflow">if</span> ( ChildGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a> ) {</div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;            AclProtected = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;            *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;        }</div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;</div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;        <span class="comment">// Only copy ACEs if the child ACL is actually present.</span></div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;        <span class="keywordflow">if</span> ( (ChildGenericControl &amp; (<a class="code" href="../../df/d4d/a02285.html#a3913167c97d0ee8d8a425cc0bcfc32eb">SEP_ACL_PRESENT</a>|SEP_ACL_PROTECTED)) != 0 ) {</div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;</div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;</div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;            <span class="keywordflow">if</span> ( ChildAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">ACE_TYPE_TO_COPY</a> AceTypeToCopy;</div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> AceFlagsToReset;</div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> MapSids;</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;</div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;                AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, ChildAcl-&gt;AclRevision );</div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;</div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;                <span class="comment">// Since we&#39;re explicitly using the ACL specified by the caller,</span></div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;                <span class="comment">//  we never want to return a NULL ACL.</span></div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;                <span class="comment">//  Rather, if we have an ACL with no ACEs,</span></div>
<div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;                <span class="comment">//  we&#39;ll return exactly that.  For a DACL, that results</span></div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;                <span class="comment">//  in a DACL that grants no access rather than a DACL</span></div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;                <span class="comment">//  that grants all access.</span></div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;</div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;                NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;</div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;                <span class="comment">// If the caller doesn&#39;t understand auto inheritance,</span></div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;                <span class="comment">//  simply preserve the specified ACL 100% intact.</span></div>
<div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;                <span class="keywordflow">if</span> ( !AutoInherit ) {</div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;</div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;                    AceTypeToCopy = <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a>;</div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;                    AceFlagsToReset = 0;      <span class="comment">// Don&#39;t turn off any ACE Flags</span></div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;                    MapSids = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;          <span class="comment">// For backward compatibility</span></div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;                <span class="comment">// If the child is protected,</span></div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;                <span class="comment">//  keep all of the ACEs turning off the INHERITED ACE flags.</span></div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ChildGenericControl &amp; SEP_ACL_PROTECTED ) {</div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;</div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;                    AceTypeToCopy = <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a>;</div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;                    AceFlagsToReset = <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>; <span class="comment">// Turn off all INHERITED_ACE flags</span></div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;                    MapSids = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;</div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;                <span class="comment">// If the child is not protected,</span></div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;                <span class="comment">//  just copy the non-inherited ACEs.</span></div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;                <span class="comment">// (The inherited ACEs will be recomputed from the parent.)</span></div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;</div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;                    AceTypeToCopy = <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">CopyNonInheritedAces</a>;</div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;                    AceFlagsToReset = 0;      <span class="comment">// Don&#39;t turn off any ACE Flags</span></div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;                    MapSids = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;</div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;                }</div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;</div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;                <span class="comment">// Copy the requested ACEs.</span></div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;</div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;                Status = <a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;                            ChildAcl,</div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;                            GenericMapping,</div>
<div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;                            AceTypeToCopy,</div>
<div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;                            AceFlagsToReset,</div>
<div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;                            MapSids,</div>
<div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;                            OwnerSid,</div>
<div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;                            GroupSid,</div>
<div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;                            ServerOwnerSid,</div>
<div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;                            ServerGroupSid,</div>
<div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;                            IsDirectoryObject,</div>
<div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;                            <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="comment">// Do not retain INHERITED_ACE bit for effective aces</span></div>
<div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;                            &amp;ChildNewAclSize,</div>
<div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;                            (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer );</div>
<div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;</div>
<div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;                UsedChildNewAclSize = ChildNewAclSize;</div>
<div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;                <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;                    AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;                    Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;                }</div>
<div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;</div>
<div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;                <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;                }</div>
<div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;</div>
<div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;                <span class="comment">// If this ACL might be ignored later,</span></div>
<div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;                <span class="comment">//  remember the current state of the ACL.</span></div>
<div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;</div>
<div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;                <span class="keywordflow">if</span> ( DefaultDescriptorForObject &amp;&amp; ChildNewAclSize != 0 ) {</div>
<div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;                    ChildAceCount = ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AceCount;</div>
<div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;</div>
<div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#ad7275b209e70848b5ee23af762a1ed5e">RtlFirstFreeAce</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer, &amp;ChildAcePosition ) ) {</div>
<div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;                    }</div>
<div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;                }</div>
<div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;</div>
<div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;            <span class="comment">// If the ACL isn&#39;t protected,</span></div>
<div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;            <span class="comment">//  don&#39;t allow NULL ACL semantics.</span></div>
<div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;            <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span></div>
<div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AutoInherit &amp;&amp;</div>
<div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;                        !IsSacl &amp;&amp;</div>
<div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;                        (ChildGenericControl &amp; (<a class="code" href="../../df/d4d/a02285.html#a3913167c97d0ee8d8a425cc0bcfc32eb">SEP_ACL_PRESENT</a>|SEP_ACL_PROTECTED)) == <a class="code" href="../../df/d4d/a02285.html#a3913167c97d0ee8d8a425cc0bcfc32eb">SEP_ACL_PRESENT</a> ) {</div>
<div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a>;</div>
<div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;</div>
<div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;            }</div>
<div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;</div>
<div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;            *NewAclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;</div>
<div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;        }</div>
<div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;</div>
<div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;    }</div>
<div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;</div>
<div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;    <span class="comment">// Inherit ACEs from the Directory ACL in any of the following cases:</span></div>
<div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;    <span class="comment">//  If !AutoInheriting,</span></div>
<div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;    <span class="comment">//      Inherit if there is no explicit child ACL (ignoring a defaulted child).</span></div>
<div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;    <span class="comment">//  If AutoInheriting,</span></div>
<div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;    <span class="comment">//      observe the protected flag.</span></div>
<div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;</div>
<div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;    <span class="keywordflow">if</span> ( (!AutoInherit &amp;&amp;</div>
<div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;            (ChildGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a3913167c97d0ee8d8a425cc0bcfc32eb">SEP_ACL_PRESENT</a>) == 0 ||</div>
<div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;                (ChildGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a98554c18dfa57f50b0f0a83aa790a773">SEP_ACL_DEFAULTED</a>) != 0) ||</div>
<div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;         (AutoInherit &amp;&amp; !AclProtected) ) {</div>
<div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;</div>
<div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;        <span class="comment">//  If there is no directory ACL,</span></div>
<div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;        <span class="comment">//      don&#39;t inherit from it.</span></div>
<div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;</div>
<div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;        <span class="keywordflow">if</span> ( DirectoryAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;</div>
<div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;            <span class="comment">// If the DirectoryAcl is used,</span></div>
<div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;            <span class="comment">//  the revision of the Directory ACL is picked up.</span></div>
<div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;</div>
<div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#a91ce2ebf39e0a306fed674324f0637d3">ValidAclRevision</a>(DirectoryAcl) ) {</div>
<div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a>;</div>
<div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;            }</div>
<div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;</div>
<div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;            AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, DirectoryAcl-&gt;AclRevision );</div>
<div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;</div>
<div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;            <span class="comment">// Inherit the Parent&#39;s ACL.</span></div>
<div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;</div>
<div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#a73ffe8bc02593f93e294cf9ceaa9e84a">RtlpGenerateInheritAcl</a>(</div>
<div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;                         DirectoryAcl,</div>
<div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;                         IsDirectoryObject,</div>
<div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;                         AutoInherit,</div>
<div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;                         OwnerSid,</div>
<div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;                         GroupSid,</div>
<div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;                         ServerOwnerSid,</div>
<div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;                         ServerGroupSid,</div>
<div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;                         GenericMapping,</div>
<div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;                         pNewObjectType,</div>
<div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;                         GuidCount,</div>
<div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;                         &amp;DirectoryNewAclSize,</div>
<div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;                         (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer,</div>
<div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;                         &amp;ObjectAceInherited );</div>
<div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;</div>
<div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;            <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;            }</div>
<div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;</div>
<div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;            }</div>
<div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;</div>
<div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;            <span class="comment">// If the default descriptor for the object should be ditched,</span></div>
<div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;            <span class="comment">//  because object specific ACEs were inherited from the directory,</span></div>
<div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;            <span class="comment">//  ditch them now.</span></div>
<div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;</div>
<div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;            <span class="keywordflow">if</span> ( DefaultDescriptorForObject &amp;&amp;</div>
<div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;                 ChildNewAclSize != 0 &amp;&amp;</div>
<div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;                 ObjectAceInherited &amp;&amp;</div>
<div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;                 !AclOverflowed ) {</div>
<div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;</div>
<div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;                <span class="comment">// Compute the last used byte of the combined ACL</span></div>
<div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#ad7275b209e70848b5ee23af762a1ed5e">RtlFirstFreeAce</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer, &amp;DirectoryAcePosition ) ) {</div>
<div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;                }</div>
<div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;                <span class="keywordflow">if</span> ( DirectoryAcePosition == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;                    DirectoryAcePosition = AclBuffer + ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>;</div>
<div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;                }</div>
<div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;</div>
<div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;</div>
<div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;</div>
<div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;                <span class="comment">// Move all the inherited ACEs to the front of the ACL.</span></div>
<div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;</div>
<div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#adb696f4512c9ed33dd7d571f296b7ebb">RtlMoveMemory</a>( <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>( AclBuffer ),</div>
<div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;                               ChildAcePosition,</div>
<div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;                               (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)DirectoryAcePosition) -</div>
<div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;                                (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)ChildAcePosition) );</div>
<div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;</div>
<div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;                <span class="comment">// Adjust the ACE count to remove the deleted ACEs</span></div>
<div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;</div>
<div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;                ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AceCount -= ChildAceCount;</div>
<div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;</div>
<div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;                <span class="comment">// Save the number of bytes of the Child ACL that were</span></div>
<div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;                <span class="comment">//  actually used.</span></div>
<div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;</div>
<div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;                UsedChildNewAclSize = 0;</div>
<div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;</div>
<div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;            }</div>
<div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;        }</div>
<div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;</div>
<div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;    }</div>
<div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;</div>
<div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;    <span class="comment">// If this routine didn&#39;t build the ACL,</span></div>
<div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;    <span class="comment">//  tell the caller.</span></div>
<div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;</div>
<div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;    <span class="keywordflow">if</span> ( DirectoryNewAclSize + UsedChildNewAclSize == 0) {</div>
<div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;</div>
<div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;        <span class="comment">// If the ACL was not explicitly assigned,</span></div>
<div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;        <span class="comment">//  tell the caller to default the ACL.</span></div>
<div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;        <span class="keywordflow">if</span> ( !(*NewAclExplicitlyAssigned) ) {</div>
<div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;            *AclBufferSize = 0;</div>
<div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a1b28d9f0fc2ca4517f6c0606efb4e0f5">STATUS_NO_INHERITANCE</a>;</div>
<div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;</div>
<div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;        <span class="comment">// If the Acl was explictly assigned,</span></div>
<div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;        <span class="comment">//  generate a NULL ACL based on the path taken above.</span></div>
<div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;</div>
<div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( NullAclOk ) {</div>
<div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;            *AclBufferSize = 0;</div>
<div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;        }</div>
<div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;</div>
<div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;        <span class="comment">// DbgBreakPoint();</span></div>
<div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;    }</div>
<div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;</div>
<div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;</div>
<div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;    <span class="comment">// And make sure we don&#39;t exceed the length limitations of an ACL (WORD)</span></div>
<div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;</div>
<div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;    <span class="keywordflow">if</span> ( DirectoryNewAclSize + UsedChildNewAclSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/dd4/a00013.html">ACL</a>) &gt; 0xFFFF) {</div>
<div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>);</div>
<div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;    }</div>
<div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;</div>
<div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;    <span class="comment">// The caller has to allocate a buffer large enough for</span></div>
<div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;    <span class="comment">// ChildNewAclSize rather than UsedChildNewAclSize.  Due to the nature of</span></div>
<div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;    <span class="comment">// my algorithm above.</span></div>
<div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;    (*AclBufferSize) = DirectoryNewAclSize + ChildNewAclSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#a067989903b97870422dc2a37d11684f8">ACL</a>);</div>
<div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;</div>
<div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;    <span class="keywordflow">if</span> ( AclOverflowed ) {</div>
<div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a>;</div>
<div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;    }</div>
<div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;</div>
<div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;    <span class="comment">// Patch the real ACL size and revision into the ACL</span></div>
<div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;</div>
<div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;    ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AclSize = (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)</div>
<div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;        (DirectoryNewAclSize + UsedChildNewAclSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/dd4/a00013.html">ACL</a>));</div>
<div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;    ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AclRevision = (<a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>) AclRevision;</div>
<div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;</div>
<div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;}</div>
<div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;</div>
<div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;</div>
<div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;</div>
<div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l04746"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b"> 4746</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a> (</div>
<div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> DirectoryAcl,</div>
<div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ChildAcl,</div>
<div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ChildGenericControl,</div>
<div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DefaultDescriptorForObject,</div>
<div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid,</div>
<div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *NewAcl,</div>
<div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> NewAclExplicitlyAssigned,</div>
<div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;    )</div>
<div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;</div>
<div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;<span class="comment">    This is a private routine that produces an inherited acl from</span></div>
<div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;<span class="comment">    a parent acl according to the rules of inheritance</span></div>
<div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;<span class="comment">    DirectoryAcl - Supplies the acl being inherited.</span></div>
<div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;<span class="comment">    ChildAcl - Supplies the acl associated with the object.  This</span></div>
<div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;<span class="comment">        is either the current acl on the object or the acl being assigned</span></div>
<div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;<span class="comment">        to the object.</span></div>
<div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;<span class="comment">    ChildGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;<span class="comment">        describing the ChildAcl:</span></div>
<div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;<span class="comment">        SEP_ACL_PRESENT: Specifies that the child ACL is explictly supplied by</span></div>
<div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;<span class="comment">            the caller.</span></div>
<div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;<span class="comment">        SEP_ACL_DEFAULTED: Specifies that the child ACL was supplied by some</span></div>
<div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;<span class="comment">            defaulting mechanism.</span></div>
<div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;<span class="comment">        SEP_ACL_PROTECTED: Specifies that the child ACL is protected and</span></div>
<div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;<span class="comment">            should not inherit any ACE from the DirectoryACL</span></div>
<div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the new acl is for a directory.</span></div>
<div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;<span class="comment">    AutoInherit - Specifies if the inheritance is an &quot;automatic inheritance&quot;.</span></div>
<div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;<span class="comment">        As such, the non-inherited ACEs from the ChildAcl will be preserved and</span></div>
<div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;<span class="comment">        the inherited ACEs from the DirectoryAcl will be marked as such.</span></div>
<div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;<span class="comment">    DefaultDescriptorForObject - If set, the CreatorDescriptor</span></div>
<div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;<span class="comment">        is the default descriptor for ObjectType.  As such, the</span></div>
<div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;<span class="comment">        CreatorDescriptor will be ignored if any ObjectType specific</span></div>
<div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;<span class="comment">        ACEs are inherited from the parent.  If not such ACEs are inherited,</span></div>
<div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;<span class="comment">        the CreatorDescriptor is handled as though this flag were not</span></div>
<div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;<span class="comment">        specified.</span></div>
<div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;<span class="comment">    IsSacl - True if this is the SACL.  False if this is the DACL.</span></div>
<div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.  If not </span></div>
<div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;<span class="comment">        specified, the object has no object type.</span></div>
<div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;<span class="comment">    NewAcl - Receives a pointer to the new (inherited) acl.</span></div>
<div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;<span class="comment">    NewAclExplicitlyAssigned - Returns true to indicate that some portion of</span></div>
<div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;<span class="comment">        &quot;NewAcl&quot; was derived from an the explicit ChildAcl</span></div>
<div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;<span class="comment">    NewGenericControl - Specifies the control flags for the newly</span></div>
<div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;<span class="comment">        generated ACL.</span></div>
<div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;<span class="comment">        SEP_ACL_AUTO_INHERITED: Set if the ACL was generated using the</span></div>
<div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;<span class="comment">            Automatic Inheritance algorithm.</span></div>
<div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;<span class="comment">        SEP_ACL_PROTECTED: Specifies that the ACL is protected and</span></div>
<div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;<span class="comment">            was not inherited from the parent ACL.</span></div>
<div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;<span class="comment">    STATUS_SUCCESS - An inheritable ACL was successfully generated.</span></div>
<div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;<span class="comment">    STATUS_NO_INHERITANCE - An inheritable ACL was not successfully generated.</span></div>
<div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;<span class="comment">        This is a warning completion status.</span></div>
<div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;<span class="comment">    STATUS_BAD_INHERITANCE_ACL - Indicates the acl built was not a valid ACL.</span></div>
<div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;<span class="comment">        This can be caused by a number of things.  One of the more probable</span></div>
<div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;<span class="comment">        causes is the replacement of a CreatorId with an SID that didn&#39;t fit</span></div>
<div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;<span class="comment">        into the ACE or ACL.</span></div>
<div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span></div>
<div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;<span class="comment">        is unknown to this routine.</span></div>
<div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;</div>
<div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;{</div>
<div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;<span class="comment">//                                                                          //</span></div>
<div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;<span class="comment">//   The logic in the ACL inheritance code must mirror the code for         //</span></div>
<div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;<span class="comment">//   inheritance in the executive (in seassign.c).  Do not make changes     //</span></div>
<div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;<span class="comment">//   here without also making changes in that module.                       //</span></div>
<div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;<span class="comment">//                                                                          //</span></div>
<div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;</div>
<div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;</div>
<div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AclBufferSize;</div>
<div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;</div>
<div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;</div>
<div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;    <span class="comment">// Implement a two pass strategy.</span></div>
<div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;    <span class="comment">// First try to create the ACL in a fixed length buffer.</span></div>
<div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;    <span class="comment">// If that is too small,</span></div>
<div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;    <span class="comment">//  then use the buffer size determined on the first pass</span></div>
<div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;</div>
<div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;    AclBufferSize = 200;</div>
<div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;    <span class="keywordflow">for</span> ( i=0; i&lt;2 ; i++ ) {</div>
<div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;</div>
<div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;        <span class="comment">// Allocate heap for the new ACL.</span></div>
<div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;</div>
<div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;        (*NewAcl) = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;                        <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;                        AclBufferSize,</div>
<div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;                        <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;</div>
<div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;        <span class="keywordflow">if</span> ((*NewAcl) == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a> );</div>
<div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;        }</div>
<div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;</div>
<div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;        <span class="comment">// Actually build the inherited ACL.</span></div>
<div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;</div>
<div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;        Status = <a class="code" href="../../d3/d32/a02665.html#aeaa146ca19ac4714659beabac108326a">RtlpInheritAcl2</a> (</div>
<div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;                    DirectoryAcl,</div>
<div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;                    ChildAcl,</div>
<div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;                    ChildGenericControl,</div>
<div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;                    IsDirectoryObject,</div>
<div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;                    AutoInherit,</div>
<div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;                    DefaultDescriptorForObject,</div>
<div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;                    OwnerSid,</div>
<div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;                    GroupSid,</div>
<div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;                    ServerOwnerSid,</div>
<div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;                    ServerGroupSid,</div>
<div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;                    GenericMapping,</div>
<div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;                    IsSacl,</div>
<div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;                    pNewObjectType,</div>
<div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;                    GuidCount,</div>
<div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;                    &amp;AclBufferSize,</div>
<div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;                    (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>) *NewAcl,</div>
<div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;                    NewAclExplicitlyAssigned,</div>
<div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;                    NewGenericControl );</div>
<div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;</div>
<div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;</div>
<div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;</div>
<div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;            <span class="comment">// If a NULL ACL should be used,</span></div>
<div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;            <span class="comment">//  tell the caller.</span></div>
<div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;</div>
<div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;            <span class="keywordflow">if</span> ( AclBufferSize == 0 ) {</div>
<div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;</div>
<div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;                <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( *NewAcl );</div>
<div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;</div>
<div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;                *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;            }</div>
<div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;</div>
<div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;</div>
<div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;            <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( *NewAcl );</div>
<div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;</div>
<div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;            *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;</div>
<div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;            <span class="keywordflow">if</span> ( Status != <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;            }</div>
<div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;        }</div>
<div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;    }</div>
<div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;</div>
<div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;</div>
<div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;}</div>
<div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;</div>
<div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;</div>
<div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l04949"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aaffde88bf4e473523c3f45c208dd97b3"> 4949</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aaffde88bf4e473523c3f45c208dd97b3">RtlpGenerateInheritedAce</a> (</div>
<div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce,</div>
<div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceLength,</div>
<div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAceExtraLength,</div>
<div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited</div>
<div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;    )</div>
<div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;</div>
<div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;<span class="comment">    This is a private routine that checks if the input ace is inheritable</span></div>
<div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;<span class="comment">    and produces 0, 1, or 2 inherited aces in the given buffer.</span></div>
<div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;<span class="comment">    OldAce - Supplies the ace being inherited</span></div>
<div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the new ACE is for a directory</span></div>
<div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;<span class="comment">    AutoInherit - Specifies if the inheritance is an &quot;automatic inheritance&quot;.</span></div>
<div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;<span class="comment">        As such, the inherited ACEs will be marked as such.</span></div>
<div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;<span class="comment">    ClientOwnerSid - Specifies the owner Sid to use</span></div>
<div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;<span class="comment">    ClientGroupSid - Specifies the new Group Sid to use</span></div>
<div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;<span class="comment">    ServerSid - Optionally specifies the Server Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;<span class="comment">    ClientSid - Optionally specifies the Client Sid to use in compound ACEs.</span></div>
<div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use</span></div>
<div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.  If not </span></div>
<div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;<span class="comment">        specified, the object has no object type.</span></div>
<div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;<span class="comment">    NewAceLength - Receives the length (number of bytes) needed to allow for</span></div>
<div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;<span class="comment">        the inheritance of the specified ACE.  This might be zero.</span></div>
<div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;<span class="comment">    NewAcl - Provides a pointer to the ACL into which the ACE is to be</span></div>
<div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;<span class="comment">        inherited.</span></div>
<div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;<span class="comment">    NewAceExtraLength - Receives a length (number of bytes) temporarily used</span></div>
<div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;<span class="comment">        in the ACL for the inheritance ACE.  This might be zero</span></div>
<div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;<span class="comment">    ObjectAceInherited - Returns true if one or more object ACEs were inherited</span></div>
<div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;<span class="comment">        based on NewObjectType</span></div>
<div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;<span class="comment">    STATUS_SUCCESS - The ACE was inherited successfully.</span></div>
<div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;<span class="comment">    STATUS_BAD_INHERITANCE_ACL - Indicates something went wrong preventing</span></div>
<div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;<span class="comment">        the ACE from being inherited.  This generally represents a bugcheck</span></div>
<div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;<span class="comment">        situation when returned from this call.</span></div>
<div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl is too small for the</span></div>
<div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;<span class="comment">        inheritance ACEs.  The required size is returned in NewAceLength.</span></div>
<div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;</div>
<div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;{</div>
<div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;    <span class="comment">// The inheritance flags AND the sid of the ACE determine whether        //</span></div>
<div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;    <span class="comment">// we need 0, 1, or 2 ACEs.                                              //</span></div>
<div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;    <span class="comment">// BE CAREFUL WHEN CHANGING THIS CODE.  READ THE DSA ACL ARCHITECTURE    //</span></div>
<div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;    <span class="comment">// SECTION COVERING INHERITANCE BEFORE ASSUMING YOU KNOW WHAT YOU ARE    //</span></div>
<div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;    <span class="comment">// DOING!!!!                                                             //</span></div>
<div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;    <span class="comment">// The general gist of the algorithm is:                                 //</span></div>
<div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;    <span class="comment">//       if ( (container  &amp;&amp; ContainerInherit) ||                        //</span></div>
<div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;    <span class="comment">//            (!container &amp;&amp; ObjectInherit)      ) {                     //</span></div>
<div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;    <span class="comment">//               GenerateEffectiveAce;                                   //</span></div>
<div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;    <span class="comment">//       }                                                               //</span></div>
<div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;    <span class="comment">//       if (Container &amp;&amp; Propagate) {                                   //</span></div>
<div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;    <span class="comment">//           Propagate copy of ACE and set InheritOnly;                  //</span></div>
<div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;    <span class="comment">//       }                                                               //</span></div>
<div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;    <span class="comment">// A slightly more accurate description of this algorithm is:            //</span></div>
<div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;    <span class="comment">//   IO  === InheritOnly flag                                            //</span></div>
<div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;    <span class="comment">//   CI  === ContainerInherit flag                                       //</span></div>
<div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;    <span class="comment">//   OI  === ObjectInherit flag                                          //</span></div>
<div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;    <span class="comment">//   NPI === NoPropagateInherit flag                                     //</span></div>
<div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;    <span class="comment">//   if ( (container  &amp;&amp; CI) ||                                          //</span></div>
<div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;    <span class="comment">//        (!container &amp;&amp; OI)   ) {                                       //</span></div>
<div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;    <span class="comment">//       Copy Header of ACE;                                             //</span></div>
<div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;    <span class="comment">//       Clear IO, NPI, CI, OI;                                          //</span></div>
<div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;    <span class="comment">//       if (KnownAceType) {                                             //</span></div>
<div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;    <span class="comment">//           if (SID is a creator ID) {                                  //</span></div>
<div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;    <span class="comment">//               Copy appropriate creator SID;                           //</span></div>
<div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;    <span class="comment">//           } else {                                                    //</span></div>
<div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;    <span class="comment">//               Copy SID of original;                                   //</span></div>
<div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;    <span class="comment">//           }                                                           //</span></div>
<div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;    <span class="comment">//           Copy AccessMask of original;                                //</span></div>
<div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;    <span class="comment">//           MapGenericAccesses;                                         //</span></div>
<div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;    <span class="comment">//           if (AccessMask == 0) {                                      //</span></div>
<div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;    <span class="comment">//               discard new ACE;                                        //</span></div>
<div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;    <span class="comment">//           }                                                           //</span></div>
<div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;    <span class="comment">//       } else {                                                        //</span></div>
<div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;    <span class="comment">//           Copy body of ACE;                                           //</span></div>
<div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;    <span class="comment">//       }                                                               //</span></div>
<div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;    <span class="comment">//   }                                                                   //</span></div>
<div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;    <span class="comment">//   if (!NPI) {                                                         //</span></div>
<div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;    <span class="comment">//       Copy ACE as is;                                                 //</span></div>
<div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;    <span class="comment">//       Set IO;                                                         //</span></div>
<div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;    <span class="comment">//   }                                                                   //</span></div>
<div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;    <span class="comment">//                                                                       //</span></div>
<div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;</div>
<div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;</div>
<div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a> = 0;</div>
<div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ExtraLengthRequired = 0;</div>
<div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> AcePosition;</div>
<div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> EffectiveAcePosition;</div>
<div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> EffectiveAceSize = 0;</div>
<div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;</div>
<div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EffectiveAceMapped;</div>
<div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> GenerateInheritAce;</div>
<div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;</div>
<div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;</div>
<div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;    <span class="comment">//  This is gross and ugly, but it&#39;s better than allocating</span></div>
<div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;    <span class="comment">//  virtual memory to hold the ClientSid, because that can</span></div>
<div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;    <span class="comment">//  fail, and propagating the error back is a tremendous pain</span></div>
<div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;</div>
<div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a>( 1 ) == <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>);</div>
<div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;    *ObjectAceInherited = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;    GenerateInheritAce = IsDirectoryObject &amp;&amp; <a class="code" href="../../df/d4d/a02285.html#a63eebbbf41ac0a1f0001273f954797f1">Propagate</a>(OldAce);</div>
<div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;</div>
<div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160;    <span class="comment">// Allocate and initialize the universal SIDs we&#39;re going to need</span></div>
<div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;    <span class="comment">// to look for inheritable ACEs.</span></div>
<div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;</div>
<div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#ad7275b209e70848b5ee23af762a1ed5e">RtlFirstFreeAce</a>(NewAcl, &amp;AcePosition) || (AcePosition == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div>
<div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;    }</div>
<div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;</div>
<div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;    <span class="comment">//  check to see if we will have a effective ACE (one mapped to</span></div>
<div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;    <span class="comment">//  the target object type).</span></div>
<div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;</div>
<div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;    <span class="keywordflow">if</span> ( (IsDirectoryObject  &amp;&amp; <a class="code" href="../../df/d4d/a02285.html#a14f1dd3e862a10584fc2d7a6c197245c">ContainerInherit</a>(OldAce)) ||</div>
<div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;         (!IsDirectoryObject &amp;&amp; <a class="code" href="../../df/d4d/a02285.html#a58f79b78a435b75cb346116e5fff329a">ObjectInherit</a>(OldAce))      ) {</div>
<div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;</div>
<div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;</div>
<div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;        <span class="comment">// Remember where the effective ACE will be copied to.</span></div>
<div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;        EffectiveAcePosition = AcePosition;</div>
<div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;</div>
<div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160;        <span class="comment">// Copy the effective ACE into the ACL.</span></div>
<div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30">RtlpCopyEffectiveAce</a> (</div>
<div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;                        OldAce,</div>
<div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;                        AutoInherit,</div>
<div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;                        GenerateInheritAce,</div>
<div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160;                        ClientOwnerSid,</div>
<div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;                        ClientGroupSid,</div>
<div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;                        ServerOwnerSid,</div>
<div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;                        ServerGroupSid,</div>
<div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;                        pNewObjectType,</div>
<div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;                        GuidCount,</div>
<div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160;                        &amp;AcePosition,</div>
<div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;                        &amp;EffectiveAceSize,</div>
<div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;                        NewAcl,</div>
<div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;                        ObjectAceInherited,</div>
<div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;                        &amp;EffectiveAceMapped,</div>
<div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;                        &amp;AclOverflowed ) ) {</div>
<div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;</div>
<div class="line"><a name="l05154"></a><span class="lineno"> 5154</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;        }</div>
<div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;</div>
<div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;        <span class="comment">// If the effective ACE is a duplicate of existing inherited ACEs,</span></div>
<div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;        <span class="comment">//  Don&#39;t really generate it.</span></div>
<div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160;</div>
<div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;        <span class="keywordflow">if</span> ( !AclOverflowed &amp;&amp;</div>
<div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;             EffectiveAceSize &gt; 0 &amp;&amp;</div>
<div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;             EffectiveAcePosition != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;</div>
<div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9">RtlpIsDuplicateAce</a>(</div>
<div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;                    NewAcl,</div>
<div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;                    EffectiveAcePosition ) ) {</div>
<div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;</div>
<div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;</div>
<div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;            <span class="comment">// Truncate the ACE we just added.</span></div>
<div class="line"><a name="l05172"></a><span class="lineno"> 5172</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05173"></a><span class="lineno"> 5173</span>&#160;</div>
<div class="line"><a name="l05174"></a><span class="lineno"> 5174</span>&#160;            NewAcl-&gt;AceCount--;</div>
<div class="line"><a name="l05175"></a><span class="lineno"> 5175</span>&#160;            AcePosition = EffectiveAcePosition;</div>
<div class="line"><a name="l05176"></a><span class="lineno"> 5176</span>&#160;            ExtraLengthRequired = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( ExtraLengthRequired, EffectiveAceSize );</div>
<div class="line"><a name="l05177"></a><span class="lineno"> 5177</span>&#160;            EffectiveAceSize = 0;</div>
<div class="line"><a name="l05178"></a><span class="lineno"> 5178</span>&#160;        }</div>
<div class="line"><a name="l05179"></a><span class="lineno"> 5179</span>&#160;</div>
<div class="line"><a name="l05180"></a><span class="lineno"> 5180</span>&#160;        LengthRequired += EffectiveAceSize;</div>
<div class="line"><a name="l05181"></a><span class="lineno"> 5181</span>&#160;</div>
<div class="line"><a name="l05182"></a><span class="lineno"> 5182</span>&#160;    }</div>
<div class="line"><a name="l05183"></a><span class="lineno"> 5183</span>&#160;</div>
<div class="line"><a name="l05184"></a><span class="lineno"> 5184</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05185"></a><span class="lineno"> 5185</span>&#160;    <span class="comment">// If we are inheriting onto a container, then we may need to</span></div>
<div class="line"><a name="l05186"></a><span class="lineno"> 5186</span>&#160;    <span class="comment">// propagate the inheritance as well.</span></div>
<div class="line"><a name="l05187"></a><span class="lineno"> 5187</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05188"></a><span class="lineno"> 5188</span>&#160;</div>
<div class="line"><a name="l05189"></a><span class="lineno"> 5189</span>&#160;    <span class="keywordflow">if</span> ( GenerateInheritAce ) {</div>
<div class="line"><a name="l05190"></a><span class="lineno"> 5190</span>&#160;</div>
<div class="line"><a name="l05191"></a><span class="lineno"> 5191</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05192"></a><span class="lineno"> 5192</span>&#160;        <span class="comment">// If a effective ACE was created,</span></div>
<div class="line"><a name="l05193"></a><span class="lineno"> 5193</span>&#160;        <span class="comment">//  and it wasn&#39;t mapped,</span></div>
<div class="line"><a name="l05194"></a><span class="lineno"> 5194</span>&#160;        <span class="comment">//  avoid generating another ACE and simply merge the inheritance bits into</span></div>
<div class="line"><a name="l05195"></a><span class="lineno"> 5195</span>&#160;        <span class="comment">//      the effective ACE.</span></div>
<div class="line"><a name="l05196"></a><span class="lineno"> 5196</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05197"></a><span class="lineno"> 5197</span>&#160;</div>
<div class="line"><a name="l05198"></a><span class="lineno"> 5198</span>&#160;        <span class="keywordflow">if</span> ( EffectiveAceSize != 0 &amp;&amp; !EffectiveAceMapped ) {</div>
<div class="line"><a name="l05199"></a><span class="lineno"> 5199</span>&#160;</div>
<div class="line"><a name="l05200"></a><span class="lineno"> 5200</span>&#160;           <span class="comment">//</span></div>
<div class="line"><a name="l05201"></a><span class="lineno"> 5201</span>&#160;           <span class="comment">// Copy the inherit bits from the original ACE.</span></div>
<div class="line"><a name="l05202"></a><span class="lineno"> 5202</span>&#160;           <span class="comment">//</span></div>
<div class="line"><a name="l05203"></a><span class="lineno"> 5203</span>&#160;           <span class="keywordflow">if</span> ( !AclOverflowed ) {</div>
<div class="line"><a name="l05204"></a><span class="lineno"> 5204</span>&#160;               ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)EffectiveAcePosition)-&gt;AceFlags |=</div>
<div class="line"><a name="l05205"></a><span class="lineno"> 5205</span>&#160;                    ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)OldAce)-&gt;AceFlags &amp; (<a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a> | <a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a>);</div>
<div class="line"><a name="l05206"></a><span class="lineno"> 5206</span>&#160;               <span class="keywordflow">if</span> ( AutoInherit ) {</div>
<div class="line"><a name="l05207"></a><span class="lineno"> 5207</span>&#160;                   ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)EffectiveAcePosition)-&gt;AceFlags |= <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>;</div>
<div class="line"><a name="l05208"></a><span class="lineno"> 5208</span>&#160;               }</div>
<div class="line"><a name="l05209"></a><span class="lineno"> 5209</span>&#160;           }</div>
<div class="line"><a name="l05210"></a><span class="lineno"> 5210</span>&#160;</div>
<div class="line"><a name="l05211"></a><span class="lineno"> 5211</span>&#160;</div>
<div class="line"><a name="l05212"></a><span class="lineno"> 5212</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05213"></a><span class="lineno"> 5213</span>&#160;        <span class="comment">// Otherwise, generate an explicit inheritance ACE.</span></div>
<div class="line"><a name="l05214"></a><span class="lineno"> 5214</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05215"></a><span class="lineno"> 5215</span>&#160;        <span class="comment">// But only if the access mask isn&#39;t zero.</span></div>
<div class="line"><a name="l05216"></a><span class="lineno"> 5216</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05217"></a><span class="lineno"> 5217</span>&#160;</div>
<div class="line"><a name="l05218"></a><span class="lineno"> 5218</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a>(OldAce) || ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(OldAce))-&gt;Mask != 0 ) {</div>
<div class="line"><a name="l05219"></a><span class="lineno"> 5219</span>&#160;</div>
<div class="line"><a name="l05220"></a><span class="lineno"> 5220</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05221"></a><span class="lineno"> 5221</span>&#160;            <span class="comment">// Account for the new ACE being added to the ACL.</span></div>
<div class="line"><a name="l05222"></a><span class="lineno"> 5222</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05223"></a><span class="lineno"> 5223</span>&#160;            LengthRequired += (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize);</div>
<div class="line"><a name="l05224"></a><span class="lineno"> 5224</span>&#160;</div>
<div class="line"><a name="l05225"></a><span class="lineno"> 5225</span>&#160;            <span class="keywordflow">if</span> (LengthRequired &gt; 0xFFFF) {</div>
<div class="line"><a name="l05226"></a><span class="lineno"> 5226</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>;</div>
<div class="line"><a name="l05227"></a><span class="lineno"> 5227</span>&#160;            }</div>
<div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;</div>
<div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;            <span class="comment">// If the ACE doesn&#39;t fit,</span></div>
<div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;            <span class="comment">//  just note the fact and don&#39;t copy the ACE.</span></div>
<div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;</div>
<div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;            <span class="keywordflow">if</span> ( ((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize &gt; NewAcl-&gt;AclSize - ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)AcePosition - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)NewAcl) ) {</div>
<div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05236"></a><span class="lineno"> 5236</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!AclOverflowed){</div>
<div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;</div>
<div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;                <span class="comment">// copy it as is, but make sure the InheritOnly bit is set.</span></div>
<div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;</div>
<div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;                    AcePosition,</div>
<div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;                    OldAce,</div>
<div class="line"><a name="l05245"></a><span class="lineno"> 5245</span>&#160;                    ((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize</div>
<div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;                    );</div>
<div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;</div>
<div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160;                ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags |= <a class="code" href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a>;</div>
<div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;                NewAcl-&gt;AceCount += 1;</div>
<div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;                <span class="keywordflow">if</span> ( AutoInherit ) {</div>
<div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;                    ((<a class="code" href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a>)AcePosition)-&gt;AceFlags |= <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>;</div>
<div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;</div>
<div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;                    <span class="comment">// If the inheritance ACE is a duplicate of existing inherited ACEs,</span></div>
<div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;                    <span class="comment">//  Don&#39;t really generate it.</span></div>
<div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;</div>
<div class="line"><a name="l05258"></a><span class="lineno"> 5258</span>&#160;                    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9">RtlpIsDuplicateAce</a>(</div>
<div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160;                                NewAcl,</div>
<div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160;                                AcePosition ) ) {</div>
<div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;</div>
<div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;</div>
<div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;                        <span class="comment">// Truncate the ACE we just added.</span></div>
<div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;</div>
<div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;                        NewAcl-&gt;AceCount--;</div>
<div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;                        ExtraLengthRequired = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( ExtraLengthRequired,</div>
<div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;                                                   ((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize );</div>
<div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;                        LengthRequired -= (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a>)OldAce)-&gt;AceSize);</div>
<div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;                    }</div>
<div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;                }</div>
<div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160;</div>
<div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;            }</div>
<div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;        }</div>
<div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;    }</div>
<div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;</div>
<div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;    <span class="comment">//  Now return to our caller</span></div>
<div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;</div>
<div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;    (*NewAceLength) = <a class="code" href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a>;</div>
<div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;    (*NewAceExtraLength) = ExtraLengthRequired;</div>
<div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;</div>
<div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;    <span class="keywordflow">return</span> AclOverflowed ? <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> : <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160;}</div>
<div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;</div>
<div class="line"><a name="l05288"></a><span class="lineno"> 5288</span>&#160;</div>
<div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l05290"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a73ffe8bc02593f93e294cf9ceaa9e84a"> 5290</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a73ffe8bc02593f93e294cf9ceaa9e84a">RtlpGenerateInheritAcl</a>(</div>
<div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AutoInherit,</div>
<div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l05295"></a><span class="lineno"> 5295</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroupSid OPTIONAL,</div>
<div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType OPTIONAL,</div>
<div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewAclSizeParam,</div>
<div class="line"><a name="l05302"></a><span class="lineno"> 5302</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewAcl,</div>
<div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> ObjectAceInherited</div>
<div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;    )</div>
<div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;</div>
<div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;<span class="comment">    This is a private routine that produces an inheritable ACL.</span></div>
<div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;<span class="comment">    The buffer to contain the inherted ACL is passed in.  If the buffer is</span></div>
<div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;<span class="comment">    too small, the corect size is computed and STATUS_BUFFER_TOO_SMALL is</span></div>
<div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160;<span class="comment">    returned.</span></div>
<div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;<span class="comment">    Acl - Supplies the acl being inherited.</span></div>
<div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the new acl is for a directory.</span></div>
<div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;<span class="comment">    AutoInherit - Specifies if the inheritance is an &quot;automatic inheritance&quot;.</span></div>
<div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;<span class="comment">        As such, the inherited ACEs will be marked as such.</span></div>
<div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.  If not </span></div>
<div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;<span class="comment">        specified, the object has no object type.</span></div>
<div class="line"><a name="l05333"></a><span class="lineno"> 5333</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;<span class="comment">    NewAclSizeParam - Receives the length of the inherited ACL.</span></div>
<div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;<span class="comment">    NewAcl - Provides a pointer to the buffer to receive the new</span></div>
<div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;<span class="comment">        (inherited) acl.  This ACL must already be initialized.</span></div>
<div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;<span class="comment">    ObjectAceInherited - Returns true if one or more object ACEs were inherited</span></div>
<div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160;<span class="comment">        based on NewObjectType</span></div>
<div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;<span class="comment">    STATUS_SUCCESS - An inheritable ACL has been generated.</span></div>
<div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;<span class="comment">    STATUS_BAD_INHERITANCE_ACL - Indicates the acl built was not a valid ACL.</span></div>
<div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;<span class="comment">        This can be caused by a number of things.  One of the more probable</span></div>
<div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160;<span class="comment">        causes is the replacement of a CreatorId with an SID that didn&#39;t fit</span></div>
<div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;<span class="comment">        into the ACE or ACL.</span></div>
<div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05354"></a><span class="lineno"> 5354</span>&#160;<span class="comment">    STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl is too small for the</span></div>
<div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;<span class="comment">        inheritance ACEs.  The required size is returned in NewAceLength.</span></div>
<div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;</div>
<div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;{</div>
<div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;</div>
<div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160;</div>
<div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> OldAce;</div>
<div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewAclSize, NewAceSize;</div>
<div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewAclExtraSize, NewAceExtraSize;</div>
<div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> LocalObjectAceInherited;</div>
<div class="line"><a name="l05370"></a><span class="lineno"> 5370</span>&#160;</div>
<div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160;</div>
<div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;</div>
<div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;    <span class="comment">// Walk through the original ACL generating any necessary</span></div>
<div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;    <span class="comment">// inheritable ACEs.</span></div>
<div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;</div>
<div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;    NewAclSize = 0;</div>
<div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;    NewAclExtraSize = 0;</div>
<div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;    *ObjectAceInherited = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;    <span class="keywordflow">for</span> (i = 0, OldAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl);</div>
<div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;         i &lt; Acl-&gt;AceCount;</div>
<div class="line"><a name="l05384"></a><span class="lineno"> 5384</span>&#160;         i += 1, OldAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(OldAce)) {</div>
<div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;</div>
<div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;        <span class="comment">//  RtlpGenerateInheritedAce() will generate the ACE(s) necessary</span></div>
<div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;        <span class="comment">//  to inherit a single ACE.  This may be 0, 1, or more ACEs.</span></div>
<div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;</div>
<div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;        Status = <a class="code" href="../../d3/d32/a02665.html#aaffde88bf4e473523c3f45c208dd97b3">RtlpGenerateInheritedAce</a>(</div>
<div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;                     OldAce,</div>
<div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;                     IsDirectoryObject,</div>
<div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;                     AutoInherit,</div>
<div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;                     ClientOwnerSid,</div>
<div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;                     ClientGroupSid,</div>
<div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;                     ServerOwnerSid,</div>
<div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;                     ServerGroupSid,</div>
<div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;                     GenericMapping,</div>
<div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;                     pNewObjectType,</div>
<div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;                     GuidCount,</div>
<div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;                     &amp;NewAceSize,</div>
<div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;                     NewAcl,</div>
<div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160;                     &amp;NewAceExtraSize,</div>
<div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;                     &amp;LocalObjectAceInherited</div>
<div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;                     );</div>
<div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;</div>
<div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;        <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;            AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;        }</div>
<div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;</div>
<div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05414"></a><span class="lineno"> 5414</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05415"></a><span class="lineno"> 5415</span>&#160;        }</div>
<div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;</div>
<div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;        <span class="keywordflow">if</span> ( LocalObjectAceInherited ) {</div>
<div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;            *ObjectAceInherited = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05419"></a><span class="lineno"> 5419</span>&#160;        }</div>
<div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;</div>
<div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;        <span class="comment">// Make room in the ACL for the new ACE</span></div>
<div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;        NewAclSize += NewAceSize;</div>
<div class="line"><a name="l05425"></a><span class="lineno"> 5425</span>&#160;</div>
<div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;        <span class="comment">// If a previous ACE needed &#39;extra&#39; space,</span></div>
<div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;        <span class="comment">//  reduce that requirement by the size of this ACE.</span></div>
<div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;        <span class="comment">// The previous ACE can use this ACE&#39;s space temporarily</span></div>
<div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160;        <span class="keywordflow">if</span> ( NewAceSize &gt; NewAclExtraSize ) {</div>
<div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;            NewAclExtraSize = 0 ;</div>
<div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;            NewAclExtraSize -= NewAceSize;</div>
<div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;        }</div>
<div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;</div>
<div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;        <span class="comment">// The &#39;extra&#39; space needed is the larger of that needed by any</span></div>
<div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160;        <span class="comment">//  previous ACE and that need by this ACE</span></div>
<div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;        NewAclExtraSize = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( NewAclExtraSize, NewAceExtraSize );</div>
<div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;</div>
<div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;    }</div>
<div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;</div>
<div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;    <span class="comment">// We only need to include the &quot;ExtraSize&quot; if we&#39;ve overflowed.</span></div>
<div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;    <span class="comment">//  In those cases, the caller will allocate the size we requested and</span></div>
<div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;    <span class="comment">//  try again.  Otherwise, the caller won&#39;t call back so we don&#39;t care</span></div>
<div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160;    <span class="comment">//  if it knows about the extra size.</span></div>
<div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;</div>
<div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;    <span class="keywordflow">if</span> ( AclOverflowed ) {</div>
<div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;        (*NewAclSizeParam) = NewAclSize + NewAclExtraSize;</div>
<div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a>;</div>
<div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;        (*NewAclSizeParam) = NewAclSize;</div>
<div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;    }</div>
<div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;</div>
<div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;}</div>
<div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;</div>
<div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;</div>
<div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l05465"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ae38867c753fcc5b5e3a162cec8c60fa1"> 5465</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae38867c753fcc5b5e3a162cec8c60fa1">RtlpComputeMergedAcl2</a> (</div>
<div class="line"><a name="l05466"></a><span class="lineno"> 5466</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentAcl,</div>
<div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CurrentGenericControl,</div>
<div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ModificationAcl,</div>
<div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ModificationGenericControl,</div>
<div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> AclBufferSize,</div>
<div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> AclBuffer,</div>
<div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;    )</div>
<div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;</div>
<div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;<span class="comment">    This routine implements the &#39;set&#39; semantics for auto inheritance.</span></div>
<div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;<span class="comment">    This routine builds the actual ACL that should be set on an object.</span></div>
<div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;<span class="comment">    The built ACL is a composite of the previous ACL on an object and</span></div>
<div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;<span class="comment">    the newly set ACL on the object.  The New ACL is built as follows:</span></div>
<div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05489"></a><span class="lineno"> 5489</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set in neither CurrentAcl nor ModificationAcl,</span></div>
<div class="line"><a name="l05490"></a><span class="lineno"> 5490</span>&#160;<span class="comment">    the NewAcl is constructed from the inherited ACEs from the</span></div>
<div class="line"><a name="l05491"></a><span class="lineno"> 5491</span>&#160;<span class="comment">    CurrentAcl and the non-inherited ACEs from the ModificationAcl.</span></div>
<div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;<span class="comment">    (That is, it is impossible to edit an inherited ACE by changing the</span></div>
<div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;<span class="comment">    ACL on an object.)</span></div>
<div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set on ModificationAcl, CurrentAcl is ignored.</span></div>
<div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;<span class="comment">    NewAcl is built as a copy of ModificationAcl with any INHERITED_ACE</span></div>
<div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;<span class="comment">    bits turned off.</span></div>
<div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set on CurrentAcl and not ModificationAcl, the</span></div>
<div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;<span class="comment">    CurrentAcl is ignored.  NewAcl is built as a copy of</span></div>
<div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;<span class="comment">    ModificationDescriptor.  It is the callers responsibility to ensure</span></div>
<div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;<span class="comment">    that the correct ACEs have the INHERITED_ACE bit turned on.</span></div>
<div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;<span class="comment">    CurrentAcl - The current ACL on the object.</span></div>
<div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;<span class="comment">    CurrentGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;<span class="comment">        describing the CurrentAcl.</span></div>
<div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;<span class="comment">    ModificationAcl - The ACL being applied to the object.</span></div>
<div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;<span class="comment">    ModificationGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;<span class="comment">        describing the CurrentAcl.</span></div>
<div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;<span class="comment">    ClientOwnerSid - Specifies the owner Sid to use</span></div>
<div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;<span class="comment">    ClientGroupSid - Specifies the new Group Sid to use</span></div>
<div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05520"></a><span class="lineno"> 5520</span>&#160;<span class="comment">    GenericMapping - The mapping of generic to specific and standard</span></div>
<div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;<span class="comment">                     access types.</span></div>
<div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;<span class="comment">    IsSacl - True if this is the SACL.  False if this is the DACL.</span></div>
<div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;<span class="comment">    AclBufferSize - On input, specifies the size of AclBuffer.</span></div>
<div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;<span class="comment">        On output, on success, returns the used size of AclBuffer.</span></div>
<div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;<span class="comment">        On output, if the buffer is too small, returns the required size of AclBuffer.</span></div>
<div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;<span class="comment">    AclBuffer - Receives a pointer to the new (inherited) acl.</span></div>
<div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;<span class="comment">    NewGenericControl - Specifies the control flags for the newly</span></div>
<div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;<span class="comment">        generated ACL.</span></div>
<div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;<span class="comment">        Only the Protected and AutoInherited bits are returned.</span></div>
<div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;<span class="comment">    STATUS_SUCCESS - An ACL was successfully generated.</span></div>
<div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span></div>
<div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;<span class="comment">        is unknown to this routine.</span></div>
<div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;</div>
<div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;{</div>
<div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ModificationNewAclSize = 0;</div>
<div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CurrentNewAclSize = 0;</div>
<div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AclRevision;</div>
<div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;</div>
<div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;</div>
<div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160;</div>
<div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;    <span class="comment">// Assume the ACL revision.</span></div>
<div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;</div>
<div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;    AclRevision = <a class="code" href="../../d3/d3a/a02259.html#abe4a853bae5886ec566c087708e4d2e5">ACL_REVISION</a>;</div>
<div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#af4ddb38f27ea43e90252a906ffdd84c1">RtlCreateAcl</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer, *AclBufferSize, AclRevision );</div>
<div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;</div>
<div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160;    <span class="comment">// This routine is only called for the AutoInheritance case.</span></div>
<div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160;</div>
<div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;    *NewGenericControl = <a class="code" href="../../df/d4d/a02285.html#a8f356589d2c645df49484357ca1ae9b1">SEP_ACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;</div>
<div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;    <span class="comment">// If the new ACL is protected,</span></div>
<div class="line"><a name="l05571"></a><span class="lineno"> 5571</span>&#160;    <span class="comment">//  simply use the new ACL with the INHERITED_ACE bits turned off.</span></div>
<div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;</div>
<div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;    <span class="keywordflow">if</span> ( (ModificationGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>) != 0 ) {</div>
<div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;</div>
<div class="line"><a name="l05576"></a><span class="lineno"> 5576</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;        <span class="comment">// Set the Control bits for the resultant descriptor.</span></div>
<div class="line"><a name="l05578"></a><span class="lineno"> 5578</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;</div>
<div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;        *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;</div>
<div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;        <span class="comment">// Only copy the ACL if it is actually present</span></div>
<div class="line"><a name="l05584"></a><span class="lineno"> 5584</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05585"></a><span class="lineno"> 5585</span>&#160;</div>
<div class="line"><a name="l05586"></a><span class="lineno"> 5586</span>&#160;        <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l05587"></a><span class="lineno"> 5587</span>&#160;</div>
<div class="line"><a name="l05588"></a><span class="lineno"> 5588</span>&#160;            AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );</div>
<div class="line"><a name="l05589"></a><span class="lineno"> 5589</span>&#160;</div>
<div class="line"><a name="l05590"></a><span class="lineno"> 5590</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05591"></a><span class="lineno"> 5591</span>&#160;            <span class="comment">// Copy all ACES, turn off the inherited bit, and generic map them.</span></div>
<div class="line"><a name="l05592"></a><span class="lineno"> 5592</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05593"></a><span class="lineno"> 5593</span>&#160;</div>
<div class="line"><a name="l05594"></a><span class="lineno"> 5594</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l05595"></a><span class="lineno"> 5595</span>&#160;                        ModificationAcl,</div>
<div class="line"><a name="l05596"></a><span class="lineno"> 5596</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l05597"></a><span class="lineno"> 5597</span>&#160;                        <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a>,</div>
<div class="line"><a name="l05598"></a><span class="lineno"> 5598</span>&#160;                        <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>,  <span class="comment">// Turn off all INHERITED_ACE flags</span></div>
<div class="line"><a name="l05599"></a><span class="lineno"> 5599</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Map sids as needed</span></div>
<div class="line"><a name="l05600"></a><span class="lineno"> 5600</span>&#160;                        ClientOwnerSid,</div>
<div class="line"><a name="l05601"></a><span class="lineno"> 5601</span>&#160;                        ClientGroupSid,</div>
<div class="line"><a name="l05602"></a><span class="lineno"> 5602</span>&#160;                        ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05603"></a><span class="lineno"> 5603</span>&#160;                        ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05604"></a><span class="lineno"> 5604</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Assume container and skip optimization</span></div>
<div class="line"><a name="l05605"></a><span class="lineno"> 5605</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,          <span class="comment">// Do not retain INHERITED_ACE bit for effective aces</span></div>
<div class="line"><a name="l05606"></a><span class="lineno"> 5606</span>&#160;                        &amp;ModificationNewAclSize,</div>
<div class="line"><a name="l05607"></a><span class="lineno"> 5607</span>&#160;                        (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer );</div>
<div class="line"><a name="l05608"></a><span class="lineno"> 5608</span>&#160;</div>
<div class="line"><a name="l05609"></a><span class="lineno"> 5609</span>&#160;            <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05610"></a><span class="lineno"> 5610</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05611"></a><span class="lineno"> 5611</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05612"></a><span class="lineno"> 5612</span>&#160;            }</div>
<div class="line"><a name="l05613"></a><span class="lineno"> 5613</span>&#160;</div>
<div class="line"><a name="l05614"></a><span class="lineno"> 5614</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05615"></a><span class="lineno"> 5615</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05616"></a><span class="lineno"> 5616</span>&#160;            }</div>
<div class="line"><a name="l05617"></a><span class="lineno"> 5617</span>&#160;</div>
<div class="line"><a name="l05618"></a><span class="lineno"> 5618</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05619"></a><span class="lineno"> 5619</span>&#160;            <span class="comment">// If the caller specified an ACL with no ACES,</span></div>
<div class="line"><a name="l05620"></a><span class="lineno"> 5620</span>&#160;            <span class="comment">//  make sure we generate an ACL with no ACES.</span></div>
<div class="line"><a name="l05621"></a><span class="lineno"> 5621</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05622"></a><span class="lineno"> 5622</span>&#160;</div>
<div class="line"><a name="l05623"></a><span class="lineno"> 5623</span>&#160;            NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05624"></a><span class="lineno"> 5624</span>&#160;        }</div>
<div class="line"><a name="l05625"></a><span class="lineno"> 5625</span>&#160;</div>
<div class="line"><a name="l05626"></a><span class="lineno"> 5626</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05627"></a><span class="lineno"> 5627</span>&#160;    <span class="comment">// If the old ACL is protected but the new one isn&#39;t,</span></div>
<div class="line"><a name="l05628"></a><span class="lineno"> 5628</span>&#160;    <span class="comment">//  simply use the new ACL as is.</span></div>
<div class="line"><a name="l05629"></a><span class="lineno"> 5629</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05630"></a><span class="lineno"> 5630</span>&#160;    <span class="comment">// Rely on the caller to get the INHERITED_ACE bits right.</span></div>
<div class="line"><a name="l05631"></a><span class="lineno"> 5631</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05632"></a><span class="lineno"> 5632</span>&#160;</div>
<div class="line"><a name="l05633"></a><span class="lineno"> 5633</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (CurrentGenericControl &amp; SEP_ACL_PROTECTED) != 0 ) {</div>
<div class="line"><a name="l05634"></a><span class="lineno"> 5634</span>&#160;</div>
<div class="line"><a name="l05635"></a><span class="lineno"> 5635</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05636"></a><span class="lineno"> 5636</span>&#160;        <span class="comment">// Only do the copy if the new ACL is specified.</span></div>
<div class="line"><a name="l05637"></a><span class="lineno"> 5637</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05638"></a><span class="lineno"> 5638</span>&#160;</div>
<div class="line"><a name="l05639"></a><span class="lineno"> 5639</span>&#160;        <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l05640"></a><span class="lineno"> 5640</span>&#160;            AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );</div>
<div class="line"><a name="l05641"></a><span class="lineno"> 5641</span>&#160;</div>
<div class="line"><a name="l05642"></a><span class="lineno"> 5642</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05643"></a><span class="lineno"> 5643</span>&#160;            <span class="comment">// Copy all ACES, and generic map them.</span></div>
<div class="line"><a name="l05644"></a><span class="lineno"> 5644</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05645"></a><span class="lineno"> 5645</span>&#160;</div>
<div class="line"><a name="l05646"></a><span class="lineno"> 5646</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l05647"></a><span class="lineno"> 5647</span>&#160;                        ModificationAcl,</div>
<div class="line"><a name="l05648"></a><span class="lineno"> 5648</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l05649"></a><span class="lineno"> 5649</span>&#160;                        <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a>,</div>
<div class="line"><a name="l05650"></a><span class="lineno"> 5650</span>&#160;                        0,</div>
<div class="line"><a name="l05651"></a><span class="lineno"> 5651</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Map sids as needed</span></div>
<div class="line"><a name="l05652"></a><span class="lineno"> 5652</span>&#160;                        ClientOwnerSid,</div>
<div class="line"><a name="l05653"></a><span class="lineno"> 5653</span>&#160;                        ClientGroupSid,</div>
<div class="line"><a name="l05654"></a><span class="lineno"> 5654</span>&#160;                        ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05655"></a><span class="lineno"> 5655</span>&#160;                        ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05656"></a><span class="lineno"> 5656</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Assume container and skip optimization</span></div>
<div class="line"><a name="l05657"></a><span class="lineno"> 5657</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Retain INHERITED_ACE bit for effective aces</span></div>
<div class="line"><a name="l05658"></a><span class="lineno"> 5658</span>&#160;                        &amp;ModificationNewAclSize,</div>
<div class="line"><a name="l05659"></a><span class="lineno"> 5659</span>&#160;                        (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer );</div>
<div class="line"><a name="l05660"></a><span class="lineno"> 5660</span>&#160;</div>
<div class="line"><a name="l05661"></a><span class="lineno"> 5661</span>&#160;            <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05662"></a><span class="lineno"> 5662</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05663"></a><span class="lineno"> 5663</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05664"></a><span class="lineno"> 5664</span>&#160;            }</div>
<div class="line"><a name="l05665"></a><span class="lineno"> 5665</span>&#160;</div>
<div class="line"><a name="l05666"></a><span class="lineno"> 5666</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05667"></a><span class="lineno"> 5667</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05668"></a><span class="lineno"> 5668</span>&#160;            }</div>
<div class="line"><a name="l05669"></a><span class="lineno"> 5669</span>&#160;</div>
<div class="line"><a name="l05670"></a><span class="lineno"> 5670</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05671"></a><span class="lineno"> 5671</span>&#160;            <span class="comment">// If the caller specified an ACL with no ACES,</span></div>
<div class="line"><a name="l05672"></a><span class="lineno"> 5672</span>&#160;            <span class="comment">//  make sure we generate an ACL with no ACES.</span></div>
<div class="line"><a name="l05673"></a><span class="lineno"> 5673</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05674"></a><span class="lineno"> 5674</span>&#160;</div>
<div class="line"><a name="l05675"></a><span class="lineno"> 5675</span>&#160;            NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05676"></a><span class="lineno"> 5676</span>&#160;</div>
<div class="line"><a name="l05677"></a><span class="lineno"> 5677</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05678"></a><span class="lineno"> 5678</span>&#160;        <span class="comment">// Since the ACL isn&#39;t protected,</span></div>
<div class="line"><a name="l05679"></a><span class="lineno"> 5679</span>&#160;        <span class="comment">//  don&#39;t allow NULL ACL semantics.</span></div>
<div class="line"><a name="l05680"></a><span class="lineno"> 5680</span>&#160;        <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span></div>
<div class="line"><a name="l05681"></a><span class="lineno"> 5681</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05682"></a><span class="lineno"> 5682</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsSacl ) {</div>
<div class="line"><a name="l05683"></a><span class="lineno"> 5683</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a>;</div>
<div class="line"><a name="l05684"></a><span class="lineno"> 5684</span>&#160;        }</div>
<div class="line"><a name="l05685"></a><span class="lineno"> 5685</span>&#160;</div>
<div class="line"><a name="l05686"></a><span class="lineno"> 5686</span>&#160;</div>
<div class="line"><a name="l05687"></a><span class="lineno"> 5687</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05688"></a><span class="lineno"> 5688</span>&#160;    <span class="comment">// If neither are protected,</span></div>
<div class="line"><a name="l05689"></a><span class="lineno"> 5689</span>&#160;    <span class="comment">//  use the non-inherited ACEs from the new ACL, and</span></div>
<div class="line"><a name="l05690"></a><span class="lineno"> 5690</span>&#160;    <span class="comment">//  preserve the inherited ACEs from the old ACL.</span></div>
<div class="line"><a name="l05691"></a><span class="lineno"> 5691</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05692"></a><span class="lineno"> 5692</span>&#160;</div>
<div class="line"><a name="l05693"></a><span class="lineno"> 5693</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l05694"></a><span class="lineno"> 5694</span>&#160;</div>
<div class="line"><a name="l05695"></a><span class="lineno"> 5695</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05696"></a><span class="lineno"> 5696</span>&#160;        <span class="comment">// NULL ACLs are always OK for a SACL.</span></div>
<div class="line"><a name="l05697"></a><span class="lineno"> 5697</span>&#160;        <span class="comment">// NULL ACLs are never OK for a non-protected DACL.</span></div>
<div class="line"><a name="l05698"></a><span class="lineno"> 5698</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05699"></a><span class="lineno"> 5699</span>&#160;</div>
<div class="line"><a name="l05700"></a><span class="lineno"> 5700</span>&#160;        NullAclOk = IsSacl;</div>
<div class="line"><a name="l05701"></a><span class="lineno"> 5701</span>&#160;</div>
<div class="line"><a name="l05702"></a><span class="lineno"> 5702</span>&#160;</div>
<div class="line"><a name="l05703"></a><span class="lineno"> 5703</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05704"></a><span class="lineno"> 5704</span>&#160;        <span class="comment">// Only do the copy if the new ACL is specified.</span></div>
<div class="line"><a name="l05705"></a><span class="lineno"> 5705</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05706"></a><span class="lineno"> 5706</span>&#160;</div>
<div class="line"><a name="l05707"></a><span class="lineno"> 5707</span>&#160;        <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l05708"></a><span class="lineno"> 5708</span>&#160;            AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );</div>
<div class="line"><a name="l05709"></a><span class="lineno"> 5709</span>&#160;</div>
<div class="line"><a name="l05710"></a><span class="lineno"> 5710</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05711"></a><span class="lineno"> 5711</span>&#160;            <span class="comment">// Copy the non-inherited ACES, and generic map them.</span></div>
<div class="line"><a name="l05712"></a><span class="lineno"> 5712</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05713"></a><span class="lineno"> 5713</span>&#160;</div>
<div class="line"><a name="l05714"></a><span class="lineno"> 5714</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l05715"></a><span class="lineno"> 5715</span>&#160;                        ModificationAcl,</div>
<div class="line"><a name="l05716"></a><span class="lineno"> 5716</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l05717"></a><span class="lineno"> 5717</span>&#160;                        <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">CopyNonInheritedAces</a>,</div>
<div class="line"><a name="l05718"></a><span class="lineno"> 5718</span>&#160;                        0,</div>
<div class="line"><a name="l05719"></a><span class="lineno"> 5719</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Map sids as needed</span></div>
<div class="line"><a name="l05720"></a><span class="lineno"> 5720</span>&#160;                        ClientOwnerSid,</div>
<div class="line"><a name="l05721"></a><span class="lineno"> 5721</span>&#160;                        ClientGroupSid,</div>
<div class="line"><a name="l05722"></a><span class="lineno"> 5722</span>&#160;                        ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05723"></a><span class="lineno"> 5723</span>&#160;                        ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span></div>
<div class="line"><a name="l05724"></a><span class="lineno"> 5724</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Assume container and skip optimization</span></div>
<div class="line"><a name="l05725"></a><span class="lineno"> 5725</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,          <span class="comment">// Do not retain INHERITED_ACE bit for effective aces</span></div>
<div class="line"><a name="l05726"></a><span class="lineno"> 5726</span>&#160;                        &amp;ModificationNewAclSize,</div>
<div class="line"><a name="l05727"></a><span class="lineno"> 5727</span>&#160;                        (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer );</div>
<div class="line"><a name="l05728"></a><span class="lineno"> 5728</span>&#160;</div>
<div class="line"><a name="l05729"></a><span class="lineno"> 5729</span>&#160;            <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05730"></a><span class="lineno"> 5730</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05731"></a><span class="lineno"> 5731</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05732"></a><span class="lineno"> 5732</span>&#160;            }</div>
<div class="line"><a name="l05733"></a><span class="lineno"> 5733</span>&#160;</div>
<div class="line"><a name="l05734"></a><span class="lineno"> 5734</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05735"></a><span class="lineno"> 5735</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05736"></a><span class="lineno"> 5736</span>&#160;            }</div>
<div class="line"><a name="l05737"></a><span class="lineno"> 5737</span>&#160;</div>
<div class="line"><a name="l05738"></a><span class="lineno"> 5738</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05739"></a><span class="lineno"> 5739</span>&#160;            <span class="comment">// If the caller specified an ACL with no ACES,</span></div>
<div class="line"><a name="l05740"></a><span class="lineno"> 5740</span>&#160;            <span class="comment">//  make sure we generate an ACL with no ACES.</span></div>
<div class="line"><a name="l05741"></a><span class="lineno"> 5741</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05742"></a><span class="lineno"> 5742</span>&#160;            <span class="comment">// If inherited aces were deleted, leave the flag alone allowing</span></div>
<div class="line"><a name="l05743"></a><span class="lineno"> 5743</span>&#160;            <span class="comment">//  a NULL SACL to be generated.</span></div>
<div class="line"><a name="l05744"></a><span class="lineno"> 5744</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05745"></a><span class="lineno"> 5745</span>&#160;</div>
<div class="line"><a name="l05746"></a><span class="lineno"> 5746</span>&#160;            <span class="keywordflow">if</span> ( ModificationAcl-&gt;AceCount == 0 ) {</div>
<div class="line"><a name="l05747"></a><span class="lineno"> 5747</span>&#160;                NullAclOk = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l05748"></a><span class="lineno"> 5748</span>&#160;            }</div>
<div class="line"><a name="l05749"></a><span class="lineno"> 5749</span>&#160;</div>
<div class="line"><a name="l05750"></a><span class="lineno"> 5750</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05751"></a><span class="lineno"> 5751</span>&#160;        <span class="comment">// Since the ACL isn&#39;t protected,</span></div>
<div class="line"><a name="l05752"></a><span class="lineno"> 5752</span>&#160;        <span class="comment">//  don&#39;t allow NULL ACL semantics.</span></div>
<div class="line"><a name="l05753"></a><span class="lineno"> 5753</span>&#160;        <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span></div>
<div class="line"><a name="l05754"></a><span class="lineno"> 5754</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05755"></a><span class="lineno"> 5755</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsSacl ) {</div>
<div class="line"><a name="l05756"></a><span class="lineno"> 5756</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a>;</div>
<div class="line"><a name="l05757"></a><span class="lineno"> 5757</span>&#160;        }</div>
<div class="line"><a name="l05758"></a><span class="lineno"> 5758</span>&#160;</div>
<div class="line"><a name="l05759"></a><span class="lineno"> 5759</span>&#160;</div>
<div class="line"><a name="l05760"></a><span class="lineno"> 5760</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05761"></a><span class="lineno"> 5761</span>&#160;        <span class="comment">// Only do the copy if the old ACL is specified.</span></div>
<div class="line"><a name="l05762"></a><span class="lineno"> 5762</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05763"></a><span class="lineno"> 5763</span>&#160;</div>
<div class="line"><a name="l05764"></a><span class="lineno"> 5764</span>&#160;        <span class="keywordflow">if</span> ( CurrentAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l05765"></a><span class="lineno"> 5765</span>&#160;</div>
<div class="line"><a name="l05766"></a><span class="lineno"> 5766</span>&#160;            AclRevision = <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( AclRevision, CurrentAcl-&gt;AclRevision );</div>
<div class="line"><a name="l05767"></a><span class="lineno"> 5767</span>&#160;</div>
<div class="line"><a name="l05768"></a><span class="lineno"> 5768</span>&#160;</div>
<div class="line"><a name="l05769"></a><span class="lineno"> 5769</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05770"></a><span class="lineno"> 5770</span>&#160;            <span class="comment">// Copy the inherited ACES, and generic map them.</span></div>
<div class="line"><a name="l05771"></a><span class="lineno"> 5771</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05772"></a><span class="lineno"> 5772</span>&#160;            <span class="comment">// Don&#39;t bother mapping the sids in these ACEs.  They got mapped</span></div>
<div class="line"><a name="l05773"></a><span class="lineno"> 5773</span>&#160;            <span class="comment">// during inheritance.</span></div>
<div class="line"><a name="l05774"></a><span class="lineno"> 5774</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05775"></a><span class="lineno"> 5775</span>&#160;</div>
<div class="line"><a name="l05776"></a><span class="lineno"> 5776</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a>(</div>
<div class="line"><a name="l05777"></a><span class="lineno"> 5777</span>&#160;                        CurrentAcl,</div>
<div class="line"><a name="l05778"></a><span class="lineno"> 5778</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l05779"></a><span class="lineno"> 5779</span>&#160;                        <a class="code" href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc">CopyInheritedAces</a>,</div>
<div class="line"><a name="l05780"></a><span class="lineno"> 5780</span>&#160;                        0,</div>
<div class="line"><a name="l05781"></a><span class="lineno"> 5781</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,          <span class="comment">// Don&#39;t map the sids,</span></div>
<div class="line"><a name="l05782"></a><span class="lineno"> 5782</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l05783"></a><span class="lineno"> 5783</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l05784"></a><span class="lineno"> 5784</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l05785"></a><span class="lineno"> 5785</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l05786"></a><span class="lineno"> 5786</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,           <span class="comment">// Assume container and skip optimization</span></div>
<div class="line"><a name="l05787"></a><span class="lineno"> 5787</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,          <span class="comment">// Do not retain INHERITED_ACE bit for effective aces</span></div>
<div class="line"><a name="l05788"></a><span class="lineno"> 5788</span>&#160;                        &amp;CurrentNewAclSize,</div>
<div class="line"><a name="l05789"></a><span class="lineno"> 5789</span>&#160;                        (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)AclBuffer );</div>
<div class="line"><a name="l05790"></a><span class="lineno"> 5790</span>&#160;</div>
<div class="line"><a name="l05791"></a><span class="lineno"> 5791</span>&#160;            <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05792"></a><span class="lineno"> 5792</span>&#160;                AclOverflowed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l05793"></a><span class="lineno"> 5793</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05794"></a><span class="lineno"> 5794</span>&#160;            }</div>
<div class="line"><a name="l05795"></a><span class="lineno"> 5795</span>&#160;</div>
<div class="line"><a name="l05796"></a><span class="lineno"> 5796</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05797"></a><span class="lineno"> 5797</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05798"></a><span class="lineno"> 5798</span>&#160;            }</div>
<div class="line"><a name="l05799"></a><span class="lineno"> 5799</span>&#160;        }</div>
<div class="line"><a name="l05800"></a><span class="lineno"> 5800</span>&#160;    }</div>
<div class="line"><a name="l05801"></a><span class="lineno"> 5801</span>&#160;</div>
<div class="line"><a name="l05802"></a><span class="lineno"> 5802</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05803"></a><span class="lineno"> 5803</span>&#160;    <span class="comment">// If this routine didn&#39;t build the ACL,</span></div>
<div class="line"><a name="l05804"></a><span class="lineno"> 5804</span>&#160;    <span class="comment">//  tell the caller to use an explict NULL ACL</span></div>
<div class="line"><a name="l05805"></a><span class="lineno"> 5805</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05806"></a><span class="lineno"> 5806</span>&#160;</div>
<div class="line"><a name="l05807"></a><span class="lineno"> 5807</span>&#160;    <span class="keywordflow">if</span> ( ModificationNewAclSize + CurrentNewAclSize == 0) {</div>
<div class="line"><a name="l05808"></a><span class="lineno"> 5808</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05809"></a><span class="lineno"> 5809</span>&#160;        <span class="comment">// If the Acl was explictly assigned,</span></div>
<div class="line"><a name="l05810"></a><span class="lineno"> 5810</span>&#160;        <span class="comment">//  generate a NULL ACL based on the path taken above.</span></div>
<div class="line"><a name="l05811"></a><span class="lineno"> 5811</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05812"></a><span class="lineno"> 5812</span>&#160;</div>
<div class="line"><a name="l05813"></a><span class="lineno"> 5813</span>&#160;        <span class="keywordflow">if</span> ( NullAclOk ) {</div>
<div class="line"><a name="l05814"></a><span class="lineno"> 5814</span>&#160;            *AclBufferSize = 0;</div>
<div class="line"><a name="l05815"></a><span class="lineno"> 5815</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05816"></a><span class="lineno"> 5816</span>&#160;        }</div>
<div class="line"><a name="l05817"></a><span class="lineno"> 5817</span>&#160;    }</div>
<div class="line"><a name="l05818"></a><span class="lineno"> 5818</span>&#160;</div>
<div class="line"><a name="l05819"></a><span class="lineno"> 5819</span>&#160;</div>
<div class="line"><a name="l05820"></a><span class="lineno"> 5820</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05821"></a><span class="lineno"> 5821</span>&#160;    <span class="comment">// And make sure we don&#39;t exceed the length limitations of an ACL (WORD)</span></div>
<div class="line"><a name="l05822"></a><span class="lineno"> 5822</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05823"></a><span class="lineno"> 5823</span>&#160;</div>
<div class="line"><a name="l05824"></a><span class="lineno"> 5824</span>&#160;    <span class="keywordflow">if</span> ( ModificationNewAclSize + CurrentNewAclSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/dd4/a00013.html">ACL</a>) &gt; 0xFFFF) {</div>
<div class="line"><a name="l05825"></a><span class="lineno"> 5825</span>&#160;        <span class="keywordflow">return</span>(<a class="code" href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a>);</div>
<div class="line"><a name="l05826"></a><span class="lineno"> 5826</span>&#160;    }</div>
<div class="line"><a name="l05827"></a><span class="lineno"> 5827</span>&#160;</div>
<div class="line"><a name="l05828"></a><span class="lineno"> 5828</span>&#160;    (*AclBufferSize) = ModificationNewAclSize + CurrentNewAclSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#a067989903b97870422dc2a37d11684f8">ACL</a>);</div>
<div class="line"><a name="l05829"></a><span class="lineno"> 5829</span>&#160;</div>
<div class="line"><a name="l05830"></a><span class="lineno"> 5830</span>&#160;    <span class="keywordflow">if</span> ( AclOverflowed ) {</div>
<div class="line"><a name="l05831"></a><span class="lineno"> 5831</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a>;</div>
<div class="line"><a name="l05832"></a><span class="lineno"> 5832</span>&#160;    }</div>
<div class="line"><a name="l05833"></a><span class="lineno"> 5833</span>&#160;</div>
<div class="line"><a name="l05834"></a><span class="lineno"> 5834</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05835"></a><span class="lineno"> 5835</span>&#160;    <span class="comment">// Patch the real ACL size and revision into the ACL</span></div>
<div class="line"><a name="l05836"></a><span class="lineno"> 5836</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05837"></a><span class="lineno"> 5837</span>&#160;</div>
<div class="line"><a name="l05838"></a><span class="lineno"> 5838</span>&#160;    ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AclSize = (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>) *AclBufferSize;</div>
<div class="line"><a name="l05839"></a><span class="lineno"> 5839</span>&#160;    ((<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)AclBuffer)-&gt;AclRevision = (<a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>) AclRevision;</div>
<div class="line"><a name="l05840"></a><span class="lineno"> 5840</span>&#160;</div>
<div class="line"><a name="l05841"></a><span class="lineno"> 5841</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l05842"></a><span class="lineno"> 5842</span>&#160;}</div>
<div class="line"><a name="l05843"></a><span class="lineno"> 5843</span>&#160;</div>
<div class="line"><a name="l05844"></a><span class="lineno"> 5844</span>&#160;</div>
<div class="line"><a name="l05845"></a><span class="lineno"> 5845</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l05846"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472"> 5846</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472">RtlpComputeMergedAcl</a> (</div>
<div class="line"><a name="l05847"></a><span class="lineno"> 5847</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentAcl,</div>
<div class="line"><a name="l05848"></a><span class="lineno"> 5848</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CurrentGenericControl,</div>
<div class="line"><a name="l05849"></a><span class="lineno"> 5849</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ModificationAcl,</div>
<div class="line"><a name="l05850"></a><span class="lineno"> 5850</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ModificationGenericControl,</div>
<div class="line"><a name="l05851"></a><span class="lineno"> 5851</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientOwnerSid,</div>
<div class="line"><a name="l05852"></a><span class="lineno"> 5852</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientGroupSid,</div>
<div class="line"><a name="l05853"></a><span class="lineno"> 5853</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l05854"></a><span class="lineno"> 5854</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsSacl,</div>
<div class="line"><a name="l05855"></a><span class="lineno"> 5855</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *NewAcl,</div>
<div class="line"><a name="l05856"></a><span class="lineno"> 5856</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l05857"></a><span class="lineno"> 5857</span>&#160;    )</div>
<div class="line"><a name="l05858"></a><span class="lineno"> 5858</span>&#160;</div>
<div class="line"><a name="l05859"></a><span class="lineno"> 5859</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l05860"></a><span class="lineno"> 5860</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05861"></a><span class="lineno"> 5861</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l05862"></a><span class="lineno"> 5862</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05863"></a><span class="lineno"> 5863</span>&#160;<span class="comment">    This routine builds the actual ACL that should be set on an object.</span></div>
<div class="line"><a name="l05864"></a><span class="lineno"> 5864</span>&#160;<span class="comment">    The built ACL is a composite of the previous ACL on an object and</span></div>
<div class="line"><a name="l05865"></a><span class="lineno"> 5865</span>&#160;<span class="comment">    the newly set ACL on the object.  The New ACL is built as follows:</span></div>
<div class="line"><a name="l05866"></a><span class="lineno"> 5866</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05867"></a><span class="lineno"> 5867</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set in neither CurrentAcl nor ModificationAcl,</span></div>
<div class="line"><a name="l05868"></a><span class="lineno"> 5868</span>&#160;<span class="comment">    the NewAcl is constructed from the inherited ACEs from the</span></div>
<div class="line"><a name="l05869"></a><span class="lineno"> 5869</span>&#160;<span class="comment">    CurrentAcl and the non-inherited ACEs from the ModificationAcl.</span></div>
<div class="line"><a name="l05870"></a><span class="lineno"> 5870</span>&#160;<span class="comment">    (That is, it is impossible to edit an inherited ACE by changing the</span></div>
<div class="line"><a name="l05871"></a><span class="lineno"> 5871</span>&#160;<span class="comment">    ACL on an object.)</span></div>
<div class="line"><a name="l05872"></a><span class="lineno"> 5872</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05873"></a><span class="lineno"> 5873</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set on ModificationAcl, CurrentAcl is ignored.</span></div>
<div class="line"><a name="l05874"></a><span class="lineno"> 5874</span>&#160;<span class="comment">    NewAcl is built as a copy of ModificationAcl with any INHERITED_ACE</span></div>
<div class="line"><a name="l05875"></a><span class="lineno"> 5875</span>&#160;<span class="comment">    bits turned off.</span></div>
<div class="line"><a name="l05876"></a><span class="lineno"> 5876</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05877"></a><span class="lineno"> 5877</span>&#160;<span class="comment">    If SEP_ACL_PROTECTED is set on CurrentAcl and not ModificationAcl, the</span></div>
<div class="line"><a name="l05878"></a><span class="lineno"> 5878</span>&#160;<span class="comment">    CurrentAcl is ignored.  NewAcl is built as a copy of</span></div>
<div class="line"><a name="l05879"></a><span class="lineno"> 5879</span>&#160;<span class="comment">    ModificationDescriptor.  It is the callers responsibility to ensure</span></div>
<div class="line"><a name="l05880"></a><span class="lineno"> 5880</span>&#160;<span class="comment">    that the correct ACEs have the INHERITED_ACE bit turned on.</span></div>
<div class="line"><a name="l05881"></a><span class="lineno"> 5881</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05882"></a><span class="lineno"> 5882</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l05883"></a><span class="lineno"> 5883</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05884"></a><span class="lineno"> 5884</span>&#160;<span class="comment">    CurrentAcl - The current ACL on the object.</span></div>
<div class="line"><a name="l05885"></a><span class="lineno"> 5885</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05886"></a><span class="lineno"> 5886</span>&#160;<span class="comment">    CurrentGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l05887"></a><span class="lineno"> 5887</span>&#160;<span class="comment">        describing the CurrentAcl.</span></div>
<div class="line"><a name="l05888"></a><span class="lineno"> 5888</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05889"></a><span class="lineno"> 5889</span>&#160;<span class="comment">    ModificationAcl - The ACL being applied to the object.</span></div>
<div class="line"><a name="l05890"></a><span class="lineno"> 5890</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05891"></a><span class="lineno"> 5891</span>&#160;<span class="comment">    ModificationGenericControl - Specifies the control flags from the SecurityDescriptor</span></div>
<div class="line"><a name="l05892"></a><span class="lineno"> 5892</span>&#160;<span class="comment">        describing the CurrentAcl.</span></div>
<div class="line"><a name="l05893"></a><span class="lineno"> 5893</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05894"></a><span class="lineno"> 5894</span>&#160;<span class="comment">    ClientOwnerSid - Specifies the owner Sid to use</span></div>
<div class="line"><a name="l05895"></a><span class="lineno"> 5895</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05896"></a><span class="lineno"> 5896</span>&#160;<span class="comment">    ClientGroupSid - Specifies the new Group Sid to use</span></div>
<div class="line"><a name="l05897"></a><span class="lineno"> 5897</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05898"></a><span class="lineno"> 5898</span>&#160;<span class="comment">    GenericMapping - The mapping of generic to specific and standard</span></div>
<div class="line"><a name="l05899"></a><span class="lineno"> 5899</span>&#160;<span class="comment">                     access types.</span></div>
<div class="line"><a name="l05900"></a><span class="lineno"> 5900</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05901"></a><span class="lineno"> 5901</span>&#160;<span class="comment">    IsSacl - True if this is the SACL.  False if this is the DACL.</span></div>
<div class="line"><a name="l05902"></a><span class="lineno"> 5902</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05903"></a><span class="lineno"> 5903</span>&#160;<span class="comment">    NewAcl - Receives a pointer to the new resultant acl.</span></div>
<div class="line"><a name="l05904"></a><span class="lineno"> 5904</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05905"></a><span class="lineno"> 5905</span>&#160;<span class="comment">    NewGenericControl - Specifies the control flags for the newly</span></div>
<div class="line"><a name="l05906"></a><span class="lineno"> 5906</span>&#160;<span class="comment">        generated ACL.</span></div>
<div class="line"><a name="l05907"></a><span class="lineno"> 5907</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05908"></a><span class="lineno"> 5908</span>&#160;<span class="comment">        Only the Protected and AutoInherited bits are returned.</span></div>
<div class="line"><a name="l05909"></a><span class="lineno"> 5909</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05910"></a><span class="lineno"> 5910</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l05911"></a><span class="lineno"> 5911</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05912"></a><span class="lineno"> 5912</span>&#160;<span class="comment">    STATUS_SUCCESS - An ACL was successfully generated.</span></div>
<div class="line"><a name="l05913"></a><span class="lineno"> 5913</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05914"></a><span class="lineno"> 5914</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span></div>
<div class="line"><a name="l05915"></a><span class="lineno"> 5915</span>&#160;<span class="comment">        is unknown to this routine.</span></div>
<div class="line"><a name="l05916"></a><span class="lineno"> 5916</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05917"></a><span class="lineno"> 5917</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l05918"></a><span class="lineno"> 5918</span>&#160;</div>
<div class="line"><a name="l05919"></a><span class="lineno"> 5919</span>&#160;{</div>
<div class="line"><a name="l05920"></a><span class="lineno"> 5920</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05921"></a><span class="lineno"> 5921</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AclBufferSize;</div>
<div class="line"><a name="l05922"></a><span class="lineno"> 5922</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l05923"></a><span class="lineno"> 5923</span>&#160;</div>
<div class="line"><a name="l05924"></a><span class="lineno"> 5924</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l05925"></a><span class="lineno"> 5925</span>&#160;</div>
<div class="line"><a name="l05926"></a><span class="lineno"> 5926</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05927"></a><span class="lineno"> 5927</span>&#160;    <span class="comment">// Implement a two pass strategy.</span></div>
<div class="line"><a name="l05928"></a><span class="lineno"> 5928</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05929"></a><span class="lineno"> 5929</span>&#160;    <span class="comment">// First try to create the ACL in a fixed length buffer.</span></div>
<div class="line"><a name="l05930"></a><span class="lineno"> 5930</span>&#160;    <span class="comment">// If that is too small,</span></div>
<div class="line"><a name="l05931"></a><span class="lineno"> 5931</span>&#160;    <span class="comment">//  then use the buffer size determined on the first pass</span></div>
<div class="line"><a name="l05932"></a><span class="lineno"> 5932</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l05933"></a><span class="lineno"> 5933</span>&#160;</div>
<div class="line"><a name="l05934"></a><span class="lineno"> 5934</span>&#160;    AclBufferSize = 1024;</div>
<div class="line"><a name="l05935"></a><span class="lineno"> 5935</span>&#160;    <span class="keywordflow">for</span> ( i=0; i&lt;2 ; i++ ) {</div>
<div class="line"><a name="l05936"></a><span class="lineno"> 5936</span>&#160;</div>
<div class="line"><a name="l05937"></a><span class="lineno"> 5937</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05938"></a><span class="lineno"> 5938</span>&#160;        <span class="comment">// Allocate heap for the new ACL.</span></div>
<div class="line"><a name="l05939"></a><span class="lineno"> 5939</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05940"></a><span class="lineno"> 5940</span>&#160;</div>
<div class="line"><a name="l05941"></a><span class="lineno"> 5941</span>&#160;        (*NewAcl) = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l05942"></a><span class="lineno"> 5942</span>&#160;                        <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l05943"></a><span class="lineno"> 5943</span>&#160;                        AclBufferSize,</div>
<div class="line"><a name="l05944"></a><span class="lineno"> 5944</span>&#160;                        <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l05945"></a><span class="lineno"> 5945</span>&#160;</div>
<div class="line"><a name="l05946"></a><span class="lineno"> 5946</span>&#160;        <span class="keywordflow">if</span> ((*NewAcl) == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l05947"></a><span class="lineno"> 5947</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a> );</div>
<div class="line"><a name="l05948"></a><span class="lineno"> 5948</span>&#160;        }</div>
<div class="line"><a name="l05949"></a><span class="lineno"> 5949</span>&#160;</div>
<div class="line"><a name="l05950"></a><span class="lineno"> 5950</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05951"></a><span class="lineno"> 5951</span>&#160;        <span class="comment">// Merge the ACLs</span></div>
<div class="line"><a name="l05952"></a><span class="lineno"> 5952</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l05953"></a><span class="lineno"> 5953</span>&#160;</div>
<div class="line"><a name="l05954"></a><span class="lineno"> 5954</span>&#160;        Status = <a class="code" href="../../d3/d32/a02665.html#ae38867c753fcc5b5e3a162cec8c60fa1">RtlpComputeMergedAcl2</a> (</div>
<div class="line"><a name="l05955"></a><span class="lineno"> 5955</span>&#160;                    CurrentAcl,</div>
<div class="line"><a name="l05956"></a><span class="lineno"> 5956</span>&#160;                    CurrentGenericControl,</div>
<div class="line"><a name="l05957"></a><span class="lineno"> 5957</span>&#160;                    ModificationAcl,</div>
<div class="line"><a name="l05958"></a><span class="lineno"> 5958</span>&#160;                    ModificationGenericControl,</div>
<div class="line"><a name="l05959"></a><span class="lineno"> 5959</span>&#160;                    ClientOwnerSid,</div>
<div class="line"><a name="l05960"></a><span class="lineno"> 5960</span>&#160;                    ClientGroupSid,</div>
<div class="line"><a name="l05961"></a><span class="lineno"> 5961</span>&#160;                    GenericMapping,</div>
<div class="line"><a name="l05962"></a><span class="lineno"> 5962</span>&#160;                    IsSacl,</div>
<div class="line"><a name="l05963"></a><span class="lineno"> 5963</span>&#160;                    &amp;AclBufferSize,</div>
<div class="line"><a name="l05964"></a><span class="lineno"> 5964</span>&#160;                    (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>) *NewAcl,</div>
<div class="line"><a name="l05965"></a><span class="lineno"> 5965</span>&#160;                    NewGenericControl );</div>
<div class="line"><a name="l05966"></a><span class="lineno"> 5966</span>&#160;</div>
<div class="line"><a name="l05967"></a><span class="lineno"> 5967</span>&#160;</div>
<div class="line"><a name="l05968"></a><span class="lineno"> 5968</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l05969"></a><span class="lineno"> 5969</span>&#160;</div>
<div class="line"><a name="l05970"></a><span class="lineno"> 5970</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05971"></a><span class="lineno"> 5971</span>&#160;            <span class="comment">// If a NULL ACL should be used,</span></div>
<div class="line"><a name="l05972"></a><span class="lineno"> 5972</span>&#160;            <span class="comment">//  tell the caller.</span></div>
<div class="line"><a name="l05973"></a><span class="lineno"> 5973</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l05974"></a><span class="lineno"> 5974</span>&#160;</div>
<div class="line"><a name="l05975"></a><span class="lineno"> 5975</span>&#160;            <span class="keywordflow">if</span> ( AclBufferSize == 0 ) {</div>
<div class="line"><a name="l05976"></a><span class="lineno"> 5976</span>&#160;                <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( *NewAcl );</div>
<div class="line"><a name="l05977"></a><span class="lineno"> 5977</span>&#160;                *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l05978"></a><span class="lineno"> 5978</span>&#160;            }</div>
<div class="line"><a name="l05979"></a><span class="lineno"> 5979</span>&#160;</div>
<div class="line"><a name="l05980"></a><span class="lineno"> 5980</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l05981"></a><span class="lineno"> 5981</span>&#160;</div>
<div class="line"><a name="l05982"></a><span class="lineno"> 5982</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l05983"></a><span class="lineno"> 5983</span>&#160;            <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( *NewAcl );</div>
<div class="line"><a name="l05984"></a><span class="lineno"> 5984</span>&#160;            *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l05985"></a><span class="lineno"> 5985</span>&#160;</div>
<div class="line"><a name="l05986"></a><span class="lineno"> 5986</span>&#160;            <span class="keywordflow">if</span> ( Status != <a class="code" href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a> ) {</div>
<div class="line"><a name="l05987"></a><span class="lineno"> 5987</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l05988"></a><span class="lineno"> 5988</span>&#160;            }</div>
<div class="line"><a name="l05989"></a><span class="lineno"> 5989</span>&#160;        }</div>
<div class="line"><a name="l05990"></a><span class="lineno"> 5990</span>&#160;    }</div>
<div class="line"><a name="l05991"></a><span class="lineno"> 5991</span>&#160;</div>
<div class="line"><a name="l05992"></a><span class="lineno"> 5992</span>&#160;</div>
<div class="line"><a name="l05993"></a><span class="lineno"> 5993</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l05994"></a><span class="lineno"> 5994</span>&#160;}</div>
<div class="line"><a name="l05995"></a><span class="lineno"> 5995</span>&#160;</div>
<div class="line"><a name="l05996"></a><span class="lineno"> 5996</span>&#160;<span class="preprocessor">#endif // WIN16</span></div>
<div class="line"><a name="l05997"></a><span class="lineno"> 5997</span>&#160;</div>
<div class="line"><a name="l05998"></a><span class="lineno"> 5998</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l05999"></a><span class="lineno"> 5999</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l06000"></a><span class="lineno"> 6000</span>&#160;RtlDumpUserSid(</div>
<div class="line"><a name="l06001"></a><span class="lineno"> 6001</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l06002"></a><span class="lineno"> 6002</span>&#160;    )</div>
<div class="line"><a name="l06003"></a><span class="lineno"> 6003</span>&#160;{</div>
<div class="line"><a name="l06004"></a><span class="lineno"> 6004</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l06005"></a><span class="lineno"> 6005</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a>   TokenHandle;</div>
<div class="line"><a name="l06006"></a><span class="lineno"> 6006</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>     <a class="code" href="../../de/dc3/a02256.html#a1f06b5cf5a277b5ecd2579b4f1387ca5">Buffer</a>[200];</div>
<div class="line"><a name="l06007"></a><span class="lineno"> 6007</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>    ReturnLength;</div>
<div class="line"><a name="l06008"></a><span class="lineno"> 6008</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>     pSid;</div>
<div class="line"><a name="l06009"></a><span class="lineno"> 6009</span>&#160;    <a class="code" href="../../dd/d00/a01776.html">UNICODE_STRING</a> SidString;</div>
<div class="line"><a name="l06010"></a><span class="lineno"> 6010</span>&#160;    <a class="code" href="../../dc/d3a/a01750.html">PTOKEN_USER</a>  User;</div>
<div class="line"><a name="l06011"></a><span class="lineno"> 6011</span>&#160;</div>
<div class="line"><a name="l06012"></a><span class="lineno"> 6012</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06013"></a><span class="lineno"> 6013</span>&#160;    <span class="comment">// Attempt to open the impersonation token first</span></div>
<div class="line"><a name="l06014"></a><span class="lineno"> 6014</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06015"></a><span class="lineno"> 6015</span>&#160;</div>
<div class="line"><a name="l06016"></a><span class="lineno"> 6016</span>&#160;    Status = <a class="code" href="../../d3/d3a/a02259.html#a3cb6b2ed9abea1f641f5c05f14eb9d2c">NtOpenThreadToken</a>(</div>
<div class="line"><a name="l06017"></a><span class="lineno"> 6017</span>&#160;                 <a class="code" href="../../db/d7a/a02253.html#ab24eb59f288b52281cad79f4a3871b1d">NtCurrentThread</a>(),</div>
<div class="line"><a name="l06018"></a><span class="lineno"> 6018</span>&#160;                 <a class="code" href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a>,</div>
<div class="line"><a name="l06019"></a><span class="lineno"> 6019</span>&#160;                 <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><a name="l06020"></a><span class="lineno"> 6020</span>&#160;                 &amp;TokenHandle</div>
<div class="line"><a name="l06021"></a><span class="lineno"> 6021</span>&#160;                 );</div>
<div class="line"><a name="l06022"></a><span class="lineno"> 6022</span>&#160;</div>
<div class="line"><a name="l06023"></a><span class="lineno"> 6023</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l06024"></a><span class="lineno"> 6024</span>&#160;</div>
<div class="line"><a name="l06025"></a><span class="lineno"> 6025</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a>(<span class="stringliteral">&quot;Not impersonating, status = %X, trying process token\n&quot;</span>,Status);</div>
<div class="line"><a name="l06026"></a><span class="lineno"> 6026</span>&#160;</div>
<div class="line"><a name="l06027"></a><span class="lineno"> 6027</span>&#160;        Status = <a class="code" href="../../d3/d3a/a02259.html#a28a40ba853d20ecf9ac183c572c2cace">NtOpenProcessToken</a>(</div>
<div class="line"><a name="l06028"></a><span class="lineno"> 6028</span>&#160;                     <a class="code" href="../../db/d7a/a02253.html#a719a7ce85358702f11dce2cd31896b4b">NtCurrentProcess</a>(),</div>
<div class="line"><a name="l06029"></a><span class="lineno"> 6029</span>&#160;                     <a class="code" href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a>,</div>
<div class="line"><a name="l06030"></a><span class="lineno"> 6030</span>&#160;                     &amp;TokenHandle</div>
<div class="line"><a name="l06031"></a><span class="lineno"> 6031</span>&#160;                     );</div>
<div class="line"><a name="l06032"></a><span class="lineno"> 6032</span>&#160;</div>
<div class="line"><a name="l06033"></a><span class="lineno"> 6033</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l06034"></a><span class="lineno"> 6034</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a>(<span class="stringliteral">&quot;Unable to open process token, status = %X\n&quot;</span>,Status);</div>
<div class="line"><a name="l06035"></a><span class="lineno"> 6035</span>&#160;            <span class="keywordflow">return</span>( Status );</div>
<div class="line"><a name="l06036"></a><span class="lineno"> 6036</span>&#160;        }</div>
<div class="line"><a name="l06037"></a><span class="lineno"> 6037</span>&#160;    }</div>
<div class="line"><a name="l06038"></a><span class="lineno"> 6038</span>&#160;</div>
<div class="line"><a name="l06039"></a><span class="lineno"> 6039</span>&#160;    Status = <a class="code" href="../../d3/d3a/a02259.html#a2e2488a35875361c69e64f983bdbcbe2">NtQueryInformationToken</a> (</div>
<div class="line"><a name="l06040"></a><span class="lineno"> 6040</span>&#160;                 TokenHandle,</div>
<div class="line"><a name="l06041"></a><span class="lineno"> 6041</span>&#160;                 <a class="code" href="../../d3/d3a/a02259.html#a8d2e2b23032684e99009ac3a7410aec4ab1f63b56b600d07b198c87bac55261fb">TokenUser</a>,</div>
<div class="line"><a name="l06042"></a><span class="lineno"> 6042</span>&#160;                 Buffer,</div>
<div class="line"><a name="l06043"></a><span class="lineno"> 6043</span>&#160;                 200,</div>
<div class="line"><a name="l06044"></a><span class="lineno"> 6044</span>&#160;                 &amp;ReturnLength</div>
<div class="line"><a name="l06045"></a><span class="lineno"> 6045</span>&#160;                 );</div>
<div class="line"><a name="l06046"></a><span class="lineno"> 6046</span>&#160;</div>
<div class="line"><a name="l06047"></a><span class="lineno"> 6047</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l06048"></a><span class="lineno"> 6048</span>&#160;</div>
<div class="line"><a name="l06049"></a><span class="lineno"> 6049</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a>(<span class="stringliteral">&quot;Unable to query user sid, status = %X \n&quot;</span>,Status);</div>
<div class="line"><a name="l06050"></a><span class="lineno"> 6050</span>&#160;        <a class="code" href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a>(TokenHandle);</div>
<div class="line"><a name="l06051"></a><span class="lineno"> 6051</span>&#160;        <span class="keywordflow">return</span>( Status );</div>
<div class="line"><a name="l06052"></a><span class="lineno"> 6052</span>&#160;    }</div>
<div class="line"><a name="l06053"></a><span class="lineno"> 6053</span>&#160;</div>
<div class="line"><a name="l06054"></a><span class="lineno"> 6054</span>&#160;    User = (<a class="code" href="../../d3/d3a/a02259.html#a3804f89782de6650b5db5183d14372f9">PTOKEN_USER</a>)Buffer;</div>
<div class="line"><a name="l06055"></a><span class="lineno"> 6055</span>&#160;</div>
<div class="line"><a name="l06056"></a><span class="lineno"> 6056</span>&#160;    pSid = User-&gt;<a class="code" href="../../dc/d3a/a01750.html#a6ff4d81245f39eecbe73e61392a3ebda">User</a>.<a class="code" href="../../d3/d2d/a01625.html#a65626cb95688165a5d004e32a6e48d48">Sid</a>;</div>
<div class="line"><a name="l06057"></a><span class="lineno"> 6057</span>&#160;</div>
<div class="line"><a name="l06058"></a><span class="lineno"> 6058</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#ad777622d13f820696a40076775ea44f8">RtlConvertSidToUnicodeString</a>( &amp;SidString, pSid, <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );</div>
<div class="line"><a name="l06059"></a><span class="lineno"> 6059</span>&#160;</div>
<div class="line"><a name="l06060"></a><span class="lineno"> 6060</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l06061"></a><span class="lineno"> 6061</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a>(<span class="stringliteral">&quot;Unable to format sid string, status = %X \n&quot;</span>,Status);</div>
<div class="line"><a name="l06062"></a><span class="lineno"> 6062</span>&#160;        <a class="code" href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a>(TokenHandle);</div>
<div class="line"><a name="l06063"></a><span class="lineno"> 6063</span>&#160;        <span class="keywordflow">return</span>( Status );</div>
<div class="line"><a name="l06064"></a><span class="lineno"> 6064</span>&#160;    }</div>
<div class="line"><a name="l06065"></a><span class="lineno"> 6065</span>&#160;</div>
<div class="line"><a name="l06066"></a><span class="lineno"> 6066</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a>(<span class="stringliteral">&quot;Current Sid = %wZ \n&quot;</span>,&amp;SidString);</div>
<div class="line"><a name="l06067"></a><span class="lineno"> 6067</span>&#160;</div>
<div class="line"><a name="l06068"></a><span class="lineno"> 6068</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#abe972030403da31994eecb16d6f7d1b9">RtlFreeUnicodeString</a>( &amp;SidString );</div>
<div class="line"><a name="l06069"></a><span class="lineno"> 6069</span>&#160;</div>
<div class="line"><a name="l06070"></a><span class="lineno"> 6070</span>&#160;    <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> );</div>
<div class="line"><a name="l06071"></a><span class="lineno"> 6071</span>&#160;}</div>
<div class="line"><a name="l06072"></a><span class="lineno"> 6072</span>&#160;</div>
<div class="line"><a name="l06073"></a><span class="lineno"> 6073</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l06074"></a><span class="lineno"> 6074</span>&#160;</div>
<div class="line"><a name="l06075"></a><span class="lineno"> 6075</span>&#160;</div>
<div class="line"><a name="l06076"></a><span class="lineno"> 6076</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l06077"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a8a2144d239d6afa124e5ec59e2eb9e19"> 6077</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a8a2144d239d6afa124e5ec59e2eb9e19">RtlpConvertToAutoInheritSecurityObject</a>(</div>
<div class="line"><a name="l06078"></a><span class="lineno"> 6078</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> ParentDescriptor <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l06079"></a><span class="lineno"> 6079</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> CurrentSecurityDescriptor,</div>
<div class="line"><a name="l06080"></a><span class="lineno"> 6080</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> *NewSecurityDescriptor,</div>
<div class="line"><a name="l06081"></a><span class="lineno"> 6081</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> *ObjectType OPTIONAL,</div>
<div class="line"><a name="l06082"></a><span class="lineno"> 6082</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l06083"></a><span class="lineno"> 6083</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping</div>
<div class="line"><a name="l06084"></a><span class="lineno"> 6084</span>&#160;    )</div>
<div class="line"><a name="l06085"></a><span class="lineno"> 6085</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l06086"></a><span class="lineno"> 6086</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06087"></a><span class="lineno"> 6087</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l06088"></a><span class="lineno"> 6088</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06089"></a><span class="lineno"> 6089</span>&#160;<span class="comment">    This routine a converts a security descriptor whose ACLs are not marked</span></div>
<div class="line"><a name="l06090"></a><span class="lineno"> 6090</span>&#160;<span class="comment">    as AutoInherit to a security descriptor whose ACLs are marked as</span></div>
<div class="line"><a name="l06091"></a><span class="lineno"> 6091</span>&#160;<span class="comment">    AutoInherit.</span></div>
<div class="line"><a name="l06092"></a><span class="lineno"> 6092</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06093"></a><span class="lineno"> 6093</span>&#160;<span class="comment">    See comments for RtlConvertToAutoInheritSecurityObject.</span></div>
<div class="line"><a name="l06094"></a><span class="lineno"> 6094</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06095"></a><span class="lineno"> 6095</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l06096"></a><span class="lineno"> 6096</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06097"></a><span class="lineno"> 6097</span>&#160;<span class="comment">    ParentDescriptor - Supplies the Security Descriptor for the parent</span></div>
<div class="line"><a name="l06098"></a><span class="lineno"> 6098</span>&#160;<span class="comment">        directory under which a object exists.  If there is</span></div>
<div class="line"><a name="l06099"></a><span class="lineno"> 6099</span>&#160;<span class="comment">        no parent directory, then this argument is specified as NULL.</span></div>
<div class="line"><a name="l06100"></a><span class="lineno"> 6100</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06101"></a><span class="lineno"> 6101</span>&#160;<span class="comment">    CurrentSecurityDescriptor - Supplies a pointer to the objects security descriptor</span></div>
<div class="line"><a name="l06102"></a><span class="lineno"> 6102</span>&#160;<span class="comment">        that is going to be altered by this procedure.</span></div>
<div class="line"><a name="l06103"></a><span class="lineno"> 6103</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06104"></a><span class="lineno"> 6104</span>&#160;<span class="comment">    NewSecurityDescriptor Points to a pointer that is to be made to point to the</span></div>
<div class="line"><a name="l06105"></a><span class="lineno"> 6105</span>&#160;<span class="comment">        newly allocated self-relative security descriptor. When no</span></div>
<div class="line"><a name="l06106"></a><span class="lineno"> 6106</span>&#160;<span class="comment">        longer needed, this descriptor must be freed using</span></div>
<div class="line"><a name="l06107"></a><span class="lineno"> 6107</span>&#160;<span class="comment">        DestroyPrivateObjectSecurity().</span></div>
<div class="line"><a name="l06108"></a><span class="lineno"> 6108</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06109"></a><span class="lineno"> 6109</span>&#160;<span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span></div>
<div class="line"><a name="l06110"></a><span class="lineno"> 6110</span>&#160;<span class="comment">        created has no GUID associated with it, then this argument is</span></div>
<div class="line"><a name="l06111"></a><span class="lineno"> 6111</span>&#160;<span class="comment">        specified as NULL.</span></div>
<div class="line"><a name="l06112"></a><span class="lineno"> 6112</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06113"></a><span class="lineno"> 6113</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the object is a</span></div>
<div class="line"><a name="l06114"></a><span class="lineno"> 6114</span>&#160;<span class="comment">        directory object.  A value of TRUE indicates the object is a</span></div>
<div class="line"><a name="l06115"></a><span class="lineno"> 6115</span>&#160;<span class="comment">        container of other objects.</span></div>
<div class="line"><a name="l06116"></a><span class="lineno"> 6116</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06117"></a><span class="lineno"> 6117</span>&#160;<span class="comment">    GenericMapping - Supplies a pointer to a generic mapping array denoting</span></div>
<div class="line"><a name="l06118"></a><span class="lineno"> 6118</span>&#160;<span class="comment">        the mapping between each generic right to specific rights.</span></div>
<div class="line"><a name="l06119"></a><span class="lineno"> 6119</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06120"></a><span class="lineno"> 6120</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l06121"></a><span class="lineno"> 6121</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06122"></a><span class="lineno"> 6122</span>&#160;<span class="comment">    STATUS_SUCCESS - The operation was successful.</span></div>
<div class="line"><a name="l06123"></a><span class="lineno"> 6123</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06124"></a><span class="lineno"> 6124</span>&#160;<span class="comment">    See comments for RtlConvertToAutoInheritSecurityObject.</span></div>
<div class="line"><a name="l06125"></a><span class="lineno"> 6125</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06126"></a><span class="lineno"> 6126</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06127"></a><span class="lineno"> 6127</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l06128"></a><span class="lineno"> 6128</span>&#160;{</div>
<div class="line"><a name="l06129"></a><span class="lineno"> 6129</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l06130"></a><span class="lineno"> 6130</span>&#160;    <a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> CurrentDescriptor;</div>
<div class="line"><a name="l06131"></a><span class="lineno"> 6131</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentSacl;</div>
<div class="line"><a name="l06132"></a><span class="lineno"> 6132</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> CurrentDacl;</div>
<div class="line"><a name="l06133"></a><span class="lineno"> 6133</span>&#160;</div>
<div class="line"><a name="l06134"></a><span class="lineno"> 6134</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewOwner;</div>
<div class="line"><a name="l06135"></a><span class="lineno"> 6135</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewGroup;</div>
<div class="line"><a name="l06136"></a><span class="lineno"> 6136</span>&#160;</div>
<div class="line"><a name="l06137"></a><span class="lineno"> 6137</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewSacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l06138"></a><span class="lineno"> 6138</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewSaclControl = 0;</div>
<div class="line"><a name="l06139"></a><span class="lineno"> 6139</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewSaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06140"></a><span class="lineno"> 6140</span>&#160;</div>
<div class="line"><a name="l06141"></a><span class="lineno"> 6141</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l06142"></a><span class="lineno"> 6142</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewDaclControl = 0;</div>
<div class="line"><a name="l06143"></a><span class="lineno"> 6143</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewDaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06144"></a><span class="lineno"> 6144</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> TemplateInheritedDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l06145"></a><span class="lineno"> 6145</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GenericControl;</div>
<div class="line"><a name="l06146"></a><span class="lineno"> 6146</span>&#160;</div>
<div class="line"><a name="l06147"></a><span class="lineno"> 6147</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d7/d24/a02261.html#a053c57ea472f2605ef6d732f25e5c6b8">AllocationSize</a>;</div>
<div class="line"><a name="l06148"></a><span class="lineno"> 6148</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewOwnerSize;</div>
<div class="line"><a name="l06149"></a><span class="lineno"> 6149</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewGroupSize;</div>
<div class="line"><a name="l06150"></a><span class="lineno"> 6150</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewSaclSize;</div>
<div class="line"><a name="l06151"></a><span class="lineno"> 6151</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewDaclSize;</div>
<div class="line"><a name="l06152"></a><span class="lineno"> 6152</span>&#160;</div>
<div class="line"><a name="l06153"></a><span class="lineno"> 6153</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Field;</div>
<div class="line"><a name="l06154"></a><span class="lineno"> 6154</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Base;</div>
<div class="line"><a name="l06155"></a><span class="lineno"> 6155</span>&#160;</div>
<div class="line"><a name="l06156"></a><span class="lineno"> 6156</span>&#160;    <a class="code" href="../../d6/d91/a01587.html">PISECURITY_DESCRIPTOR_RELATIVE</a> INewDescriptor = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l06157"></a><span class="lineno"> 6157</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ReturnLength;</div>
<div class="line"><a name="l06158"></a><span class="lineno"> 6158</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> PassedStatus;</div>
<div class="line"><a name="l06159"></a><span class="lineno"> 6159</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> PrimaryToken;</div>
<div class="line"><a name="l06160"></a><span class="lineno"> 6160</span>&#160;</div>
<div class="line"><a name="l06161"></a><span class="lineno"> 6161</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l06162"></a><span class="lineno"> 6162</span>&#160;</div>
<div class="line"><a name="l06163"></a><span class="lineno"> 6163</span>&#160;    CurrentDescriptor = CurrentSecurityDescriptor;</div>
<div class="line"><a name="l06164"></a><span class="lineno"> 6164</span>&#160;</div>
<div class="line"><a name="l06165"></a><span class="lineno"> 6165</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06166"></a><span class="lineno"> 6166</span>&#160;    <span class="comment">// Validate the incoming security descriptor.</span></div>
<div class="line"><a name="l06167"></a><span class="lineno"> 6167</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06168"></a><span class="lineno"> 6168</span>&#160;</div>
<div class="line"><a name="l06169"></a><span class="lineno"> 6169</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a476fa7a3fca096253cc03efda08e091d">RtlValidSecurityDescriptor</a> ( CurrentDescriptor )) {</div>
<div class="line"><a name="l06170"></a><span class="lineno"> 6170</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l06171"></a><span class="lineno"> 6171</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l06172"></a><span class="lineno"> 6172</span>&#160;    }</div>
<div class="line"><a name="l06173"></a><span class="lineno"> 6173</span>&#160;</div>
<div class="line"><a name="l06174"></a><span class="lineno"> 6174</span>&#160;</div>
<div class="line"><a name="l06175"></a><span class="lineno"> 6175</span>&#160;    NewOwner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>( CurrentDescriptor );</div>
<div class="line"><a name="l06176"></a><span class="lineno"> 6176</span>&#160;    <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06177"></a><span class="lineno"> 6177</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a>;</div>
<div class="line"><a name="l06178"></a><span class="lineno"> 6178</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l06179"></a><span class="lineno"> 6179</span>&#160;    }</div>
<div class="line"><a name="l06180"></a><span class="lineno"> 6180</span>&#160;</div>
<div class="line"><a name="l06181"></a><span class="lineno"> 6181</span>&#160;    NewGroup = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>( CurrentDescriptor );</div>
<div class="line"><a name="l06182"></a><span class="lineno"> 6182</span>&#160;</div>
<div class="line"><a name="l06183"></a><span class="lineno"> 6183</span>&#160;</div>
<div class="line"><a name="l06184"></a><span class="lineno"> 6184</span>&#160;</div>
<div class="line"><a name="l06185"></a><span class="lineno"> 6185</span>&#160;</div>
<div class="line"><a name="l06186"></a><span class="lineno"> 6186</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06187"></a><span class="lineno"> 6187</span>&#160;    <span class="comment">// Handle the SACL.</span></div>
<div class="line"><a name="l06188"></a><span class="lineno"> 6188</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06189"></a><span class="lineno"> 6189</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06190"></a><span class="lineno"> 6190</span>&#160;    <span class="comment">// If the SACL isn&#39;t present,</span></div>
<div class="line"><a name="l06191"></a><span class="lineno"> 6191</span>&#160;    <span class="comment">//  special case it.</span></div>
<div class="line"><a name="l06192"></a><span class="lineno"> 6192</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06193"></a><span class="lineno"> 6193</span>&#160;</div>
<div class="line"><a name="l06194"></a><span class="lineno"> 6194</span>&#160;    CurrentSacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( CurrentDescriptor );</div>
<div class="line"><a name="l06195"></a><span class="lineno"> 6195</span>&#160;</div>
<div class="line"><a name="l06196"></a><span class="lineno"> 6196</span>&#160;    <span class="keywordflow">if</span> ( CurrentSacl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06197"></a><span class="lineno"> 6197</span>&#160;        <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ParentSacl;</div>
<div class="line"><a name="l06198"></a><span class="lineno"> 6198</span>&#160;</div>
<div class="line"><a name="l06199"></a><span class="lineno"> 6199</span>&#160;        <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span></div>
<div class="line"><a name="l06200"></a><span class="lineno"> 6200</span>&#160;        NewSaclControl |= CurrentDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; (<a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a>|<a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>);</div>
<div class="line"><a name="l06201"></a><span class="lineno"> 6201</span>&#160;</div>
<div class="line"><a name="l06202"></a><span class="lineno"> 6202</span>&#160;        <span class="comment">// Always set the autoinherited bit.</span></div>
<div class="line"><a name="l06203"></a><span class="lineno"> 6203</span>&#160;        NewSaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l06204"></a><span class="lineno"> 6204</span>&#160;</div>
<div class="line"><a name="l06205"></a><span class="lineno"> 6205</span>&#160;</div>
<div class="line"><a name="l06206"></a><span class="lineno"> 6206</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06207"></a><span class="lineno"> 6207</span>&#160;        <span class="comment">// If the Parent also has a NULL SACL,</span></div>
<div class="line"><a name="l06208"></a><span class="lineno"> 6208</span>&#160;        <span class="comment">//  just consider this SACL as inherited.</span></div>
<div class="line"><a name="l06209"></a><span class="lineno"> 6209</span>&#160;        <span class="comment">//  otherwise, this SACL is protected.</span></div>
<div class="line"><a name="l06210"></a><span class="lineno"> 6210</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06211"></a><span class="lineno"> 6211</span>&#160;</div>
<div class="line"><a name="l06212"></a><span class="lineno"> 6212</span>&#160;        ParentSacl = <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ?</div>
<div class="line"><a name="l06213"></a><span class="lineno"> 6213</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor)) :</div>
<div class="line"><a name="l06214"></a><span class="lineno"> 6214</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l06215"></a><span class="lineno"> 6215</span>&#160;        <span class="keywordflow">if</span> ( ParentSacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l06216"></a><span class="lineno"> 6216</span>&#160;            NewSaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a>;</div>
<div class="line"><a name="l06217"></a><span class="lineno"> 6217</span>&#160;        }</div>
<div class="line"><a name="l06218"></a><span class="lineno"> 6218</span>&#160;</div>
<div class="line"><a name="l06219"></a><span class="lineno"> 6219</span>&#160;</div>
<div class="line"><a name="l06220"></a><span class="lineno"> 6220</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06221"></a><span class="lineno"> 6221</span>&#160;    <span class="comment">// If the SACL is already converted,</span></div>
<div class="line"><a name="l06222"></a><span class="lineno"> 6222</span>&#160;    <span class="comment">//  or if this object is at the root of the tree,</span></div>
<div class="line"><a name="l06223"></a><span class="lineno"> 6223</span>&#160;    <span class="comment">//  simply leave it alone.</span></div>
<div class="line"><a name="l06224"></a><span class="lineno"> 6224</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06225"></a><span class="lineno"> 6225</span>&#160;    <span class="comment">// Don&#39;t force the Protect bit on at the root of the tree since it is semantically</span></div>
<div class="line"><a name="l06226"></a><span class="lineno"> 6226</span>&#160;    <span class="comment">//  a no-op and gets in the way if the object is ever moved.</span></div>
<div class="line"><a name="l06227"></a><span class="lineno"> 6227</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06228"></a><span class="lineno"> 6228</span>&#160;</div>
<div class="line"><a name="l06229"></a><span class="lineno"> 6229</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CurrentDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>) ||</div>
<div class="line"><a name="l06230"></a><span class="lineno"> 6230</span>&#160;                <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CurrentDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a> ) ||</div>
<div class="line"><a name="l06231"></a><span class="lineno"> 6231</span>&#160;                !<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ) {</div>
<div class="line"><a name="l06232"></a><span class="lineno"> 6232</span>&#160;</div>
<div class="line"><a name="l06233"></a><span class="lineno"> 6233</span>&#160;        <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span></div>
<div class="line"><a name="l06234"></a><span class="lineno"> 6234</span>&#160;        NewSaclControl |= CurrentDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; (<a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a>|<a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>);</div>
<div class="line"><a name="l06235"></a><span class="lineno"> 6235</span>&#160;</div>
<div class="line"><a name="l06236"></a><span class="lineno"> 6236</span>&#160;        <span class="comment">// Always set the autoinherited bit.</span></div>
<div class="line"><a name="l06237"></a><span class="lineno"> 6237</span>&#160;        NewSaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l06238"></a><span class="lineno"> 6238</span>&#160;</div>
<div class="line"><a name="l06239"></a><span class="lineno"> 6239</span>&#160;        NewSacl = CurrentSacl;</div>
<div class="line"><a name="l06240"></a><span class="lineno"> 6240</span>&#160;</div>
<div class="line"><a name="l06241"></a><span class="lineno"> 6241</span>&#160;</div>
<div class="line"><a name="l06242"></a><span class="lineno"> 6242</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06243"></a><span class="lineno"> 6243</span>&#160;    <span class="comment">// If the SACL is present,</span></div>
<div class="line"><a name="l06244"></a><span class="lineno"> 6244</span>&#160;    <span class="comment">//  compute a new SACL with appropriate ACEs marked as inherited.</span></div>
<div class="line"><a name="l06245"></a><span class="lineno"> 6245</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06246"></a><span class="lineno"> 6246</span>&#160;</div>
<div class="line"><a name="l06247"></a><span class="lineno"> 6247</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06248"></a><span class="lineno"> 6248</span>&#160;</div>
<div class="line"><a name="l06249"></a><span class="lineno"> 6249</span>&#160;</div>
<div class="line"><a name="l06250"></a><span class="lineno"> 6250</span>&#160;        Status = <a class="code" href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833">RtlpConvertAclToAutoInherit</a> (</div>
<div class="line"><a name="l06251"></a><span class="lineno"> 6251</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ?</div>
<div class="line"><a name="l06252"></a><span class="lineno"> 6252</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(</div>
<div class="line"><a name="l06253"></a><span class="lineno"> 6253</span>&#160;                            ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor)) :</div>
<div class="line"><a name="l06254"></a><span class="lineno"> 6254</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l06255"></a><span class="lineno"> 6255</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06256"></a><span class="lineno"> 6256</span>&#160;                    ObjectType,</div>
<div class="line"><a name="l06257"></a><span class="lineno"> 6257</span>&#160;                    IsDirectoryObject,</div>
<div class="line"><a name="l06258"></a><span class="lineno"> 6258</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06259"></a><span class="lineno"> 6259</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06260"></a><span class="lineno"> 6260</span>&#160;                    GenericMapping,</div>
<div class="line"><a name="l06261"></a><span class="lineno"> 6261</span>&#160;                    &amp;NewSacl,</div>
<div class="line"><a name="l06262"></a><span class="lineno"> 6262</span>&#160;                    &amp;GenericControl );</div>
<div class="line"><a name="l06263"></a><span class="lineno"> 6263</span>&#160;</div>
<div class="line"><a name="l06264"></a><span class="lineno"> 6264</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l06265"></a><span class="lineno"> 6265</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l06266"></a><span class="lineno"> 6266</span>&#160;        }</div>
<div class="line"><a name="l06267"></a><span class="lineno"> 6267</span>&#160;</div>
<div class="line"><a name="l06268"></a><span class="lineno"> 6268</span>&#160;        NewSaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l06269"></a><span class="lineno"> 6269</span>&#160;        NewSaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a> | <a class="code" href="../../df/d4d/a02285.html#a2739a37915edd332226ecc507d08067d">SeControlGenericToSacl</a>( GenericControl );</div>
<div class="line"><a name="l06270"></a><span class="lineno"> 6270</span>&#160;    }</div>
<div class="line"><a name="l06271"></a><span class="lineno"> 6271</span>&#160;</div>
<div class="line"><a name="l06272"></a><span class="lineno"> 6272</span>&#160;</div>
<div class="line"><a name="l06273"></a><span class="lineno"> 6273</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06274"></a><span class="lineno"> 6274</span>&#160;    <span class="comment">// Handle the DACL.</span></div>
<div class="line"><a name="l06275"></a><span class="lineno"> 6275</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06276"></a><span class="lineno"> 6276</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06277"></a><span class="lineno"> 6277</span>&#160;    <span class="comment">// If the DACL isn&#39;t present,</span></div>
<div class="line"><a name="l06278"></a><span class="lineno"> 6278</span>&#160;    <span class="comment">//  special case it.</span></div>
<div class="line"><a name="l06279"></a><span class="lineno"> 6279</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06280"></a><span class="lineno"> 6280</span>&#160;</div>
<div class="line"><a name="l06281"></a><span class="lineno"> 6281</span>&#160;    CurrentDacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( CurrentDescriptor );</div>
<div class="line"><a name="l06282"></a><span class="lineno"> 6282</span>&#160;</div>
<div class="line"><a name="l06283"></a><span class="lineno"> 6283</span>&#160;    <span class="keywordflow">if</span> ( CurrentDacl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06284"></a><span class="lineno"> 6284</span>&#160;        <span class="comment">// Preserve the Dacl Present bit from the existing descriptor.</span></div>
<div class="line"><a name="l06285"></a><span class="lineno"> 6285</span>&#160;        NewDaclControl |= CurrentDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l06286"></a><span class="lineno"> 6286</span>&#160;</div>
<div class="line"><a name="l06287"></a><span class="lineno"> 6287</span>&#160;        <span class="comment">// Always set the autoinherited bit.</span></div>
<div class="line"><a name="l06288"></a><span class="lineno"> 6288</span>&#160;        <span class="comment">// Force it protected.</span></div>
<div class="line"><a name="l06289"></a><span class="lineno"> 6289</span>&#160;        NewDaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a> | <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a>;</div>
<div class="line"><a name="l06290"></a><span class="lineno"> 6290</span>&#160;</div>
<div class="line"><a name="l06291"></a><span class="lineno"> 6291</span>&#160;</div>
<div class="line"><a name="l06292"></a><span class="lineno"> 6292</span>&#160;</div>
<div class="line"><a name="l06293"></a><span class="lineno"> 6293</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06294"></a><span class="lineno"> 6294</span>&#160;    <span class="comment">// If the DACL is already converted,</span></div>
<div class="line"><a name="l06295"></a><span class="lineno"> 6295</span>&#160;    <span class="comment">//  or if this object is at the root of the tree,</span></div>
<div class="line"><a name="l06296"></a><span class="lineno"> 6296</span>&#160;    <span class="comment">//  simply leave it alone.</span></div>
<div class="line"><a name="l06297"></a><span class="lineno"> 6297</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06298"></a><span class="lineno"> 6298</span>&#160;    <span class="comment">// Don&#39;t force the Protect bit on at the root of the tree since it is semantically</span></div>
<div class="line"><a name="l06299"></a><span class="lineno"> 6299</span>&#160;    <span class="comment">//  a no-op and gets in the way if the object is ever moved.</span></div>
<div class="line"><a name="l06300"></a><span class="lineno"> 6300</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06301"></a><span class="lineno"> 6301</span>&#160;</div>
<div class="line"><a name="l06302"></a><span class="lineno"> 6302</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CurrentDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a>) ||</div>
<div class="line"><a name="l06303"></a><span class="lineno"> 6303</span>&#160;                <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CurrentDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a> ) ||</div>
<div class="line"><a name="l06304"></a><span class="lineno"> 6304</span>&#160;                !<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ) {</div>
<div class="line"><a name="l06305"></a><span class="lineno"> 6305</span>&#160;</div>
<div class="line"><a name="l06306"></a><span class="lineno"> 6306</span>&#160;        <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span></div>
<div class="line"><a name="l06307"></a><span class="lineno"> 6307</span>&#160;        NewDaclControl |= CurrentDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; (<a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a>|<a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>);</div>
<div class="line"><a name="l06308"></a><span class="lineno"> 6308</span>&#160;</div>
<div class="line"><a name="l06309"></a><span class="lineno"> 6309</span>&#160;        <span class="comment">// Always set the autoinherited bit.</span></div>
<div class="line"><a name="l06310"></a><span class="lineno"> 6310</span>&#160;        NewDaclControl |= <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l06311"></a><span class="lineno"> 6311</span>&#160;</div>
<div class="line"><a name="l06312"></a><span class="lineno"> 6312</span>&#160;        NewDacl = CurrentDacl;</div>
<div class="line"><a name="l06313"></a><span class="lineno"> 6313</span>&#160;</div>
<div class="line"><a name="l06314"></a><span class="lineno"> 6314</span>&#160;</div>
<div class="line"><a name="l06315"></a><span class="lineno"> 6315</span>&#160;</div>
<div class="line"><a name="l06316"></a><span class="lineno"> 6316</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06317"></a><span class="lineno"> 6317</span>&#160;    <span class="comment">// If the DACL is present,</span></div>
<div class="line"><a name="l06318"></a><span class="lineno"> 6318</span>&#160;    <span class="comment">//  compute a new DACL with appropriate ACEs marked as inherited.</span></div>
<div class="line"><a name="l06319"></a><span class="lineno"> 6319</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06320"></a><span class="lineno"> 6320</span>&#160;</div>
<div class="line"><a name="l06321"></a><span class="lineno"> 6321</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06322"></a><span class="lineno"> 6322</span>&#160;</div>
<div class="line"><a name="l06323"></a><span class="lineno"> 6323</span>&#160;</div>
<div class="line"><a name="l06324"></a><span class="lineno"> 6324</span>&#160;        Status = <a class="code" href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833">RtlpConvertAclToAutoInherit</a> (</div>
<div class="line"><a name="l06325"></a><span class="lineno"> 6325</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ?</div>
<div class="line"><a name="l06326"></a><span class="lineno"> 6326</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(</div>
<div class="line"><a name="l06327"></a><span class="lineno"> 6327</span>&#160;                            ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor)) :</div>
<div class="line"><a name="l06328"></a><span class="lineno"> 6328</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l06329"></a><span class="lineno"> 6329</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06330"></a><span class="lineno"> 6330</span>&#160;                    ObjectType,</div>
<div class="line"><a name="l06331"></a><span class="lineno"> 6331</span>&#160;                    IsDirectoryObject,</div>
<div class="line"><a name="l06332"></a><span class="lineno"> 6332</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06333"></a><span class="lineno"> 6333</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(CurrentDescriptor),</div>
<div class="line"><a name="l06334"></a><span class="lineno"> 6334</span>&#160;                    GenericMapping,</div>
<div class="line"><a name="l06335"></a><span class="lineno"> 6335</span>&#160;                    &amp;NewDacl,</div>
<div class="line"><a name="l06336"></a><span class="lineno"> 6336</span>&#160;                    &amp;GenericControl );</div>
<div class="line"><a name="l06337"></a><span class="lineno"> 6337</span>&#160;</div>
<div class="line"><a name="l06338"></a><span class="lineno"> 6338</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l06339"></a><span class="lineno"> 6339</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l06340"></a><span class="lineno"> 6340</span>&#160;        }</div>
<div class="line"><a name="l06341"></a><span class="lineno"> 6341</span>&#160;</div>
<div class="line"><a name="l06342"></a><span class="lineno"> 6342</span>&#160;        NewDaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l06343"></a><span class="lineno"> 6343</span>&#160;        NewDaclControl |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a> | <a class="code" href="../../df/d4d/a02285.html#aad434d64fabed59aebb1581338b289b2">SeControlGenericToDacl</a>( GenericControl );</div>
<div class="line"><a name="l06344"></a><span class="lineno"> 6344</span>&#160;    }</div>
<div class="line"><a name="l06345"></a><span class="lineno"> 6345</span>&#160;</div>
<div class="line"><a name="l06346"></a><span class="lineno"> 6346</span>&#160;</div>
<div class="line"><a name="l06347"></a><span class="lineno"> 6347</span>&#160;</div>
<div class="line"><a name="l06348"></a><span class="lineno"> 6348</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06349"></a><span class="lineno"> 6349</span>&#160;    <span class="comment">// Build the resultant security descriptor</span></div>
<div class="line"><a name="l06350"></a><span class="lineno"> 6350</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06351"></a><span class="lineno"> 6351</span>&#160;    <span class="comment">// Also map the ACEs for application to the target object</span></div>
<div class="line"><a name="l06352"></a><span class="lineno"> 6352</span>&#160;    <span class="comment">// type, if they haven&#39;t already been mapped.</span></div>
<div class="line"><a name="l06353"></a><span class="lineno"> 6353</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06354"></a><span class="lineno"> 6354</span>&#160;    NewOwnerSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewOwner));</div>
<div class="line"><a name="l06355"></a><span class="lineno"> 6355</span>&#160;</div>
<div class="line"><a name="l06356"></a><span class="lineno"> 6356</span>&#160;    <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06357"></a><span class="lineno"> 6357</span>&#160;        NewGroupSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewGroup));</div>
<div class="line"><a name="l06358"></a><span class="lineno"> 6358</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06359"></a><span class="lineno"> 6359</span>&#160;        NewGroupSize = 0;</div>
<div class="line"><a name="l06360"></a><span class="lineno"> 6360</span>&#160;    }</div>
<div class="line"><a name="l06361"></a><span class="lineno"> 6361</span>&#160;</div>
<div class="line"><a name="l06362"></a><span class="lineno"> 6362</span>&#160;    <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l06363"></a><span class="lineno"> 6363</span>&#160;        NewSaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l06364"></a><span class="lineno"> 6364</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06365"></a><span class="lineno"> 6365</span>&#160;        NewSaclSize = 0;</div>
<div class="line"><a name="l06366"></a><span class="lineno"> 6366</span>&#160;    }</div>
<div class="line"><a name="l06367"></a><span class="lineno"> 6367</span>&#160;</div>
<div class="line"><a name="l06368"></a><span class="lineno"> 6368</span>&#160;    <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l06369"></a><span class="lineno"> 6369</span>&#160;        NewDaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l06370"></a><span class="lineno"> 6370</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06371"></a><span class="lineno"> 6371</span>&#160;        NewDaclSize = 0;</div>
<div class="line"><a name="l06372"></a><span class="lineno"> 6372</span>&#160;    }</div>
<div class="line"><a name="l06373"></a><span class="lineno"> 6373</span>&#160;</div>
<div class="line"><a name="l06374"></a><span class="lineno"> 6374</span>&#160;    AllocationSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>)) +</div>
<div class="line"><a name="l06375"></a><span class="lineno"> 6375</span>&#160;                     NewOwnerSize +</div>
<div class="line"><a name="l06376"></a><span class="lineno"> 6376</span>&#160;                     NewGroupSize +</div>
<div class="line"><a name="l06377"></a><span class="lineno"> 6377</span>&#160;                     NewSaclSize  +</div>
<div class="line"><a name="l06378"></a><span class="lineno"> 6378</span>&#160;                     NewDaclSize;</div>
<div class="line"><a name="l06379"></a><span class="lineno"> 6379</span>&#160;</div>
<div class="line"><a name="l06380"></a><span class="lineno"> 6380</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06381"></a><span class="lineno"> 6381</span>&#160;    <span class="comment">// Allocate and initialize the security descriptor as</span></div>
<div class="line"><a name="l06382"></a><span class="lineno"> 6382</span>&#160;    <span class="comment">// self-relative form.</span></div>
<div class="line"><a name="l06383"></a><span class="lineno"> 6383</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06384"></a><span class="lineno"> 6384</span>&#160;</div>
<div class="line"><a name="l06385"></a><span class="lineno"> 6385</span>&#160;</div>
<div class="line"><a name="l06386"></a><span class="lineno"> 6386</span>&#160;    INewDescriptor = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l06387"></a><span class="lineno"> 6387</span>&#160;                        <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l06388"></a><span class="lineno"> 6388</span>&#160;                        AllocationSize,</div>
<div class="line"><a name="l06389"></a><span class="lineno"> 6389</span>&#160;                        <span class="stringliteral">&#39;dSeS&#39;</span> );</div>
<div class="line"><a name="l06390"></a><span class="lineno"> 6390</span>&#160;</div>
<div class="line"><a name="l06391"></a><span class="lineno"> 6391</span>&#160;    <span class="keywordflow">if</span> ( INewDescriptor == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06392"></a><span class="lineno"> 6392</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a>;</div>
<div class="line"><a name="l06393"></a><span class="lineno"> 6393</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l06394"></a><span class="lineno"> 6394</span>&#160;    }</div>
<div class="line"><a name="l06395"></a><span class="lineno"> 6395</span>&#160;</div>
<div class="line"><a name="l06396"></a><span class="lineno"> 6396</span>&#160;</div>
<div class="line"><a name="l06397"></a><span class="lineno"> 6397</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06398"></a><span class="lineno"> 6398</span>&#160;    <span class="comment">// Initialize the security descriptor as self-relative form.</span></div>
<div class="line"><a name="l06399"></a><span class="lineno"> 6399</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06400"></a><span class="lineno"> 6400</span>&#160;</div>
<div class="line"><a name="l06401"></a><span class="lineno"> 6401</span>&#160;    <a class="code" href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2">RtlCreateSecurityDescriptorRelative</a>(</div>
<div class="line"><a name="l06402"></a><span class="lineno"> 6402</span>&#160;        INewDescriptor,</div>
<div class="line"><a name="l06403"></a><span class="lineno"> 6403</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a></div>
<div class="line"><a name="l06404"></a><span class="lineno"> 6404</span>&#160;        );</div>
<div class="line"><a name="l06405"></a><span class="lineno"> 6405</span>&#160;</div>
<div class="line"><a name="l06406"></a><span class="lineno"> 6406</span>&#160;    <a class="code" href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a>( INewDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a> );</div>
<div class="line"><a name="l06407"></a><span class="lineno"> 6407</span>&#160;</div>
<div class="line"><a name="l06408"></a><span class="lineno"> 6408</span>&#160;    Base = (<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)(INewDescriptor);</div>
<div class="line"><a name="l06409"></a><span class="lineno"> 6409</span>&#160;    Field =  Base + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aecc9f2cb4b77c249451b1db76791af53">SECURITY_DESCRIPTOR_RELATIVE</a>);</div>
<div class="line"><a name="l06410"></a><span class="lineno"> 6410</span>&#160;</div>
<div class="line"><a name="l06411"></a><span class="lineno"> 6411</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06412"></a><span class="lineno"> 6412</span>&#160;    <span class="comment">// Copy the Sacl</span></div>
<div class="line"><a name="l06413"></a><span class="lineno"> 6413</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06414"></a><span class="lineno"> 6414</span>&#160;</div>
<div class="line"><a name="l06415"></a><span class="lineno"> 6415</span>&#160;    <a class="code" href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a>( INewDescriptor, NewSaclControl );</div>
<div class="line"><a name="l06416"></a><span class="lineno"> 6416</span>&#160;    <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06417"></a><span class="lineno"> 6417</span>&#160;</div>
<div class="line"><a name="l06418"></a><span class="lineno"> 6418</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewSacl, NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l06419"></a><span class="lineno"> 6419</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l06420"></a><span class="lineno"> 6420</span>&#160;        Field += NewSaclSize;</div>
<div class="line"><a name="l06421"></a><span class="lineno"> 6421</span>&#160;</div>
<div class="line"><a name="l06422"></a><span class="lineno"> 6422</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06423"></a><span class="lineno"> 6423</span>&#160;</div>
<div class="line"><a name="l06424"></a><span class="lineno"> 6424</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = 0;</div>
<div class="line"><a name="l06425"></a><span class="lineno"> 6425</span>&#160;    }</div>
<div class="line"><a name="l06426"></a><span class="lineno"> 6426</span>&#160;</div>
<div class="line"><a name="l06427"></a><span class="lineno"> 6427</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06428"></a><span class="lineno"> 6428</span>&#160;    <span class="comment">// Copy the Dacl</span></div>
<div class="line"><a name="l06429"></a><span class="lineno"> 6429</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06430"></a><span class="lineno"> 6430</span>&#160;</div>
<div class="line"><a name="l06431"></a><span class="lineno"> 6431</span>&#160;    <a class="code" href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a>( INewDescriptor, NewDaclControl );</div>
<div class="line"><a name="l06432"></a><span class="lineno"> 6432</span>&#160;    <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06433"></a><span class="lineno"> 6433</span>&#160;</div>
<div class="line"><a name="l06434"></a><span class="lineno"> 6434</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewDacl, NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l06435"></a><span class="lineno"> 6435</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l06436"></a><span class="lineno"> 6436</span>&#160;        Field += NewDaclSize;</div>
<div class="line"><a name="l06437"></a><span class="lineno"> 6437</span>&#160;</div>
<div class="line"><a name="l06438"></a><span class="lineno"> 6438</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06439"></a><span class="lineno"> 6439</span>&#160;</div>
<div class="line"><a name="l06440"></a><span class="lineno"> 6440</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = 0;</div>
<div class="line"><a name="l06441"></a><span class="lineno"> 6441</span>&#160;    }</div>
<div class="line"><a name="l06442"></a><span class="lineno"> 6442</span>&#160;</div>
<div class="line"><a name="l06443"></a><span class="lineno"> 6443</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06444"></a><span class="lineno"> 6444</span>&#160;    <span class="comment">// Assign the owner</span></div>
<div class="line"><a name="l06445"></a><span class="lineno"> 6445</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06446"></a><span class="lineno"> 6446</span>&#160;</div>
<div class="line"><a name="l06447"></a><span class="lineno"> 6447</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewOwner, <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewOwner) );</div>
<div class="line"><a name="l06448"></a><span class="lineno"> 6448</span>&#160;    INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l06449"></a><span class="lineno"> 6449</span>&#160;    Field += NewOwnerSize;</div>
<div class="line"><a name="l06450"></a><span class="lineno"> 6450</span>&#160;</div>
<div class="line"><a name="l06451"></a><span class="lineno"> 6451</span>&#160;    <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06452"></a><span class="lineno"> 6452</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewGroup, <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewGroup) );</div>
<div class="line"><a name="l06453"></a><span class="lineno"> 6453</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l06454"></a><span class="lineno"> 6454</span>&#160;    }</div>
<div class="line"><a name="l06455"></a><span class="lineno"> 6455</span>&#160;</div>
<div class="line"><a name="l06456"></a><span class="lineno"> 6456</span>&#160;    Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l06457"></a><span class="lineno"> 6457</span>&#160;</div>
<div class="line"><a name="l06458"></a><span class="lineno"> 6458</span>&#160;</div>
<div class="line"><a name="l06459"></a><span class="lineno"> 6459</span>&#160;</div>
<div class="line"><a name="l06460"></a><span class="lineno"> 6460</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06461"></a><span class="lineno"> 6461</span>&#160;    <span class="comment">// Cleanup any locally used resources.</span></div>
<div class="line"><a name="l06462"></a><span class="lineno"> 6462</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06463"></a><span class="lineno"> 6463</span>&#160;Cleanup:</div>
<div class="line"><a name="l06464"></a><span class="lineno"> 6464</span>&#160;    <span class="keywordflow">if</span> (NewDaclAllocated) {</div>
<div class="line"><a name="l06465"></a><span class="lineno"> 6465</span>&#160;            <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewDacl );</div>
<div class="line"><a name="l06466"></a><span class="lineno"> 6466</span>&#160;    }</div>
<div class="line"><a name="l06467"></a><span class="lineno"> 6467</span>&#160;    <span class="keywordflow">if</span> (NewSaclAllocated) {</div>
<div class="line"><a name="l06468"></a><span class="lineno"> 6468</span>&#160;            <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewSacl );</div>
<div class="line"><a name="l06469"></a><span class="lineno"> 6469</span>&#160;    }</div>
<div class="line"><a name="l06470"></a><span class="lineno"> 6470</span>&#160;</div>
<div class="line"><a name="l06471"></a><span class="lineno"> 6471</span>&#160;    *NewSecurityDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a>) INewDescriptor;</div>
<div class="line"><a name="l06472"></a><span class="lineno"> 6472</span>&#160;</div>
<div class="line"><a name="l06473"></a><span class="lineno"> 6473</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l06474"></a><span class="lineno"> 6474</span>&#160;</div>
<div class="line"><a name="l06475"></a><span class="lineno"> 6475</span>&#160;</div>
<div class="line"><a name="l06476"></a><span class="lineno"> 6476</span>&#160;}</div>
<div class="line"><a name="l06477"></a><span class="lineno"> 6477</span>&#160;</div>
<div class="line"><a name="l06478"></a><span class="lineno"> 6478</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l06479"></a><span class="lineno"> 6479</span>&#160;<span class="comment">// Local macro to classify the ACE flags in an ACE.</span></div>
<div class="line"><a name="l06480"></a><span class="lineno"> 6480</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l06481"></a><span class="lineno"> 6481</span>&#160;<span class="comment">// Returns one or more of the following ACE flags:</span></div>
<div class="line"><a name="l06482"></a><span class="lineno"> 6482</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l06483"></a><span class="lineno"> 6483</span>&#160;<span class="comment">//  CONTAINER_INHERIT_ACE - ACE is inherited to child containers</span></div>
<div class="line"><a name="l06484"></a><span class="lineno"> 6484</span>&#160;<span class="comment">//  OBJECT_INHERIT_ACE - ACE is inherited to child leaf objects</span></div>
<div class="line"><a name="l06485"></a><span class="lineno"> 6485</span>&#160;<span class="comment">//  EFFECTIVE_ACE - ACE is used during access validation</span></div>
<div class="line"><a name="l06486"></a><span class="lineno"> 6486</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l06487"></a><span class="lineno"> 6487</span>&#160;</div>
<div class="line"><a name="l06488"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#abeaaec74904663e61799079a1cf40f39"> 6488</a></span>&#160;<span class="preprocessor">#define MAX_CHILD_SID_GROUP_SIZE 3 // Number of bits in above list</span></div>
<div class="line"><a name="l06489"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95"> 6489</a></span>&#160;<span class="preprocessor">#define EFFECTIVE_ACE INHERIT_ONLY_ACE</span></div>
<div class="line"><a name="l06490"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb"> 6490</a></span>&#160;<span class="preprocessor">#define AceFlagsInAce( _Ace) \</span></div>
<div class="line"><a name="l06491"></a><span class="lineno"> 6491</span>&#160;<span class="preprocessor">            (((PACE_HEADER)(_Ace))-&gt;AceFlags &amp; (OBJECT_INHERIT_ACE|CONTAINER_INHERIT_ACE) | \</span></div>
<div class="line"><a name="l06492"></a><span class="lineno"> 6492</span>&#160;<span class="preprocessor">             (((PACE_HEADER)(_Ace))-&gt;AceFlags &amp; INHERIT_ONLY_ACE) ^ INHERIT_ONLY_ACE )</span></div>
<div class="line"><a name="l06493"></a><span class="lineno"> 6493</span>&#160;</div>
<div class="line"><a name="l06494"></a><span class="lineno"> 6494</span>&#160;</div>
<div class="line"><a name="l06495"></a><span class="lineno"> 6495</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l06496"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed"> 6496</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed">RtlpCompareAces</a>(</div>
<div class="line"><a name="l06497"></a><span class="lineno"> 6497</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> InheritedAce,</div>
<div class="line"><a name="l06498"></a><span class="lineno"> 6498</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> ChildAce,</div>
<div class="line"><a name="l06499"></a><span class="lineno"> 6499</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l06500"></a><span class="lineno"> 6500</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid</div>
<div class="line"><a name="l06501"></a><span class="lineno"> 6501</span>&#160;    )</div>
<div class="line"><a name="l06502"></a><span class="lineno"> 6502</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l06503"></a><span class="lineno"> 6503</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06504"></a><span class="lineno"> 6504</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l06505"></a><span class="lineno"> 6505</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06506"></a><span class="lineno"> 6506</span>&#160;<span class="comment">    Compare two aces to see if they are &quot;substantially&quot; the same.</span></div>
<div class="line"><a name="l06507"></a><span class="lineno"> 6507</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06508"></a><span class="lineno"> 6508</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l06509"></a><span class="lineno"> 6509</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06510"></a><span class="lineno"> 6510</span>&#160;<span class="comment">    InheritedAce - Computed ACE as inherited from DirectoryAcl.</span></div>
<div class="line"><a name="l06511"></a><span class="lineno"> 6511</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06512"></a><span class="lineno"> 6512</span>&#160;<span class="comment">    ChildAce - The current acl on the object.  This ACL must be a revision 2 ACL.</span></div>
<div class="line"><a name="l06513"></a><span class="lineno"> 6513</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06514"></a><span class="lineno"> 6514</span>&#160;<span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span></div>
<div class="line"><a name="l06515"></a><span class="lineno"> 6515</span>&#160;<span class="comment">        created has no GUID associated with it, then this argument is</span></div>
<div class="line"><a name="l06516"></a><span class="lineno"> 6516</span>&#160;<span class="comment">        specified as NULL.</span></div>
<div class="line"><a name="l06517"></a><span class="lineno"> 6517</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06518"></a><span class="lineno"> 6518</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l06519"></a><span class="lineno"> 6519</span>&#160;<span class="comment">        If not specified, the owner sid is not treated as special.</span></div>
<div class="line"><a name="l06520"></a><span class="lineno"> 6520</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06521"></a><span class="lineno"> 6521</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l06522"></a><span class="lineno"> 6522</span>&#160;<span class="comment">        If not specified, the group sid is not treated as special.</span></div>
<div class="line"><a name="l06523"></a><span class="lineno"> 6523</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06524"></a><span class="lineno"> 6524</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l06525"></a><span class="lineno"> 6525</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06526"></a><span class="lineno"> 6526</span>&#160;<span class="comment">    TRUE - The ACEs are substantially the same.</span></div>
<div class="line"><a name="l06527"></a><span class="lineno"> 6527</span>&#160;<span class="comment">    FALSE - The ACEs are not substantially the same.</span></div>
<div class="line"><a name="l06528"></a><span class="lineno"> 6528</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06529"></a><span class="lineno"> 6529</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l06530"></a><span class="lineno"> 6530</span>&#160;{</div>
<div class="line"><a name="l06531"></a><span class="lineno"> 6531</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AcesCompare = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06532"></a><span class="lineno"> 6532</span>&#160;</div>
<div class="line"><a name="l06533"></a><span class="lineno"> 6533</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(InheritedAce) &amp;&amp; <a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(ChildAce)) {</div>
<div class="line"><a name="l06534"></a><span class="lineno"> 6534</span>&#160;</div>
<div class="line"><a name="l06535"></a><span class="lineno"> 6535</span>&#160;        AcesCompare = <a class="code" href="../../d3/d32/a02665.html#a98fa21d2d8124ffe917105ea7cd6338b">RtlpCompareKnownObjectAces</a>( (<a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a>)InheritedAce,</div>
<div class="line"><a name="l06536"></a><span class="lineno"> 6536</span>&#160;                                                  (<a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a>)ChildAce,</div>
<div class="line"><a name="l06537"></a><span class="lineno"> 6537</span>&#160;                                                  OwnerSid,</div>
<div class="line"><a name="l06538"></a><span class="lineno"> 6538</span>&#160;                                                  GroupSid</div>
<div class="line"><a name="l06539"></a><span class="lineno"> 6539</span>&#160;                                                  );</div>
<div class="line"><a name="l06540"></a><span class="lineno"> 6540</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06541"></a><span class="lineno"> 6541</span>&#160;</div>
<div class="line"><a name="l06542"></a><span class="lineno"> 6542</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(InheritedAce) &amp;&amp; !<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(ChildAce)) {</div>
<div class="line"><a name="l06543"></a><span class="lineno"> 6543</span>&#160;</div>
<div class="line"><a name="l06544"></a><span class="lineno"> 6544</span>&#160;            AcesCompare = <a class="code" href="../../d3/d32/a02665.html#a33f46ef50693a7e87038c3bdb4990aaa">RtlpCompareKnownAces</a>( InheritedAce,</div>
<div class="line"><a name="l06545"></a><span class="lineno"> 6545</span>&#160;                                                ChildAce,</div>
<div class="line"><a name="l06546"></a><span class="lineno"> 6546</span>&#160;                                                OwnerSid,</div>
<div class="line"><a name="l06547"></a><span class="lineno"> 6547</span>&#160;                                                GroupSid</div>
<div class="line"><a name="l06548"></a><span class="lineno"> 6548</span>&#160;                                                );</div>
<div class="line"><a name="l06549"></a><span class="lineno"> 6549</span>&#160;        }</div>
<div class="line"><a name="l06550"></a><span class="lineno"> 6550</span>&#160;    }</div>
<div class="line"><a name="l06551"></a><span class="lineno"> 6551</span>&#160;</div>
<div class="line"><a name="l06552"></a><span class="lineno"> 6552</span>&#160;    <span class="keywordflow">return</span>( AcesCompare );</div>
<div class="line"><a name="l06553"></a><span class="lineno"> 6553</span>&#160;}</div>
<div class="line"><a name="l06554"></a><span class="lineno"> 6554</span>&#160;</div>
<div class="line"><a name="l06555"></a><span class="lineno"> 6555</span>&#160;</div>
<div class="line"><a name="l06556"></a><span class="lineno"> 6556</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l06557"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a33f46ef50693a7e87038c3bdb4990aaa"> 6557</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a33f46ef50693a7e87038c3bdb4990aaa">RtlpCompareKnownAces</a>(</div>
<div class="line"><a name="l06558"></a><span class="lineno"> 6558</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> InheritedAce,</div>
<div class="line"><a name="l06559"></a><span class="lineno"> 6559</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> ChildAce,</div>
<div class="line"><a name="l06560"></a><span class="lineno"> 6560</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l06561"></a><span class="lineno"> 6561</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid OPTIONAL</div>
<div class="line"><a name="l06562"></a><span class="lineno"> 6562</span>&#160;    )</div>
<div class="line"><a name="l06563"></a><span class="lineno"> 6563</span>&#160;</div>
<div class="line"><a name="l06564"></a><span class="lineno"> 6564</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l06565"></a><span class="lineno"> 6565</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06566"></a><span class="lineno"> 6566</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l06567"></a><span class="lineno"> 6567</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06568"></a><span class="lineno"> 6568</span>&#160;<span class="comment">    Compare two aces to see if they are &quot;substantially&quot; the same.</span></div>
<div class="line"><a name="l06569"></a><span class="lineno"> 6569</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06570"></a><span class="lineno"> 6570</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l06571"></a><span class="lineno"> 6571</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06572"></a><span class="lineno"> 6572</span>&#160;<span class="comment">    InheritedAce - Computed ACE as inherited from DirectoryAcl.</span></div>
<div class="line"><a name="l06573"></a><span class="lineno"> 6573</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06574"></a><span class="lineno"> 6574</span>&#160;<span class="comment">    ChildAce - The current acl on the object.  This ACL must be a revision 2 ACL.</span></div>
<div class="line"><a name="l06575"></a><span class="lineno"> 6575</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06576"></a><span class="lineno"> 6576</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l06577"></a><span class="lineno"> 6577</span>&#160;<span class="comment">        If not specified, the owner sid is not treated as special.</span></div>
<div class="line"><a name="l06578"></a><span class="lineno"> 6578</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06579"></a><span class="lineno"> 6579</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l06580"></a><span class="lineno"> 6580</span>&#160;<span class="comment">        If not specified, the group sid is not treated as special.</span></div>
<div class="line"><a name="l06581"></a><span class="lineno"> 6581</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06582"></a><span class="lineno"> 6582</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l06583"></a><span class="lineno"> 6583</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06584"></a><span class="lineno"> 6584</span>&#160;<span class="comment">    TRUE - The ACEs are substantially the same.</span></div>
<div class="line"><a name="l06585"></a><span class="lineno"> 6585</span>&#160;<span class="comment">    FALSE - The ACEs are not substantially the same.</span></div>
<div class="line"><a name="l06586"></a><span class="lineno"> 6586</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06587"></a><span class="lineno"> 6587</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l06588"></a><span class="lineno"> 6588</span>&#160;</div>
<div class="line"><a name="l06589"></a><span class="lineno"> 6589</span>&#160;{</div>
<div class="line"><a name="l06590"></a><span class="lineno"> 6590</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l06591"></a><span class="lineno"> 6591</span>&#160;    <a class="code" href="../../df/d86/a00012.html">ACE_HEADER</a> <span class="keyword">volatile</span> *InheritedAceHdr = &amp;InheritedAce-&gt;Header;</div>
<div class="line"><a name="l06592"></a><span class="lineno"> 6592</span>&#160;</div>
<div class="line"><a name="l06593"></a><span class="lineno"> 6593</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l06594"></a><span class="lineno"> 6594</span>&#160;</div>
<div class="line"><a name="l06595"></a><span class="lineno"> 6595</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(!<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(InheritedAce));</div>
<div class="line"><a name="l06596"></a><span class="lineno"> 6596</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(!<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(ChildAce));</div>
<div class="line"><a name="l06597"></a><span class="lineno"> 6597</span>&#160;</div>
<div class="line"><a name="l06598"></a><span class="lineno"> 6598</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06599"></a><span class="lineno"> 6599</span>&#160;    <span class="comment">// If the Ace types are different,</span></div>
<div class="line"><a name="l06600"></a><span class="lineno"> 6600</span>&#160;    <span class="comment">//  we don&#39;t match.</span></div>
<div class="line"><a name="l06601"></a><span class="lineno"> 6601</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06602"></a><span class="lineno"> 6602</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] != <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[InheritedAceHdr-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] ) {</div>
<div class="line"><a name="l06603"></a><span class="lineno"> 6603</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06604"></a><span class="lineno"> 6604</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06605"></a><span class="lineno"> 6605</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;AceType mismatch&quot;</span>));</div>
<div class="line"><a name="l06606"></a><span class="lineno"> 6606</span>&#160;        }</div>
<div class="line"><a name="l06607"></a><span class="lineno"> 6607</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06608"></a><span class="lineno"> 6608</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06609"></a><span class="lineno"> 6609</span>&#160;    }</div>
<div class="line"><a name="l06610"></a><span class="lineno"> 6610</span>&#160;</div>
<div class="line"><a name="l06611"></a><span class="lineno"> 6611</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06612"></a><span class="lineno"> 6612</span>&#160;    <span class="comment">// If this is a system ACE,</span></div>
<div class="line"><a name="l06613"></a><span class="lineno"> 6613</span>&#160;    <span class="comment">//  ensure the SUCCESS/FAILURE flags match.</span></div>
<div class="line"><a name="l06614"></a><span class="lineno"> 6614</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06615"></a><span class="lineno"> 6615</span>&#160;</div>
<div class="line"><a name="l06616"></a><span class="lineno"> 6616</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab5f13e236f1a3bb478abc2db92920779">RtlIsSystemAceType</a>[ChildAce-&gt;Header.AceType] ) {</div>
<div class="line"><a name="l06617"></a><span class="lineno"> 6617</span>&#160;        <span class="keywordflow">if</span> ( (ChildAce-&gt;Header.AceFlags &amp; (<a class="code" href="../../d3/d3a/a02259.html#af432365a7f8156f8c092870edea1329b">SUCCESSFUL_ACCESS_ACE_FLAG</a>|<a class="code" href="../../d3/d3a/a02259.html#aed93f572f76288c4e5238b805f0f1c24">FAILED_ACCESS_ACE_FLAG</a>)) !=</div>
<div class="line"><a name="l06618"></a><span class="lineno"> 6618</span>&#160;             (InheritedAceHdr-&gt;<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; (<a class="code" href="../../d3/d3a/a02259.html#af432365a7f8156f8c092870edea1329b">SUCCESSFUL_ACCESS_ACE_FLAG</a>|<a class="code" href="../../d3/d3a/a02259.html#aed93f572f76288c4e5238b805f0f1c24">FAILED_ACCESS_ACE_FLAG</a>)) ) {</div>
<div class="line"><a name="l06619"></a><span class="lineno"> 6619</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06620"></a><span class="lineno"> 6620</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06621"></a><span class="lineno"> 6621</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;System ace success/fail mismatch&quot;</span>));</div>
<div class="line"><a name="l06622"></a><span class="lineno"> 6622</span>&#160;            }</div>
<div class="line"><a name="l06623"></a><span class="lineno"> 6623</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06624"></a><span class="lineno"> 6624</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06625"></a><span class="lineno"> 6625</span>&#160;        }</div>
<div class="line"><a name="l06626"></a><span class="lineno"> 6626</span>&#160;    }</div>
<div class="line"><a name="l06627"></a><span class="lineno"> 6627</span>&#160;</div>
<div class="line"><a name="l06628"></a><span class="lineno"> 6628</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06629"></a><span class="lineno"> 6629</span>&#160;    <span class="comment">// If the SID of the inherited ACE doesn&#39;t match,</span></div>
<div class="line"><a name="l06630"></a><span class="lineno"> 6630</span>&#160;    <span class="comment">//  we don&#39;t match.</span></div>
<div class="line"><a name="l06631"></a><span class="lineno"> 6631</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06632"></a><span class="lineno"> 6632</span>&#160;</div>
<div class="line"><a name="l06633"></a><span class="lineno"> 6633</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;ChildAce-&gt;SidStart, (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;InheritedAce-&gt;SidStart )) {</div>
<div class="line"><a name="l06634"></a><span class="lineno"> 6634</span>&#160;</div>
<div class="line"><a name="l06635"></a><span class="lineno"> 6635</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06636"></a><span class="lineno"> 6636</span>&#160;        <span class="comment">// The inheritance algorithm only does SID mapping when building the effective</span></div>
<div class="line"><a name="l06637"></a><span class="lineno"> 6637</span>&#160;        <span class="comment">//  ace.  So, we only check for a mapped SID if the child ACE is an effective ACE.</span></div>
<div class="line"><a name="l06638"></a><span class="lineno"> 6638</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06639"></a><span class="lineno"> 6639</span>&#160;</div>
<div class="line"><a name="l06640"></a><span class="lineno"> 6640</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb">AceFlagsInAce</a>(ChildAce) != <a class="code" href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95">EFFECTIVE_ACE</a> ) {</div>
<div class="line"><a name="l06641"></a><span class="lineno"> 6641</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06642"></a><span class="lineno"> 6642</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06643"></a><span class="lineno"> 6643</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06644"></a><span class="lineno"> 6644</span>&#160;            }</div>
<div class="line"><a name="l06645"></a><span class="lineno"> 6645</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06646"></a><span class="lineno"> 6646</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06647"></a><span class="lineno"> 6647</span>&#160;        }</div>
<div class="line"><a name="l06648"></a><span class="lineno"> 6648</span>&#160;</div>
<div class="line"><a name="l06649"></a><span class="lineno"> 6649</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06650"></a><span class="lineno"> 6650</span>&#160;        <span class="comment">// In the case of CreatorOwner and CreatorGroup, the SIDs don&#39;t have to</span></div>
<div class="line"><a name="l06651"></a><span class="lineno"> 6651</span>&#160;        <span class="comment">//  exactly match.  When the InheritedAce was generated, care was taken</span></div>
<div class="line"><a name="l06652"></a><span class="lineno"> 6652</span>&#160;        <span class="comment">//  to NOT map these sids.  The SID may (or may not) have been mapped in</span></div>
<div class="line"><a name="l06653"></a><span class="lineno"> 6653</span>&#160;        <span class="comment">//  the ChildAce.  We want to compare equal in both cases.</span></div>
<div class="line"><a name="l06654"></a><span class="lineno"> 6654</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06655"></a><span class="lineno"> 6655</span>&#160;        <span class="comment">// If the InheritedAce contains a CreatorOwner/Group SID,</span></div>
<div class="line"><a name="l06656"></a><span class="lineno"> 6656</span>&#160;        <span class="comment">//  do the another comparison of the SID in the child ACE with the</span></div>
<div class="line"><a name="l06657"></a><span class="lineno"> 6657</span>&#160;        <span class="comment">//  real owner/group from the child security descriptor.</span></div>
<div class="line"><a name="l06658"></a><span class="lineno"> 6658</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06659"></a><span class="lineno"> 6659</span>&#160;</div>
<div class="line"><a name="l06660"></a><span class="lineno"> 6660</span>&#160;        <span class="keywordflow">if</span> ( OwnerSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || GroupSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06661"></a><span class="lineno"> 6661</span>&#160;            <a class="code" href="../../dd/d90/a01626.html">SID_IDENTIFIER_AUTHORITY</a>  CreatorSidAuthority = <a class="code" href="../../d3/d3a/a02259.html#ae3bf1a31d65e4d15c09a8cd24dc0c0c2">SECURITY_CREATOR_SID_AUTHORITY</a>;</div>
<div class="line"><a name="l06662"></a><span class="lineno"> 6662</span>&#160;            <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreatorSid[<a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>];</div>
<div class="line"><a name="l06663"></a><span class="lineno"> 6663</span>&#160;</div>
<div class="line"><a name="l06664"></a><span class="lineno"> 6664</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06665"></a><span class="lineno"> 6665</span>&#160;            <span class="comment">// Allocate and initialize the universal SIDs we&#39;re going to need</span></div>
<div class="line"><a name="l06666"></a><span class="lineno"> 6666</span>&#160;            <span class="comment">// to look for inheritable ACEs.</span></div>
<div class="line"><a name="l06667"></a><span class="lineno"> 6667</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06668"></a><span class="lineno"> 6668</span>&#160;</div>
<div class="line"><a name="l06669"></a><span class="lineno"> 6669</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a>( 1 ) == <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>);</div>
<div class="line"><a name="l06670"></a><span class="lineno"> 6670</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, &amp;CreatorSidAuthority, 1 );</div>
<div class="line"><a name="l06671"></a><span class="lineno"> 6671</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l06672"></a><span class="lineno"> 6672</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06673"></a><span class="lineno"> 6673</span>&#160;            }</div>
<div class="line"><a name="l06674"></a><span class="lineno"> 6674</span>&#160;</div>
<div class="line"><a name="l06675"></a><span class="lineno"> 6675</span>&#160;            *(<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, 0 )) = <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>;</div>
<div class="line"><a name="l06676"></a><span class="lineno"> 6676</span>&#160;</div>
<div class="line"><a name="l06677"></a><span class="lineno"> 6677</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a> ( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;InheritedAce-&gt;SidStart, CreatorSid )) {</div>
<div class="line"><a name="l06678"></a><span class="lineno"> 6678</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Rid;</div>
<div class="line"><a name="l06679"></a><span class="lineno"> 6679</span>&#160;</div>
<div class="line"><a name="l06680"></a><span class="lineno"> 6680</span>&#160;                Rid = *<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;InheritedAce-&gt;SidStart, 0 );</div>
<div class="line"><a name="l06681"></a><span class="lineno"> 6681</span>&#160;                <span class="keywordflow">switch</span> (Rid) {</div>
<div class="line"><a name="l06682"></a><span class="lineno"> 6682</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>:</div>
<div class="line"><a name="l06683"></a><span class="lineno"> 6683</span>&#160;                    <span class="keywordflow">if</span> ( OwnerSid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06684"></a><span class="lineno"> 6684</span>&#160;                         !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;ChildAce-&gt;SidStart, OwnerSid )) {</div>
<div class="line"><a name="l06685"></a><span class="lineno"> 6685</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06686"></a><span class="lineno"> 6686</span>&#160;                        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06687"></a><span class="lineno"> 6687</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator Owner)&quot;</span>));</div>
<div class="line"><a name="l06688"></a><span class="lineno"> 6688</span>&#160;                        }</div>
<div class="line"><a name="l06689"></a><span class="lineno"> 6689</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06690"></a><span class="lineno"> 6690</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06691"></a><span class="lineno"> 6691</span>&#160;                    }</div>
<div class="line"><a name="l06692"></a><span class="lineno"> 6692</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06693"></a><span class="lineno"> 6693</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a>:</div>
<div class="line"><a name="l06694"></a><span class="lineno"> 6694</span>&#160;                    <span class="keywordflow">if</span> ( GroupSid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06695"></a><span class="lineno"> 6695</span>&#160;                         !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)&amp;ChildAce-&gt;SidStart, GroupSid )) {</div>
<div class="line"><a name="l06696"></a><span class="lineno"> 6696</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06697"></a><span class="lineno"> 6697</span>&#160;                        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06698"></a><span class="lineno"> 6698</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator Group)&quot;</span>));</div>
<div class="line"><a name="l06699"></a><span class="lineno"> 6699</span>&#160;                        }</div>
<div class="line"><a name="l06700"></a><span class="lineno"> 6700</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06701"></a><span class="lineno"> 6701</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06702"></a><span class="lineno"> 6702</span>&#160;                    }</div>
<div class="line"><a name="l06703"></a><span class="lineno"> 6703</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06704"></a><span class="lineno"> 6704</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l06705"></a><span class="lineno"> 6705</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06706"></a><span class="lineno"> 6706</span>&#160;                    <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06707"></a><span class="lineno"> 6707</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator)&quot;</span>));</div>
<div class="line"><a name="l06708"></a><span class="lineno"> 6708</span>&#160;                    }</div>
<div class="line"><a name="l06709"></a><span class="lineno"> 6709</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06710"></a><span class="lineno"> 6710</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06711"></a><span class="lineno"> 6711</span>&#160;                }</div>
<div class="line"><a name="l06712"></a><span class="lineno"> 6712</span>&#160;</div>
<div class="line"><a name="l06713"></a><span class="lineno"> 6713</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06714"></a><span class="lineno"> 6714</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06715"></a><span class="lineno"> 6715</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06716"></a><span class="lineno"> 6716</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06717"></a><span class="lineno"> 6717</span>&#160;                }</div>
<div class="line"><a name="l06718"></a><span class="lineno"> 6718</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06719"></a><span class="lineno"> 6719</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06720"></a><span class="lineno"> 6720</span>&#160;            }</div>
<div class="line"><a name="l06721"></a><span class="lineno"> 6721</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06722"></a><span class="lineno"> 6722</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06723"></a><span class="lineno"> 6723</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06724"></a><span class="lineno"> 6724</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06725"></a><span class="lineno"> 6725</span>&#160;            }</div>
<div class="line"><a name="l06726"></a><span class="lineno"> 6726</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06727"></a><span class="lineno"> 6727</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06728"></a><span class="lineno"> 6728</span>&#160;        }</div>
<div class="line"><a name="l06729"></a><span class="lineno"> 6729</span>&#160;    }</div>
<div class="line"><a name="l06730"></a><span class="lineno"> 6730</span>&#160;</div>
<div class="line"><a name="l06731"></a><span class="lineno"> 6731</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l06732"></a><span class="lineno"> 6732</span>&#160;</div>
<div class="line"><a name="l06733"></a><span class="lineno"> 6733</span>&#160;}</div>
<div class="line"><a name="l06734"></a><span class="lineno"> 6734</span>&#160;</div>
<div class="line"><a name="l06735"></a><span class="lineno"> 6735</span>&#160;</div>
<div class="line"><a name="l06736"></a><span class="lineno"> 6736</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l06737"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a98fa21d2d8124ffe917105ea7cd6338b"> 6737</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a98fa21d2d8124ffe917105ea7cd6338b">RtlpCompareKnownObjectAces</a>(</div>
<div class="line"><a name="l06738"></a><span class="lineno"> 6738</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a> InheritedAce,</div>
<div class="line"><a name="l06739"></a><span class="lineno"> 6739</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d4/d45/a00791.html">PKNOWN_OBJECT_ACE</a> ChildAce,</div>
<div class="line"><a name="l06740"></a><span class="lineno"> 6740</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l06741"></a><span class="lineno"> 6741</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid OPTIONAL</div>
<div class="line"><a name="l06742"></a><span class="lineno"> 6742</span>&#160;    )</div>
<div class="line"><a name="l06743"></a><span class="lineno"> 6743</span>&#160;</div>
<div class="line"><a name="l06744"></a><span class="lineno"> 6744</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l06745"></a><span class="lineno"> 6745</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06746"></a><span class="lineno"> 6746</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l06747"></a><span class="lineno"> 6747</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06748"></a><span class="lineno"> 6748</span>&#160;<span class="comment">    Compare two aces to see if they are &quot;substantially&quot; the same.</span></div>
<div class="line"><a name="l06749"></a><span class="lineno"> 6749</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06750"></a><span class="lineno"> 6750</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l06751"></a><span class="lineno"> 6751</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06752"></a><span class="lineno"> 6752</span>&#160;<span class="comment">    InheritedAce - Computed ACE as inherited from DirectoryAcl.</span></div>
<div class="line"><a name="l06753"></a><span class="lineno"> 6753</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06754"></a><span class="lineno"> 6754</span>&#160;<span class="comment">    ChildAce - The current acl on the object.  This ACL must be a revision 2 ACL.</span></div>
<div class="line"><a name="l06755"></a><span class="lineno"> 6755</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06756"></a><span class="lineno"> 6756</span>&#160;<span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span></div>
<div class="line"><a name="l06757"></a><span class="lineno"> 6757</span>&#160;<span class="comment">        created has no GUID associated with it, then this argument is</span></div>
<div class="line"><a name="l06758"></a><span class="lineno"> 6758</span>&#160;<span class="comment">        specified as NULL.</span></div>
<div class="line"><a name="l06759"></a><span class="lineno"> 6759</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06760"></a><span class="lineno"> 6760</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l06761"></a><span class="lineno"> 6761</span>&#160;<span class="comment">        If not specified, the owner sid is not treated as special.</span></div>
<div class="line"><a name="l06762"></a><span class="lineno"> 6762</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06763"></a><span class="lineno"> 6763</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l06764"></a><span class="lineno"> 6764</span>&#160;<span class="comment">        If not specified, the group sid is not treated as special.</span></div>
<div class="line"><a name="l06765"></a><span class="lineno"> 6765</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06766"></a><span class="lineno"> 6766</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l06767"></a><span class="lineno"> 6767</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06768"></a><span class="lineno"> 6768</span>&#160;<span class="comment">    TRUE - The ACEs are substantially the same.</span></div>
<div class="line"><a name="l06769"></a><span class="lineno"> 6769</span>&#160;<span class="comment">    FALSE - The ACEs are not substantially the same.</span></div>
<div class="line"><a name="l06770"></a><span class="lineno"> 6770</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l06771"></a><span class="lineno"> 6771</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l06772"></a><span class="lineno"> 6772</span>&#160;</div>
<div class="line"><a name="l06773"></a><span class="lineno"> 6773</span>&#160;{</div>
<div class="line"><a name="l06774"></a><span class="lineno"> 6774</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l06775"></a><span class="lineno"> 6775</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DoingObjectAces;</div>
<div class="line"><a name="l06776"></a><span class="lineno"> 6776</span>&#160;    <a class="code" href="../../db/d44/a00533.html">GUID</a> *ChildObjectGuid;</div>
<div class="line"><a name="l06777"></a><span class="lineno"> 6777</span>&#160;    <a class="code" href="../../db/d44/a00533.html">GUID</a> *InhObjectGuid;</div>
<div class="line"><a name="l06778"></a><span class="lineno"> 6778</span>&#160;    <a class="code" href="../../db/d44/a00533.html">GUID</a> *ChildInheritedObjectGuid;</div>
<div class="line"><a name="l06779"></a><span class="lineno"> 6779</span>&#160;    <a class="code" href="../../db/d44/a00533.html">GUID</a> *InhInheritedObjectGuid;</div>
<div class="line"><a name="l06780"></a><span class="lineno"> 6780</span>&#160;    <a class="code" href="../../df/d86/a00012.html">ACE_HEADER</a> <span class="keyword">volatile</span> *InheritedAceHdr = &amp;InheritedAce-&gt;Header;</div>
<div class="line"><a name="l06781"></a><span class="lineno"> 6781</span>&#160;</div>
<div class="line"><a name="l06782"></a><span class="lineno"> 6782</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l06783"></a><span class="lineno"> 6783</span>&#160;</div>
<div class="line"><a name="l06784"></a><span class="lineno"> 6784</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(InheritedAce));</div>
<div class="line"><a name="l06785"></a><span class="lineno"> 6785</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a>(ChildAce));</div>
<div class="line"><a name="l06786"></a><span class="lineno"> 6786</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06787"></a><span class="lineno"> 6787</span>&#160;    <span class="comment">// If the Ace types are different,</span></div>
<div class="line"><a name="l06788"></a><span class="lineno"> 6788</span>&#160;    <span class="comment">//  we don&#39;t match.</span></div>
<div class="line"><a name="l06789"></a><span class="lineno"> 6789</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06790"></a><span class="lineno"> 6790</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] != <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[InheritedAceHdr-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] ) {</div>
<div class="line"><a name="l06791"></a><span class="lineno"> 6791</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06792"></a><span class="lineno"> 6792</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06793"></a><span class="lineno"> 6793</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;AceType mismatch&quot;</span>));</div>
<div class="line"><a name="l06794"></a><span class="lineno"> 6794</span>&#160;        }</div>
<div class="line"><a name="l06795"></a><span class="lineno"> 6795</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06796"></a><span class="lineno"> 6796</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06797"></a><span class="lineno"> 6797</span>&#160;    }</div>
<div class="line"><a name="l06798"></a><span class="lineno"> 6798</span>&#160;</div>
<div class="line"><a name="l06799"></a><span class="lineno"> 6799</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06800"></a><span class="lineno"> 6800</span>&#160;    <span class="comment">// If this is a system ACE,</span></div>
<div class="line"><a name="l06801"></a><span class="lineno"> 6801</span>&#160;    <span class="comment">//  ensure the SUCCESS/FAILURE flags match.</span></div>
<div class="line"><a name="l06802"></a><span class="lineno"> 6802</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06803"></a><span class="lineno"> 6803</span>&#160;</div>
<div class="line"><a name="l06804"></a><span class="lineno"> 6804</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab5f13e236f1a3bb478abc2db92920779">RtlIsSystemAceType</a>[ChildAce-&gt;Header.AceType] ) {</div>
<div class="line"><a name="l06805"></a><span class="lineno"> 6805</span>&#160;        <span class="keywordflow">if</span> ( (ChildAce-&gt;Header.AceFlags &amp; (<a class="code" href="../../d3/d3a/a02259.html#af432365a7f8156f8c092870edea1329b">SUCCESSFUL_ACCESS_ACE_FLAG</a>|<a class="code" href="../../d3/d3a/a02259.html#aed93f572f76288c4e5238b805f0f1c24">FAILED_ACCESS_ACE_FLAG</a>)) !=</div>
<div class="line"><a name="l06806"></a><span class="lineno"> 6806</span>&#160;             (InheritedAceHdr-&gt;<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; (<a class="code" href="../../d3/d3a/a02259.html#af432365a7f8156f8c092870edea1329b">SUCCESSFUL_ACCESS_ACE_FLAG</a>|<a class="code" href="../../d3/d3a/a02259.html#aed93f572f76288c4e5238b805f0f1c24">FAILED_ACCESS_ACE_FLAG</a>)) ) {</div>
<div class="line"><a name="l06807"></a><span class="lineno"> 6807</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06808"></a><span class="lineno"> 6808</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06809"></a><span class="lineno"> 6809</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;System ace success/fail mismatch&quot;</span>));</div>
<div class="line"><a name="l06810"></a><span class="lineno"> 6810</span>&#160;            }</div>
<div class="line"><a name="l06811"></a><span class="lineno"> 6811</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06812"></a><span class="lineno"> 6812</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06813"></a><span class="lineno"> 6813</span>&#160;        }</div>
<div class="line"><a name="l06814"></a><span class="lineno"> 6814</span>&#160;    }</div>
<div class="line"><a name="l06815"></a><span class="lineno"> 6815</span>&#160;</div>
<div class="line"><a name="l06816"></a><span class="lineno"> 6816</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06817"></a><span class="lineno"> 6817</span>&#160;    <span class="comment">// Get the GUIDs from the Object Aces</span></div>
<div class="line"><a name="l06818"></a><span class="lineno"> 6818</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06819"></a><span class="lineno"> 6819</span>&#160;</div>
<div class="line"><a name="l06820"></a><span class="lineno"> 6820</span>&#160;    ChildObjectGuid = <a class="code" href="../../df/d4d/a02285.html#aaf8953de6e4f7cd6b1e1246959c3b6d8">RtlObjectAceObjectType</a>(ChildAce);</div>
<div class="line"><a name="l06821"></a><span class="lineno"> 6821</span>&#160;    ChildInheritedObjectGuid = <a class="code" href="../../df/d4d/a02285.html#adfcbc9779e90e656630eab7a9e1a2173">RtlObjectAceInheritedObjectType</a>(ChildAce);</div>
<div class="line"><a name="l06822"></a><span class="lineno"> 6822</span>&#160;</div>
<div class="line"><a name="l06823"></a><span class="lineno"> 6823</span>&#160;    InhObjectGuid = <a class="code" href="../../df/d4d/a02285.html#aaf8953de6e4f7cd6b1e1246959c3b6d8">RtlObjectAceObjectType</a>(InheritedAce);</div>
<div class="line"><a name="l06824"></a><span class="lineno"> 6824</span>&#160;    InhInheritedObjectGuid = <a class="code" href="../../df/d4d/a02285.html#adfcbc9779e90e656630eab7a9e1a2173">RtlObjectAceInheritedObjectType</a>(InheritedAce);</div>
<div class="line"><a name="l06825"></a><span class="lineno"> 6825</span>&#160;</div>
<div class="line"><a name="l06826"></a><span class="lineno"> 6826</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06827"></a><span class="lineno"> 6827</span>&#160;    <span class="comment">// If the InheritedObjectGuid is present in either ACE,</span></div>
<div class="line"><a name="l06828"></a><span class="lineno"> 6828</span>&#160;    <span class="comment">//  they must be equal.</span></div>
<div class="line"><a name="l06829"></a><span class="lineno"> 6829</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06830"></a><span class="lineno"> 6830</span>&#160;</div>
<div class="line"><a name="l06831"></a><span class="lineno"> 6831</span>&#160;    <span class="keywordflow">if</span> ( ChildInheritedObjectGuid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || InhInheritedObjectGuid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06832"></a><span class="lineno"> 6832</span>&#160;</div>
<div class="line"><a name="l06833"></a><span class="lineno"> 6833</span>&#160;        <span class="keywordflow">if</span> ( ChildInheritedObjectGuid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06834"></a><span class="lineno"> 6834</span>&#160;             InhInheritedObjectGuid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06835"></a><span class="lineno"> 6835</span>&#160;             !<a class="code" href="../../df/d4d/a02285.html#ae331f8cb230765ba3962c1fbeb6776f6">RtlpIsEqualGuid</a>( ChildInheritedObjectGuid, InhInheritedObjectGuid )) {</div>
<div class="line"><a name="l06836"></a><span class="lineno"> 6836</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06837"></a><span class="lineno"> 6837</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06838"></a><span class="lineno"> 6838</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;InheritedObject GUID mismatch&quot;</span>));</div>
<div class="line"><a name="l06839"></a><span class="lineno"> 6839</span>&#160;            }</div>
<div class="line"><a name="l06840"></a><span class="lineno"> 6840</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06841"></a><span class="lineno"> 6841</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06842"></a><span class="lineno"> 6842</span>&#160;        }</div>
<div class="line"><a name="l06843"></a><span class="lineno"> 6843</span>&#160;    }</div>
<div class="line"><a name="l06844"></a><span class="lineno"> 6844</span>&#160;</div>
<div class="line"><a name="l06845"></a><span class="lineno"> 6845</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06846"></a><span class="lineno"> 6846</span>&#160;    <span class="comment">// If the ObjectGUID is present in either ACE,</span></div>
<div class="line"><a name="l06847"></a><span class="lineno"> 6847</span>&#160;    <span class="comment">//  they must be equal.</span></div>
<div class="line"><a name="l06848"></a><span class="lineno"> 6848</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06849"></a><span class="lineno"> 6849</span>&#160;    <span class="comment">// Any missing object GUID defaults to the passed in object GUID.</span></div>
<div class="line"><a name="l06850"></a><span class="lineno"> 6850</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06851"></a><span class="lineno"> 6851</span>&#160;</div>
<div class="line"><a name="l06852"></a><span class="lineno"> 6852</span>&#160;    <span class="keywordflow">if</span> ( (ChildObjectGuid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (InhObjectGuid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ) {</div>
<div class="line"><a name="l06853"></a><span class="lineno"> 6853</span>&#160;</div>
<div class="line"><a name="l06854"></a><span class="lineno"> 6854</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../df/d4d/a02285.html#ae331f8cb230765ba3962c1fbeb6776f6">RtlpIsEqualGuid</a>( ChildObjectGuid, InhObjectGuid )) {</div>
<div class="line"><a name="l06855"></a><span class="lineno"> 6855</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06856"></a><span class="lineno"> 6856</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06857"></a><span class="lineno"> 6857</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Object GUID mismatch&quot;</span>));</div>
<div class="line"><a name="l06858"></a><span class="lineno"> 6858</span>&#160;            }</div>
<div class="line"><a name="l06859"></a><span class="lineno"> 6859</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06860"></a><span class="lineno"> 6860</span>&#160;</div>
<div class="line"><a name="l06861"></a><span class="lineno"> 6861</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> );</div>
<div class="line"><a name="l06862"></a><span class="lineno"> 6862</span>&#160;        }</div>
<div class="line"><a name="l06863"></a><span class="lineno"> 6863</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06864"></a><span class="lineno"> 6864</span>&#160;</div>
<div class="line"><a name="l06865"></a><span class="lineno"> 6865</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06866"></a><span class="lineno"> 6866</span>&#160;        <span class="comment">// One or both is NULL, if it&#39;s only one, they don&#39;t match.</span></div>
<div class="line"><a name="l06867"></a><span class="lineno"> 6867</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06868"></a><span class="lineno"> 6868</span>&#160;</div>
<div class="line"><a name="l06869"></a><span class="lineno"> 6869</span>&#160;        <span class="keywordflow">if</span> ( !((ChildObjectGuid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (InhObjectGuid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) ) {</div>
<div class="line"><a name="l06870"></a><span class="lineno"> 6870</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06871"></a><span class="lineno"> 6871</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06872"></a><span class="lineno"> 6872</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Object GUID mismatch&quot;</span>));</div>
<div class="line"><a name="l06873"></a><span class="lineno"> 6873</span>&#160;            }</div>
<div class="line"><a name="l06874"></a><span class="lineno"> 6874</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06875"></a><span class="lineno"> 6875</span>&#160;</div>
<div class="line"><a name="l06876"></a><span class="lineno"> 6876</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> );</div>
<div class="line"><a name="l06877"></a><span class="lineno"> 6877</span>&#160;        }</div>
<div class="line"><a name="l06878"></a><span class="lineno"> 6878</span>&#160;    }</div>
<div class="line"><a name="l06879"></a><span class="lineno"> 6879</span>&#160;</div>
<div class="line"><a name="l06880"></a><span class="lineno"> 6880</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06881"></a><span class="lineno"> 6881</span>&#160;    <span class="comment">// If the SID of the inherited ACE doesn&#39;t match,</span></div>
<div class="line"><a name="l06882"></a><span class="lineno"> 6882</span>&#160;    <span class="comment">//  we don&#39;t match.</span></div>
<div class="line"><a name="l06883"></a><span class="lineno"> 6883</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l06884"></a><span class="lineno"> 6884</span>&#160;</div>
<div class="line"><a name="l06885"></a><span class="lineno"> 6885</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(ChildAce), <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(InheritedAce))) {</div>
<div class="line"><a name="l06886"></a><span class="lineno"> 6886</span>&#160;</div>
<div class="line"><a name="l06887"></a><span class="lineno"> 6887</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06888"></a><span class="lineno"> 6888</span>&#160;        <span class="comment">// The inheritance algorithm only does SID mapping when building the effective</span></div>
<div class="line"><a name="l06889"></a><span class="lineno"> 6889</span>&#160;        <span class="comment">//  ace.  So, we only check for a mapped SID if the child ACE is an effective ACE.</span></div>
<div class="line"><a name="l06890"></a><span class="lineno"> 6890</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06891"></a><span class="lineno"> 6891</span>&#160;</div>
<div class="line"><a name="l06892"></a><span class="lineno"> 6892</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb">AceFlagsInAce</a>(ChildAce) != <a class="code" href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95">EFFECTIVE_ACE</a> ) {</div>
<div class="line"><a name="l06893"></a><span class="lineno"> 6893</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06894"></a><span class="lineno"> 6894</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06895"></a><span class="lineno"> 6895</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06896"></a><span class="lineno"> 6896</span>&#160;            }</div>
<div class="line"><a name="l06897"></a><span class="lineno"> 6897</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06898"></a><span class="lineno"> 6898</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06899"></a><span class="lineno"> 6899</span>&#160;        }</div>
<div class="line"><a name="l06900"></a><span class="lineno"> 6900</span>&#160;</div>
<div class="line"><a name="l06901"></a><span class="lineno"> 6901</span>&#160;</div>
<div class="line"><a name="l06902"></a><span class="lineno"> 6902</span>&#160;</div>
<div class="line"><a name="l06903"></a><span class="lineno"> 6903</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06904"></a><span class="lineno"> 6904</span>&#160;        <span class="comment">// In the case of CreatorOwner and CreatorGroup, the SIDs don&#39;t have to</span></div>
<div class="line"><a name="l06905"></a><span class="lineno"> 6905</span>&#160;        <span class="comment">//  exactly match.  When the InheritedAce was generated, care was taken</span></div>
<div class="line"><a name="l06906"></a><span class="lineno"> 6906</span>&#160;        <span class="comment">//  to NOT map these sids.  The SID may (or may not) have been mapped in</span></div>
<div class="line"><a name="l06907"></a><span class="lineno"> 6907</span>&#160;        <span class="comment">//  the ChildAce.  We want to compare equal in both cases.</span></div>
<div class="line"><a name="l06908"></a><span class="lineno"> 6908</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06909"></a><span class="lineno"> 6909</span>&#160;        <span class="comment">// If the InheritedAce contains a CreatorOwner/Group SID,</span></div>
<div class="line"><a name="l06910"></a><span class="lineno"> 6910</span>&#160;        <span class="comment">//  do the another comparison of the SID in the child ACE with the</span></div>
<div class="line"><a name="l06911"></a><span class="lineno"> 6911</span>&#160;        <span class="comment">//  real owner/group from the child security descriptor.</span></div>
<div class="line"><a name="l06912"></a><span class="lineno"> 6912</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l06913"></a><span class="lineno"> 6913</span>&#160;</div>
<div class="line"><a name="l06914"></a><span class="lineno"> 6914</span>&#160;        <span class="keywordflow">if</span> ( OwnerSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || GroupSid != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l06915"></a><span class="lineno"> 6915</span>&#160;            <a class="code" href="../../dd/d90/a01626.html">SID_IDENTIFIER_AUTHORITY</a>  CreatorSidAuthority = <a class="code" href="../../d3/d3a/a02259.html#ae3bf1a31d65e4d15c09a8cd24dc0c0c2">SECURITY_CREATOR_SID_AUTHORITY</a>;</div>
<div class="line"><a name="l06916"></a><span class="lineno"> 6916</span>&#160;            <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreatorSid[<a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>];</div>
<div class="line"><a name="l06917"></a><span class="lineno"> 6917</span>&#160;</div>
<div class="line"><a name="l06918"></a><span class="lineno"> 6918</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06919"></a><span class="lineno"> 6919</span>&#160;            <span class="comment">// Allocate and initialize the universal SIDs we&#39;re going to need</span></div>
<div class="line"><a name="l06920"></a><span class="lineno"> 6920</span>&#160;            <span class="comment">// to look for inheritable ACEs.</span></div>
<div class="line"><a name="l06921"></a><span class="lineno"> 6921</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l06922"></a><span class="lineno"> 6922</span>&#160;</div>
<div class="line"><a name="l06923"></a><span class="lineno"> 6923</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a>( 1 ) == <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>);</div>
<div class="line"><a name="l06924"></a><span class="lineno"> 6924</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, &amp;CreatorSidAuthority, 1 );</div>
<div class="line"><a name="l06925"></a><span class="lineno"> 6925</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l06926"></a><span class="lineno"> 6926</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06927"></a><span class="lineno"> 6927</span>&#160;            }</div>
<div class="line"><a name="l06928"></a><span class="lineno"> 6928</span>&#160;</div>
<div class="line"><a name="l06929"></a><span class="lineno"> 6929</span>&#160;            *(<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorSid, 0 )) = <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>;</div>
<div class="line"><a name="l06930"></a><span class="lineno"> 6930</span>&#160;</div>
<div class="line"><a name="l06931"></a><span class="lineno"> 6931</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a> ( <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(InheritedAce), CreatorSid )) {</div>
<div class="line"><a name="l06932"></a><span class="lineno"> 6932</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Rid;</div>
<div class="line"><a name="l06933"></a><span class="lineno"> 6933</span>&#160;</div>
<div class="line"><a name="l06934"></a><span class="lineno"> 6934</span>&#160;                Rid = *<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(InheritedAce), 0 );</div>
<div class="line"><a name="l06935"></a><span class="lineno"> 6935</span>&#160;                <span class="keywordflow">switch</span> (Rid) {</div>
<div class="line"><a name="l06936"></a><span class="lineno"> 6936</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>:</div>
<div class="line"><a name="l06937"></a><span class="lineno"> 6937</span>&#160;                    <span class="keywordflow">if</span> ( OwnerSid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06938"></a><span class="lineno"> 6938</span>&#160;                         !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(ChildAce), OwnerSid )) {</div>
<div class="line"><a name="l06939"></a><span class="lineno"> 6939</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06940"></a><span class="lineno"> 6940</span>&#160;                        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06941"></a><span class="lineno"> 6941</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator Owner)&quot;</span>));</div>
<div class="line"><a name="l06942"></a><span class="lineno"> 6942</span>&#160;                        }</div>
<div class="line"><a name="l06943"></a><span class="lineno"> 6943</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06944"></a><span class="lineno"> 6944</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06945"></a><span class="lineno"> 6945</span>&#160;                    }</div>
<div class="line"><a name="l06946"></a><span class="lineno"> 6946</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06947"></a><span class="lineno"> 6947</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a>:</div>
<div class="line"><a name="l06948"></a><span class="lineno"> 6948</span>&#160;                    <span class="keywordflow">if</span> ( GroupSid == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||</div>
<div class="line"><a name="l06949"></a><span class="lineno"> 6949</span>&#160;                         !<a class="code" href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a>( <a class="code" href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a>(ChildAce), GroupSid )) {</div>
<div class="line"><a name="l06950"></a><span class="lineno"> 6950</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06951"></a><span class="lineno"> 6951</span>&#160;                        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06952"></a><span class="lineno"> 6952</span>&#160;                            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator Group)&quot;</span>));</div>
<div class="line"><a name="l06953"></a><span class="lineno"> 6953</span>&#160;                        }</div>
<div class="line"><a name="l06954"></a><span class="lineno"> 6954</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06955"></a><span class="lineno"> 6955</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06956"></a><span class="lineno"> 6956</span>&#160;                    }</div>
<div class="line"><a name="l06957"></a><span class="lineno"> 6957</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l06958"></a><span class="lineno"> 6958</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l06959"></a><span class="lineno"> 6959</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06960"></a><span class="lineno"> 6960</span>&#160;                    <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06961"></a><span class="lineno"> 6961</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch (Creator)&quot;</span>));</div>
<div class="line"><a name="l06962"></a><span class="lineno"> 6962</span>&#160;                    }</div>
<div class="line"><a name="l06963"></a><span class="lineno"> 6963</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06964"></a><span class="lineno"> 6964</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06965"></a><span class="lineno"> 6965</span>&#160;                }</div>
<div class="line"><a name="l06966"></a><span class="lineno"> 6966</span>&#160;</div>
<div class="line"><a name="l06967"></a><span class="lineno"> 6967</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06968"></a><span class="lineno"> 6968</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06969"></a><span class="lineno"> 6969</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06970"></a><span class="lineno"> 6970</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06971"></a><span class="lineno"> 6971</span>&#160;                }</div>
<div class="line"><a name="l06972"></a><span class="lineno"> 6972</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06973"></a><span class="lineno"> 6973</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06974"></a><span class="lineno"> 6974</span>&#160;            }</div>
<div class="line"><a name="l06975"></a><span class="lineno"> 6975</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l06976"></a><span class="lineno"> 6976</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l06977"></a><span class="lineno"> 6977</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l06978"></a><span class="lineno"> 6978</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;SID mismatch&quot;</span>));</div>
<div class="line"><a name="l06979"></a><span class="lineno"> 6979</span>&#160;            }</div>
<div class="line"><a name="l06980"></a><span class="lineno"> 6980</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l06981"></a><span class="lineno"> 6981</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l06982"></a><span class="lineno"> 6982</span>&#160;        }</div>
<div class="line"><a name="l06983"></a><span class="lineno"> 6983</span>&#160;    }</div>
<div class="line"><a name="l06984"></a><span class="lineno"> 6984</span>&#160;</div>
<div class="line"><a name="l06985"></a><span class="lineno"> 6985</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l06986"></a><span class="lineno"> 6986</span>&#160;</div>
<div class="line"><a name="l06987"></a><span class="lineno"> 6987</span>&#160;}</div>
<div class="line"><a name="l06988"></a><span class="lineno"> 6988</span>&#160;</div>
<div class="line"><a name="l06989"></a><span class="lineno"> 6989</span>&#160;</div>
<div class="line"><a name="l06990"></a><span class="lineno"> 6990</span>&#160;</div>
<div class="line"><a name="l06991"></a><span class="lineno"> 6991</span>&#160;</div>
<div class="line"><a name="l06992"></a><span class="lineno"> 6992</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l06993"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833"> 6993</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833">RtlpConvertAclToAutoInherit</a> (</div>
<div class="line"><a name="l06994"></a><span class="lineno"> 6994</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ParentAcl <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l06995"></a><span class="lineno"> 6995</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ChildAcl,</div>
<div class="line"><a name="l06996"></a><span class="lineno"> 6996</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> *ObjectType OPTIONAL,</div>
<div class="line"><a name="l06997"></a><span class="lineno"> 6997</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l06998"></a><span class="lineno"> 6998</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> OwnerSid,</div>
<div class="line"><a name="l06999"></a><span class="lineno"> 6999</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> GroupSid,</div>
<div class="line"><a name="l07000"></a><span class="lineno"> 7000</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l07001"></a><span class="lineno"> 7001</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *NewAcl,</div>
<div class="line"><a name="l07002"></a><span class="lineno"> 7002</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> NewGenericControl</div>
<div class="line"><a name="l07003"></a><span class="lineno"> 7003</span>&#160;    )</div>
<div class="line"><a name="l07004"></a><span class="lineno"> 7004</span>&#160;</div>
<div class="line"><a name="l07005"></a><span class="lineno"> 7005</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l07006"></a><span class="lineno"> 7006</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07007"></a><span class="lineno"> 7007</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l07008"></a><span class="lineno"> 7008</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07009"></a><span class="lineno"> 7009</span>&#160;<span class="comment">    This is a private routine that produces an auto inherited acl from</span></div>
<div class="line"><a name="l07010"></a><span class="lineno"> 7010</span>&#160;<span class="comment">    a ChildAcl that is not marked as auto inherited.  The passed in InheritedAcl</span></div>
<div class="line"><a name="l07011"></a><span class="lineno"> 7011</span>&#160;<span class="comment">    is computed as the pure inherited ACL of Parent ACL of the object.</span></div>
<div class="line"><a name="l07012"></a><span class="lineno"> 7012</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07013"></a><span class="lineno"> 7013</span>&#160;<span class="comment">    See comments for RtlConvertToAutoInheritSecurityObject.</span></div>
<div class="line"><a name="l07014"></a><span class="lineno"> 7014</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07015"></a><span class="lineno"> 7015</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l07016"></a><span class="lineno"> 7016</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07017"></a><span class="lineno"> 7017</span>&#160;<span class="comment">    ParentAcl - Supplies the ACL of the parent object.</span></div>
<div class="line"><a name="l07018"></a><span class="lineno"> 7018</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07019"></a><span class="lineno"> 7019</span>&#160;<span class="comment">    ChildAcl - Supplies the acl associated with the object.  This</span></div>
<div class="line"><a name="l07020"></a><span class="lineno"> 7020</span>&#160;<span class="comment">        is the current acl on the object.</span></div>
<div class="line"><a name="l07021"></a><span class="lineno"> 7021</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07022"></a><span class="lineno"> 7022</span>&#160;<span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span></div>
<div class="line"><a name="l07023"></a><span class="lineno"> 7023</span>&#160;<span class="comment">        created has no GUID associated with it, then this argument is</span></div>
<div class="line"><a name="l07024"></a><span class="lineno"> 7024</span>&#160;<span class="comment">        specified as NULL.</span></div>
<div class="line"><a name="l07025"></a><span class="lineno"> 7025</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07026"></a><span class="lineno"> 7026</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the object is a</span></div>
<div class="line"><a name="l07027"></a><span class="lineno"> 7027</span>&#160;<span class="comment">        directory object.  A value of TRUE indicates the object is a</span></div>
<div class="line"><a name="l07028"></a><span class="lineno"> 7028</span>&#160;<span class="comment">        container of other objects.</span></div>
<div class="line"><a name="l07029"></a><span class="lineno"> 7029</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07030"></a><span class="lineno"> 7030</span>&#160;<span class="comment">    OwnerSid - Specifies the owner Sid to use.</span></div>
<div class="line"><a name="l07031"></a><span class="lineno"> 7031</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07032"></a><span class="lineno"> 7032</span>&#160;<span class="comment">    GroupSid - Specifies the group SID to use.</span></div>
<div class="line"><a name="l07033"></a><span class="lineno"> 7033</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07034"></a><span class="lineno"> 7034</span>&#160;<span class="comment">    GenericMapping - Specifies the generic mapping to use.</span></div>
<div class="line"><a name="l07035"></a><span class="lineno"> 7035</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07036"></a><span class="lineno"> 7036</span>&#160;<span class="comment">    NewAcl - Receives a pointer to the new (auto inherited) acl.</span></div>
<div class="line"><a name="l07037"></a><span class="lineno"> 7037</span>&#160;<span class="comment">        The ACL must be deallocated using the pool (kernel mode) or</span></div>
<div class="line"><a name="l07038"></a><span class="lineno"> 7038</span>&#160;<span class="comment">            heap (user mode) deallocator.</span></div>
<div class="line"><a name="l07039"></a><span class="lineno"> 7039</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07040"></a><span class="lineno"> 7040</span>&#160;<span class="comment">    NewGenericControl - Specifies the control flags for the newly</span></div>
<div class="line"><a name="l07041"></a><span class="lineno"> 7041</span>&#160;<span class="comment">        generated ACL.</span></div>
<div class="line"><a name="l07042"></a><span class="lineno"> 7042</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07043"></a><span class="lineno"> 7043</span>&#160;<span class="comment">        SEP_ACL_PRESENT: Specifies that the ACL is explictly supplied by</span></div>
<div class="line"><a name="l07044"></a><span class="lineno"> 7044</span>&#160;<span class="comment">            the caller. ?? Ever set?</span></div>
<div class="line"><a name="l07045"></a><span class="lineno"> 7045</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07046"></a><span class="lineno"> 7046</span>&#160;<span class="comment">        SEP_ACL_DEFAULTED: Specifies that the ACL was supplied by some</span></div>
<div class="line"><a name="l07047"></a><span class="lineno"> 7047</span>&#160;<span class="comment">            defaulting mechanism. ?? Ever set</span></div>
<div class="line"><a name="l07048"></a><span class="lineno"> 7048</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07049"></a><span class="lineno"> 7049</span>&#160;<span class="comment">        SEP_ACL_AUTO_INHERITED: Set if the ACL was generated using the</span></div>
<div class="line"><a name="l07050"></a><span class="lineno"> 7050</span>&#160;<span class="comment">            Automatic Inheritance algorithm.</span></div>
<div class="line"><a name="l07051"></a><span class="lineno"> 7051</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07052"></a><span class="lineno"> 7052</span>&#160;<span class="comment">        SEP_ACL_PROTECTED: Specifies that the ACL is protected and</span></div>
<div class="line"><a name="l07053"></a><span class="lineno"> 7053</span>&#160;<span class="comment">            was not inherited from the parent ACL.</span></div>
<div class="line"><a name="l07054"></a><span class="lineno"> 7054</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07055"></a><span class="lineno"> 7055</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l07056"></a><span class="lineno"> 7056</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07057"></a><span class="lineno"> 7057</span>&#160;<span class="comment">    STATUS_SUCCESS - An inheritable ACL was successfully generated.</span></div>
<div class="line"><a name="l07058"></a><span class="lineno"> 7058</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07059"></a><span class="lineno"> 7059</span>&#160;<span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span></div>
<div class="line"><a name="l07060"></a><span class="lineno"> 7060</span>&#160;<span class="comment">        is unknown to this routine.</span></div>
<div class="line"><a name="l07061"></a><span class="lineno"> 7061</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07062"></a><span class="lineno"> 7062</span>&#160;<span class="comment">    STATUS_INVALID_ACL - The structure of one of the ACLs in invalid.</span></div>
<div class="line"><a name="l07063"></a><span class="lineno"> 7063</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07064"></a><span class="lineno"> 7064</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l07065"></a><span class="lineno"> 7065</span>&#160;</div>
<div class="line"><a name="l07066"></a><span class="lineno"> 7066</span>&#160;{</div>
<div class="line"><a name="l07067"></a><span class="lineno"> 7067</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l07068"></a><span class="lineno"> 7068</span>&#160;</div>
<div class="line"><a name="l07069"></a><span class="lineno"> 7069</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> InheritedAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07070"></a><span class="lineno"> 7070</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> RealInheritedAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07071"></a><span class="lineno"> 7071</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclExplicitlyAssigned;</div>
<div class="line"><a name="l07072"></a><span class="lineno"> 7072</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GenericControl;</div>
<div class="line"><a name="l07073"></a><span class="lineno"> 7073</span>&#160;</div>
<div class="line"><a name="l07074"></a><span class="lineno"> 7074</span>&#160;    <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> ChildAce = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07075"></a><span class="lineno"> 7075</span>&#160;    <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> InheritedAce;</div>
<div class="line"><a name="l07076"></a><span class="lineno"> 7076</span>&#160;</div>
<div class="line"><a name="l07077"></a><span class="lineno"> 7077</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a> ChildAceIndex;</div>
<div class="line"><a name="l07078"></a><span class="lineno"> 7078</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a> InheritedAceIndex;</div>
<div class="line"><a name="l07079"></a><span class="lineno"> 7079</span>&#160;</div>
<div class="line"><a name="l07080"></a><span class="lineno"> 7080</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> InheritedAllowFound;</div>
<div class="line"><a name="l07081"></a><span class="lineno"> 7081</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> InheritedDenyFound;</div>
<div class="line"><a name="l07082"></a><span class="lineno"> 7082</span>&#160;</div>
<div class="line"><a name="l07083"></a><span class="lineno"> 7083</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AcesCompare;</div>
<div class="line"><a name="l07084"></a><span class="lineno"> 7084</span>&#160;</div>
<div class="line"><a name="l07085"></a><span class="lineno"> 7085</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> InheritedContainerInheritMask;</div>
<div class="line"><a name="l07086"></a><span class="lineno"> 7086</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> InheritedObjectInheritMask;</div>
<div class="line"><a name="l07087"></a><span class="lineno"> 7087</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> InheritedEffectiveMask;</div>
<div class="line"><a name="l07088"></a><span class="lineno"> 7088</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalInheritedContainerInheritMask;</div>
<div class="line"><a name="l07089"></a><span class="lineno"> 7089</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalInheritedObjectInheritMask;</div>
<div class="line"><a name="l07090"></a><span class="lineno"> 7090</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalInheritedEffectiveMask;</div>
<div class="line"><a name="l07091"></a><span class="lineno"> 7091</span>&#160;</div>
<div class="line"><a name="l07092"></a><span class="lineno"> 7092</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> InheritedAceFlags;</div>
<div class="line"><a name="l07093"></a><span class="lineno"> 7093</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> MatchedFlags;</div>
<div class="line"><a name="l07094"></a><span class="lineno"> 7094</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NonInheritedAclSize;</div>
<div class="line"><a name="l07095"></a><span class="lineno"> 7095</span>&#160;</div>
<div class="line"><a name="l07096"></a><span class="lineno"> 7096</span>&#160;</div>
<div class="line"><a name="l07097"></a><span class="lineno"> 7097</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> AceHeader;</div>
<div class="line"><a name="l07098"></a><span class="lineno"> 7098</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> Where;</div>
<div class="line"><a name="l07099"></a><span class="lineno"> 7099</span>&#160;</div>
<div class="line"><a name="l07100"></a><span class="lineno"> 7100</span>&#160;    <span class="comment">// ULONG i;</span></div>
<div class="line"><a name="l07101"></a><span class="lineno"> 7101</span>&#160;</div>
<div class="line"><a name="l07102"></a><span class="lineno"> 7102</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07103"></a><span class="lineno"> 7103</span>&#160;    <span class="comment">// This routine maintains an array of the structure below (one element per ACE in</span></div>
<div class="line"><a name="l07104"></a><span class="lineno"> 7104</span>&#160;    <span class="comment">// the ChildAcl).</span></div>
<div class="line"><a name="l07105"></a><span class="lineno"> 7105</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07106"></a><span class="lineno"> 7106</span>&#160;    <span class="comment">// The ACE is broken down into its component parts.  The access mask is &#39;triplicated&#39;.</span></div>
<div class="line"><a name="l07107"></a><span class="lineno"> 7107</span>&#160;    <span class="comment">// That is, if the ACE is a ContainerInherit ACE, the access mask is remembered as</span></div>
<div class="line"><a name="l07108"></a><span class="lineno"> 7108</span>&#160;    <span class="comment">// being a &quot;ContainerInheritMask&quot;.  The same is true if the ACE is an ObjectInherit ACE</span></div>
<div class="line"><a name="l07109"></a><span class="lineno"> 7109</span>&#160;    <span class="comment">// on an effective ACE.  This is done since each of the resultant 96 bits are</span></div>
<div class="line"><a name="l07110"></a><span class="lineno"> 7110</span>&#160;    <span class="comment">// individually matched against corresponding bits in the computed inherited ACE.</span></div>
<div class="line"><a name="l07111"></a><span class="lineno"> 7111</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07112"></a><span class="lineno"> 7112</span>&#160;    <span class="comment">// Each of the above mentioned masks are maintained in two forms.  The first is never</span></div>
<div class="line"><a name="l07113"></a><span class="lineno"> 7113</span>&#160;    <span class="comment">// changed and represents the bits as the originally appeared in the child ACL.</span></div>
<div class="line"><a name="l07114"></a><span class="lineno"> 7114</span>&#160;    <span class="comment">// This second is modified as the corresponding bits are matched in the inherited ACL.</span></div>
<div class="line"><a name="l07115"></a><span class="lineno"> 7115</span>&#160;    <span class="comment">// When the algorithm is completed, bits that haven&#39;t been matched represent ACEs</span></div>
<div class="line"><a name="l07116"></a><span class="lineno"> 7116</span>&#160;    <span class="comment">// that weren&#39;t inherited from the parent.</span></div>
<div class="line"><a name="l07117"></a><span class="lineno"> 7117</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07118"></a><span class="lineno"> 7118</span>&#160;</div>
<div class="line"><a name="l07119"></a><span class="lineno"> 7119</span>&#160;    <span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line"><a name="l07120"></a><span class="lineno"> 7120</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalContainerInheritMask;</div>
<div class="line"><a name="l07121"></a><span class="lineno"> 7121</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalObjectInheritMask;</div>
<div class="line"><a name="l07122"></a><span class="lineno"> 7122</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> OriginalEffectiveMask;</div>
<div class="line"><a name="l07123"></a><span class="lineno"> 7123</span>&#160;</div>
<div class="line"><a name="l07124"></a><span class="lineno"> 7124</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> ContainerInheritMask;</div>
<div class="line"><a name="l07125"></a><span class="lineno"> 7125</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> ObjectInheritMask;</div>
<div class="line"><a name="l07126"></a><span class="lineno"> 7126</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> EffectiveMask;</div>
<div class="line"><a name="l07127"></a><span class="lineno"> 7127</span>&#160;    } ACE_INFO, *PACE_INFO;</div>
<div class="line"><a name="l07128"></a><span class="lineno"> 7128</span>&#160;</div>
<div class="line"><a name="l07129"></a><span class="lineno"> 7129</span>&#160;    PACE_INFO ChildAceInfo = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07130"></a><span class="lineno"> 7130</span>&#160;</div>
<div class="line"><a name="l07131"></a><span class="lineno"> 7131</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreatorOwnerSid[<a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>];</div>
<div class="line"><a name="l07132"></a><span class="lineno"> 7132</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreatorGroupSid[<a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>];</div>
<div class="line"><a name="l07133"></a><span class="lineno"> 7133</span>&#160;</div>
<div class="line"><a name="l07134"></a><span class="lineno"> 7134</span>&#160;    <a class="code" href="../../dd/d90/a01626.html">SID_IDENTIFIER_AUTHORITY</a>  CreatorSidAuthority = <a class="code" href="../../d3/d3a/a02259.html#ae3bf1a31d65e4d15c09a8cd24dc0c0c2">SECURITY_CREATOR_SID_AUTHORITY</a>;</div>
<div class="line"><a name="l07135"></a><span class="lineno"> 7135</span>&#160;</div>
<div class="line"><a name="l07136"></a><span class="lineno"> 7136</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l07137"></a><span class="lineno"> 7137</span>&#160;</div>
<div class="line"><a name="l07138"></a><span class="lineno"> 7138</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07139"></a><span class="lineno"> 7139</span>&#160;    <span class="comment">// Allocate and initialize the universal SIDs we&#39;re going to need</span></div>
<div class="line"><a name="l07140"></a><span class="lineno"> 7140</span>&#160;    <span class="comment">// to look for inheritable ACEs.</span></div>
<div class="line"><a name="l07141"></a><span class="lineno"> 7141</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07142"></a><span class="lineno"> 7142</span>&#160;</div>
<div class="line"><a name="l07143"></a><span class="lineno"> 7143</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(<a class="code" href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a>( 1 ) == <a class="code" href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a>);</div>
<div class="line"><a name="l07144"></a><span class="lineno"> 7144</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorOwnerSid, &amp;CreatorSidAuthority, 1 );</div>
<div class="line"><a name="l07145"></a><span class="lineno"> 7145</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07146"></a><span class="lineno"> 7146</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07147"></a><span class="lineno"> 7147</span>&#160;    }</div>
<div class="line"><a name="l07148"></a><span class="lineno"> 7148</span>&#160;</div>
<div class="line"><a name="l07149"></a><span class="lineno"> 7149</span>&#160;    *(<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorOwnerSid, 0 )) = <a class="code" href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a>;</div>
<div class="line"><a name="l07150"></a><span class="lineno"> 7150</span>&#160;</div>
<div class="line"><a name="l07151"></a><span class="lineno"> 7151</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorGroupSid, &amp;CreatorSidAuthority, 1 );</div>
<div class="line"><a name="l07152"></a><span class="lineno"> 7152</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07153"></a><span class="lineno"> 7153</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07154"></a><span class="lineno"> 7154</span>&#160;    }</div>
<div class="line"><a name="l07155"></a><span class="lineno"> 7155</span>&#160;</div>
<div class="line"><a name="l07156"></a><span class="lineno"> 7156</span>&#160;    *(<a class="code" href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a>( (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)CreatorGroupSid, 0 )) = <a class="code" href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a>;</div>
<div class="line"><a name="l07157"></a><span class="lineno"> 7157</span>&#160;</div>
<div class="line"><a name="l07158"></a><span class="lineno"> 7158</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07159"></a><span class="lineno"> 7159</span>&#160;    <span class="comment">// Ensure the passed in ACLs are valid.</span></div>
<div class="line"><a name="l07160"></a><span class="lineno"> 7160</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07161"></a><span class="lineno"> 7161</span>&#160;</div>
<div class="line"><a name="l07162"></a><span class="lineno"> 7162</span>&#160;    *NewGenericControl = <a class="code" href="../../df/d4d/a02285.html#a8f356589d2c645df49484357ca1ae9b1">SEP_ACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l07163"></a><span class="lineno"> 7163</span>&#160;    *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07164"></a><span class="lineno"> 7164</span>&#160;</div>
<div class="line"><a name="l07165"></a><span class="lineno"> 7165</span>&#160;    <span class="keywordflow">if</span> ( ParentAcl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a>( ParentAcl ) ) {</div>
<div class="line"><a name="l07166"></a><span class="lineno"> 7166</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a>;</div>
<div class="line"><a name="l07167"></a><span class="lineno"> 7167</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07168"></a><span class="lineno"> 7168</span>&#160;    }</div>
<div class="line"><a name="l07169"></a><span class="lineno"> 7169</span>&#160;</div>
<div class="line"><a name="l07170"></a><span class="lineno"> 7170</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a>( ChildAcl ) ) {</div>
<div class="line"><a name="l07171"></a><span class="lineno"> 7171</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a>;</div>
<div class="line"><a name="l07172"></a><span class="lineno"> 7172</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07173"></a><span class="lineno"> 7173</span>&#160;    }</div>
<div class="line"><a name="l07174"></a><span class="lineno"> 7174</span>&#160;</div>
<div class="line"><a name="l07175"></a><span class="lineno"> 7175</span>&#160;</div>
<div class="line"><a name="l07176"></a><span class="lineno"> 7176</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07177"></a><span class="lineno"> 7177</span>&#160;    <span class="comment">// Compute what the inherited ACL &quot;should&quot; look like.</span></div>
<div class="line"><a name="l07178"></a><span class="lineno"> 7178</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07179"></a><span class="lineno"> 7179</span>&#160;    <span class="comment">// The inherited ACL is computed to NOT SID-map Creator Owner and Creator Group.</span></div>
<div class="line"><a name="l07180"></a><span class="lineno"> 7180</span>&#160;    <span class="comment">// This allows use to later recognize the constant SIDs and special case them</span></div>
<div class="line"><a name="l07181"></a><span class="lineno"> 7181</span>&#160;    <span class="comment">// rather than mistakenly confuse them with the mapped SID.</span></div>
<div class="line"><a name="l07182"></a><span class="lineno"> 7182</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07183"></a><span class="lineno"> 7183</span>&#160;</div>
<div class="line"><a name="l07184"></a><span class="lineno"> 7184</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a> (</div>
<div class="line"><a name="l07185"></a><span class="lineno"> 7185</span>&#160;                ParentAcl,</div>
<div class="line"><a name="l07186"></a><span class="lineno"> 7186</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,   <span class="comment">// No explicit child ACL</span></div>
<div class="line"><a name="l07187"></a><span class="lineno"> 7187</span>&#160;                0,      <span class="comment">// No Child Generic Control</span></div>
<div class="line"><a name="l07188"></a><span class="lineno"> 7188</span>&#160;                IsDirectoryObject,</div>
<div class="line"><a name="l07189"></a><span class="lineno"> 7189</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,   <span class="comment">// AutoInherit the DACL</span></div>
<div class="line"><a name="l07190"></a><span class="lineno"> 7190</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,  <span class="comment">// Not default descriptor for object</span></div>
<div class="line"><a name="l07191"></a><span class="lineno"> 7191</span>&#160;                CreatorOwnerSid,   <span class="comment">// Subsitute a constant SID</span></div>
<div class="line"><a name="l07192"></a><span class="lineno"> 7192</span>&#160;                CreatorGroupSid,   <span class="comment">// Subsitute a constant SID</span></div>
<div class="line"><a name="l07193"></a><span class="lineno"> 7193</span>&#160;                CreatorOwnerSid,   <span class="comment">// Server Owner (Technically incorrect, but OK since we don&#39;t support compound ACEs)</span></div>
<div class="line"><a name="l07194"></a><span class="lineno"> 7194</span>&#160;                CreatorGroupSid,   <span class="comment">// Server Group</span></div>
<div class="line"><a name="l07195"></a><span class="lineno"> 7195</span>&#160;                GenericMapping,</div>
<div class="line"><a name="l07196"></a><span class="lineno"> 7196</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,   <span class="comment">// Is a SACL</span></div>
<div class="line"><a name="l07197"></a><span class="lineno"> 7197</span>&#160;                ObjectType ? &amp;ObjectType : <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, </div>
<div class="line"><a name="l07198"></a><span class="lineno"> 7198</span>&#160;                ObjectType ? 1 : 0,</div>
<div class="line"><a name="l07199"></a><span class="lineno"> 7199</span>&#160;                &amp;InheritedAcl,</div>
<div class="line"><a name="l07200"></a><span class="lineno"> 7200</span>&#160;                &amp;AclExplicitlyAssigned,</div>
<div class="line"><a name="l07201"></a><span class="lineno"> 7201</span>&#160;                &amp;GenericControl );</div>
<div class="line"><a name="l07202"></a><span class="lineno"> 7202</span>&#160;</div>
<div class="line"><a name="l07203"></a><span class="lineno"> 7203</span>&#160;    <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#a1b28d9f0fc2ca4517f6c0606efb4e0f5">STATUS_NO_INHERITANCE</a> ) {</div>
<div class="line"><a name="l07204"></a><span class="lineno"> 7204</span>&#160;        *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07205"></a><span class="lineno"> 7205</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07206"></a><span class="lineno"> 7206</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07207"></a><span class="lineno"> 7207</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;NO_INHERITANCE of the parent ACL\n&quot;</span> ));</div>
<div class="line"><a name="l07208"></a><span class="lineno"> 7208</span>&#160;        }</div>
<div class="line"><a name="l07209"></a><span class="lineno"> 7209</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07210"></a><span class="lineno"> 7210</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07211"></a><span class="lineno"> 7211</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07212"></a><span class="lineno"> 7212</span>&#160;    }</div>
<div class="line"><a name="l07213"></a><span class="lineno"> 7213</span>&#160;</div>
<div class="line"><a name="l07214"></a><span class="lineno"> 7214</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07215"></a><span class="lineno"> 7215</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07216"></a><span class="lineno"> 7216</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07217"></a><span class="lineno"> 7217</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Can&#39;t build inherited ACL %lX\n&quot;</span>, Status ));</div>
<div class="line"><a name="l07218"></a><span class="lineno"> 7218</span>&#160;        }</div>
<div class="line"><a name="l07219"></a><span class="lineno"> 7219</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07220"></a><span class="lineno"> 7220</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07221"></a><span class="lineno"> 7221</span>&#160;    }</div>
<div class="line"><a name="l07222"></a><span class="lineno"> 7222</span>&#160;</div>
<div class="line"><a name="l07223"></a><span class="lineno"> 7223</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07224"></a><span class="lineno"> 7224</span>&#160;    <span class="comment">// Allocate a work buffer describing the ChildAcl</span></div>
<div class="line"><a name="l07225"></a><span class="lineno"> 7225</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07226"></a><span class="lineno"> 7226</span>&#160;</div>
<div class="line"><a name="l07227"></a><span class="lineno"> 7227</span>&#160;    ChildAceInfo = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l07228"></a><span class="lineno"> 7228</span>&#160;                        <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l07229"></a><span class="lineno"> 7229</span>&#160;                        ChildAcl-&gt;AceCount * <span class="keyword">sizeof</span>(ACE_INFO),</div>
<div class="line"><a name="l07230"></a><span class="lineno"> 7230</span>&#160;                        <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l07231"></a><span class="lineno"> 7231</span>&#160;</div>
<div class="line"><a name="l07232"></a><span class="lineno"> 7232</span>&#160;    <span class="keywordflow">if</span> (ChildAceInfo == NULL ) {</div>
<div class="line"><a name="l07233"></a><span class="lineno"> 7233</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a>;</div>
<div class="line"><a name="l07234"></a><span class="lineno"> 7234</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07235"></a><span class="lineno"> 7235</span>&#160;    }</div>
<div class="line"><a name="l07236"></a><span class="lineno"> 7236</span>&#160;</div>
<div class="line"><a name="l07237"></a><span class="lineno"> 7237</span>&#160;    <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(ChildAcl);</div>
<div class="line"><a name="l07238"></a><span class="lineno"> 7238</span>&#160;         ChildAceIndex &lt; ChildAcl-&gt;AceCount;</div>
<div class="line"><a name="l07239"></a><span class="lineno"> 7239</span>&#160;         ChildAceIndex += 1, ChildAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(ChildAce)) {</div>
<div class="line"><a name="l07240"></a><span class="lineno"> 7240</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> LocalMask;</div>
<div class="line"><a name="l07241"></a><span class="lineno"> 7241</span>&#160;        <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ChildAceFlags;</div>
<div class="line"><a name="l07242"></a><span class="lineno"> 7242</span>&#160;</div>
<div class="line"><a name="l07243"></a><span class="lineno"> 7243</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#ada772d88133c0c4f43ef15b685f17944">IsV4AceType</a>(ChildAce) || <a class="code" href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a>(ChildAce)) {</div>
<div class="line"><a name="l07244"></a><span class="lineno"> 7244</span>&#160;             *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07245"></a><span class="lineno"> 7245</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07246"></a><span class="lineno"> 7246</span>&#160;             <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07247"></a><span class="lineno"> 7247</span>&#160;                 <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Inherited Ace type (%ld) not known\n&quot;</span>, ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> ));</div>
<div class="line"><a name="l07248"></a><span class="lineno"> 7248</span>&#160;             }</div>
<div class="line"><a name="l07249"></a><span class="lineno"> 7249</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07250"></a><span class="lineno"> 7250</span>&#160;             Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07251"></a><span class="lineno"> 7251</span>&#160;             <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07252"></a><span class="lineno"> 7252</span>&#160;        }</div>
<div class="line"><a name="l07253"></a><span class="lineno"> 7253</span>&#160;</div>
<div class="line"><a name="l07254"></a><span class="lineno"> 7254</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07255"></a><span class="lineno"> 7255</span>&#160;        <span class="comment">// Compute the generic mapped mask for use in all comparisons.  The</span></div>
<div class="line"><a name="l07256"></a><span class="lineno"> 7256</span>&#160;        <span class="comment">//  generic mapping will be undone if needed later.</span></div>
<div class="line"><a name="l07257"></a><span class="lineno"> 7257</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07258"></a><span class="lineno"> 7258</span>&#160;        <span class="comment">// All V4 aces have an access mask in the same location.</span></div>
<div class="line"><a name="l07259"></a><span class="lineno"> 7259</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07260"></a><span class="lineno"> 7260</span>&#160;        LocalMask = ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(ChildAce))-&gt;Mask;</div>
<div class="line"><a name="l07261"></a><span class="lineno"> 7261</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#a226f8b2aa65758424db1dd0f51011d32">RtlApplyGenericMask</a>( ChildAce, &amp;LocalMask, GenericMapping);</div>
<div class="line"><a name="l07262"></a><span class="lineno"> 7262</span>&#160;</div>
<div class="line"><a name="l07263"></a><span class="lineno"> 7263</span>&#160;</div>
<div class="line"><a name="l07264"></a><span class="lineno"> 7264</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07265"></a><span class="lineno"> 7265</span>&#160;        <span class="comment">// Break the ACE into its component parts.</span></div>
<div class="line"><a name="l07266"></a><span class="lineno"> 7266</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07267"></a><span class="lineno"> 7267</span>&#160;        ChildAceFlags = <a class="code" href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb">AceFlagsInAce</a>( ChildAce );</div>
<div class="line"><a name="l07268"></a><span class="lineno"> 7268</span>&#160;        <span class="keywordflow">if</span> ( ChildAceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07269"></a><span class="lineno"> 7269</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask = LocalMask;</div>
<div class="line"><a name="l07270"></a><span class="lineno"> 7270</span>&#160;            ChildAceInfo[ChildAceIndex].ContainerInheritMask = LocalMask;</div>
<div class="line"><a name="l07271"></a><span class="lineno"> 7271</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07272"></a><span class="lineno"> 7272</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask = 0;</div>
<div class="line"><a name="l07273"></a><span class="lineno"> 7273</span>&#160;            ChildAceInfo[ChildAceIndex].ContainerInheritMask = 0;</div>
<div class="line"><a name="l07274"></a><span class="lineno"> 7274</span>&#160;        }</div>
<div class="line"><a name="l07275"></a><span class="lineno"> 7275</span>&#160;</div>
<div class="line"><a name="l07276"></a><span class="lineno"> 7276</span>&#160;        <span class="keywordflow">if</span> ( ChildAceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07277"></a><span class="lineno"> 7277</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask = LocalMask;</div>
<div class="line"><a name="l07278"></a><span class="lineno"> 7278</span>&#160;            ChildAceInfo[ChildAceIndex].ObjectInheritMask = LocalMask;</div>
<div class="line"><a name="l07279"></a><span class="lineno"> 7279</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07280"></a><span class="lineno"> 7280</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask = 0;</div>
<div class="line"><a name="l07281"></a><span class="lineno"> 7281</span>&#160;            ChildAceInfo[ChildAceIndex].ObjectInheritMask = 0;</div>
<div class="line"><a name="l07282"></a><span class="lineno"> 7282</span>&#160;        }</div>
<div class="line"><a name="l07283"></a><span class="lineno"> 7283</span>&#160;</div>
<div class="line"><a name="l07284"></a><span class="lineno"> 7284</span>&#160;        <span class="keywordflow">if</span> ( ChildAceFlags &amp; <a class="code" href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95">EFFECTIVE_ACE</a> ) {</div>
<div class="line"><a name="l07285"></a><span class="lineno"> 7285</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalEffectiveMask = LocalMask;</div>
<div class="line"><a name="l07286"></a><span class="lineno"> 7286</span>&#160;            ChildAceInfo[ChildAceIndex].EffectiveMask = LocalMask;</div>
<div class="line"><a name="l07287"></a><span class="lineno"> 7287</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07288"></a><span class="lineno"> 7288</span>&#160;            ChildAceInfo[ChildAceIndex].OriginalEffectiveMask = 0;</div>
<div class="line"><a name="l07289"></a><span class="lineno"> 7289</span>&#160;            ChildAceInfo[ChildAceIndex].EffectiveMask = 0;</div>
<div class="line"><a name="l07290"></a><span class="lineno"> 7290</span>&#160;        }</div>
<div class="line"><a name="l07291"></a><span class="lineno"> 7291</span>&#160;</div>
<div class="line"><a name="l07292"></a><span class="lineno"> 7292</span>&#160;    }</div>
<div class="line"><a name="l07293"></a><span class="lineno"> 7293</span>&#160;</div>
<div class="line"><a name="l07294"></a><span class="lineno"> 7294</span>&#160;</div>
<div class="line"><a name="l07295"></a><span class="lineno"> 7295</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07296"></a><span class="lineno"> 7296</span>&#160;    <span class="comment">// Walk through the computed inherited ACL one ACE at a time.</span></div>
<div class="line"><a name="l07297"></a><span class="lineno"> 7297</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07298"></a><span class="lineno"> 7298</span>&#160;</div>
<div class="line"><a name="l07299"></a><span class="lineno"> 7299</span>&#160;    <span class="keywordflow">for</span> (InheritedAceIndex = 0, InheritedAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(InheritedAcl);</div>
<div class="line"><a name="l07300"></a><span class="lineno"> 7300</span>&#160;         InheritedAceIndex &lt; InheritedAcl-&gt;<a class="code" href="../../d7/dd4/a00013.html#aaac225aa146d75e9a598696c5c02f5f3">AceCount</a>;</div>
<div class="line"><a name="l07301"></a><span class="lineno"> 7301</span>&#160;         InheritedAceIndex += 1, InheritedAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(InheritedAce)) {</div>
<div class="line"><a name="l07302"></a><span class="lineno"> 7302</span>&#160;</div>
<div class="line"><a name="l07303"></a><span class="lineno"> 7303</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> LocalMask;</div>
<div class="line"><a name="l07304"></a><span class="lineno"> 7304</span>&#160;</div>
<div class="line"><a name="l07305"></a><span class="lineno"> 7305</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07306"></a><span class="lineno"> 7306</span>&#160;        <span class="comment">// If the ACE isn&#39;t a valid version 4 ACE,</span></div>
<div class="line"><a name="l07307"></a><span class="lineno"> 7307</span>&#160;        <span class="comment">//  this isn&#39;t an ACL we&#39;re interested in handling.</span></div>
<div class="line"><a name="l07308"></a><span class="lineno"> 7308</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07309"></a><span class="lineno"> 7309</span>&#160;</div>
<div class="line"><a name="l07310"></a><span class="lineno"> 7310</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#ada772d88133c0c4f43ef15b685f17944">IsV4AceType</a>(InheritedAce) || <a class="code" href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a>(InheritedAce)) {</div>
<div class="line"><a name="l07311"></a><span class="lineno"> 7311</span>&#160;             *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07312"></a><span class="lineno"> 7312</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07313"></a><span class="lineno"> 7313</span>&#160;             <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07314"></a><span class="lineno"> 7314</span>&#160;                 <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Inherited Ace type (%ld) not known\n&quot;</span>, InheritedAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> ));</div>
<div class="line"><a name="l07315"></a><span class="lineno"> 7315</span>&#160;             }</div>
<div class="line"><a name="l07316"></a><span class="lineno"> 7316</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07317"></a><span class="lineno"> 7317</span>&#160;             Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07318"></a><span class="lineno"> 7318</span>&#160;             <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07319"></a><span class="lineno"> 7319</span>&#160;        }</div>
<div class="line"><a name="l07320"></a><span class="lineno"> 7320</span>&#160;</div>
<div class="line"><a name="l07321"></a><span class="lineno"> 7321</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07322"></a><span class="lineno"> 7322</span>&#160;        <span class="comment">// Compute the generic mapped mask for use in all comparisons.  The</span></div>
<div class="line"><a name="l07323"></a><span class="lineno"> 7323</span>&#160;        <span class="comment">//  generic mapping will be undone if needed later.</span></div>
<div class="line"><a name="l07324"></a><span class="lineno"> 7324</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07325"></a><span class="lineno"> 7325</span>&#160;        <span class="comment">// All V4 aces have an access mask in the same location.</span></div>
<div class="line"><a name="l07326"></a><span class="lineno"> 7326</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07327"></a><span class="lineno"> 7327</span>&#160;        LocalMask = ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(InheritedAce))-&gt;Mask;</div>
<div class="line"><a name="l07328"></a><span class="lineno"> 7328</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#a226f8b2aa65758424db1dd0f51011d32">RtlApplyGenericMask</a>( InheritedAce, &amp;LocalMask, GenericMapping);</div>
<div class="line"><a name="l07329"></a><span class="lineno"> 7329</span>&#160;</div>
<div class="line"><a name="l07330"></a><span class="lineno"> 7330</span>&#160;        <span class="keywordflow">if</span> ( LocalMask == 0 ) {</div>
<div class="line"><a name="l07331"></a><span class="lineno"> 7331</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07332"></a><span class="lineno"> 7332</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07333"></a><span class="lineno"> 7333</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Worthless INH ACE: %ld 0x%8.8lx\n&quot;</span>, InheritedAceIndex, LocalMask ));</div>
<div class="line"><a name="l07334"></a><span class="lineno"> 7334</span>&#160;            }</div>
<div class="line"><a name="l07335"></a><span class="lineno"> 7335</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07336"></a><span class="lineno"> 7336</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07337"></a><span class="lineno"> 7337</span>&#160;        }</div>
<div class="line"><a name="l07338"></a><span class="lineno"> 7338</span>&#160;</div>
<div class="line"><a name="l07339"></a><span class="lineno"> 7339</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07340"></a><span class="lineno"> 7340</span>&#160;        <span class="comment">// This ACE is some combination of an effective ACE, a container</span></div>
<div class="line"><a name="l07341"></a><span class="lineno"> 7341</span>&#160;        <span class="comment">//  inherit ACE and an object inherit ACE.  Process each of those</span></div>
<div class="line"><a name="l07342"></a><span class="lineno"> 7342</span>&#160;        <span class="comment">//  attributes separately since they might be represented separately</span></div>
<div class="line"><a name="l07343"></a><span class="lineno"> 7343</span>&#160;        <span class="comment">//  in the ChildAcl.</span></div>
<div class="line"><a name="l07344"></a><span class="lineno"> 7344</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07345"></a><span class="lineno"> 7345</span>&#160;</div>
<div class="line"><a name="l07346"></a><span class="lineno"> 7346</span>&#160;        InheritedAceFlags = <a class="code" href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb">AceFlagsInAce</a>( InheritedAce );</div>
<div class="line"><a name="l07347"></a><span class="lineno"> 7347</span>&#160;</div>
<div class="line"><a name="l07348"></a><span class="lineno"> 7348</span>&#160;        <span class="keywordflow">if</span>  ( InheritedAceFlags == 0 ) {</div>
<div class="line"><a name="l07349"></a><span class="lineno"> 7349</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07350"></a><span class="lineno"> 7350</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07351"></a><span class="lineno"> 7351</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Worthless INH ACE: %ld 0x%lx\n&quot;</span>, InheritedAceIndex, InheritedAceFlags ));</div>
<div class="line"><a name="l07352"></a><span class="lineno"> 7352</span>&#160;            }</div>
<div class="line"><a name="l07353"></a><span class="lineno"> 7353</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07354"></a><span class="lineno"> 7354</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07355"></a><span class="lineno"> 7355</span>&#160;        }</div>
<div class="line"><a name="l07356"></a><span class="lineno"> 7356</span>&#160;</div>
<div class="line"><a name="l07357"></a><span class="lineno"> 7357</span>&#160;        <span class="keywordflow">if</span> ( InheritedAceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07358"></a><span class="lineno"> 7358</span>&#160;            OriginalInheritedContainerInheritMask = InheritedContainerInheritMask = LocalMask;</div>
<div class="line"><a name="l07359"></a><span class="lineno"> 7359</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07360"></a><span class="lineno"> 7360</span>&#160;            OriginalInheritedContainerInheritMask = InheritedContainerInheritMask = 0;</div>
<div class="line"><a name="l07361"></a><span class="lineno"> 7361</span>&#160;        }</div>
<div class="line"><a name="l07362"></a><span class="lineno"> 7362</span>&#160;</div>
<div class="line"><a name="l07363"></a><span class="lineno"> 7363</span>&#160;        <span class="keywordflow">if</span> ( InheritedAceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07364"></a><span class="lineno"> 7364</span>&#160;            OriginalInheritedObjectInheritMask = InheritedObjectInheritMask = LocalMask;</div>
<div class="line"><a name="l07365"></a><span class="lineno"> 7365</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07366"></a><span class="lineno"> 7366</span>&#160;            OriginalInheritedObjectInheritMask = InheritedObjectInheritMask = 0;</div>
<div class="line"><a name="l07367"></a><span class="lineno"> 7367</span>&#160;        }</div>
<div class="line"><a name="l07368"></a><span class="lineno"> 7368</span>&#160;</div>
<div class="line"><a name="l07369"></a><span class="lineno"> 7369</span>&#160;        <span class="keywordflow">if</span> ( InheritedAceFlags &amp; <a class="code" href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95">EFFECTIVE_ACE</a> ) {</div>
<div class="line"><a name="l07370"></a><span class="lineno"> 7370</span>&#160;            OriginalInheritedEffectiveMask = InheritedEffectiveMask = LocalMask;</div>
<div class="line"><a name="l07371"></a><span class="lineno"> 7371</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07372"></a><span class="lineno"> 7372</span>&#160;            OriginalInheritedEffectiveMask = InheritedEffectiveMask = 0;</div>
<div class="line"><a name="l07373"></a><span class="lineno"> 7373</span>&#160;        }</div>
<div class="line"><a name="l07374"></a><span class="lineno"> 7374</span>&#160;</div>
<div class="line"><a name="l07375"></a><span class="lineno"> 7375</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07376"></a><span class="lineno"> 7376</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07377"></a><span class="lineno"> 7377</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Doing INH ACE:  %ld %8.8lX %8.8lX %8.8lX\n&quot;</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));</div>
<div class="line"><a name="l07378"></a><span class="lineno"> 7378</span>&#160;        }</div>
<div class="line"><a name="l07379"></a><span class="lineno"> 7379</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07380"></a><span class="lineno"> 7380</span>&#160;</div>
<div class="line"><a name="l07381"></a><span class="lineno"> 7381</span>&#160;</div>
<div class="line"><a name="l07382"></a><span class="lineno"> 7382</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07383"></a><span class="lineno"> 7383</span>&#160;        <span class="comment">// Loop through the entire child ACL comparing each inherited ACE with</span></div>
<div class="line"><a name="l07384"></a><span class="lineno"> 7384</span>&#160;        <span class="comment">//  each child ACE.  Don&#39;t stop simply because we&#39;ve matched once.</span></div>
<div class="line"><a name="l07385"></a><span class="lineno"> 7385</span>&#160;        <span class="comment">//  Multiple ACEs in the one ACL may have been condensed into a single ACE</span></div>
<div class="line"><a name="l07386"></a><span class="lineno"> 7386</span>&#160;        <span class="comment">//  in the other ACL in any combination (by any of our friendly ACL editors).</span></div>
<div class="line"><a name="l07387"></a><span class="lineno"> 7387</span>&#160;        <span class="comment">//  In all cases, it is better to compute a resultant auto inherited ACL</span></div>
<div class="line"><a name="l07388"></a><span class="lineno"> 7388</span>&#160;        <span class="comment">//  than it is to compute a protected ACL.</span></div>
<div class="line"><a name="l07389"></a><span class="lineno"> 7389</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07390"></a><span class="lineno"> 7390</span>&#160;</div>
<div class="line"><a name="l07391"></a><span class="lineno"> 7391</span>&#160;        <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(ChildAcl);</div>
<div class="line"><a name="l07392"></a><span class="lineno"> 7392</span>&#160;             ChildAceIndex &lt; ChildAcl-&gt;AceCount;</div>
<div class="line"><a name="l07393"></a><span class="lineno"> 7393</span>&#160;             ChildAceIndex += 1, ChildAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(ChildAce)) {</div>
<div class="line"><a name="l07394"></a><span class="lineno"> 7394</span>&#160;</div>
<div class="line"><a name="l07395"></a><span class="lineno"> 7395</span>&#160;</div>
<div class="line"><a name="l07396"></a><span class="lineno"> 7396</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07397"></a><span class="lineno"> 7397</span>&#160;            <span class="comment">// Ensure the ACE represents the same principal and object,</span></div>
<div class="line"><a name="l07398"></a><span class="lineno"> 7398</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07399"></a><span class="lineno"> 7399</span>&#160;</div>
<div class="line"><a name="l07400"></a><span class="lineno"> 7400</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07401"></a><span class="lineno"> 7401</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07402"></a><span class="lineno"> 7402</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Compare Child Ace: %ld &quot;</span>, ChildAceIndex ));</div>
<div class="line"><a name="l07403"></a><span class="lineno"> 7403</span>&#160;            }</div>
<div class="line"><a name="l07404"></a><span class="lineno"> 7404</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07405"></a><span class="lineno"> 7405</span>&#160;</div>
<div class="line"><a name="l07406"></a><span class="lineno"> 7406</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed">RtlpCompareAces</a>( InheritedAce,</div>
<div class="line"><a name="l07407"></a><span class="lineno"> 7407</span>&#160;                                   ChildAce,</div>
<div class="line"><a name="l07408"></a><span class="lineno"> 7408</span>&#160;                                   OwnerSid,</div>
<div class="line"><a name="l07409"></a><span class="lineno"> 7409</span>&#160;                                   GroupSid ) ) {</div>
<div class="line"><a name="l07410"></a><span class="lineno"> 7410</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07411"></a><span class="lineno"> 7411</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07412"></a><span class="lineno"> 7412</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;\n&quot;</span> ));</div>
<div class="line"><a name="l07413"></a><span class="lineno"> 7413</span>&#160;                }</div>
<div class="line"><a name="l07414"></a><span class="lineno"> 7414</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07415"></a><span class="lineno"> 7415</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07416"></a><span class="lineno"> 7416</span>&#160;            }</div>
<div class="line"><a name="l07417"></a><span class="lineno"> 7417</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07418"></a><span class="lineno"> 7418</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07419"></a><span class="lineno"> 7419</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;\n&quot;</span> ));</div>
<div class="line"><a name="l07420"></a><span class="lineno"> 7420</span>&#160;            }</div>
<div class="line"><a name="l07421"></a><span class="lineno"> 7421</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07422"></a><span class="lineno"> 7422</span>&#160;</div>
<div class="line"><a name="l07423"></a><span class="lineno"> 7423</span>&#160;</div>
<div class="line"><a name="l07424"></a><span class="lineno"> 7424</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07425"></a><span class="lineno"> 7425</span>&#160;            <span class="comment">// Match as many access bits in the INH ACE as possible.</span></div>
<div class="line"><a name="l07426"></a><span class="lineno"> 7426</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07427"></a><span class="lineno"> 7427</span>&#160;            <span class="comment">// Don&#39;t pay any attention to whether the bits have been previously matched</span></div>
<div class="line"><a name="l07428"></a><span class="lineno"> 7428</span>&#160;            <span class="comment">// in the CHILD ACE.  To do so, would imply that there is a one-to-one</span></div>
<div class="line"><a name="l07429"></a><span class="lineno"> 7429</span>&#160;            <span class="comment">// correspondance between bits in the INH ACL and Child ACL.  Unfortunately,</span></div>
<div class="line"><a name="l07430"></a><span class="lineno"> 7430</span>&#160;            <span class="comment">// ACL editors feel free to compress out duplicate bits in both</span></div>
<div class="line"><a name="l07431"></a><span class="lineno"> 7431</span>&#160;            <span class="comment">// the CHILD ACL and PARENT ACL as they see fit.</span></div>
<div class="line"><a name="l07432"></a><span class="lineno"> 7432</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07433"></a><span class="lineno"> 7433</span>&#160;</div>
<div class="line"><a name="l07434"></a><span class="lineno"> 7434</span>&#160;            InheritedEffectiveMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalEffectiveMask;</div>
<div class="line"><a name="l07435"></a><span class="lineno"> 7435</span>&#160;            InheritedContainerInheritMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask;</div>
<div class="line"><a name="l07436"></a><span class="lineno"> 7436</span>&#160;            InheritedObjectInheritMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask;</div>
<div class="line"><a name="l07437"></a><span class="lineno"> 7437</span>&#160;</div>
<div class="line"><a name="l07438"></a><span class="lineno"> 7438</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07439"></a><span class="lineno"> 7439</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07440"></a><span class="lineno"> 7440</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;New   INH MASKs %ld %8.8lX %8.8lX %8.8lX\n&quot;</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));</div>
<div class="line"><a name="l07441"></a><span class="lineno"> 7441</span>&#160;            }</div>
<div class="line"><a name="l07442"></a><span class="lineno"> 7442</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07443"></a><span class="lineno"> 7443</span>&#160;</div>
<div class="line"><a name="l07444"></a><span class="lineno"> 7444</span>&#160;</div>
<div class="line"><a name="l07445"></a><span class="lineno"> 7445</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07446"></a><span class="lineno"> 7446</span>&#160;            <span class="comment">// Match as many access bits in the child ACE as possible.</span></div>
<div class="line"><a name="l07447"></a><span class="lineno"> 7447</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07448"></a><span class="lineno"> 7448</span>&#160;            <span class="comment">// Same reasoning as above.</span></div>
<div class="line"><a name="l07449"></a><span class="lineno"> 7449</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07450"></a><span class="lineno"> 7450</span>&#160;</div>
<div class="line"><a name="l07451"></a><span class="lineno"> 7451</span>&#160;            ChildAceInfo[ChildAceIndex].EffectiveMask &amp;= ~OriginalInheritedEffectiveMask;</div>
<div class="line"><a name="l07452"></a><span class="lineno"> 7452</span>&#160;            ChildAceInfo[ChildAceIndex].ContainerInheritMask &amp;= ~OriginalInheritedContainerInheritMask;</div>
<div class="line"><a name="l07453"></a><span class="lineno"> 7453</span>&#160;            ChildAceInfo[ChildAceIndex].ObjectInheritMask &amp;= ~OriginalInheritedObjectInheritMask;</div>
<div class="line"><a name="l07454"></a><span class="lineno"> 7454</span>&#160;</div>
<div class="line"><a name="l07455"></a><span class="lineno"> 7455</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07456"></a><span class="lineno"> 7456</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07457"></a><span class="lineno"> 7457</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;New Child MASKs %ld %8.8lX %8.8lX %8.8lX\n&quot;</span>, ChildAceIndex, ChildAceInfo[ChildAceIndex].EffectiveMask, ChildAceInfo[ChildAceIndex].ContainerInheritMask, ChildAceInfo[ChildAceIndex].ObjectInheritMask ));</div>
<div class="line"><a name="l07458"></a><span class="lineno"> 7458</span>&#160;            }</div>
<div class="line"><a name="l07459"></a><span class="lineno"> 7459</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07460"></a><span class="lineno"> 7460</span>&#160;</div>
<div class="line"><a name="l07461"></a><span class="lineno"> 7461</span>&#160;        }</div>
<div class="line"><a name="l07462"></a><span class="lineno"> 7462</span>&#160;</div>
<div class="line"><a name="l07463"></a><span class="lineno"> 7463</span>&#160;</div>
<div class="line"><a name="l07464"></a><span class="lineno"> 7464</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07465"></a><span class="lineno"> 7465</span>&#160;        <span class="comment">// If we couldn&#39;t process this inherited ACE,</span></div>
<div class="line"><a name="l07466"></a><span class="lineno"> 7466</span>&#160;        <span class="comment">//  then the child ACL wasn&#39;t inherited.</span></div>
<div class="line"><a name="l07467"></a><span class="lineno"> 7467</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07468"></a><span class="lineno"> 7468</span>&#160;</div>
<div class="line"><a name="l07469"></a><span class="lineno"> 7469</span>&#160;        <span class="keywordflow">if</span> ( (InheritedEffectiveMask | InheritedContainerInheritMask | InheritedObjectInheritMask) != 0 ) {</div>
<div class="line"><a name="l07470"></a><span class="lineno"> 7470</span>&#160;            *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07471"></a><span class="lineno"> 7471</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07472"></a><span class="lineno"> 7472</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07473"></a><span class="lineno"> 7473</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;INH ACE not completely matched: %ld %8.8lX %8.8lX %8.8lX\n&quot;</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));</div>
<div class="line"><a name="l07474"></a><span class="lineno"> 7474</span>&#160;            }</div>
<div class="line"><a name="l07475"></a><span class="lineno"> 7475</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07476"></a><span class="lineno"> 7476</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07477"></a><span class="lineno"> 7477</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07478"></a><span class="lineno"> 7478</span>&#160;        }</div>
<div class="line"><a name="l07479"></a><span class="lineno"> 7479</span>&#160;</div>
<div class="line"><a name="l07480"></a><span class="lineno"> 7480</span>&#160;</div>
<div class="line"><a name="l07481"></a><span class="lineno"> 7481</span>&#160;    }</div>
<div class="line"><a name="l07482"></a><span class="lineno"> 7482</span>&#160;</div>
<div class="line"><a name="l07483"></a><span class="lineno"> 7483</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07484"></a><span class="lineno"> 7484</span>&#160;    <span class="comment">// ASSERT: All of the inherited ACEs have been processed.</span></div>
<div class="line"><a name="l07485"></a><span class="lineno"> 7485</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07486"></a><span class="lineno"> 7486</span>&#160;</div>
<div class="line"><a name="l07487"></a><span class="lineno"> 7487</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07488"></a><span class="lineno"> 7488</span>&#160;    <span class="comment">// Loop through the Child ACL ensuring we can build a valid auto inherited ACL</span></div>
<div class="line"><a name="l07489"></a><span class="lineno"> 7489</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07490"></a><span class="lineno"> 7490</span>&#160;</div>
<div class="line"><a name="l07491"></a><span class="lineno"> 7491</span>&#160;    InheritedAllowFound = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l07492"></a><span class="lineno"> 7492</span>&#160;    InheritedDenyFound = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l07493"></a><span class="lineno"> 7493</span>&#160;    NonInheritedAclSize = 0;</div>
<div class="line"><a name="l07494"></a><span class="lineno"> 7494</span>&#160;    <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(ChildAcl);</div>
<div class="line"><a name="l07495"></a><span class="lineno"> 7495</span>&#160;         ChildAceIndex &lt; ChildAcl-&gt;AceCount;</div>
<div class="line"><a name="l07496"></a><span class="lineno"> 7496</span>&#160;         ChildAceIndex += 1, ChildAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(ChildAce)) {</div>
<div class="line"><a name="l07497"></a><span class="lineno"> 7497</span>&#160;</div>
<div class="line"><a name="l07498"></a><span class="lineno"> 7498</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> ResultantMask;</div>
<div class="line"><a name="l07499"></a><span class="lineno"> 7499</span>&#160;</div>
<div class="line"><a name="l07500"></a><span class="lineno"> 7500</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07501"></a><span class="lineno"> 7501</span>&#160;        <span class="comment">// Any Child ACE access bits not eliminated above required than an</span></div>
<div class="line"><a name="l07502"></a><span class="lineno"> 7502</span>&#160;        <span class="comment">//  explicit non-inherited ACE by built.  That ACE will have an</span></div>
<div class="line"><a name="l07503"></a><span class="lineno"> 7503</span>&#160;        <span class="comment">//  access mask that is the combined access mask of the unmatched bit</span></div>
<div class="line"><a name="l07504"></a><span class="lineno"> 7504</span>&#160;        <span class="comment">//  in the effective, container inherit, and object inherit categories.</span></div>
<div class="line"><a name="l07505"></a><span class="lineno"> 7505</span>&#160;        <span class="comment">//  Even though, the combined mask may include access bits not absolutely</span></div>
<div class="line"><a name="l07506"></a><span class="lineno"> 7506</span>&#160;        <span class="comment">//  required (since they were already inherited), this strategy prevents</span></div>
<div class="line"><a name="l07507"></a><span class="lineno"> 7507</span>&#160;        <span class="comment">//  us from having to build multiple ACEs (one for each category) for this</span></div>
<div class="line"><a name="l07508"></a><span class="lineno"> 7508</span>&#160;        <span class="comment">//  single ACE.</span></div>
<div class="line"><a name="l07509"></a><span class="lineno"> 7509</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07510"></a><span class="lineno"> 7510</span>&#160;</div>
<div class="line"><a name="l07511"></a><span class="lineno"> 7511</span>&#160;        ResultantMask =</div>
<div class="line"><a name="l07512"></a><span class="lineno"> 7512</span>&#160;            ChildAceInfo[ChildAceIndex].EffectiveMask |</div>
<div class="line"><a name="l07513"></a><span class="lineno"> 7513</span>&#160;            ChildAceInfo[ChildAceIndex].ContainerInheritMask |</div>
<div class="line"><a name="l07514"></a><span class="lineno"> 7514</span>&#160;            ChildAceInfo[ChildAceIndex].ObjectInheritMask;</div>
<div class="line"><a name="l07515"></a><span class="lineno"> 7515</span>&#160;</div>
<div class="line"><a name="l07516"></a><span class="lineno"> 7516</span>&#160;</div>
<div class="line"><a name="l07517"></a><span class="lineno"> 7517</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07518"></a><span class="lineno"> 7518</span>&#160;        <span class="comment">// Handle an inherited ACE</span></div>
<div class="line"><a name="l07519"></a><span class="lineno"> 7519</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07520"></a><span class="lineno"> 7520</span>&#160;</div>
<div class="line"><a name="l07521"></a><span class="lineno"> 7521</span>&#160;        <span class="keywordflow">if</span> ( ResultantMask == 0 ) {</div>
<div class="line"><a name="l07522"></a><span class="lineno"> 7522</span>&#160;</div>
<div class="line"><a name="l07523"></a><span class="lineno"> 7523</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07524"></a><span class="lineno"> 7524</span>&#160;            <span class="comment">// Keep track of whether inherited &quot;allow&quot; and &quot;deny&quot; ACEs are found.</span></div>
<div class="line"><a name="l07525"></a><span class="lineno"> 7525</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07526"></a><span class="lineno"> 7526</span>&#160;</div>
<div class="line"><a name="l07527"></a><span class="lineno"> 7527</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] == <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a> ) {</div>
<div class="line"><a name="l07528"></a><span class="lineno"> 7528</span>&#160;                InheritedAllowFound = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l07529"></a><span class="lineno"> 7529</span>&#160;            }</div>
<div class="line"><a name="l07530"></a><span class="lineno"> 7530</span>&#160;</div>
<div class="line"><a name="l07531"></a><span class="lineno"> 7531</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] == <a class="code" href="../../d3/d3a/a02259.html#a9081b9116c6cf606b4ccbee0ece39f5d">ACCESS_DENIED_ACE_TYPE</a> ) {</div>
<div class="line"><a name="l07532"></a><span class="lineno"> 7532</span>&#160;                InheritedDenyFound = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l07533"></a><span class="lineno"> 7533</span>&#160;            }</div>
<div class="line"><a name="l07534"></a><span class="lineno"> 7534</span>&#160;</div>
<div class="line"><a name="l07535"></a><span class="lineno"> 7535</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07536"></a><span class="lineno"> 7536</span>&#160;        <span class="comment">// Handle a non-inherited ACE</span></div>
<div class="line"><a name="l07537"></a><span class="lineno"> 7537</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07538"></a><span class="lineno"> 7538</span>&#160;</div>
<div class="line"><a name="l07539"></a><span class="lineno"> 7539</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07540"></a><span class="lineno"> 7540</span>&#160;</div>
<div class="line"><a name="l07541"></a><span class="lineno"> 7541</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07542"></a><span class="lineno"> 7542</span>&#160;            <span class="comment">// Keep a running tab of the size of the non-inherited ACEs.</span></div>
<div class="line"><a name="l07543"></a><span class="lineno"> 7543</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07544"></a><span class="lineno"> 7544</span>&#160;</div>
<div class="line"><a name="l07545"></a><span class="lineno"> 7545</span>&#160;            NonInheritedAclSize += ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a>;</div>
<div class="line"><a name="l07546"></a><span class="lineno"> 7546</span>&#160;</div>
<div class="line"><a name="l07547"></a><span class="lineno"> 7547</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07548"></a><span class="lineno"> 7548</span>&#160;            <span class="comment">// Since non-inherited ACEs will be moved to the front of the ACL,</span></div>
<div class="line"><a name="l07549"></a><span class="lineno"> 7549</span>&#160;            <span class="comment">//  we have to be careful that we don&#39;t move a deny ACE in front of a</span></div>
<div class="line"><a name="l07550"></a><span class="lineno"> 7550</span>&#160;            <span class="comment">//  previously found inherited allow ACE (and vice-versa).  To do so would</span></div>
<div class="line"><a name="l07551"></a><span class="lineno"> 7551</span>&#160;            <span class="comment">//  change the semantics of the ACL.</span></div>
<div class="line"><a name="l07552"></a><span class="lineno"> 7552</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07553"></a><span class="lineno"> 7553</span>&#160;</div>
<div class="line"><a name="l07554"></a><span class="lineno"> 7554</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] == <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a> &amp;&amp; InheritedDenyFound ) {</div>
<div class="line"><a name="l07555"></a><span class="lineno"> 7555</span>&#160;                *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07556"></a><span class="lineno"> 7556</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07557"></a><span class="lineno"> 7557</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07558"></a><span class="lineno"> 7558</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Previous deny found Child ACE: %ld\n&quot;</span>, ChildAceIndex ));</div>
<div class="line"><a name="l07559"></a><span class="lineno"> 7559</span>&#160;                }</div>
<div class="line"><a name="l07560"></a><span class="lineno"> 7560</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07561"></a><span class="lineno"> 7561</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07562"></a><span class="lineno"> 7562</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07563"></a><span class="lineno"> 7563</span>&#160;            }</div>
<div class="line"><a name="l07564"></a><span class="lineno"> 7564</span>&#160;</div>
<div class="line"><a name="l07565"></a><span class="lineno"> 7565</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a>[ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a>] == <a class="code" href="../../d3/d3a/a02259.html#a9081b9116c6cf606b4ccbee0ece39f5d">ACCESS_DENIED_ACE_TYPE</a> &amp;&amp; InheritedAllowFound ) {</div>
<div class="line"><a name="l07566"></a><span class="lineno"> 7566</span>&#160;                *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07567"></a><span class="lineno"> 7567</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07568"></a><span class="lineno"> 7568</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07569"></a><span class="lineno"> 7569</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Previous allow found Child ACE: %ld\n&quot;</span>, ChildAceIndex ));</div>
<div class="line"><a name="l07570"></a><span class="lineno"> 7570</span>&#160;                }</div>
<div class="line"><a name="l07571"></a><span class="lineno"> 7571</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07572"></a><span class="lineno"> 7572</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07573"></a><span class="lineno"> 7573</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07574"></a><span class="lineno"> 7574</span>&#160;            }</div>
<div class="line"><a name="l07575"></a><span class="lineno"> 7575</span>&#160;</div>
<div class="line"><a name="l07576"></a><span class="lineno"> 7576</span>&#160;        }</div>
<div class="line"><a name="l07577"></a><span class="lineno"> 7577</span>&#160;</div>
<div class="line"><a name="l07578"></a><span class="lineno"> 7578</span>&#160;    }</div>
<div class="line"><a name="l07579"></a><span class="lineno"> 7579</span>&#160;</div>
<div class="line"><a name="l07580"></a><span class="lineno"> 7580</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07581"></a><span class="lineno"> 7581</span>&#160;    <span class="comment">// The resultant ACL is composed of the non-inherited ACEs followed by</span></div>
<div class="line"><a name="l07582"></a><span class="lineno"> 7582</span>&#160;    <span class="comment">// the inherited ACE. The inherited ACEs are built by running the</span></div>
<div class="line"><a name="l07583"></a><span class="lineno"> 7583</span>&#160;    <span class="comment">// inheritance algorithm over the Parent ACL.</span></div>
<div class="line"><a name="l07584"></a><span class="lineno"> 7584</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07585"></a><span class="lineno"> 7585</span>&#160;    <span class="comment">// The Inherited ACL computed below is almost identical to InheritedAcl.</span></div>
<div class="line"><a name="l07586"></a><span class="lineno"> 7586</span>&#160;    <span class="comment">// However, InheritedAcl didn&#39;t properly substitute the correct owner and</span></div>
<div class="line"><a name="l07587"></a><span class="lineno"> 7587</span>&#160;    <span class="comment">// group SID.</span></div>
<div class="line"><a name="l07588"></a><span class="lineno"> 7588</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07589"></a><span class="lineno"> 7589</span>&#160;</div>
<div class="line"><a name="l07590"></a><span class="lineno"> 7590</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a> (</div>
<div class="line"><a name="l07591"></a><span class="lineno"> 7591</span>&#160;                ParentAcl,</div>
<div class="line"><a name="l07592"></a><span class="lineno"> 7592</span>&#160;                NULL,   <span class="comment">// No explicit child ACL</span></div>
<div class="line"><a name="l07593"></a><span class="lineno"> 7593</span>&#160;                0,      <span class="comment">// No Child Generic Control</span></div>
<div class="line"><a name="l07594"></a><span class="lineno"> 7594</span>&#160;                IsDirectoryObject,</div>
<div class="line"><a name="l07595"></a><span class="lineno"> 7595</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,   <span class="comment">// AutoInherit the DACL</span></div>
<div class="line"><a name="l07596"></a><span class="lineno"> 7596</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,  <span class="comment">// Not default descriptor for object</span></div>
<div class="line"><a name="l07597"></a><span class="lineno"> 7597</span>&#160;                OwnerSid,   <span class="comment">// Subsitute a constant SID</span></div>
<div class="line"><a name="l07598"></a><span class="lineno"> 7598</span>&#160;                GroupSid,   <span class="comment">// Subsitute a constant SID</span></div>
<div class="line"><a name="l07599"></a><span class="lineno"> 7599</span>&#160;                OwnerSid,   <span class="comment">// Server Owner (Technically incorrect, but OK since we don&#39;t support compound ACEs)</span></div>
<div class="line"><a name="l07600"></a><span class="lineno"> 7600</span>&#160;                GroupSid,   <span class="comment">// Server Group</span></div>
<div class="line"><a name="l07601"></a><span class="lineno"> 7601</span>&#160;                GenericMapping,</div>
<div class="line"><a name="l07602"></a><span class="lineno"> 7602</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,   <span class="comment">// Is a SACL</span></div>
<div class="line"><a name="l07603"></a><span class="lineno"> 7603</span>&#160;                ObjectType ? &amp;ObjectType : NULL, </div>
<div class="line"><a name="l07604"></a><span class="lineno"> 7604</span>&#160;                ObjectType ? 1 : 0,</div>
<div class="line"><a name="l07605"></a><span class="lineno"> 7605</span>&#160;                &amp;RealInheritedAcl,</div>
<div class="line"><a name="l07606"></a><span class="lineno"> 7606</span>&#160;                &amp;AclExplicitlyAssigned,</div>
<div class="line"><a name="l07607"></a><span class="lineno"> 7607</span>&#160;                &amp;GenericControl );</div>
<div class="line"><a name="l07608"></a><span class="lineno"> 7608</span>&#160;</div>
<div class="line"><a name="l07609"></a><span class="lineno"> 7609</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07610"></a><span class="lineno"> 7610</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07611"></a><span class="lineno"> 7611</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07612"></a><span class="lineno"> 7612</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Can&#39;t build real inherited ACL %lX\n&quot;</span>, Status ));</div>
<div class="line"><a name="l07613"></a><span class="lineno"> 7613</span>&#160;        }</div>
<div class="line"><a name="l07614"></a><span class="lineno"> 7614</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07615"></a><span class="lineno"> 7615</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07616"></a><span class="lineno"> 7616</span>&#160;    }</div>
<div class="line"><a name="l07617"></a><span class="lineno"> 7617</span>&#160;</div>
<div class="line"><a name="l07618"></a><span class="lineno"> 7618</span>&#160;</div>
<div class="line"><a name="l07619"></a><span class="lineno"> 7619</span>&#160;</div>
<div class="line"><a name="l07620"></a><span class="lineno"> 7620</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07621"></a><span class="lineno"> 7621</span>&#160;    <span class="comment">// Allocate a buffer for the inherited ACL</span></div>
<div class="line"><a name="l07622"></a><span class="lineno"> 7622</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07623"></a><span class="lineno"> 7623</span>&#160;</div>
<div class="line"><a name="l07624"></a><span class="lineno"> 7624</span>&#160;    *NewAcl = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l07625"></a><span class="lineno"> 7625</span>&#160;                        <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l07626"></a><span class="lineno"> 7626</span>&#160;                        RealInheritedAcl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> + NonInheritedAclSize,</div>
<div class="line"><a name="l07627"></a><span class="lineno"> 7627</span>&#160;                        <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l07628"></a><span class="lineno"> 7628</span>&#160;</div>
<div class="line"><a name="l07629"></a><span class="lineno"> 7629</span>&#160;    <span class="keywordflow">if</span> ( *NewAcl == NULL ) {</div>
<div class="line"><a name="l07630"></a><span class="lineno"> 7630</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a>;</div>
<div class="line"><a name="l07631"></a><span class="lineno"> 7631</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07632"></a><span class="lineno"> 7632</span>&#160;    }</div>
<div class="line"><a name="l07633"></a><span class="lineno"> 7633</span>&#160;</div>
<div class="line"><a name="l07634"></a><span class="lineno"> 7634</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07635"></a><span class="lineno"> 7635</span>&#160;    <span class="comment">// All non-inherited ACEs are copied first.</span></div>
<div class="line"><a name="l07636"></a><span class="lineno"> 7636</span>&#160;    <span class="comment">// The inherited ACES are grabbed from real inherited ACL.</span></div>
<div class="line"><a name="l07637"></a><span class="lineno"> 7637</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07638"></a><span class="lineno"> 7638</span>&#160;    <span class="comment">// Build an ACL Header.</span></div>
<div class="line"><a name="l07639"></a><span class="lineno"> 7639</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07640"></a><span class="lineno"> 7640</span>&#160;</div>
<div class="line"><a name="l07641"></a><span class="lineno"> 7641</span>&#160;    Status = <a class="code" href="../../de/dc3/a02256.html#af4ddb38f27ea43e90252a906ffdd84c1">RtlCreateAcl</a>( *NewAcl,</div>
<div class="line"><a name="l07642"></a><span class="lineno"> 7642</span>&#160;                           RealInheritedAcl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> + NonInheritedAclSize,</div>
<div class="line"><a name="l07643"></a><span class="lineno"> 7643</span>&#160;                           <a class="code" href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a>( RealInheritedAcl-&gt;<a class="code" href="../../d7/dd4/a00013.html#af0530f532005a2073a721e492f92afd1">AclRevision</a>, ChildAcl-&gt;AclRevision ) );</div>
<div class="line"><a name="l07644"></a><span class="lineno"> 7644</span>&#160;</div>
<div class="line"><a name="l07645"></a><span class="lineno"> 7645</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07646"></a><span class="lineno"> 7646</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07647"></a><span class="lineno"> 7647</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07648"></a><span class="lineno"> 7648</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Can&#39;t create final ACL %lX\n&quot;</span>, Status ));</div>
<div class="line"><a name="l07649"></a><span class="lineno"> 7649</span>&#160;        }</div>
<div class="line"><a name="l07650"></a><span class="lineno"> 7650</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07651"></a><span class="lineno"> 7651</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07652"></a><span class="lineno"> 7652</span>&#160;        <span class="comment">// The only reason for failure would be if the combined ACL is too large.</span></div>
<div class="line"><a name="l07653"></a><span class="lineno"> 7653</span>&#160;        <span class="comment">// So just create a protected ACL (better than a failure).</span></div>
<div class="line"><a name="l07654"></a><span class="lineno"> 7654</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07655"></a><span class="lineno"> 7655</span>&#160;        *NewGenericControl |= <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a>;</div>
<div class="line"><a name="l07656"></a><span class="lineno"> 7656</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07657"></a><span class="lineno"> 7657</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07658"></a><span class="lineno"> 7658</span>&#160;    }</div>
<div class="line"><a name="l07659"></a><span class="lineno"> 7659</span>&#160;</div>
<div class="line"><a name="l07660"></a><span class="lineno"> 7660</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07661"></a><span class="lineno"> 7661</span>&#160;    <span class="comment">// Copy the non-inherited ACES.</span></div>
<div class="line"><a name="l07662"></a><span class="lineno"> 7662</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07663"></a><span class="lineno"> 7663</span>&#160;</div>
<div class="line"><a name="l07664"></a><span class="lineno"> 7664</span>&#160;    Where = ((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)(*NewAcl)) + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/dd4/a00013.html">ACL</a>);</div>
<div class="line"><a name="l07665"></a><span class="lineno"> 7665</span>&#160;    <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(ChildAcl);</div>
<div class="line"><a name="l07666"></a><span class="lineno"> 7666</span>&#160;         ChildAceIndex &lt; ChildAcl-&gt;AceCount;</div>
<div class="line"><a name="l07667"></a><span class="lineno"> 7667</span>&#160;         ChildAceIndex += 1, ChildAce = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(ChildAce)) {</div>
<div class="line"><a name="l07668"></a><span class="lineno"> 7668</span>&#160;</div>
<div class="line"><a name="l07669"></a><span class="lineno"> 7669</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> ResultantMask;</div>
<div class="line"><a name="l07670"></a><span class="lineno"> 7670</span>&#160;</div>
<div class="line"><a name="l07671"></a><span class="lineno"> 7671</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07672"></a><span class="lineno"> 7672</span>&#160;        <span class="comment">// Copy the non-inherited ACE from the Child only if there&#39;s a non-zero access mask.</span></div>
<div class="line"><a name="l07673"></a><span class="lineno"> 7673</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07674"></a><span class="lineno"> 7674</span>&#160;</div>
<div class="line"><a name="l07675"></a><span class="lineno"> 7675</span>&#160;        ResultantMask =</div>
<div class="line"><a name="l07676"></a><span class="lineno"> 7676</span>&#160;            ChildAceInfo[ChildAceIndex].EffectiveMask |</div>
<div class="line"><a name="l07677"></a><span class="lineno"> 7677</span>&#160;            ChildAceInfo[ChildAceIndex].ContainerInheritMask |</div>
<div class="line"><a name="l07678"></a><span class="lineno"> 7678</span>&#160;            ChildAceInfo[ChildAceIndex].ObjectInheritMask;</div>
<div class="line"><a name="l07679"></a><span class="lineno"> 7679</span>&#160;</div>
<div class="line"><a name="l07680"></a><span class="lineno"> 7680</span>&#160;        <span class="keywordflow">if</span> ( ResultantMask != 0 ) {</div>
<div class="line"><a name="l07681"></a><span class="lineno"> 7681</span>&#160;            <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> NewAce;</div>
<div class="line"><a name="l07682"></a><span class="lineno"> 7682</span>&#160;            <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GenericBitToTry;</div>
<div class="line"><a name="l07683"></a><span class="lineno"> 7683</span>&#160;</div>
<div class="line"><a name="l07684"></a><span class="lineno"> 7684</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07685"></a><span class="lineno"> 7685</span>&#160;            <span class="comment">// Use the original ChildAce as the template.</span></div>
<div class="line"><a name="l07686"></a><span class="lineno"> 7686</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07687"></a><span class="lineno"> 7687</span>&#160;</div>
<div class="line"><a name="l07688"></a><span class="lineno"> 7688</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Where, ChildAce, ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a> );</div>
<div class="line"><a name="l07689"></a><span class="lineno"> 7689</span>&#160;            NewAce = (<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)Where;</div>
<div class="line"><a name="l07690"></a><span class="lineno"> 7690</span>&#160;            NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a>;  <span class="comment">// Clear stray bits</span></div>
<div class="line"><a name="l07691"></a><span class="lineno"> 7691</span>&#160;            Where += ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a>;</div>
<div class="line"><a name="l07692"></a><span class="lineno"> 7692</span>&#160;</div>
<div class="line"><a name="l07693"></a><span class="lineno"> 7693</span>&#160;            (*NewAcl)-&gt;AceCount ++;</div>
<div class="line"><a name="l07694"></a><span class="lineno"> 7694</span>&#160;</div>
<div class="line"><a name="l07695"></a><span class="lineno"> 7695</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07696"></a><span class="lineno"> 7696</span>&#160;            <span class="comment">// The AccessMask on the ACE are those access bits that didn&#39;t get matched</span></div>
<div class="line"><a name="l07697"></a><span class="lineno"> 7697</span>&#160;            <span class="comment">//  by inherited ACEs.</span></div>
<div class="line"><a name="l07698"></a><span class="lineno"> 7698</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07699"></a><span class="lineno"> 7699</span>&#160;</div>
<div class="line"><a name="l07700"></a><span class="lineno"> 7700</span>&#160;            NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a> = ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a> &amp; ResultantMask;</div>
<div class="line"><a name="l07701"></a><span class="lineno"> 7701</span>&#160;            ResultantMask &amp;= ~ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a>;</div>
<div class="line"><a name="l07702"></a><span class="lineno"> 7702</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07703"></a><span class="lineno"> 7703</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07704"></a><span class="lineno"> 7704</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Original non-inherited: %ld %8.8lX %8.8lX\n&quot;</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a>, ResultantMask ));</div>
<div class="line"><a name="l07705"></a><span class="lineno"> 7705</span>&#160;            }</div>
<div class="line"><a name="l07706"></a><span class="lineno"> 7706</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07707"></a><span class="lineno"> 7707</span>&#160;</div>
<div class="line"><a name="l07708"></a><span class="lineno"> 7708</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07709"></a><span class="lineno"> 7709</span>&#160;            <span class="comment">// Map any remaining bits back to generic access bits.</span></div>
<div class="line"><a name="l07710"></a><span class="lineno"> 7710</span>&#160;            <span class="comment">// Doing so might expand the ResultantMask to beyond what was computed above.</span></div>
<div class="line"><a name="l07711"></a><span class="lineno"> 7711</span>&#160;            <span class="comment">// Doing so will never expand the computed ACE to beyond what the original</span></div>
<div class="line"><a name="l07712"></a><span class="lineno"> 7712</span>&#160;            <span class="comment">//  ChildAce granted.</span></div>
<div class="line"><a name="l07713"></a><span class="lineno"> 7713</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07714"></a><span class="lineno"> 7714</span>&#160;</div>
<div class="line"><a name="l07715"></a><span class="lineno"> 7715</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../d3/d3a/a02259.html#ae7a3106c6bef5edbff79f9e203c7ccf4">GENERIC_WRITE</a> == (<a class="code" href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a> &gt;&gt; 1));</div>
<div class="line"><a name="l07716"></a><span class="lineno"> 7716</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../d3/d3a/a02259.html#af61ec68f6a67fc6167e4eabd117b2b3b">GENERIC_EXECUTE</a> == (<a class="code" href="../../d3/d3a/a02259.html#ae7a3106c6bef5edbff79f9e203c7ccf4">GENERIC_WRITE</a> &gt;&gt; 1));</div>
<div class="line"><a name="l07717"></a><span class="lineno"> 7717</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../d3/d3a/a02259.html#aad70cf4262d42fc67104c6d9bb407cd4">GENERIC_ALL</a> == (<a class="code" href="../../d3/d3a/a02259.html#af61ec68f6a67fc6167e4eabd117b2b3b">GENERIC_EXECUTE</a> &gt;&gt; 1));</div>
<div class="line"><a name="l07718"></a><span class="lineno"> 7718</span>&#160;</div>
<div class="line"><a name="l07719"></a><span class="lineno"> 7719</span>&#160;            GenericBitToTry = <a class="code" href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a>;</div>
<div class="line"><a name="l07720"></a><span class="lineno"> 7720</span>&#160;</div>
<div class="line"><a name="l07721"></a><span class="lineno"> 7721</span>&#160;            <span class="keywordflow">while</span> ( ResultantMask &amp;&amp; GenericBitToTry &gt;= <a class="code" href="../../d3/d3a/a02259.html#aad70cf4262d42fc67104c6d9bb407cd4">GENERIC_ALL</a> ) {</div>
<div class="line"><a name="l07722"></a><span class="lineno"> 7722</span>&#160;</div>
<div class="line"><a name="l07723"></a><span class="lineno"> 7723</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l07724"></a><span class="lineno"> 7724</span>&#160;                <span class="comment">// Only map generic bits that are in the ChildAce.</span></div>
<div class="line"><a name="l07725"></a><span class="lineno"> 7725</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l07726"></a><span class="lineno"> 7726</span>&#160;</div>
<div class="line"><a name="l07727"></a><span class="lineno"> 7727</span>&#160;                <span class="keywordflow">if</span> ( GenericBitToTry &amp; ChildAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a> ) {</div>
<div class="line"><a name="l07728"></a><span class="lineno"> 7728</span>&#160;                    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> GenericMask;</div>
<div class="line"><a name="l07729"></a><span class="lineno"> 7729</span>&#160;</div>
<div class="line"><a name="l07730"></a><span class="lineno"> 7730</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l07731"></a><span class="lineno"> 7731</span>&#160;                    <span class="comment">// Compute the real access mask corresponding to the Generic bit.</span></div>
<div class="line"><a name="l07732"></a><span class="lineno"> 7732</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l07733"></a><span class="lineno"> 7733</span>&#160;</div>
<div class="line"><a name="l07734"></a><span class="lineno"> 7734</span>&#160;                    GenericMask = GenericBitToTry;</div>
<div class="line"><a name="l07735"></a><span class="lineno"> 7735</span>&#160;                    <a class="code" href="../../d3/d32/a02665.html#a4463c888f291f366516bb8843732a9a6">RtlMapGenericMask</a>( &amp;GenericMask, GenericMapping );</div>
<div class="line"><a name="l07736"></a><span class="lineno"> 7736</span>&#160;</div>
<div class="line"><a name="l07737"></a><span class="lineno"> 7737</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l07738"></a><span class="lineno"> 7738</span>&#160;                    <span class="comment">// If the current generic bit matches any of the bits remaining,</span></div>
<div class="line"><a name="l07739"></a><span class="lineno"> 7739</span>&#160;                    <span class="comment">//  set the generic bit in the current ACE.</span></div>
<div class="line"><a name="l07740"></a><span class="lineno"> 7740</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l07741"></a><span class="lineno"> 7741</span>&#160;</div>
<div class="line"><a name="l07742"></a><span class="lineno"> 7742</span>&#160;                    <span class="keywordflow">if</span> ( (ResultantMask &amp; GenericMask) != 0 ) {</div>
<div class="line"><a name="l07743"></a><span class="lineno"> 7743</span>&#160;                        NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a> |= GenericBitToTry;</div>
<div class="line"><a name="l07744"></a><span class="lineno"> 7744</span>&#160;                        ResultantMask &amp;= ~GenericMask;</div>
<div class="line"><a name="l07745"></a><span class="lineno"> 7745</span>&#160;                    }</div>
<div class="line"><a name="l07746"></a><span class="lineno"> 7746</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07747"></a><span class="lineno"> 7747</span>&#160;                    <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07748"></a><span class="lineno"> 7748</span>&#160;                        <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Generic  non-inherited: %ld %8.8lX %8.8lX\n&quot;</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a>, ResultantMask ));</div>
<div class="line"><a name="l07749"></a><span class="lineno"> 7749</span>&#160;                    }</div>
<div class="line"><a name="l07750"></a><span class="lineno"> 7750</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07751"></a><span class="lineno"> 7751</span>&#160;                }</div>
<div class="line"><a name="l07752"></a><span class="lineno"> 7752</span>&#160;</div>
<div class="line"><a name="l07753"></a><span class="lineno"> 7753</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l07754"></a><span class="lineno"> 7754</span>&#160;                <span class="comment">// Try the next Generic bit.</span></div>
<div class="line"><a name="l07755"></a><span class="lineno"> 7755</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l07756"></a><span class="lineno"> 7756</span>&#160;</div>
<div class="line"><a name="l07757"></a><span class="lineno"> 7757</span>&#160;                GenericBitToTry &gt;&gt;= 1;</div>
<div class="line"><a name="l07758"></a><span class="lineno"> 7758</span>&#160;            }</div>
<div class="line"><a name="l07759"></a><span class="lineno"> 7759</span>&#160;</div>
<div class="line"><a name="l07760"></a><span class="lineno"> 7760</span>&#160;</div>
<div class="line"><a name="l07761"></a><span class="lineno"> 7761</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07762"></a><span class="lineno"> 7762</span>&#160;            <span class="comment">// This is really an internal error, but press on regardless.</span></div>
<div class="line"><a name="l07763"></a><span class="lineno"> 7763</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07764"></a><span class="lineno"> 7764</span>&#160;</div>
<div class="line"><a name="l07765"></a><span class="lineno"> 7765</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>(ResultantMask == 0 );</div>
<div class="line"><a name="l07766"></a><span class="lineno"> 7766</span>&#160;            NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a> |= ResultantMask;</div>
<div class="line"><a name="l07767"></a><span class="lineno"> 7767</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07768"></a><span class="lineno"> 7768</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07769"></a><span class="lineno"> 7769</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Final    non-inherited: %ld %8.8lX %8.8lX\n&quot;</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">Mask</a>, ResultantMask ));</div>
<div class="line"><a name="l07770"></a><span class="lineno"> 7770</span>&#160;            }</div>
<div class="line"><a name="l07771"></a><span class="lineno"> 7771</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07772"></a><span class="lineno"> 7772</span>&#160;</div>
<div class="line"><a name="l07773"></a><span class="lineno"> 7773</span>&#160;        }</div>
<div class="line"><a name="l07774"></a><span class="lineno"> 7774</span>&#160;    }</div>
<div class="line"><a name="l07775"></a><span class="lineno"> 7775</span>&#160;</div>
<div class="line"><a name="l07776"></a><span class="lineno"> 7776</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07777"></a><span class="lineno"> 7777</span>&#160;    <span class="comment">// Copy the inherited ACES.</span></div>
<div class="line"><a name="l07778"></a><span class="lineno"> 7778</span>&#160;    <span class="comment">//  Simply copy computed Inherited ACL.</span></div>
<div class="line"><a name="l07779"></a><span class="lineno"> 7779</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07780"></a><span class="lineno"> 7780</span>&#160;</div>
<div class="line"><a name="l07781"></a><span class="lineno"> 7781</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Where,</div>
<div class="line"><a name="l07782"></a><span class="lineno"> 7782</span>&#160;                   <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(RealInheritedAcl),</div>
<div class="line"><a name="l07783"></a><span class="lineno"> 7783</span>&#160;                   RealInheritedAcl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> - (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)<a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(RealInheritedAcl)) - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)RealInheritedAcl));</div>
<div class="line"><a name="l07784"></a><span class="lineno"> 7784</span>&#160;    Where += RealInheritedAcl-&gt;AclSize - (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>)(((<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)<a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(RealInheritedAcl)) - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)RealInheritedAcl);</div>
<div class="line"><a name="l07785"></a><span class="lineno"> 7785</span>&#160;</div>
<div class="line"><a name="l07786"></a><span class="lineno"> 7786</span>&#160;    (*NewAcl)-&gt;AceCount += RealInheritedAcl-&gt;AceCount;</div>
<div class="line"><a name="l07787"></a><span class="lineno"> 7787</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( (*NewAcl)-&gt;AclSize == Where - (<a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a>)(*NewAcl) );</div>
<div class="line"><a name="l07788"></a><span class="lineno"> 7788</span>&#160;</div>
<div class="line"><a name="l07789"></a><span class="lineno"> 7789</span>&#160;</div>
<div class="line"><a name="l07790"></a><span class="lineno"> 7790</span>&#160;    Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l07791"></a><span class="lineno"> 7791</span>&#160;Cleanup:</div>
<div class="line"><a name="l07792"></a><span class="lineno"> 7792</span>&#160;</div>
<div class="line"><a name="l07793"></a><span class="lineno"> 7793</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07794"></a><span class="lineno"> 7794</span>&#160;    <span class="comment">// If successful,</span></div>
<div class="line"><a name="l07795"></a><span class="lineno"> 7795</span>&#160;    <span class="comment">//  build the resultant autoinherited ACL.</span></div>
<div class="line"><a name="l07796"></a><span class="lineno"> 7796</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07797"></a><span class="lineno"> 7797</span>&#160;</div>
<div class="line"><a name="l07798"></a><span class="lineno"> 7798</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l07799"></a><span class="lineno"> 7799</span>&#160;</div>
<div class="line"><a name="l07800"></a><span class="lineno"> 7800</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07801"></a><span class="lineno"> 7801</span>&#160;        <span class="comment">// If the Child ACL is protected,</span></div>
<div class="line"><a name="l07802"></a><span class="lineno"> 7802</span>&#160;        <span class="comment">//  just build it as a copy of the original ACL</span></div>
<div class="line"><a name="l07803"></a><span class="lineno"> 7803</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07804"></a><span class="lineno"> 7804</span>&#160;</div>
<div class="line"><a name="l07805"></a><span class="lineno"> 7805</span>&#160;        <span class="keywordflow">if</span> ( *NewGenericControl &amp; <a class="code" href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a> ) {</div>
<div class="line"><a name="l07806"></a><span class="lineno"> 7806</span>&#160;</div>
<div class="line"><a name="l07807"></a><span class="lineno"> 7807</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07808"></a><span class="lineno"> 7808</span>&#160;            <span class="comment">// If we&#39;ve already allocated a new ACL (and couldn&#39;t finish it for some reason),</span></div>
<div class="line"><a name="l07809"></a><span class="lineno"> 7809</span>&#160;            <span class="comment">//  free it.</span></div>
<div class="line"><a name="l07810"></a><span class="lineno"> 7810</span>&#160;</div>
<div class="line"><a name="l07811"></a><span class="lineno"> 7811</span>&#160;            <span class="keywordflow">if</span> ( *NewAcl != NULL) {</div>
<div class="line"><a name="l07812"></a><span class="lineno"> 7812</span>&#160;                <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( *NewAcl );</div>
<div class="line"><a name="l07813"></a><span class="lineno"> 7813</span>&#160;                *NewAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l07814"></a><span class="lineno"> 7814</span>&#160;            }</div>
<div class="line"><a name="l07815"></a><span class="lineno"> 7815</span>&#160;</div>
<div class="line"><a name="l07816"></a><span class="lineno"> 7816</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07817"></a><span class="lineno"> 7817</span>&#160;            <span class="comment">// Allocate a buffer for the protected ACL.</span></div>
<div class="line"><a name="l07818"></a><span class="lineno"> 7818</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l07819"></a><span class="lineno"> 7819</span>&#160;</div>
<div class="line"><a name="l07820"></a><span class="lineno"> 7820</span>&#160;            *NewAcl = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(</div>
<div class="line"><a name="l07821"></a><span class="lineno"> 7821</span>&#160;                                <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>,</div>
<div class="line"><a name="l07822"></a><span class="lineno"> 7822</span>&#160;                                ChildAcl-&gt;AclSize,</div>
<div class="line"><a name="l07823"></a><span class="lineno"> 7823</span>&#160;                                <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l07824"></a><span class="lineno"> 7824</span>&#160;</div>
<div class="line"><a name="l07825"></a><span class="lineno"> 7825</span>&#160;            <span class="keywordflow">if</span> ( *NewAcl == NULL ) {</div>
<div class="line"><a name="l07826"></a><span class="lineno"> 7826</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a>;</div>
<div class="line"><a name="l07827"></a><span class="lineno"> 7827</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07828"></a><span class="lineno"> 7828</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( *NewAcl, ChildAcl, ChildAcl-&gt;AclSize );</div>
<div class="line"><a name="l07829"></a><span class="lineno"> 7829</span>&#160;            }</div>
<div class="line"><a name="l07830"></a><span class="lineno"> 7830</span>&#160;        }</div>
<div class="line"><a name="l07831"></a><span class="lineno"> 7831</span>&#160;</div>
<div class="line"><a name="l07832"></a><span class="lineno"> 7832</span>&#160;    }</div>
<div class="line"><a name="l07833"></a><span class="lineno"> 7833</span>&#160;</div>
<div class="line"><a name="l07834"></a><span class="lineno"> 7834</span>&#160;    <span class="keywordflow">if</span> ( ChildAceInfo != NULL) {</div>
<div class="line"><a name="l07835"></a><span class="lineno"> 7835</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( ChildAceInfo );</div>
<div class="line"><a name="l07836"></a><span class="lineno"> 7836</span>&#160;    }</div>
<div class="line"><a name="l07837"></a><span class="lineno"> 7837</span>&#160;</div>
<div class="line"><a name="l07838"></a><span class="lineno"> 7838</span>&#160;    <span class="keywordflow">if</span> ( InheritedAcl != NULL) {</div>
<div class="line"><a name="l07839"></a><span class="lineno"> 7839</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( InheritedAcl );</div>
<div class="line"><a name="l07840"></a><span class="lineno"> 7840</span>&#160;    }</div>
<div class="line"><a name="l07841"></a><span class="lineno"> 7841</span>&#160;</div>
<div class="line"><a name="l07842"></a><span class="lineno"> 7842</span>&#160;    <span class="keywordflow">if</span> ( RealInheritedAcl != NULL) {</div>
<div class="line"><a name="l07843"></a><span class="lineno"> 7843</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( RealInheritedAcl );</div>
<div class="line"><a name="l07844"></a><span class="lineno"> 7844</span>&#160;    }</div>
<div class="line"><a name="l07845"></a><span class="lineno"> 7845</span>&#160;</div>
<div class="line"><a name="l07846"></a><span class="lineno"> 7846</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l07847"></a><span class="lineno"> 7847</span>&#160;}</div>
<div class="line"><a name="l07848"></a><span class="lineno"> 7848</span>&#160;</div>
<div class="line"><a name="l07849"></a><span class="lineno"> 7849</span>&#160;</div>
<div class="line"><a name="l07850"></a><span class="lineno"> 7850</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l07851"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9"> 7851</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9">RtlpIsDuplicateAce</a>(</div>
<div class="line"><a name="l07852"></a><span class="lineno"> 7852</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l07853"></a><span class="lineno"> 7853</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> NewAce</div>
<div class="line"><a name="l07854"></a><span class="lineno"> 7854</span>&#160;    )</div>
<div class="line"><a name="l07855"></a><span class="lineno"> 7855</span>&#160;</div>
<div class="line"><a name="l07856"></a><span class="lineno"> 7856</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l07857"></a><span class="lineno"> 7857</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07858"></a><span class="lineno"> 7858</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l07859"></a><span class="lineno"> 7859</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07860"></a><span class="lineno"> 7860</span>&#160;<span class="comment">    This routine determine if an ACE is a duplicate of an ACE already in an</span></div>
<div class="line"><a name="l07861"></a><span class="lineno"> 7861</span>&#160;<span class="comment">    ACL.  If so, the NewAce can be removed from the end of the ACL.</span></div>
<div class="line"><a name="l07862"></a><span class="lineno"> 7862</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07863"></a><span class="lineno"> 7863</span>&#160;<span class="comment">    This routine currently only detects duplicate version 4 ACEs.  If the</span></div>
<div class="line"><a name="l07864"></a><span class="lineno"> 7864</span>&#160;<span class="comment">    ACE isn&#39;t version 4, the ACE will be declared to be a non-duplicate.</span></div>
<div class="line"><a name="l07865"></a><span class="lineno"> 7865</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07866"></a><span class="lineno"> 7866</span>&#160;<span class="comment">    This routine only detects duplicate INHERTED ACEs.</span></div>
<div class="line"><a name="l07867"></a><span class="lineno"> 7867</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07868"></a><span class="lineno"> 7868</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l07869"></a><span class="lineno"> 7869</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07870"></a><span class="lineno"> 7870</span>&#160;<span class="comment">    Acl - Existing ACL</span></div>
<div class="line"><a name="l07871"></a><span class="lineno"> 7871</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07872"></a><span class="lineno"> 7872</span>&#160;<span class="comment">    NewAce - Ace to determine if it is already in Acl.</span></div>
<div class="line"><a name="l07873"></a><span class="lineno"> 7873</span>&#160;<span class="comment">        NewAce is expected to be the last ACE in &quot;Acl&quot;.</span></div>
<div class="line"><a name="l07874"></a><span class="lineno"> 7874</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07875"></a><span class="lineno"> 7875</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l07876"></a><span class="lineno"> 7876</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07877"></a><span class="lineno"> 7877</span>&#160;<span class="comment">    TRUE - NewAce is a duplicate of another ACE on the Acl</span></div>
<div class="line"><a name="l07878"></a><span class="lineno"> 7878</span>&#160;<span class="comment">    FALSE - NewAce is NOT a duplicate of another ACE on the Acl</span></div>
<div class="line"><a name="l07879"></a><span class="lineno"> 7879</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l07880"></a><span class="lineno"> 7880</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l07881"></a><span class="lineno"> 7881</span>&#160;</div>
<div class="line"><a name="l07882"></a><span class="lineno"> 7882</span>&#160;{</div>
<div class="line"><a name="l07883"></a><span class="lineno"> 7883</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l07884"></a><span class="lineno"> 7884</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> RetVal = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l07885"></a><span class="lineno"> 7885</span>&#160;</div>
<div class="line"><a name="l07886"></a><span class="lineno"> 7886</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a> AceIndex;</div>
<div class="line"><a name="l07887"></a><span class="lineno"> 7887</span>&#160;</div>
<div class="line"><a name="l07888"></a><span class="lineno"> 7888</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> NewAceContainerInheritMask;</div>
<div class="line"><a name="l07889"></a><span class="lineno"> 7889</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> NewAceObjectInheritMask;</div>
<div class="line"><a name="l07890"></a><span class="lineno"> 7890</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> NewAceEffectiveMask;</div>
<div class="line"><a name="l07891"></a><span class="lineno"> 7891</span>&#160;</div>
<div class="line"><a name="l07892"></a><span class="lineno"> 7892</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a> LocalMask;</div>
<div class="line"><a name="l07893"></a><span class="lineno"> 7893</span>&#160;</div>
<div class="line"><a name="l07894"></a><span class="lineno"> 7894</span>&#160;    <a class="code" href="../../d8/d7d/a00789.html">PKNOWN_ACE</a> AceFromAcl;</div>
<div class="line"><a name="l07895"></a><span class="lineno"> 7895</span>&#160;</div>
<div class="line"><a name="l07896"></a><span class="lineno"> 7896</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l07897"></a><span class="lineno"> 7897</span>&#160;</div>
<div class="line"><a name="l07898"></a><span class="lineno"> 7898</span>&#160;</div>
<div class="line"><a name="l07899"></a><span class="lineno"> 7899</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07900"></a><span class="lineno"> 7900</span>&#160;    <span class="comment">// Ensure the passed in ACE is one this routine understands</span></div>
<div class="line"><a name="l07901"></a><span class="lineno"> 7901</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07902"></a><span class="lineno"> 7902</span>&#160;</div>
<div class="line"><a name="l07903"></a><span class="lineno"> 7903</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#ada772d88133c0c4f43ef15b685f17944">IsV4AceType</a>(NewAce) || <a class="code" href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a>(NewAce)) {</div>
<div class="line"><a name="l07904"></a><span class="lineno"> 7904</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07905"></a><span class="lineno"> 7905</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07906"></a><span class="lineno"> 7906</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;New Ace type (%ld) not known\n&quot;</span>, NewAce-&gt;Header.AceType ));</div>
<div class="line"><a name="l07907"></a><span class="lineno"> 7907</span>&#160;        }</div>
<div class="line"><a name="l07908"></a><span class="lineno"> 7908</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07909"></a><span class="lineno"> 7909</span>&#160;        RetVal = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l07910"></a><span class="lineno"> 7910</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07911"></a><span class="lineno"> 7911</span>&#160;    }</div>
<div class="line"><a name="l07912"></a><span class="lineno"> 7912</span>&#160;</div>
<div class="line"><a name="l07913"></a><span class="lineno"> 7913</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07914"></a><span class="lineno"> 7914</span>&#160;    <span class="comment">// This routine only works for ACEs marked as INHERITED.</span></div>
<div class="line"><a name="l07915"></a><span class="lineno"> 7915</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07916"></a><span class="lineno"> 7916</span>&#160;</div>
<div class="line"><a name="l07917"></a><span class="lineno"> 7917</span>&#160;    <span class="keywordflow">if</span> ( (NewAce-&gt;Header.AceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a> ) == 0 ) {</div>
<div class="line"><a name="l07918"></a><span class="lineno"> 7918</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07919"></a><span class="lineno"> 7919</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07920"></a><span class="lineno"> 7920</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;New Ace type isn&#39;t inherited\n&quot;</span> ));</div>
<div class="line"><a name="l07921"></a><span class="lineno"> 7921</span>&#160;        }</div>
<div class="line"><a name="l07922"></a><span class="lineno"> 7922</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07923"></a><span class="lineno"> 7923</span>&#160;        RetVal = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l07924"></a><span class="lineno"> 7924</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l07925"></a><span class="lineno"> 7925</span>&#160;    }</div>
<div class="line"><a name="l07926"></a><span class="lineno"> 7926</span>&#160;</div>
<div class="line"><a name="l07927"></a><span class="lineno"> 7927</span>&#160;</div>
<div class="line"><a name="l07928"></a><span class="lineno"> 7928</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07929"></a><span class="lineno"> 7929</span>&#160;    <span class="comment">// Break the new ACE into its component parts.</span></div>
<div class="line"><a name="l07930"></a><span class="lineno"> 7930</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07931"></a><span class="lineno"> 7931</span>&#160;    <span class="comment">// All V4 aces have an access mask in the same location.</span></div>
<div class="line"><a name="l07932"></a><span class="lineno"> 7932</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07933"></a><span class="lineno"> 7933</span>&#160;    LocalMask = ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(NewAce))-&gt;Mask;</div>
<div class="line"><a name="l07934"></a><span class="lineno"> 7934</span>&#160;</div>
<div class="line"><a name="l07935"></a><span class="lineno"> 7935</span>&#160;    <span class="keywordflow">if</span> ( NewAce-&gt;Header.AceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07936"></a><span class="lineno"> 7936</span>&#160;        NewAceContainerInheritMask = LocalMask;</div>
<div class="line"><a name="l07937"></a><span class="lineno"> 7937</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07938"></a><span class="lineno"> 7938</span>&#160;        NewAceContainerInheritMask = 0;</div>
<div class="line"><a name="l07939"></a><span class="lineno"> 7939</span>&#160;    }</div>
<div class="line"><a name="l07940"></a><span class="lineno"> 7940</span>&#160;</div>
<div class="line"><a name="l07941"></a><span class="lineno"> 7941</span>&#160;    <span class="keywordflow">if</span> ( NewAce-&gt;Header.AceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l07942"></a><span class="lineno"> 7942</span>&#160;        NewAceObjectInheritMask = LocalMask;</div>
<div class="line"><a name="l07943"></a><span class="lineno"> 7943</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07944"></a><span class="lineno"> 7944</span>&#160;        NewAceObjectInheritMask = 0;</div>
<div class="line"><a name="l07945"></a><span class="lineno"> 7945</span>&#160;    }</div>
<div class="line"><a name="l07946"></a><span class="lineno"> 7946</span>&#160;</div>
<div class="line"><a name="l07947"></a><span class="lineno"> 7947</span>&#160;    <span class="keywordflow">if</span> ( (NewAce-&gt;Header.AceFlags &amp; <a class="code" href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a>) == 0 ) {</div>
<div class="line"><a name="l07948"></a><span class="lineno"> 7948</span>&#160;        NewAceEffectiveMask = LocalMask;</div>
<div class="line"><a name="l07949"></a><span class="lineno"> 7949</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l07950"></a><span class="lineno"> 7950</span>&#160;        NewAceEffectiveMask = 0;</div>
<div class="line"><a name="l07951"></a><span class="lineno"> 7951</span>&#160;    }</div>
<div class="line"><a name="l07952"></a><span class="lineno"> 7952</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07953"></a><span class="lineno"> 7953</span>&#160;    <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07954"></a><span class="lineno"> 7954</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Starting MASKs:  %8.8lX %8.8lX %8.8lX&quot;</span>, NewAceEffectiveMask, NewAceContainerInheritMask, NewAceObjectInheritMask ));</div>
<div class="line"><a name="l07955"></a><span class="lineno"> 7955</span>&#160;    }</div>
<div class="line"><a name="l07956"></a><span class="lineno"> 7956</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l07957"></a><span class="lineno"> 7957</span>&#160;</div>
<div class="line"><a name="l07958"></a><span class="lineno"> 7958</span>&#160;</div>
<div class="line"><a name="l07959"></a><span class="lineno"> 7959</span>&#160;</div>
<div class="line"><a name="l07960"></a><span class="lineno"> 7960</span>&#160;</div>
<div class="line"><a name="l07961"></a><span class="lineno"> 7961</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07962"></a><span class="lineno"> 7962</span>&#160;    <span class="comment">// Walk through the ACL one ACE at a time.</span></div>
<div class="line"><a name="l07963"></a><span class="lineno"> 7963</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l07964"></a><span class="lineno"> 7964</span>&#160;</div>
<div class="line"><a name="l07965"></a><span class="lineno"> 7965</span>&#160;    <span class="keywordflow">for</span> (AceIndex = 0, AceFromAcl = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl);</div>
<div class="line"><a name="l07966"></a><span class="lineno"> 7966</span>&#160;         AceIndex &lt; Acl-&gt;AceCount-1;    <span class="comment">// NewAce is the last ACE</span></div>
<div class="line"><a name="l07967"></a><span class="lineno"> 7967</span>&#160;         AceIndex += 1, AceFromAcl = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(AceFromAcl)) {</div>
<div class="line"><a name="l07968"></a><span class="lineno"> 7968</span>&#160;</div>
<div class="line"><a name="l07969"></a><span class="lineno"> 7969</span>&#160;</div>
<div class="line"><a name="l07970"></a><span class="lineno"> 7970</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07971"></a><span class="lineno"> 7971</span>&#160;        <span class="comment">// If the ACE isn&#39;t a valid version 4 ACE,</span></div>
<div class="line"><a name="l07972"></a><span class="lineno"> 7972</span>&#160;        <span class="comment">//  this isn&#39;t an ACE we&#39;re interested in handling.</span></div>
<div class="line"><a name="l07973"></a><span class="lineno"> 7973</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07974"></a><span class="lineno"> 7974</span>&#160;</div>
<div class="line"><a name="l07975"></a><span class="lineno"> 7975</span>&#160;        <span class="keywordflow">if</span> ( !<a class="code" href="../../df/d4d/a02285.html#ada772d88133c0c4f43ef15b685f17944">IsV4AceType</a>(AceFromAcl) || <a class="code" href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a>(AceFromAcl)) {</div>
<div class="line"><a name="l07976"></a><span class="lineno"> 7976</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07977"></a><span class="lineno"> 7977</span>&#160;        }</div>
<div class="line"><a name="l07978"></a><span class="lineno"> 7978</span>&#160;</div>
<div class="line"><a name="l07979"></a><span class="lineno"> 7979</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07980"></a><span class="lineno"> 7980</span>&#160;        <span class="comment">// This routine only works for ACEs marked as INHERITED.</span></div>
<div class="line"><a name="l07981"></a><span class="lineno"> 7981</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07982"></a><span class="lineno"> 7982</span>&#160;</div>
<div class="line"><a name="l07983"></a><span class="lineno"> 7983</span>&#160;        <span class="keywordflow">if</span> ( (AceFromAcl-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a> ) == 0 ) {</div>
<div class="line"><a name="l07984"></a><span class="lineno"> 7984</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l07985"></a><span class="lineno"> 7985</span>&#160;        }</div>
<div class="line"><a name="l07986"></a><span class="lineno"> 7986</span>&#160;</div>
<div class="line"><a name="l07987"></a><span class="lineno"> 7987</span>&#160;</div>
<div class="line"><a name="l07988"></a><span class="lineno"> 7988</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07989"></a><span class="lineno"> 7989</span>&#160;        <span class="comment">// Compare the Ace from the ACL with the New ACE</span></div>
<div class="line"><a name="l07990"></a><span class="lineno"> 7990</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07991"></a><span class="lineno"> 7991</span>&#160;        <span class="comment">//  Don&#39;t stop simply because we&#39;ve matched once.</span></div>
<div class="line"><a name="l07992"></a><span class="lineno"> 7992</span>&#160;        <span class="comment">//  Multiple ACEs in the one ACL may have been condensed into a single ACE</span></div>
<div class="line"><a name="l07993"></a><span class="lineno"> 7993</span>&#160;        <span class="comment">//  in the other ACL in any combination (by any of our friendly ACL editors).</span></div>
<div class="line"><a name="l07994"></a><span class="lineno"> 7994</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l07995"></a><span class="lineno"> 7995</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l07996"></a><span class="lineno"> 7996</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l07997"></a><span class="lineno"> 7997</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Compare Ace: %ld &quot;</span>, AceIndex ));</div>
<div class="line"><a name="l07998"></a><span class="lineno"> 7998</span>&#160;        }</div>
<div class="line"><a name="l07999"></a><span class="lineno"> 7999</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l08000"></a><span class="lineno"> 8000</span>&#160;</div>
<div class="line"><a name="l08001"></a><span class="lineno"> 8001</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed">RtlpCompareAces</a>( AceFromAcl,</div>
<div class="line"><a name="l08002"></a><span class="lineno"> 8002</span>&#160;                              NewAce,</div>
<div class="line"><a name="l08003"></a><span class="lineno"> 8003</span>&#160;                              <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l08004"></a><span class="lineno"> 8004</span>&#160;                              <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) ) {</div>
<div class="line"><a name="l08005"></a><span class="lineno"> 8005</span>&#160;</div>
<div class="line"><a name="l08006"></a><span class="lineno"> 8006</span>&#160;</div>
<div class="line"><a name="l08007"></a><span class="lineno"> 8007</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08008"></a><span class="lineno"> 8008</span>&#160;            <span class="comment">// Match the bits from the current ACE with bits from the New ACE.</span></div>
<div class="line"><a name="l08009"></a><span class="lineno"> 8009</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08010"></a><span class="lineno"> 8010</span>&#160;            <span class="comment">// All V4 aces have an access mask in the same location.</span></div>
<div class="line"><a name="l08011"></a><span class="lineno"> 8011</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08012"></a><span class="lineno"> 8012</span>&#160;</div>
<div class="line"><a name="l08013"></a><span class="lineno"> 8013</span>&#160;            LocalMask = ((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)(AceFromAcl))-&gt;Mask;</div>
<div class="line"><a name="l08014"></a><span class="lineno"> 8014</span>&#160;</div>
<div class="line"><a name="l08015"></a><span class="lineno"> 8015</span>&#160;            <span class="keywordflow">if</span> ( AceFromAcl-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l08016"></a><span class="lineno"> 8016</span>&#160;                NewAceContainerInheritMask &amp;= ~LocalMask;</div>
<div class="line"><a name="l08017"></a><span class="lineno"> 8017</span>&#160;            }</div>
<div class="line"><a name="l08018"></a><span class="lineno"> 8018</span>&#160;</div>
<div class="line"><a name="l08019"></a><span class="lineno"> 8019</span>&#160;            <span class="keywordflow">if</span> ( AceFromAcl-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a> ) {</div>
<div class="line"><a name="l08020"></a><span class="lineno"> 8020</span>&#160;                NewAceObjectInheritMask &amp;= ~LocalMask;</div>
<div class="line"><a name="l08021"></a><span class="lineno"> 8021</span>&#160;            }</div>
<div class="line"><a name="l08022"></a><span class="lineno"> 8022</span>&#160;</div>
<div class="line"><a name="l08023"></a><span class="lineno"> 8023</span>&#160;            <span class="keywordflow">if</span> ( (AceFromAcl-&gt;<a class="code" href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">Header</a>.<a class="code" href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">AceFlags</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a>) == 0 ) {</div>
<div class="line"><a name="l08024"></a><span class="lineno"> 8024</span>&#160;                NewAceEffectiveMask &amp;= ~LocalMask;</div>
<div class="line"><a name="l08025"></a><span class="lineno"> 8025</span>&#160;            }</div>
<div class="line"><a name="l08026"></a><span class="lineno"> 8026</span>&#160;</div>
<div class="line"><a name="l08027"></a><span class="lineno"> 8027</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l08028"></a><span class="lineno"> 8028</span>&#160;            <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l08029"></a><span class="lineno"> 8029</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;Remaining MASKs:  %8.8lX %8.8lX %8.8lX&quot;</span>, NewAceEffectiveMask, NewAceContainerInheritMask, NewAceObjectInheritMask ));</div>
<div class="line"><a name="l08030"></a><span class="lineno"> 8030</span>&#160;            }</div>
<div class="line"><a name="l08031"></a><span class="lineno"> 8031</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l08032"></a><span class="lineno"> 8032</span>&#160;</div>
<div class="line"><a name="l08033"></a><span class="lineno"> 8033</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08034"></a><span class="lineno"> 8034</span>&#160;            <span class="comment">// If all bits have been matched in the New Ace,</span></div>
<div class="line"><a name="l08035"></a><span class="lineno"> 8035</span>&#160;            <span class="comment">//  then this is a duplicate ACE.</span></div>
<div class="line"><a name="l08036"></a><span class="lineno"> 8036</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08037"></a><span class="lineno"> 8037</span>&#160;</div>
<div class="line"><a name="l08038"></a><span class="lineno"> 8038</span>&#160;            <span class="keywordflow">if</span> ( (NewAceEffectiveMask | NewAceContainerInheritMask | NewAceObjectInheritMask) == 0 ) {</div>
<div class="line"><a name="l08039"></a><span class="lineno"> 8039</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l08040"></a><span class="lineno"> 8040</span>&#160;                <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l08041"></a><span class="lineno"> 8041</span>&#160;                    <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;\n&quot;</span>));</div>
<div class="line"><a name="l08042"></a><span class="lineno"> 8042</span>&#160;                }</div>
<div class="line"><a name="l08043"></a><span class="lineno"> 8043</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l08044"></a><span class="lineno"> 8044</span>&#160;                RetVal = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08045"></a><span class="lineno"> 8045</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08046"></a><span class="lineno"> 8046</span>&#160;            }</div>
<div class="line"><a name="l08047"></a><span class="lineno"> 8047</span>&#160;        }</div>
<div class="line"><a name="l08048"></a><span class="lineno"> 8048</span>&#160;<span class="preprocessor">#if DBG</span></div>
<div class="line"><a name="l08049"></a><span class="lineno"> 8049</span>&#160;        <span class="keywordflow">if</span> ( RtlpVerboseConvert ) {</div>
<div class="line"><a name="l08050"></a><span class="lineno"> 8050</span>&#160;              <a class="code" href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a>((<span class="stringliteral">&quot;\n&quot;</span>));</div>
<div class="line"><a name="l08051"></a><span class="lineno"> 8051</span>&#160;        }</div>
<div class="line"><a name="l08052"></a><span class="lineno"> 8052</span>&#160;<span class="preprocessor">#endif // DBG</span></div>
<div class="line"><a name="l08053"></a><span class="lineno"> 8053</span>&#160;</div>
<div class="line"><a name="l08054"></a><span class="lineno"> 8054</span>&#160;</div>
<div class="line"><a name="l08055"></a><span class="lineno"> 8055</span>&#160;    }</div>
<div class="line"><a name="l08056"></a><span class="lineno"> 8056</span>&#160;</div>
<div class="line"><a name="l08057"></a><span class="lineno"> 8057</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08058"></a><span class="lineno"> 8058</span>&#160;    <span class="comment">// All of the ACEs of the ACL have been processed.</span></div>
<div class="line"><a name="l08059"></a><span class="lineno"> 8059</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08060"></a><span class="lineno"> 8060</span>&#160;    <span class="comment">// We haven&#39;t matched all of the bits in the New Ace so this is not a duplicate ACE.</span></div>
<div class="line"><a name="l08061"></a><span class="lineno"> 8061</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08062"></a><span class="lineno"> 8062</span>&#160;</div>
<div class="line"><a name="l08063"></a><span class="lineno"> 8063</span>&#160;    RetVal = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08064"></a><span class="lineno"> 8064</span>&#160;Cleanup:</div>
<div class="line"><a name="l08065"></a><span class="lineno"> 8065</span>&#160;</div>
<div class="line"><a name="l08066"></a><span class="lineno"> 8066</span>&#160;    <span class="keywordflow">return</span> RetVal;</div>
<div class="line"><a name="l08067"></a><span class="lineno"> 8067</span>&#160;</div>
<div class="line"><a name="l08068"></a><span class="lineno"> 8068</span>&#160;}</div>
<div class="line"><a name="l08069"></a><span class="lineno"> 8069</span>&#160;</div>
<div class="line"><a name="l08070"></a><span class="lineno"> 8070</span>&#160;</div>
<div class="line"><a name="l08071"></a><span class="lineno"> 8071</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l08072"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0"> 8072</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0">RtlpCreateServerAcl</a>(</div>
<div class="line"><a name="l08073"></a><span class="lineno"> 8073</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Acl,</div>
<div class="line"><a name="l08074"></a><span class="lineno"> 8074</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> AclUntrusted,</div>
<div class="line"><a name="l08075"></a><span class="lineno"> 8075</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerSid,</div>
<div class="line"><a name="l08076"></a><span class="lineno"> 8076</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d7/dd4/a00013.html">PACL</a> *ServerAcl,</div>
<div class="line"><a name="l08077"></a><span class="lineno"> 8077</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *ServerAclAllocated</div>
<div class="line"><a name="l08078"></a><span class="lineno"> 8078</span>&#160;    )</div>
<div class="line"><a name="l08079"></a><span class="lineno"> 8079</span>&#160;</div>
<div class="line"><a name="l08080"></a><span class="lineno"> 8080</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l08081"></a><span class="lineno"> 8081</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08082"></a><span class="lineno"> 8082</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l08083"></a><span class="lineno"> 8083</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08084"></a><span class="lineno"> 8084</span>&#160;<span class="comment">    This routine takes an ACL and converts it into a server ACL.</span></div>
<div class="line"><a name="l08085"></a><span class="lineno"> 8085</span>&#160;<span class="comment">    Currently, that means converting all of the GRANT ACEs into</span></div>
<div class="line"><a name="l08086"></a><span class="lineno"> 8086</span>&#160;<span class="comment">    Compount Grants, and if necessary sanitizing any Compound</span></div>
<div class="line"><a name="l08087"></a><span class="lineno"> 8087</span>&#160;<span class="comment">    Grants that are encountered.</span></div>
<div class="line"><a name="l08088"></a><span class="lineno"> 8088</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08089"></a><span class="lineno"> 8089</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l08090"></a><span class="lineno"> 8090</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08091"></a><span class="lineno"> 8091</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08092"></a><span class="lineno"> 8092</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08093"></a><span class="lineno"> 8093</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l08094"></a><span class="lineno"> 8094</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08095"></a><span class="lineno"> 8095</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08096"></a><span class="lineno"> 8096</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l08097"></a><span class="lineno"> 8097</span>&#160;</div>
<div class="line"><a name="l08098"></a><span class="lineno"> 8098</span>&#160;{</div>
<div class="line"><a name="l08099"></a><span class="lineno"> 8099</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> RequiredSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#a067989903b97870422dc2a37d11684f8">ACL</a>);</div>
<div class="line"><a name="l08100"></a><span class="lineno"> 8100</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> AceSizeAdjustment;</div>
<div class="line"><a name="l08101"></a><span class="lineno"> 8101</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a> ServerSidSize;</div>
<div class="line"><a name="l08102"></a><span class="lineno"> 8102</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> Ace;</div>
<div class="line"><a name="l08103"></a><span class="lineno"> 8103</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l08104"></a><span class="lineno"> 8104</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> Target;</div>
<div class="line"><a name="l08105"></a><span class="lineno"> 8105</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> AcePosition;</div>
<div class="line"><a name="l08106"></a><span class="lineno"> 8106</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> UntrustedSid;</div>
<div class="line"><a name="l08107"></a><span class="lineno"> 8107</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ClientSid;</div>
<div class="line"><a name="l08108"></a><span class="lineno"> 8108</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l08109"></a><span class="lineno"> 8109</span>&#160;</div>
<div class="line"><a name="l08110"></a><span class="lineno"> 8110</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l08111"></a><span class="lineno"> 8111</span>&#160;</div>
<div class="line"><a name="l08112"></a><span class="lineno"> 8112</span>&#160;    <span class="keywordflow">if</span> (Acl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08113"></a><span class="lineno"> 8113</span>&#160;        *ServerAclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08114"></a><span class="lineno"> 8114</span>&#160;        *ServerAcl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08115"></a><span class="lineno"> 8115</span>&#160;        <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> );</div>
<div class="line"><a name="l08116"></a><span class="lineno"> 8116</span>&#160;    }</div>
<div class="line"><a name="l08117"></a><span class="lineno"> 8117</span>&#160;</div>
<div class="line"><a name="l08118"></a><span class="lineno"> 8118</span>&#160;    AceSizeAdjustment = <span class="keyword">sizeof</span>( <a class="code" href="../../df/d4d/a02285.html#a5a0c3b46354580362b32e0f209b6da8d">KNOWN_COMPOUND_ACE</a> ) - <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a> );</div>
<div class="line"><a name="l08119"></a><span class="lineno"> 8119</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <span class="keyword">sizeof</span>( <a class="code" href="../../d3/daf/a00790.html">KNOWN_COMPOUND_ACE</a> ) &gt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a> ) );</div>
<div class="line"><a name="l08120"></a><span class="lineno"> 8120</span>&#160;</div>
<div class="line"><a name="l08121"></a><span class="lineno"> 8121</span>&#160;    ServerSidSize = (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( ServerSid );</div>
<div class="line"><a name="l08122"></a><span class="lineno"> 8122</span>&#160;</div>
<div class="line"><a name="l08123"></a><span class="lineno"> 8123</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08124"></a><span class="lineno"> 8124</span>&#160;    <span class="comment">// Do this in two passes.  First, determine how big the final</span></div>
<div class="line"><a name="l08125"></a><span class="lineno"> 8125</span>&#160;    <span class="comment">// result is going to be, and then allocate the space and make</span></div>
<div class="line"><a name="l08126"></a><span class="lineno"> 8126</span>&#160;    <span class="comment">// the changes.</span></div>
<div class="line"><a name="l08127"></a><span class="lineno"> 8127</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08128"></a><span class="lineno"> 8128</span>&#160;</div>
<div class="line"><a name="l08129"></a><span class="lineno"> 8129</span>&#160;    <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl);</div>
<div class="line"><a name="l08130"></a><span class="lineno"> 8130</span>&#160;         i &lt; Acl-&gt;AceCount;</div>
<div class="line"><a name="l08131"></a><span class="lineno"> 8131</span>&#160;         i += 1, Ace = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(Ace)) {</div>
<div class="line"><a name="l08132"></a><span class="lineno"> 8132</span>&#160;</div>
<div class="line"><a name="l08133"></a><span class="lineno"> 8133</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08134"></a><span class="lineno"> 8134</span>&#160;        <span class="comment">// If it&#39;s an ACCESS_ALLOWED_ACE_TYPE, we&#39;ll need to add in the</span></div>
<div class="line"><a name="l08135"></a><span class="lineno"> 8135</span>&#160;        <span class="comment">// size of the Server SID.</span></div>
<div class="line"><a name="l08136"></a><span class="lineno"> 8136</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08137"></a><span class="lineno"> 8137</span>&#160;</div>
<div class="line"><a name="l08138"></a><span class="lineno"> 8138</span>&#160;        <span class="keywordflow">if</span> (Ace-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> == <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a>) {</div>
<div class="line"><a name="l08139"></a><span class="lineno"> 8139</span>&#160;</div>
<div class="line"><a name="l08140"></a><span class="lineno"> 8140</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08141"></a><span class="lineno"> 8141</span>&#160;            <span class="comment">// Simply add the size of the new Server SID plus whatever</span></div>
<div class="line"><a name="l08142"></a><span class="lineno"> 8142</span>&#160;            <span class="comment">// adjustment needs to be made to increase the size of the ACE.</span></div>
<div class="line"><a name="l08143"></a><span class="lineno"> 8143</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08144"></a><span class="lineno"> 8144</span>&#160;</div>
<div class="line"><a name="l08145"></a><span class="lineno"> 8145</span>&#160;            RequiredSize += ( ServerSidSize + AceSizeAdjustment );</div>
<div class="line"><a name="l08146"></a><span class="lineno"> 8146</span>&#160;</div>
<div class="line"><a name="l08147"></a><span class="lineno"> 8147</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08148"></a><span class="lineno"> 8148</span>&#160;</div>
<div class="line"><a name="l08149"></a><span class="lineno"> 8149</span>&#160;            <span class="keywordflow">if</span> (AclUntrusted &amp;&amp; Ace-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> == <a class="code" href="../../d3/d3a/a02259.html#abbf861f5f7ab0c3d45df32ffb0ffd1fd">ACCESS_ALLOWED_COMPOUND_ACE_TYPE</a> ) {</div>
<div class="line"><a name="l08150"></a><span class="lineno"> 8150</span>&#160;</div>
<div class="line"><a name="l08151"></a><span class="lineno"> 8151</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l08152"></a><span class="lineno"> 8152</span>&#160;                <span class="comment">// Since the Acl is untrusted, we don&#39;t care what is in the</span></div>
<div class="line"><a name="l08153"></a><span class="lineno"> 8153</span>&#160;                <span class="comment">// server SID, we&#39;re going to replace it.</span></div>
<div class="line"><a name="l08154"></a><span class="lineno"> 8154</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l08155"></a><span class="lineno"> 8155</span>&#160;</div>
<div class="line"><a name="l08156"></a><span class="lineno"> 8156</span>&#160;                UntrustedSid = <a class="code" href="../../de/dc3/a02256.html#a629256bb2488240a06b6827cc90016a6">RtlCompoundAceServerSid</a>( Ace );</div>
<div class="line"><a name="l08157"></a><span class="lineno"> 8157</span>&#160;                <span class="keywordflow">if</span> ((<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(UntrustedSid) &gt; ServerSidSize) {</div>
<div class="line"><a name="l08158"></a><span class="lineno"> 8158</span>&#160;                    RequiredSize += ((<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(UntrustedSid) - ServerSidSize);</div>
<div class="line"><a name="l08159"></a><span class="lineno"> 8159</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08160"></a><span class="lineno"> 8160</span>&#160;                    RequiredSize += (ServerSidSize - (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(UntrustedSid));</div>
<div class="line"><a name="l08161"></a><span class="lineno"> 8161</span>&#160;</div>
<div class="line"><a name="l08162"></a><span class="lineno"> 8162</span>&#160;                }</div>
<div class="line"><a name="l08163"></a><span class="lineno"> 8163</span>&#160;            }</div>
<div class="line"><a name="l08164"></a><span class="lineno"> 8164</span>&#160;        }</div>
<div class="line"><a name="l08165"></a><span class="lineno"> 8165</span>&#160;</div>
<div class="line"><a name="l08166"></a><span class="lineno"> 8166</span>&#160;        RequiredSize += Ace-&gt;<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a>;</div>
<div class="line"><a name="l08167"></a><span class="lineno"> 8167</span>&#160;    }</div>
<div class="line"><a name="l08168"></a><span class="lineno"> 8168</span>&#160;</div>
<div class="line"><a name="l08169"></a><span class="lineno"> 8169</span>&#160;    (*ServerAcl) = (<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)<a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>, RequiredSize, <span class="stringliteral">&#39;cAeS&#39;</span> );</div>
<div class="line"><a name="l08170"></a><span class="lineno"> 8170</span>&#160;</div>
<div class="line"><a name="l08171"></a><span class="lineno"> 8171</span>&#160;    <span class="keywordflow">if</span> ((*ServerAcl) == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08172"></a><span class="lineno"> 8172</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dc/d18/a02260.html#aeb86c04f9593b4cdb1b56c71e76d2e36">STATUS_INSUFFICIENT_RESOURCES</a>;</div>
<div class="line"><a name="l08173"></a><span class="lineno"> 8173</span>&#160;    }</div>
<div class="line"><a name="l08174"></a><span class="lineno"> 8174</span>&#160;</div>
<div class="line"><a name="l08175"></a><span class="lineno"> 8175</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08176"></a><span class="lineno"> 8176</span>&#160;    <span class="comment">// Mark as allocated so caller knows to free it.</span></div>
<div class="line"><a name="l08177"></a><span class="lineno"> 8177</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08178"></a><span class="lineno"> 8178</span>&#160;</div>
<div class="line"><a name="l08179"></a><span class="lineno"> 8179</span>&#160;    *ServerAclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08180"></a><span class="lineno"> 8180</span>&#160;</div>
<div class="line"><a name="l08181"></a><span class="lineno"> 8181</span>&#160;    Status = <a class="code" href="../../de/dc3/a02256.html#af4ddb38f27ea43e90252a906ffdd84c1">RtlCreateAcl</a>( (*ServerAcl), RequiredSize, <a class="code" href="../../d3/d3a/a02259.html#a5a7b412541ed85b9b603ed687fe28681">ACL_REVISION3</a> );</div>
<div class="line"><a name="l08182"></a><span class="lineno"> 8182</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status ));</div>
<div class="line"><a name="l08183"></a><span class="lineno"> 8183</span>&#160;</div>
<div class="line"><a name="l08184"></a><span class="lineno"> 8184</span>&#160;    <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>(Acl), Target=<a class="code" href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a>( *ServerAcl );</div>
<div class="line"><a name="l08185"></a><span class="lineno"> 8185</span>&#160;         i &lt; Acl-&gt;AceCount;</div>
<div class="line"><a name="l08186"></a><span class="lineno"> 8186</span>&#160;         i += 1, Ace = <a class="code" href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a>(Ace)) {</div>
<div class="line"><a name="l08187"></a><span class="lineno"> 8187</span>&#160;</div>
<div class="line"><a name="l08188"></a><span class="lineno"> 8188</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08189"></a><span class="lineno"> 8189</span>&#160;        <span class="comment">// If it&#39;s an ACCESS_ALLOWED_ACE_TYPE, convert to a Server ACE.</span></div>
<div class="line"><a name="l08190"></a><span class="lineno"> 8190</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08191"></a><span class="lineno"> 8191</span>&#160;</div>
<div class="line"><a name="l08192"></a><span class="lineno"> 8192</span>&#160;        <span class="keywordflow">if</span> (Ace-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> == <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a> ||</div>
<div class="line"><a name="l08193"></a><span class="lineno"> 8193</span>&#160;           (AclUntrusted &amp;&amp; Ace-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> == <a class="code" href="../../d3/d3a/a02259.html#abbf861f5f7ab0c3d45df32ffb0ffd1fd">ACCESS_ALLOWED_COMPOUND_ACE_TYPE</a> )) {</div>
<div class="line"><a name="l08194"></a><span class="lineno"> 8194</span>&#160;</div>
<div class="line"><a name="l08195"></a><span class="lineno"> 8195</span>&#160;            AcePosition = Target;</div>
<div class="line"><a name="l08196"></a><span class="lineno"> 8196</span>&#160;</div>
<div class="line"><a name="l08197"></a><span class="lineno"> 8197</span>&#160;            <span class="keywordflow">if</span> (Ace-&gt;<a class="code" href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">AceType</a> == <a class="code" href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a>) {</div>
<div class="line"><a name="l08198"></a><span class="lineno"> 8198</span>&#160;                ClientSid =  &amp;((<a class="code" href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a>)Ace)-&gt;SidStart;</div>
<div class="line"><a name="l08199"></a><span class="lineno"> 8199</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08200"></a><span class="lineno"> 8200</span>&#160;                ClientSid = <a class="code" href="../../de/dc3/a02256.html#ac2b83a0ab0baf87298094ed858d91248">RtlCompoundAceClientSid</a>( Ace );</div>
<div class="line"><a name="l08201"></a><span class="lineno"> 8201</span>&#160;            }</div>
<div class="line"><a name="l08202"></a><span class="lineno"> 8202</span>&#160;</div>
<div class="line"><a name="l08203"></a><span class="lineno"> 8203</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08204"></a><span class="lineno"> 8204</span>&#160;            <span class="comment">// Copy up to the access mask.</span></div>
<div class="line"><a name="l08205"></a><span class="lineno"> 8205</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08206"></a><span class="lineno"> 8206</span>&#160;</div>
<div class="line"><a name="l08207"></a><span class="lineno"> 8207</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l08208"></a><span class="lineno"> 8208</span>&#160;                Target,</div>
<div class="line"><a name="l08209"></a><span class="lineno"> 8209</span>&#160;                Ace,</div>
<div class="line"><a name="l08210"></a><span class="lineno"> 8210</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d8/d7d/a00789.html">KNOWN_ACE</a>, SidStart)</div>
<div class="line"><a name="l08211"></a><span class="lineno"> 8211</span>&#160;                );</div>
<div class="line"><a name="l08212"></a><span class="lineno"> 8212</span>&#160;</div>
<div class="line"><a name="l08213"></a><span class="lineno"> 8213</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08214"></a><span class="lineno"> 8214</span>&#160;            <span class="comment">// Now copy the correct Server SID</span></div>
<div class="line"><a name="l08215"></a><span class="lineno"> 8215</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08216"></a><span class="lineno"> 8216</span>&#160;</div>
<div class="line"><a name="l08217"></a><span class="lineno"> 8217</span>&#160;            Target = ((<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)Target + (<a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>)(<a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d3/daf/a00790.html">KNOWN_COMPOUND_ACE</a>, SidStart)));</div>
<div class="line"><a name="l08218"></a><span class="lineno"> 8218</span>&#160;</div>
<div class="line"><a name="l08219"></a><span class="lineno"> 8219</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l08220"></a><span class="lineno"> 8220</span>&#160;                Target,</div>
<div class="line"><a name="l08221"></a><span class="lineno"> 8221</span>&#160;                ServerSid,</div>
<div class="line"><a name="l08222"></a><span class="lineno"> 8222</span>&#160;                <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ServerSid)</div>
<div class="line"><a name="l08223"></a><span class="lineno"> 8223</span>&#160;                );</div>
<div class="line"><a name="l08224"></a><span class="lineno"> 8224</span>&#160;</div>
<div class="line"><a name="l08225"></a><span class="lineno"> 8225</span>&#160;            Target = ((<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)Target + (<a class="code" href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ServerSid));</div>
<div class="line"><a name="l08226"></a><span class="lineno"> 8226</span>&#160;</div>
<div class="line"><a name="l08227"></a><span class="lineno"> 8227</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08228"></a><span class="lineno"> 8228</span>&#160;            <span class="comment">// Now copy in the correct client SID.  We can copy this right out of</span></div>
<div class="line"><a name="l08229"></a><span class="lineno"> 8229</span>&#160;            <span class="comment">// the original ACE.</span></div>
<div class="line"><a name="l08230"></a><span class="lineno"> 8230</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08231"></a><span class="lineno"> 8231</span>&#160;</div>
<div class="line"><a name="l08232"></a><span class="lineno"> 8232</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>(</div>
<div class="line"><a name="l08233"></a><span class="lineno"> 8233</span>&#160;                Target,</div>
<div class="line"><a name="l08234"></a><span class="lineno"> 8234</span>&#160;                ClientSid,</div>
<div class="line"><a name="l08235"></a><span class="lineno"> 8235</span>&#160;                <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientSid)</div>
<div class="line"><a name="l08236"></a><span class="lineno"> 8236</span>&#160;                );</div>
<div class="line"><a name="l08237"></a><span class="lineno"> 8237</span>&#160;</div>
<div class="line"><a name="l08238"></a><span class="lineno"> 8238</span>&#160;            Target = ((<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)Target + <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientSid));</div>
<div class="line"><a name="l08239"></a><span class="lineno"> 8239</span>&#160;</div>
<div class="line"><a name="l08240"></a><span class="lineno"> 8240</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08241"></a><span class="lineno"> 8241</span>&#160;            <span class="comment">// Set the size of the ACE accordingly</span></div>
<div class="line"><a name="l08242"></a><span class="lineno"> 8242</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08243"></a><span class="lineno"> 8243</span>&#160;</div>
<div class="line"><a name="l08244"></a><span class="lineno"> 8244</span>&#160;            ((<a class="code" href="../../df/d4d/a02285.html#a1d1ca952dbdcb9d3acad809233e0706e">PKNOWN_COMPOUND_ACE</a>)AcePosition)-&gt;Header.AceSize =</div>
<div class="line"><a name="l08245"></a><span class="lineno"> 8245</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a>(<a class="code" href="../../d3/daf/a00790.html">KNOWN_COMPOUND_ACE</a>, SidStart) +</div>
<div class="line"><a name="l08246"></a><span class="lineno"> 8246</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ServerSid) +</div>
<div class="line"><a name="l08247"></a><span class="lineno"> 8247</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a>)<a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(ClientSid);</div>
<div class="line"><a name="l08248"></a><span class="lineno"> 8248</span>&#160;</div>
<div class="line"><a name="l08249"></a><span class="lineno"> 8249</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08250"></a><span class="lineno"> 8250</span>&#160;            <span class="comment">// Set the type</span></div>
<div class="line"><a name="l08251"></a><span class="lineno"> 8251</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08252"></a><span class="lineno"> 8252</span>&#160;</div>
<div class="line"><a name="l08253"></a><span class="lineno"> 8253</span>&#160;            ((<a class="code" href="../../df/d4d/a02285.html#a1d1ca952dbdcb9d3acad809233e0706e">PKNOWN_COMPOUND_ACE</a>)AcePosition)-&gt;Header.AceType = <a class="code" href="../../d3/d3a/a02259.html#abbf861f5f7ab0c3d45df32ffb0ffd1fd">ACCESS_ALLOWED_COMPOUND_ACE_TYPE</a>;</div>
<div class="line"><a name="l08254"></a><span class="lineno"> 8254</span>&#160;            ((<a class="code" href="../../df/d4d/a02285.html#a1d1ca952dbdcb9d3acad809233e0706e">PKNOWN_COMPOUND_ACE</a>)AcePosition)-&gt;CompoundAceType = <a class="code" href="../../d3/d3a/a02259.html#aee18bff241b40f364f3b09805c029d27">COMPOUND_ACE_IMPERSONATION</a>;</div>
<div class="line"><a name="l08255"></a><span class="lineno"> 8255</span>&#160;</div>
<div class="line"><a name="l08256"></a><span class="lineno"> 8256</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08257"></a><span class="lineno"> 8257</span>&#160;</div>
<div class="line"><a name="l08258"></a><span class="lineno"> 8258</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08259"></a><span class="lineno"> 8259</span>&#160;            <span class="comment">// Just copy the ACE as is.</span></div>
<div class="line"><a name="l08260"></a><span class="lineno"> 8260</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08261"></a><span class="lineno"> 8261</span>&#160;</div>
<div class="line"><a name="l08262"></a><span class="lineno"> 8262</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Target, Ace, Ace-&gt;<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a> );</div>
<div class="line"><a name="l08263"></a><span class="lineno"> 8263</span>&#160;</div>
<div class="line"><a name="l08264"></a><span class="lineno"> 8264</span>&#160;            Target = ((<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)Target + Ace-&gt;<a class="code" href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">AceSize</a>);</div>
<div class="line"><a name="l08265"></a><span class="lineno"> 8265</span>&#160;        }</div>
<div class="line"><a name="l08266"></a><span class="lineno"> 8266</span>&#160;    }</div>
<div class="line"><a name="l08267"></a><span class="lineno"> 8267</span>&#160;</div>
<div class="line"><a name="l08268"></a><span class="lineno"> 8268</span>&#160;    (*ServerAcl)-&gt;AceCount = Acl-&gt;AceCount;</div>
<div class="line"><a name="l08269"></a><span class="lineno"> 8269</span>&#160;</div>
<div class="line"><a name="l08270"></a><span class="lineno"> 8270</span>&#160;    <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a> );</div>
<div class="line"><a name="l08271"></a><span class="lineno"> 8271</span>&#160;}</div>
<div class="line"><a name="l08272"></a><span class="lineno"> 8272</span>&#160;</div>
<div class="line"><a name="l08273"></a><span class="lineno"> 8273</span>&#160;</div>
<div class="line"><a name="l08274"></a><span class="lineno"> 8274</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l08275"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a33acc19d2faa9d67df8294de0bbced58"> 8275</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a33acc19d2faa9d67df8294de0bbced58">RtlpNewSecurityObject</a> (</div>
<div class="line"><a name="l08276"></a><span class="lineno"> 8276</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> ParentDescriptor <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l08277"></a><span class="lineno"> 8277</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> CreatorDescriptor OPTIONAL,</div>
<div class="line"><a name="l08278"></a><span class="lineno"> 8278</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> * NewDescriptor,</div>
<div class="line"><a name="l08279"></a><span class="lineno"> 8279</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pObjectType OPTIONAL,</div>
<div class="line"><a name="l08280"></a><span class="lineno"> 8280</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount,</div>
<div class="line"><a name="l08281"></a><span class="lineno"> 8281</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsDirectoryObject,</div>
<div class="line"><a name="l08282"></a><span class="lineno"> 8282</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AutoInheritFlags,</div>
<div class="line"><a name="l08283"></a><span class="lineno"> 8283</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> Token OPTIONAL,</div>
<div class="line"><a name="l08284"></a><span class="lineno"> 8284</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping</div>
<div class="line"><a name="l08285"></a><span class="lineno"> 8285</span>&#160;    )</div>
<div class="line"><a name="l08286"></a><span class="lineno"> 8286</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l08287"></a><span class="lineno"> 8287</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08288"></a><span class="lineno"> 8288</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l08289"></a><span class="lineno"> 8289</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08290"></a><span class="lineno"> 8290</span>&#160;<span class="comment">    The procedure is used to allocate and initialize a self-relative</span></div>
<div class="line"><a name="l08291"></a><span class="lineno"> 8291</span>&#160;<span class="comment">    Security Descriptor for a new protected server&#39;s object.  It is called</span></div>
<div class="line"><a name="l08292"></a><span class="lineno"> 8292</span>&#160;<span class="comment">    when a new protected server object is being created.  The generated</span></div>
<div class="line"><a name="l08293"></a><span class="lineno"> 8293</span>&#160;<span class="comment">    security descriptor will be in self-relative form.</span></div>
<div class="line"><a name="l08294"></a><span class="lineno"> 8294</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08295"></a><span class="lineno"> 8295</span>&#160;<span class="comment">    This procedure, called only from user mode, is used to establish a</span></div>
<div class="line"><a name="l08296"></a><span class="lineno"> 8296</span>&#160;<span class="comment">    security descriptor for a new protected server&#39;s object.  Memory is</span></div>
<div class="line"><a name="l08297"></a><span class="lineno"> 8297</span>&#160;<span class="comment">    allocated to hold each of the security descriptor&#39;s components (using</span></div>
<div class="line"><a name="l08298"></a><span class="lineno"> 8298</span>&#160;<span class="comment">    NtAllocateVirtualMemory()).  The final security descriptor generated by</span></div>
<div class="line"><a name="l08299"></a><span class="lineno"> 8299</span>&#160;<span class="comment">    this procedure is produced according to the rules stated in ???</span></div>
<div class="line"><a name="l08300"></a><span class="lineno"> 8300</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08301"></a><span class="lineno"> 8301</span>&#160;<span class="comment">    System and Discretionary ACL Assignment</span></div>
<div class="line"><a name="l08302"></a><span class="lineno"> 8302</span>&#160;<span class="comment">    ---------------------------------------</span></div>
<div class="line"><a name="l08303"></a><span class="lineno"> 8303</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08304"></a><span class="lineno"> 8304</span>&#160;<span class="comment">    The assignment of system and discretionary ACLs is governed by the</span></div>
<div class="line"><a name="l08305"></a><span class="lineno"> 8305</span>&#160;<span class="comment">    logic illustrated in the following table:</span></div>
<div class="line"><a name="l08306"></a><span class="lineno"> 8306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08307"></a><span class="lineno"> 8307</span>&#160;<span class="comment">                 |  Explicit      |  Explicit     |</span></div>
<div class="line"><a name="l08308"></a><span class="lineno"> 8308</span>&#160;<span class="comment">                 | (non-default)  |  Default      |   No</span></div>
<div class="line"><a name="l08309"></a><span class="lineno"> 8309</span>&#160;<span class="comment">                 |  Acl           |  Acl          |   Acl</span></div>
<div class="line"><a name="l08310"></a><span class="lineno"> 8310</span>&#160;<span class="comment">                 |  Specified     |  Specified    |   Specified</span></div>
<div class="line"><a name="l08311"></a><span class="lineno"> 8311</span>&#160;<span class="comment">    -------------+----------------+---------------+--------------</span></div>
<div class="line"><a name="l08312"></a><span class="lineno"> 8312</span>&#160;<span class="comment">                 |                |               |</span></div>
<div class="line"><a name="l08313"></a><span class="lineno"> 8313</span>&#160;<span class="comment">    Inheritable  | Assign         |  Assign       | Assign</span></div>
<div class="line"><a name="l08314"></a><span class="lineno"> 8314</span>&#160;<span class="comment">    Acl From     | Specified      |  Inherited    | Inherited</span></div>
<div class="line"><a name="l08315"></a><span class="lineno"> 8315</span>&#160;<span class="comment">    Parent       | Acl(1)(2)      |  Acl          | Acl</span></div>
<div class="line"><a name="l08316"></a><span class="lineno"> 8316</span>&#160;<span class="comment">                 |                |               |</span></div>
<div class="line"><a name="l08317"></a><span class="lineno"> 8317</span>&#160;<span class="comment">    -------------+----------------+---------------+--------------</span></div>
<div class="line"><a name="l08318"></a><span class="lineno"> 8318</span>&#160;<span class="comment">    No           |                |               |</span></div>
<div class="line"><a name="l08319"></a><span class="lineno"> 8319</span>&#160;<span class="comment">    Inheritable  | Assign         |  Assign       | Assign</span></div>
<div class="line"><a name="l08320"></a><span class="lineno"> 8320</span>&#160;<span class="comment">    Acl From     | Specified      |  Default      | No Acl</span></div>
<div class="line"><a name="l08321"></a><span class="lineno"> 8321</span>&#160;<span class="comment">    Parent       | Acl(1)         |  Acl          |</span></div>
<div class="line"><a name="l08322"></a><span class="lineno"> 8322</span>&#160;<span class="comment">                 |                |               |</span></div>
<div class="line"><a name="l08323"></a><span class="lineno"> 8323</span>&#160;<span class="comment">    -------------+----------------+---------------+--------------</span></div>
<div class="line"><a name="l08324"></a><span class="lineno"> 8324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08325"></a><span class="lineno"> 8325</span>&#160;<span class="comment">    (1) Any ACEs with the INHERITED_ACE bit set are NOT copied to the assigned</span></div>
<div class="line"><a name="l08326"></a><span class="lineno"> 8326</span>&#160;<span class="comment">    security descriptor.</span></div>
<div class="line"><a name="l08327"></a><span class="lineno"> 8327</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08328"></a><span class="lineno"> 8328</span>&#160;<span class="comment">    (2) If the AutoInheritFlags is flagged to automatically inherit ACEs from</span></div>
<div class="line"><a name="l08329"></a><span class="lineno"> 8329</span>&#160;<span class="comment">    parent (SEF_DACL_AUTO_INHERIT or SEF_SACL_AUTO_INHERIT), inherited</span></div>
<div class="line"><a name="l08330"></a><span class="lineno"> 8330</span>&#160;<span class="comment">    ACEs from the parent will be appended after explicit ACEs from the</span></div>
<div class="line"><a name="l08331"></a><span class="lineno"> 8331</span>&#160;<span class="comment">    CreatorDescriptor.</span></div>
<div class="line"><a name="l08332"></a><span class="lineno"> 8332</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08333"></a><span class="lineno"> 8333</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08334"></a><span class="lineno"> 8334</span>&#160;<span class="comment">    Note that an explicitly specified ACL, whether a default ACL or</span></div>
<div class="line"><a name="l08335"></a><span class="lineno"> 8335</span>&#160;<span class="comment">    not, may be empty or null.</span></div>
<div class="line"><a name="l08336"></a><span class="lineno"> 8336</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08337"></a><span class="lineno"> 8337</span>&#160;<span class="comment">    If the caller is explicitly assigning a system acl, default or</span></div>
<div class="line"><a name="l08338"></a><span class="lineno"> 8338</span>&#160;<span class="comment">    non-default, the caller must either be a kernel mode client or</span></div>
<div class="line"><a name="l08339"></a><span class="lineno"> 8339</span>&#160;<span class="comment">    must be appropriately privileged.</span></div>
<div class="line"><a name="l08340"></a><span class="lineno"> 8340</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08341"></a><span class="lineno"> 8341</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08342"></a><span class="lineno"> 8342</span>&#160;<span class="comment">    Owner and Group Assignment</span></div>
<div class="line"><a name="l08343"></a><span class="lineno"> 8343</span>&#160;<span class="comment">    --------------------------</span></div>
<div class="line"><a name="l08344"></a><span class="lineno"> 8344</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08345"></a><span class="lineno"> 8345</span>&#160;<span class="comment">    The assignment of the new object&#39;s owner and group is governed</span></div>
<div class="line"><a name="l08346"></a><span class="lineno"> 8346</span>&#160;<span class="comment">    by the following logic:</span></div>
<div class="line"><a name="l08347"></a><span class="lineno"> 8347</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08348"></a><span class="lineno"> 8348</span>&#160;<span class="comment">       1)   If the passed security descriptor includes an owner, it</span></div>
<div class="line"><a name="l08349"></a><span class="lineno"> 8349</span>&#160;<span class="comment">            is assigned as the new object&#39;s owner.  Otherwise, the</span></div>
<div class="line"><a name="l08350"></a><span class="lineno"> 8350</span>&#160;<span class="comment">            caller&#39;s token is looked in for the owner.  Within the</span></div>
<div class="line"><a name="l08351"></a><span class="lineno"> 8351</span>&#160;<span class="comment">            token, if there is a default owner, it is assigned.</span></div>
<div class="line"><a name="l08352"></a><span class="lineno"> 8352</span>&#160;<span class="comment">            Otherwise, the caller&#39;s user ID is assigned.</span></div>
<div class="line"><a name="l08353"></a><span class="lineno"> 8353</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08354"></a><span class="lineno"> 8354</span>&#160;<span class="comment">       2)   If the passed security descriptor includes a group, it</span></div>
<div class="line"><a name="l08355"></a><span class="lineno"> 8355</span>&#160;<span class="comment">            is assigned as the new object&#39;s group.  Otherwise, the</span></div>
<div class="line"><a name="l08356"></a><span class="lineno"> 8356</span>&#160;<span class="comment">            caller&#39;s token is looked in for the group.  Within the</span></div>
<div class="line"><a name="l08357"></a><span class="lineno"> 8357</span>&#160;<span class="comment">            token, if there is a default group, it is assigned.</span></div>
<div class="line"><a name="l08358"></a><span class="lineno"> 8358</span>&#160;<span class="comment">            Otherwise, the caller&#39;s primary group ID is assigned.</span></div>
<div class="line"><a name="l08359"></a><span class="lineno"> 8359</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08360"></a><span class="lineno"> 8360</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08361"></a><span class="lineno"> 8361</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l08362"></a><span class="lineno"> 8362</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08363"></a><span class="lineno"> 8363</span>&#160;<span class="comment">    ParentDescriptor - Supplies the Security Descriptor for the parent</span></div>
<div class="line"><a name="l08364"></a><span class="lineno"> 8364</span>&#160;<span class="comment">        directory under which a new object is being created.  If there is</span></div>
<div class="line"><a name="l08365"></a><span class="lineno"> 8365</span>&#160;<span class="comment">        no parent directory, then this argument is specified as NULL.</span></div>
<div class="line"><a name="l08366"></a><span class="lineno"> 8366</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08367"></a><span class="lineno"> 8367</span>&#160;<span class="comment">    CreatorDescriptor - (Optionally) Points to a security descriptor</span></div>
<div class="line"><a name="l08368"></a><span class="lineno"> 8368</span>&#160;<span class="comment">        presented by the creator of the object.  If the creator of the</span></div>
<div class="line"><a name="l08369"></a><span class="lineno"> 8369</span>&#160;<span class="comment">        object did not explicitly pass security information for the new</span></div>
<div class="line"><a name="l08370"></a><span class="lineno"> 8370</span>&#160;<span class="comment">        object, then a null pointer should be passed.</span></div>
<div class="line"><a name="l08371"></a><span class="lineno"> 8371</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08372"></a><span class="lineno"> 8372</span>&#160;<span class="comment">    NewDescriptor - Points to a pointer that is to be made to point to the</span></div>
<div class="line"><a name="l08373"></a><span class="lineno"> 8373</span>&#160;<span class="comment">        newly allocated self-relative security descriptor.</span></div>
<div class="line"><a name="l08374"></a><span class="lineno"> 8374</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08375"></a><span class="lineno"> 8375</span>&#160;<span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span></div>
<div class="line"><a name="l08376"></a><span class="lineno"> 8376</span>&#160;<span class="comment">        created has no GUID associated with it, then this argument is</span></div>
<div class="line"><a name="l08377"></a><span class="lineno"> 8377</span>&#160;<span class="comment">        specified as NULL.</span></div>
<div class="line"><a name="l08378"></a><span class="lineno"> 8378</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08379"></a><span class="lineno"> 8379</span>&#160;<span class="comment">    IsDirectoryObject - Specifies if the new object is going to be a</span></div>
<div class="line"><a name="l08380"></a><span class="lineno"> 8380</span>&#160;<span class="comment">        directory object.  A value of TRUE indicates the object is a</span></div>
<div class="line"><a name="l08381"></a><span class="lineno"> 8381</span>&#160;<span class="comment">        container of other objects.</span></div>
<div class="line"><a name="l08382"></a><span class="lineno"> 8382</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08383"></a><span class="lineno"> 8383</span>&#160;<span class="comment">    AutoInheritFlags - Controls automatic inheritance of ACES from the Parent</span></div>
<div class="line"><a name="l08384"></a><span class="lineno"> 8384</span>&#160;<span class="comment">        Descriptor.  Valid values are a bits mask of the logical OR of</span></div>
<div class="line"><a name="l08385"></a><span class="lineno"> 8385</span>&#160;<span class="comment">        one or more of the following bits:</span></div>
<div class="line"><a name="l08386"></a><span class="lineno"> 8386</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08387"></a><span class="lineno"> 8387</span>&#160;<span class="comment">        SEF_DACL_AUTO_INHERIT - If set, inherit ACEs from the</span></div>
<div class="line"><a name="l08388"></a><span class="lineno"> 8388</span>&#160;<span class="comment">            DACL ParentDescriptor are inherited to NewDescriptor in addition</span></div>
<div class="line"><a name="l08389"></a><span class="lineno"> 8389</span>&#160;<span class="comment">            to any explicit ACEs specified by the CreatorDescriptor.</span></div>
<div class="line"><a name="l08390"></a><span class="lineno"> 8390</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08391"></a><span class="lineno"> 8391</span>&#160;<span class="comment">        SEF_SACL_AUTO_INHERIT - If set, inherit ACEs from the</span></div>
<div class="line"><a name="l08392"></a><span class="lineno"> 8392</span>&#160;<span class="comment">            SACL ParentDescriptor are inherited to NewDescriptor in addition</span></div>
<div class="line"><a name="l08393"></a><span class="lineno"> 8393</span>&#160;<span class="comment">            to any explicit ACEs specified by the CreatorDescriptor.</span></div>
<div class="line"><a name="l08394"></a><span class="lineno"> 8394</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08395"></a><span class="lineno"> 8395</span>&#160;<span class="comment">        SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT - If set, the CreatorDescriptor</span></div>
<div class="line"><a name="l08396"></a><span class="lineno"> 8396</span>&#160;<span class="comment">            is the default descriptor for ObjectType.  As such, the</span></div>
<div class="line"><a name="l08397"></a><span class="lineno"> 8397</span>&#160;<span class="comment">            CreatorDescriptor will be ignored if any ObjectType specific</span></div>
<div class="line"><a name="l08398"></a><span class="lineno"> 8398</span>&#160;<span class="comment">            ACEs are inherited from the parent.  If no such ACEs are inherited,</span></div>
<div class="line"><a name="l08399"></a><span class="lineno"> 8399</span>&#160;<span class="comment">            the CreatorDescriptor is handled as though this flag were not</span></div>
<div class="line"><a name="l08400"></a><span class="lineno"> 8400</span>&#160;<span class="comment">            specified.</span></div>
<div class="line"><a name="l08401"></a><span class="lineno"> 8401</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08402"></a><span class="lineno"> 8402</span>&#160;<span class="comment">        SEF_AVOID_PRIVILEGE_CHECK - If set, no privilege checking is done by this</span></div>
<div class="line"><a name="l08403"></a><span class="lineno"> 8403</span>&#160;<span class="comment">            routine.  This flag is useful while implementing automatic inheritance</span></div>
<div class="line"><a name="l08404"></a><span class="lineno"> 8404</span>&#160;<span class="comment">            to avoid checking privileges on each child updated.</span></div>
<div class="line"><a name="l08405"></a><span class="lineno"> 8405</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08406"></a><span class="lineno"> 8406</span>&#160;<span class="comment">        SEF_AVOID_OWNER_CHECK - If set, no owner checking is done by this routine.</span></div>
<div class="line"><a name="l08407"></a><span class="lineno"> 8407</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08408"></a><span class="lineno"> 8408</span>&#160;<span class="comment">        SEF_DEFAULT_OWNER_FROM_PARENT - If set, the owner of NewDescriptor will</span></div>
<div class="line"><a name="l08409"></a><span class="lineno"> 8409</span>&#160;<span class="comment">            default to the owner from ParentDescriptor.  If not set, the owner</span></div>
<div class="line"><a name="l08410"></a><span class="lineno"> 8410</span>&#160;<span class="comment">            of NewDescriptor will default to the user specified in Token.</span></div>
<div class="line"><a name="l08411"></a><span class="lineno"> 8411</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08412"></a><span class="lineno"> 8412</span>&#160;<span class="comment">            In either case, the owner of NewDescriptor is set to the owner from</span></div>
<div class="line"><a name="l08413"></a><span class="lineno"> 8413</span>&#160;<span class="comment">            the CreatorDescriptor if that field is specified.</span></div>
<div class="line"><a name="l08414"></a><span class="lineno"> 8414</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08415"></a><span class="lineno"> 8415</span>&#160;<span class="comment">        SEF_DEFAULT_GROUP_FROM_PARENT - If set, the group of NewDescriptor will</span></div>
<div class="line"><a name="l08416"></a><span class="lineno"> 8416</span>&#160;<span class="comment">            default to the group from ParentDescriptor.  If not set, the group</span></div>
<div class="line"><a name="l08417"></a><span class="lineno"> 8417</span>&#160;<span class="comment">            of NewDescriptor will default to the group specified in Token.</span></div>
<div class="line"><a name="l08418"></a><span class="lineno"> 8418</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08419"></a><span class="lineno"> 8419</span>&#160;<span class="comment">            In either case, the group of NewDescriptor is set to the group from</span></div>
<div class="line"><a name="l08420"></a><span class="lineno"> 8420</span>&#160;<span class="comment">            the CreatorDescriptor if that field is specified.</span></div>
<div class="line"><a name="l08421"></a><span class="lineno"> 8421</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08422"></a><span class="lineno"> 8422</span>&#160;<span class="comment">    Token - Supplies the token for the client on whose behalf the</span></div>
<div class="line"><a name="l08423"></a><span class="lineno"> 8423</span>&#160;<span class="comment">        object is being created.  If it is an impersonation token,</span></div>
<div class="line"><a name="l08424"></a><span class="lineno"> 8424</span>&#160;<span class="comment">        then it must be at SecurityIdentification level or higher.  If</span></div>
<div class="line"><a name="l08425"></a><span class="lineno"> 8425</span>&#160;<span class="comment">        it is not an impersonation token, the operation proceeds</span></div>
<div class="line"><a name="l08426"></a><span class="lineno"> 8426</span>&#160;<span class="comment">        normally.</span></div>
<div class="line"><a name="l08427"></a><span class="lineno"> 8427</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08428"></a><span class="lineno"> 8428</span>&#160;<span class="comment">        A client token is used to retrieve default security</span></div>
<div class="line"><a name="l08429"></a><span class="lineno"> 8429</span>&#160;<span class="comment">        information for the new object, such as default owner, primary</span></div>
<div class="line"><a name="l08430"></a><span class="lineno"> 8430</span>&#160;<span class="comment">        group, and discretionary access control.  The token must be</span></div>
<div class="line"><a name="l08431"></a><span class="lineno"> 8431</span>&#160;<span class="comment">        open for TOKEN_QUERY access.</span></div>
<div class="line"><a name="l08432"></a><span class="lineno"> 8432</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08433"></a><span class="lineno"> 8433</span>&#160;<span class="comment">        For calls from the kernel, Supplies the security context of the subject creating the</span></div>
<div class="line"><a name="l08434"></a><span class="lineno"> 8434</span>&#160;<span class="comment">        object. This is used to retrieve default security information for the</span></div>
<div class="line"><a name="l08435"></a><span class="lineno"> 8435</span>&#160;<span class="comment">        new object, such as default owner, primary group, and discretionary</span></div>
<div class="line"><a name="l08436"></a><span class="lineno"> 8436</span>&#160;<span class="comment">        access control.</span></div>
<div class="line"><a name="l08437"></a><span class="lineno"> 8437</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08438"></a><span class="lineno"> 8438</span>&#160;<span class="comment">        If not specified, the Owner and Primary group must be specified in the</span></div>
<div class="line"><a name="l08439"></a><span class="lineno"> 8439</span>&#160;<span class="comment">        CreatorDescriptor.</span></div>
<div class="line"><a name="l08440"></a><span class="lineno"> 8440</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08441"></a><span class="lineno"> 8441</span>&#160;<span class="comment">    GenericMapping - Supplies a pointer to a generic mapping array denoting</span></div>
<div class="line"><a name="l08442"></a><span class="lineno"> 8442</span>&#160;<span class="comment">        the mapping between each generic right to specific rights.</span></div>
<div class="line"><a name="l08443"></a><span class="lineno"> 8443</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08444"></a><span class="lineno"> 8444</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l08445"></a><span class="lineno"> 8445</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08446"></a><span class="lineno"> 8446</span>&#160;<span class="comment">    STATUS_SUCCESS - The operation was successful.</span></div>
<div class="line"><a name="l08447"></a><span class="lineno"> 8447</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08448"></a><span class="lineno"> 8448</span>&#160;<span class="comment">    STATUS_INVALID_OWNER - The owner SID provided as the owner of the</span></div>
<div class="line"><a name="l08449"></a><span class="lineno"> 8449</span>&#160;<span class="comment">        target security descriptor is not one the subject is authorized to</span></div>
<div class="line"><a name="l08450"></a><span class="lineno"> 8450</span>&#160;<span class="comment">        assign as the owner of an object.</span></div>
<div class="line"><a name="l08451"></a><span class="lineno"> 8451</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08452"></a><span class="lineno"> 8452</span>&#160;<span class="comment">    STATUS_NO_CLIENT_TOKEN - Indicates a client token was not explicitly</span></div>
<div class="line"><a name="l08453"></a><span class="lineno"> 8453</span>&#160;<span class="comment">        provided and the caller is not currently impersonating a client.</span></div>
<div class="line"><a name="l08454"></a><span class="lineno"> 8454</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08455"></a><span class="lineno"> 8455</span>&#160;<span class="comment">    STATUS_PRIVILEGE_NOT_HELD - The caller does not have the privilege</span></div>
<div class="line"><a name="l08456"></a><span class="lineno"> 8456</span>&#160;<span class="comment">        necessary to explicitly assign the specified system ACL.</span></div>
<div class="line"><a name="l08457"></a><span class="lineno"> 8457</span>&#160;<span class="comment">        SeSecurityPrivilege privilege is needed to explicitly assign</span></div>
<div class="line"><a name="l08458"></a><span class="lineno"> 8458</span>&#160;<span class="comment">        system ACLs to objects.</span></div>
<div class="line"><a name="l08459"></a><span class="lineno"> 8459</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08460"></a><span class="lineno"> 8460</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l08461"></a><span class="lineno"> 8461</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l08462"></a><span class="lineno"> 8462</span>&#160;{</div>
<div class="line"><a name="l08463"></a><span class="lineno"> 8463</span>&#160;</div>
<div class="line"><a name="l08464"></a><span class="lineno"> 8464</span>&#160;</div>
<div class="line"><a name="l08465"></a><span class="lineno"> 8465</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *CapturedDescriptor;</div>
<div class="line"><a name="l08466"></a><span class="lineno"> 8466</span>&#160;    <a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> InCaseOneNotPassed;</div>
<div class="line"><a name="l08467"></a><span class="lineno"> 8467</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SecurityDescriptorPassed;</div>
<div class="line"><a name="l08468"></a><span class="lineno"> 8468</span>&#160;</div>
<div class="line"><a name="l08469"></a><span class="lineno"> 8469</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l08470"></a><span class="lineno"> 8470</span>&#160;</div>
<div class="line"><a name="l08471"></a><span class="lineno"> 8471</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewSacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08472"></a><span class="lineno"> 8472</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewSaclInherited = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08473"></a><span class="lineno"> 8473</span>&#160;</div>
<div class="line"><a name="l08474"></a><span class="lineno"> 8474</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08475"></a><span class="lineno"> 8475</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ServerDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08476"></a><span class="lineno"> 8476</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewDaclInherited = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08477"></a><span class="lineno"> 8477</span>&#160;</div>
<div class="line"><a name="l08478"></a><span class="lineno"> 8478</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewOwner = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08479"></a><span class="lineno"> 8479</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08480"></a><span class="lineno"> 8480</span>&#160;</div>
<div class="line"><a name="l08481"></a><span class="lineno"> 8481</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SaclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08482"></a><span class="lineno"> 8482</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> OwnerExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08483"></a><span class="lineno"> 8483</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DaclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08484"></a><span class="lineno"> 8484</span>&#160;</div>
<div class="line"><a name="l08485"></a><span class="lineno"> 8485</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ServerDaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08486"></a><span class="lineno"> 8486</span>&#160;</div>
<div class="line"><a name="l08487"></a><span class="lineno"> 8487</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ServerObject;</div>
<div class="line"><a name="l08488"></a><span class="lineno"> 8488</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DaclUntrusted;</div>
<div class="line"><a name="l08489"></a><span class="lineno"> 8489</span>&#160;</div>
<div class="line"><a name="l08490"></a><span class="lineno"> 8490</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> HasPrivilege;</div>
<div class="line"><a name="l08491"></a><span class="lineno"> 8491</span>&#160;    <a class="code" href="../../dc/d25/a01406.html">PRIVILEGE_SET</a> PrivilegeSet;</div>
<div class="line"><a name="l08492"></a><span class="lineno"> 8492</span>&#160;</div>
<div class="line"><a name="l08493"></a><span class="lineno"> 8493</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextOwner = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08494"></a><span class="lineno"> 8494</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08495"></a><span class="lineno"> 8495</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerOwner = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08496"></a><span class="lineno"> 8496</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> ServerGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08497"></a><span class="lineno"> 8497</span>&#160;</div>
<div class="line"><a name="l08498"></a><span class="lineno"> 8498</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> SubjectContextDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08499"></a><span class="lineno"> 8499</span>&#160;</div>
<div class="line"><a name="l08500"></a><span class="lineno"> 8500</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d7/d24/a02261.html#a053c57ea472f2605ef6d732f25e5c6b8">AllocationSize</a>;</div>
<div class="line"><a name="l08501"></a><span class="lineno"> 8501</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewOwnerSize, OwnerSize;</div>
<div class="line"><a name="l08502"></a><span class="lineno"> 8502</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewGroupSize, GroupSize;</div>
<div class="line"><a name="l08503"></a><span class="lineno"> 8503</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewSaclSize;</div>
<div class="line"><a name="l08504"></a><span class="lineno"> 8504</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewDaclSize;</div>
<div class="line"><a name="l08505"></a><span class="lineno"> 8505</span>&#160;</div>
<div class="line"><a name="l08506"></a><span class="lineno"> 8506</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Field;</div>
<div class="line"><a name="l08507"></a><span class="lineno"> 8507</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Base;</div>
<div class="line"><a name="l08508"></a><span class="lineno"> 8508</span>&#160;</div>
<div class="line"><a name="l08509"></a><span class="lineno"> 8509</span>&#160;</div>
<div class="line"><a name="l08510"></a><span class="lineno"> 8510</span>&#160;</div>
<div class="line"><a name="l08511"></a><span class="lineno"> 8511</span>&#160;    <a class="code" href="../../d6/d91/a01587.html">PISECURITY_DESCRIPTOR_RELATIVE</a> INewDescriptor = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08512"></a><span class="lineno"> 8512</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> PassedStatus;</div>
<div class="line"><a name="l08513"></a><span class="lineno"> 8513</span>&#160;    <a class="code" href="../../dd/dc3/a02249.html#a425eea3f57239dc3a8b77669eba3ca97">KPROCESSOR_MODE</a> RequestorMode;</div>
<div class="line"><a name="l08514"></a><span class="lineno"> 8514</span>&#160;</div>
<div class="line"><a name="l08515"></a><span class="lineno"> 8515</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GenericControl;</div>
<div class="line"><a name="l08516"></a><span class="lineno"> 8516</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewControlBits = <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>;</div>
<div class="line"><a name="l08517"></a><span class="lineno"> 8517</span>&#160;</div>
<div class="line"><a name="l08518"></a><span class="lineno"> 8518</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08519"></a><span class="lineno"> 8519</span>&#160;    <span class="comment">// For kernel mode callers, the Token parameter is really</span></div>
<div class="line"><a name="l08520"></a><span class="lineno"> 8520</span>&#160;    <span class="comment">// a pointer to a subject context structure.</span></div>
<div class="line"><a name="l08521"></a><span class="lineno"> 8521</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08522"></a><span class="lineno"> 8522</span>&#160;</div>
<div class="line"><a name="l08523"></a><span class="lineno"> 8523</span>&#160;    <a class="code" href="../../dc/d42/a01591.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;</div>
<div class="line"><a name="l08524"></a><span class="lineno"> 8524</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> SubjectContextInfo = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08525"></a><span class="lineno"> 8525</span>&#160;</div>
<div class="line"><a name="l08526"></a><span class="lineno"> 8526</span>&#160;    SubjectSecurityContext = (<a class="code" href="../../d3/d81/a02284.html#a0f80046299c6f5ace2b38d769508fde6">PSECURITY_SUBJECT_CONTEXT</a>)Token;</div>
<div class="line"><a name="l08527"></a><span class="lineno"> 8527</span>&#160;</div>
<div class="line"><a name="l08528"></a><span class="lineno"> 8528</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l08529"></a><span class="lineno"> 8529</span>&#160;</div>
<div class="line"><a name="l08530"></a><span class="lineno"> 8530</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08531"></a><span class="lineno"> 8531</span>&#160;    <span class="comment">//  Get the previous mode of the caller</span></div>
<div class="line"><a name="l08532"></a><span class="lineno"> 8532</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08533"></a><span class="lineno"> 8533</span>&#160;</div>
<div class="line"><a name="l08534"></a><span class="lineno"> 8534</span>&#160;    RequestorMode = <a class="code" href="../../dc/d43/a02205.html#a59359495801dfca8e1fbc3196348a0db">KeGetPreviousMode</a>();</div>
<div class="line"><a name="l08535"></a><span class="lineno"> 8535</span>&#160;</div>
<div class="line"><a name="l08536"></a><span class="lineno"> 8536</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08537"></a><span class="lineno"> 8537</span>&#160;    <span class="comment">//  The desired end result is to build a self-relative security descriptor.</span></div>
<div class="line"><a name="l08538"></a><span class="lineno"> 8538</span>&#160;    <span class="comment">//  This means that a single block of memory will be allocated and all</span></div>
<div class="line"><a name="l08539"></a><span class="lineno"> 8539</span>&#160;    <span class="comment">//  security information copied into it.  To minimize work along the way,</span></div>
<div class="line"><a name="l08540"></a><span class="lineno"> 8540</span>&#160;    <span class="comment">//  it is desirable to reference (rather than copy) each field as we</span></div>
<div class="line"><a name="l08541"></a><span class="lineno"> 8541</span>&#160;    <span class="comment">//  determine its source.  This can not be done with inherited ACLs, however,</span></div>
<div class="line"><a name="l08542"></a><span class="lineno"> 8542</span>&#160;    <span class="comment">//  since they must be built from another ACL.  So, explicitly assigned</span></div>
<div class="line"><a name="l08543"></a><span class="lineno"> 8543</span>&#160;    <span class="comment">//  and defaulted SIDs and ACLs are just referenced until they are copied</span></div>
<div class="line"><a name="l08544"></a><span class="lineno"> 8544</span>&#160;    <span class="comment">//  into the self-relative descriptor.  Inherited ACLs are built in a</span></div>
<div class="line"><a name="l08545"></a><span class="lineno"> 8545</span>&#160;    <span class="comment">//  temporary buffer which must be deallocated after being copied to the</span></div>
<div class="line"><a name="l08546"></a><span class="lineno"> 8546</span>&#160;    <span class="comment">//  self-relative descriptor.</span></div>
<div class="line"><a name="l08547"></a><span class="lineno"> 8547</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08548"></a><span class="lineno"> 8548</span>&#160;</div>
<div class="line"><a name="l08549"></a><span class="lineno"> 8549</span>&#160;</div>
<div class="line"><a name="l08550"></a><span class="lineno"> 8550</span>&#160;</div>
<div class="line"><a name="l08551"></a><span class="lineno"> 8551</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08552"></a><span class="lineno"> 8552</span>&#160;    <span class="comment">//  If a security descriptor has been passed, capture it, otherwise</span></div>
<div class="line"><a name="l08553"></a><span class="lineno"> 8553</span>&#160;    <span class="comment">//  cobble up a fake one to simplify the code that follows.</span></div>
<div class="line"><a name="l08554"></a><span class="lineno"> 8554</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08555"></a><span class="lineno"> 8555</span>&#160;</div>
<div class="line"><a name="l08556"></a><span class="lineno"> 8556</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(CreatorDescriptor)) {</div>
<div class="line"><a name="l08557"></a><span class="lineno"> 8557</span>&#160;</div>
<div class="line"><a name="l08558"></a><span class="lineno"> 8558</span>&#160;        CapturedDescriptor = CreatorDescriptor;</div>
<div class="line"><a name="l08559"></a><span class="lineno"> 8559</span>&#160;        SecurityDescriptorPassed = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08560"></a><span class="lineno"> 8560</span>&#160;</div>
<div class="line"><a name="l08561"></a><span class="lineno"> 8561</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08562"></a><span class="lineno"> 8562</span>&#160;</div>
<div class="line"><a name="l08563"></a><span class="lineno"> 8563</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08564"></a><span class="lineno"> 8564</span>&#160;        <span class="comment">//  No descriptor passed, make a fake one</span></div>
<div class="line"><a name="l08565"></a><span class="lineno"> 8565</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08566"></a><span class="lineno"> 8566</span>&#160;</div>
<div class="line"><a name="l08567"></a><span class="lineno"> 8567</span>&#160;        SecurityDescriptorPassed = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08568"></a><span class="lineno"> 8568</span>&#160;</div>
<div class="line"><a name="l08569"></a><span class="lineno"> 8569</span>&#160;        <a class="code" href="../../d3/d32/a02665.html#a456d1320fc92eae0407d43dc33e61448">RtlCreateSecurityDescriptor</a>(&amp;InCaseOneNotPassed,</div>
<div class="line"><a name="l08570"></a><span class="lineno"> 8570</span>&#160;                                    <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>);</div>
<div class="line"><a name="l08571"></a><span class="lineno"> 8571</span>&#160;        CapturedDescriptor = &amp;InCaseOneNotPassed;</div>
<div class="line"><a name="l08572"></a><span class="lineno"> 8572</span>&#160;</div>
<div class="line"><a name="l08573"></a><span class="lineno"> 8573</span>&#160;    }</div>
<div class="line"><a name="l08574"></a><span class="lineno"> 8574</span>&#160;</div>
<div class="line"><a name="l08575"></a><span class="lineno"> 8575</span>&#160;</div>
<div class="line"><a name="l08576"></a><span class="lineno"> 8576</span>&#160;    <span class="keywordflow">if</span> ( CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a39e75889cffac1a2830c354f27ea1b43">SE_SERVER_SECURITY</a> ) {</div>
<div class="line"><a name="l08577"></a><span class="lineno"> 8577</span>&#160;        ServerObject = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08578"></a><span class="lineno"> 8578</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08579"></a><span class="lineno"> 8579</span>&#160;        ServerObject = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08580"></a><span class="lineno"> 8580</span>&#160;    }</div>
<div class="line"><a name="l08581"></a><span class="lineno"> 8581</span>&#160;</div>
<div class="line"><a name="l08582"></a><span class="lineno"> 8582</span>&#160;    <span class="keywordflow">if</span> ( CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a8d0e3871ec8a12b6bcda7c0858ba64be">SE_DACL_UNTRUSTED</a> ) {</div>
<div class="line"><a name="l08583"></a><span class="lineno"> 8583</span>&#160;        DaclUntrusted = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08584"></a><span class="lineno"> 8584</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08585"></a><span class="lineno"> 8585</span>&#160;        DaclUntrusted = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l08586"></a><span class="lineno"> 8586</span>&#160;    }</div>
<div class="line"><a name="l08587"></a><span class="lineno"> 8587</span>&#160;</div>
<div class="line"><a name="l08588"></a><span class="lineno"> 8588</span>&#160;</div>
<div class="line"><a name="l08589"></a><span class="lineno"> 8589</span>&#160;</div>
<div class="line"><a name="l08590"></a><span class="lineno"> 8590</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08591"></a><span class="lineno"> 8591</span>&#160;    <span class="comment">// Get the required information from the token.</span></div>
<div class="line"><a name="l08592"></a><span class="lineno"> 8592</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08593"></a><span class="lineno"> 8593</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08594"></a><span class="lineno"> 8594</span>&#160;    <span class="comment">// Grab pointers to the default owner, primary group, and</span></div>
<div class="line"><a name="l08595"></a><span class="lineno"> 8595</span>&#160;    <span class="comment">// discretionary ACL.</span></div>
<div class="line"><a name="l08596"></a><span class="lineno"> 8596</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08597"></a><span class="lineno"> 8597</span>&#160;    <span class="keywordflow">if</span> ( Token != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ServerObject ) {</div>
<div class="line"><a name="l08598"></a><span class="lineno"> 8598</span>&#160;</div>
<div class="line"><a name="l08599"></a><span class="lineno"> 8599</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> TmpSubjectContextOwner = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08600"></a><span class="lineno"> 8600</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> TmpSubjectContextGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08601"></a><span class="lineno"> 8601</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> TmpServerOwner = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08602"></a><span class="lineno"> 8602</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> TmpServerGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08603"></a><span class="lineno"> 8603</span>&#160;</div>
<div class="line"><a name="l08604"></a><span class="lineno"> 8604</span>&#160;        <a class="code" href="../../d7/dd4/a00013.html">PACL</a> TmpSubjectContextDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08605"></a><span class="lineno"> 8605</span>&#160;</div>
<div class="line"><a name="l08606"></a><span class="lineno"> 8606</span>&#160;        <a class="code" href="../../de/d48/a02167.html#af8429def935ee9a571d3e6dfffc3e790">SIZE_T</a> SubjectContextInfoSize = 0;</div>
<div class="line"><a name="l08607"></a><span class="lineno"> 8607</span>&#160;</div>
<div class="line"><a name="l08608"></a><span class="lineno"> 8608</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08609"></a><span class="lineno"> 8609</span>&#160;        <span class="comment">// Lock the subject context for read access so that the pointers</span></div>
<div class="line"><a name="l08610"></a><span class="lineno"> 8610</span>&#160;        <span class="comment">// we copy out of it don&#39;t disappear on us at random</span></div>
<div class="line"><a name="l08611"></a><span class="lineno"> 8611</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08612"></a><span class="lineno"> 8612</span>&#160;</div>
<div class="line"><a name="l08613"></a><span class="lineno"> 8613</span>&#160;        <a class="code" href="../../d3/d81/a02284.html#a2d307979d30aaaa35f263e78b6503fe0">SeLockSubjectContext</a>( SubjectSecurityContext );</div>
<div class="line"><a name="l08614"></a><span class="lineno"> 8614</span>&#160;</div>
<div class="line"><a name="l08615"></a><span class="lineno"> 8615</span>&#160;        <a class="code" href="../../dd/dee/a02700.html#a9815296fd3bf6e2f58aaf39bf0673148">SepGetDefaultsSubjectContext</a>(</div>
<div class="line"><a name="l08616"></a><span class="lineno"> 8616</span>&#160;            SubjectSecurityContext,</div>
<div class="line"><a name="l08617"></a><span class="lineno"> 8617</span>&#160;            &amp;TmpSubjectContextOwner,</div>
<div class="line"><a name="l08618"></a><span class="lineno"> 8618</span>&#160;            &amp;TmpSubjectContextGroup,</div>
<div class="line"><a name="l08619"></a><span class="lineno"> 8619</span>&#160;            &amp;TmpServerOwner,</div>
<div class="line"><a name="l08620"></a><span class="lineno"> 8620</span>&#160;            &amp;TmpServerGroup,</div>
<div class="line"><a name="l08621"></a><span class="lineno"> 8621</span>&#160;            &amp;TmpSubjectContextDacl</div>
<div class="line"><a name="l08622"></a><span class="lineno"> 8622</span>&#160;            );</div>
<div class="line"><a name="l08623"></a><span class="lineno"> 8623</span>&#160;</div>
<div class="line"><a name="l08624"></a><span class="lineno"> 8624</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08625"></a><span class="lineno"> 8625</span>&#160;        <span class="comment">// We can&#39;t keep the subject context locked, because</span></div>
<div class="line"><a name="l08626"></a><span class="lineno"> 8626</span>&#160;        <span class="comment">// we may have to do a privilege check later, which calls</span></div>
<div class="line"><a name="l08627"></a><span class="lineno"> 8627</span>&#160;        <span class="comment">// PsLockProcessSecurityFields, which can cause a deadlock</span></div>
<div class="line"><a name="l08628"></a><span class="lineno"> 8628</span>&#160;        <span class="comment">// with PsImpersonateClient, which takes them in the reverse</span></div>
<div class="line"><a name="l08629"></a><span class="lineno"> 8629</span>&#160;        <span class="comment">// order.</span></div>
<div class="line"><a name="l08630"></a><span class="lineno"> 8630</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08631"></a><span class="lineno"> 8631</span>&#160;        <span class="comment">// Since we&#39;re giving up our read lock on the token, we</span></div>
<div class="line"><a name="l08632"></a><span class="lineno"> 8632</span>&#160;        <span class="comment">// need to copy all the stuff that we just got back.  Since</span></div>
<div class="line"><a name="l08633"></a><span class="lineno"> 8633</span>&#160;        <span class="comment">// it&#39;s not going to change, we can save some cycles and copy</span></div>
<div class="line"><a name="l08634"></a><span class="lineno"> 8634</span>&#160;        <span class="comment">// it all into a single chunck of memory.</span></div>
<div class="line"><a name="l08635"></a><span class="lineno"> 8635</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08636"></a><span class="lineno"> 8636</span>&#160;</div>
<div class="line"><a name="l08637"></a><span class="lineno"> 8637</span>&#160;        SubjectContextInfoSize = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextOwner ) +</div>
<div class="line"><a name="l08638"></a><span class="lineno"> 8638</span>&#160;                                 <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerOwner )         +</div>
<div class="line"><a name="l08639"></a><span class="lineno"> 8639</span>&#160;                                 (TmpSubjectContextGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ? <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextGroup ) : 0) +</div>
<div class="line"><a name="l08640"></a><span class="lineno"> 8640</span>&#160;                                 (TmpServerGroup         != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ? <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerGroup )         : 0) +</div>
<div class="line"><a name="l08641"></a><span class="lineno"> 8641</span>&#160;                                 (TmpSubjectContextDacl  != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ? TmpSubjectContextDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>        : 0);</div>
<div class="line"><a name="l08642"></a><span class="lineno"> 8642</span>&#160;</div>
<div class="line"><a name="l08643"></a><span class="lineno"> 8643</span>&#160;        SubjectContextInfo = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>, SubjectContextInfoSize, <span class="stringliteral">&#39;dSeS&#39;</span>);</div>
<div class="line"><a name="l08644"></a><span class="lineno"> 8644</span>&#160;</div>
<div class="line"><a name="l08645"></a><span class="lineno"> 8645</span>&#160;        <span class="keywordflow">if</span> (SubjectContextInfo) {</div>
<div class="line"><a name="l08646"></a><span class="lineno"> 8646</span>&#160;</div>
<div class="line"><a name="l08647"></a><span class="lineno"> 8647</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08648"></a><span class="lineno"> 8648</span>&#160;            <span class="comment">// Copy in the data</span></div>
<div class="line"><a name="l08649"></a><span class="lineno"> 8649</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08650"></a><span class="lineno"> 8650</span>&#160;</div>
<div class="line"><a name="l08651"></a><span class="lineno"> 8651</span>&#160;            Base = SubjectContextInfo;</div>
<div class="line"><a name="l08652"></a><span class="lineno"> 8652</span>&#160;</div>
<div class="line"><a name="l08653"></a><span class="lineno"> 8653</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08654"></a><span class="lineno"> 8654</span>&#160;            <span class="comment">// There will always be an owner.</span></div>
<div class="line"><a name="l08655"></a><span class="lineno"> 8655</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08656"></a><span class="lineno"> 8656</span>&#160;</div>
<div class="line"><a name="l08657"></a><span class="lineno"> 8657</span>&#160;            SubjectContextOwner = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)Base;</div>
<div class="line"><a name="l08658"></a><span class="lineno"> 8658</span>&#160;            <a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a>( <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextOwner), Base, TmpSubjectContextOwner );</div>
<div class="line"><a name="l08659"></a><span class="lineno"> 8659</span>&#160;            Base += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextOwner);</div>
<div class="line"><a name="l08660"></a><span class="lineno"> 8660</span>&#160;</div>
<div class="line"><a name="l08661"></a><span class="lineno"> 8661</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08662"></a><span class="lineno"> 8662</span>&#160;            <span class="comment">// Groups may be NULL</span></div>
<div class="line"><a name="l08663"></a><span class="lineno"> 8663</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08664"></a><span class="lineno"> 8664</span>&#160;</div>
<div class="line"><a name="l08665"></a><span class="lineno"> 8665</span>&#160;            <span class="keywordflow">if</span> (TmpSubjectContextGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08666"></a><span class="lineno"> 8666</span>&#160;                SubjectContextGroup = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)Base;</div>
<div class="line"><a name="l08667"></a><span class="lineno"> 8667</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a>( <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextGroup), Base, TmpSubjectContextGroup );</div>
<div class="line"><a name="l08668"></a><span class="lineno"> 8668</span>&#160;                Base += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpSubjectContextGroup );</div>
<div class="line"><a name="l08669"></a><span class="lineno"> 8669</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08670"></a><span class="lineno"> 8670</span>&#160;                SubjectContextGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08671"></a><span class="lineno"> 8671</span>&#160;            }</div>
<div class="line"><a name="l08672"></a><span class="lineno"> 8672</span>&#160;</div>
<div class="line"><a name="l08673"></a><span class="lineno"> 8673</span>&#160;            ServerOwner = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)Base;</div>
<div class="line"><a name="l08674"></a><span class="lineno"> 8674</span>&#160;            <a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a>( <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerOwner ), Base, TmpServerOwner );</div>
<div class="line"><a name="l08675"></a><span class="lineno"> 8675</span>&#160;            Base += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerOwner );</div>
<div class="line"><a name="l08676"></a><span class="lineno"> 8676</span>&#160;</div>
<div class="line"><a name="l08677"></a><span class="lineno"> 8677</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08678"></a><span class="lineno"> 8678</span>&#160;            <span class="comment">// Groups may be NULL</span></div>
<div class="line"><a name="l08679"></a><span class="lineno"> 8679</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08680"></a><span class="lineno"> 8680</span>&#160;</div>
<div class="line"><a name="l08681"></a><span class="lineno"> 8681</span>&#160;            <span class="keywordflow">if</span> (TmpServerGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08682"></a><span class="lineno"> 8682</span>&#160;                ServerGroup = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)Base;</div>
<div class="line"><a name="l08683"></a><span class="lineno"> 8683</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a>( <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerGroup ), Base, TmpServerGroup );</div>
<div class="line"><a name="l08684"></a><span class="lineno"> 8684</span>&#160;                Base += <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>( TmpServerGroup );</div>
<div class="line"><a name="l08685"></a><span class="lineno"> 8685</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08686"></a><span class="lineno"> 8686</span>&#160;                ServerGroup = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08687"></a><span class="lineno"> 8687</span>&#160;            }</div>
<div class="line"><a name="l08688"></a><span class="lineno"> 8688</span>&#160;</div>
<div class="line"><a name="l08689"></a><span class="lineno"> 8689</span>&#160;            <span class="keywordflow">if</span> (TmpSubjectContextDacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08690"></a><span class="lineno"> 8690</span>&#160;                SubjectContextDacl = (<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>)Base;</div>
<div class="line"><a name="l08691"></a><span class="lineno"> 8691</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Base, TmpSubjectContextDacl, TmpSubjectContextDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l08692"></a><span class="lineno"> 8692</span>&#160;                <span class="comment">// Base += TmpSubjectContextDacl-&gt;AclSize;</span></div>
<div class="line"><a name="l08693"></a><span class="lineno"> 8693</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08694"></a><span class="lineno"> 8694</span>&#160;                SubjectContextDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l08695"></a><span class="lineno"> 8695</span>&#160;            }</div>
<div class="line"><a name="l08696"></a><span class="lineno"> 8696</span>&#160;</div>
<div class="line"><a name="l08697"></a><span class="lineno"> 8697</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08698"></a><span class="lineno"> 8698</span>&#160;</div>
<div class="line"><a name="l08699"></a><span class="lineno"> 8699</span>&#160;            <a class="code" href="../../d3/d81/a02284.html#aa25242f85c1cf107ce24237f5836c527">SeUnlockSubjectContext</a>( SubjectSecurityContext );</div>
<div class="line"><a name="l08700"></a><span class="lineno"> 8700</span>&#160;</div>
<div class="line"><a name="l08701"></a><span class="lineno"> 8701</span>&#160;            <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#aeb86c04f9593b4cdb1b56c71e76d2e36">STATUS_INSUFFICIENT_RESOURCES</a> );</div>
<div class="line"><a name="l08702"></a><span class="lineno"> 8702</span>&#160;        }</div>
<div class="line"><a name="l08703"></a><span class="lineno"> 8703</span>&#160;</div>
<div class="line"><a name="l08704"></a><span class="lineno"> 8704</span>&#160;        <a class="code" href="../../d3/d81/a02284.html#aa25242f85c1cf107ce24237f5836c527">SeUnlockSubjectContext</a>( SubjectSecurityContext );</div>
<div class="line"><a name="l08705"></a><span class="lineno"> 8705</span>&#160;    }</div>
<div class="line"><a name="l08706"></a><span class="lineno"> 8706</span>&#160;</div>
<div class="line"><a name="l08707"></a><span class="lineno"> 8707</span>&#160;</div>
<div class="line"><a name="l08708"></a><span class="lineno"> 8708</span>&#160;</div>
<div class="line"><a name="l08709"></a><span class="lineno"> 8709</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08710"></a><span class="lineno"> 8710</span>&#160;    <span class="comment">// Establish an owner SID</span></div>
<div class="line"><a name="l08711"></a><span class="lineno"> 8711</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08712"></a><span class="lineno"> 8712</span>&#160;</div>
<div class="line"><a name="l08713"></a><span class="lineno"> 8713</span>&#160;    NewOwner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>(CapturedDescriptor);</div>
<div class="line"><a name="l08714"></a><span class="lineno"> 8714</span>&#160;</div>
<div class="line"><a name="l08715"></a><span class="lineno"> 8715</span>&#160;    <span class="keywordflow">if</span> ((NewOwner) != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08716"></a><span class="lineno"> 8716</span>&#160;</div>
<div class="line"><a name="l08717"></a><span class="lineno"> 8717</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08718"></a><span class="lineno"> 8718</span>&#160;        <span class="comment">// Use the specified owner</span></div>
<div class="line"><a name="l08719"></a><span class="lineno"> 8719</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08720"></a><span class="lineno"> 8720</span>&#160;</div>
<div class="line"><a name="l08721"></a><span class="lineno"> 8721</span>&#160;        OwnerExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08722"></a><span class="lineno"> 8722</span>&#160;</div>
<div class="line"><a name="l08723"></a><span class="lineno"> 8723</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08724"></a><span class="lineno"> 8724</span>&#160;</div>
<div class="line"><a name="l08725"></a><span class="lineno"> 8725</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08726"></a><span class="lineno"> 8726</span>&#160;        <span class="comment">// If the caller said to default the owner from the parent descriptor,</span></div>
<div class="line"><a name="l08727"></a><span class="lineno"> 8727</span>&#160;        <span class="comment">//  grab it now.</span></div>
<div class="line"><a name="l08728"></a><span class="lineno"> 8728</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08729"></a><span class="lineno"> 8729</span>&#160;</div>
<div class="line"><a name="l08730"></a><span class="lineno"> 8730</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#ad69196aefc264e1a286ffa1a5482c629">SEF_DEFAULT_OWNER_FROM_PARENT</a>) {</div>
<div class="line"><a name="l08731"></a><span class="lineno"> 8731</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ) {</div>
<div class="line"><a name="l08732"></a><span class="lineno"> 8732</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a>;</div>
<div class="line"><a name="l08733"></a><span class="lineno"> 8733</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08734"></a><span class="lineno"> 8734</span>&#160;            }</div>
<div class="line"><a name="l08735"></a><span class="lineno"> 8735</span>&#160;            NewOwner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor);</div>
<div class="line"><a name="l08736"></a><span class="lineno"> 8736</span>&#160;            OwnerExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08737"></a><span class="lineno"> 8737</span>&#160;</div>
<div class="line"><a name="l08738"></a><span class="lineno"> 8738</span>&#160;            <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l08739"></a><span class="lineno"> 8739</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a>;</div>
<div class="line"><a name="l08740"></a><span class="lineno"> 8740</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08741"></a><span class="lineno"> 8741</span>&#160;            }</div>
<div class="line"><a name="l08742"></a><span class="lineno"> 8742</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08743"></a><span class="lineno"> 8743</span>&#160;</div>
<div class="line"><a name="l08744"></a><span class="lineno"> 8744</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08745"></a><span class="lineno"> 8745</span>&#160;            <span class="comment">// Pick up the default from the subject&#39;s security context.</span></div>
<div class="line"><a name="l08746"></a><span class="lineno"> 8746</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08747"></a><span class="lineno"> 8747</span>&#160;            <span class="comment">// This does NOT constitute explicit assignment of owner</span></div>
<div class="line"><a name="l08748"></a><span class="lineno"> 8748</span>&#160;            <span class="comment">// and does not have to be checked as an ID that can be</span></div>
<div class="line"><a name="l08749"></a><span class="lineno"> 8749</span>&#160;            <span class="comment">// assigned as owner.  This is because a default can not</span></div>
<div class="line"><a name="l08750"></a><span class="lineno"> 8750</span>&#160;            <span class="comment">// be established in a token unless the user of the token</span></div>
<div class="line"><a name="l08751"></a><span class="lineno"> 8751</span>&#160;            <span class="comment">// can assign it as an owner.</span></div>
<div class="line"><a name="l08752"></a><span class="lineno"> 8752</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08753"></a><span class="lineno"> 8753</span>&#160;</div>
<div class="line"><a name="l08754"></a><span class="lineno"> 8754</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08755"></a><span class="lineno"> 8755</span>&#160;            <span class="comment">// If we&#39;ve been asked to create a ServerObject, we need to</span></div>
<div class="line"><a name="l08756"></a><span class="lineno"> 8756</span>&#160;            <span class="comment">// make sure to pick up the new owner from the Primary token,</span></div>
<div class="line"><a name="l08757"></a><span class="lineno"> 8757</span>&#160;            <span class="comment">// not the client token.  If we&#39;re not impersonating, they will</span></div>
<div class="line"><a name="l08758"></a><span class="lineno"> 8758</span>&#160;            <span class="comment">// end up being the same.</span></div>
<div class="line"><a name="l08759"></a><span class="lineno"> 8759</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08760"></a><span class="lineno"> 8760</span>&#160;</div>
<div class="line"><a name="l08761"></a><span class="lineno"> 8761</span>&#160;            NewOwner = ServerObject ? ServerOwner : SubjectContextOwner;</div>
<div class="line"><a name="l08762"></a><span class="lineno"> 8762</span>&#160;</div>
<div class="line"><a name="l08763"></a><span class="lineno"> 8763</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08764"></a><span class="lineno"> 8764</span>&#160;            <span class="comment">// Ensure an owner is now defined.</span></div>
<div class="line"><a name="l08765"></a><span class="lineno"> 8765</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08766"></a><span class="lineno"> 8766</span>&#160;</div>
<div class="line"><a name="l08767"></a><span class="lineno"> 8767</span>&#160;            <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l08768"></a><span class="lineno"> 8768</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#a061ab569ad0e495f99eb4dd005951170">STATUS_NO_TOKEN</a>;</div>
<div class="line"><a name="l08769"></a><span class="lineno"> 8769</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08770"></a><span class="lineno"> 8770</span>&#160;            }</div>
<div class="line"><a name="l08771"></a><span class="lineno"> 8771</span>&#160;        }</div>
<div class="line"><a name="l08772"></a><span class="lineno"> 8772</span>&#160;    }</div>
<div class="line"><a name="l08773"></a><span class="lineno"> 8773</span>&#160;</div>
<div class="line"><a name="l08774"></a><span class="lineno"> 8774</span>&#160;</div>
<div class="line"><a name="l08775"></a><span class="lineno"> 8775</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08776"></a><span class="lineno"> 8776</span>&#160;    <span class="comment">// Establish a Group SID</span></div>
<div class="line"><a name="l08777"></a><span class="lineno"> 8777</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08778"></a><span class="lineno"> 8778</span>&#160;</div>
<div class="line"><a name="l08779"></a><span class="lineno"> 8779</span>&#160;    NewGroup = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(CapturedDescriptor);</div>
<div class="line"><a name="l08780"></a><span class="lineno"> 8780</span>&#160;</div>
<div class="line"><a name="l08781"></a><span class="lineno"> 8781</span>&#160;    <span class="keywordflow">if</span> (NewGroup == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08782"></a><span class="lineno"> 8782</span>&#160;</div>
<div class="line"><a name="l08783"></a><span class="lineno"> 8783</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08784"></a><span class="lineno"> 8784</span>&#160;        <span class="comment">// If the caller said to default the group from the parent descriptor,</span></div>
<div class="line"><a name="l08785"></a><span class="lineno"> 8785</span>&#160;        <span class="comment">//  grab it now.</span></div>
<div class="line"><a name="l08786"></a><span class="lineno"> 8786</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08787"></a><span class="lineno"> 8787</span>&#160;</div>
<div class="line"><a name="l08788"></a><span class="lineno"> 8788</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#a9516e3561b7fb36a8b060127348f450b">SEF_DEFAULT_GROUP_FROM_PARENT</a>) {</div>
<div class="line"><a name="l08789"></a><span class="lineno"> 8789</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ) {</div>
<div class="line"><a name="l08790"></a><span class="lineno"> 8790</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#ad61c566fa6f03ba2aa2d05700cdc5ea5">STATUS_INVALID_PRIMARY_GROUP</a>;</div>
<div class="line"><a name="l08791"></a><span class="lineno"> 8791</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08792"></a><span class="lineno"> 8792</span>&#160;            }</div>
<div class="line"><a name="l08793"></a><span class="lineno"> 8793</span>&#160;            NewGroup = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor);</div>
<div class="line"><a name="l08794"></a><span class="lineno"> 8794</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08795"></a><span class="lineno"> 8795</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08796"></a><span class="lineno"> 8796</span>&#160;            <span class="comment">// Pick up the primary group from the subject&#39;s security context</span></div>
<div class="line"><a name="l08797"></a><span class="lineno"> 8797</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08798"></a><span class="lineno"> 8798</span>&#160;            <span class="comment">// If we&#39;re creating a Server object, use the group from the server</span></div>
<div class="line"><a name="l08799"></a><span class="lineno"> 8799</span>&#160;            <span class="comment">// context.</span></div>
<div class="line"><a name="l08800"></a><span class="lineno"> 8800</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08801"></a><span class="lineno"> 8801</span>&#160;</div>
<div class="line"><a name="l08802"></a><span class="lineno"> 8802</span>&#160;            NewGroup = ServerObject ? ServerGroup : SubjectContextGroup;</div>
<div class="line"><a name="l08803"></a><span class="lineno"> 8803</span>&#160;</div>
<div class="line"><a name="l08804"></a><span class="lineno"> 8804</span>&#160;        }</div>
<div class="line"><a name="l08805"></a><span class="lineno"> 8805</span>&#160;</div>
<div class="line"><a name="l08806"></a><span class="lineno"> 8806</span>&#160;    }</div>
<div class="line"><a name="l08807"></a><span class="lineno"> 8807</span>&#160;</div>
<div class="line"><a name="l08808"></a><span class="lineno"> 8808</span>&#160;    <span class="keywordflow">if</span> (NewGroup == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l08809"></a><span class="lineno"> 8809</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#ad61c566fa6f03ba2aa2d05700cdc5ea5">STATUS_INVALID_PRIMARY_GROUP</a>;</div>
<div class="line"><a name="l08810"></a><span class="lineno"> 8810</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08811"></a><span class="lineno"> 8811</span>&#160;    }</div>
<div class="line"><a name="l08812"></a><span class="lineno"> 8812</span>&#160;</div>
<div class="line"><a name="l08813"></a><span class="lineno"> 8813</span>&#160;</div>
<div class="line"><a name="l08814"></a><span class="lineno"> 8814</span>&#160;</div>
<div class="line"><a name="l08815"></a><span class="lineno"> 8815</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08816"></a><span class="lineno"> 8816</span>&#160;    <span class="comment">// Establish System Acl</span></div>
<div class="line"><a name="l08817"></a><span class="lineno"> 8817</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08818"></a><span class="lineno"> 8818</span>&#160;</div>
<div class="line"><a name="l08819"></a><span class="lineno"> 8819</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a> (</div>
<div class="line"><a name="l08820"></a><span class="lineno"> 8820</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ?</div>
<div class="line"><a name="l08821"></a><span class="lineno"> 8821</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(</div>
<div class="line"><a name="l08822"></a><span class="lineno"> 8822</span>&#160;                        ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor)) :</div>
<div class="line"><a name="l08823"></a><span class="lineno"> 8823</span>&#160;                    <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line"><a name="l08824"></a><span class="lineno"> 8824</span>&#160;                <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(CapturedDescriptor),</div>
<div class="line"><a name="l08825"></a><span class="lineno"> 8825</span>&#160;                <a class="code" href="../../df/d4d/a02285.html#a478668a3f7d97d76ab60a908fd5a4780">SeControlSaclToGeneric</a>( CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> ),</div>
<div class="line"><a name="l08826"></a><span class="lineno"> 8826</span>&#160;                IsDirectoryObject,</div>
<div class="line"><a name="l08827"></a><span class="lineno"> 8827</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)((AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#ab31f4c0fab101f20d852eb7b68b57cd4">SEF_SACL_AUTO_INHERIT</a>) != 0),</div>
<div class="line"><a name="l08828"></a><span class="lineno"> 8828</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)((AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#ad8b92003f9218337012742c64702b604">SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT</a>) != 0),</div>
<div class="line"><a name="l08829"></a><span class="lineno"> 8829</span>&#160;                NewOwner,</div>
<div class="line"><a name="l08830"></a><span class="lineno"> 8830</span>&#160;                NewGroup,</div>
<div class="line"><a name="l08831"></a><span class="lineno"> 8831</span>&#160;                ServerOwner,</div>
<div class="line"><a name="l08832"></a><span class="lineno"> 8832</span>&#160;                ServerGroup,</div>
<div class="line"><a name="l08833"></a><span class="lineno"> 8833</span>&#160;                GenericMapping,</div>
<div class="line"><a name="l08834"></a><span class="lineno"> 8834</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,   <span class="comment">// Is a SACL</span></div>
<div class="line"><a name="l08835"></a><span class="lineno"> 8835</span>&#160;                pObjectType,</div>
<div class="line"><a name="l08836"></a><span class="lineno"> 8836</span>&#160;                GuidCount,</div>
<div class="line"><a name="l08837"></a><span class="lineno"> 8837</span>&#160;                &amp;NewSacl,</div>
<div class="line"><a name="l08838"></a><span class="lineno"> 8838</span>&#160;                &amp;SaclExplicitlyAssigned,</div>
<div class="line"><a name="l08839"></a><span class="lineno"> 8839</span>&#160;                &amp;GenericControl );</div>
<div class="line"><a name="l08840"></a><span class="lineno"> 8840</span>&#160;</div>
<div class="line"><a name="l08841"></a><span class="lineno"> 8841</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l08842"></a><span class="lineno"> 8842</span>&#160;        NewSaclInherited = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08843"></a><span class="lineno"> 8843</span>&#160;        NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a> | <a class="code" href="../../df/d4d/a02285.html#a2739a37915edd332226ecc507d08067d">SeControlGenericToSacl</a>( GenericControl );</div>
<div class="line"><a name="l08844"></a><span class="lineno"> 8844</span>&#160;</div>
<div class="line"><a name="l08845"></a><span class="lineno"> 8845</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#a1b28d9f0fc2ca4517f6c0606efb4e0f5">STATUS_NO_INHERITANCE</a> ) {</div>
<div class="line"><a name="l08846"></a><span class="lineno"> 8846</span>&#160;</div>
<div class="line"><a name="l08847"></a><span class="lineno"> 8847</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08848"></a><span class="lineno"> 8848</span>&#160;        <span class="comment">// Always set the auto inherit bit if the caller requested it.</span></div>
<div class="line"><a name="l08849"></a><span class="lineno"> 8849</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08850"></a><span class="lineno"> 8850</span>&#160;</div>
<div class="line"><a name="l08851"></a><span class="lineno"> 8851</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_SACL_AUTO_INHERIT) {</div>
<div class="line"><a name="l08852"></a><span class="lineno"> 8852</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l08853"></a><span class="lineno"> 8853</span>&#160;        }</div>
<div class="line"><a name="l08854"></a><span class="lineno"> 8854</span>&#160;</div>
<div class="line"><a name="l08855"></a><span class="lineno"> 8855</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08856"></a><span class="lineno"> 8856</span>&#160;        <span class="comment">// No inheritable ACL - check for a defaulted one.</span></div>
<div class="line"><a name="l08857"></a><span class="lineno"> 8857</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08858"></a><span class="lineno"> 8858</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CapturedDescriptor,</div>
<div class="line"><a name="l08859"></a><span class="lineno"> 8859</span>&#160;                                <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a> | <a class="code" href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e">SE_SACL_DEFAULTED</a> ) ) {</div>
<div class="line"><a name="l08860"></a><span class="lineno"> 8860</span>&#160;</div>
<div class="line"><a name="l08861"></a><span class="lineno"> 8861</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08862"></a><span class="lineno"> 8862</span>&#160;            <span class="comment">// Reference the default ACL</span></div>
<div class="line"><a name="l08863"></a><span class="lineno"> 8863</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08864"></a><span class="lineno"> 8864</span>&#160;</div>
<div class="line"><a name="l08865"></a><span class="lineno"> 8865</span>&#160;            NewSacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>(CapturedDescriptor);</div>
<div class="line"><a name="l08866"></a><span class="lineno"> 8866</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>;</div>
<div class="line"><a name="l08867"></a><span class="lineno"> 8867</span>&#160;            NewControlBits |= (CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a>);</div>
<div class="line"><a name="l08868"></a><span class="lineno"> 8868</span>&#160;</div>
<div class="line"><a name="l08869"></a><span class="lineno"> 8869</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08870"></a><span class="lineno"> 8870</span>&#160;            <span class="comment">// This counts as an explicit assignment.</span></div>
<div class="line"><a name="l08871"></a><span class="lineno"> 8871</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08872"></a><span class="lineno"> 8872</span>&#160;            SaclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08873"></a><span class="lineno"> 8873</span>&#160;        }</div>
<div class="line"><a name="l08874"></a><span class="lineno"> 8874</span>&#160;</div>
<div class="line"><a name="l08875"></a><span class="lineno"> 8875</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08876"></a><span class="lineno"> 8876</span>&#160;</div>
<div class="line"><a name="l08877"></a><span class="lineno"> 8877</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08878"></a><span class="lineno"> 8878</span>&#160;        <span class="comment">// Some unusual error occured</span></div>
<div class="line"><a name="l08879"></a><span class="lineno"> 8879</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08880"></a><span class="lineno"> 8880</span>&#160;</div>
<div class="line"><a name="l08881"></a><span class="lineno"> 8881</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08882"></a><span class="lineno"> 8882</span>&#160;    }</div>
<div class="line"><a name="l08883"></a><span class="lineno"> 8883</span>&#160;</div>
<div class="line"><a name="l08884"></a><span class="lineno"> 8884</span>&#160;</div>
<div class="line"><a name="l08885"></a><span class="lineno"> 8885</span>&#160;</div>
<div class="line"><a name="l08886"></a><span class="lineno"> 8886</span>&#160;</div>
<div class="line"><a name="l08887"></a><span class="lineno"> 8887</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08888"></a><span class="lineno"> 8888</span>&#160;    <span class="comment">// Establish Discretionary Acl</span></div>
<div class="line"><a name="l08889"></a><span class="lineno"> 8889</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08890"></a><span class="lineno"> 8890</span>&#160;</div>
<div class="line"><a name="l08891"></a><span class="lineno"> 8891</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a> (</div>
<div class="line"><a name="l08892"></a><span class="lineno"> 8892</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ParentDescriptor) ?</div>
<div class="line"><a name="l08893"></a><span class="lineno"> 8893</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(</div>
<div class="line"><a name="l08894"></a><span class="lineno"> 8894</span>&#160;                        ((<a class="code" href="../../da/de2/a01585.html">SECURITY_DESCRIPTOR</a> *)ParentDescriptor)) :</div>
<div class="line"><a name="l08895"></a><span class="lineno"> 8895</span>&#160;                    NULL,</div>
<div class="line"><a name="l08896"></a><span class="lineno"> 8896</span>&#160;                <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(CapturedDescriptor),</div>
<div class="line"><a name="l08897"></a><span class="lineno"> 8897</span>&#160;                <a class="code" href="../../df/d4d/a02285.html#a03cefa160daede67f38b6dec9f9119a1">SeControlDaclToGeneric</a>( CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> ),</div>
<div class="line"><a name="l08898"></a><span class="lineno"> 8898</span>&#160;                IsDirectoryObject,</div>
<div class="line"><a name="l08899"></a><span class="lineno"> 8899</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)((AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#a59d287bcfe603ad0d4b5a330be02d22d">SEF_DACL_AUTO_INHERIT</a>) != 0),</div>
<div class="line"><a name="l08900"></a><span class="lineno"> 8900</span>&#160;                (<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>)((AutoInheritFlags &amp; SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT) != 0),</div>
<div class="line"><a name="l08901"></a><span class="lineno"> 8901</span>&#160;                NewOwner,</div>
<div class="line"><a name="l08902"></a><span class="lineno"> 8902</span>&#160;                NewGroup,</div>
<div class="line"><a name="l08903"></a><span class="lineno"> 8903</span>&#160;                ServerOwner,</div>
<div class="line"><a name="l08904"></a><span class="lineno"> 8904</span>&#160;                ServerGroup,</div>
<div class="line"><a name="l08905"></a><span class="lineno"> 8905</span>&#160;                GenericMapping,</div>
<div class="line"><a name="l08906"></a><span class="lineno"> 8906</span>&#160;                <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,   <span class="comment">// Is a DACL</span></div>
<div class="line"><a name="l08907"></a><span class="lineno"> 8907</span>&#160;                pObjectType,</div>
<div class="line"><a name="l08908"></a><span class="lineno"> 8908</span>&#160;                GuidCount,</div>
<div class="line"><a name="l08909"></a><span class="lineno"> 8909</span>&#160;                &amp;NewDacl,</div>
<div class="line"><a name="l08910"></a><span class="lineno"> 8910</span>&#160;                &amp;DaclExplicitlyAssigned,</div>
<div class="line"><a name="l08911"></a><span class="lineno"> 8911</span>&#160;                &amp;GenericControl );</div>
<div class="line"><a name="l08912"></a><span class="lineno"> 8912</span>&#160;</div>
<div class="line"><a name="l08913"></a><span class="lineno"> 8913</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status) ) {</div>
<div class="line"><a name="l08914"></a><span class="lineno"> 8914</span>&#160;        NewDaclInherited = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08915"></a><span class="lineno"> 8915</span>&#160;        NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a> | <a class="code" href="../../df/d4d/a02285.html#aad434d64fabed59aebb1581338b289b2">SeControlGenericToDacl</a>( GenericControl );</div>
<div class="line"><a name="l08916"></a><span class="lineno"> 8916</span>&#160;</div>
<div class="line"><a name="l08917"></a><span class="lineno"> 8917</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Status == <a class="code" href="../../dc/d18/a02260.html#a1b28d9f0fc2ca4517f6c0606efb4e0f5">STATUS_NO_INHERITANCE</a> ) {</div>
<div class="line"><a name="l08918"></a><span class="lineno"> 8918</span>&#160;</div>
<div class="line"><a name="l08919"></a><span class="lineno"> 8919</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08920"></a><span class="lineno"> 8920</span>&#160;        <span class="comment">// Always set the auto inherit bit if the caller requested it.</span></div>
<div class="line"><a name="l08921"></a><span class="lineno"> 8921</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08922"></a><span class="lineno"> 8922</span>&#160;</div>
<div class="line"><a name="l08923"></a><span class="lineno"> 8923</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT) {</div>
<div class="line"><a name="l08924"></a><span class="lineno"> 8924</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l08925"></a><span class="lineno"> 8925</span>&#160;        }</div>
<div class="line"><a name="l08926"></a><span class="lineno"> 8926</span>&#160;</div>
<div class="line"><a name="l08927"></a><span class="lineno"> 8927</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08928"></a><span class="lineno"> 8928</span>&#160;        <span class="comment">// No inheritable ACL - check for a defaulted one.</span></div>
<div class="line"><a name="l08929"></a><span class="lineno"> 8929</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08930"></a><span class="lineno"> 8930</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( CapturedDescriptor,</div>
<div class="line"><a name="l08931"></a><span class="lineno"> 8931</span>&#160;                                <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a> | <a class="code" href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a> ) ) {</div>
<div class="line"><a name="l08932"></a><span class="lineno"> 8932</span>&#160;</div>
<div class="line"><a name="l08933"></a><span class="lineno"> 8933</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08934"></a><span class="lineno"> 8934</span>&#160;            <span class="comment">// Reference the default ACL</span></div>
<div class="line"><a name="l08935"></a><span class="lineno"> 8935</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08936"></a><span class="lineno"> 8936</span>&#160;</div>
<div class="line"><a name="l08937"></a><span class="lineno"> 8937</span>&#160;            NewDacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(CapturedDescriptor);</div>
<div class="line"><a name="l08938"></a><span class="lineno"> 8938</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l08939"></a><span class="lineno"> 8939</span>&#160;            NewControlBits |= (CapturedDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a>);</div>
<div class="line"><a name="l08940"></a><span class="lineno"> 8940</span>&#160;</div>
<div class="line"><a name="l08941"></a><span class="lineno"> 8941</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08942"></a><span class="lineno"> 8942</span>&#160;            <span class="comment">// This counts as an explicit assignment.</span></div>
<div class="line"><a name="l08943"></a><span class="lineno"> 8943</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l08944"></a><span class="lineno"> 8944</span>&#160;            DaclExplicitlyAssigned = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l08945"></a><span class="lineno"> 8945</span>&#160;</div>
<div class="line"><a name="l08946"></a><span class="lineno"> 8946</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08947"></a><span class="lineno"> 8947</span>&#160;        <span class="comment">// Default to the DACL on the token.</span></div>
<div class="line"><a name="l08948"></a><span class="lineno"> 8948</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08949"></a><span class="lineno"> 8949</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(SubjectContextDacl)) {</div>
<div class="line"><a name="l08950"></a><span class="lineno"> 8950</span>&#160;</div>
<div class="line"><a name="l08951"></a><span class="lineno"> 8951</span>&#160;            NewDacl = SubjectContextDacl;</div>
<div class="line"><a name="l08952"></a><span class="lineno"> 8952</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l08953"></a><span class="lineno"> 8953</span>&#160;</div>
<div class="line"><a name="l08954"></a><span class="lineno"> 8954</span>&#160;        }</div>
<div class="line"><a name="l08955"></a><span class="lineno"> 8955</span>&#160;</div>
<div class="line"><a name="l08956"></a><span class="lineno"> 8956</span>&#160;</div>
<div class="line"><a name="l08957"></a><span class="lineno"> 8957</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l08958"></a><span class="lineno"> 8958</span>&#160;</div>
<div class="line"><a name="l08959"></a><span class="lineno"> 8959</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08960"></a><span class="lineno"> 8960</span>&#160;        <span class="comment">// Some unusual error occured</span></div>
<div class="line"><a name="l08961"></a><span class="lineno"> 8961</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l08962"></a><span class="lineno"> 8962</span>&#160;</div>
<div class="line"><a name="l08963"></a><span class="lineno"> 8963</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l08964"></a><span class="lineno"> 8964</span>&#160;    }</div>
<div class="line"><a name="l08965"></a><span class="lineno"> 8965</span>&#160;</div>
<div class="line"><a name="l08966"></a><span class="lineno"> 8966</span>&#160;<span class="preprocessor">#ifdef  ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l08967"></a><span class="lineno"> 8967</span>&#160;</div>
<div class="line"><a name="l08968"></a><span class="lineno"> 8968</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08969"></a><span class="lineno"> 8969</span>&#160;    <span class="comment">// Culprit will probably be the caller NtCreate*, or</span></div>
<div class="line"><a name="l08970"></a><span class="lineno"> 8970</span>&#160;    <span class="comment">// RtlNewSecurityObject.  Note that although this will not always occur</span></div>
<div class="line"><a name="l08971"></a><span class="lineno"> 8971</span>&#160;    <span class="comment">// because of explicit user action it still must be corrected.</span></div>
<div class="line"><a name="l08972"></a><span class="lineno"> 8972</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08973"></a><span class="lineno"> 8973</span>&#160;    </div>
<div class="line"><a name="l08974"></a><span class="lineno"> 8974</span>&#160;    <span class="keywordflow">if</span> (RtlpAssertOnNullDacls) {</div>
<div class="line"><a name="l08975"></a><span class="lineno"> 8975</span>&#160;</div>
<div class="line"><a name="l08976"></a><span class="lineno"> 8976</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>((<span class="stringliteral">&quot;NULL DACLs are NOT allowed!&quot;</span>, NewDacl != NULL));</div>
<div class="line"><a name="l08977"></a><span class="lineno"> 8977</span>&#160;    }</div>
<div class="line"><a name="l08978"></a><span class="lineno"> 8978</span>&#160;</div>
<div class="line"><a name="l08979"></a><span class="lineno"> 8979</span>&#160;<span class="preprocessor">#endif // ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l08980"></a><span class="lineno"> 8980</span>&#160;</div>
<div class="line"><a name="l08981"></a><span class="lineno"> 8981</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08982"></a><span class="lineno"> 8982</span>&#160;    <span class="comment">// If auto inheriting and the computed child DACL is NULL,</span></div>
<div class="line"><a name="l08983"></a><span class="lineno"> 8983</span>&#160;    <span class="comment">//  mark it as protected.</span></div>
<div class="line"><a name="l08984"></a><span class="lineno"> 8984</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08985"></a><span class="lineno"> 8985</span>&#160;    <span class="comment">// NULL DACLs are problematic when ACEs are actually inherited from the</span></div>
<div class="line"><a name="l08986"></a><span class="lineno"> 8986</span>&#160;    <span class="comment">// parent DACL.  It is better to mark them as protected NOW (even if we don&#39;t</span></div>
<div class="line"><a name="l08987"></a><span class="lineno"> 8987</span>&#160;    <span class="comment">// end up inheriting any ACEs) to avoid confusion later.</span></div>
<div class="line"><a name="l08988"></a><span class="lineno"> 8988</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08989"></a><span class="lineno"> 8989</span>&#160;</div>
<div class="line"><a name="l08990"></a><span class="lineno"> 8990</span>&#160;    <span class="keywordflow">if</span> ( (AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT) != 0 &amp;&amp;</div>
<div class="line"><a name="l08991"></a><span class="lineno"> 8991</span>&#160;         NewDacl == NULL ) {</div>
<div class="line"><a name="l08992"></a><span class="lineno"> 8992</span>&#160;        NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a>;</div>
<div class="line"><a name="l08993"></a><span class="lineno"> 8993</span>&#160;    }</div>
<div class="line"><a name="l08994"></a><span class="lineno"> 8994</span>&#160;</div>
<div class="line"><a name="l08995"></a><span class="lineno"> 8995</span>&#160;</div>
<div class="line"><a name="l08996"></a><span class="lineno"> 8996</span>&#160;</div>
<div class="line"><a name="l08997"></a><span class="lineno"> 8997</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l08998"></a><span class="lineno"> 8998</span>&#160;    <span class="comment">// Now make sure that the caller has the right to assign</span></div>
<div class="line"><a name="l08999"></a><span class="lineno"> 8999</span>&#160;    <span class="comment">// everything in the descriptor.  The requestor is subjected</span></div>
<div class="line"><a name="l09000"></a><span class="lineno"> 9000</span>&#160;    <span class="comment">// to privilege and restriction tests for some assignments.</span></div>
<div class="line"><a name="l09001"></a><span class="lineno"> 9001</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09002"></a><span class="lineno"> 9002</span>&#160;    <span class="keywordflow">if</span> (RequestorMode == <a class="code" href="../../dd/dc3/a02249.html#a9b26934030fc4241b92fe90168d238efadcfc57d389e8e2bb30dc32135b6a92d0">UserMode</a>) {</div>
<div class="line"><a name="l09003"></a><span class="lineno"> 9003</span>&#160;</div>
<div class="line"><a name="l09004"></a><span class="lineno"> 9004</span>&#160;</div>
<div class="line"><a name="l09005"></a><span class="lineno"> 9005</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09006"></a><span class="lineno"> 9006</span>&#160;        <span class="comment">// Anybody can assign any Discretionary ACL or group that they want to.</span></div>
<div class="line"><a name="l09007"></a><span class="lineno"> 9007</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09008"></a><span class="lineno"> 9008</span>&#160;</div>
<div class="line"><a name="l09009"></a><span class="lineno"> 9009</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09010"></a><span class="lineno"> 9010</span>&#160;        <span class="comment">//  See if the system ACL was explicitly specified</span></div>
<div class="line"><a name="l09011"></a><span class="lineno"> 9011</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09012"></a><span class="lineno"> 9012</span>&#160;</div>
<div class="line"><a name="l09013"></a><span class="lineno"> 9013</span>&#160;        <span class="keywordflow">if</span> ( SaclExplicitlyAssigned &amp;&amp;</div>
<div class="line"><a name="l09014"></a><span class="lineno"> 9014</span>&#160;             (AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#af9c9d7545f456effa5019a3f41ee424f">SEF_AVOID_PRIVILEGE_CHECK</a>) == 0 ) {</div>
<div class="line"><a name="l09015"></a><span class="lineno"> 9015</span>&#160;</div>
<div class="line"><a name="l09016"></a><span class="lineno"> 9016</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09017"></a><span class="lineno"> 9017</span>&#160;            <span class="comment">// Require a Token if we&#39;re to do the privilege check.</span></div>
<div class="line"><a name="l09018"></a><span class="lineno"> 9018</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09019"></a><span class="lineno"> 9019</span>&#160;</div>
<div class="line"><a name="l09020"></a><span class="lineno"> 9020</span>&#160;            <span class="keywordflow">if</span> ( Token == NULL ) {</div>
<div class="line"><a name="l09021"></a><span class="lineno"> 9021</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#a061ab569ad0e495f99eb4dd005951170">STATUS_NO_TOKEN</a>;</div>
<div class="line"><a name="l09022"></a><span class="lineno"> 9022</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09023"></a><span class="lineno"> 9023</span>&#160;            }</div>
<div class="line"><a name="l09024"></a><span class="lineno"> 9024</span>&#160;</div>
<div class="line"><a name="l09025"></a><span class="lineno"> 9025</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09026"></a><span class="lineno"> 9026</span>&#160;            <span class="comment">// Check for appropriate Privileges</span></div>
<div class="line"><a name="l09027"></a><span class="lineno"> 9027</span>&#160;            <span class="comment">// Audit/Alarm messages need to be generated due to the attempt</span></div>
<div class="line"><a name="l09028"></a><span class="lineno"> 9028</span>&#160;            <span class="comment">// to perform a privileged operation.</span></div>
<div class="line"><a name="l09029"></a><span class="lineno"> 9029</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09030"></a><span class="lineno"> 9030</span>&#160;</div>
<div class="line"><a name="l09031"></a><span class="lineno"> 9031</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09032"></a><span class="lineno"> 9032</span>&#160;            <span class="comment">// Note: be sure to do the privilege check against</span></div>
<div class="line"><a name="l09033"></a><span class="lineno"> 9033</span>&#160;            <span class="comment">// the passed subject context!</span></div>
<div class="line"><a name="l09034"></a><span class="lineno"> 9034</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09035"></a><span class="lineno"> 9035</span>&#160;</div>
<div class="line"><a name="l09036"></a><span class="lineno"> 9036</span>&#160;            PrivilegeSet.<a class="code" href="../../dc/d25/a01406.html#acf053936624411d4a0b7370693299e9e">PrivilegeCount</a> = 1;</div>
<div class="line"><a name="l09037"></a><span class="lineno"> 9037</span>&#160;            PrivilegeSet.<a class="code" href="../../dc/d25/a01406.html#a3df45b81acf2a35fe9ed114238adc49b">Control</a> = <a class="code" href="../../d3/d3a/a02259.html#acaa5961b4e4d9bfcc202f122d8eb222a">PRIVILEGE_SET_ALL_NECESSARY</a>;</div>
<div class="line"><a name="l09038"></a><span class="lineno"> 9038</span>&#160;            PrivilegeSet.<a class="code" href="../../dc/d25/a01406.html#a19ff8e350afcb8b62f12c47c57e6bb0e">Privilege</a>[0].<a class="code" href="../../d7/d46/a00890.html#a87ba6ddd98dbc6cb4af380e69d31233a">Luid</a> = <a class="code" href="../../d3/d81/a02284.html#a21cb2fd86cd221d0f0cca48ae0cfd349">SeSecurityPrivilege</a>;</div>
<div class="line"><a name="l09039"></a><span class="lineno"> 9039</span>&#160;            PrivilegeSet.<a class="code" href="../../dc/d25/a01406.html#a19ff8e350afcb8b62f12c47c57e6bb0e">Privilege</a>[0].<a class="code" href="../../d7/d46/a00890.html#aaa4581db6230461bf219f4e3bc6810c0">Attributes</a> = 0;</div>
<div class="line"><a name="l09040"></a><span class="lineno"> 9040</span>&#160;</div>
<div class="line"><a name="l09041"></a><span class="lineno"> 9041</span>&#160;            HasPrivilege = <a class="code" href="../../d3/d81/a02284.html#a22b50e7c3b91068e25bfe17b41bf0fea">SePrivilegeCheck</a>(</div>
<div class="line"><a name="l09042"></a><span class="lineno"> 9042</span>&#160;                               &amp;PrivilegeSet,</div>
<div class="line"><a name="l09043"></a><span class="lineno"> 9043</span>&#160;                               SubjectSecurityContext,</div>
<div class="line"><a name="l09044"></a><span class="lineno"> 9044</span>&#160;                               RequestorMode</div>
<div class="line"><a name="l09045"></a><span class="lineno"> 9045</span>&#160;                               );</div>
<div class="line"><a name="l09046"></a><span class="lineno"> 9046</span>&#160;</div>
<div class="line"><a name="l09047"></a><span class="lineno"> 9047</span>&#160;            <span class="keywordflow">if</span> ( RequestorMode != <a class="code" href="../../dd/dc3/a02249.html#a9b26934030fc4241b92fe90168d238efab76e1d872ad43cb76d21124abdd4312a">KernelMode</a> ) {</div>
<div class="line"><a name="l09048"></a><span class="lineno"> 9048</span>&#160;</div>
<div class="line"><a name="l09049"></a><span class="lineno"> 9049</span>&#160;                <a class="code" href="../../d3/d81/a02284.html#a1e26855b314a730c9adf39f1c9681a28">SePrivilegedServiceAuditAlarm</a> (</div>
<div class="line"><a name="l09050"></a><span class="lineno"> 9050</span>&#160;                    NULL,</div>
<div class="line"><a name="l09051"></a><span class="lineno"> 9051</span>&#160;                    SubjectSecurityContext,</div>
<div class="line"><a name="l09052"></a><span class="lineno"> 9052</span>&#160;                    &amp;PrivilegeSet,</div>
<div class="line"><a name="l09053"></a><span class="lineno"> 9053</span>&#160;                    HasPrivilege</div>
<div class="line"><a name="l09054"></a><span class="lineno"> 9054</span>&#160;                    );</div>
<div class="line"><a name="l09055"></a><span class="lineno"> 9055</span>&#160;            }</div>
<div class="line"><a name="l09056"></a><span class="lineno"> 9056</span>&#160;</div>
<div class="line"><a name="l09057"></a><span class="lineno"> 9057</span>&#160;            <span class="keywordflow">if</span> ( !HasPrivilege ) {</div>
<div class="line"><a name="l09058"></a><span class="lineno"> 9058</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#a62f33d4e46ad5b4ca3e889ded4c0f7a1">STATUS_PRIVILEGE_NOT_HELD</a>;</div>
<div class="line"><a name="l09059"></a><span class="lineno"> 9059</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09060"></a><span class="lineno"> 9060</span>&#160;            }</div>
<div class="line"><a name="l09061"></a><span class="lineno"> 9061</span>&#160;</div>
<div class="line"><a name="l09062"></a><span class="lineno"> 9062</span>&#160;        }</div>
<div class="line"><a name="l09063"></a><span class="lineno"> 9063</span>&#160;</div>
<div class="line"><a name="l09064"></a><span class="lineno"> 9064</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09065"></a><span class="lineno"> 9065</span>&#160;        <span class="comment">// See if the owner field is one the requestor can assign</span></div>
<div class="line"><a name="l09066"></a><span class="lineno"> 9066</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09067"></a><span class="lineno"> 9067</span>&#160;</div>
<div class="line"><a name="l09068"></a><span class="lineno"> 9068</span>&#160;        <span class="keywordflow">if</span> (OwnerExplicitlyAssigned &amp;&amp;</div>
<div class="line"><a name="l09069"></a><span class="lineno"> 9069</span>&#160;            (AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#a8059550dde3ea391b347d9133c2725db">SEF_AVOID_OWNER_CHECK</a>) == 0 ) {</div>
<div class="line"><a name="l09070"></a><span class="lineno"> 9070</span>&#160;</div>
<div class="line"><a name="l09071"></a><span class="lineno"> 9071</span>&#160;</div>
<div class="line"><a name="l09072"></a><span class="lineno"> 9072</span>&#160;</div>
<div class="line"><a name="l09073"></a><span class="lineno"> 9073</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../dd/dee/a02700.html#a4c90199d4212712e0e4f06f9e7f580ac">SepValidOwnerSubjectContext</a>(</div>
<div class="line"><a name="l09074"></a><span class="lineno"> 9074</span>&#160;                    SubjectSecurityContext,</div>
<div class="line"><a name="l09075"></a><span class="lineno"> 9075</span>&#160;                    NewOwner,</div>
<div class="line"><a name="l09076"></a><span class="lineno"> 9076</span>&#160;                    ServerObject)</div>
<div class="line"><a name="l09077"></a><span class="lineno"> 9077</span>&#160;                    ) {</div>
<div class="line"><a name="l09078"></a><span class="lineno"> 9078</span>&#160;</div>
<div class="line"><a name="l09079"></a><span class="lineno"> 9079</span>&#160;                Status = <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a>;</div>
<div class="line"><a name="l09080"></a><span class="lineno"> 9080</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09081"></a><span class="lineno"> 9081</span>&#160;            }</div>
<div class="line"><a name="l09082"></a><span class="lineno"> 9082</span>&#160;        }</div>
<div class="line"><a name="l09083"></a><span class="lineno"> 9083</span>&#160;</div>
<div class="line"><a name="l09084"></a><span class="lineno"> 9084</span>&#160;</div>
<div class="line"><a name="l09085"></a><span class="lineno"> 9085</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09086"></a><span class="lineno"> 9086</span>&#160;        <span class="comment">// If the DACL was explictly assigned and this is a server object,</span></div>
<div class="line"><a name="l09087"></a><span class="lineno"> 9087</span>&#160;        <span class="comment">//  convert the DACL to be a server DACL</span></div>
<div class="line"><a name="l09088"></a><span class="lineno"> 9088</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09089"></a><span class="lineno"> 9089</span>&#160;</div>
<div class="line"><a name="l09090"></a><span class="lineno"> 9090</span>&#160;        <span class="keywordflow">if</span> (DaclExplicitlyAssigned &amp;&amp; ServerObject) {</div>
<div class="line"><a name="l09091"></a><span class="lineno"> 9091</span>&#160;</div>
<div class="line"><a name="l09092"></a><span class="lineno"> 9092</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0">RtlpCreateServerAcl</a>(</div>
<div class="line"><a name="l09093"></a><span class="lineno"> 9093</span>&#160;                         NewDacl,</div>
<div class="line"><a name="l09094"></a><span class="lineno"> 9094</span>&#160;                         DaclUntrusted,</div>
<div class="line"><a name="l09095"></a><span class="lineno"> 9095</span>&#160;                         ServerOwner,</div>
<div class="line"><a name="l09096"></a><span class="lineno"> 9096</span>&#160;                         &amp;ServerDacl,</div>
<div class="line"><a name="l09097"></a><span class="lineno"> 9097</span>&#160;                         &amp;ServerDaclAllocated</div>
<div class="line"><a name="l09098"></a><span class="lineno"> 9098</span>&#160;                         );</div>
<div class="line"><a name="l09099"></a><span class="lineno"> 9099</span>&#160;</div>
<div class="line"><a name="l09100"></a><span class="lineno"> 9100</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l09101"></a><span class="lineno"> 9101</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09102"></a><span class="lineno"> 9102</span>&#160;            }</div>
<div class="line"><a name="l09103"></a><span class="lineno"> 9103</span>&#160;            </div>
<div class="line"><a name="l09104"></a><span class="lineno"> 9104</span>&#160;            <span class="keywordflow">if</span> (NewDaclInherited &amp;&amp; NewDacl) {</div>
<div class="line"><a name="l09105"></a><span class="lineno"> 9105</span>&#160;                <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewDacl );</div>
<div class="line"><a name="l09106"></a><span class="lineno"> 9106</span>&#160;            }</div>
<div class="line"><a name="l09107"></a><span class="lineno"> 9107</span>&#160;</div>
<div class="line"><a name="l09108"></a><span class="lineno"> 9108</span>&#160;            NewDacl = ServerDacl;</div>
<div class="line"><a name="l09109"></a><span class="lineno"> 9109</span>&#160;            ServerDacl = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l09110"></a><span class="lineno"> 9110</span>&#160;        }</div>
<div class="line"><a name="l09111"></a><span class="lineno"> 9111</span>&#160;    }</div>
<div class="line"><a name="l09112"></a><span class="lineno"> 9112</span>&#160;</div>
<div class="line"><a name="l09113"></a><span class="lineno"> 9113</span>&#160;</div>
<div class="line"><a name="l09114"></a><span class="lineno"> 9114</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09115"></a><span class="lineno"> 9115</span>&#160;    <span class="comment">// Everything is assignable by the requestor.</span></div>
<div class="line"><a name="l09116"></a><span class="lineno"> 9116</span>&#160;    <span class="comment">// Calculate the memory needed to house all the information in</span></div>
<div class="line"><a name="l09117"></a><span class="lineno"> 9117</span>&#160;    <span class="comment">// a self-relative security descriptor.</span></div>
<div class="line"><a name="l09118"></a><span class="lineno"> 9118</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09119"></a><span class="lineno"> 9119</span>&#160;    <span class="comment">// Also map the ACEs for application to the target object</span></div>
<div class="line"><a name="l09120"></a><span class="lineno"> 9120</span>&#160;    <span class="comment">// type, if they haven&#39;t already been mapped.</span></div>
<div class="line"><a name="l09121"></a><span class="lineno"> 9121</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09122"></a><span class="lineno"> 9122</span>&#160;    OwnerSize = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewOwner);</div>
<div class="line"><a name="l09123"></a><span class="lineno"> 9123</span>&#160;    NewOwnerSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(OwnerSize);</div>
<div class="line"><a name="l09124"></a><span class="lineno"> 9124</span>&#160;    <span class="keywordflow">if</span> (NewGroup != NULL) {</div>
<div class="line"><a name="l09125"></a><span class="lineno"> 9125</span>&#160;        GroupSize = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewGroup);</div>
<div class="line"><a name="l09126"></a><span class="lineno"> 9126</span>&#160;        NewGroupSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(GroupSize);</div>
<div class="line"><a name="l09127"></a><span class="lineno"> 9127</span>&#160;    }</div>
<div class="line"><a name="l09128"></a><span class="lineno"> 9128</span>&#160;</div>
<div class="line"><a name="l09129"></a><span class="lineno"> 9129</span>&#160;    <span class="keywordflow">if</span> ((NewControlBits &amp; <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>) &amp;&amp; (NewSacl != NULL)) {</div>
<div class="line"><a name="l09130"></a><span class="lineno"> 9130</span>&#160;        NewSaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09131"></a><span class="lineno"> 9131</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09132"></a><span class="lineno"> 9132</span>&#160;        NewSaclSize = 0;</div>
<div class="line"><a name="l09133"></a><span class="lineno"> 9133</span>&#160;    }</div>
<div class="line"><a name="l09134"></a><span class="lineno"> 9134</span>&#160;</div>
<div class="line"><a name="l09135"></a><span class="lineno"> 9135</span>&#160;    <span class="keywordflow">if</span> ( (NewControlBits &amp; <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>) &amp;&amp; (NewDacl != NULL)) {</div>
<div class="line"><a name="l09136"></a><span class="lineno"> 9136</span>&#160;        NewDaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09137"></a><span class="lineno"> 9137</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09138"></a><span class="lineno"> 9138</span>&#160;        NewDaclSize = 0;</div>
<div class="line"><a name="l09139"></a><span class="lineno"> 9139</span>&#160;    }</div>
<div class="line"><a name="l09140"></a><span class="lineno"> 9140</span>&#160;</div>
<div class="line"><a name="l09141"></a><span class="lineno"> 9141</span>&#160;    AllocationSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>)) +</div>
<div class="line"><a name="l09142"></a><span class="lineno"> 9142</span>&#160;                     NewOwnerSize +</div>
<div class="line"><a name="l09143"></a><span class="lineno"> 9143</span>&#160;                     NewGroupSize +</div>
<div class="line"><a name="l09144"></a><span class="lineno"> 9144</span>&#160;                     NewSaclSize  +</div>
<div class="line"><a name="l09145"></a><span class="lineno"> 9145</span>&#160;                     NewDaclSize;</div>
<div class="line"><a name="l09146"></a><span class="lineno"> 9146</span>&#160;</div>
<div class="line"><a name="l09147"></a><span class="lineno"> 9147</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09148"></a><span class="lineno"> 9148</span>&#160;    <span class="comment">// Allocate and initialize the security descriptor as</span></div>
<div class="line"><a name="l09149"></a><span class="lineno"> 9149</span>&#160;    <span class="comment">// self-relative form.</span></div>
<div class="line"><a name="l09150"></a><span class="lineno"> 9150</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09151"></a><span class="lineno"> 9151</span>&#160;</div>
<div class="line"><a name="l09152"></a><span class="lineno"> 9152</span>&#160;    INewDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a>)<a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a>, AllocationSize, <span class="stringliteral">&#39;dSeS&#39;</span>);</div>
<div class="line"><a name="l09153"></a><span class="lineno"> 9153</span>&#160;</div>
<div class="line"><a name="l09154"></a><span class="lineno"> 9154</span>&#160;    <span class="keywordflow">if</span> ( INewDescriptor == NULL ) {</div>
<div class="line"><a name="l09155"></a><span class="lineno"> 9155</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#aeb86c04f9593b4cdb1b56c71e76d2e36">STATUS_INSUFFICIENT_RESOURCES</a>;</div>
<div class="line"><a name="l09156"></a><span class="lineno"> 9156</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09157"></a><span class="lineno"> 9157</span>&#160;    }</div>
<div class="line"><a name="l09158"></a><span class="lineno"> 9158</span>&#160;</div>
<div class="line"><a name="l09159"></a><span class="lineno"> 9159</span>&#160;    <a class="code" href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2">RtlCreateSecurityDescriptorRelative</a>(</div>
<div class="line"><a name="l09160"></a><span class="lineno"> 9160</span>&#160;        INewDescriptor,</div>
<div class="line"><a name="l09161"></a><span class="lineno"> 9161</span>&#160;        <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a></div>
<div class="line"><a name="l09162"></a><span class="lineno"> 9162</span>&#160;        );</div>
<div class="line"><a name="l09163"></a><span class="lineno"> 9163</span>&#160;</div>
<div class="line"><a name="l09164"></a><span class="lineno"> 9164</span>&#160;    <a class="code" href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a>( INewDescriptor, NewControlBits );</div>
<div class="line"><a name="l09165"></a><span class="lineno"> 9165</span>&#160;</div>
<div class="line"><a name="l09166"></a><span class="lineno"> 9166</span>&#160;    Base = (<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)(INewDescriptor);</div>
<div class="line"><a name="l09167"></a><span class="lineno"> 9167</span>&#160;    Field =  Base + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aecc9f2cb4b77c249451b1db76791af53">SECURITY_DESCRIPTOR_RELATIVE</a>);</div>
<div class="line"><a name="l09168"></a><span class="lineno"> 9168</span>&#160;</div>
<div class="line"><a name="l09169"></a><span class="lineno"> 9169</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09170"></a><span class="lineno"> 9170</span>&#160;    <span class="comment">// Map and Copy in the Sacl</span></div>
<div class="line"><a name="l09171"></a><span class="lineno"> 9171</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09172"></a><span class="lineno"> 9172</span>&#160;</div>
<div class="line"><a name="l09173"></a><span class="lineno"> 9173</span>&#160;    <span class="keywordflow">if</span> (NewControlBits &amp; SE_SACL_PRESENT) {</div>
<div class="line"><a name="l09174"></a><span class="lineno"> 9174</span>&#160;</div>
<div class="line"><a name="l09175"></a><span class="lineno"> 9175</span>&#160;        <span class="keywordflow">if</span> (NewSacl != NULL) {</div>
<div class="line"><a name="l09176"></a><span class="lineno"> 9176</span>&#160;</div>
<div class="line"><a name="l09177"></a><span class="lineno"> 9177</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewSacl, NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l09178"></a><span class="lineno"> 9178</span>&#160;</div>
<div class="line"><a name="l09179"></a><span class="lineno"> 9179</span>&#160;            <span class="keywordflow">if</span> (!NewSaclInherited) {</div>
<div class="line"><a name="l09180"></a><span class="lineno"> 9180</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)Field, GenericMapping );</div>
<div class="line"><a name="l09181"></a><span class="lineno"> 9181</span>&#160;            }</div>
<div class="line"><a name="l09182"></a><span class="lineno"> 9182</span>&#160;</div>
<div class="line"><a name="l09183"></a><span class="lineno"> 9183</span>&#160;            INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09184"></a><span class="lineno"> 9184</span>&#160;            <span class="keywordflow">if</span> (NewSaclSize &gt; NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>) {</div>
<div class="line"><a name="l09185"></a><span class="lineno"> 9185</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a> (Field + NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>, NewSaclSize - NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09186"></a><span class="lineno"> 9186</span>&#160;            }</div>
<div class="line"><a name="l09187"></a><span class="lineno"> 9187</span>&#160;            Field += NewSaclSize;</div>
<div class="line"><a name="l09188"></a><span class="lineno"> 9188</span>&#160;</div>
<div class="line"><a name="l09189"></a><span class="lineno"> 9189</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09190"></a><span class="lineno"> 9190</span>&#160;</div>
<div class="line"><a name="l09191"></a><span class="lineno"> 9191</span>&#160;            INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = 0;</div>
<div class="line"><a name="l09192"></a><span class="lineno"> 9192</span>&#160;        }</div>
<div class="line"><a name="l09193"></a><span class="lineno"> 9193</span>&#160;</div>
<div class="line"><a name="l09194"></a><span class="lineno"> 9194</span>&#160;    }</div>
<div class="line"><a name="l09195"></a><span class="lineno"> 9195</span>&#160;</div>
<div class="line"><a name="l09196"></a><span class="lineno"> 9196</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09197"></a><span class="lineno"> 9197</span>&#160;    <span class="comment">// Map and Copy in the Dacl</span></div>
<div class="line"><a name="l09198"></a><span class="lineno"> 9198</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09199"></a><span class="lineno"> 9199</span>&#160;</div>
<div class="line"><a name="l09200"></a><span class="lineno"> 9200</span>&#160;    <span class="keywordflow">if</span> (NewControlBits &amp; SE_DACL_PRESENT) {</div>
<div class="line"><a name="l09201"></a><span class="lineno"> 9201</span>&#160;</div>
<div class="line"><a name="l09202"></a><span class="lineno"> 9202</span>&#160;        <span class="keywordflow">if</span> (NewDacl != NULL) {</div>
<div class="line"><a name="l09203"></a><span class="lineno"> 9203</span>&#160;</div>
<div class="line"><a name="l09204"></a><span class="lineno"> 9204</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewDacl, NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l09205"></a><span class="lineno"> 9205</span>&#160;</div>
<div class="line"><a name="l09206"></a><span class="lineno"> 9206</span>&#160;            <span class="keywordflow">if</span> (!NewDaclInherited) {</div>
<div class="line"><a name="l09207"></a><span class="lineno"> 9207</span>&#160;                <a class="code" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)Field, GenericMapping );</div>
<div class="line"><a name="l09208"></a><span class="lineno"> 9208</span>&#160;            }</div>
<div class="line"><a name="l09209"></a><span class="lineno"> 9209</span>&#160;</div>
<div class="line"><a name="l09210"></a><span class="lineno"> 9210</span>&#160;            INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09211"></a><span class="lineno"> 9211</span>&#160;            <span class="keywordflow">if</span> (NewDaclSize &gt; NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>) {</div>
<div class="line"><a name="l09212"></a><span class="lineno"> 9212</span>&#160;                <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a> (Field + NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>, NewDaclSize - NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09213"></a><span class="lineno"> 9213</span>&#160;            }</div>
<div class="line"><a name="l09214"></a><span class="lineno"> 9214</span>&#160;            Field += NewDaclSize;</div>
<div class="line"><a name="l09215"></a><span class="lineno"> 9215</span>&#160;</div>
<div class="line"><a name="l09216"></a><span class="lineno"> 9216</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09217"></a><span class="lineno"> 9217</span>&#160;</div>
<div class="line"><a name="l09218"></a><span class="lineno"> 9218</span>&#160;            INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = 0;</div>
<div class="line"><a name="l09219"></a><span class="lineno"> 9219</span>&#160;        }</div>
<div class="line"><a name="l09220"></a><span class="lineno"> 9220</span>&#160;</div>
<div class="line"><a name="l09221"></a><span class="lineno"> 9221</span>&#160;    }</div>
<div class="line"><a name="l09222"></a><span class="lineno"> 9222</span>&#160;</div>
<div class="line"><a name="l09223"></a><span class="lineno"> 9223</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09224"></a><span class="lineno"> 9224</span>&#160;    <span class="comment">// Assign the owner</span></div>
<div class="line"><a name="l09225"></a><span class="lineno"> 9225</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09226"></a><span class="lineno"> 9226</span>&#160;</div>
<div class="line"><a name="l09227"></a><span class="lineno"> 9227</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewOwner, OwnerSize );</div>
<div class="line"><a name="l09228"></a><span class="lineno"> 9228</span>&#160;    <span class="keywordflow">if</span> (NewOwnerSize &gt; OwnerSize) {</div>
<div class="line"><a name="l09229"></a><span class="lineno"> 9229</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a> (Field + OwnerSize, NewOwnerSize - OwnerSize);</div>
<div class="line"><a name="l09230"></a><span class="lineno"> 9230</span>&#160;    }</div>
<div class="line"><a name="l09231"></a><span class="lineno"> 9231</span>&#160;    INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09232"></a><span class="lineno"> 9232</span>&#160;    Field += NewOwnerSize;</div>
<div class="line"><a name="l09233"></a><span class="lineno"> 9233</span>&#160;</div>
<div class="line"><a name="l09234"></a><span class="lineno"> 9234</span>&#160;    <span class="keywordflow">if</span> (NewGroup != NULL) {</div>
<div class="line"><a name="l09235"></a><span class="lineno"> 9235</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewGroup, GroupSize );</div>
<div class="line"><a name="l09236"></a><span class="lineno"> 9236</span>&#160;        <span class="keywordflow">if</span> (NewGroupSize &gt; GroupSize) {</div>
<div class="line"><a name="l09237"></a><span class="lineno"> 9237</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a> (Field + GroupSize, NewGroupSize - GroupSize);</div>
<div class="line"><a name="l09238"></a><span class="lineno"> 9238</span>&#160;        }</div>
<div class="line"><a name="l09239"></a><span class="lineno"> 9239</span>&#160;        INewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09240"></a><span class="lineno"> 9240</span>&#160;    }</div>
<div class="line"><a name="l09241"></a><span class="lineno"> 9241</span>&#160;</div>
<div class="line"><a name="l09242"></a><span class="lineno"> 9242</span>&#160;    Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l09243"></a><span class="lineno"> 9243</span>&#160;</div>
<div class="line"><a name="l09244"></a><span class="lineno"> 9244</span>&#160;</div>
<div class="line"><a name="l09245"></a><span class="lineno"> 9245</span>&#160;</div>
<div class="line"><a name="l09246"></a><span class="lineno"> 9246</span>&#160;Cleanup:</div>
<div class="line"><a name="l09247"></a><span class="lineno"> 9247</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09248"></a><span class="lineno"> 9248</span>&#160;    <span class="comment">// If we allocated memory for a Server DACL, free it now.</span></div>
<div class="line"><a name="l09249"></a><span class="lineno"> 9249</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09250"></a><span class="lineno"> 9250</span>&#160;</div>
<div class="line"><a name="l09251"></a><span class="lineno"> 9251</span>&#160;    <span class="keywordflow">if</span> (ServerDaclAllocated &amp;&amp; ServerDacl != NULL) {</div>
<div class="line"><a name="l09252"></a><span class="lineno"> 9252</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( ServerDacl );</div>
<div class="line"><a name="l09253"></a><span class="lineno"> 9253</span>&#160;    }</div>
<div class="line"><a name="l09254"></a><span class="lineno"> 9254</span>&#160;</div>
<div class="line"><a name="l09255"></a><span class="lineno"> 9255</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09256"></a><span class="lineno"> 9256</span>&#160;    <span class="comment">// Either an error was encountered or the assignment has completed</span></div>
<div class="line"><a name="l09257"></a><span class="lineno"> 9257</span>&#160;    <span class="comment">// successfully.  In either case, we have to clean up any memory.</span></div>
<div class="line"><a name="l09258"></a><span class="lineno"> 9258</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09259"></a><span class="lineno"> 9259</span>&#160;</div>
<div class="line"><a name="l09260"></a><span class="lineno"> 9260</span>&#160;    <span class="keywordflow">if</span> (SubjectContextInfo != NULL) {</div>
<div class="line"><a name="l09261"></a><span class="lineno"> 9261</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( SubjectContextInfo );</div>
<div class="line"><a name="l09262"></a><span class="lineno"> 9262</span>&#160;    }</div>
<div class="line"><a name="l09263"></a><span class="lineno"> 9263</span>&#160;</div>
<div class="line"><a name="l09264"></a><span class="lineno"> 9264</span>&#160;    <span class="keywordflow">if</span> (NewSaclInherited &amp;&amp; NewSacl != NULL ) {</div>
<div class="line"><a name="l09265"></a><span class="lineno"> 9265</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewSacl );</div>
<div class="line"><a name="l09266"></a><span class="lineno"> 9266</span>&#160;    }</div>
<div class="line"><a name="l09267"></a><span class="lineno"> 9267</span>&#160;</div>
<div class="line"><a name="l09268"></a><span class="lineno"> 9268</span>&#160;    <span class="keywordflow">if</span> (NewDaclInherited &amp;&amp; NewDacl != NULL ) {</div>
<div class="line"><a name="l09269"></a><span class="lineno"> 9269</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewDacl );</div>
<div class="line"><a name="l09270"></a><span class="lineno"> 9270</span>&#160;    }</div>
<div class="line"><a name="l09271"></a><span class="lineno"> 9271</span>&#160;</div>
<div class="line"><a name="l09272"></a><span class="lineno"> 9272</span>&#160;    *NewDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a>) INewDescriptor;</div>
<div class="line"><a name="l09273"></a><span class="lineno"> 9273</span>&#160;</div>
<div class="line"><a name="l09274"></a><span class="lineno"> 9274</span>&#160;</div>
<div class="line"><a name="l09275"></a><span class="lineno"> 9275</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l09276"></a><span class="lineno"> 9276</span>&#160;}</div>
<div class="line"><a name="l09277"></a><span class="lineno"> 9277</span>&#160;</div>
<div class="line"><a name="l09278"></a><span class="lineno"> 9278</span>&#160;</div>
<div class="line"><a name="l09279"></a><span class="lineno"> 9279</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l09280"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ad2ade6a49301fb4ec6e67d9ed18d2012"> 9280</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ad2ade6a49301fb4ec6e67d9ed18d2012">RtlpSetSecurityObject</a> (</div>
<div class="line"><a name="l09281"></a><span class="lineno"> 9281</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a> Object <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a>,</div>
<div class="line"><a name="l09282"></a><span class="lineno"> 9282</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a923cbf88fdb4b0381d8e3c837656c0b2">SECURITY_INFORMATION</a> SecurityInformation,</div>
<div class="line"><a name="l09283"></a><span class="lineno"> 9283</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> ModificationDescriptor,</div>
<div class="line"><a name="l09284"></a><span class="lineno"> 9284</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> *ObjectsSecurityDescriptor,</div>
<div class="line"><a name="l09285"></a><span class="lineno"> 9285</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> AutoInheritFlags,</div>
<div class="line"><a name="l09286"></a><span class="lineno"> 9286</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> PoolType,</div>
<div class="line"><a name="l09287"></a><span class="lineno"> 9287</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d7/def/a00521.html">PGENERIC_MAPPING</a> GenericMapping,</div>
<div class="line"><a name="l09288"></a><span class="lineno"> 9288</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> Token OPTIONAL</div>
<div class="line"><a name="l09289"></a><span class="lineno"> 9289</span>&#160;    )</div>
<div class="line"><a name="l09290"></a><span class="lineno"> 9290</span>&#160;</div>
<div class="line"><a name="l09291"></a><span class="lineno"> 9291</span>&#160;</div>
<div class="line"><a name="l09292"></a><span class="lineno"> 9292</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l09293"></a><span class="lineno"> 9293</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09294"></a><span class="lineno"> 9294</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l09295"></a><span class="lineno"> 9295</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09296"></a><span class="lineno"> 9296</span>&#160;<span class="comment">    Modify an object&#39;s existing self-relative form security descriptor.</span></div>
<div class="line"><a name="l09297"></a><span class="lineno"> 9297</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09298"></a><span class="lineno"> 9298</span>&#160;<span class="comment">    This procedure, called only from user mode, is used to update a</span></div>
<div class="line"><a name="l09299"></a><span class="lineno"> 9299</span>&#160;<span class="comment">    security descriptor on an existing protected server&#39;s object.  It</span></div>
<div class="line"><a name="l09300"></a><span class="lineno"> 9300</span>&#160;<span class="comment">    applies changes requested by a new security descriptor to the existing</span></div>
<div class="line"><a name="l09301"></a><span class="lineno"> 9301</span>&#160;<span class="comment">    security descriptor.  If necessary, this routine will allocate</span></div>
<div class="line"><a name="l09302"></a><span class="lineno"> 9302</span>&#160;<span class="comment">    additional memory to produce a larger security descriptor.  All access</span></div>
<div class="line"><a name="l09303"></a><span class="lineno"> 9303</span>&#160;<span class="comment">    checking is expected to be done before calling this routine.  This</span></div>
<div class="line"><a name="l09304"></a><span class="lineno"> 9304</span>&#160;<span class="comment">    includes checking for WRITE_OWNER, WRITE_DAC, and privilege to assign a</span></div>
<div class="line"><a name="l09305"></a><span class="lineno"> 9305</span>&#160;<span class="comment">    system ACL as appropriate.</span></div>
<div class="line"><a name="l09306"></a><span class="lineno"> 9306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09307"></a><span class="lineno"> 9307</span>&#160;<span class="comment">    The caller of this routine must not be impersonating a client.</span></div>
<div class="line"><a name="l09308"></a><span class="lineno"> 9308</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09309"></a><span class="lineno"> 9309</span>&#160;<span class="comment">                                  - - WARNING - -</span></div>
<div class="line"><a name="l09310"></a><span class="lineno"> 9310</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09311"></a><span class="lineno"> 9311</span>&#160;<span class="comment">    This service is for use by protected subsystems that project their own</span></div>
<div class="line"><a name="l09312"></a><span class="lineno"> 9312</span>&#160;<span class="comment">    type of object.  This service is explicitly not for use by the</span></div>
<div class="line"><a name="l09313"></a><span class="lineno"> 9313</span>&#160;<span class="comment">    executive for executive objects and must not be called from kernel</span></div>
<div class="line"><a name="l09314"></a><span class="lineno"> 9314</span>&#160;<span class="comment">    mode.</span></div>
<div class="line"><a name="l09315"></a><span class="lineno"> 9315</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09316"></a><span class="lineno"> 9316</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l09317"></a><span class="lineno"> 9317</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09318"></a><span class="lineno"> 9318</span>&#160;<span class="comment">    Object - Optionally supplies the object whose security is</span></div>
<div class="line"><a name="l09319"></a><span class="lineno"> 9319</span>&#160;<span class="comment">        being adjusted.  This is used to update security quota</span></div>
<div class="line"><a name="l09320"></a><span class="lineno"> 9320</span>&#160;<span class="comment">        information.</span></div>
<div class="line"><a name="l09321"></a><span class="lineno"> 9321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09322"></a><span class="lineno"> 9322</span>&#160;<span class="comment">    SecurityInformation - Indicates which security information is</span></div>
<div class="line"><a name="l09323"></a><span class="lineno"> 9323</span>&#160;<span class="comment">        to be applied to the object.  The value(s) to be assigned are</span></div>
<div class="line"><a name="l09324"></a><span class="lineno"> 9324</span>&#160;<span class="comment">        passed in the ModificationDescriptor parameter.</span></div>
<div class="line"><a name="l09325"></a><span class="lineno"> 9325</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09326"></a><span class="lineno"> 9326</span>&#160;<span class="comment">    ModificationDescriptor - Supplies the input security descriptor to be</span></div>
<div class="line"><a name="l09327"></a><span class="lineno"> 9327</span>&#160;<span class="comment">        applied to the object.  The caller of this routine is expected</span></div>
<div class="line"><a name="l09328"></a><span class="lineno"> 9328</span>&#160;<span class="comment">        to probe and capture the passed security descriptor before calling</span></div>
<div class="line"><a name="l09329"></a><span class="lineno"> 9329</span>&#160;<span class="comment">        and release it after calling.</span></div>
<div class="line"><a name="l09330"></a><span class="lineno"> 9330</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09331"></a><span class="lineno"> 9331</span>&#160;<span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span></div>
<div class="line"><a name="l09332"></a><span class="lineno"> 9332</span>&#160;<span class="comment">        the objects security descriptor that is going to be altered by</span></div>
<div class="line"><a name="l09333"></a><span class="lineno"> 9333</span>&#160;<span class="comment">        this procedure.  This security descriptor must be in self-</span></div>
<div class="line"><a name="l09334"></a><span class="lineno"> 9334</span>&#160;<span class="comment">        relative form or an error will be returned.</span></div>
<div class="line"><a name="l09335"></a><span class="lineno"> 9335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09336"></a><span class="lineno"> 9336</span>&#160;<span class="comment">    AutoInheritFlags - Controls automatic inheritance of ACES.</span></div>
<div class="line"><a name="l09337"></a><span class="lineno"> 9337</span>&#160;<span class="comment">        Valid values are a bits mask of the logical OR of</span></div>
<div class="line"><a name="l09338"></a><span class="lineno"> 9338</span>&#160;<span class="comment">        one or more of the following bits:</span></div>
<div class="line"><a name="l09339"></a><span class="lineno"> 9339</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09340"></a><span class="lineno"> 9340</span>&#160;<span class="comment">        SEF_DACL_AUTO_INHERIT - If set, inherited ACEs from the</span></div>
<div class="line"><a name="l09341"></a><span class="lineno"> 9341</span>&#160;<span class="comment">            DACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from</span></div>
<div class="line"><a name="l09342"></a><span class="lineno"> 9342</span>&#160;<span class="comment">            the ModificationDescriptor are ignored. Inherited ACEs are not supposed</span></div>
<div class="line"><a name="l09343"></a><span class="lineno"> 9343</span>&#160;<span class="comment">            to be modified; so preserving them across this call is appropriate.</span></div>
<div class="line"><a name="l09344"></a><span class="lineno"> 9344</span>&#160;<span class="comment">            If a protected server does not itself implement auto inheritance, it should</span></div>
<div class="line"><a name="l09345"></a><span class="lineno"> 9345</span>&#160;<span class="comment">            not set this bit.  The caller of the protected server may implement</span></div>
<div class="line"><a name="l09346"></a><span class="lineno"> 9346</span>&#160;<span class="comment">            auto inheritance and my indeed be modifying inherited ACEs.</span></div>
<div class="line"><a name="l09347"></a><span class="lineno"> 9347</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09348"></a><span class="lineno"> 9348</span>&#160;<span class="comment">        SEF_SACL_AUTO_INHERIT - If set, inherited ACEs from the</span></div>
<div class="line"><a name="l09349"></a><span class="lineno"> 9349</span>&#160;<span class="comment">            SACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from</span></div>
<div class="line"><a name="l09350"></a><span class="lineno"> 9350</span>&#160;<span class="comment">            the ModificationDescriptor are ignored. Inherited ACEs are not supposed</span></div>
<div class="line"><a name="l09351"></a><span class="lineno"> 9351</span>&#160;<span class="comment">            to be modified; so preserving them across this call is appropriate.</span></div>
<div class="line"><a name="l09352"></a><span class="lineno"> 9352</span>&#160;<span class="comment">            If a protected server does not itself implement auto inheritance, it should</span></div>
<div class="line"><a name="l09353"></a><span class="lineno"> 9353</span>&#160;<span class="comment">            not set this bit.  The caller of the protected server may implement</span></div>
<div class="line"><a name="l09354"></a><span class="lineno"> 9354</span>&#160;<span class="comment">            auto inheritance and my indeed be modifying inherited ACEs.</span></div>
<div class="line"><a name="l09355"></a><span class="lineno"> 9355</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09356"></a><span class="lineno"> 9356</span>&#160;<span class="comment">         SEF_AVOID_PRIVILEGE_CHECK - If set, the Token in not used to ensure the</span></div>
<div class="line"><a name="l09357"></a><span class="lineno"> 9357</span>&#160;<span class="comment">            Owner passed in ModificationDescriptor is valid.</span></div>
<div class="line"><a name="l09358"></a><span class="lineno"> 9358</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09359"></a><span class="lineno"> 9359</span>&#160;<span class="comment">    PoolType - Specifies the type of pool to allocate for the objects</span></div>
<div class="line"><a name="l09360"></a><span class="lineno"> 9360</span>&#160;<span class="comment">        security descriptor.</span></div>
<div class="line"><a name="l09361"></a><span class="lineno"> 9361</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09362"></a><span class="lineno"> 9362</span>&#160;<span class="comment">    GenericMapping - This argument provides the mapping of generic to</span></div>
<div class="line"><a name="l09363"></a><span class="lineno"> 9363</span>&#160;<span class="comment">        specific/standard access types for the object being accessed.</span></div>
<div class="line"><a name="l09364"></a><span class="lineno"> 9364</span>&#160;<span class="comment">        This mapping structure is expected to be safe to access</span></div>
<div class="line"><a name="l09365"></a><span class="lineno"> 9365</span>&#160;<span class="comment">        (i.e., captured if necessary) prior to be passed to this routine.</span></div>
<div class="line"><a name="l09366"></a><span class="lineno"> 9366</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09367"></a><span class="lineno"> 9367</span>&#160;<span class="comment">    Token - (optionally) Supplies the token for the client on whose</span></div>
<div class="line"><a name="l09368"></a><span class="lineno"> 9368</span>&#160;<span class="comment">        behalf the security is being modified.  This parameter is only</span></div>
<div class="line"><a name="l09369"></a><span class="lineno"> 9369</span>&#160;<span class="comment">        required to ensure that the client has provided a legitimate</span></div>
<div class="line"><a name="l09370"></a><span class="lineno"> 9370</span>&#160;<span class="comment">        value for a new owner SID.  The token must be open for</span></div>
<div class="line"><a name="l09371"></a><span class="lineno"> 9371</span>&#160;<span class="comment">        TOKEN_QUERY access.</span></div>
<div class="line"><a name="l09372"></a><span class="lineno"> 9372</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09373"></a><span class="lineno"> 9373</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l09374"></a><span class="lineno"> 9374</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09375"></a><span class="lineno"> 9375</span>&#160;<span class="comment">    STATUS_SUCCESS - The operation was successful.</span></div>
<div class="line"><a name="l09376"></a><span class="lineno"> 9376</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09377"></a><span class="lineno"> 9377</span>&#160;<span class="comment">    STATUS_INVALID_OWNER - The owner SID provided as the new owner of the</span></div>
<div class="line"><a name="l09378"></a><span class="lineno"> 9378</span>&#160;<span class="comment">        target security descriptor is not one the caller is authorized to</span></div>
<div class="line"><a name="l09379"></a><span class="lineno"> 9379</span>&#160;<span class="comment">        assign as the owner of an object, or the client did not pass</span></div>
<div class="line"><a name="l09380"></a><span class="lineno"> 9380</span>&#160;<span class="comment">        a token at all.</span></div>
<div class="line"><a name="l09381"></a><span class="lineno"> 9381</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09382"></a><span class="lineno"> 9382</span>&#160;<span class="comment">    STATUS_NO_CLIENT_TOKEN - Indicates a client token was not explicitly</span></div>
<div class="line"><a name="l09383"></a><span class="lineno"> 9383</span>&#160;<span class="comment">        provided and the caller is not currently impersonating a client.</span></div>
<div class="line"><a name="l09384"></a><span class="lineno"> 9384</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09385"></a><span class="lineno"> 9385</span>&#160;<span class="comment">    STATUS_BAD_DESCRIPTOR_FORMAT - Indicates the provided object&#39;s security</span></div>
<div class="line"><a name="l09386"></a><span class="lineno"> 9386</span>&#160;<span class="comment">        descriptor was not in self-relative format.</span></div>
<div class="line"><a name="l09387"></a><span class="lineno"> 9387</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l09388"></a><span class="lineno"> 9388</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l09389"></a><span class="lineno"> 9389</span>&#160;</div>
<div class="line"><a name="l09390"></a><span class="lineno"> 9390</span>&#160;{</div>
<div class="line"><a name="l09391"></a><span class="lineno"> 9391</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewGroupPresent = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09392"></a><span class="lineno"> 9392</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> NewOwnerPresent = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09393"></a><span class="lineno"> 9393</span>&#160;</div>
<div class="line"><a name="l09394"></a><span class="lineno"> 9394</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ServerAclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09395"></a><span class="lineno"> 9395</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> LocalDaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09396"></a><span class="lineno"> 9396</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> LocalSaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09397"></a><span class="lineno"> 9397</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ServerObject;</div>
<div class="line"><a name="l09398"></a><span class="lineno"> 9398</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> DaclUntrusted;</div>
<div class="line"><a name="l09399"></a><span class="lineno"> 9399</span>&#160;</div>
<div class="line"><a name="l09400"></a><span class="lineno"> 9400</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Field;</div>
<div class="line"><a name="l09401"></a><span class="lineno"> 9401</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a> Base;</div>
<div class="line"><a name="l09402"></a><span class="lineno"> 9402</span>&#160;</div>
<div class="line"><a name="l09403"></a><span class="lineno"> 9403</span>&#160;    <a class="code" href="../../d6/d91/a01587.html">PISECURITY_DESCRIPTOR_RELATIVE</a> NewDescriptor = <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l09404"></a><span class="lineno"> 9404</span>&#160;</div>
<div class="line"><a name="l09405"></a><span class="lineno"> 9405</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l09406"></a><span class="lineno"> 9406</span>&#160;</div>
<div class="line"><a name="l09407"></a><span class="lineno"> 9407</span>&#160;    <a class="code" href="../../d5/d77/a01749.html">TOKEN_STATISTICS</a> ThreadTokenStatistics;</div>
<div class="line"><a name="l09408"></a><span class="lineno"> 9408</span>&#160;</div>
<div class="line"><a name="l09409"></a><span class="lineno"> 9409</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ReturnLength;</div>
<div class="line"><a name="l09410"></a><span class="lineno"> 9410</span>&#160;</div>
<div class="line"><a name="l09411"></a><span class="lineno"> 9411</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewGroup;</div>
<div class="line"><a name="l09412"></a><span class="lineno"> 9412</span>&#160;    <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> NewOwner;</div>
<div class="line"><a name="l09413"></a><span class="lineno"> 9413</span>&#160;</div>
<div class="line"><a name="l09414"></a><span class="lineno"> 9414</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewDacl;</div>
<div class="line"><a name="l09415"></a><span class="lineno"> 9415</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> LocalDacl;</div>
<div class="line"><a name="l09416"></a><span class="lineno"> 9416</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> NewSacl;</div>
<div class="line"><a name="l09417"></a><span class="lineno"> 9417</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> LocalSacl;</div>
<div class="line"><a name="l09418"></a><span class="lineno"> 9418</span>&#160;</div>
<div class="line"><a name="l09419"></a><span class="lineno"> 9419</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewDaclSize;</div>
<div class="line"><a name="l09420"></a><span class="lineno"> 9420</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewSaclSize;</div>
<div class="line"><a name="l09421"></a><span class="lineno"> 9421</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewOwnerSize, OwnerSize;</div>
<div class="line"><a name="l09422"></a><span class="lineno"> 9422</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewGroupSize, GroupSize;</div>
<div class="line"><a name="l09423"></a><span class="lineno"> 9423</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="code" href="../../d7/d24/a02261.html#a053c57ea472f2605ef6d732f25e5c6b8">AllocationSize</a>;</div>
<div class="line"><a name="l09424"></a><span class="lineno"> 9424</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ServerOwnerInfoSize;</div>
<div class="line"><a name="l09425"></a><span class="lineno"> 9425</span>&#160;</div>
<div class="line"><a name="l09426"></a><span class="lineno"> 9426</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a> PrimaryToken;</div>
<div class="line"><a name="l09427"></a><span class="lineno"> 9427</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GenericControl;</div>
<div class="line"><a name="l09428"></a><span class="lineno"> 9428</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> NewControlBits = <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>;</div>
<div class="line"><a name="l09429"></a><span class="lineno"> 9429</span>&#160;</div>
<div class="line"><a name="l09430"></a><span class="lineno"> 9430</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> ServerDacl;</div>
<div class="line"><a name="l09431"></a><span class="lineno"> 9431</span>&#160;</div>
<div class="line"><a name="l09432"></a><span class="lineno"> 9432</span>&#160;    <a class="code" href="../../dc/d42/a01591.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;</div>
<div class="line"><a name="l09433"></a><span class="lineno"> 9433</span>&#160;</div>
<div class="line"><a name="l09434"></a><span class="lineno"> 9434</span>&#160;</div>
<div class="line"><a name="l09435"></a><span class="lineno"> 9435</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09436"></a><span class="lineno"> 9436</span>&#160;    <span class="comment">// Typecast to internal representation of security descriptor.</span></div>
<div class="line"><a name="l09437"></a><span class="lineno"> 9437</span>&#160;    <span class="comment">// Note that the internal one is not a pointer to a pointer.</span></div>
<div class="line"><a name="l09438"></a><span class="lineno"> 9438</span>&#160;    <span class="comment">// It is just a pointer to a security descriptor.</span></div>
<div class="line"><a name="l09439"></a><span class="lineno"> 9439</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09440"></a><span class="lineno"> 9440</span>&#160;    <a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> IModificationDescriptor =</div>
<div class="line"><a name="l09441"></a><span class="lineno"> 9441</span>&#160;       (<a class="code" href="../../d3/d3a/a02259.html#a61cf327633d2a19c13477bda23e517ad">PISECURITY_DESCRIPTOR</a>)ModificationDescriptor;</div>
<div class="line"><a name="l09442"></a><span class="lineno"> 9442</span>&#160;</div>
<div class="line"><a name="l09443"></a><span class="lineno"> 9443</span>&#160;    <a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> *IObjectsSecurityDescriptor =</div>
<div class="line"><a name="l09444"></a><span class="lineno"> 9444</span>&#160;       (<a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> *)(ObjectsSecurityDescriptor);</div>
<div class="line"><a name="l09445"></a><span class="lineno"> 9445</span>&#160;</div>
<div class="line"><a name="l09446"></a><span class="lineno"> 9446</span>&#160;    <a class="code" href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a>();</div>
<div class="line"><a name="l09447"></a><span class="lineno"> 9447</span>&#160;</div>
<div class="line"><a name="l09448"></a><span class="lineno"> 9448</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09449"></a><span class="lineno"> 9449</span>&#160;    <span class="comment">//  Validate that the provided SD is in self-relative form</span></div>
<div class="line"><a name="l09450"></a><span class="lineno"> 9450</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09451"></a><span class="lineno"> 9451</span>&#160;</div>
<div class="line"><a name="l09452"></a><span class="lineno"> 9452</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>(*IObjectsSecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>) ) {</div>
<div class="line"><a name="l09453"></a><span class="lineno"> 9453</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a1cc0388869628f7245cb8134faa7257c">STATUS_BAD_DESCRIPTOR_FORMAT</a>;</div>
<div class="line"><a name="l09454"></a><span class="lineno"> 9454</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09455"></a><span class="lineno"> 9455</span>&#160;    }</div>
<div class="line"><a name="l09456"></a><span class="lineno"> 9456</span>&#160;</div>
<div class="line"><a name="l09457"></a><span class="lineno"> 9457</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09458"></a><span class="lineno"> 9458</span>&#160;    <span class="comment">// Check to see if we need to edit the passed acl</span></div>
<div class="line"><a name="l09459"></a><span class="lineno"> 9459</span>&#160;    <span class="comment">// either because we&#39;re creating a server object, or because</span></div>
<div class="line"><a name="l09460"></a><span class="lineno"> 9460</span>&#160;    <span class="comment">// we were passed an untrusted ACL.</span></div>
<div class="line"><a name="l09461"></a><span class="lineno"> 9461</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09462"></a><span class="lineno"> 9462</span>&#160;</div>
<div class="line"><a name="l09463"></a><span class="lineno"> 9463</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(ModificationDescriptor)) {</div>
<div class="line"><a name="l09464"></a><span class="lineno"> 9464</span>&#160;</div>
<div class="line"><a name="l09465"></a><span class="lineno"> 9465</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>(IModificationDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a39e75889cffac1a2830c354f27ea1b43">SE_SERVER_SECURITY</a>)) {</div>
<div class="line"><a name="l09466"></a><span class="lineno"> 9466</span>&#160;            ServerObject = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09467"></a><span class="lineno"> 9467</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09468"></a><span class="lineno"> 9468</span>&#160;            ServerObject = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09469"></a><span class="lineno"> 9469</span>&#160;        }</div>
<div class="line"><a name="l09470"></a><span class="lineno"> 9470</span>&#160;</div>
<div class="line"><a name="l09471"></a><span class="lineno"> 9471</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>(IModificationDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a8d0e3871ec8a12b6bcda7c0858ba64be">SE_DACL_UNTRUSTED</a>)) {</div>
<div class="line"><a name="l09472"></a><span class="lineno"> 9472</span>&#160;            DaclUntrusted = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09473"></a><span class="lineno"> 9473</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09474"></a><span class="lineno"> 9474</span>&#160;            DaclUntrusted = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09475"></a><span class="lineno"> 9475</span>&#160;        }</div>
<div class="line"><a name="l09476"></a><span class="lineno"> 9476</span>&#160;</div>
<div class="line"><a name="l09477"></a><span class="lineno"> 9477</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09478"></a><span class="lineno"> 9478</span>&#160;</div>
<div class="line"><a name="l09479"></a><span class="lineno"> 9479</span>&#160;        ServerObject = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09480"></a><span class="lineno"> 9480</span>&#160;        DaclUntrusted = <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l09481"></a><span class="lineno"> 9481</span>&#160;</div>
<div class="line"><a name="l09482"></a><span class="lineno"> 9482</span>&#160;    }</div>
<div class="line"><a name="l09483"></a><span class="lineno"> 9483</span>&#160;</div>
<div class="line"><a name="l09484"></a><span class="lineno"> 9484</span>&#160;</div>
<div class="line"><a name="l09485"></a><span class="lineno"> 9485</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09486"></a><span class="lineno"> 9486</span>&#160;    <span class="comment">// For each item specified in the SecurityInformation, extract it</span></div>
<div class="line"><a name="l09487"></a><span class="lineno"> 9487</span>&#160;    <span class="comment">// and get it to the point where it can be copied into a new</span></div>
<div class="line"><a name="l09488"></a><span class="lineno"> 9488</span>&#160;    <span class="comment">// descriptor.</span></div>
<div class="line"><a name="l09489"></a><span class="lineno"> 9489</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09490"></a><span class="lineno"> 9490</span>&#160;</div>
<div class="line"><a name="l09491"></a><span class="lineno"> 9491</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09492"></a><span class="lineno"> 9492</span>&#160;    <span class="comment">// if he&#39;s setting the owner field, make sure he&#39;s</span></div>
<div class="line"><a name="l09493"></a><span class="lineno"> 9493</span>&#160;    <span class="comment">// allowed to set that value as an owner.</span></div>
<div class="line"><a name="l09494"></a><span class="lineno"> 9494</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09495"></a><span class="lineno"> 9495</span>&#160;</div>
<div class="line"><a name="l09496"></a><span class="lineno"> 9496</span>&#160;    <span class="keywordflow">if</span> (SecurityInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#a5befedca477346da731bee5367de1921">OWNER_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l09497"></a><span class="lineno"> 9497</span>&#160;</div>
<div class="line"><a name="l09498"></a><span class="lineno"> 9498</span>&#160;        NewOwner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a>( IModificationDescriptor );</div>
<div class="line"><a name="l09499"></a><span class="lineno"> 9499</span>&#160;        NewOwnerPresent = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09500"></a><span class="lineno"> 9500</span>&#160;</div>
<div class="line"><a name="l09501"></a><span class="lineno"> 9501</span>&#160;        <span class="keywordflow">if</span> ((AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#af9c9d7545f456effa5019a3f41ee424f">SEF_AVOID_PRIVILEGE_CHECK</a>) == 0 ) {</div>
<div class="line"><a name="l09502"></a><span class="lineno"> 9502</span>&#160;</div>
<div class="line"><a name="l09503"></a><span class="lineno"> 9503</span>&#160;</div>
<div class="line"><a name="l09504"></a><span class="lineno"> 9504</span>&#160;            <a class="code" href="../../d3/d81/a02284.html#a4fdfa8d06c067debced0c6e8bad60563">SeCaptureSubjectContext</a>( &amp;SubjectContext );</div>
<div class="line"><a name="l09505"></a><span class="lineno"> 9505</span>&#160;</div>
<div class="line"><a name="l09506"></a><span class="lineno"> 9506</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../dd/dee/a02700.html#a4c90199d4212712e0e4f06f9e7f580ac">SepValidOwnerSubjectContext</a>( &amp;SubjectContext, NewOwner, ServerObject ) ) {</div>
<div class="line"><a name="l09507"></a><span class="lineno"> 9507</span>&#160;</div>
<div class="line"><a name="l09508"></a><span class="lineno"> 9508</span>&#160;                <a class="code" href="../../d3/d81/a02284.html#ab0290ff1aa67964ff59b542b1cfeeba1">SeReleaseSubjectContext</a>( &amp;SubjectContext );</div>
<div class="line"><a name="l09509"></a><span class="lineno"> 9509</span>&#160;                <span class="keywordflow">return</span>( <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a> );</div>
<div class="line"><a name="l09510"></a><span class="lineno"> 9510</span>&#160;</div>
<div class="line"><a name="l09511"></a><span class="lineno"> 9511</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09512"></a><span class="lineno"> 9512</span>&#160;</div>
<div class="line"><a name="l09513"></a><span class="lineno"> 9513</span>&#160;                <a class="code" href="../../d3/d81/a02284.html#ab0290ff1aa67964ff59b542b1cfeeba1">SeReleaseSubjectContext</a>( &amp;SubjectContext );</div>
<div class="line"><a name="l09514"></a><span class="lineno"> 9514</span>&#160;            }</div>
<div class="line"><a name="l09515"></a><span class="lineno"> 9515</span>&#160;        }</div>
<div class="line"><a name="l09516"></a><span class="lineno"> 9516</span>&#160;</div>
<div class="line"><a name="l09517"></a><span class="lineno"> 9517</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09518"></a><span class="lineno"> 9518</span>&#160;</div>
<div class="line"><a name="l09519"></a><span class="lineno"> 9519</span>&#160;        NewOwner = <a class="code" href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a> ( *IObjectsSecurityDescriptor );</div>
<div class="line"><a name="l09520"></a><span class="lineno"> 9520</span>&#160;        <span class="keywordflow">if</span> (NewOwner == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09521"></a><span class="lineno"> 9521</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a>;</div>
<div class="line"><a name="l09522"></a><span class="lineno"> 9522</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09523"></a><span class="lineno"> 9523</span>&#160;        }</div>
<div class="line"><a name="l09524"></a><span class="lineno"> 9524</span>&#160;</div>
<div class="line"><a name="l09525"></a><span class="lineno"> 9525</span>&#160;    }</div>
<div class="line"><a name="l09526"></a><span class="lineno"> 9526</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( NewOwner != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> );</div>
<div class="line"><a name="l09527"></a><span class="lineno"> 9527</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( NewOwner )) {</div>
<div class="line"><a name="l09528"></a><span class="lineno"> 9528</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a>;</div>
<div class="line"><a name="l09529"></a><span class="lineno"> 9529</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09530"></a><span class="lineno"> 9530</span>&#160;    }</div>
<div class="line"><a name="l09531"></a><span class="lineno"> 9531</span>&#160;</div>
<div class="line"><a name="l09532"></a><span class="lineno"> 9532</span>&#160;</div>
<div class="line"><a name="l09533"></a><span class="lineno"> 9533</span>&#160;    <span class="keywordflow">if</span> (SecurityInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#ab1cf9e99656615972a3407e5d72574b5">GROUP_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l09534"></a><span class="lineno"> 9534</span>&#160;</div>
<div class="line"><a name="l09535"></a><span class="lineno"> 9535</span>&#160;        NewGroup = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>(IModificationDescriptor);</div>
<div class="line"><a name="l09536"></a><span class="lineno"> 9536</span>&#160;        NewGroupPresent = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09537"></a><span class="lineno"> 9537</span>&#160;</div>
<div class="line"><a name="l09538"></a><span class="lineno"> 9538</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09539"></a><span class="lineno"> 9539</span>&#160;</div>
<div class="line"><a name="l09540"></a><span class="lineno"> 9540</span>&#160;        NewGroup = <a class="code" href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a>( *IObjectsSecurityDescriptor );</div>
<div class="line"><a name="l09541"></a><span class="lineno"> 9541</span>&#160;    }</div>
<div class="line"><a name="l09542"></a><span class="lineno"> 9542</span>&#160;</div>
<div class="line"><a name="l09543"></a><span class="lineno"> 9543</span>&#160;    <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09544"></a><span class="lineno"> 9544</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a>( NewGroup )) {</div>
<div class="line"><a name="l09545"></a><span class="lineno"> 9545</span>&#160;            Status = <a class="code" href="../../dc/d18/a02260.html#ad61c566fa6f03ba2aa2d05700cdc5ea5">STATUS_INVALID_PRIMARY_GROUP</a>;</div>
<div class="line"><a name="l09546"></a><span class="lineno"> 9546</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09547"></a><span class="lineno"> 9547</span>&#160;        }</div>
<div class="line"><a name="l09548"></a><span class="lineno"> 9548</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09549"></a><span class="lineno"> 9549</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#ad61c566fa6f03ba2aa2d05700cdc5ea5">STATUS_INVALID_PRIMARY_GROUP</a>;</div>
<div class="line"><a name="l09550"></a><span class="lineno"> 9550</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09551"></a><span class="lineno"> 9551</span>&#160;    }</div>
<div class="line"><a name="l09552"></a><span class="lineno"> 9552</span>&#160;</div>
<div class="line"><a name="l09553"></a><span class="lineno"> 9553</span>&#160;</div>
<div class="line"><a name="l09554"></a><span class="lineno"> 9554</span>&#160;    <span class="keywordflow">if</span> (SecurityInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#a209f30ceb819d151d3e4479960b65fef">DACL_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l09555"></a><span class="lineno"> 9555</span>&#160;</div>
<div class="line"><a name="l09556"></a><span class="lineno"> 9556</span>&#160;<span class="preprocessor">#ifdef  ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l09557"></a><span class="lineno"> 9557</span>&#160;</div>
<div class="line"><a name="l09558"></a><span class="lineno"> 9558</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09559"></a><span class="lineno"> 9559</span>&#160;        <span class="comment">// Culprit will probably be the caller NtSetSecurityObject, or</span></div>
<div class="line"><a name="l09560"></a><span class="lineno"> 9560</span>&#160;        <span class="comment">// RtlSetSecurityObject. </span></div>
<div class="line"><a name="l09561"></a><span class="lineno"> 9561</span>&#160;        <span class="comment">// </span></div>
<div class="line"><a name="l09562"></a><span class="lineno"> 9562</span>&#160;</div>
<div class="line"><a name="l09563"></a><span class="lineno"> 9563</span>&#160;        <span class="keywordflow">if</span> (RtlpAssertOnNullDacls) {</div>
<div class="line"><a name="l09564"></a><span class="lineno"> 9564</span>&#160;</div>
<div class="line"><a name="l09565"></a><span class="lineno"> 9565</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>((<span class="stringliteral">&quot;NULL DACLs are NOT allowed!&quot;</span>,</div>
<div class="line"><a name="l09566"></a><span class="lineno"> 9566</span>&#160;                    <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>(IModificationDescriptor) != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div>
<div class="line"><a name="l09567"></a><span class="lineno"> 9567</span>&#160;        }</div>
<div class="line"><a name="l09568"></a><span class="lineno"> 9568</span>&#160;<span class="preprocessor">#endif // ASSERT_ON_NULL_DACL</span></div>
<div class="line"><a name="l09569"></a><span class="lineno"> 9569</span>&#160;</div>
<div class="line"><a name="l09570"></a><span class="lineno"> 9570</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09571"></a><span class="lineno"> 9571</span>&#160;        <span class="comment">// If AutoInherit is requested,</span></div>
<div class="line"><a name="l09572"></a><span class="lineno"> 9572</span>&#160;        <span class="comment">//  build a merged ACL.</span></div>
<div class="line"><a name="l09573"></a><span class="lineno"> 9573</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09574"></a><span class="lineno"> 9574</span>&#160;</div>
<div class="line"><a name="l09575"></a><span class="lineno"> 9575</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#a59d287bcfe603ad0d4b5a330be02d22d">SEF_DACL_AUTO_INHERIT</a> ) {</div>
<div class="line"><a name="l09576"></a><span class="lineno"> 9576</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472">RtlpComputeMergedAcl</a>(</div>
<div class="line"><a name="l09577"></a><span class="lineno"> 9577</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( *IObjectsSecurityDescriptor ),</div>
<div class="line"><a name="l09578"></a><span class="lineno"> 9578</span>&#160;                        <a class="code" href="../../df/d4d/a02285.html#a03cefa160daede67f38b6dec9f9119a1">SeControlDaclToGeneric</a>( (*IObjectsSecurityDescriptor)-&gt;Control ),</div>
<div class="line"><a name="l09579"></a><span class="lineno"> 9579</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( IModificationDescriptor ),</div>
<div class="line"><a name="l09580"></a><span class="lineno"> 9580</span>&#160;                        <a class="code" href="../../df/d4d/a02285.html#a03cefa160daede67f38b6dec9f9119a1">SeControlDaclToGeneric</a>( IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> ),</div>
<div class="line"><a name="l09581"></a><span class="lineno"> 9581</span>&#160;                        NewOwner,</div>
<div class="line"><a name="l09582"></a><span class="lineno"> 9582</span>&#160;                        NewGroup,</div>
<div class="line"><a name="l09583"></a><span class="lineno"> 9583</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l09584"></a><span class="lineno"> 9584</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,      <span class="comment">// Not a SACL</span></div>
<div class="line"><a name="l09585"></a><span class="lineno"> 9585</span>&#160;                        &amp;LocalDacl,</div>
<div class="line"><a name="l09586"></a><span class="lineno"> 9586</span>&#160;                        &amp;GenericControl );</div>
<div class="line"><a name="l09587"></a><span class="lineno"> 9587</span>&#160;</div>
<div class="line"><a name="l09588"></a><span class="lineno"> 9588</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l09589"></a><span class="lineno"> 9589</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09590"></a><span class="lineno"> 9590</span>&#160;            }</div>
<div class="line"><a name="l09591"></a><span class="lineno"> 9591</span>&#160;</div>
<div class="line"><a name="l09592"></a><span class="lineno"> 9592</span>&#160;            LocalDaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09593"></a><span class="lineno"> 9593</span>&#160;            NewDacl = LocalDacl;</div>
<div class="line"><a name="l09594"></a><span class="lineno"> 9594</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l09595"></a><span class="lineno"> 9595</span>&#160;            NewControlBits |= <a class="code" href="../../df/d4d/a02285.html#aad434d64fabed59aebb1581338b289b2">SeControlGenericToDacl</a>( GenericControl );</div>
<div class="line"><a name="l09596"></a><span class="lineno"> 9596</span>&#160;</div>
<div class="line"><a name="l09597"></a><span class="lineno"> 9597</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09598"></a><span class="lineno"> 9598</span>&#160;        <span class="comment">// If AutoInherit isn&#39;t requested,</span></div>
<div class="line"><a name="l09599"></a><span class="lineno"> 9599</span>&#160;        <span class="comment">//  just grab a copy of the input DACL.</span></div>
<div class="line"><a name="l09600"></a><span class="lineno"> 9600</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09601"></a><span class="lineno"> 9601</span>&#160;</div>
<div class="line"><a name="l09602"></a><span class="lineno"> 9602</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09603"></a><span class="lineno"> 9603</span>&#160;            NewDacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( IModificationDescriptor );</div>
<div class="line"><a name="l09604"></a><span class="lineno"> 9604</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>;</div>
<div class="line"><a name="l09605"></a><span class="lineno"> 9605</span>&#160;            NewControlBits |= IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a>;</div>
<div class="line"><a name="l09606"></a><span class="lineno"> 9606</span>&#160;</div>
<div class="line"><a name="l09607"></a><span class="lineno"> 9607</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09608"></a><span class="lineno"> 9608</span>&#160;            <span class="comment">// If the original caller claims he understands auto inheritance,</span></div>
<div class="line"><a name="l09609"></a><span class="lineno"> 9609</span>&#160;            <span class="comment">//  preserve the AutoInherited flag.</span></div>
<div class="line"><a name="l09610"></a><span class="lineno"> 9610</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09611"></a><span class="lineno"> 9611</span>&#160;</div>
<div class="line"><a name="l09612"></a><span class="lineno"> 9612</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>(IModificationDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a598b14f5d10c4d033b7a6c1dd2a79e67">SE_DACL_AUTO_INHERIT_REQ</a>|<a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a>) ) {</div>
<div class="line"><a name="l09613"></a><span class="lineno"> 9613</span>&#160;                NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l09614"></a><span class="lineno"> 9614</span>&#160;            }</div>
<div class="line"><a name="l09615"></a><span class="lineno"> 9615</span>&#160;        }</div>
<div class="line"><a name="l09616"></a><span class="lineno"> 9616</span>&#160;</div>
<div class="line"><a name="l09617"></a><span class="lineno"> 9617</span>&#160;        <span class="keywordflow">if</span> (ServerObject) {</div>
<div class="line"><a name="l09618"></a><span class="lineno"> 9618</span>&#160;</div>
<div class="line"><a name="l09619"></a><span class="lineno"> 9619</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextOwner;</div>
<div class="line"><a name="l09620"></a><span class="lineno"> 9620</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextGroup;</div>
<div class="line"><a name="l09621"></a><span class="lineno"> 9621</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextServerOwner;</div>
<div class="line"><a name="l09622"></a><span class="lineno"> 9622</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a> SubjectContextServerGroup;</div>
<div class="line"><a name="l09623"></a><span class="lineno"> 9623</span>&#160;            <a class="code" href="../../d7/dd4/a00013.html">PACL</a> SubjectContextDacl;</div>
<div class="line"><a name="l09624"></a><span class="lineno"> 9624</span>&#160;</div>
<div class="line"><a name="l09625"></a><span class="lineno"> 9625</span>&#160;            <a class="code" href="../../d3/d81/a02284.html#a4fdfa8d06c067debced0c6e8bad60563">SeCaptureSubjectContext</a>( &amp;SubjectContext );</div>
<div class="line"><a name="l09626"></a><span class="lineno"> 9626</span>&#160;</div>
<div class="line"><a name="l09627"></a><span class="lineno"> 9627</span>&#160;            <a class="code" href="../../dd/dee/a02700.html#a9815296fd3bf6e2f58aaf39bf0673148">SepGetDefaultsSubjectContext</a>(</div>
<div class="line"><a name="l09628"></a><span class="lineno"> 9628</span>&#160;                &amp;SubjectContext,</div>
<div class="line"><a name="l09629"></a><span class="lineno"> 9629</span>&#160;                &amp;SubjectContextOwner,</div>
<div class="line"><a name="l09630"></a><span class="lineno"> 9630</span>&#160;                &amp;SubjectContextGroup,</div>
<div class="line"><a name="l09631"></a><span class="lineno"> 9631</span>&#160;                &amp;SubjectContextServerOwner,</div>
<div class="line"><a name="l09632"></a><span class="lineno"> 9632</span>&#160;                &amp;SubjectContextServerGroup,</div>
<div class="line"><a name="l09633"></a><span class="lineno"> 9633</span>&#160;                &amp;SubjectContextDacl</div>
<div class="line"><a name="l09634"></a><span class="lineno"> 9634</span>&#160;                );</div>
<div class="line"><a name="l09635"></a><span class="lineno"> 9635</span>&#160;</div>
<div class="line"><a name="l09636"></a><span class="lineno"> 9636</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0">RtlpCreateServerAcl</a>(</div>
<div class="line"><a name="l09637"></a><span class="lineno"> 9637</span>&#160;                         NewDacl,</div>
<div class="line"><a name="l09638"></a><span class="lineno"> 9638</span>&#160;                         DaclUntrusted,</div>
<div class="line"><a name="l09639"></a><span class="lineno"> 9639</span>&#160;                         SubjectContextServerOwner,</div>
<div class="line"><a name="l09640"></a><span class="lineno"> 9640</span>&#160;                         &amp;ServerDacl,</div>
<div class="line"><a name="l09641"></a><span class="lineno"> 9641</span>&#160;                         &amp;ServerAclAllocated</div>
<div class="line"><a name="l09642"></a><span class="lineno"> 9642</span>&#160;                         );</div>
<div class="line"><a name="l09643"></a><span class="lineno"> 9643</span>&#160;</div>
<div class="line"><a name="l09644"></a><span class="lineno"> 9644</span>&#160;            <a class="code" href="../../d3/d81/a02284.html#ab0290ff1aa67964ff59b542b1cfeeba1">SeReleaseSubjectContext</a>( &amp;SubjectContext );</div>
<div class="line"><a name="l09645"></a><span class="lineno"> 9645</span>&#160;</div>
<div class="line"><a name="l09646"></a><span class="lineno"> 9646</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l09647"></a><span class="lineno"> 9647</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09648"></a><span class="lineno"> 9648</span>&#160;            }</div>
<div class="line"><a name="l09649"></a><span class="lineno"> 9649</span>&#160;</div>
<div class="line"><a name="l09650"></a><span class="lineno"> 9650</span>&#160;            NewDacl = ServerDacl;</div>
<div class="line"><a name="l09651"></a><span class="lineno"> 9651</span>&#160;</div>
<div class="line"><a name="l09652"></a><span class="lineno"> 9652</span>&#160;        }</div>
<div class="line"><a name="l09653"></a><span class="lineno"> 9653</span>&#160;</div>
<div class="line"><a name="l09654"></a><span class="lineno"> 9654</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09655"></a><span class="lineno"> 9655</span>&#160;</div>
<div class="line"><a name="l09656"></a><span class="lineno"> 9656</span>&#160;        NewDacl = <a class="code" href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a>( *IObjectsSecurityDescriptor );</div>
<div class="line"><a name="l09657"></a><span class="lineno"> 9657</span>&#160;    }</div>
<div class="line"><a name="l09658"></a><span class="lineno"> 9658</span>&#160;</div>
<div class="line"><a name="l09659"></a><span class="lineno"> 9659</span>&#160;</div>
<div class="line"><a name="l09660"></a><span class="lineno"> 9660</span>&#160;</div>
<div class="line"><a name="l09661"></a><span class="lineno"> 9661</span>&#160;    <span class="keywordflow">if</span> (SecurityInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#ad7d3e853b74bd0e483fa2c6107fb69fd">SACL_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l09662"></a><span class="lineno"> 9662</span>&#160;</div>
<div class="line"><a name="l09663"></a><span class="lineno"> 9663</span>&#160;</div>
<div class="line"><a name="l09664"></a><span class="lineno"> 9664</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09665"></a><span class="lineno"> 9665</span>&#160;        <span class="comment">// If AutoInherit is requested,</span></div>
<div class="line"><a name="l09666"></a><span class="lineno"> 9666</span>&#160;        <span class="comment">//  build a merged ACL.</span></div>
<div class="line"><a name="l09667"></a><span class="lineno"> 9667</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09668"></a><span class="lineno"> 9668</span>&#160;</div>
<div class="line"><a name="l09669"></a><span class="lineno"> 9669</span>&#160;        <span class="keywordflow">if</span> ( AutoInheritFlags &amp; <a class="code" href="../../d7/d24/a02261.html#ab31f4c0fab101f20d852eb7b68b57cd4">SEF_SACL_AUTO_INHERIT</a> ) {</div>
<div class="line"><a name="l09670"></a><span class="lineno"> 9670</span>&#160;            Status = <a class="code" href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472">RtlpComputeMergedAcl</a>(</div>
<div class="line"><a name="l09671"></a><span class="lineno"> 9671</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( *IObjectsSecurityDescriptor ),</div>
<div class="line"><a name="l09672"></a><span class="lineno"> 9672</span>&#160;                        <a class="code" href="../../df/d4d/a02285.html#a478668a3f7d97d76ab60a908fd5a4780">SeControlSaclToGeneric</a>( (*IObjectsSecurityDescriptor)-&gt;Control ),</div>
<div class="line"><a name="l09673"></a><span class="lineno"> 9673</span>&#160;                        <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( IModificationDescriptor ),</div>
<div class="line"><a name="l09674"></a><span class="lineno"> 9674</span>&#160;                        <a class="code" href="../../df/d4d/a02285.html#a478668a3f7d97d76ab60a908fd5a4780">SeControlSaclToGeneric</a>( IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> ),</div>
<div class="line"><a name="l09675"></a><span class="lineno"> 9675</span>&#160;                        NewOwner,</div>
<div class="line"><a name="l09676"></a><span class="lineno"> 9676</span>&#160;                        NewGroup,</div>
<div class="line"><a name="l09677"></a><span class="lineno"> 9677</span>&#160;                        GenericMapping,</div>
<div class="line"><a name="l09678"></a><span class="lineno"> 9678</span>&#160;                        <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,      <span class="comment">// Is a SACL</span></div>
<div class="line"><a name="l09679"></a><span class="lineno"> 9679</span>&#160;                        &amp;LocalSacl,</div>
<div class="line"><a name="l09680"></a><span class="lineno"> 9680</span>&#160;                        &amp;GenericControl );</div>
<div class="line"><a name="l09681"></a><span class="lineno"> 9681</span>&#160;</div>
<div class="line"><a name="l09682"></a><span class="lineno"> 9682</span>&#160;            <span class="keywordflow">if</span> ( !<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>(Status)) {</div>
<div class="line"><a name="l09683"></a><span class="lineno"> 9683</span>&#160;                <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09684"></a><span class="lineno"> 9684</span>&#160;            }</div>
<div class="line"><a name="l09685"></a><span class="lineno"> 9685</span>&#160;            LocalSaclAllocated = <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l09686"></a><span class="lineno"> 9686</span>&#160;            NewSacl = LocalSacl;</div>
<div class="line"><a name="l09687"></a><span class="lineno"> 9687</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>;</div>
<div class="line"><a name="l09688"></a><span class="lineno"> 9688</span>&#160;            NewControlBits |= <a class="code" href="../../df/d4d/a02285.html#a2739a37915edd332226ecc507d08067d">SeControlGenericToSacl</a>( GenericControl );</div>
<div class="line"><a name="l09689"></a><span class="lineno"> 9689</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09690"></a><span class="lineno"> 9690</span>&#160;            NewSacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( IModificationDescriptor );</div>
<div class="line"><a name="l09691"></a><span class="lineno"> 9691</span>&#160;            NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>;</div>
<div class="line"><a name="l09692"></a><span class="lineno"> 9692</span>&#160;            NewControlBits |= IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a>;</div>
<div class="line"><a name="l09693"></a><span class="lineno"> 9693</span>&#160;</div>
<div class="line"><a name="l09694"></a><span class="lineno"> 9694</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09695"></a><span class="lineno"> 9695</span>&#160;            <span class="comment">// If the original caller claims he understands auto inheritance,</span></div>
<div class="line"><a name="l09696"></a><span class="lineno"> 9696</span>&#160;            <span class="comment">//  preserve the AutoInherited flag.</span></div>
<div class="line"><a name="l09697"></a><span class="lineno"> 9697</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09698"></a><span class="lineno"> 9698</span>&#160;</div>
<div class="line"><a name="l09699"></a><span class="lineno"> 9699</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>(IModificationDescriptor, <a class="code" href="../../d3/d3a/a02259.html#aae9d6ab7cd5bf47b8f418aa9b3693eb3">SE_SACL_AUTO_INHERIT_REQ</a>|<a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>) ) {</div>
<div class="line"><a name="l09700"></a><span class="lineno"> 9700</span>&#160;                NewControlBits |= <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a>;</div>
<div class="line"><a name="l09701"></a><span class="lineno"> 9701</span>&#160;            }</div>
<div class="line"><a name="l09702"></a><span class="lineno"> 9702</span>&#160;        }</div>
<div class="line"><a name="l09703"></a><span class="lineno"> 9703</span>&#160;</div>
<div class="line"><a name="l09704"></a><span class="lineno"> 9704</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09705"></a><span class="lineno"> 9705</span>&#160;</div>
<div class="line"><a name="l09706"></a><span class="lineno"> 9706</span>&#160;        NewSacl = <a class="code" href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a>( *IObjectsSecurityDescriptor );</div>
<div class="line"><a name="l09707"></a><span class="lineno"> 9707</span>&#160;    }</div>
<div class="line"><a name="l09708"></a><span class="lineno"> 9708</span>&#160;</div>
<div class="line"><a name="l09709"></a><span class="lineno"> 9709</span>&#160;</div>
<div class="line"><a name="l09710"></a><span class="lineno"> 9710</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09711"></a><span class="lineno"> 9711</span>&#160;    <span class="comment">// Everything is assignable by the requestor.</span></div>
<div class="line"><a name="l09712"></a><span class="lineno"> 9712</span>&#160;    <span class="comment">// Calculate the memory needed to house all the information in</span></div>
<div class="line"><a name="l09713"></a><span class="lineno"> 9713</span>&#160;    <span class="comment">// a self-relative security descriptor.</span></div>
<div class="line"><a name="l09714"></a><span class="lineno"> 9714</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09715"></a><span class="lineno"> 9715</span>&#160;    <span class="comment">// Also map the ACEs for application to the target object</span></div>
<div class="line"><a name="l09716"></a><span class="lineno"> 9716</span>&#160;    <span class="comment">// type, if they haven&#39;t already been mapped.</span></div>
<div class="line"><a name="l09717"></a><span class="lineno"> 9717</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09718"></a><span class="lineno"> 9718</span>&#160;    OwnerSize = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewOwner);</div>
<div class="line"><a name="l09719"></a><span class="lineno"> 9719</span>&#160;    NewOwnerSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(OwnerSize);</div>
<div class="line"><a name="l09720"></a><span class="lineno"> 9720</span>&#160;</div>
<div class="line"><a name="l09721"></a><span class="lineno"> 9721</span>&#160;    <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09722"></a><span class="lineno"> 9722</span>&#160;        GroupSize = <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a>(NewGroup);</div>
<div class="line"><a name="l09723"></a><span class="lineno"> 9723</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09724"></a><span class="lineno"> 9724</span>&#160;        GroupSize = 0;</div>
<div class="line"><a name="l09725"></a><span class="lineno"> 9725</span>&#160;    }</div>
<div class="line"><a name="l09726"></a><span class="lineno"> 9726</span>&#160;    NewGroupSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(GroupSize);</div>
<div class="line"><a name="l09727"></a><span class="lineno"> 9727</span>&#160;</div>
<div class="line"><a name="l09728"></a><span class="lineno"> 9728</span>&#160;    <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09729"></a><span class="lineno"> 9729</span>&#160;        NewSaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09730"></a><span class="lineno"> 9730</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09731"></a><span class="lineno"> 9731</span>&#160;        NewSaclSize = 0;</div>
<div class="line"><a name="l09732"></a><span class="lineno"> 9732</span>&#160;    }</div>
<div class="line"><a name="l09733"></a><span class="lineno"> 9733</span>&#160;</div>
<div class="line"><a name="l09734"></a><span class="lineno"> 9734</span>&#160;    <span class="keywordflow">if</span> (NewDacl !=<a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09735"></a><span class="lineno"> 9735</span>&#160;        NewDaclSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09736"></a><span class="lineno"> 9736</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09737"></a><span class="lineno"> 9737</span>&#160;        NewDaclSize = 0;</div>
<div class="line"><a name="l09738"></a><span class="lineno"> 9738</span>&#160;    }</div>
<div class="line"><a name="l09739"></a><span class="lineno"> 9739</span>&#160;</div>
<div class="line"><a name="l09740"></a><span class="lineno"> 9740</span>&#160;    AllocationSize = <a class="code" href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>)) +</div>
<div class="line"><a name="l09741"></a><span class="lineno"> 9741</span>&#160;                     NewOwnerSize +</div>
<div class="line"><a name="l09742"></a><span class="lineno"> 9742</span>&#160;                     NewGroupSize +</div>
<div class="line"><a name="l09743"></a><span class="lineno"> 9743</span>&#160;                     NewSaclSize  +</div>
<div class="line"><a name="l09744"></a><span class="lineno"> 9744</span>&#160;                     NewDaclSize;</div>
<div class="line"><a name="l09745"></a><span class="lineno"> 9745</span>&#160;</div>
<div class="line"><a name="l09746"></a><span class="lineno"> 9746</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09747"></a><span class="lineno"> 9747</span>&#160;    <span class="comment">// Allocate and initialize the security descriptor as</span></div>
<div class="line"><a name="l09748"></a><span class="lineno"> 9748</span>&#160;    <span class="comment">// self-relative form.</span></div>
<div class="line"><a name="l09749"></a><span class="lineno"> 9749</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09750"></a><span class="lineno"> 9750</span>&#160;</div>
<div class="line"><a name="l09751"></a><span class="lineno"> 9751</span>&#160;    NewDescriptor = <a class="code" href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a>(PoolType, AllocationSize, <span class="stringliteral">&#39;dSeS&#39;</span>);</div>
<div class="line"><a name="l09752"></a><span class="lineno"> 9752</span>&#160;</div>
<div class="line"><a name="l09753"></a><span class="lineno"> 9753</span>&#160;    <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ) {</div>
<div class="line"><a name="l09754"></a><span class="lineno"> 9754</span>&#160;        Status = <a class="code" href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a>;</div>
<div class="line"><a name="l09755"></a><span class="lineno"> 9755</span>&#160;        <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09756"></a><span class="lineno"> 9756</span>&#160;    }</div>
<div class="line"><a name="l09757"></a><span class="lineno"> 9757</span>&#160;</div>
<div class="line"><a name="l09758"></a><span class="lineno"> 9758</span>&#160;    Status = <a class="code" href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2">RtlCreateSecurityDescriptorRelative</a>(</div>
<div class="line"><a name="l09759"></a><span class="lineno"> 9759</span>&#160;                 NewDescriptor,</div>
<div class="line"><a name="l09760"></a><span class="lineno"> 9760</span>&#160;                 <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a></div>
<div class="line"><a name="l09761"></a><span class="lineno"> 9761</span>&#160;                 );</div>
<div class="line"><a name="l09762"></a><span class="lineno"> 9762</span>&#160;</div>
<div class="line"><a name="l09763"></a><span class="lineno"> 9763</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( <a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status ) );</div>
<div class="line"><a name="l09764"></a><span class="lineno"> 9764</span>&#160;</div>
<div class="line"><a name="l09765"></a><span class="lineno"> 9765</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09766"></a><span class="lineno"> 9766</span>&#160;    <span class="comment">// We must check to make sure that the Group and Dacl size</span></div>
<div class="line"><a name="l09767"></a><span class="lineno"> 9767</span>&#160;    <span class="comment">// do not exceed the quota preallocated for this object&#39;s</span></div>
<div class="line"><a name="l09768"></a><span class="lineno"> 9768</span>&#160;    <span class="comment">// security when it was created.</span></div>
<div class="line"><a name="l09769"></a><span class="lineno"> 9769</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09770"></a><span class="lineno"> 9770</span>&#160;    <span class="comment">// Update SeComputeSecurityQuota if this changes.</span></div>
<div class="line"><a name="l09771"></a><span class="lineno"> 9771</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09772"></a><span class="lineno"> 9772</span>&#160;</div>
<div class="line"><a name="l09773"></a><span class="lineno"> 9773</span>&#160;</div>
<div class="line"><a name="l09774"></a><span class="lineno"> 9774</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>( Object )) {</div>
<div class="line"><a name="l09775"></a><span class="lineno"> 9775</span>&#160;</div>
<div class="line"><a name="l09776"></a><span class="lineno"> 9776</span>&#160;        Status = <a class="code" href="../../d3/d6e/a02266.html#a3ca742f1facb2707a4633d55feacbf4c">ObValidateSecurityQuota</a>(</div>
<div class="line"><a name="l09777"></a><span class="lineno"> 9777</span>&#160;                     Object,</div>
<div class="line"><a name="l09778"></a><span class="lineno"> 9778</span>&#160;                     NewGroupSize + NewDaclSize</div>
<div class="line"><a name="l09779"></a><span class="lineno"> 9779</span>&#160;                     );</div>
<div class="line"><a name="l09780"></a><span class="lineno"> 9780</span>&#160;</div>
<div class="line"><a name="l09781"></a><span class="lineno"> 9781</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a>( Status )) {</div>
<div class="line"><a name="l09782"></a><span class="lineno"> 9782</span>&#160;</div>
<div class="line"><a name="l09783"></a><span class="lineno"> 9783</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09784"></a><span class="lineno"> 9784</span>&#160;            <span class="comment">// The new information is too big.</span></div>
<div class="line"><a name="l09785"></a><span class="lineno"> 9785</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l09786"></a><span class="lineno"> 9786</span>&#160;</div>
<div class="line"><a name="l09787"></a><span class="lineno"> 9787</span>&#160;            <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( NewDescriptor );</div>
<div class="line"><a name="l09788"></a><span class="lineno"> 9788</span>&#160;            <span class="keywordflow">goto</span> Cleanup;</div>
<div class="line"><a name="l09789"></a><span class="lineno"> 9789</span>&#160;        }</div>
<div class="line"><a name="l09790"></a><span class="lineno"> 9790</span>&#160;</div>
<div class="line"><a name="l09791"></a><span class="lineno"> 9791</span>&#160;    }</div>
<div class="line"><a name="l09792"></a><span class="lineno"> 9792</span>&#160;</div>
<div class="line"><a name="l09793"></a><span class="lineno"> 9793</span>&#160;    Base = (<a class="code" href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a>)NewDescriptor;</div>
<div class="line"><a name="l09794"></a><span class="lineno"> 9794</span>&#160;    Field =  Base + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3a/a02259.html#aecc9f2cb4b77c249451b1db76791af53">SECURITY_DESCRIPTOR_RELATIVE</a>);</div>
<div class="line"><a name="l09795"></a><span class="lineno"> 9795</span>&#160;</div>
<div class="line"><a name="l09796"></a><span class="lineno"> 9796</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09797"></a><span class="lineno"> 9797</span>&#160;    <span class="comment">// Map and Copy in the Sacl</span></div>
<div class="line"><a name="l09798"></a><span class="lineno"> 9798</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09799"></a><span class="lineno"> 9799</span>&#160;</div>
<div class="line"><a name="l09800"></a><span class="lineno"> 9800</span>&#160;</div>
<div class="line"><a name="l09801"></a><span class="lineno"> 9801</span>&#160;    <span class="comment">//         if new item {</span></div>
<div class="line"><a name="l09802"></a><span class="lineno"> 9802</span>&#160;    <span class="comment">//             PRESENT=TRUE</span></div>
<div class="line"><a name="l09803"></a><span class="lineno"> 9803</span>&#160;    <span class="comment">//             DEFAULTED=FALSE</span></div>
<div class="line"><a name="l09804"></a><span class="lineno"> 9804</span>&#160;    <span class="comment">//             if (NULL) {</span></div>
<div class="line"><a name="l09805"></a><span class="lineno"> 9805</span>&#160;    <span class="comment">//                 set new pointer to NULL</span></div>
<div class="line"><a name="l09806"></a><span class="lineno"> 9806</span>&#160;    <span class="comment">//             } else {</span></div>
<div class="line"><a name="l09807"></a><span class="lineno"> 9807</span>&#160;    <span class="comment">//                 copy into new SD</span></div>
<div class="line"><a name="l09808"></a><span class="lineno"> 9808</span>&#160;    <span class="comment">//             }</span></div>
<div class="line"><a name="l09809"></a><span class="lineno"> 9809</span>&#160;    <span class="comment">//         } else {</span></div>
<div class="line"><a name="l09810"></a><span class="lineno"> 9810</span>&#160;    <span class="comment">//             copy PRESENT bit</span></div>
<div class="line"><a name="l09811"></a><span class="lineno"> 9811</span>&#160;    <span class="comment">//             copy DEFAULTED bit</span></div>
<div class="line"><a name="l09812"></a><span class="lineno"> 9812</span>&#160;    <span class="comment">//             if (NULL) {</span></div>
<div class="line"><a name="l09813"></a><span class="lineno"> 9813</span>&#160;    <span class="comment">//                 set new pointer to NULL</span></div>
<div class="line"><a name="l09814"></a><span class="lineno"> 9814</span>&#160;    <span class="comment">//             } else {</span></div>
<div class="line"><a name="l09815"></a><span class="lineno"> 9815</span>&#160;    <span class="comment">//                 copy old one into new SD</span></div>
<div class="line"><a name="l09816"></a><span class="lineno"> 9816</span>&#160;    <span class="comment">//             }</span></div>
<div class="line"><a name="l09817"></a><span class="lineno"> 9817</span>&#160;    <span class="comment">//         }</span></div>
<div class="line"><a name="l09818"></a><span class="lineno"> 9818</span>&#160;</div>
<div class="line"><a name="l09819"></a><span class="lineno"> 9819</span>&#160;    <a class="code" href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a>( NewDescriptor, NewControlBits );</div>
<div class="line"><a name="l09820"></a><span class="lineno"> 9820</span>&#160;</div>
<div class="line"><a name="l09821"></a><span class="lineno"> 9821</span>&#160;</div>
<div class="line"><a name="l09822"></a><span class="lineno"> 9822</span>&#160;    <span class="keywordflow">if</span> (IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a>) {</div>
<div class="line"><a name="l09823"></a><span class="lineno"> 9823</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aae3a91931713ea8423d18fd741958388">Sbz1</a> = IModificationDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a4e7f873aebc6462ff1e07b387b11c782">Sbz1</a>;</div>
<div class="line"><a name="l09824"></a><span class="lineno"> 9824</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a084c1aff512c7521374babc4823b237e">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a>;</div>
<div class="line"><a name="l09825"></a><span class="lineno"> 9825</span>&#160;    }</div>
<div class="line"><a name="l09826"></a><span class="lineno"> 9826</span>&#160;</div>
<div class="line"><a name="l09827"></a><span class="lineno"> 9827</span>&#160;    <span class="keywordflow">if</span> (NewSacl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09828"></a><span class="lineno"> 9828</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = 0;</div>
<div class="line"><a name="l09829"></a><span class="lineno"> 9829</span>&#160;</div>
<div class="line"><a name="l09830"></a><span class="lineno"> 9830</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09831"></a><span class="lineno"> 9831</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewSacl, NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l09832"></a><span class="lineno"> 9832</span>&#160;        <a class="code" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)Field, GenericMapping );</div>
<div class="line"><a name="l09833"></a><span class="lineno"> 9833</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09834"></a><span class="lineno"> 9834</span>&#160;        <span class="keywordflow">if</span> (NewSaclSize &gt; NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>) {</div>
<div class="line"><a name="l09835"></a><span class="lineno"> 9835</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( Field + NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>, NewSaclSize - NewSacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09836"></a><span class="lineno"> 9836</span>&#160;        }</div>
<div class="line"><a name="l09837"></a><span class="lineno"> 9837</span>&#160;        Field += NewSaclSize;</div>
<div class="line"><a name="l09838"></a><span class="lineno"> 9838</span>&#160;    }</div>
<div class="line"><a name="l09839"></a><span class="lineno"> 9839</span>&#160;</div>
<div class="line"><a name="l09840"></a><span class="lineno"> 9840</span>&#160;</div>
<div class="line"><a name="l09841"></a><span class="lineno"> 9841</span>&#160;</div>
<div class="line"><a name="l09842"></a><span class="lineno"> 9842</span>&#160;</div>
<div class="line"><a name="l09843"></a><span class="lineno"> 9843</span>&#160;    <span class="keywordflow">if</span> ( (NewControlBits &amp; <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>) == 0 ) {</div>
<div class="line"><a name="l09844"></a><span class="lineno"> 9844</span>&#160;</div>
<div class="line"><a name="l09845"></a><span class="lineno"> 9845</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09846"></a><span class="lineno"> 9846</span>&#160;        <span class="comment">// Propagate the SE_SACL_DEFAULTED and SE_SACL_PRESENT</span></div>
<div class="line"><a name="l09847"></a><span class="lineno"> 9847</span>&#160;        <span class="comment">// bits from the old security descriptor into the new</span></div>
<div class="line"><a name="l09848"></a><span class="lineno"> 9848</span>&#160;        <span class="comment">// one.</span></div>
<div class="line"><a name="l09849"></a><span class="lineno"> 9849</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09850"></a><span class="lineno"> 9850</span>&#160;</div>
<div class="line"><a name="l09851"></a><span class="lineno"> 9851</span>&#160;        <a class="code" href="../../db/d2d/a02286.html#ac4869f77a683277682d7629dbc3d6198">RtlpPropagateControlBits</a>(</div>
<div class="line"><a name="l09852"></a><span class="lineno"> 9852</span>&#160;            NewDescriptor,</div>
<div class="line"><a name="l09853"></a><span class="lineno"> 9853</span>&#160;            *IObjectsSecurityDescriptor,</div>
<div class="line"><a name="l09854"></a><span class="lineno"> 9854</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e">SE_SACL_DEFAULTED</a> | SE_SACL_PRESENT | <a class="code" href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a> | <a class="code" href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a></div>
<div class="line"><a name="l09855"></a><span class="lineno"> 9855</span>&#160;            );</div>
<div class="line"><a name="l09856"></a><span class="lineno"> 9856</span>&#160;</div>
<div class="line"><a name="l09857"></a><span class="lineno"> 9857</span>&#160;    }</div>
<div class="line"><a name="l09858"></a><span class="lineno"> 9858</span>&#160;</div>
<div class="line"><a name="l09859"></a><span class="lineno"> 9859</span>&#160;</div>
<div class="line"><a name="l09860"></a><span class="lineno"> 9860</span>&#160;</div>
<div class="line"><a name="l09861"></a><span class="lineno"> 9861</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09862"></a><span class="lineno"> 9862</span>&#160;    <span class="comment">// Fill in Dacl field in new SD</span></div>
<div class="line"><a name="l09863"></a><span class="lineno"> 9863</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09864"></a><span class="lineno"> 9864</span>&#160;</div>
<div class="line"><a name="l09865"></a><span class="lineno"> 9865</span>&#160;    <span class="keywordflow">if</span> (NewDacl == <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09866"></a><span class="lineno"> 9866</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = 0;</div>
<div class="line"><a name="l09867"></a><span class="lineno"> 9867</span>&#160;</div>
<div class="line"><a name="l09868"></a><span class="lineno"> 9868</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09869"></a><span class="lineno"> 9869</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewDacl, NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a> );</div>
<div class="line"><a name="l09870"></a><span class="lineno"> 9870</span>&#160;        <a class="code" href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a>( (<a class="code" href="../../d7/dd4/a00013.html">PACL</a>)Field, GenericMapping );</div>
<div class="line"><a name="l09871"></a><span class="lineno"> 9871</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09872"></a><span class="lineno"> 9872</span>&#160;        <span class="keywordflow">if</span> (NewDaclSize &gt; NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>) {</div>
<div class="line"><a name="l09873"></a><span class="lineno"> 9873</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( Field + NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>, NewDaclSize - NewDacl-&gt;<a class="code" href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">AclSize</a>);</div>
<div class="line"><a name="l09874"></a><span class="lineno"> 9874</span>&#160;        }</div>
<div class="line"><a name="l09875"></a><span class="lineno"> 9875</span>&#160;        Field += NewDaclSize;</div>
<div class="line"><a name="l09876"></a><span class="lineno"> 9876</span>&#160;    }</div>
<div class="line"><a name="l09877"></a><span class="lineno"> 9877</span>&#160;</div>
<div class="line"><a name="l09878"></a><span class="lineno"> 9878</span>&#160;</div>
<div class="line"><a name="l09879"></a><span class="lineno"> 9879</span>&#160;    <span class="keywordflow">if</span> ( (NewControlBits &amp; <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>) == 0 ) {</div>
<div class="line"><a name="l09880"></a><span class="lineno"> 9880</span>&#160;</div>
<div class="line"><a name="l09881"></a><span class="lineno"> 9881</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09882"></a><span class="lineno"> 9882</span>&#160;        <span class="comment">// Propagate the SE_DACL_DEFAULTED and SE_DACL_PRESENT</span></div>
<div class="line"><a name="l09883"></a><span class="lineno"> 9883</span>&#160;        <span class="comment">// bits from the old security descriptor into the new</span></div>
<div class="line"><a name="l09884"></a><span class="lineno"> 9884</span>&#160;        <span class="comment">// one.</span></div>
<div class="line"><a name="l09885"></a><span class="lineno"> 9885</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09886"></a><span class="lineno"> 9886</span>&#160;</div>
<div class="line"><a name="l09887"></a><span class="lineno"> 9887</span>&#160;        <a class="code" href="../../db/d2d/a02286.html#ac4869f77a683277682d7629dbc3d6198">RtlpPropagateControlBits</a>(</div>
<div class="line"><a name="l09888"></a><span class="lineno"> 9888</span>&#160;            NewDescriptor,</div>
<div class="line"><a name="l09889"></a><span class="lineno"> 9889</span>&#160;            *IObjectsSecurityDescriptor,</div>
<div class="line"><a name="l09890"></a><span class="lineno"> 9890</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a> | SE_DACL_PRESENT | <a class="code" href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a> | <a class="code" href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a></div>
<div class="line"><a name="l09891"></a><span class="lineno"> 9891</span>&#160;            );</div>
<div class="line"><a name="l09892"></a><span class="lineno"> 9892</span>&#160;</div>
<div class="line"><a name="l09893"></a><span class="lineno"> 9893</span>&#160;    }</div>
<div class="line"><a name="l09894"></a><span class="lineno"> 9894</span>&#160;</div>
<div class="line"><a name="l09895"></a><span class="lineno"> 9895</span>&#160;<span class="comment">//         if new item {</span></div>
<div class="line"><a name="l09896"></a><span class="lineno"> 9896</span>&#160;<span class="comment">//             PRESENT=TRUE</span></div>
<div class="line"><a name="l09897"></a><span class="lineno"> 9897</span>&#160;<span class="comment">//             DEFAULTED=FALSE</span></div>
<div class="line"><a name="l09898"></a><span class="lineno"> 9898</span>&#160;<span class="comment">//             if (NULL) {</span></div>
<div class="line"><a name="l09899"></a><span class="lineno"> 9899</span>&#160;<span class="comment">//                 set new pointer to NULL</span></div>
<div class="line"><a name="l09900"></a><span class="lineno"> 9900</span>&#160;<span class="comment">//             } else {</span></div>
<div class="line"><a name="l09901"></a><span class="lineno"> 9901</span>&#160;<span class="comment">//                 copy into new SD</span></div>
<div class="line"><a name="l09902"></a><span class="lineno"> 9902</span>&#160;<span class="comment">//             }</span></div>
<div class="line"><a name="l09903"></a><span class="lineno"> 9903</span>&#160;<span class="comment">//         } else {</span></div>
<div class="line"><a name="l09904"></a><span class="lineno"> 9904</span>&#160;<span class="comment">//             copy PRESENT bit</span></div>
<div class="line"><a name="l09905"></a><span class="lineno"> 9905</span>&#160;<span class="comment">//             copy DEFAULTED bit</span></div>
<div class="line"><a name="l09906"></a><span class="lineno"> 9906</span>&#160;<span class="comment">//             if (NULL) {</span></div>
<div class="line"><a name="l09907"></a><span class="lineno"> 9907</span>&#160;<span class="comment">//                 set new pointer to NULL</span></div>
<div class="line"><a name="l09908"></a><span class="lineno"> 9908</span>&#160;<span class="comment">//             } else {</span></div>
<div class="line"><a name="l09909"></a><span class="lineno"> 9909</span>&#160;<span class="comment">//                 copy old one into new SD</span></div>
<div class="line"><a name="l09910"></a><span class="lineno"> 9910</span>&#160;<span class="comment">//             }</span></div>
<div class="line"><a name="l09911"></a><span class="lineno"> 9911</span>&#160;<span class="comment">//         }</span></div>
<div class="line"><a name="l09912"></a><span class="lineno"> 9912</span>&#160;</div>
<div class="line"><a name="l09913"></a><span class="lineno"> 9913</span>&#160;</div>
<div class="line"><a name="l09914"></a><span class="lineno"> 9914</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09915"></a><span class="lineno"> 9915</span>&#160;    <span class="comment">// Fill in Owner field in new SD</span></div>
<div class="line"><a name="l09916"></a><span class="lineno"> 9916</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09917"></a><span class="lineno"> 9917</span>&#160;</div>
<div class="line"><a name="l09918"></a><span class="lineno"> 9918</span>&#160;    <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewOwner, OwnerSize );</div>
<div class="line"><a name="l09919"></a><span class="lineno"> 9919</span>&#160;    <span class="keywordflow">if</span> (OwnerSize &lt; NewOwnerSize) {</div>
<div class="line"><a name="l09920"></a><span class="lineno"> 9920</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( Field + OwnerSize, NewOwnerSize - OwnerSize );</div>
<div class="line"><a name="l09921"></a><span class="lineno"> 9921</span>&#160;    }</div>
<div class="line"><a name="l09922"></a><span class="lineno"> 9922</span>&#160;    NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09923"></a><span class="lineno"> 9923</span>&#160;    Field += NewOwnerSize;</div>
<div class="line"><a name="l09924"></a><span class="lineno"> 9924</span>&#160;</div>
<div class="line"><a name="l09925"></a><span class="lineno"> 9925</span>&#160;    <span class="keywordflow">if</span> (!NewOwnerPresent) {</div>
<div class="line"><a name="l09926"></a><span class="lineno"> 9926</span>&#160;</div>
<div class="line"><a name="l09927"></a><span class="lineno"> 9927</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09928"></a><span class="lineno"> 9928</span>&#160;        <span class="comment">// Propagate the SE_OWNER_DEFAULTED bit from the old SD.</span></div>
<div class="line"><a name="l09929"></a><span class="lineno"> 9929</span>&#160;        <span class="comment">// If a new owner is being assigned, we want to leave</span></div>
<div class="line"><a name="l09930"></a><span class="lineno"> 9930</span>&#160;        <span class="comment">// SE_OWNER_DEFAULTED off, which means leave it alone.</span></div>
<div class="line"><a name="l09931"></a><span class="lineno"> 9931</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09932"></a><span class="lineno"> 9932</span>&#160;</div>
<div class="line"><a name="l09933"></a><span class="lineno"> 9933</span>&#160;        <a class="code" href="../../db/d2d/a02286.html#ac4869f77a683277682d7629dbc3d6198">RtlpPropagateControlBits</a>(</div>
<div class="line"><a name="l09934"></a><span class="lineno"> 9934</span>&#160;            NewDescriptor,</div>
<div class="line"><a name="l09935"></a><span class="lineno"> 9935</span>&#160;            *IObjectsSecurityDescriptor,</div>
<div class="line"><a name="l09936"></a><span class="lineno"> 9936</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a></div>
<div class="line"><a name="l09937"></a><span class="lineno"> 9937</span>&#160;            );</div>
<div class="line"><a name="l09938"></a><span class="lineno"> 9938</span>&#160;</div>
<div class="line"><a name="l09939"></a><span class="lineno"> 9939</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09940"></a><span class="lineno"> 9940</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( !<a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( NewDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a> ) );</div>
<div class="line"><a name="l09941"></a><span class="lineno"> 9941</span>&#160;    }</div>
<div class="line"><a name="l09942"></a><span class="lineno"> 9942</span>&#160;</div>
<div class="line"><a name="l09943"></a><span class="lineno"> 9943</span>&#160;</div>
<div class="line"><a name="l09944"></a><span class="lineno"> 9944</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09945"></a><span class="lineno"> 9945</span>&#160;    <span class="comment">// Fill in Group field in new SD</span></div>
<div class="line"><a name="l09946"></a><span class="lineno"> 9946</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09947"></a><span class="lineno"> 9947</span>&#160;</div>
<div class="line"><a name="l09948"></a><span class="lineno"> 9948</span>&#160;    <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><a name="l09949"></a><span class="lineno"> 9949</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a>( Field, NewGroup, GroupSize );</div>
<div class="line"><a name="l09950"></a><span class="lineno"> 9950</span>&#160;        <span class="keywordflow">if</span> (GroupSize &lt; NewGroupSize) {</div>
<div class="line"><a name="l09951"></a><span class="lineno"> 9951</span>&#160;            <a class="code" href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a>( Field + GroupSize, NewGroupSize - GroupSize);</div>
<div class="line"><a name="l09952"></a><span class="lineno"> 9952</span>&#160;        }</div>
<div class="line"><a name="l09953"></a><span class="lineno"> 9953</span>&#160;        NewDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a> = <a class="code" href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a>(Base,Field);</div>
<div class="line"><a name="l09954"></a><span class="lineno"> 9954</span>&#160;    }</div>
<div class="line"><a name="l09955"></a><span class="lineno"> 9955</span>&#160;</div>
<div class="line"><a name="l09956"></a><span class="lineno"> 9956</span>&#160;    <span class="keywordflow">if</span> (!NewGroupPresent) {</div>
<div class="line"><a name="l09957"></a><span class="lineno"> 9957</span>&#160;</div>
<div class="line"><a name="l09958"></a><span class="lineno"> 9958</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09959"></a><span class="lineno"> 9959</span>&#160;        <span class="comment">// Propagate the SE_GROUP_DEFAULTED bit from the old SD</span></div>
<div class="line"><a name="l09960"></a><span class="lineno"> 9960</span>&#160;        <span class="comment">// If a new owner is being assigned, we want to leave</span></div>
<div class="line"><a name="l09961"></a><span class="lineno"> 9961</span>&#160;        <span class="comment">// SE_GROUP_DEFAULTED off, which means leave it alone.</span></div>
<div class="line"><a name="l09962"></a><span class="lineno"> 9962</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l09963"></a><span class="lineno"> 9963</span>&#160;</div>
<div class="line"><a name="l09964"></a><span class="lineno"> 9964</span>&#160;        <a class="code" href="../../db/d2d/a02286.html#ac4869f77a683277682d7629dbc3d6198">RtlpPropagateControlBits</a>(</div>
<div class="line"><a name="l09965"></a><span class="lineno"> 9965</span>&#160;            NewDescriptor,</div>
<div class="line"><a name="l09966"></a><span class="lineno"> 9966</span>&#160;            *IObjectsSecurityDescriptor,</div>
<div class="line"><a name="l09967"></a><span class="lineno"> 9967</span>&#160;            <a class="code" href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a></div>
<div class="line"><a name="l09968"></a><span class="lineno"> 9968</span>&#160;            );</div>
<div class="line"><a name="l09969"></a><span class="lineno"> 9969</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l09970"></a><span class="lineno"> 9970</span>&#160;        <a class="code" href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a>( !<a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a>( NewDescriptor, <a class="code" href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a> ) );</div>
<div class="line"><a name="l09971"></a><span class="lineno"> 9971</span>&#160;</div>
<div class="line"><a name="l09972"></a><span class="lineno"> 9972</span>&#160;    }</div>
<div class="line"><a name="l09973"></a><span class="lineno"> 9973</span>&#160;</div>
<div class="line"><a name="l09974"></a><span class="lineno"> 9974</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09975"></a><span class="lineno"> 9975</span>&#160;    <span class="comment">// Free old descriptor</span></div>
<div class="line"><a name="l09976"></a><span class="lineno"> 9976</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l09977"></a><span class="lineno"> 9977</span>&#160;</div>
<div class="line"><a name="l09978"></a><span class="lineno"> 9978</span>&#160;    <span class="comment">// Kernel version doesn&#39;t free the old descriptor</span></div>
<div class="line"><a name="l09979"></a><span class="lineno"> 9979</span>&#160;</div>
<div class="line"><a name="l09980"></a><span class="lineno"> 9980</span>&#160;    *ObjectsSecurityDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a>)NewDescriptor;</div>
<div class="line"><a name="l09981"></a><span class="lineno"> 9981</span>&#160;    Status = <a class="code" href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;</div>
<div class="line"><a name="l09982"></a><span class="lineno"> 9982</span>&#160;</div>
<div class="line"><a name="l09983"></a><span class="lineno"> 9983</span>&#160;Cleanup:</div>
<div class="line"><a name="l09984"></a><span class="lineno"> 9984</span>&#160;    <span class="keywordflow">if</span> ( LocalDaclAllocated ) {</div>
<div class="line"><a name="l09985"></a><span class="lineno"> 9985</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( LocalDacl );</div>
<div class="line"><a name="l09986"></a><span class="lineno"> 9986</span>&#160;    }</div>
<div class="line"><a name="l09987"></a><span class="lineno"> 9987</span>&#160;    <span class="keywordflow">if</span> ( LocalSaclAllocated ) {</div>
<div class="line"><a name="l09988"></a><span class="lineno"> 9988</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( LocalSacl );</div>
<div class="line"><a name="l09989"></a><span class="lineno"> 9989</span>&#160;    }</div>
<div class="line"><a name="l09990"></a><span class="lineno"> 9990</span>&#160;    <span class="keywordflow">if</span> (ServerAclAllocated) {</div>
<div class="line"><a name="l09991"></a><span class="lineno"> 9991</span>&#160;        <a class="code" href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a>( ServerDacl );</div>
<div class="line"><a name="l09992"></a><span class="lineno"> 9992</span>&#160;    }</div>
<div class="line"><a name="l09993"></a><span class="lineno"> 9993</span>&#160;</div>
<div class="line"><a name="l09994"></a><span class="lineno"> 9994</span>&#160;    <span class="keywordflow">return</span>( Status );</div>
<div class="line"><a name="l09995"></a><span class="lineno"> 9995</span>&#160;}</div>
<div class="line"><a name="l09996"></a><span class="lineno"> 9996</span>&#160;</div>
<div class="line"><a name="l09997"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0"> 9997</a></span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> <a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (</div>
<div class="line"><a name="l09998"></a><span class="lineno"> 9998</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   Offset,</div>
<div class="line"><a name="l09999"></a><span class="lineno"> 9999</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   <a class="code" href="../../d8/d51/a02244.html#a1eba21559f17793c695f34f7e4787604">Length</a>,</div>
<div class="line"><a name="l10000"></a><span class="lineno">10000</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>   MinLength,</div>
<div class="line"><a name="l10001"></a><span class="lineno">10001</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a> MaxLength</div>
<div class="line"><a name="l10002"></a><span class="lineno">10002</span>&#160;    )</div>
<div class="line"><a name="l10003"></a><span class="lineno">10003</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10004"></a><span class="lineno">10004</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10005"></a><span class="lineno">10005</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10006"></a><span class="lineno">10006</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10007"></a><span class="lineno">10007</span>&#160;<span class="comment">    This procedure validates offsets within a SecurityDescriptor.</span></div>
<div class="line"><a name="l10008"></a><span class="lineno">10008</span>&#160;<span class="comment">    It checks that the structure can have the minimum length,</span></div>
<div class="line"><a name="l10009"></a><span class="lineno">10009</span>&#160;<span class="comment">    not overlap with the fixed header and returns the maximum size</span></div>
<div class="line"><a name="l10010"></a><span class="lineno">10010</span>&#160;<span class="comment">    of the item and longword alignment.</span></div>
<div class="line"><a name="l10011"></a><span class="lineno">10011</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10012"></a><span class="lineno">10012</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10013"></a><span class="lineno">10013</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10014"></a><span class="lineno">10014</span>&#160;<span class="comment">    Offset - Offset from start of SD of structure to validate</span></div>
<div class="line"><a name="l10015"></a><span class="lineno">10015</span>&#160;<span class="comment">    Length - Total size of SD</span></div>
<div class="line"><a name="l10016"></a><span class="lineno">10016</span>&#160;<span class="comment">    MinLength - Minimum size this structure can be</span></div>
<div class="line"><a name="l10017"></a><span class="lineno">10017</span>&#160;<span class="comment">    MaxLength - Returns the maximum length this item can be given by</span></div>
<div class="line"><a name="l10018"></a><span class="lineno">10018</span>&#160;<span class="comment">                the enclosing structure.</span></div>
<div class="line"><a name="l10019"></a><span class="lineno">10019</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10020"></a><span class="lineno">10020</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l10021"></a><span class="lineno">10021</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10022"></a><span class="lineno">10022</span>&#160;<span class="comment">    BOOLEAN - TRUE if the item is valid</span></div>
<div class="line"><a name="l10023"></a><span class="lineno">10023</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10024"></a><span class="lineno">10024</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10025"></a><span class="lineno">10025</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10026"></a><span class="lineno">10026</span>&#160;</div>
<div class="line"><a name="l10027"></a><span class="lineno">10027</span>&#160;{</div>
<div class="line"><a name="l10028"></a><span class="lineno">10028</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Left;</div>
<div class="line"><a name="l10029"></a><span class="lineno">10029</span>&#160;</div>
<div class="line"><a name="l10030"></a><span class="lineno">10030</span>&#160;    *MaxLength = 0;</div>
<div class="line"><a name="l10031"></a><span class="lineno">10031</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10032"></a><span class="lineno">10032</span>&#160;    <span class="comment">// Don&#39;t allow overlap with header just in case caller modifies control bits etc</span></div>
<div class="line"><a name="l10033"></a><span class="lineno">10033</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10034"></a><span class="lineno">10034</span>&#160;    <span class="keywordflow">if</span> (Offset &lt; <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>)) {</div>
<div class="line"><a name="l10035"></a><span class="lineno">10035</span>&#160;       <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10036"></a><span class="lineno">10036</span>&#160;    }</div>
<div class="line"><a name="l10037"></a><span class="lineno">10037</span>&#160;</div>
<div class="line"><a name="l10038"></a><span class="lineno">10038</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10039"></a><span class="lineno">10039</span>&#160;    <span class="comment">// Don&#39;t allow offsets beyond the end of the buffer</span></div>
<div class="line"><a name="l10040"></a><span class="lineno">10040</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10041"></a><span class="lineno">10041</span>&#160;    <span class="keywordflow">if</span> (Offset &gt;= Length) {</div>
<div class="line"><a name="l10042"></a><span class="lineno">10042</span>&#160;       <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10043"></a><span class="lineno">10043</span>&#160;    }</div>
<div class="line"><a name="l10044"></a><span class="lineno">10044</span>&#160;</div>
<div class="line"><a name="l10045"></a><span class="lineno">10045</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10046"></a><span class="lineno">10046</span>&#160;    <span class="comment">// Calculate maximum size of segment and check its limits</span></div>
<div class="line"><a name="l10047"></a><span class="lineno">10047</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10048"></a><span class="lineno">10048</span>&#160;    Left = Length - Offset;</div>
<div class="line"><a name="l10049"></a><span class="lineno">10049</span>&#160;</div>
<div class="line"><a name="l10050"></a><span class="lineno">10050</span>&#160;    <span class="keywordflow">if</span> (Left &lt; MinLength) {</div>
<div class="line"><a name="l10051"></a><span class="lineno">10051</span>&#160;       <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10052"></a><span class="lineno">10052</span>&#160;    }</div>
<div class="line"><a name="l10053"></a><span class="lineno">10053</span>&#160;</div>
<div class="line"><a name="l10054"></a><span class="lineno">10054</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10055"></a><span class="lineno">10055</span>&#160;    <span class="comment">// Reject unaligned offsets</span></div>
<div class="line"><a name="l10056"></a><span class="lineno">10056</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10057"></a><span class="lineno">10057</span>&#160;    <span class="keywordflow">if</span> (Offset &amp; (<span class="keyword">sizeof</span> (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>) - 1)) {</div>
<div class="line"><a name="l10058"></a><span class="lineno">10058</span>&#160;       <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10059"></a><span class="lineno">10059</span>&#160;    }</div>
<div class="line"><a name="l10060"></a><span class="lineno">10060</span>&#160;    *MaxLength = Left;</div>
<div class="line"><a name="l10061"></a><span class="lineno">10061</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l10062"></a><span class="lineno">10062</span>&#160;}</div>
<div class="line"><a name="l10063"></a><span class="lineno">10063</span>&#160;</div>
<div class="line"><a name="l10064"></a><span class="lineno">10064</span>&#160;</div>
<div class="line"><a name="l10065"></a><span class="lineno">10065</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l10066"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#aa7894911d24d33ceed9f7b781bbe81ca">10066</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#aa7894911d24d33ceed9f7b781bbe81ca">RtlValidRelativeSecurityDescriptor</a> (</div>
<div class="line"><a name="l10067"></a><span class="lineno">10067</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptorInput,</div>
<div class="line"><a name="l10068"></a><span class="lineno">10068</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SecurityDescriptorLength,</div>
<div class="line"><a name="l10069"></a><span class="lineno">10069</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a923cbf88fdb4b0381d8e3c837656c0b2">SECURITY_INFORMATION</a> RequiredInformation</div>
<div class="line"><a name="l10070"></a><span class="lineno">10070</span>&#160;    )</div>
<div class="line"><a name="l10071"></a><span class="lineno">10071</span>&#160;</div>
<div class="line"><a name="l10072"></a><span class="lineno">10072</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10073"></a><span class="lineno">10073</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10074"></a><span class="lineno">10074</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10075"></a><span class="lineno">10075</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10076"></a><span class="lineno">10076</span>&#160;<span class="comment">    This procedure validates a SecurityDescriptor&#39;s structure</span></div>
<div class="line"><a name="l10077"></a><span class="lineno">10077</span>&#160;<span class="comment">    contained within a flat buffer.  This involves validating</span></div>
<div class="line"><a name="l10078"></a><span class="lineno">10078</span>&#160;<span class="comment">    the revision levels of each component of the security</span></div>
<div class="line"><a name="l10079"></a><span class="lineno">10079</span>&#160;<span class="comment">    descriptor.</span></div>
<div class="line"><a name="l10080"></a><span class="lineno">10080</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10081"></a><span class="lineno">10081</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10082"></a><span class="lineno">10082</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10083"></a><span class="lineno">10083</span>&#160;<span class="comment">    SecurityDescriptor - Pointer to the SECURITY_DESCRIPTOR structure</span></div>
<div class="line"><a name="l10084"></a><span class="lineno">10084</span>&#160;<span class="comment">        to validate.</span></div>
<div class="line"><a name="l10085"></a><span class="lineno">10085</span>&#160;<span class="comment">    SecurityDescriptorLength - Size of flat buffer containing the security</span></div>
<div class="line"><a name="l10086"></a><span class="lineno">10086</span>&#160;<span class="comment">        descriptor.</span></div>
<div class="line"><a name="l10087"></a><span class="lineno">10087</span>&#160;<span class="comment">    RequiredInformation - Which SD components must be present to be valid.</span></div>
<div class="line"><a name="l10088"></a><span class="lineno">10088</span>&#160;<span class="comment">        OWNER_SECURITY_INFORMATION etc as a bit mask.</span></div>
<div class="line"><a name="l10089"></a><span class="lineno">10089</span>&#160;<span class="comment">        OWNER_SECURITY_INFORMATION - There must be a valid owner SID</span></div>
<div class="line"><a name="l10090"></a><span class="lineno">10090</span>&#160;<span class="comment">        GROUP_SECURITY_INFORMATION - There must be a valid group SID</span></div>
<div class="line"><a name="l10091"></a><span class="lineno">10091</span>&#160;<span class="comment">        DACL_SECURITY_INFORMATION - Ignored</span></div>
<div class="line"><a name="l10092"></a><span class="lineno">10092</span>&#160;<span class="comment">        SACL_SECURITY_INFORMATION - Ignored</span></div>
<div class="line"><a name="l10093"></a><span class="lineno">10093</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10094"></a><span class="lineno">10094</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l10095"></a><span class="lineno">10095</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10096"></a><span class="lineno">10096</span>&#160;<span class="comment">    BOOLEAN - TRUE if the structure of SecurityDescriptor is valid.</span></div>
<div class="line"><a name="l10097"></a><span class="lineno">10097</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10098"></a><span class="lineno">10098</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10099"></a><span class="lineno">10099</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10100"></a><span class="lineno">10100</span>&#160;</div>
<div class="line"><a name="l10101"></a><span class="lineno">10101</span>&#160;{</div>
<div class="line"><a name="l10102"></a><span class="lineno">10102</span>&#160;    <a class="code" href="../../d6/d91/a01587.html">PISECURITY_DESCRIPTOR_RELATIVE</a> SecurityDescriptor;</div>
<div class="line"><a name="l10103"></a><span class="lineno">10103</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> OwnerSid;</div>
<div class="line"><a name="l10104"></a><span class="lineno">10104</span>&#160;    <a class="code" href="../../de/df9/a01624.html">PISID</a> GroupSid;</div>
<div class="line"><a name="l10105"></a><span class="lineno">10105</span>&#160;    <a class="code" href="../../df/d86/a00012.html">PACE_HEADER</a> Ace;</div>
<div class="line"><a name="l10106"></a><span class="lineno">10106</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Dacl;</div>
<div class="line"><a name="l10107"></a><span class="lineno">10107</span>&#160;    <a class="code" href="../../d7/dd4/a00013.html">PACL</a> Sacl;</div>
<div class="line"><a name="l10108"></a><span class="lineno">10108</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> MaxOwnerSidLength;</div>
<div class="line"><a name="l10109"></a><span class="lineno">10109</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> MaxGroupSidLength;</div>
<div class="line"><a name="l10110"></a><span class="lineno">10110</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> MaxDaclLength;</div>
<div class="line"><a name="l10111"></a><span class="lineno">10111</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> MaxSaclLength;</div>
<div class="line"><a name="l10112"></a><span class="lineno">10112</span>&#160;</div>
<div class="line"><a name="l10113"></a><span class="lineno">10113</span>&#160;    <span class="keywordflow">if</span> (SecurityDescriptorLength &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d91/a01587.html">SECURITY_DESCRIPTOR_RELATIVE</a>)) {</div>
<div class="line"><a name="l10114"></a><span class="lineno">10114</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10115"></a><span class="lineno">10115</span>&#160;    }</div>
<div class="line"><a name="l10116"></a><span class="lineno">10116</span>&#160;</div>
<div class="line"><a name="l10117"></a><span class="lineno">10117</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10118"></a><span class="lineno">10118</span>&#160;    <span class="comment">// Check the revision information.</span></div>
<div class="line"><a name="l10119"></a><span class="lineno">10119</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10120"></a><span class="lineno">10120</span>&#160;</div>
<div class="line"><a name="l10121"></a><span class="lineno">10121</span>&#160;    <span class="keywordflow">if</span> (((<a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a>) SecurityDescriptorInput)-&gt;Revision !=</div>
<div class="line"><a name="l10122"></a><span class="lineno">10122</span>&#160;             <a class="code" href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a>) {</div>
<div class="line"><a name="l10123"></a><span class="lineno">10123</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10124"></a><span class="lineno">10124</span>&#160;    }</div>
<div class="line"><a name="l10125"></a><span class="lineno">10125</span>&#160;</div>
<div class="line"><a name="l10126"></a><span class="lineno">10126</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10127"></a><span class="lineno">10127</span>&#160;    <span class="comment">// Make sure the passed SecurityDescriptor is in self-relative form</span></div>
<div class="line"><a name="l10128"></a><span class="lineno">10128</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10129"></a><span class="lineno">10129</span>&#160;</div>
<div class="line"><a name="l10130"></a><span class="lineno">10130</span>&#160;    <span class="keywordflow">if</span> (!(((<a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a>) SecurityDescriptorInput)-&gt;Control &amp; <a class="code" href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a>)) {</div>
<div class="line"><a name="l10131"></a><span class="lineno">10131</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10132"></a><span class="lineno">10132</span>&#160;    }</div>
<div class="line"><a name="l10133"></a><span class="lineno">10133</span>&#160;</div>
<div class="line"><a name="l10134"></a><span class="lineno">10134</span>&#160;    SecurityDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a5e200ddef24f6ab53b4ce054b6069eb0">PISECURITY_DESCRIPTOR_RELATIVE</a>) SecurityDescriptorInput;</div>
<div class="line"><a name="l10135"></a><span class="lineno">10135</span>&#160;</div>
<div class="line"><a name="l10136"></a><span class="lineno">10136</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10137"></a><span class="lineno">10137</span>&#160;    <span class="comment">// Validate the owner if it&#39;s there and see if its allowed to be missing</span></div>
<div class="line"><a name="l10138"></a><span class="lineno">10138</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10139"></a><span class="lineno">10139</span>&#160;    <span class="keywordflow">if</span> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a> == 0) {</div>
<div class="line"><a name="l10140"></a><span class="lineno">10140</span>&#160;        <span class="keywordflow">if</span> (RequiredInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#a5befedca477346da731bee5367de1921">OWNER_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l10141"></a><span class="lineno">10141</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10142"></a><span class="lineno">10142</span>&#160;        }</div>
<div class="line"><a name="l10143"></a><span class="lineno">10143</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l10144"></a><span class="lineno">10144</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a>,</div>
<div class="line"><a name="l10145"></a><span class="lineno">10145</span>&#160;                                          SecurityDescriptorLength,</div>
<div class="line"><a name="l10146"></a><span class="lineno">10146</span>&#160;                                          sizeof (<a class="code" href="../../de/df9/a01624.html">SID</a>),</div>
<div class="line"><a name="l10147"></a><span class="lineno">10147</span>&#160;                                          &amp;MaxOwnerSidLength)) {</div>
<div class="line"><a name="l10148"></a><span class="lineno">10148</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10149"></a><span class="lineno">10149</span>&#160;        }</div>
<div class="line"><a name="l10150"></a><span class="lineno">10150</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10151"></a><span class="lineno">10151</span>&#160;        <span class="comment">// It is safe to reference the owner&#39;s SubAuthorityCount, compute the</span></div>
<div class="line"><a name="l10152"></a><span class="lineno">10152</span>&#160;        <span class="comment">// expected length of the SID</span></div>
<div class="line"><a name="l10153"></a><span class="lineno">10153</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10154"></a><span class="lineno">10154</span>&#160;</div>
<div class="line"><a name="l10155"></a><span class="lineno">10155</span>&#160;        OwnerSid = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)<a class="code" href="../../de/dc3/a02256.html#af2f5618e7817dc88a1bb7ab4c55a59a0">RtlOffsetToPointer</a> (SecurityDescriptor,</div>
<div class="line"><a name="l10156"></a><span class="lineno">10156</span>&#160;                                             SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">Owner</a>);</div>
<div class="line"><a name="l10157"></a><span class="lineno">10157</span>&#160;</div>
<div class="line"><a name="l10158"></a><span class="lineno">10158</span>&#160;        <span class="keywordflow">if</span> (OwnerSid-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#ae27969fb295feb91d5951b723325b339">SID_REVISION</a>) {</div>
<div class="line"><a name="l10159"></a><span class="lineno">10159</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10160"></a><span class="lineno">10160</span>&#160;        }</div>
<div class="line"><a name="l10161"></a><span class="lineno">10161</span>&#160;</div>
<div class="line"><a name="l10162"></a><span class="lineno">10162</span>&#160;        <span class="keywordflow">if</span> (OwnerSid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> &gt; <a class="code" href="../../d3/d3a/a02259.html#ad0a23f15b31cfde28fd99cd0cee99d20">SID_MAX_SUB_AUTHORITIES</a>) {</div>
<div class="line"><a name="l10163"></a><span class="lineno">10163</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10164"></a><span class="lineno">10164</span>&#160;        }</div>
<div class="line"><a name="l10165"></a><span class="lineno">10165</span>&#160;</div>
<div class="line"><a name="l10166"></a><span class="lineno">10166</span>&#160;        <span class="keywordflow">if</span> (MaxOwnerSidLength &lt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>) <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a> (OwnerSid)) {</div>
<div class="line"><a name="l10167"></a><span class="lineno">10167</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10168"></a><span class="lineno">10168</span>&#160;        }</div>
<div class="line"><a name="l10169"></a><span class="lineno">10169</span>&#160;</div>
<div class="line"><a name="l10170"></a><span class="lineno">10170</span>&#160;    }</div>
<div class="line"><a name="l10171"></a><span class="lineno">10171</span>&#160;</div>
<div class="line"><a name="l10172"></a><span class="lineno">10172</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10173"></a><span class="lineno">10173</span>&#160;    <span class="comment">// The owner appears to be a structurally valid SID that lies within</span></div>
<div class="line"><a name="l10174"></a><span class="lineno">10174</span>&#160;    <span class="comment">// the bounds of the security descriptor.  Do the same for the Group</span></div>
<div class="line"><a name="l10175"></a><span class="lineno">10175</span>&#160;    <span class="comment">// if there is one.</span></div>
<div class="line"><a name="l10176"></a><span class="lineno">10176</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10177"></a><span class="lineno">10177</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10178"></a><span class="lineno">10178</span>&#160;    <span class="comment">// Validate the group if it&#39;s there and see if its allowed to be missing</span></div>
<div class="line"><a name="l10179"></a><span class="lineno">10179</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10180"></a><span class="lineno">10180</span>&#160;    <span class="keywordflow">if</span> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a> == 0) {</div>
<div class="line"><a name="l10181"></a><span class="lineno">10181</span>&#160;        <span class="keywordflow">if</span> (RequiredInformation &amp; <a class="code" href="../../d3/d3a/a02259.html#ab1cf9e99656615972a3407e5d72574b5">GROUP_SECURITY_INFORMATION</a>) {</div>
<div class="line"><a name="l10182"></a><span class="lineno">10182</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10183"></a><span class="lineno">10183</span>&#160;        }</div>
<div class="line"><a name="l10184"></a><span class="lineno">10184</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l10185"></a><span class="lineno">10185</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a>,</div>
<div class="line"><a name="l10186"></a><span class="lineno">10186</span>&#160;                                          SecurityDescriptorLength,</div>
<div class="line"><a name="l10187"></a><span class="lineno">10187</span>&#160;                                          sizeof (<a class="code" href="../../de/df9/a01624.html">SID</a>),</div>
<div class="line"><a name="l10188"></a><span class="lineno">10188</span>&#160;                                          &amp;MaxGroupSidLength)) {</div>
<div class="line"><a name="l10189"></a><span class="lineno">10189</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10190"></a><span class="lineno">10190</span>&#160;        }</div>
<div class="line"><a name="l10191"></a><span class="lineno">10191</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10192"></a><span class="lineno">10192</span>&#160;        <span class="comment">// It is safe to reference the group&#39;s SubAuthorityCount, compute the</span></div>
<div class="line"><a name="l10193"></a><span class="lineno">10193</span>&#160;        <span class="comment">// expected length of the SID</span></div>
<div class="line"><a name="l10194"></a><span class="lineno">10194</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10195"></a><span class="lineno">10195</span>&#160;</div>
<div class="line"><a name="l10196"></a><span class="lineno">10196</span>&#160;        GroupSid = (<a class="code" href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a>)<a class="code" href="../../de/dc3/a02256.html#af2f5618e7817dc88a1bb7ab4c55a59a0">RtlOffsetToPointer</a> (SecurityDescriptor,</div>
<div class="line"><a name="l10197"></a><span class="lineno">10197</span>&#160;                                             SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">Group</a>);</div>
<div class="line"><a name="l10198"></a><span class="lineno">10198</span>&#160;</div>
<div class="line"><a name="l10199"></a><span class="lineno">10199</span>&#160;        <span class="keywordflow">if</span> (GroupSid-&gt;<a class="code" href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">Revision</a> != <a class="code" href="../../d3/d3a/a02259.html#ae27969fb295feb91d5951b723325b339">SID_REVISION</a>) {</div>
<div class="line"><a name="l10200"></a><span class="lineno">10200</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10201"></a><span class="lineno">10201</span>&#160;        }</div>
<div class="line"><a name="l10202"></a><span class="lineno">10202</span>&#160;</div>
<div class="line"><a name="l10203"></a><span class="lineno">10203</span>&#160;        <span class="keywordflow">if</span> (GroupSid-&gt;<a class="code" href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">SubAuthorityCount</a> &gt; <a class="code" href="../../d3/d3a/a02259.html#ad0a23f15b31cfde28fd99cd0cee99d20">SID_MAX_SUB_AUTHORITIES</a>) {</div>
<div class="line"><a name="l10204"></a><span class="lineno">10204</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10205"></a><span class="lineno">10205</span>&#160;        }</div>
<div class="line"><a name="l10206"></a><span class="lineno">10206</span>&#160;</div>
<div class="line"><a name="l10207"></a><span class="lineno">10207</span>&#160;        <span class="keywordflow">if</span> (MaxGroupSidLength &lt; (<a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>) <a class="code" href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a> (GroupSid)) {</div>
<div class="line"><a name="l10208"></a><span class="lineno">10208</span>&#160;             <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10209"></a><span class="lineno">10209</span>&#160;        }</div>
<div class="line"><a name="l10210"></a><span class="lineno">10210</span>&#160;</div>
<div class="line"><a name="l10211"></a><span class="lineno">10211</span>&#160;    }</div>
<div class="line"><a name="l10212"></a><span class="lineno">10212</span>&#160;</div>
<div class="line"><a name="l10213"></a><span class="lineno">10213</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10214"></a><span class="lineno">10214</span>&#160;    <span class="comment">// Validate the DACL if it&#39;s there and check if its allowed to be missing.</span></div>
<div class="line"><a name="l10215"></a><span class="lineno">10215</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10216"></a><span class="lineno">10216</span>&#160;</div>
<div class="line"><a name="l10217"></a><span class="lineno">10217</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a> (SecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a>)) {</div>
<div class="line"><a name="l10218"></a><span class="lineno">10218</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l10219"></a><span class="lineno">10219</span>&#160;<span class="comment">// Some code does this kind of thing:</span></div>
<div class="line"><a name="l10220"></a><span class="lineno">10220</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l10221"></a><span class="lineno">10221</span>&#160;<span class="comment">// InitializeSecurityDescriptor (&amp;sd, SECURITY_DESCRIPTOR_REVISION);</span></div>
<div class="line"><a name="l10222"></a><span class="lineno">10222</span>&#160;<span class="comment">// RegSetKeySecurity(hKey, DACL_SECURITY_INFORMATION, &amp;sd) )</span></div>
<div class="line"><a name="l10223"></a><span class="lineno">10223</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l10224"></a><span class="lineno">10224</span>&#160;<span class="comment">// With the current system this works the same as passing in a NULL DACL but it looks</span></div>
<div class="line"><a name="l10225"></a><span class="lineno">10225</span>&#160;<span class="comment">// almost by accident</span></div>
<div class="line"><a name="l10226"></a><span class="lineno">10226</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l10227"></a><span class="lineno">10227</span>&#160;<span class="comment">//        if (RequiredInformation &amp; DACL_SECURITY_INFORMATION) {</span></div>
<div class="line"><a name="l10228"></a><span class="lineno">10228</span>&#160;<span class="comment">//            return FALSE;</span></div>
<div class="line"><a name="l10229"></a><span class="lineno">10229</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l10230"></a><span class="lineno">10230</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a>) {</div>
<div class="line"><a name="l10231"></a><span class="lineno">10231</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a>,</div>
<div class="line"><a name="l10232"></a><span class="lineno">10232</span>&#160;                                          SecurityDescriptorLength,</div>
<div class="line"><a name="l10233"></a><span class="lineno">10233</span>&#160;                                          sizeof (<a class="code" href="../../d7/dd4/a00013.html">ACL</a>),</div>
<div class="line"><a name="l10234"></a><span class="lineno">10234</span>&#160;                                          &amp;MaxDaclLength)) {</div>
<div class="line"><a name="l10235"></a><span class="lineno">10235</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10236"></a><span class="lineno">10236</span>&#160;        }</div>
<div class="line"><a name="l10237"></a><span class="lineno">10237</span>&#160;</div>
<div class="line"><a name="l10238"></a><span class="lineno">10238</span>&#160;        Dacl = (<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>) <a class="code" href="../../de/dc3/a02256.html#af2f5618e7817dc88a1bb7ab4c55a59a0">RtlOffsetToPointer</a> (SecurityDescriptor,</div>
<div class="line"><a name="l10239"></a><span class="lineno">10239</span>&#160;                                          SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">Dacl</a>);</div>
<div class="line"><a name="l10240"></a><span class="lineno">10240</span>&#160;</div>
<div class="line"><a name="l10241"></a><span class="lineno">10241</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10242"></a><span class="lineno">10242</span>&#160;        <span class="comment">// Make sure the DACL length fits within the bounds of the security descriptor.</span></div>
<div class="line"><a name="l10243"></a><span class="lineno">10243</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10244"></a><span class="lineno">10244</span>&#160;        <span class="keywordflow">if</span> (MaxDaclLength &lt; Dacl-&gt;AclSize) {</div>
<div class="line"><a name="l10245"></a><span class="lineno">10245</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10246"></a><span class="lineno">10246</span>&#160;        }</div>
<div class="line"><a name="l10247"></a><span class="lineno">10247</span>&#160;</div>
<div class="line"><a name="l10248"></a><span class="lineno">10248</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10249"></a><span class="lineno">10249</span>&#160;        <span class="comment">// Make sure the ACL is structurally valid.</span></div>
<div class="line"><a name="l10250"></a><span class="lineno">10250</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10251"></a><span class="lineno">10251</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a> (Dacl)) {</div>
<div class="line"><a name="l10252"></a><span class="lineno">10252</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10253"></a><span class="lineno">10253</span>&#160;        }</div>
<div class="line"><a name="l10254"></a><span class="lineno">10254</span>&#160;    }</div>
<div class="line"><a name="l10255"></a><span class="lineno">10255</span>&#160;</div>
<div class="line"><a name="l10256"></a><span class="lineno">10256</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10257"></a><span class="lineno">10257</span>&#160;    <span class="comment">// Validate the SACL if it&#39;s there and check if its allowed to be missing.</span></div>
<div class="line"><a name="l10258"></a><span class="lineno">10258</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l10259"></a><span class="lineno">10259</span>&#160;</div>
<div class="line"><a name="l10260"></a><span class="lineno">10260</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a> (SecurityDescriptor, <a class="code" href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a>)) {</div>
<div class="line"><a name="l10261"></a><span class="lineno">10261</span>&#160;<span class="comment">//        if (RequiredInformation &amp; SACL_SECURITY_INFORMATION) {</span></div>
<div class="line"><a name="l10262"></a><span class="lineno">10262</span>&#160;<span class="comment">//            return FALSE;</span></div>
<div class="line"><a name="l10263"></a><span class="lineno">10263</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l10264"></a><span class="lineno">10264</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a>) {</div>
<div class="line"><a name="l10265"></a><span class="lineno">10265</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a>,</div>
<div class="line"><a name="l10266"></a><span class="lineno">10266</span>&#160;                                          SecurityDescriptorLength,</div>
<div class="line"><a name="l10267"></a><span class="lineno">10267</span>&#160;                                          sizeof (<a class="code" href="../../d7/dd4/a00013.html">ACL</a>),</div>
<div class="line"><a name="l10268"></a><span class="lineno">10268</span>&#160;                                          &amp;MaxSaclLength)) {</div>
<div class="line"><a name="l10269"></a><span class="lineno">10269</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10270"></a><span class="lineno">10270</span>&#160;        }</div>
<div class="line"><a name="l10271"></a><span class="lineno">10271</span>&#160;</div>
<div class="line"><a name="l10272"></a><span class="lineno">10272</span>&#160;        Sacl = (<a class="code" href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a>) <a class="code" href="../../de/dc3/a02256.html#af2f5618e7817dc88a1bb7ab4c55a59a0">RtlOffsetToPointer</a> (SecurityDescriptor,</div>
<div class="line"><a name="l10273"></a><span class="lineno">10273</span>&#160;                                          SecurityDescriptor-&gt;<a class="code" href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">Sacl</a>);</div>
<div class="line"><a name="l10274"></a><span class="lineno">10274</span>&#160;</div>
<div class="line"><a name="l10275"></a><span class="lineno">10275</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10276"></a><span class="lineno">10276</span>&#160;        <span class="comment">// Make sure the SACL length fits within the bounds of the security descriptor.</span></div>
<div class="line"><a name="l10277"></a><span class="lineno">10277</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10278"></a><span class="lineno">10278</span>&#160;</div>
<div class="line"><a name="l10279"></a><span class="lineno">10279</span>&#160;        <span class="keywordflow">if</span> (MaxSaclLength &lt; Sacl-&gt;AclSize) {</div>
<div class="line"><a name="l10280"></a><span class="lineno">10280</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10281"></a><span class="lineno">10281</span>&#160;        }</div>
<div class="line"><a name="l10282"></a><span class="lineno">10282</span>&#160;</div>
<div class="line"><a name="l10283"></a><span class="lineno">10283</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10284"></a><span class="lineno">10284</span>&#160;        <span class="comment">// Make sure the ACL is structurally valid.</span></div>
<div class="line"><a name="l10285"></a><span class="lineno">10285</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l10286"></a><span class="lineno">10286</span>&#160;</div>
<div class="line"><a name="l10287"></a><span class="lineno">10287</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a> (Sacl)) {</div>
<div class="line"><a name="l10288"></a><span class="lineno">10288</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10289"></a><span class="lineno">10289</span>&#160;        }</div>
<div class="line"><a name="l10290"></a><span class="lineno">10290</span>&#160;    }</div>
<div class="line"><a name="l10291"></a><span class="lineno">10291</span>&#160;</div>
<div class="line"><a name="l10292"></a><span class="lineno">10292</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l10293"></a><span class="lineno">10293</span>&#160;}</div>
<div class="line"><a name="l10294"></a><span class="lineno">10294</span>&#160;</div>
<div class="line"><a name="l10295"></a><span class="lineno">10295</span>&#160;</div>
<div class="line"><a name="l10296"></a><span class="lineno">10296</span>&#160;</div>
<div class="line"><a name="l10297"></a><span class="lineno">10297</span>&#160;</div>
<div class="line"><a name="l10298"></a><span class="lineno">10298</span>&#160;</div>
<div class="line"><a name="l10299"></a><span class="lineno">10299</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l10300"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a0a555b854f73125cde10bd1e12254f4c">10300</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a0a555b854f73125cde10bd1e12254f4c">RtlGetSecurityDescriptorRMControl</a>(</div>
<div class="line"><a name="l10301"></a><span class="lineno">10301</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l10302"></a><span class="lineno">10302</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> RMControl</div>
<div class="line"><a name="l10303"></a><span class="lineno">10303</span>&#160;    )</div>
<div class="line"><a name="l10304"></a><span class="lineno">10304</span>&#160;</div>
<div class="line"><a name="l10305"></a><span class="lineno">10305</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10306"></a><span class="lineno">10306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10307"></a><span class="lineno">10307</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10308"></a><span class="lineno">10308</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10309"></a><span class="lineno">10309</span>&#160;<span class="comment">    This procedure returns the RM Control flags from a SecurityDescriptor if</span></div>
<div class="line"><a name="l10310"></a><span class="lineno">10310</span>&#160;<span class="comment">    SE_RM_CONTROL_VALID flags is present in the control field.</span></div>
<div class="line"><a name="l10311"></a><span class="lineno">10311</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10312"></a><span class="lineno">10312</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10313"></a><span class="lineno">10313</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10314"></a><span class="lineno">10314</span>&#160;<span class="comment">    SecurityDescriptor - Pointer to the SECURITY_DESCRIPTOR structure</span></div>
<div class="line"><a name="l10315"></a><span class="lineno">10315</span>&#160;<span class="comment">    RMControl          - Returns the flags in the SecurityDescriptor if</span></div>
<div class="line"><a name="l10316"></a><span class="lineno">10316</span>&#160;<span class="comment">                         SE_RM_CONTROL_VALID is set in the control bits of the</span></div>
<div class="line"><a name="l10317"></a><span class="lineno">10317</span>&#160;<span class="comment">                         SecurityDescriptor.</span></div>
<div class="line"><a name="l10318"></a><span class="lineno">10318</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10319"></a><span class="lineno">10319</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10320"></a><span class="lineno">10320</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l10321"></a><span class="lineno">10321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10322"></a><span class="lineno">10322</span>&#160;<span class="comment">    BOOLEAN - TRUE if SE_RM_CONTROL_VALID is set in the Control bits of the</span></div>
<div class="line"><a name="l10323"></a><span class="lineno">10323</span>&#160;<span class="comment">              SecurityDescriptor.</span></div>
<div class="line"><a name="l10324"></a><span class="lineno">10324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10325"></a><span class="lineno">10325</span>&#160;<span class="comment">Note:</span></div>
<div class="line"><a name="l10326"></a><span class="lineno">10326</span>&#160;<span class="comment">    Parameter validation has already been done in Advapi.</span></div>
<div class="line"><a name="l10327"></a><span class="lineno">10327</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10328"></a><span class="lineno">10328</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10329"></a><span class="lineno">10329</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10330"></a><span class="lineno">10330</span>&#160;</div>
<div class="line"><a name="l10331"></a><span class="lineno">10331</span>&#160;{</div>
<div class="line"><a name="l10332"></a><span class="lineno">10332</span>&#160;    <a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> ISecurityDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a61cf327633d2a19c13477bda23e517ad">PISECURITY_DESCRIPTOR</a>) SecurityDescriptor;</div>
<div class="line"><a name="l10333"></a><span class="lineno">10333</span>&#160;</div>
<div class="line"><a name="l10334"></a><span class="lineno">10334</span>&#160;    <span class="keywordflow">if</span> (!(ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp; <a class="code" href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a>))</div>
<div class="line"><a name="l10335"></a><span class="lineno">10335</span>&#160;    {</div>
<div class="line"><a name="l10336"></a><span class="lineno">10336</span>&#160;        *RMControl = 0;</div>
<div class="line"><a name="l10337"></a><span class="lineno">10337</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10338"></a><span class="lineno">10338</span>&#160;    }</div>
<div class="line"><a name="l10339"></a><span class="lineno">10339</span>&#160;</div>
<div class="line"><a name="l10340"></a><span class="lineno">10340</span>&#160;    *RMControl = ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a4e7f873aebc6462ff1e07b387b11c782">Sbz1</a>;</div>
<div class="line"><a name="l10341"></a><span class="lineno">10341</span>&#160;</div>
<div class="line"><a name="l10342"></a><span class="lineno">10342</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l10343"></a><span class="lineno">10343</span>&#160;}</div>
<div class="line"><a name="l10344"></a><span class="lineno">10344</span>&#160;</div>
<div class="line"><a name="l10345"></a><span class="lineno">10345</span>&#160;</div>
<div class="line"><a name="l10346"></a><span class="lineno">10346</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div>
<div class="line"><a name="l10347"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#ade7b3318164b177270351c77baa8d79f">10347</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#ade7b3318164b177270351c77baa8d79f">RtlpGuidPresentInGuidList</a>(</div>
<div class="line"><a name="l10348"></a><span class="lineno">10348</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> *InheritedObjectType,</div>
<div class="line"><a name="l10349"></a><span class="lineno">10349</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../db/d44/a00533.html">GUID</a> **pNewObjectType,</div>
<div class="line"><a name="l10350"></a><span class="lineno">10350</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> GuidCount</div>
<div class="line"><a name="l10351"></a><span class="lineno">10351</span>&#160;    )</div>
<div class="line"><a name="l10352"></a><span class="lineno">10352</span>&#160;</div>
<div class="line"><a name="l10353"></a><span class="lineno">10353</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10354"></a><span class="lineno">10354</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10355"></a><span class="lineno">10355</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10356"></a><span class="lineno">10356</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10357"></a><span class="lineno">10357</span>&#160;<span class="comment">    This routine returns whether a given guid is present in a list of guids.</span></div>
<div class="line"><a name="l10358"></a><span class="lineno">10358</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10359"></a><span class="lineno">10359</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10360"></a><span class="lineno">10360</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10361"></a><span class="lineno">10361</span>&#160;<span class="comment">    InheritedObjectType - Guid from the ace that will be compared against </span></div>
<div class="line"><a name="l10362"></a><span class="lineno">10362</span>&#160;<span class="comment">        the object types for the object.</span></div>
<div class="line"><a name="l10363"></a><span class="lineno">10363</span>&#160;<span class="comment">        </span></div>
<div class="line"><a name="l10364"></a><span class="lineno">10364</span>&#160;<span class="comment">    pNewObjectType - List of types of object being inherited to.</span></div>
<div class="line"><a name="l10365"></a><span class="lineno">10365</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10366"></a><span class="lineno">10366</span>&#160;<span class="comment">    GuidCount - Number of object types in the list.</span></div>
<div class="line"><a name="l10367"></a><span class="lineno">10367</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10368"></a><span class="lineno">10368</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10369"></a><span class="lineno">10369</span>&#160;<span class="comment">Return Value:</span></div>
<div class="line"><a name="l10370"></a><span class="lineno">10370</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10371"></a><span class="lineno">10371</span>&#160;<span class="comment">    Returns TRUE if the given guid is present in the list of guids.</span></div>
<div class="line"><a name="l10372"></a><span class="lineno">10372</span>&#160;<span class="comment">    FALSE otherwise.</span></div>
<div class="line"><a name="l10373"></a><span class="lineno">10373</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10374"></a><span class="lineno">10374</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10375"></a><span class="lineno">10375</span>&#160;</div>
<div class="line"><a name="l10376"></a><span class="lineno">10376</span>&#160;{</div>
<div class="line"><a name="l10377"></a><span class="lineno">10377</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> i;</div>
<div class="line"><a name="l10378"></a><span class="lineno">10378</span>&#160;</div>
<div class="line"><a name="l10379"></a><span class="lineno">10379</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; GuidCount; i++) {</div>
<div class="line"><a name="l10380"></a><span class="lineno">10380</span>&#160;</div>
<div class="line"><a name="l10381"></a><span class="lineno">10381</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../de/dc3/a02256.html#a6c25a490b42cfa68e593014c864424c8">RtlEqualMemory</a>(</div>
<div class="line"><a name="l10382"></a><span class="lineno">10382</span>&#160;                InheritedObjectType,</div>
<div class="line"><a name="l10383"></a><span class="lineno">10383</span>&#160;                pNewObjectType[i],</div>
<div class="line"><a name="l10384"></a><span class="lineno">10384</span>&#160;                <span class="keyword">sizeof</span>(<a class="code" href="../../db/d44/a00533.html">GUID</a>) ) ) {</div>
<div class="line"><a name="l10385"></a><span class="lineno">10385</span>&#160;</div>
<div class="line"><a name="l10386"></a><span class="lineno">10386</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l10387"></a><span class="lineno">10387</span>&#160;        }</div>
<div class="line"><a name="l10388"></a><span class="lineno">10388</span>&#160;</div>
<div class="line"><a name="l10389"></a><span class="lineno">10389</span>&#160;    }</div>
<div class="line"><a name="l10390"></a><span class="lineno">10390</span>&#160;</div>
<div class="line"><a name="l10391"></a><span class="lineno">10391</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l10392"></a><span class="lineno">10392</span>&#160;}</div>
<div class="line"><a name="l10393"></a><span class="lineno">10393</span>&#160;</div>
<div class="line"><a name="l10394"></a><span class="lineno">10394</span>&#160;</div>
<div class="line"><a name="l10395"></a><span class="lineno">10395</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div>
<div class="line"><a name="l10396"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#afde17e8941f81fff1936c74ed0f7371c">10396</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#afde17e8941f81fff1936c74ed0f7371c">RtlSetSecurityDescriptorRMControl</a>(</div>
<div class="line"><a name="l10397"></a><span class="lineno">10397</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a> SecurityDescriptor,</div>
<div class="line"><a name="l10398"></a><span class="lineno">10398</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a> RMControl <a class="code" href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a></div>
<div class="line"><a name="l10399"></a><span class="lineno">10399</span>&#160;    )</div>
<div class="line"><a name="l10400"></a><span class="lineno">10400</span>&#160;</div>
<div class="line"><a name="l10401"></a><span class="lineno">10401</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10402"></a><span class="lineno">10402</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10403"></a><span class="lineno">10403</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10404"></a><span class="lineno">10404</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10405"></a><span class="lineno">10405</span>&#160;<span class="comment">    This procedure sets the RM Control flag in the control field of</span></div>
<div class="line"><a name="l10406"></a><span class="lineno">10406</span>&#160;<span class="comment">    SecurityDescriptor and sets Sbz1 to the the byte to which RMContol points.</span></div>
<div class="line"><a name="l10407"></a><span class="lineno">10407</span>&#160;<span class="comment">    If RMControl is NULL then the bits are cleared.</span></div>
<div class="line"><a name="l10408"></a><span class="lineno">10408</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10409"></a><span class="lineno">10409</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10410"></a><span class="lineno">10410</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10411"></a><span class="lineno">10411</span>&#160;<span class="comment">    SecurityDescriptor - Pointer to the SECURITY_DESCRIPTOR structure</span></div>
<div class="line"><a name="l10412"></a><span class="lineno">10412</span>&#160;<span class="comment">    RMControl          - Pointer to the flags to set. If NULL then the bits</span></div>
<div class="line"><a name="l10413"></a><span class="lineno">10413</span>&#160;<span class="comment">                         are cleared.</span></div>
<div class="line"><a name="l10414"></a><span class="lineno">10414</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10415"></a><span class="lineno">10415</span>&#160;<span class="comment">Note:</span></div>
<div class="line"><a name="l10416"></a><span class="lineno">10416</span>&#160;<span class="comment">    Parameter validation has already been done in Advapi.</span></div>
<div class="line"><a name="l10417"></a><span class="lineno">10417</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10418"></a><span class="lineno">10418</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10419"></a><span class="lineno">10419</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10420"></a><span class="lineno">10420</span>&#160;</div>
<div class="line"><a name="l10421"></a><span class="lineno">10421</span>&#160;{</div>
<div class="line"><a name="l10422"></a><span class="lineno">10422</span>&#160;    <a class="code" href="../../da/de2/a01585.html">PISECURITY_DESCRIPTOR</a> ISecurityDescriptor = (<a class="code" href="../../d3/d3a/a02259.html#a61cf327633d2a19c13477bda23e517ad">PISECURITY_DESCRIPTOR</a>) SecurityDescriptor;</div>
<div class="line"><a name="l10423"></a><span class="lineno">10423</span>&#160;</div>
<div class="line"><a name="l10424"></a><span class="lineno">10424</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a>(RMControl)) {</div>
<div class="line"><a name="l10425"></a><span class="lineno">10425</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> |= <a class="code" href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a>;</div>
<div class="line"><a name="l10426"></a><span class="lineno">10426</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a4e7f873aebc6462ff1e07b387b11c782">Sbz1</a> = *RMControl;</div>
<div class="line"><a name="l10427"></a><span class="lineno">10427</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l10428"></a><span class="lineno">10428</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">Control</a> &amp;= ~<a class="code" href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a>;</div>
<div class="line"><a name="l10429"></a><span class="lineno">10429</span>&#160;        ISecurityDescriptor-&gt;<a class="code" href="../../da/de2/a01585.html#a4e7f873aebc6462ff1e07b387b11c782">Sbz1</a> = 0;</div>
<div class="line"><a name="l10430"></a><span class="lineno">10430</span>&#160;    }</div>
<div class="line"><a name="l10431"></a><span class="lineno">10431</span>&#160;}</div>
<div class="line"><a name="l10432"></a><span class="lineno">10432</span>&#160;</div>
<div class="line"><a name="l10433"></a><span class="lineno">10433</span>&#160;<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div>
<div class="line"><a name="l10434"></a><span class="lineno"><a class="line" href="../../d3/d32/a02665.html#a008d15dcf7208a7c92d06feb4a959509">10434</a></span>&#160;<a class="code" href="../../d3/d32/a02665.html#a008d15dcf7208a7c92d06feb4a959509">RtlMapSecurityErrorToNtStatus</a>(</div>
<div class="line"><a name="l10435"></a><span class="lineno">10435</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="../../dd/d67/a02230.html#a4e5982714d855e34fa8dd0ad6b0f3682">SECURITY_STATUS</a> Error</div>
<div class="line"><a name="l10436"></a><span class="lineno">10436</span>&#160;    )</div>
<div class="line"><a name="l10437"></a><span class="lineno">10437</span>&#160;<span class="comment">/*++</span></div>
<div class="line"><a name="l10438"></a><span class="lineno">10438</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10439"></a><span class="lineno">10439</span>&#160;<span class="comment">Routine Description:</span></div>
<div class="line"><a name="l10440"></a><span class="lineno">10440</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10441"></a><span class="lineno">10441</span>&#160;<span class="comment">    This procedure maps a security HRESULT to the proper NTSTATUS code.</span></div>
<div class="line"><a name="l10442"></a><span class="lineno">10442</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l10443"></a><span class="lineno">10443</span>&#160;<span class="comment">Arguments:</span></div>
<div class="line"><a name="l10444"></a><span class="lineno">10444</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10445"></a><span class="lineno">10445</span>&#160;<span class="comment">    Error - a security HRESULT</span></div>
<div class="line"><a name="l10446"></a><span class="lineno">10446</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l10447"></a><span class="lineno">10447</span>&#160;<span class="comment">Return Value:  The NTSTATUS code corresponding to the HRESULT. If no</span></div>
<div class="line"><a name="l10448"></a><span class="lineno">10448</span>&#160;<span class="comment">               status code can be mapped, the original error is returned.</span></div>
<div class="line"><a name="l10449"></a><span class="lineno">10449</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10450"></a><span class="lineno">10450</span>&#160;<span class="comment">Note:</span></div>
<div class="line"><a name="l10451"></a><span class="lineno">10451</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l10452"></a><span class="lineno">10452</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10453"></a><span class="lineno">10453</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l10454"></a><span class="lineno">10454</span>&#160;<span class="comment">--*/</span></div>
<div class="line"><a name="l10455"></a><span class="lineno">10455</span>&#160;{</div>
<div class="line"><a name="l10456"></a><span class="lineno">10456</span>&#160;    <a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a> <a class="code" href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a>;</div>
<div class="line"><a name="l10457"></a><span class="lineno">10457</span>&#160;</div>
<div class="line"><a name="l10458"></a><span class="lineno">10458</span>&#160;    <span class="keywordflow">switch</span>(Error) {</div>
<div class="line"><a name="l10459"></a><span class="lineno">10459</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#ac2dbec73a8c9af33a1a47d6ba56981e8">SEC_E_INSUFFICIENT_MEMORY</a> : Status = <a class="code" href="../../dc/d18/a02260.html#aeb86c04f9593b4cdb1b56c71e76d2e36">STATUS_INSUFFICIENT_RESOURCES</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10460"></a><span class="lineno">10460</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a127027368b7a96197888884e97578e12">SEC_E_INVALID_HANDLE</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a0b8838a698a06fdd7f62c4bd39e00755">STATUS_INVALID_HANDLE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10461"></a><span class="lineno">10461</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a699ef412e2ac0d6aac37e17e61a89b79">SEC_E_UNSUPPORTED_FUNCTION</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a91e0d9975c55202ba11078f5f7a69747">STATUS_NOT_SUPPORTED</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10462"></a><span class="lineno">10462</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#adf4f2d6191dfec4f94a62cdcb520fa72">SEC_E_TARGET_UNKNOWN</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a977e3e5c6f2215f7aff3763d08ad0442">STATUS_BAD_NETWORK_PATH</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10463"></a><span class="lineno">10463</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a3896ec4b73f3568b9c393dca63de8abc">SEC_E_INTERNAL_ERROR</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a02e7b4e5e8145bdfc8bb23069ea89912">STATUS_INTERNAL_ERROR</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10464"></a><span class="lineno">10464</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a7d6ef79476c5e09375033be85404a66b">SEC_E_SECPKG_NOT_FOUND</a> : Status = <a class="code" href="../../dc/d18/a02260.html#afea71f62fd3e29097dd31a4e813612b8">STATUS_NO_SUCH_PACKAGE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10465"></a><span class="lineno">10465</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a6ad1332983c284ac77ad5d299d7380f8">SEC_E_NOT_OWNER</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a62f33d4e46ad5b4ca3e889ded4c0f7a1">STATUS_PRIVILEGE_NOT_HELD</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10466"></a><span class="lineno">10466</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a3e9be4fa173e288f3f5b2674c6e6c218">SEC_E_CANNOT_INSTALL</a> : Status = <a class="code" href="../../dc/d18/a02260.html#afea71f62fd3e29097dd31a4e813612b8">STATUS_NO_SUCH_PACKAGE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10467"></a><span class="lineno">10467</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#ab3c98963d70bdc291e8fe2140ccf984e">SEC_E_INVALID_TOKEN</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a52c9a508482278e5a91348ba542df15f">STATUS_INVALID_PARAMETER</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10468"></a><span class="lineno">10468</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a93053278fb0a1a2881b9318ceb5d001f">SEC_E_CANNOT_PACK</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a52c9a508482278e5a91348ba542df15f">STATUS_INVALID_PARAMETER</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10469"></a><span class="lineno">10469</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#abbbdcce8a976349b4e60a751d797bf1f">SEC_E_QOP_NOT_SUPPORTED</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a91e0d9975c55202ba11078f5f7a69747">STATUS_NOT_SUPPORTED</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10470"></a><span class="lineno">10470</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a58fe53f536c879511669395419737eff">SEC_E_NO_IMPERSONATION</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a32e3f920f2666a40f948e8092d9d6980">STATUS_CANNOT_IMPERSONATE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10471"></a><span class="lineno">10471</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a375312e60c413be670bc3b90617a2eee">SEC_E_LOGON_DENIED</a> : Status = <a class="code" href="../../dc/d18/a02260.html#af0ac76339079fd1133253822f542f093">STATUS_LOGON_FAILURE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10472"></a><span class="lineno">10472</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a4ef54e5314157491ca49e206b87a2913">SEC_E_UNKNOWN_CREDENTIALS</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a76144b5198b53ccf2b102bb11b6dd79a">STATUS_NO_SUCH_LOGON_SESSION</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10473"></a><span class="lineno">10473</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#aba38e12cb68a39555dd1642be58713cd">SEC_E_NO_CREDENTIALS</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a76144b5198b53ccf2b102bb11b6dd79a">STATUS_NO_SUCH_LOGON_SESSION</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10474"></a><span class="lineno">10474</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a98143de0e4dda2c2461e9003f8945ed4">SEC_E_MESSAGE_ALTERED</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a415c67a7a97e52ebee39db8c3addfd4d">STATUS_ACCESS_DENIED</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10475"></a><span class="lineno">10475</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#ab5a2c77139e3835fe5b767b2f99b9c26">SEC_E_OUT_OF_SEQUENCE</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a415c67a7a97e52ebee39db8c3addfd4d">STATUS_ACCESS_DENIED</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10476"></a><span class="lineno">10476</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a611b653b57d08ef0e8b6145c5b6e3f58">SEC_E_NO_AUTHENTICATING_AUTHORITY</a> : Status = <a class="code" href="../../dc/d18/a02260.html#a54a87528fba7b6b6256f3c5f074ba9b9">STATUS_NO_LOGON_SERVERS</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10477"></a><span class="lineno">10477</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#a6eb360050ffcd1576d48120c77249c3c">SEC_E_BAD_PKGID</a> : Status = <a class="code" href="../../dc/d18/a02260.html#afea71f62fd3e29097dd31a4e813612b8">STATUS_NO_SUCH_PACKAGE</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10478"></a><span class="lineno">10478</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="../../d3/dc5/a02306.html#ad82d7bdad424f560c968dc536c428f0e">SEC_E_TIME_SKEW</a> : Status = <a class="code" href="../../dc/d18/a02260.html#abb89369ba87c77abdba0f391be67da52">STATUS_TIME_DIFFERENCE_AT_DC</a>; <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l10479"></a><span class="lineno">10479</span>&#160;</div>
<div class="line"><a name="l10480"></a><span class="lineno">10480</span>&#160;    <span class="keywordflow">default</span>: Status = (<a class="code" href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a>) Error;</div>
<div class="line"><a name="l10481"></a><span class="lineno">10481</span>&#160;    }</div>
<div class="line"><a name="l10482"></a><span class="lineno">10482</span>&#160;</div>
<div class="line"><a name="l10483"></a><span class="lineno">10483</span>&#160;    <span class="keywordflow">return</span>(Status);</div>
<div class="line"><a name="l10484"></a><span class="lineno">10484</span>&#160;}</div>
<div class="line"><a name="l10485"></a><span class="lineno">10485</span>&#160;</div>
<div class="line"><a name="l10486"></a><span class="lineno">10486</span>&#160;<span class="preprocessor">#if defined(ALLOC_DATA_PRAGMA)</span></div>
<div class="line"><a name="l10487"></a><span class="lineno">10487</span>&#160;<span class="preprocessor">#pragma const_seg()</span></div>
<div class="line"><a name="l10488"></a><span class="lineno">10488</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l10489"></a><span class="lineno">10489</span>&#160;</div>
<div class="ttc" id="a02285_html_a478668a3f7d97d76ab60a908fd5a4780"><div class="ttname"><a href="../../df/d4d/a02285.html#a478668a3f7d97d76ab60a908fd5a4780">SeControlSaclToGeneric</a></div><div class="ttdeci">#define SeControlSaclToGeneric(_Sacl)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00299">seopaque.h:299</a></div></div>
<div class="ttc" id="a02665_html_a98fa21d2d8124ffe917105ea7cd6338b"><div class="ttname"><a href="../../d3/d32/a02665.html#a98fa21d2d8124ffe917105ea7cd6338b">RtlpCompareKnownObjectAces</a></div><div class="ttdeci">BOOLEAN RtlpCompareKnownObjectAces(IN PKNOWN_OBJECT_ACE InheritedAce, IN PKNOWN_OBJECT_ACE ChildAce, IN PSID OwnerSid OPTIONAL, IN PSID GroupSid OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06737">sertl.c:6737</a></div></div>
<div class="ttc" id="a02369_html_ac72f24fb0e57feffb445dd9456b8597a"><div class="ttname"><a href="../../df/def/a02369.html#ac72f24fb0e57feffb445dd9456b8597a">Group</a></div><div class="ttdeci">ULONG Group</div><div class="ttdef"><b>Definition:</b> <a href="../../df/def/a02369_source.html#l00130">decode.c:130</a></div></div>
<div class="ttc" id="a02230_html_ac2bbd6d630a06a980d9a92ddb9a49928"><div class="ttname"><a href="../../dd/d67/a02230.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a></div><div class="ttdeci">#define IN</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00031">ntdef.h:31</a></div></div>
<div class="ttc" id="a01406_html_a19ff8e350afcb8b62f12c47c57e6bb0e"><div class="ttname"><a href="../../dc/d25/a01406.html#a19ff8e350afcb8b62f12c47c57e6bb0e">_PRIVILEGE_SET::Privilege</a></div><div class="ttdeci">LUID_AND_ATTRIBUTES Privilege[ANYSIZE_ARRAY]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01309">ntseapi.h:1309</a></div></div>
<div class="ttc" id="a02665_html_af7aac31ad0fbb0a545f52ddfcaae9b98"><div class="ttname"><a href="../../d3/d32/a02665.html#af7aac31ad0fbb0a545f52ddfcaae9b98">RtlpCopyAces</a></div><div class="ttdeci">NTSTATUS RtlpCopyAces(IN PACL Acl, IN PGENERIC_MAPPING GenericMapping, IN ACE_TYPE_TO_COPY AceTypeToCopy, IN UCHAR AceFlagsToReset, IN BOOLEAN MapSids, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN BOOLEAN IsDirectoryObject, IN BOOLEAN RetainInheritedAceBit, OUT PULONG NewAclSizeParam, OUT PACL NewAcl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03935">sertl.c:3935</a></div></div>
<div class="ttc" id="a02665_html_abd7188a3d40a69b06e673cde4fd09833"><div class="ttname"><a href="../../d3/d32/a02665.html#abd7188a3d40a69b06e673cde4fd09833">RtlpConvertAclToAutoInherit</a></div><div class="ttdeci">NTSTATUS RtlpConvertAclToAutoInherit(IN PACL ParentAcl OPTIONAL, IN PACL ChildAcl, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN PSID OwnerSid, IN PSID GroupSid, IN PGENERIC_MAPPING GenericMapping, OUT PACL *NewAcl, OUT PULONG NewGenericControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06993">sertl.c:6993</a></div></div>
<div class="ttc" id="a02259_html_a5bdc6aa90cb7276fc7e2523b65e3556e"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5bdc6aa90cb7276fc7e2523b65e3556e">PSECURITY_DESCRIPTOR</a></div><div class="ttdeci">PVOID PSECURITY_DESCRIPTOR</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00059">ntseapi.h:59</a></div></div>
<div class="ttc" id="a02247_html_a790ab8c3782da2b69b1564d13591d23c"><div class="ttname"><a href="../../df/d71/a02247.html#a790ab8c3782da2b69b1564d13591d23c">NtClose</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtClose(__in HANDLE Handle)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d4a/a02550_source.html#l00399">obclose.c:399</a></div></div>
<div class="ttc" id="a02261_html_ad8b92003f9218337012742c64702b604"><div class="ttname"><a href="../../d7/d24/a02261.html#ad8b92003f9218337012742c64702b604">SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT</a></div><div class="ttdeci">#define SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00921">nturtl.h:921</a></div></div>
<div class="ttc" id="a01624_html_a3cd69b64b8e96f1cf67ab649a2e0795a"><div class="ttname"><a href="../../de/df9/a01624.html#a3cd69b64b8e96f1cf67ab649a2e0795a">_SID::Revision</a></div><div class="ttdeci">UCHAR Revision</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00252">ntseapi.h:252</a></div></div>
<div class="ttc" id="a00012_html_acfe3343d4b304d024e5560b9c385fcbf"><div class="ttname"><a href="../../df/d86/a00012.html#acfe3343d4b304d024e5560b9c385fcbf">_ACE_HEADER::AceType</a></div><div class="ttdeci">UCHAR AceType</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00688">ntseapi.h:688</a></div></div>
<div class="ttc" id="a02259_html_abe4a853bae5886ec566c087708e4d2e5"><div class="ttname"><a href="../../d3/d3a/a02259.html#abe4a853bae5886ec566c087708e4d2e5">ACL_REVISION</a></div><div class="ttdeci">#define ACL_REVISION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00645">ntseapi.h:645</a></div></div>
<div class="ttc" id="a02259_html_a537521ea5f9e4ec4b4288628a0b86d5d"><div class="ttname"><a href="../../d3/d3a/a02259.html#a537521ea5f9e4ec4b4288628a0b86d5d">PACCESS_MASK</a></div><div class="ttdeci">ACCESS_MASK * PACCESS_MASK</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00112">ntseapi.h:112</a></div></div>
<div class="ttc" id="a02259_html_a99e85d58654f7a9338b77835298b4689"><div class="ttname"><a href="../../d3/d3a/a02259.html#a99e85d58654f7a9338b77835298b4689">PTOKEN_PRIVILEGES</a></div><div class="ttdeci">struct _TOKEN_PRIVILEGES * PTOKEN_PRIVILEGES</div></div>
<div class="ttc" id="a02259_html_aa02fa07acf110491c9561459d8e3c4fa"><div class="ttname"><a href="../../d3/d3a/a02259.html#aa02fa07acf110491c9561459d8e3c4fa">ACCESS_MASK</a></div><div class="ttdeci">ULONG ACCESS_MASK</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00111">ntseapi.h:111</a></div></div>
<div class="ttc" id="a02665_html_a008d15dcf7208a7c92d06feb4a959509"><div class="ttname"><a href="../../d3/d32/a02665.html#a008d15dcf7208a7c92d06feb4a959509">RtlMapSecurityErrorToNtStatus</a></div><div class="ttdeci">NTSTATUS RtlMapSecurityErrorToNtStatus(IN SECURITY_STATUS Error)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l10434">sertl.c:10434</a></div></div>
<div class="ttc" id="a02665_html_a8b44a03dd9ddd7d2fb3abe5a92a38c88"><div class="ttname"><a href="../../d3/d32/a02665.html#a8b44a03dd9ddd7d2fb3abe5a92a38c88">RtlSetOwnerSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetOwnerSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID Owner OPTIONAL, IN BOOLEAN OwnerDefaulted OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02707">sertl.c:2707</a></div></div>
<div class="ttc" id="a02700_html_a9815296fd3bf6e2f58aaf39bf0673148"><div class="ttname"><a href="../../dd/dee/a02700.html#a9815296fd3bf6e2f58aaf39bf0673148">SepGetDefaultsSubjectContext</a></div><div class="ttdeci">VOID SepGetDefaultsSubjectContext(IN PSECURITY_SUBJECT_CONTEXT SubjectContext, OUT PSID *Owner, OUT PSID *Group, OUT PSID *ServerOwner, OUT PSID *ServerGroup, OUT PACL *Dacl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00320">subject.c:320</a></div></div>
<div class="ttc" id="a02256_html_aea7f07b5b74d7f1bdb529aab026c79c6"><div class="ttname"><a href="../../de/dc3/a02256.html#aea7f07b5b74d7f1bdb529aab026c79c6">RtlApplyAceToObject</a></div><div class="ttdeci">#define RtlApplyAceToObject(Ace, Mapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l06830">ntrtl.h:6830</a></div></div>
<div class="ttc" id="a02259_html_aee95b08affc82550582d1c5421d9cafb"><div class="ttname"><a href="../../d3/d3a/a02259.html#aee95b08affc82550582d1c5421d9cafb">TOKEN_PRIVILEGES</a></div><div class="ttdeci">struct _TOKEN_PRIVILEGES TOKEN_PRIVILEGES</div></div>
<div class="ttc" id="a02260_html_a5872ceb716a4f69f7f861596e77a016c"><div class="ttname"><a href="../../dc/d18/a02260.html#a5872ceb716a4f69f7f861596e77a016c">STATUS_INVALID_SID</a></div><div class="ttdeci">#define STATUS_INVALID_SID</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02622">ntstatus.h:2622</a></div></div>
<div class="ttc" id="a02256_html_ac240d01157015858f293a75c9bc4a6f9"><div class="ttname"><a href="../../de/dc3/a02256.html#ac240d01157015858f293a75c9bc4a6f9">KdPrint</a></div><div class="ttdeci">#define KdPrint(_x_)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l04572">ntrtl.h:4572</a></div></div>
<div class="ttc" id="a02665_html_a98ed9bc41b41b1f5f6bd1d4cdb3f2a0d"><div class="ttname"><a href="../../d3/d32/a02665.html#a98ed9bc41b41b1f5f6bd1d4cdb3f2a0d">RtlAreAnyAccessesGranted</a></div><div class="ttdeci">BOOLEAN RtlAreAnyAccessesGranted(IN ACCESS_MASK GrantedAccess, IN ACCESS_MASK DesiredAccess)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03088">sertl.c:3088</a></div></div>
<div class="ttc" id="a02230_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="../../dd/d67/a02230.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01073">ntdef.h:1073</a></div></div>
<div class="ttc" id="a02665_html_a0a555b854f73125cde10bd1e12254f4c"><div class="ttname"><a href="../../d3/d32/a02665.html#a0a555b854f73125cde10bd1e12254f4c">RtlGetSecurityDescriptorRMControl</a></div><div class="ttdeci">BOOLEAN RtlGetSecurityDescriptorRMControl(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PUCHAR RMControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l10300">sertl.c:10300</a></div></div>
<div class="ttc" id="a02665_html_a73ffe8bc02593f93e294cf9ceaa9e84a"><div class="ttname"><a href="../../d3/d32/a02665.html#a73ffe8bc02593f93e294cf9ceaa9e84a">RtlpGenerateInheritAcl</a></div><div class="ttdeci">NTSTATUS RtlpGenerateInheritAcl(IN PACL Acl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID **pNewObjectType OPTIONAL, IN ULONG GuidCount, OUT PULONG NewAclSizeParam, OUT PACL NewAcl, OUT PBOOLEAN ObjectAceInherited)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l05290">sertl.c:5290</a></div></div>
<div class="ttc" id="a02234_html_a5c1da301e64af190fdfe3a264cd83e91"><div class="ttname"><a href="../../d8/d6f/a02234.html#a5c1da301e64af190fdfe3a264cd83e91">NtQuerySystemTime</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtQuerySystemTime(__out PLARGE_INTEGER SystemTime)</div></div>
<div class="ttc" id="a02665_html_a1fe8cfc3e645e82d1290b931cfedfc4f"><div class="ttname"><a href="../../d3/d32/a02665.html#a1fe8cfc3e645e82d1290b931cfedfc4f">max</a></div><div class="ttdeci">#define max(a, b)                    </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00331">sertl.c:331</a></div></div>
<div class="ttc" id="a01624_html_a016791c144978a3390935063f68f1d6b"><div class="ttname"><a href="../../de/df9/a01624.html#a016791c144978a3390935063f68f1d6b">_SID::SubAuthority</a></div><div class="ttdeci">ULONG SubAuthority[ANYSIZE_ARRAY]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00258">ntseapi.h:258</a></div></div>
<div class="ttc" id="a02249_html_a9b26934030fc4241b92fe90168d238efadcfc57d389e8e2bb30dc32135b6a92d0"><div class="ttname"><a href="../../dd/dc3/a02249.html#a9b26934030fc4241b92fe90168d238efadcfc57d389e8e2bb30dc32135b6a92d0">UserMode</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dc3/a02249_source.html#l00128">ntosdef.h:128</a></div></div>
<div class="ttc" id="a02256_html_af4ddb38f27ea43e90252a906ffdd84c1"><div class="ttname"><a href="../../de/dc3/a02256.html#af4ddb38f27ea43e90252a906ffdd84c1">RtlCreateAcl</a></div><div class="ttdeci">NTSYSAPI NTSTATUS NTAPI RtlCreateAcl(PACL Acl, ULONG AclLength, ULONG AclRevision)</div></div>
<div class="ttc" id="a02259_html_acaa5961b4e4d9bfcc202f122d8eb222a"><div class="ttname"><a href="../../d3/d3a/a02259.html#acaa5961b4e4d9bfcc202f122d8eb222a">PRIVILEGE_SET_ALL_NECESSARY</a></div><div class="ttdeci">#define PRIVILEGE_SET_ALL_NECESSARY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01295">ntseapi.h:1295</a></div></div>
<div class="ttc" id="a02259_html_a2c9953d651287b48dd438b7a53bb91d5"><div class="ttname"><a href="../../d3/d3a/a02259.html#a2c9953d651287b48dd438b7a53bb91d5">SE_DACL_PROTECTED</a></div><div class="ttdeci">#define SE_DACL_PROTECTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01070">ntseapi.h:1070</a></div></div>
<div class="ttc" id="a02295_html_a9d2c7dc8b4f88632fdd2cd302e3d6957"><div class="ttname"><a href="../../dd/da4/a02295.html#a9d2c7dc8b4f88632fdd2cd302e3d6957">wcscat</a></div><div class="ttdeci">#define wcscat</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/da4/a02295_source.html#l07636">strsafe.h:7636</a></div></div>
<div class="ttc" id="a02259_html_a209f30ceb819d151d3e4479960b65fef"><div class="ttname"><a href="../../d3/d3a/a02259.html#a209f30ceb819d151d3e4479960b65fef">DACL_SECURITY_INFORMATION</a></div><div class="ttdeci">#define DACL_SECURITY_INFORMATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01775">ntseapi.h:1775</a></div></div>
<div class="ttc" id="a02256_html_a01c770015bc96e494b2ccfc6d9b080e0"><div class="ttname"><a href="../../de/dc3/a02256.html#a01c770015bc96e494b2ccfc6d9b080e0">RtlCreateUnicodeString</a></div><div class="ttdeci">NTSYSAPI BOOLEAN NTAPI RtlCreateUnicodeString(OUT PUNICODE_STRING DestinationString, IN PCWSTR SourceString)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d4d/a02654_source.html#l02042">nls.c:2042</a></div></div>
<div class="ttc" id="a01585_html"><div class="ttname"><a href="../../da/de2/a01585.html">_SECURITY_DESCRIPTOR</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01173">ntseapi.h:1173</a></div></div>
<div class="ttc" id="a02260_html_abb89369ba87c77abdba0f391be67da52"><div class="ttname"><a href="../../dc/d18/a02260.html#abb89369ba87c77abdba0f391be67da52">STATUS_TIME_DIFFERENCE_AT_DC</a></div><div class="ttdeci">#define STATUS_TIME_DIFFERENCE_AT_DC</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l04364">ntstatus.h:4364</a></div></div>
<div class="ttc" id="a02259_html_aad70cf4262d42fc67104c6d9bb407cd4"><div class="ttname"><a href="../../d3/d3a/a02259.html#aad70cf4262d42fc67104c6d9bb407cd4">GENERIC_ALL</a></div><div class="ttdeci">#define GENERIC_ALL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00166">ntseapi.h:166</a></div></div>
<div class="ttc" id="a02306_html_a6ad1332983c284ac77ad5d299d7380f8"><div class="ttname"><a href="../../d3/dc5/a02306.html#a6ad1332983c284ac77ad5d299d7380f8">SEC_E_NOT_OWNER</a></div><div class="ttdeci">#define SEC_E_NOT_OWNER</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22379">winerror.h:22379</a></div></div>
<div class="ttc" id="a02656_html_a1a19504422f244f779880b5bc1c4ac68"><div class="ttname"><a href="../../d2/d7d/a02656.html#a1a19504422f244f779880b5bc1c4ac68">RTL_PAGED_CODE</a></div><div class="ttdeci">#define RTL_PAGED_CODE()</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d7d/a02656_source.html#l00248">ntrtlp.h:248</a></div></div>
<div class="ttc" id="a00791_html"><div class="ttname"><a href="../../d4/d45/a00791.html">_KNOWN_OBJECT_ACE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00043">seopaque.h:43</a></div></div>
<div class="ttc" id="a02256_html_ac2b83a0ab0baf87298094ed858d91248"><div class="ttname"><a href="../../de/dc3/a02256.html#ac2b83a0ab0baf87298094ed858d91248">RtlCompoundAceClientSid</a></div><div class="ttdeci">#define RtlCompoundAceClientSid(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l06928">ntrtl.h:6928</a></div></div>
<div class="ttc" id="a02284_html_a21cb2fd86cd221d0f0cca48ae0cfd349"><div class="ttname"><a href="../../d3/d81/a02284.html#a21cb2fd86cd221d0f0cca48ae0cfd349">SeSecurityPrivilege</a></div><div class="ttdeci">LUID SeSecurityPrivilege</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da6/a02696_source.html#l00217">seglobal.c:217</a></div></div>
<div class="ttc" id="a02259_html_a8c669a5371bc7f2b06e09490052426c5"><div class="ttname"><a href="../../d3/d3a/a02259.html#a8c669a5371bc7f2b06e09490052426c5">PACL</a></div><div class="ttdeci">ACL * PACL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00665">ntseapi.h:665</a></div></div>
<div class="ttc" id="a02286_html_ab3a29f850b47635960753778305a0f82"><div class="ttname"><a href="../../db/d2d/a02286.html#ab3a29f850b47635960753778305a0f82">RtlpSaclAddrSecurityDescriptor</a></div><div class="ttdeci">#define RtlpSaclAddrSecurityDescriptor(SD)                                                                  </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00075">sertlp.h:75</a></div></div>
<div class="ttc" id="a02266_html_a3ca742f1facb2707a4633d55feacbf4c"><div class="ttname"><a href="../../d3/d6e/a02266.html#a3ca742f1facb2707a4633d55feacbf4c">ObValidateSecurityQuota</a></div><div class="ttdeci">NTSTATUS ObValidateSecurityQuota(IN PVOID Object, IN ULONG NewSize)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d66/a02562_source.html#l01374">obse.c:1374</a></div></div>
<div class="ttc" id="a02285_html_a03cefa160daede67f38b6dec9f9119a1"><div class="ttname"><a href="../../df/d4d/a02285.html#a03cefa160daede67f38b6dec9f9119a1">SeControlDaclToGeneric</a></div><div class="ttdeci">#define SeControlDaclToGeneric(_Dacl)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00293">seopaque.h:293</a></div></div>
<div class="ttc" id="a02665_html_a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2"><div class="ttname"><a href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a251e58d2255a0240718137cdd1734cb2">CopyAllAces</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00073">sertl.c:73</a></div></div>
<div class="ttc" id="a02665_html_a45c61e8254572cfd24099b583af624c9"><div class="ttname"><a href="../../d3/d32/a02665.html#a45c61e8254572cfd24099b583af624c9">RtlpIsDuplicateAce</a></div><div class="ttdeci">BOOLEAN RtlpIsDuplicateAce(IN PACL Acl, IN PKNOWN_ACE NewAce)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l07851">sertl.c:7851</a></div></div>
<div class="ttc" id="a02285_html"><div class="ttname"><a href="../../df/d4d/a02285.html">seopaque.h</a></div></div>
<div class="ttc" id="a02259_html_a6a17154ddd8ee109a4deeb874f14264e"><div class="ttname"><a href="../../d3/d3a/a02259.html#a6a17154ddd8ee109a4deeb874f14264e">SE_SACL_DEFAULTED</a></div><div class="ttdeci">#define SE_SACL_DEFAULTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01061">ntseapi.h:1061</a></div></div>
<div class="ttc" id="a02260_html_a91e0d9975c55202ba11078f5f7a69747"><div class="ttname"><a href="../../dc/d18/a02260.html#a91e0d9975c55202ba11078f5f7a69747">STATUS_NOT_SUPPORTED</a></div><div class="ttdeci">#define STATUS_NOT_SUPPORTED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03252">ntstatus.h:3252</a></div></div>
<div class="ttc" id="a02665_html_a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe"><div class="ttname"><a href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2ac892fed35148328955048dd7f7e3eefe">CopyNonInheritedAces</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00072">sertl.c:72</a></div></div>
<div class="ttc" id="a02230_html_a253b627decfeb8fee3765eba6d720d74"><div class="ttname"><a href="../../dd/d67/a02230.html#a253b627decfeb8fee3765eba6d720d74">PULONG</a></div><div class="ttdeci">ULONG * PULONG</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00401">ntdef.h:401</a></div></div>
<div class="ttc" id="a00789_html_a54cb4a9888227adece5d5fa2525b1a71"><div class="ttname"><a href="../../d8/d7d/a00789.html#a54cb4a9888227adece5d5fa2525b1a71">_KNOWN_ACE::Header</a></div><div class="ttdeci">ACE_HEADER Header</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00038">seopaque.h:38</a></div></div>
<div class="ttc" id="a02285_html_ae95f120ac17a4331773cfc7240498181"><div class="ttname"><a href="../../df/d4d/a02285.html#ae95f120ac17a4331773cfc7240498181">NextAce</a></div><div class="ttdeci">#define NextAce(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00140">seopaque.h:140</a></div></div>
<div class="ttc" id="a02285_html_a58f79b78a435b75cb346116e5fff329a"><div class="ttname"><a href="../../df/d4d/a02285.html#a58f79b78a435b75cb346116e5fff329a">ObjectInherit</a></div><div class="ttdeci">#define ObjectInherit(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00227">seopaque.h:227</a></div></div>
<div class="ttc" id="a02259_html_ab1cf9e99656615972a3407e5d72574b5"><div class="ttname"><a href="../../d3/d3a/a02259.html#ab1cf9e99656615972a3407e5d72574b5">GROUP_SECURITY_INFORMATION</a></div><div class="ttdeci">#define GROUP_SECURITY_INFORMATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01774">ntseapi.h:1774</a></div></div>
<div class="ttc" id="a02665_html_a6e033b81eaae1f1acdf292ab3214a3f2"><div class="ttname"><a href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2">ACE_TYPE_TO_COPY</a></div><div class="ttdeci">ACE_TYPE_TO_COPY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00070">sertl.c:70</a></div></div>
<div class="ttc" id="a02256_html_ab00558cf20129feb37af30b11cca45d5"><div class="ttname"><a href="../../de/dc3/a02256.html#ab00558cf20129feb37af30b11cca45d5">RtlIntegerToUnicode</a></div><div class="ttdeci">NTSYSAPI NTSTATUS NTAPI RtlIntegerToUnicode(IN ULONG Value, IN ULONG Base OPTIONAL, IN LONG OutputLength, OUT PWSTR String)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d70/a02629_source.html#l00344">cnvint.c:344</a></div></div>
<div class="ttc" id="a02285_html_ab1f11dd357b660fd4f53cdc00bb14e6f"><div class="ttname"><a href="../../df/d4d/a02285.html#ab1f11dd357b660fd4f53cdc00bb14e6f">RtlObjectAceObjectTypePresent</a></div><div class="ttdeci">#define RtlObjectAceObjectTypePresent(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00242">seopaque.h:242</a></div></div>
<div class="ttc" id="a02244_html_ab2d24f6b2b769cf895179481b4a8bc00"><div class="ttname"><a href="../../d8/d51/a02244.html#ab2d24f6b2b769cf895179481b4a8bc00">LengthRequired</a></div><div class="ttdeci">IN ULONG LengthRequired</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d51/a02244_source.html#l01038">ntlsa.h:1038</a></div></div>
<div class="ttc" id="a02665_html_ab480a0f5efb65a4d69b939013a83008b"><div class="ttname"><a href="../../d3/d32/a02665.html#ab480a0f5efb65a4d69b939013a83008b">RtlpInheritAcl</a></div><div class="ttdeci">NTSTATUS RtlpInheritAcl(IN PACL DirectoryAcl, IN PACL ChildAcl, IN ULONG ChildGenericControl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN BOOLEAN DefaultDescriptorForObject, IN PSID OwnerSid, IN PSID GroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN GUID **pNewObjectType OPTIONAL, IN ULONG GuidCount, OUT PACL *NewAcl, OUT PBOOLEAN NewAclExplicitlyAssigned, OUT PULONG NewGenericControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l04746">sertl.c:4746</a></div></div>
<div class="ttc" id="a02285_html_ad77f759c54bc99e903c272ee601e5bd4"><div class="ttname"><a href="../../df/d4d/a02285.html#ad77f759c54bc99e903c272ee601e5bd4">PKNOWN_ACE</a></div><div class="ttdeci">struct _KNOWN_ACE * PKNOWN_ACE</div></div>
<div class="ttc" id="a02285_html_a78b32f38b2da7b2c358f21a6f32190df"><div class="ttname"><a href="../../df/d4d/a02285.html#a78b32f38b2da7b2c358f21a6f32190df">PKNOWN_OBJECT_ACE</a></div><div class="ttdeci">struct _KNOWN_OBJECT_ACE * PKNOWN_OBJECT_ACE</div></div>
<div class="ttc" id="a02259_html_a3e6f1b8d0a078bc25ae7ea3a6b5c3ecb"><div class="ttname"><a href="../../d3/d3a/a02259.html#a3e6f1b8d0a078bc25ae7ea3a6b5c3ecb">SECURITY_CREATOR_GROUP_SERVER_RID</a></div><div class="ttdeci">#define SECURITY_CREATOR_GROUP_SERVER_RID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00327">ntseapi.h:327</a></div></div>
<div class="ttc" id="a02284_html_aa25242f85c1cf107ce24237f5836c527"><div class="ttname"><a href="../../d3/d81/a02284.html#aa25242f85c1cf107ce24237f5836c527">SeUnlockSubjectContext</a></div><div class="ttdeci">NTKERNELAPI VOID SeUnlockSubjectContext(__in PSECURITY_SUBJECT_CONTEXT SubjectContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00224">subject.c:224</a></div></div>
<div class="ttc" id="a02261_html_a59d287bcfe603ad0d4b5a330be02d22d"><div class="ttname"><a href="../../d7/d24/a02261.html#a59d287bcfe603ad0d4b5a330be02d22d">SEF_DACL_AUTO_INHERIT</a></div><div class="ttdeci">#define SEF_DACL_AUTO_INHERIT</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00919">nturtl.h:919</a></div></div>
<div class="ttc" id="a02261_html_a8059550dde3ea391b347d9133c2725db"><div class="ttname"><a href="../../d7/d24/a02261.html#a8059550dde3ea391b347d9133c2725db">SEF_AVOID_OWNER_CHECK</a></div><div class="ttdeci">#define SEF_AVOID_OWNER_CHECK</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00923">nturtl.h:923</a></div></div>
<div class="ttc" id="a01624_html"><div class="ttname"><a href="../../de/df9/a01624.html">_SID</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00251">ntseapi.h:251</a></div></div>
<div class="ttc" id="a02230_html_a284f59a7515ae016d59a07190930d155"><div class="ttname"><a href="../../dd/d67/a02230.html#a284f59a7515ae016d59a07190930d155">ARGUMENT_PRESENT</a></div><div class="ttdeci">#define ARGUMENT_PRESENT(ArgumentPointer)    </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01313">ntdef.h:1313</a></div></div>
<div class="ttc" id="a02260_html_afd3e0a22edbce2392a2a0ef70ee123cd"><div class="ttname"><a href="../../dc/d18/a02260.html#afd3e0a22edbce2392a2a0ef70ee123cd">STATUS_INVALID_OWNER</a></div><div class="ttdeci">#define STATUS_INVALID_OWNER</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02350">ntstatus.h:2350</a></div></div>
<div class="ttc" id="a02259_html_a61cf327633d2a19c13477bda23e517ad"><div class="ttname"><a href="../../d3/d3a/a02259.html#a61cf327633d2a19c13477bda23e517ad">PISECURITY_DESCRIPTOR</a></div><div class="ttdeci">struct _SECURITY_DESCRIPTOR * PISECURITY_DESCRIPTOR</div></div>
<div class="ttc" id="a02260_html_a708fc4ea0c51a0fe9b07f924b2e0d0dd"><div class="ttname"><a href="../../dc/d18/a02260.html#a708fc4ea0c51a0fe9b07f924b2e0d0dd">STATUS_NOT_ALL_ASSIGNED</a></div><div class="ttdeci">#define STATUS_NOT_ALL_ASSIGNED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l00250">ntstatus.h:250</a></div></div>
<div class="ttc" id="a02284_html_a4fdfa8d06c067debced0c6e8bad60563"><div class="ttname"><a href="../../d3/d81/a02284.html#a4fdfa8d06c067debced0c6e8bad60563">SeCaptureSubjectContext</a></div><div class="ttdeci">NTKERNELAPI VOID SeCaptureSubjectContext(__out PSECURITY_SUBJECT_CONTEXT SubjectContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00043">subject.c:43</a></div></div>
<div class="ttc" id="a02306_html_a98143de0e4dda2c2461e9003f8945ed4"><div class="ttname"><a href="../../d3/dc5/a02306.html#a98143de0e4dda2c2461e9003f8945ed4">SEC_E_MESSAGE_ALTERED</a></div><div class="ttdeci">#define SEC_E_MESSAGE_ALTERED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22460">winerror.h:22460</a></div></div>
<div class="ttc" id="a02256_html_ad7275b209e70848b5ee23af762a1ed5e"><div class="ttname"><a href="../../de/dc3/a02256.html#ad7275b209e70848b5ee23af762a1ed5e">RtlFirstFreeAce</a></div><div class="ttdeci">NTSYSAPI BOOLEAN NTAPI RtlFirstFreeAce(PACL Acl, PVOID *FirstFree)</div></div>
<div class="ttc" id="a01589_html_ae0193db9a6f380415db53c5bc702b4e3"><div class="ttname"><a href="../../d7/d29/a01589.html#ae0193db9a6f380415db53c5bc702b4e3">_SECURITY_QUALITY_OF_SERVICE::ImpersonationLevel</a></div><div class="ttdeci">SECURITY_IMPERSONATION_LEVEL ImpersonationLevel</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01709">ntseapi.h:1709</a></div></div>
<div class="ttc" id="a02260_html_a8eb3559683e7c3ce95f24c1088698bd4"><div class="ttname"><a href="../../dc/d18/a02260.html#a8eb3559683e7c3ce95f24c1088698bd4">STATUS_INVALID_SECURITY_DESCR</a></div><div class="ttdeci">#define STATUS_INVALID_SECURITY_DESCR</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02631">ntstatus.h:2631</a></div></div>
<div class="ttc" id="a02184_html_a59fe6f7d78d70b911cd477e39a102b12"><div class="ttname"><a href="../../d5/ddd/a02184.html#a59fe6f7d78d70b911cd477e39a102b12">ExAllocatePoolWithTag</a></div><div class="ttdeci">#define ExAllocatePoolWithTag(a, b, c)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/ddd/a02184_source.html#l00258">ex.h:258</a></div></div>
<div class="ttc" id="a02184_html_a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1"><div class="ttname"><a href="../../d5/ddd/a02184.html#a32a1467b2542bf2a6384f6fc19953bddae0942a3b0a37bffc44d7b2d63e116ef1">PagedPool</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/ddd/a02184_source.html#l00106">ex.h:106</a></div></div>
<div class="ttc" id="a02665_html_aeb094dbbef491e36813859d691e28472"><div class="ttname"><a href="../../d3/d32/a02665.html#aeb094dbbef491e36813859d691e28472">RtlpComputeMergedAcl</a></div><div class="ttdeci">NTSTATUS RtlpComputeMergedAcl(IN PACL CurrentAcl, IN ULONG CurrentGenericControl, IN PACL ModificationAcl, IN ULONG ModificationGenericControl, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, OUT PACL *NewAcl, OUT PULONG NewGenericControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l05846">sertl.c:5846</a></div></div>
<div class="ttc" id="a02665_html_afb2c886bd235999ca11436eb7b2d7f37"><div class="ttname"><a href="../../d3/d32/a02665.html#afb2c886bd235999ca11436eb7b2d7f37">RtlEqualSid</a></div><div class="ttdeci">BOOLEAN RtlEqualSid(IN PSID Sid1, IN PSID Sid2)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00878">sertl.c:878</a></div></div>
<div class="ttc" id="a02230_html_a7f319bfc2492a2136964194204e7a8cf"><div class="ttname"><a href="../../dd/d67/a02230.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a></div><div class="ttdeci">#define VOID</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00288">ntdef.h:288</a></div></div>
<div class="ttc" id="a02665_html_a33f46ef50693a7e87038c3bdb4990aaa"><div class="ttname"><a href="../../d3/d32/a02665.html#a33f46ef50693a7e87038c3bdb4990aaa">RtlpCompareKnownAces</a></div><div class="ttdeci">BOOLEAN RtlpCompareKnownAces(IN PKNOWN_ACE InheritedAce, IN PKNOWN_ACE ChildAce, IN PSID OwnerSid OPTIONAL, IN PSID GroupSid OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06557">sertl.c:6557</a></div></div>
<div class="ttc" id="a02230_html_aadbc71070481af70d016fda17ea87109"><div class="ttname"><a href="../../dd/d67/a02230.html#aadbc71070481af70d016fda17ea87109">UNALIGNED</a></div><div class="ttdeci">#define UNALIGNED</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00072">ntdef.h:72</a></div></div>
<div class="ttc" id="a02230_html_a81b21cd8bf111de2c2c66bb07c1d2654"><div class="ttname"><a href="../../dd/d67/a02230.html#a81b21cd8bf111de2c2c66bb07c1d2654">ANYSIZE_ARRAY</a></div><div class="ttdeci">#define ANYSIZE_ARRAY</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00051">ntdef.h:51</a></div></div>
<div class="ttc" id="a02253_html_a65780912cd4fb95e0089374e5a58e603a76474afacf68326759d287ada0de8afa"><div class="ttname"><a href="../../db/d7a/a02253.html#a65780912cd4fb95e0089374e5a58e603a76474afacf68326759d287ada0de8afa">ThreadImpersonationToken</a></div><div class="ttdef"><b>Definition:</b> <a href="../../db/d7a/a02253_source.html#l00480">ntpsapi.h:480</a></div></div>
<div class="ttc" id="a02259_html_a4ef74f2d725a1d8bd1b8d715aef852b9"><div class="ttname"><a href="../../d3/d3a/a02259.html#a4ef74f2d725a1d8bd1b8d715aef852b9">ACCESS_ALLOWED_ACE_TYPE</a></div><div class="ttdeci">#define ACCESS_ALLOWED_ACE_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00700">ntseapi.h:700</a></div></div>
<div class="ttc" id="a02028_html_a92dd13ee5770a55ecb6128f6d8143939"><div class="ttname"><a href="../../db/d68/a02028.html#a92dd13ee5770a55ecb6128f6d8143939">except</a></div><div class="ttdeci">#define except</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d68/a02028_source.html#l00061">WARNING.h:61</a></div></div>
<div class="ttc" id="a02285_html_aaf8953de6e4f7cd6b1e1246959c3b6d8"><div class="ttname"><a href="../../df/d4d/a02285.html#aaf8953de6e4f7cd6b1e1246959c3b6d8">RtlObjectAceObjectType</a></div><div class="ttdeci">#define RtlObjectAceObjectType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00252">seopaque.h:252</a></div></div>
<div class="ttc" id="a02665_html_ab5f13e236f1a3bb478abc2db92920779"><div class="ttname"><a href="../../d3/d32/a02665.html#ab5f13e236f1a3bb478abc2db92920779">RtlIsSystemAceType</a></div><div class="ttdeci">const UCHAR RtlIsSystemAceType[]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00359">sertl.c:359</a></div></div>
<div class="ttc" id="a02306_html_a611b653b57d08ef0e8b6145c5b6e3f58"><div class="ttname"><a href="../../d3/dc5/a02306.html#a611b653b57d08ef0e8b6145c5b6e3f58">SEC_E_NO_AUTHENTICATING_AUTHORITY</a></div><div class="ttdeci">#define SEC_E_NO_AUTHENTICATING_AUTHORITY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22478">winerror.h:22478</a></div></div>
<div class="ttc" id="a02665_html_a795c641f8635fb65e2b54a5ec94f96eb"><div class="ttname"><a href="../../d3/d32/a02665.html#a795c641f8635fb65e2b54a5ec94f96eb">AceFlagsInAce</a></div><div class="ttdeci">#define AceFlagsInAce(_Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06490">sertl.c:6490</a></div></div>
<div class="ttc" id="a02230_html_ad2051345e0b0a20c9c5770f56f75278c"><div class="ttname"><a href="../../dd/d67/a02230.html#ad2051345e0b0a20c9c5770f56f75278c">NTSYSAPI</a></div><div class="ttdeci">#define NTSYSAPI</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00272">ntdef.h:272</a></div></div>
<div class="ttc" id="a01585_html_aedf674c652a73f50f9a896b2497f1409"><div class="ttname"><a href="../../da/de2/a01585.html#aedf674c652a73f50f9a896b2497f1409">_SECURITY_DESCRIPTOR::Control</a></div><div class="ttdeci">SECURITY_DESCRIPTOR_CONTROL Control</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01176">ntseapi.h:1176</a></div></div>
<div class="ttc" id="a02186_html_a3fece785755a75d4c26022cb6f6a7638"><div class="ttname"><a href="../../d5/d4d/a02186.html#a3fece785755a75d4c26022cb6f6a7638">EXCEPTION_EXECUTE_HANDLER</a></div><div class="ttdeci">#define EXCEPTION_EXECUTE_HANDLER</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d4d/a02186_source.html#l00128">excpt.h:128</a></div></div>
<div class="ttc" id="a02259_html_aae9d6ab7cd5bf47b8f418aa9b3693eb3"><div class="ttname"><a href="../../d3/d3a/a02259.html#aae9d6ab7cd5bf47b8f418aa9b3693eb3">SE_SACL_AUTO_INHERIT_REQ</a></div><div class="ttdeci">#define SE_SACL_AUTO_INHERIT_REQ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01067">ntseapi.h:1067</a></div></div>
<div class="ttc" id="a02665_html_a3a634997d7ccb33bc64687fe0eaf3fb0"><div class="ttname"><a href="../../d3/d32/a02665.html#a3a634997d7ccb33bc64687fe0eaf3fb0">RtlpCreateServerAcl</a></div><div class="ttdeci">NTSTATUS RtlpCreateServerAcl(IN PACL Acl, IN BOOLEAN AclUntrusted, IN PSID ServerSid, OUT PACL *ServerAcl, OUT BOOLEAN *ServerAclAllocated)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l08072">sertl.c:8072</a></div></div>
<div class="ttc" id="a00013_html_adcc539ec60449474c83a555f326d3710"><div class="ttname"><a href="../../d7/dd4/a00013.html#adcc539ec60449474c83a555f326d3710">_ACL::AclSize</a></div><div class="ttdeci">USHORT AclSize</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00661">ntseapi.h:661</a></div></div>
<div class="ttc" id="a02230_html_a5fb149be049e9964b63bdd041c1bb130"><div class="ttname"><a href="../../dd/d67/a02230.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a></div><div class="ttdeci">BOOLEAN * PBOOLEAN</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01074">ntdef.h:1074</a></div></div>
<div class="ttc" id="a02665_html_a456d1320fc92eae0407d43dc33e61448"><div class="ttname"><a href="../../d3/d32/a02665.html#a456d1320fc92eae0407d43dc33e61448">RtlCreateSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlCreateSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN ULONG Revision)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01810">sertl.c:1810</a></div></div>
<div class="ttc" id="a02167_html_aa53040d6ed85b65dd0ebc79ced7fd547"><div class="ttname"><a href="../../de/d48/a02167.html#aa53040d6ed85b65dd0ebc79ced7fd547">PtrToUlong</a></div><div class="ttdeci">#define PtrToUlong(p)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d48/a02167_source.html#l00322">basetsd.h:322</a></div></div>
<div class="ttc" id="a02259_html_aee18bff241b40f364f3b09805c029d27"><div class="ttname"><a href="../../d3/d3a/a02259.html#aee18bff241b40f364f3b09805c029d27">COMPOUND_ACE_IMPERSONATION</a></div><div class="ttdeci">#define COMPOUND_ACE_IMPERSONATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00871">ntseapi.h:871</a></div></div>
<div class="ttc" id="a02259_html_ae27969fb295feb91d5951b723325b339"><div class="ttname"><a href="../../d3/d3a/a02259.html#ae27969fb295feb91d5951b723325b339">SID_REVISION</a></div><div class="ttdeci">#define SID_REVISION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00263">ntseapi.h:263</a></div></div>
<div class="ttc" id="a00890_html_a87ba6ddd98dbc6cb4af380e69d31233a"><div class="ttname"><a href="../../d7/d46/a00890.html#a87ba6ddd98dbc6cb4af380e69d31233a">_LUID_AND_ATTRIBUTES::Luid</a></div><div class="ttdeci">LUID Luid</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00199">ntseapi.h:199</a></div></div>
<div class="ttc" id="a02230_html_a327a7264f49955a340d1b07a90e1c62e"><div class="ttname"><a href="../../dd/d67/a02230.html#a327a7264f49955a340d1b07a90e1c62e">InitializeObjectAttributes</a></div><div class="ttdeci">#define InitializeObjectAttributes(p, n, a, r, s)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01237">ntdef.h:1237</a></div></div>
<div class="ttc" id="a02259_html_a067989903b97870422dc2a37d11684f8"><div class="ttname"><a href="../../d3/d3a/a02259.html#a067989903b97870422dc2a37d11684f8">ACL</a></div><div class="ttdeci">struct _ACL ACL</div></div>
<div class="ttc" id="a02665_html_ad777622d13f820696a40076775ea44f8"><div class="ttname"><a href="../../d3/d32/a02665.html#ad777622d13f820696a40076775ea44f8">RtlConvertSidToUnicodeString</a></div><div class="ttdeci">NTSTATUS RtlConvertSidToUnicodeString(PUNICODE_STRING UnicodeString, PSID Sid, BOOLEAN AllocateDestinationString)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01472">sertl.c:1472</a></div></div>
<div class="ttc" id="a01591_html"><div class="ttname"><a href="../../dc/d42/a01591.html">_SECURITY_SUBJECT_CONTEXT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d81/a02284_source.html#l00098">se.h:98</a></div></div>
<div class="ttc" id="a02665_html_a476fa7a3fca096253cc03efda08e091d"><div class="ttname"><a href="../../d3/d32/a02665.html#a476fa7a3fca096253cc03efda08e091d">RtlValidSecurityDescriptor</a></div><div class="ttdeci">BOOLEAN RtlValidSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01931">sertl.c:1931</a></div></div>
<div class="ttc" id="a02285_html_a14f1dd3e862a10584fc2d7a6c197245c"><div class="ttname"><a href="../../df/d4d/a02285.html#a14f1dd3e862a10584fc2d7a6c197245c">ContainerInherit</a></div><div class="ttdeci">#define ContainerInherit(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00207">seopaque.h:207</a></div></div>
<div class="ttc" id="a02259_html_af8a3094a4a40ef8d0e5eee5012e827d4"><div class="ttname"><a href="../../d3/d3a/a02259.html#af8a3094a4a40ef8d0e5eee5012e827d4">SE_DACL_PRESENT</a></div><div class="ttdeci">#define SE_DACL_PRESENT</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01058">ntseapi.h:1058</a></div></div>
<div class="ttc" id="a02700_html_a4c90199d4212712e0e4f06f9e7f580ac"><div class="ttname"><a href="../../dd/dee/a02700.html#a4c90199d4212712e0e4f06f9e7f580ac">SepValidOwnerSubjectContext</a></div><div class="ttdeci">BOOLEAN SepValidOwnerSubjectContext(IN PSECURITY_SUBJECT_CONTEXT SubjectContext, IN PSID Owner, IN BOOLEAN ServerObject)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00467">subject.c:467</a></div></div>
<div class="ttc" id="a02665_html_af55de731f3daac1ea87ea3ef7737e1ee"><div class="ttname"><a href="../../d3/d32/a02665.html#af55de731f3daac1ea87ea3ef7737e1ee">RtlGetGroupSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlGetGroupSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSID *Group, OUT PBOOLEAN GroupDefaulted)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02976">sertl.c:2976</a></div></div>
<div class="ttc" id="a02291_html"><div class="ttname"><a href="../../dd/d3b/a02291.html">stdio.h</a></div></div>
<div class="ttc" id="a02259_html_ad8484c25c05e8046dfd6bc7b360681ad"><div class="ttname"><a href="../../d3/d3a/a02259.html#ad8484c25c05e8046dfd6bc7b360681ad">SE_RM_CONTROL_VALID</a></div><div class="ttdeci">#define SE_RM_CONTROL_VALID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01072">ntseapi.h:1072</a></div></div>
<div class="ttc" id="a02286_html_a80786fbc3ae2fb6380d05a2758ceab4f"><div class="ttname"><a href="../../db/d2d/a02286.html#a80786fbc3ae2fb6380d05a2758ceab4f">RtlpSubAuthoritySid</a></div><div class="ttdeci">FORCEINLINE PULONG RtlpSubAuthoritySid(IN PSID Sid, IN ULONG SubAuthority)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00294">sertlp.h:294</a></div></div>
<div class="ttc" id="a02665_html_ae339b2cd57aa94d6bf571d636418c02a"><div class="ttname"><a href="../../d3/d32/a02665.html#ae339b2cd57aa94d6bf571d636418c02a">RtlCopyLuid</a></div><div class="ttdeci">VOID RtlCopyLuid(OUT PLUID DestinationLuid, IN PLUID SourceLuid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01728">sertl.c:1728</a></div></div>
<div class="ttc" id="a02656_html"><div class="ttname"><a href="../../d2/d7d/a02656.html">ntrtlp.h</a></div></div>
<div class="ttc" id="a02256_html_abe972030403da31994eecb16d6f7d1b9"><div class="ttname"><a href="../../de/dc3/a02256.html#abe972030403da31994eecb16d6f7d1b9">RtlFreeUnicodeString</a></div><div class="ttdeci">NTSYSAPI VOID NTAPI RtlFreeUnicodeString(PUNICODE_STRING UnicodeString)</div></div>
<div class="ttc" id="a01585_html_a04d07191f19edda54e63353837a588a7"><div class="ttname"><a href="../../da/de2/a01585.html#a04d07191f19edda54e63353837a588a7">_SECURITY_DESCRIPTOR::Revision</a></div><div class="ttdeci">UCHAR Revision</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01174">ntseapi.h:1174</a></div></div>
<div class="ttc" id="a02665_html_a241df3175fd3fde04d9808fa527729eb"><div class="ttname"><a href="../../d3/d32/a02665.html#a241df3175fd3fde04d9808fa527729eb">RtlGetControlSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlGetControlSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSECURITY_DESCRIPTOR_CONTROL Control, OUT PULONG Revision)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02159">sertl.c:2159</a></div></div>
<div class="ttc" id="a02259_html_a279babfff7df280bed29afa27c3bc27c"><div class="ttname"><a href="../../d3/d3a/a02259.html#a279babfff7df280bed29afa27c3bc27c">TOKEN_DUPLICATE</a></div><div class="ttdeci">#define TOKEN_DUPLICATE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01470">ntseapi.h:1470</a></div></div>
<div class="ttc" id="a02260_html_a1b28d9f0fc2ca4517f6c0606efb4e0f5"><div class="ttname"><a href="../../dc/d18/a02260.html#a1b28d9f0fc2ca4517f6c0606efb4e0f5">STATUS_NO_INHERITANCE</a></div><div class="ttdeci">#define STATUS_NO_INHERITANCE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01141">ntstatus.h:1141</a></div></div>
<div class="ttc" id="a02167_html_af8429def935ee9a571d3e6dfffc3e790"><div class="ttname"><a href="../../de/d48/a02167.html#af8429def935ee9a571d3e6dfffc3e790">SIZE_T</a></div><div class="ttdeci">ULONG_PTR SIZE_T</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d48/a02167_source.html#l00400">basetsd.h:400</a></div></div>
<div class="ttc" id="a00521_html"><div class="ttname"><a href="../../d7/def/a00521.html">_GENERIC_MAPPING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00174">ntseapi.h:174</a></div></div>
<div class="ttc" id="a02259_html_abfbebcb07a24f698a6c04b3bc0ad32f4"><div class="ttname"><a href="../../d3/d3a/a02259.html#abfbebcb07a24f698a6c04b3bc0ad32f4">SE_GROUP_DEFAULTED</a></div><div class="ttdeci">#define SE_GROUP_DEFAULTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01057">ntseapi.h:1057</a></div></div>
<div class="ttc" id="a02285_html_a1c9d14bdc1c9ada63f83e93e328be84b"><div class="ttname"><a href="../../df/d4d/a02285.html#a1c9d14bdc1c9ada63f83e93e328be84b">LongAlignSize</a></div><div class="ttdeci">#define LongAlignSize(Size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00096">seopaque.h:96</a></div></div>
<div class="ttc" id="a02665_html_a8fed5f76147b0dcc56e7926a15807990"><div class="ttname"><a href="../../d3/d32/a02665.html#a8fed5f76147b0dcc56e7926a15807990">RtlpGetDefaultsSubjectContext</a></div><div class="ttdeci">NTSTATUS RtlpGetDefaultsSubjectContext(HANDLE ClientToken, OUT PTOKEN_OWNER *OwnerInfo, OUT PTOKEN_PRIMARY_GROUP *GroupInfo, OUT PTOKEN_DEFAULT_DACL *DefaultDaclInfo, OUT PTOKEN_OWNER *ServerOwner, OUT PTOKEN_PRIMARY_GROUP *ServerGroup)</div></div>
<div class="ttc" id="a02665_html_a33acc19d2faa9d67df8294de0bbced58"><div class="ttname"><a href="../../d3/d32/a02665.html#a33acc19d2faa9d67df8294de0bbced58">RtlpNewSecurityObject</a></div><div class="ttdeci">NTSTATUS RtlpNewSecurityObject(IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor, IN GUID **pObjectType OPTIONAL, IN ULONG GuidCount, IN BOOLEAN IsDirectoryObject, IN ULONG AutoInheritFlags, IN HANDLE Token OPTIONAL, IN PGENERIC_MAPPING GenericMapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l08275">sertl.c:8275</a></div></div>
<div class="ttc" id="a02285_html_a5a0c3b46354580362b32e0f209b6da8d"><div class="ttname"><a href="../../df/d4d/a02285.html#a5a0c3b46354580362b32e0f209b6da8d">KNOWN_COMPOUND_ACE</a></div><div class="ttdeci">struct _KNOWN_COMPOUND_ACE KNOWN_COMPOUND_ACE</div></div>
<div class="ttc" id="a00789_html_a9450127a482353aab68a324d87e36b88"><div class="ttname"><a href="../../d8/d7d/a00789.html#a9450127a482353aab68a324d87e36b88">_KNOWN_ACE::Mask</a></div><div class="ttdeci">ACCESS_MASK Mask</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00039">seopaque.h:39</a></div></div>
<div class="ttc" id="a02285_html_ada772d88133c0c4f43ef15b685f17944"><div class="ttname"><a href="../../df/d4d/a02285.html#ada772d88133c0c4f43ef15b685f17944">IsV4AceType</a></div><div class="ttdeci">#define IsV4AceType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00166">seopaque.h:166</a></div></div>
<div class="ttc" id="a02306_html_a3896ec4b73f3568b9c393dca63de8abc"><div class="ttname"><a href="../../d3/dc5/a02306.html#a3896ec4b73f3568b9c393dca63de8abc">SEC_E_INTERNAL_ERROR</a></div><div class="ttdeci">#define SEC_E_INTERNAL_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22361">winerror.h:22361</a></div></div>
<div class="ttc" id="a01585_html_a70c93c5c3fa5b26ae1cee641896d9b0e"><div class="ttname"><a href="../../da/de2/a01585.html#a70c93c5c3fa5b26ae1cee641896d9b0e">_SECURITY_DESCRIPTOR::Owner</a></div><div class="ttdeci">PSID Owner</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01177">ntseapi.h:1177</a></div></div>
<div class="ttc" id="a02260_html_a821aeaec567da53a136174d941ca2e7d"><div class="ttname"><a href="../../dc/d18/a02260.html#a821aeaec567da53a136174d941ca2e7d">STATUS_NO_MEMORY</a></div><div class="ttdeci">#define STATUS_NO_MEMORY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01735">ntstatus.h:1735</a></div></div>
<div class="ttc" id="a02147_html_a0f50d1e6e2813033b8aea6e7912f1c7d"><div class="ttname"><a href="../../d3/d28/a02147.html#a0f50d1e6e2813033b8aea6e7912f1c7d">LongAlign</a></div><div class="ttdeci">#define LongAlign(Ptr)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d28/a02147_source.html#l00198">fsrtlp.h:198</a></div></div>
<div class="ttc" id="a01589_html_a3501dda7ede19670b2b46138cc82707f"><div class="ttname"><a href="../../d7/d29/a01589.html#a3501dda7ede19670b2b46138cc82707f">_SECURITY_QUALITY_OF_SERVICE::ContextTrackingMode</a></div><div class="ttdeci">SECURITY_CONTEXT_TRACKING_MODE ContextTrackingMode</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01710">ntseapi.h:1710</a></div></div>
<div class="ttc" id="a02261_html_ab31f4c0fab101f20d852eb7b68b57cd4"><div class="ttname"><a href="../../d7/d24/a02261.html#ab31f4c0fab101f20d852eb7b68b57cd4">SEF_SACL_AUTO_INHERIT</a></div><div class="ttdeci">#define SEF_SACL_AUTO_INHERIT</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00920">nturtl.h:920</a></div></div>
<div class="ttc" id="a02244_html_a1eba21559f17793c695f34f7e4787604"><div class="ttname"><a href="../../d8/d51/a02244.html#a1eba21559f17793c695f34f7e4787604">Length</a></div><div class="ttdeci">IN ULONG Length</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d51/a02244_source.html#l01051">ntlsa.h:1051</a></div></div>
<div class="ttc" id="a02259_html_a72b025cb2be68de4fd11bdb82c21fd96"><div class="ttname"><a href="../../d3/d3a/a02259.html#a72b025cb2be68de4fd11bdb82c21fd96">SE_SACL_AUTO_INHERITED</a></div><div class="ttdeci">#define SE_SACL_AUTO_INHERITED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01069">ntseapi.h:1069</a></div></div>
<div class="ttc" id="a02665_html_a8a2144d239d6afa124e5ec59e2eb9e19"><div class="ttname"><a href="../../d3/d32/a02665.html#a8a2144d239d6afa124e5ec59e2eb9e19">RtlpConvertToAutoInheritSecurityObject</a></div><div class="ttdeci">NTSTATUS RtlpConvertToAutoInheritSecurityObject(IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CurrentSecurityDescriptor, OUT PSECURITY_DESCRIPTOR *NewSecurityDescriptor, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN PGENERIC_MAPPING GenericMapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06077">sertl.c:6077</a></div></div>
<div class="ttc" id="a02256_html_a6c25a490b42cfa68e593014c864424c8"><div class="ttname"><a href="../../de/dc3/a02256.html#a6c25a490b42cfa68e593014c864424c8">RtlEqualMemory</a></div><div class="ttdeci">#define RtlEqualMemory(Destination, Source, Length)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l04264">ntrtl.h:4264</a></div></div>
<div class="ttc" id="a02285_html_a6394e76cf8cc1201405fdb6ae899d8dd"><div class="ttname"><a href="../../df/d4d/a02285.html#a6394e76cf8cc1201405fdb6ae899d8dd">IsObjectAceType</a></div><div class="ttdeci">#define IsObjectAceType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00191">seopaque.h:191</a></div></div>
<div class="ttc" id="a02665_html_aaa71d897407ea439b802831ac5128bf4"><div class="ttname"><a href="../../d3/d32/a02665.html#aaa71d897407ea439b802831ac5128bf4">RtlRunDecodeUnicodeString</a></div><div class="ttdeci">VOID RtlRunDecodeUnicodeString(UCHAR Seed, PUNICODE_STRING String)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00540">sertl.c:540</a></div></div>
<div class="ttc" id="a02259_html_a8d2e2b23032684e99009ac3a7410aec4ab1f63b56b600d07b198c87bac55261fb"><div class="ttname"><a href="../../d3/d3a/a02259.html#a8d2e2b23032684e99009ac3a7410aec4ab1f63b56b600d07b198c87bac55261fb">TokenUser</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01526">ntseapi.h:1526</a></div></div>
<div class="ttc" id="a02260_html_afea71f62fd3e29097dd31a4e813612b8"><div class="ttname"><a href="../../dc/d18/a02260.html#afea71f62fd3e29097dd31a4e813612b8">STATUS_NO_SUCH_PACKAGE</a></div><div class="ttdeci">#define STATUS_NO_SUCH_PACKAGE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03868">ntstatus.h:3868</a></div></div>
<div class="ttc" id="a01776_html"><div class="ttname"><a href="../../dd/d00/a01776.html">_UNICODE_STRING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01043">ntdef.h:1043</a></div></div>
<div class="ttc" id="a01747_html"><div class="ttname"><a href="../../d7/db4/a01747.html">_TOKEN_PRIVILEGES</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01561">ntseapi.h:1561</a></div></div>
<div class="ttc" id="a02665_html_a70d8fb41bc0b1d3142319b0b9d6bccec"><div class="ttname"><a href="../../d3/d32/a02665.html#a70d8fb41bc0b1d3142319b0b9d6bccec">RtlCopySid</a></div><div class="ttdeci">NTSTATUS RtlCopySid(IN ULONG DestinationSidLength, OUT PSID DestinationSid, IN PSID SourceSid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01241">sertl.c:1241</a></div></div>
<div class="ttc" id="a02665_html_a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc"><div class="ttname"><a href="../../d3/d32/a02665.html#a6e033b81eaae1f1acdf292ab3214a3f2a06ed8144bb917116a4c20a845f2a9cfc">CopyInheritedAces</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00071">sertl.c:71</a></div></div>
<div class="ttc" id="a02665_html_a4463c888f291f366516bb8843732a9a6"><div class="ttname"><a href="../../d3/d32/a02665.html#a4463c888f291f366516bb8843732a9a6">RtlMapGenericMask</a></div><div class="ttdeci">VOID RtlMapGenericMask(IN OUT PACCESS_MASK AccessMask, IN PGENERIC_MAPPING GenericMapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03125">sertl.c:3125</a></div></div>
<div class="ttc" id="a02259_html_a05913ec4024dd593dae39d59269e365f"><div class="ttname"><a href="../../d3/d3a/a02259.html#a05913ec4024dd593dae39d59269e365f">CONTAINER_INHERIT_ACE</a></div><div class="ttdeci">#define CONTAINER_INHERIT_ACE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00741">ntseapi.h:741</a></div></div>
<div class="ttc" id="a02285_html_a2739a37915edd332226ecc507d08067d"><div class="ttname"><a href="../../df/d4d/a02285.html#a2739a37915edd332226ecc507d08067d">SeControlGenericToSacl</a></div><div class="ttdeci">#define SeControlGenericToSacl(_Generic)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00305">seopaque.h:305</a></div></div>
<div class="ttc" id="a01587_html_a084c1aff512c7521374babc4823b237e"><div class="ttname"><a href="../../d6/d91/a01587.html#a084c1aff512c7521374babc4823b237e">_SECURITY_DESCRIPTOR_RELATIVE::Control</a></div><div class="ttdeci">SECURITY_DESCRIPTOR_CONTROL Control</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01166">ntseapi.h:1166</a></div></div>
<div class="ttc" id="a02230_html_aa8c0374618b33785ccb02f74bcfebc46"><div class="ttname"><a href="../../dd/d67/a02230.html#aa8c0374618b33785ccb02f74bcfebc46">HANDLE</a></div><div class="ttdeci">void * HANDLE</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00424">ntdef.h:424</a></div></div>
<div class="ttc" id="a01235_html"><div class="ttname"><a href="../../dd/dad/a01235.html">_OBJECT_ATTRIBUTES</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01213">ntdef.h:1213</a></div></div>
<div class="ttc" id="a02230_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="../../dd/d67/a02230.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01263">ntdef.h:1263</a></div></div>
<div class="ttc" id="a02261_html_a9516e3561b7fb36a8b060127348f450b"><div class="ttname"><a href="../../d7/d24/a02261.html#a9516e3561b7fb36a8b060127348f450b">SEF_DEFAULT_GROUP_FROM_PARENT</a></div><div class="ttdeci">#define SEF_DEFAULT_GROUP_FROM_PARENT</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00925">nturtl.h:925</a></div></div>
<div class="ttc" id="a02259_html_aefb952e8802062a4ebab626444d3f82d"><div class="ttname"><a href="../../d3/d3a/a02259.html#aefb952e8802062a4ebab626444d3f82d">INHERITED_ACE</a></div><div class="ttdeci">#define INHERITED_ACE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00744">ntseapi.h:744</a></div></div>
<div class="ttc" id="a01747_html_aa6fc51dcc5ae40ab50c8e1e78620d578"><div class="ttname"><a href="../../d7/db4/a01747.html#aa6fc51dcc5ae40ab50c8e1e78620d578">_TOKEN_PRIVILEGES::PrivilegeCount</a></div><div class="ttdeci">ULONG PrivilegeCount</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01562">ntseapi.h:1562</a></div></div>
<div class="ttc" id="a02259_html_a3cb6b2ed9abea1f641f5c05f14eb9d2c"><div class="ttname"><a href="../../d3/d3a/a02259.html#a3cb6b2ed9abea1f641f5c05f14eb9d2c">NtOpenThreadToken</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtOpenThreadToken(__in HANDLE ThreadHandle, __in ACCESS_MASK DesiredAccess, __in BOOLEAN OpenAsSelf, __out PHANDLE TokenHandle)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc1/a02706_source.html#l00489">tokenopn.c:489</a></div></div>
<div class="ttc" id="a02256_html_a09632371bc84fad1dbde91977154b1d8"><div class="ttname"><a href="../../de/dc3/a02256.html#a09632371bc84fad1dbde91977154b1d8">RtlLargeIntegerToUnicode</a></div><div class="ttdeci">NTSYSAPI NTSTATUS NTAPI RtlLargeIntegerToUnicode(IN PLARGE_INTEGER Value, IN ULONG Base OPTIONAL, IN LONG OutputLength, OUT PWSTR String)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d70/a02629_source.html#l00535">cnvint.c:535</a></div></div>
<div class="ttc" id="a02286_html_ac4869f77a683277682d7629dbc3d6198"><div class="ttname"><a href="../../db/d2d/a02286.html#ac4869f77a683277682d7629dbc3d6198">RtlpPropagateControlBits</a></div><div class="ttdeci">#define RtlpPropagateControlBits(NewSD, OldSD, Bits)                                                      </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00115">sertlp.h:115</a></div></div>
<div class="ttc" id="a02259_html_af6b2d90a83069813c4ffab10f943a36f"><div class="ttname"><a href="../../d3/d3a/a02259.html#af6b2d90a83069813c4ffab10f943a36f">SECURITY_DYNAMIC_TRACKING</a></div><div class="ttdeci">#define SECURITY_DYNAMIC_TRACKING</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01695">ntseapi.h:1695</a></div></div>
<div class="ttc" id="a02260_html_a15d6ef056327bd65c90d4794d1729ba1"><div class="ttname"><a href="../../dc/d18/a02260.html#a15d6ef056327bd65c90d4794d1729ba1">STATUS_UNKNOWN_REVISION</a></div><div class="ttdeci">#define STATUS_UNKNOWN_REVISION</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02332">ntstatus.h:2332</a></div></div>
<div class="ttc" id="a02665_html_a79bfbf3d5f194239a70e703aa23d78ae"><div class="ttname"><a href="../../d3/d32/a02665.html#a79bfbf3d5f194239a70e703aa23d78ae">RtlCopySidAndAttributesArray</a></div><div class="ttdeci">NTSTATUS RtlCopySidAndAttributesArray(IN ULONG ArrayLength, IN PSID_AND_ATTRIBUTES Source, IN ULONG TargetSidBufferSize, OUT PSID_AND_ATTRIBUTES TargetArrayElement, OUT PSID TargetSid, OUT PSID *NextTargetSid, OUT PULONG RemainingTargetSidBufferSize)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01297">sertl.c:1297</a></div></div>
<div class="ttc" id="a02249_html_a425eea3f57239dc3a8b77669eba3ca97"><div class="ttname"><a href="../../dd/dc3/a02249.html#a425eea3f57239dc3a8b77669eba3ca97">KPROCESSOR_MODE</a></div><div class="ttdeci">CCHAR KPROCESSOR_MODE</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dc3/a02249_source.html#l00124">ntosdef.h:124</a></div></div>
<div class="ttc" id="a01626_html_af20114433ef94ae999cbd2b8c9ec6b4b"><div class="ttname"><a href="../../dd/d90/a01626.html#af20114433ef94ae999cbd2b8c9ec6b4b">_SID_IDENTIFIER_AUTHORITY::Value</a></div><div class="ttdeci">UCHAR Value[6]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00244">ntseapi.h:244</a></div></div>
<div class="ttc" id="a02260_html_a62f33d4e46ad5b4ca3e889ded4c0f7a1"><div class="ttname"><a href="../../dc/d18/a02260.html#a62f33d4e46ad5b4ca3e889ded4c0f7a1">STATUS_PRIVILEGE_NOT_HELD</a></div><div class="ttdeci">#define STATUS_PRIVILEGE_NOT_HELD</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02413">ntstatus.h:2413</a></div></div>
<div class="ttc" id="a00817_html_a9b8939bdf30481e7477d6094c107e65b"><div class="ttname"><a href="../../dc/d5e/a00817.html#a9b8939bdf30481e7477d6094c107e65b">_LARGE_INTEGER::HighPart</a></div><div class="ttdeci">LONG HighPart</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00673">ntdef.h:673</a></div></div>
<div class="ttc" id="a02306_html_a93053278fb0a1a2881b9318ceb5d001f"><div class="ttname"><a href="../../d3/dc5/a02306.html#a93053278fb0a1a2881b9318ceb5d001f">SEC_E_CANNOT_PACK</a></div><div class="ttdeci">#define SEC_E_CANNOT_PACK</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22406">winerror.h:22406</a></div></div>
<div class="ttc" id="a01750_html"><div class="ttname"><a href="../../dc/d3a/a01750.html">_TOKEN_USER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01551">ntseapi.h:1551</a></div></div>
<div class="ttc" id="a02665_html_a8fbf1693d548969e3053c0f2d8bce1ca"><div class="ttname"><a href="../../d3/d32/a02665.html#a8fbf1693d548969e3053c0f2d8bce1ca">RtlValidSid</a></div><div class="ttdeci">BOOLEAN RtlValidSid(IN PSID Sid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00830">sertl.c:830</a></div></div>
<div class="ttc" id="a02259_html_a003d67b3544da7d511ed48f876e2cfc7"><div class="ttname"><a href="../../d3/d3a/a02259.html#a003d67b3544da7d511ed48f876e2cfc7">VALID_INHERIT_FLAGS</a></div><div class="ttdeci">#define VALID_INHERIT_FLAGS</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00745">ntseapi.h:745</a></div></div>
<div class="ttc" id="a02286_html_a1ae5ed7f5a2f3d50dc653c7d1e9de539"><div class="ttname"><a href="../../db/d2d/a02286.html#a1ae5ed7f5a2f3d50dc653c7d1e9de539">RtlpGroupAddrSecurityDescriptor</a></div><div class="ttdeci">#define RtlpGroupAddrSecurityDescriptor(SD)                                                                </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00067">sertlp.h:67</a></div></div>
<div class="ttc" id="a02665_html_a6279bc5bce1ac234f1c5c921f581508d"><div class="ttname"><a href="../../d3/d32/a02665.html#a6279bc5bce1ac234f1c5c921f581508d">SE_VALID_CONTROL_BITS</a></div><div class="ttdeci">#define SE_VALID_CONTROL_BITS</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00375">sertl.c:375</a></div></div>
<div class="ttc" id="a02306_html_a58fe53f536c879511669395419737eff"><div class="ttname"><a href="../../d3/dc5/a02306.html#a58fe53f536c879511669395419737eff">SEC_E_NO_IMPERSONATION</a></div><div class="ttdeci">#define SEC_E_NO_IMPERSONATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22424">winerror.h:22424</a></div></div>
<div class="ttc" id="a01585_html_a0c558ea93c3789c077e444ae677f4d6e"><div class="ttname"><a href="../../da/de2/a01585.html#a0c558ea93c3789c077e444ae677f4d6e">_SECURITY_DESCRIPTOR::Sacl</a></div><div class="ttdeci">PACL Sacl</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01179">ntseapi.h:1179</a></div></div>
<div class="ttc" id="a02665_html_a596dac518bdbca2e54a67c2e1d8b5f14"><div class="ttname"><a href="../../d3/d32/a02665.html#a596dac518bdbca2e54a67c2e1d8b5f14">RtlSubAuthoritySid</a></div><div class="ttdeci">PULONG RtlSubAuthoritySid(IN PSID Sid, IN ULONG SubAuthority)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01147">sertl.c:1147</a></div></div>
<div class="ttc" id="a01587_html_aa24ad3c48067e3f489f174c08beebdb4"><div class="ttname"><a href="../../d6/d91/a01587.html#aa24ad3c48067e3f489f174c08beebdb4">_SECURITY_DESCRIPTOR_RELATIVE::Group</a></div><div class="ttdeci">ULONG Group</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01168">ntseapi.h:1168</a></div></div>
<div class="ttc" id="a02284_html_a2d307979d30aaaa35f263e78b6503fe0"><div class="ttname"><a href="../../d3/d81/a02284.html#a2d307979d30aaaa35f263e78b6503fe0">SeLockSubjectContext</a></div><div class="ttdeci">NTKERNELAPI VOID SeLockSubjectContext(__in PSECURITY_SUBJECT_CONTEXT SubjectContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00180">subject.c:180</a></div></div>
<div class="ttc" id="a02259_html_aa9234d5266db94ea655ac6bd3ced3319"><div class="ttname"><a href="../../d3/d3a/a02259.html#aa9234d5266db94ea655ac6bd3ced3319">SECURITY_CREATOR_OWNER_RID</a></div><div class="ttdeci">#define SECURITY_CREATOR_OWNER_RID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00323">ntseapi.h:323</a></div></div>
<div class="ttc" id="a02259_html_a97ad0204224abe93ef689dbe8ebabc36"><div class="ttname"><a href="../../d3/d3a/a02259.html#a97ad0204224abe93ef689dbe8ebabc36">SECURITY_CREATOR_OWNER_SERVER_RID</a></div><div class="ttdeci">#define SECURITY_CREATOR_OWNER_SERVER_RID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00326">ntseapi.h:326</a></div></div>
<div class="ttc" id="a02259_html_ac9f266100c326d2388dd176464c917cc"><div class="ttname"><a href="../../d3/d3a/a02259.html#ac9f266100c326d2388dd176464c917cc">LUID_AND_ATTRIBUTES</a></div><div class="ttdeci">struct _LUID_AND_ATTRIBUTES LUID_AND_ATTRIBUTES</div></div>
<div class="ttc" id="a02665_html_ab9171b7f154370c640a57546f3df5c8f"><div class="ttname"><a href="../../d3/d32/a02665.html#ab9171b7f154370c640a57546f3df5c8f">RtlBaseAceType</a></div><div class="ttdeci">const UCHAR RtlBaseAceType[]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00343">sertl.c:343</a></div></div>
<div class="ttc" id="a02285_html_a8f356589d2c645df49484357ca1ae9b1"><div class="ttname"><a href="../../df/d4d/a02285.html#a8f356589d2c645df49484357ca1ae9b1">SEP_ACL_AUTO_INHERITED</a></div><div class="ttdeci">#define SEP_ACL_AUTO_INHERITED</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00284">seopaque.h:284</a></div></div>
<div class="ttc" id="a02260_html_a1cc0388869628f7245cb8134faa7257c"><div class="ttname"><a href="../../dc/d18/a02260.html#a1cc0388869628f7245cb8134faa7257c">STATUS_BAD_DESCRIPTOR_FORMAT</a></div><div class="ttdeci">#define STATUS_BAD_DESCRIPTOR_FORMAT</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03652">ntstatus.h:3652</a></div></div>
<div class="ttc" id="a02285_html_a044a6ce7a3a5f71322a2cfb360ac104d"><div class="ttname"><a href="../../df/d4d/a02285.html#a044a6ce7a3a5f71322a2cfb360ac104d">FirstAce</a></div><div class="ttdeci">#define FirstAce(Acl)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00134">seopaque.h:134</a></div></div>
<div class="ttc" id="a02256_html_ab49350da23720546beb60b8054facd9c"><div class="ttname"><a href="../../de/dc3/a02256.html#ab49350da23720546beb60b8054facd9c">ASSERT</a></div><div class="ttdeci">#define ASSERT(exp)              </div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l00286">ntrtl.h:286</a></div></div>
<div class="ttc" id="a01776_html_a3ebb6a85103954fd7fc325ba30c54008"><div class="ttname"><a href="../../dd/d00/a01776.html#a3ebb6a85103954fd7fc325ba30c54008">_UNICODE_STRING::Length</a></div><div class="ttdeci">USHORT Length</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01044">ntdef.h:1044</a></div></div>
<div class="ttc" id="a00890_html_aaa4581db6230461bf219f4e3bc6810c0"><div class="ttname"><a href="../../d7/d46/a00890.html#aaa4581db6230461bf219f4e3bc6810c0">_LUID_AND_ATTRIBUTES::Attributes</a></div><div class="ttdeci">ULONG Attributes</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00200">ntseapi.h:200</a></div></div>
<div class="ttc" id="a02044_html_a8d0307cc6eebba297dba1b97a0a7618e"><div class="ttname"><a href="../../d8/d22/a02044.html#a8d0307cc6eebba297dba1b97a0a7618e">Status</a></div><div class="ttdeci">ULONG Status</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d22/a02044_source.html#l00083">cmchek.c:83</a></div></div>
<div class="ttc" id="a02260_html_a0b8838a698a06fdd7f62c4bd39e00755"><div class="ttname"><a href="../../dc/d18/a02260.html#a0b8838a698a06fdd7f62c4bd39e00755">STATUS_INVALID_HANDLE</a></div><div class="ttdeci">#define STATUS_INVALID_HANDLE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01590">ntstatus.h:1590</a></div></div>
<div class="ttc" id="a01747_html_aefd3533e806f3225e053dda98b31470b"><div class="ttname"><a href="../../d7/db4/a01747.html#aefd3533e806f3225e053dda98b31470b">_TOKEN_PRIVILEGES::Privileges</a></div><div class="ttdeci">LUID_AND_ATTRIBUTES Privileges[ANYSIZE_ARRAY]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01563">ntseapi.h:1563</a></div></div>
<div class="ttc" id="a02260_html_a061ab569ad0e495f99eb4dd005951170"><div class="ttname"><a href="../../dc/d18/a02260.html#a061ab569ad0e495f99eb4dd005951170">STATUS_NO_TOKEN</a></div><div class="ttdeci">#define STATUS_NO_TOKEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02660">ntstatus.h:2660</a></div></div>
<div class="ttc" id="a02260_html_a76144b5198b53ccf2b102bb11b6dd79a"><div class="ttname"><a href="../../dc/d18/a02260.html#a76144b5198b53ccf2b102bb11b6dd79a">STATUS_NO_SUCH_LOGON_SESSION</a></div><div class="ttdeci">#define STATUS_NO_SUCH_LOGON_SESSION</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02395">ntstatus.h:2395</a></div></div>
<div class="ttc" id="a02259_html_abb05f20ab4635bb0f610c0d1d3a42c42"><div class="ttname"><a href="../../d3/d3a/a02259.html#abb05f20ab4635bb0f610c0d1d3a42c42">TOKEN_IMPERSONATE</a></div><div class="ttdeci">#define TOKEN_IMPERSONATE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01471">ntseapi.h:1471</a></div></div>
<div class="ttc" id="a02230_html_a2a3e0cda5f1249bef6db47c5eb8e3813"><div class="ttname"><a href="../../dd/d67/a02230.html#a2a3e0cda5f1249bef6db47c5eb8e3813">LONG</a></div><div class="ttdeci">long LONG</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00291">ntdef.h:291</a></div></div>
<div class="ttc" id="a02256_html_ad3971c6e26e44eb8b7131861a66d1785"><div class="ttname"><a href="../../de/dc3/a02256.html#ad3971c6e26e44eb8b7131861a66d1785">RtlCopyUnicodeString</a></div><div class="ttdeci">NTSYSAPI VOID NTAPI RtlCopyUnicodeString(PUNICODE_STRING DestinationString, PCUNICODE_STRING SourceString)</div></div>
<div class="ttc" id="a00890_html"><div class="ttname"><a href="../../d7/d46/a00890.html">_LUID_AND_ATTRIBUTES</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00198">ntseapi.h:198</a></div></div>
<div class="ttc" id="a00790_html"><div class="ttname"><a href="../../d3/daf/a00790.html">_KNOWN_COMPOUND_ACE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00052">seopaque.h:52</a></div></div>
<div class="ttc" id="a02256_html_a1f06b5cf5a277b5ecd2579b4f1387ca5"><div class="ttname"><a href="../../de/dc3/a02256.html#a1f06b5cf5a277b5ecd2579b4f1387ca5">Buffer</a></div><div class="ttdeci">PVOID Buffer</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l00563">ntrtl.h:563</a></div></div>
<div class="ttc" id="a02665_html_ae8e993c3bb60d9a0e04837b21c2bb45c"><div class="ttname"><a href="../../d3/d32/a02665.html#ae8e993c3bb60d9a0e04837b21c2bb45c">RtlSetGroupSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetGroupSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID Group OPTIONAL, IN BOOLEAN GroupDefaulted OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02879">sertl.c:2879</a></div></div>
<div class="ttc" id="a02665_html_a3f67809168515a00397063627d736340"><div class="ttname"><a href="../../d3/d32/a02665.html#a3f67809168515a00397063627d736340">RtlSetSaclSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetSaclSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN SaclPresent, IN PACL Sacl OPTIONAL, IN BOOLEAN SaclDefaulted OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02500">sertl.c:2500</a></div></div>
<div class="ttc" id="a00013_html_aaac225aa146d75e9a598696c5c02f5f3"><div class="ttname"><a href="../../d7/dd4/a00013.html#aaac225aa146d75e9a598696c5c02f5f3">_ACL::AceCount</a></div><div class="ttdeci">USHORT AceCount</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00662">ntseapi.h:662</a></div></div>
<div class="ttc" id="a02285_html_a05abeb677af8fc66f09ff32c5d3fc1b3"><div class="ttname"><a href="../../df/d4d/a02285.html#a05abeb677af8fc66f09ff32c5d3fc1b3">IsCompoundAceType</a></div><div class="ttdeci">#define IsCompoundAceType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00184">seopaque.h:184</a></div></div>
<div class="ttc" id="a02259_html_ad7d3e853b74bd0e483fa2c6107fb69fd"><div class="ttname"><a href="../../d3/d3a/a02259.html#ad7d3e853b74bd0e483fa2c6107fb69fd">SACL_SECURITY_INFORMATION</a></div><div class="ttdeci">#define SACL_SECURITY_INFORMATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01776">ntseapi.h:1776</a></div></div>
<div class="ttc" id="a02259_html_a5584596b6561bf1ef1c462d5032c6e12"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5584596b6561bf1ef1c462d5032c6e12">TOKEN_QUERY</a></div><div class="ttdeci">#define TOKEN_QUERY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01472">ntseapi.h:1472</a></div></div>
<div class="ttc" id="a02259_html_a783c8ad3877adc922b1184d3bfd83189"><div class="ttname"><a href="../../d3/d3a/a02259.html#a783c8ad3877adc922b1184d3bfd83189">PSID</a></div><div class="ttdeci">PVOID PSID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00065">ntseapi.h:65</a></div></div>
<div class="ttc" id="a02230_html_abf28f80e90bef143796d9dfcf34dd239"><div class="ttname"><a href="../../dd/d67/a02230.html#abf28f80e90bef143796d9dfcf34dd239">C_ASSERT</a></div><div class="ttdeci">#define C_ASSERT(e)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00122">ntdef.h:122</a></div></div>
<div class="ttc" id="a01406_html"><div class="ttname"><a href="../../dc/d25/a01406.html">_PRIVILEGE_SET</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01306">ntseapi.h:1306</a></div></div>
<div class="ttc" id="a02256_html_a1c6ea9a91be76d8dfe0a5337310ba361"><div class="ttname"><a href="../../de/dc3/a02256.html#a1c6ea9a91be76d8dfe0a5337310ba361">RtlValidAcl</a></div><div class="ttdeci">NTSYSAPI BOOLEAN NTAPI RtlValidAcl(PACL Acl)</div></div>
<div class="ttc" id="a02230_html_a9b3a762f8b8db86e6cb243f4af6d87ac"><div class="ttname"><a href="../../dd/d67/a02230.html#a9b3a762f8b8db86e6cb243f4af6d87ac">NTAPI</a></div><div class="ttdeci">#define NTAPI</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00264">ntdef.h:264</a></div></div>
<div class="ttc" id="a00012_html"><div class="ttname"><a href="../../df/d86/a00012.html">_ACE_HEADER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00687">ntseapi.h:687</a></div></div>
<div class="ttc" id="a01741_html"><div class="ttname"><a href="../../d0/d4e/a01741.html">_TOKEN_DEFAULT_DACL</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01577">ntseapi.h:1577</a></div></div>
<div class="ttc" id="a02665_html_aeaa146ca19ac4714659beabac108326a"><div class="ttname"><a href="../../d3/d32/a02665.html#aeaa146ca19ac4714659beabac108326a">RtlpInheritAcl2</a></div><div class="ttdeci">NTSTATUS RtlpInheritAcl2(IN PACL DirectoryAcl, IN PACL ChildAcl, IN ULONG ChildGenericControl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN BOOLEAN DefaultDescriptorForObject, IN PSID OwnerSid, IN PSID GroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN GUID **pNewObjectType OPTIONAL, IN ULONG GuidCount, IN PULONG AclBufferSize, IN OUT PUCHAR AclBuffer, OUT PBOOLEAN NewAclExplicitlyAssigned, OUT PULONG NewGenericControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l04302">sertl.c:4302</a></div></div>
<div class="ttc" id="a02230_html_a75af6aee35551eeff024eb003e8eee22"><div class="ttname"><a href="../../dd/d67/a02230.html#a75af6aee35551eeff024eb003e8eee22">PHANDLE</a></div><div class="ttdeci">HANDLE * PHANDLE</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00430">ntdef.h:430</a></div></div>
<div class="ttc" id="a02284_html_a22b50e7c3b91068e25bfe17b41bf0fea"><div class="ttname"><a href="../../d3/d81/a02284.html#a22b50e7c3b91068e25bfe17b41bf0fea">SePrivilegeCheck</a></div><div class="ttdeci">NTKERNELAPI BOOLEAN SePrivilegeCheck(__inout PPRIVILEGE_SET RequiredPrivileges, __in PSECURITY_SUBJECT_CONTEXT SubjectSecurityContext, __in KPROCESSOR_MODE AccessMode)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d84/a02686_source.html#l00155">privileg.c:155</a></div></div>
<div class="ttc" id="a02306_html_ad82d7bdad424f560c968dc536c428f0e"><div class="ttname"><a href="../../d3/dc5/a02306.html#ad82d7bdad424f560c968dc536c428f0e">SEC_E_TIME_SKEW</a></div><div class="ttdeci">#define SEC_E_TIME_SKEW</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22613">winerror.h:22613</a></div></div>
<div class="ttc" id="a02044_html_a9eb3c581a5dc041cceb93a93c7b129f9"><div class="ttname"><a href="../../d8/d22/a02044.html#a9eb3c581a5dc041cceb93a93c7b129f9">Index</a></div><div class="ttdeci">ULONG Index</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d22/a02044_source.html#l00097">cmchek.c:97</a></div></div>
<div class="ttc" id="a01589_html_a8f4e4ca9a25a61e46d5a7bc754f3fb25"><div class="ttname"><a href="../../d7/d29/a01589.html#a8f4e4ca9a25a61e46d5a7bc754f3fb25">_SECURITY_QUALITY_OF_SERVICE::Length</a></div><div class="ttdeci">ULONG Length</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01708">ntseapi.h:1708</a></div></div>
<div class="ttc" id="a02306_html_a699ef412e2ac0d6aac37e17e61a89b79"><div class="ttname"><a href="../../d3/dc5/a02306.html#a699ef412e2ac0d6aac37e17e61a89b79">SEC_E_UNSUPPORTED_FUNCTION</a></div><div class="ttdeci">#define SEC_E_UNSUPPORTED_FUNCTION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22343">winerror.h:22343</a></div></div>
<div class="ttc" id="a01661_html_a42053951503fd821638234bd01a1c6c7"><div class="ttname"><a href="../../d4/d41/a01661.html#a42053951503fd821638234bd01a1c6c7">_STRING::Length</a></div><div class="ttdeci">USHORT Length</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01007">ntdef.h:1007</a></div></div>
<div class="ttc" id="a02306_html"><div class="ttname"><a href="../../d3/dc5/a02306.html">winerror.h</a></div></div>
<div class="ttc" id="a02261_html_ad69196aefc264e1a286ffa1a5482c629"><div class="ttname"><a href="../../d7/d24/a02261.html#ad69196aefc264e1a286ffa1a5482c629">SEF_DEFAULT_OWNER_FROM_PARENT</a></div><div class="ttdeci">#define SEF_DEFAULT_OWNER_FROM_PARENT</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00924">nturtl.h:924</a></div></div>
<div class="ttc" id="a02665_html_af8c5ad668f79e24b981fde21c3589d30"><div class="ttname"><a href="../../d3/d32/a02665.html#af8c5ad668f79e24b981fde21c3589d30">RtlpCopyEffectiveAce</a></div><div class="ttdeci">BOOLEAN RtlpCopyEffectiveAce(IN PACE_HEADER OldAce, IN BOOLEAN AutoInherit, IN BOOLEAN WillGenerateInheritAce, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID **pNewObjectType OPTIONAL, IN ULONG GuidCount, IN OUT PVOID *AcePosition, OUT PULONG NewAceLength, OUT PACL NewAcl, OUT PBOOLEAN ObjectAceInherited OPTIONAL, OUT PBOOLEAN EffectiveAceMapped, OUT PBOOLEAN AclOverflowed)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03385">sertl.c:3385</a></div></div>
<div class="ttc" id="a02230_html_a5ec94aadb53d4c45441b96dacfc08379"><div class="ttname"><a href="../../dd/d67/a02230.html#a5ec94aadb53d4c45441b96dacfc08379">PSTRING</a></div><div class="ttdeci">STRING * PSTRING</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01014">ntdef.h:1014</a></div></div>
<div class="ttc" id="a02665_html_af002fe57526a71b69dcb65d6b21be224"><div class="ttname"><a href="../../d3/d32/a02665.html#af002fe57526a71b69dcb65d6b21be224">RtlEqualLuid</a></div><div class="ttdeci">NTSYSAPI BOOLEAN NTAPI RtlEqualLuid(PLUID Luid1, PLUID Luid2)</div></div>
<div class="ttc" id="a02306_html_adf4f2d6191dfec4f94a62cdcb520fa72"><div class="ttname"><a href="../../d3/dc5/a02306.html#adf4f2d6191dfec4f94a62cdcb520fa72">SEC_E_TARGET_UNKNOWN</a></div><div class="ttdeci">#define SEC_E_TARGET_UNKNOWN</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22352">winerror.h:22352</a></div></div>
<div class="ttc" id="a02259_html_a9081b9116c6cf606b4ccbee0ece39f5d"><div class="ttname"><a href="../../d3/d3a/a02259.html#a9081b9116c6cf606b4ccbee0ece39f5d">ACCESS_DENIED_ACE_TYPE</a></div><div class="ttdeci">#define ACCESS_DENIED_ACE_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00701">ntseapi.h:701</a></div></div>
<div class="ttc" id="a01587_html"><div class="ttname"><a href="../../d6/d91/a01587.html">_SECURITY_DESCRIPTOR_RELATIVE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01163">ntseapi.h:1163</a></div></div>
<div class="ttc" id="a02253_html_afdbb1a6fd7c93dbb3641b309895bbd59"><div class="ttname"><a href="../../db/d7a/a02253.html#afdbb1a6fd7c93dbb3641b309895bbd59">NtSetInformationThread</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtSetInformationThread(__in HANDLE ThreadHandle, __in THREADINFOCLASS ThreadInformationClass, __in_bcount(ThreadInformationLength) PVOID ThreadInformation, __in ULONG ThreadInformationLength)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d48/a02589_source.html#l03503">psquery.c:3503</a></div></div>
<div class="ttc" id="a02259_html_a23a254f5381c9262ec2c236a0e1f62f1"><div class="ttname"><a href="../../d3/d3a/a02259.html#a23a254f5381c9262ec2c236a0e1f62f1">SE_DACL_DEFAULTED</a></div><div class="ttdeci">#define SE_DACL_DEFAULTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01059">ntseapi.h:1059</a></div></div>
<div class="ttc" id="a01661_html_aaaaa56a4176d7ae875eaea419d56799f"><div class="ttname"><a href="../../d4/d41/a01661.html#aaaaa56a4176d7ae875eaea419d56799f">_STRING::Buffer</a></div><div class="ttdeci">PCHAR Buffer</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01012">ntdef.h:1012</a></div></div>
<div class="ttc" id="a00012_html_aa1999bc78c39c6379f555344863bf214"><div class="ttname"><a href="../../df/d86/a00012.html#aa1999bc78c39c6379f555344863bf214">_ACE_HEADER::AceFlags</a></div><div class="ttdeci">UCHAR AceFlags</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00689">ntseapi.h:689</a></div></div>
<div class="ttc" id="a02306_html_ab5a2c77139e3835fe5b767b2f99b9c26"><div class="ttname"><a href="../../d3/dc5/a02306.html#ab5a2c77139e3835fe5b767b2f99b9c26">SEC_E_OUT_OF_SEQUENCE</a></div><div class="ttdeci">#define SEC_E_OUT_OF_SEQUENCE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22469">winerror.h:22469</a></div></div>
<div class="ttc" id="a02259_html_af1c4d90a73cbb90d64e7539845cec6fe"><div class="ttname"><a href="../../d3/d3a/a02259.html#af1c4d90a73cbb90d64e7539845cec6fe">NtAdjustPrivilegesToken</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtAdjustPrivilegesToken(__in HANDLE TokenHandle, __in BOOLEAN DisableAllPrivileges, __in_opt PTOKEN_PRIVILEGES NewState, __in_opt ULONG BufferLength, __out_bcount_part_opt(BufferLength,*ReturnLength) PTOKEN_PRIVILEGES PreviousState, __out_opt PULONG ReturnLength)</div></div>
<div class="ttc" id="a02665_html_a6d97771616b301496c63c10e72b39232"><div class="ttname"><a href="../../d3/d32/a02665.html#a6d97771616b301496c63c10e72b39232">RtlEqualPrefixSid</a></div><div class="ttdeci">BOOLEAN RtlEqualPrefixSid(IN PSID Sid1, IN PSID Sid2)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00926">sertl.c:926</a></div></div>
<div class="ttc" id="a01624_html_a128c3bab70f681c6df6d7eb7a171e959"><div class="ttname"><a href="../../de/df9/a01624.html#a128c3bab70f681c6df6d7eb7a171e959">_SID::SubAuthorityCount</a></div><div class="ttdeci">UCHAR SubAuthorityCount</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00253">ntseapi.h:253</a></div></div>
<div class="ttc" id="a02665_html_a116af4b9237b96e5629c806dc2662161"><div class="ttname"><a href="../../d3/d32/a02665.html#a116af4b9237b96e5629c806dc2662161">RtlIdentifierAuthoritySid</a></div><div class="ttdeci">PSID_IDENTIFIER_AUTHORITY RtlIdentifierAuthoritySid(IN PSID Sid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01114">sertl.c:1114</a></div></div>
<div class="ttc" id="a02259_html_a0b3f598c6ca0b18ba95fe4675d354c48"><div class="ttname"><a href="../../d3/d3a/a02259.html#a0b3f598c6ca0b18ba95fe4675d354c48">INHERIT_ONLY_ACE</a></div><div class="ttdeci">#define INHERIT_ONLY_ACE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00743">ntseapi.h:743</a></div></div>
<div class="ttc" id="a02256_html_abd90afec09d7094004e811f9056461b3"><div class="ttname"><a href="../../de/dc3/a02256.html#abd90afec09d7094004e811f9056461b3">RtlZeroMemory</a></div><div class="ttdeci">#define RtlZeroMemory(Destination, Length)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l04268">ntrtl.h:4268</a></div></div>
<div class="ttc" id="a00817_html"><div class="ttname"><a href="../../dc/d5e/a00817.html">_LARGE_INTEGER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00670">ntdef.h:670</a></div></div>
<div class="ttc" id="a02259_html_a598b14f5d10c4d033b7a6c1dd2a79e67"><div class="ttname"><a href="../../d3/d3a/a02259.html#a598b14f5d10c4d033b7a6c1dd2a79e67">SE_DACL_AUTO_INHERIT_REQ</a></div><div class="ttdeci">#define SE_DACL_AUTO_INHERIT_REQ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01066">ntseapi.h:1066</a></div></div>
<div class="ttc" id="a02259_html_a5dcdcb687d0ee6009b792fe98286b02f"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5dcdcb687d0ee6009b792fe98286b02f">SECURITY_DESCRIPTOR_CONTROL</a></div><div class="ttdeci">USHORT SECURITY_DESCRIPTOR_CONTROL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01054">ntseapi.h:1054</a></div></div>
<div class="ttc" id="a02230_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="../../dd/d67/a02230.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01262">ntdef.h:1262</a></div></div>
<div class="ttc" id="a02261_html_af9c9d7545f456effa5019a3f41ee424f"><div class="ttname"><a href="../../d7/d24/a02261.html#af9c9d7545f456effa5019a3f41ee424f">SEF_AVOID_PRIVILEGE_CHECK</a></div><div class="ttdeci">#define SEF_AVOID_PRIVILEGE_CHECK</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00922">nturtl.h:922</a></div></div>
<div class="ttc" id="a02665_html_a7c3f037a28be18be89bb15f8c69bfd3b"><div class="ttname"><a href="../../d3/d32/a02665.html#a7c3f037a28be18be89bb15f8c69bfd3b">RtlLengthSid</a></div><div class="ttdeci">ULONG RtlLengthSid(IN PSID Sid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01211">sertl.c:1211</a></div></div>
<div class="ttc" id="a02260_html_aeb86c04f9593b4cdb1b56c71e76d2e36"><div class="ttname"><a href="../../dc/d18/a02260.html#aeb86c04f9593b4cdb1b56c71e76d2e36">STATUS_INSUFFICIENT_RESOURCES</a></div><div class="ttdeci">#define STATUS_INSUFFICIENT_RESOURCES</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02944">ntstatus.h:2944</a></div></div>
<div class="ttc" id="a02665_html_afb36f010039d85b0c281e98b73055c37"><div class="ttname"><a href="../../d3/d32/a02665.html#afb36f010039d85b0c281e98b73055c37">RtlSetDaclSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetDaclSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN DaclPresent, IN PACL Dacl OPTIONAL, IN BOOLEAN DaclDefaulted OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02287">sertl.c:2287</a></div></div>
<div class="ttc" id="a02285_html_a1d1ca952dbdcb9d3acad809233e0706e"><div class="ttname"><a href="../../df/d4d/a02285.html#a1d1ca952dbdcb9d3acad809233e0706e">PKNOWN_COMPOUND_ACE</a></div><div class="ttdeci">struct _KNOWN_COMPOUND_ACE * PKNOWN_COMPOUND_ACE</div></div>
<div class="ttc" id="a02230_html_a9de25ce33a4628ba620c6ec99fa46ede"><div class="ttname"><a href="../../dd/d67/a02230.html#a9de25ce33a4628ba620c6ec99fa46ede">PUCHAR</a></div><div class="ttdeci">UCHAR * PUCHAR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00399">ntdef.h:399</a></div></div>
<div class="ttc" id="a02285_html_a91ce2ebf39e0a306fed674324f0637d3"><div class="ttname"><a href="../../df/d4d/a02285.html#a91ce2ebf39e0a306fed674324f0637d3">ValidAclRevision</a></div><div class="ttdeci">#define ValidAclRevision(Acl)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00200">seopaque.h:200</a></div></div>
<div class="ttc" id="a02665_html_ade7b3318164b177270351c77baa8d79f"><div class="ttname"><a href="../../d3/d32/a02665.html#ade7b3318164b177270351c77baa8d79f">RtlpGuidPresentInGuidList</a></div><div class="ttdeci">BOOLEAN RtlpGuidPresentInGuidList(IN GUID *InheritedObjectType, IN GUID **pNewObjectType, IN ULONG GuidCount)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l10347">sertl.c:10347</a></div></div>
<div class="ttc" id="a02665_html_a370116e75eb3ccfdf6cf12b3737007a0"><div class="ttname"><a href="../../d3/d32/a02665.html#a370116e75eb3ccfdf6cf12b3737007a0">RtlpValidateSDOffsetAndSize</a></div><div class="ttdeci">BOOLEAN RtlpValidateSDOffsetAndSize(IN ULONG Offset, IN ULONG Length, IN ULONG MinLength, OUT PULONG MaxLength)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l09997">sertl.c:9997</a></div></div>
<div class="ttc" id="a01661_html"><div class="ttname"><a href="../../d4/d41/a01661.html">_STRING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01006">ntdef.h:1006</a></div></div>
<div class="ttc" id="a02230_html_a92ac059a9f2eebdf70d057eb27709f4a"><div class="ttname"><a href="../../dd/d67/a02230.html#a92ac059a9f2eebdf70d057eb27709f4a">PWSTR</a></div><div class="ttdeci">__nullterminated WCHAR * PWSTR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00302">ntdef.h:302</a></div></div>
<div class="ttc" id="a02284_html_a6b4016db9802d1ca4d0c566f618ff03e"><div class="ttname"><a href="../../d3/d81/a02284.html#a6b4016db9802d1ca4d0c566f618ff03e">SeLengthSid</a></div><div class="ttdeci">#define SeLengthSid(Sid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d81/a02284_source.html#l00558">se.h:558</a></div></div>
<div class="ttc" id="a01626_html"><div class="ttname"><a href="../../dd/d90/a01626.html">_SID_IDENTIFIER_AUTHORITY</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00243">ntseapi.h:243</a></div></div>
<div class="ttc" id="a02285_html_a5985e9e13d64e98fdec10c1e46e55a3c"><div class="ttname"><a href="../../df/d4d/a02285.html#a5985e9e13d64e98fdec10c1e46e55a3c">KNOWN_OBJECT_ACE</a></div><div class="ttdeci">struct _KNOWN_OBJECT_ACE KNOWN_OBJECT_ACE</div></div>
<div class="ttc" id="a02190_html_acabfea33dd59df8e10a8b0bb0b19860f"><div class="ttname"><a href="../../dc/dc3/a02190.html#acabfea33dd59df8e10a8b0bb0b19860f">GUID</a></div><div class="ttdeci">struct _GUID GUID</div></div>
<div class="ttc" id="a02665_html_a0efacda5cdc2ad0345fca5f8fde2b155"><div class="ttname"><a href="../../d3/d32/a02665.html#a0efacda5cdc2ad0345fca5f8fde2b155">RtlAreAllAccessesGranted</a></div><div class="ttdeci">BOOLEAN RtlAreAllAccessesGranted(IN ACCESS_MASK GrantedAccess, IN ACCESS_MASK DesiredAccess)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03053">sertl.c:3053</a></div></div>
<div class="ttc" id="a02285_html_afe9f9ad9432d321e3efcb26d9df02efc"><div class="ttname"><a href="../../df/d4d/a02285.html#afe9f9ad9432d321e3efcb26d9df02efc">RtlObjectAceSid</a></div><div class="ttdeci">#define RtlObjectAceSid(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00247">seopaque.h:247</a></div></div>
<div class="ttc" id="a02306_html_ab3c98963d70bdc291e8fe2140ccf984e"><div class="ttname"><a href="../../d3/dc5/a02306.html#ab3c98963d70bdc291e8fe2140ccf984e">SEC_E_INVALID_TOKEN</a></div><div class="ttdeci">#define SEC_E_INVALID_TOKEN</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22397">winerror.h:22397</a></div></div>
<div class="ttc" id="a02259_html_a7d9e23f817e83da107625e5e40f99cd7"><div class="ttname"><a href="../../d3/d3a/a02259.html#a7d9e23f817e83da107625e5e40f99cd7">SYSTEM_ALARM_ACE_TYPE</a></div><div class="ttdeci">#define SYSTEM_ALARM_ACE_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00703">ntseapi.h:703</a></div></div>
<div class="ttc" id="a02260_html_a5f4f09d62ff51bb9ef6e3dd6f0eb88b4"><div class="ttname"><a href="../../dc/d18/a02260.html#a5f4f09d62ff51bb9ef6e3dd6f0eb88b4">STATUS_INVALID_PARAMETER_2</a></div><div class="ttdeci">#define STATUS_INVALID_PARAMETER_2</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03742">ntstatus.h:3742</a></div></div>
<div class="ttc" id="a02259_html_a5e200ddef24f6ab53b4ce054b6069eb0"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5e200ddef24f6ab53b4ce054b6069eb0">PISECURITY_DESCRIPTOR_RELATIVE</a></div><div class="ttdeci">struct _SECURITY_DESCRIPTOR_RELATIVE * PISECURITY_DESCRIPTOR_RELATIVE</div></div>
<div class="ttc" id="a02665_html_a5fecd27bb15029d767a1c093cc2fd00c"><div class="ttname"><a href="../../d3/d32/a02665.html#a5fecd27bb15029d767a1c093cc2fd00c">RtlpApplyAclToObject</a></div><div class="ttdeci">VOID RtlpApplyAclToObject(IN PACL Acl, IN PGENERIC_MAPPING GenericMapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03317">sertl.c:3317</a></div></div>
<div class="ttc" id="a02284_html_ab0290ff1aa67964ff59b542b1cfeeba1"><div class="ttname"><a href="../../d3/d81/a02284.html#ab0290ff1aa67964ff59b542b1cfeeba1">SeReleaseSubjectContext</a></div><div class="ttdeci">NTKERNELAPI VOID SeReleaseSubjectContext(__inout PSECURITY_SUBJECT_CONTEXT SubjectContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d94/a02702_source.html#l00261">subject.c:261</a></div></div>
<div class="ttc" id="a02665_html_a4ae2a669f4467584a20a7ad54fce92d5"><div class="ttname"><a href="../../d3/d32/a02665.html#a4ae2a669f4467584a20a7ad54fce92d5">RtlSetAttributesSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetAttributesSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN SECURITY_DESCRIPTOR_CONTROL Control, OUT PULONG Revision)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02130">sertl.c:2130</a></div></div>
<div class="ttc" id="a02261_html_a053c57ea472f2605ef6d732f25e5c6b8"><div class="ttname"><a href="../../d7/d24/a02261.html#a053c57ea472f2605ef6d732f25e5c6b8">AllocationSize</a></div><div class="ttdeci">SIZE_T AllocationSize</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d24/a02261_source.html#l00381">nturtl.h:381</a></div></div>
<div class="ttc" id="a02253_html_ab24eb59f288b52281cad79f4a3871b1d"><div class="ttname"><a href="../../db/d7a/a02253.html#ab24eb59f288b52281cad79f4a3871b1d">NtCurrentThread</a></div><div class="ttdeci">#define NtCurrentThread()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d7a/a02253_source.html#l01044">ntpsapi.h:1044</a></div></div>
<div class="ttc" id="a02260_html_a02e7b4e5e8145bdfc8bb23069ea89912"><div class="ttname"><a href="../../dc/d18/a02260.html#a02e7b4e5e8145bdfc8bb23069ea89912">STATUS_INTERNAL_ERROR</a></div><div class="ttdeci">#define STATUS_INTERNAL_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03634">ntstatus.h:3634</a></div></div>
<div class="ttc" id="a02259_html_a3804f89782de6650b5db5183d14372f9"><div class="ttname"><a href="../../d3/d3a/a02259.html#a3804f89782de6650b5db5183d14372f9">PTOKEN_USER</a></div><div class="ttdeci">struct _TOKEN_USER * PTOKEN_USER</div></div>
<div class="ttc" id="a02260_html_ac978cc4096a590979ae52c9fd4f62ee0"><div class="ttname"><a href="../../dc/d18/a02260.html#ac978cc4096a590979ae52c9fd4f62ee0">STATUS_BUFFER_TOO_SMALL</a></div><div class="ttdeci">#define STATUS_BUFFER_TOO_SMALL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01852">ntstatus.h:1852</a></div></div>
<div class="ttc" id="a02230_html_aebb9e13210d88d43e32e735ada43a425"><div class="ttname"><a href="../../dd/d67/a02230.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a></div><div class="ttdeci">char CHAR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00289">ntdef.h:289</a></div></div>
<div class="ttc" id="a02260_html_a52c9a508482278e5a91348ba542df15f"><div class="ttname"><a href="../../dc/d18/a02260.html#a52c9a508482278e5a91348ba542df15f">STATUS_INVALID_PARAMETER</a></div><div class="ttdeci">#define STATUS_INVALID_PARAMETER</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01635">ntstatus.h:1635</a></div></div>
<div class="ttc" id="a02260_html_a415c67a7a97e52ebee39db8c3addfd4d"><div class="ttname"><a href="../../dc/d18/a02260.html#a415c67a7a97e52ebee39db8c3addfd4d">STATUS_ACCESS_DENIED</a></div><div class="ttdeci">#define STATUS_ACCESS_DENIED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01842">ntstatus.h:1842</a></div></div>
<div class="ttc" id="a02260_html_a89356a217cd93310fa094c5ec4f33cbd"><div class="ttname"><a href="../../dc/d18/a02260.html#a89356a217cd93310fa094c5ec4f33cbd">STATUS_BAD_INHERITANCE_ACL</a></div><div class="ttdeci">#define STATUS_BAD_INHERITANCE_ACL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02670">ntstatus.h:2670</a></div></div>
<div class="ttc" id="a02260_html_a373b1616b13408581dc1c1fe216214cb"><div class="ttname"><a href="../../dc/d18/a02260.html#a373b1616b13408581dc1c1fe216214cb">STATUS_INVALID_ACL</a></div><div class="ttdeci">#define STATUS_INVALID_ACL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02613">ntstatus.h:2613</a></div></div>
<div class="ttc" id="a02665_html_a023bf37e42fdc7e5e8ead3f19f22a690"><div class="ttname"><a href="../../d3/d32/a02665.html#a023bf37e42fdc7e5e8ead3f19f22a690">RtlAdjustPrivilege</a></div><div class="ttdeci">NTSTATUS RtlAdjustPrivilege(ULONG Privilege, BOOLEAN Enable, BOOLEAN Client, PBOOLEAN WasEnabled)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00659">sertl.c:659</a></div></div>
<div class="ttc" id="a02665_html_ae38867c753fcc5b5e3a162cec8c60fa1"><div class="ttname"><a href="../../d3/d32/a02665.html#ae38867c753fcc5b5e3a162cec8c60fa1">RtlpComputeMergedAcl2</a></div><div class="ttdeci">NTSTATUS RtlpComputeMergedAcl2(IN PACL CurrentAcl, IN ULONG CurrentGenericControl, IN PACL ModificationAcl, IN ULONG ModificationGenericControl, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN PULONG AclBufferSize, IN OUT PUCHAR AclBuffer, OUT PULONG NewGenericControl)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l05465">sertl.c:5465</a></div></div>
<div class="ttc" id="a02259_html_abb44b9106133f10d55f863cdaaf972f5"><div class="ttname"><a href="../../d3/d3a/a02259.html#abb44b9106133f10d55f863cdaaf972f5">SE_PRIVILEGE_ENABLED</a></div><div class="ttdeci">#define SE_PRIVILEGE_ENABLED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01287">ntseapi.h:1287</a></div></div>
<div class="ttc" id="a02259_html_aecc9f2cb4b77c249451b1db76791af53"><div class="ttname"><a href="../../d3/d3a/a02259.html#aecc9f2cb4b77c249451b1db76791af53">SECURITY_DESCRIPTOR_RELATIVE</a></div><div class="ttdeci">struct _SECURITY_DESCRIPTOR_RELATIVE SECURITY_DESCRIPTOR_RELATIVE</div></div>
<div class="ttc" id="a02230_html_a4f4bb67531a9bf6f0b9c6ad76aeba587"><div class="ttname"><a href="../../dd/d67/a02230.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a></div><div class="ttdeci">unsigned char UCHAR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00390">ntdef.h:390</a></div></div>
<div class="ttc" id="a02260_html_a54a87528fba7b6b6256f3c5f074ba9b9"><div class="ttname"><a href="../../dc/d18/a02260.html#a54a87528fba7b6b6256f3c5f074ba9b9">STATUS_NO_LOGON_SERVERS</a></div><div class="ttdeci">#define STATUS_NO_LOGON_SERVERS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02386">ntstatus.h:2386</a></div></div>
<div class="ttc" id="a02665_html_ab4216159656088d3e13d13a6d5f6d1b1"><div class="ttname"><a href="../../d3/d32/a02665.html#ab4216159656088d3e13d13a6d5f6d1b1">RtlpImpersonateSelfEx</a></div><div class="ttdeci">NTSTATUS RtlpImpersonateSelfEx(IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, IN ACCESS_MASK AdditionalAccess, OUT PHANDLE ThreadToken OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03189">sertl.c:3189</a></div></div>
<div class="ttc" id="a02256_html_a7dac7ee67fd8470847e01b44f980cae6"><div class="ttname"><a href="../../de/dc3/a02256.html#a7dac7ee67fd8470847e01b44f980cae6">RtlPointerToOffset</a></div><div class="ttdeci">#define RtlPointerToOffset(B, P)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l05695">ntrtl.h:5695</a></div></div>
<div class="ttc" id="a02256_html_aab05afc2eabef1f27a5d5c4c0d629c80"><div class="ttname"><a href="../../de/dc3/a02256.html#aab05afc2eabef1f27a5d5c4c0d629c80">DbgPrint</a></div><div class="ttdeci">ULONG __cdecl DbgPrint(__in PCH Format,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc9/a02414_source.html#l00041">debug.c:41</a></div></div>
<div class="ttc" id="a02259_html_a497809e531ff71f06a1bd80ae7782d90"><div class="ttname"><a href="../../d3/d3a/a02259.html#a497809e531ff71f06a1bd80ae7782d90">SYSTEM_AUDIT_ACE_TYPE</a></div><div class="ttdeci">#define SYSTEM_AUDIT_ACE_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00702">ntseapi.h:702</a></div></div>
<div class="ttc" id="a02665_html_a9203f363f65ad0d7a697c93d76fcdd0e"><div class="ttname"><a href="../../d3/d32/a02665.html#a9203f363f65ad0d7a697c93d76fcdd0e">RtlSetControlSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlSetControlSecurityDescriptor(IN PSECURITY_DESCRIPTOR pSecurityDescriptor, IN SECURITY_DESCRIPTOR_CONTROL ControlBitsOfInterest, IN SECURITY_DESCRIPTOR_CONTROL ControlBitsToSet)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02216">sertl.c:2216</a></div></div>
<div class="ttc" id="a02665_html_a7f27dd5d02917eb83aa6b901c0512fc1"><div class="ttname"><a href="../../d3/d32/a02665.html#a7f27dd5d02917eb83aa6b901c0512fc1">RtlLengthSecurityDescriptor</a></div><div class="ttdeci">ULONG RtlLengthSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02030">sertl.c:2030</a></div></div>
<div class="ttc" id="a02259_html_a80b600d19cb808f261dd4d305de14927"><div class="ttname"><a href="../../d3/d3a/a02259.html#a80b600d19cb808f261dd4d305de14927">SECURITY_QUALITY_OF_SERVICE</a></div><div class="ttdeci">struct _SECURITY_QUALITY_OF_SERVICE SECURITY_QUALITY_OF_SERVICE</div></div>
<div class="ttc" id="a02665_html_aa5c7194b0c04c14f10ff963771b65daf"><div class="ttname"><a href="../../d3/d32/a02665.html#aa5c7194b0c04c14f10ff963771b65daf">RtlRunEncodeUnicodeString</a></div><div class="ttdeci">VOID RtlRunEncodeUnicodeString(PUCHAR Seed OPTIONAL, PUNICODE_STRING String)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00409">sertl.c:409</a></div></div>
<div class="ttc" id="a01750_html_a6ff4d81245f39eecbe73e61392a3ebda"><div class="ttname"><a href="../../dc/d3a/a01750.html#a6ff4d81245f39eecbe73e61392a3ebda">_TOKEN_USER::User</a></div><div class="ttdeci">SID_AND_ATTRIBUTES User</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01552">ntseapi.h:1552</a></div></div>
<div class="ttc" id="a02256_html_a226f8b2aa65758424db1dd0f51011d32"><div class="ttname"><a href="../../de/dc3/a02256.html#a226f8b2aa65758424db1dd0f51011d32">RtlApplyGenericMask</a></div><div class="ttdeci">#define RtlApplyGenericMask(Ace, Mask, Mapping)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l06836">ntrtl.h:6836</a></div></div>
<div class="ttc" id="a00013_html"><div class="ttname"><a href="../../d7/dd4/a00013.html">_ACL</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00658">ntseapi.h:658</a></div></div>
<div class="ttc" id="a01746_html"><div class="ttname"><a href="../../d5/dfa/a01746.html">_TOKEN_PRIMARY_GROUP</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01572">ntseapi.h:1572</a></div></div>
<div class="ttc" id="a02259_html_a5a7b412541ed85b9b603ed687fe28681"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5a7b412541ed85b9b603ed687fe28681">ACL_REVISION3</a></div><div class="ttdeci">#define ACL_REVISION3</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00654">ntseapi.h:654</a></div></div>
<div class="ttc" id="a02230_html_a6addcc52e2dfddf231bf3213859ae2bb"><div class="ttname"><a href="../../dd/d67/a02230.html#a6addcc52e2dfddf231bf3213859ae2bb">PCHAR</a></div><div class="ttdeci">CHAR * PCHAR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00313">ntdef.h:313</a></div></div>
<div class="ttc" id="a02230_html_a5850d5316caf7f4cedd742fdf8cd7c02"><div class="ttname"><a href="../../dd/d67/a02230.html#a5850d5316caf7f4cedd742fdf8cd7c02">USHORT</a></div><div class="ttdeci">unsigned short USHORT</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00391">ntdef.h:391</a></div></div>
<div class="ttc" id="a02665_html_a6c0f5054b396ce159d856064b1645d9a"><div class="ttname"><a href="../../d3/d32/a02665.html#a6c0f5054b396ce159d856064b1645d9a">RtlGetSaclSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlGetSaclSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PBOOLEAN SaclPresent, OUT PACL *Sacl, OUT PBOOLEAN SaclDefaulted)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02615">sertl.c:2615</a></div></div>
<div class="ttc" id="a02256_html_ab329f640d89ba58a8e81e19004bdb7bd"><div class="ttname"><a href="../../de/dc3/a02256.html#ab329f640d89ba58a8e81e19004bdb7bd">RtlCopyMemory</a></div><div class="ttdeci">#define RtlCopyMemory(Destination, Source, Length)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l04266">ntrtl.h:4266</a></div></div>
<div class="ttc" id="a02259_html_abbf861f5f7ab0c3d45df32ffb0ffd1fd"><div class="ttname"><a href="../../d3/d3a/a02259.html#abbf861f5f7ab0c3d45df32ffb0ffd1fd">ACCESS_ALLOWED_COMPOUND_ACE_TYPE</a></div><div class="ttdeci">#define ACCESS_ALLOWED_COMPOUND_ACE_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00706">ntseapi.h:706</a></div></div>
<div class="ttc" id="a02259_html_a2b8d1197825674e6b8bb0657f844c0cd"><div class="ttname"><a href="../../d3/d3a/a02259.html#a2b8d1197825674e6b8bb0657f844c0cd">PACE_HEADER</a></div><div class="ttdeci">ACE_HEADER * PACE_HEADER</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00692">ntseapi.h:692</a></div></div>
<div class="ttc" id="a02253_html_a719a7ce85358702f11dce2cd31896b4b"><div class="ttname"><a href="../../db/d7a/a02253.html#a719a7ce85358702f11dce2cd31896b4b">NtCurrentProcess</a></div><div class="ttdeci">#define NtCurrentProcess()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d7a/a02253_source.html#l00934">ntpsapi.h:934</a></div></div>
<div class="ttc" id="a02256_html_a629256bb2488240a06b6827cc90016a6"><div class="ttname"><a href="../../de/dc3/a02256.html#a629256bb2488240a06b6827cc90016a6">RtlCompoundAceServerSid</a></div><div class="ttdeci">#define RtlCompoundAceServerSid(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l06926">ntrtl.h:6926</a></div></div>
<div class="ttc" id="a02665_html_ad126d04085e16b2aa54a9faceaab13d1"><div class="ttname"><a href="../../d3/d32/a02665.html#ad126d04085e16b2aa54a9faceaab13d1">RtlSubAuthorityCountSid</a></div><div class="ttdeci">PUCHAR RtlSubAuthorityCountSid(IN PSID Sid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01177">sertl.c:1177</a></div></div>
<div class="ttc" id="a01624_html_ad8ef3ca4f98f30abbadebf247214256e"><div class="ttname"><a href="../../de/df9/a01624.html#ad8ef3ca4f98f30abbadebf247214256e">_SID::IdentifierAuthority</a></div><div class="ttdeci">SID_IDENTIFIER_AUTHORITY IdentifierAuthority</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00254">ntseapi.h:254</a></div></div>
<div class="ttc" id="a02260_html_a32e3f920f2666a40f948e8092d9d6980"><div class="ttname"><a href="../../dc/d18/a02260.html#a32e3f920f2666a40f948e8092d9d6980">STATUS_CANNOT_IMPERSONATE</a></div><div class="ttdeci">#define STATUS_CANNOT_IMPERSONATE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l04006">ntstatus.h:4006</a></div></div>
<div class="ttc" id="a02285_html_abb859604285097c0889f27f0266c560a"><div class="ttname"><a href="../../df/d4d/a02285.html#abb859604285097c0889f27f0266c560a">IsMSAceType</a></div><div class="ttdeci">#define IsMSAceType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00175">seopaque.h:175</a></div></div>
<div class="ttc" id="a02259_html_a974c8776187280aecce79aa09411978a"><div class="ttname"><a href="../../d3/d3a/a02259.html#a974c8776187280aecce79aa09411978a">SE_SACL_PRESENT</a></div><div class="ttdeci">#define SE_SACL_PRESENT</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01060">ntseapi.h:1060</a></div></div>
<div class="ttc" id="a02285_html_ac5fd69aebb752e1bc476afa0d6afa7e0"><div class="ttname"><a href="../../df/d4d/a02285.html#ac5fd69aebb752e1bc476afa0d6afa7e0">AceInherited</a></div><div class="ttdeci">#define AceInherited(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00235">seopaque.h:235</a></div></div>
<div class="ttc" id="a02259_html_af432365a7f8156f8c092870edea1329b"><div class="ttname"><a href="../../d3/d3a/a02259.html#af432365a7f8156f8c092870edea1329b">SUCCESSFUL_ACCESS_ACE_FLAG</a></div><div class="ttdeci">#define SUCCESSFUL_ACCESS_ACE_FLAG</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00765">ntseapi.h:765</a></div></div>
<div class="ttc" id="a02259_html_afaa027bcf070507dd737b67c4a404882"><div class="ttname"><a href="../../d3/d3a/a02259.html#afaa027bcf070507dd737b67c4a404882">NtDuplicateToken</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtDuplicateToken(__in HANDLE ExistingTokenHandle, __in ACCESS_MASK DesiredAccess, __in POBJECT_ATTRIBUTES ObjectAttributes, __in BOOLEAN EffectiveOnly, __in TOKEN_TYPE TokenType, __out PHANDLE NewTokenHandle)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d28/a02705_source.html#l00039">tokendup.c:39</a></div></div>
<div class="ttc" id="a02256_html_a07be44e9f5d9a11211d015d74071c358"><div class="ttname"><a href="../../de/dc3/a02256.html#a07be44e9f5d9a11211d015d74071c358">RtlConvertUlongToLuid</a></div><div class="ttdeci">FORCEINLINE LUID NTAPI RtlConvertUlongToLuid(ULONG Ulong)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l06222">ntrtl.h:6222</a></div></div>
<div class="ttc" id="a02286_html_a60936e4951b5254ffb43baca1c1a8fb5"><div class="ttname"><a href="../../db/d2d/a02286.html#a60936e4951b5254ffb43baca1c1a8fb5">RtlpAreControlBitsSet</a></div><div class="ttdeci">#define RtlpAreControlBitsSet(SD, Bits)                                                                                </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00127">sertlp.h:127</a></div></div>
<div class="ttc" id="a02259_html_a6243776f2306b552ea5cccf5b9873cef"><div class="ttname"><a href="../../d3/d3a/a02259.html#a6243776f2306b552ea5cccf5b9873cef">SE_SELF_RELATIVE</a></div><div class="ttdeci">#define SE_SELF_RELATIVE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01073">ntseapi.h:1073</a></div></div>
<div class="ttc" id="a02259_html_aa7206f38a9d41e461e3a4ab8b03f0836"><div class="ttname"><a href="../../d3/d3a/a02259.html#aa7206f38a9d41e461e3a4ab8b03f0836">STANDARD_RIGHTS_ALL</a></div><div class="ttdeci">#define STANDARD_RIGHTS_ALL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00143">ntseapi.h:143</a></div></div>
<div class="ttc" id="a01585_html_a6dc4d9f0455e08f4a5158b52b6dd23fc"><div class="ttname"><a href="../../da/de2/a01585.html#a6dc4d9f0455e08f4a5158b52b6dd23fc">_SECURITY_DESCRIPTOR::Dacl</a></div><div class="ttdeci">PACL Dacl</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01180">ntseapi.h:1180</a></div></div>
<div class="ttc" id="a02205_html_a59359495801dfca8e1fbc3196348a0db"><div class="ttname"><a href="../../dc/d43/a02205.html#a59359495801dfca8e1fbc3196348a0db">KeGetPreviousMode</a></div><div class="ttdeci">#define KeGetPreviousMode()</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d43/a02205_source.html#l02748">ke.h:2748</a></div></div>
<div class="ttc" id="a02306_html_a375312e60c413be670bc3b90617a2eee"><div class="ttname"><a href="../../d3/dc5/a02306.html#a375312e60c413be670bc3b90617a2eee">SEC_E_LOGON_DENIED</a></div><div class="ttdeci">#define SEC_E_LOGON_DENIED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22433">winerror.h:22433</a></div></div>
<div class="ttc" id="a02230_html_ad14231612b7a675d33f0ead0b695d21a"><div class="ttname"><a href="../../dd/d67/a02230.html#ad14231612b7a675d33f0ead0b695d21a">NT_SUCCESS</a></div><div class="ttdeci">#define NT_SUCCESS(Status)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00569">ntdef.h:569</a></div></div>
<div class="ttc" id="a02284_html_a0f80046299c6f5ace2b38d769508fde6"><div class="ttname"><a href="../../d3/d81/a02284.html#a0f80046299c6f5ace2b38d769508fde6">PSECURITY_SUBJECT_CONTEXT</a></div><div class="ttdeci">struct _SECURITY_SUBJECT_CONTEXT * PSECURITY_SUBJECT_CONTEXT</div></div>
<div class="ttc" id="a01749_html"><div class="ttname"><a href="../../d5/d77/a01749.html">_TOKEN_STATISTICS</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01660">ntseapi.h:1660</a></div></div>
<div class="ttc" id="a02249_html_a9b26934030fc4241b92fe90168d238efab76e1d872ad43cb76d21124abdd4312a"><div class="ttname"><a href="../../dd/dc3/a02249.html#a9b26934030fc4241b92fe90168d238efab76e1d872ad43cb76d21124abdd4312a">KernelMode</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dc3/a02249_source.html#l00127">ntosdef.h:127</a></div></div>
<div class="ttc" id="a02259_html_aed93f572f76288c4e5238b805f0f1c24"><div class="ttname"><a href="../../d3/d3a/a02259.html#aed93f572f76288c4e5238b805f0f1c24">FAILED_ACCESS_ACE_FLAG</a></div><div class="ttdeci">#define FAILED_ACCESS_ACE_FLAG</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00766">ntseapi.h:766</a></div></div>
<div class="ttc" id="a02259_html_a5befedca477346da731bee5367de1921"><div class="ttname"><a href="../../d3/d3a/a02259.html#a5befedca477346da731bee5367de1921">OWNER_SECURITY_INFORMATION</a></div><div class="ttdeci">#define OWNER_SECURITY_INFORMATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01773">ntseapi.h:1773</a></div></div>
<div class="ttc" id="a02256_html_adb696f4512c9ed33dd7d571f296b7ebb"><div class="ttname"><a href="../../de/dc3/a02256.html#adb696f4512c9ed33dd7d571f296b7ebb">RtlMoveMemory</a></div><div class="ttdeci">#define RtlMoveMemory(Destination, Source, Length)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l04265">ntrtl.h:4265</a></div></div>
<div class="ttc" id="a02306_html_ac2dbec73a8c9af33a1a47d6ba56981e8"><div class="ttname"><a href="../../d3/dc5/a02306.html#ac2dbec73a8c9af33a1a47d6ba56981e8">SEC_E_INSUFFICIENT_MEMORY</a></div><div class="ttdeci">#define SEC_E_INSUFFICIENT_MEMORY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22325">winerror.h:22325</a></div></div>
<div class="ttc" id="a02256_html_af2f5618e7817dc88a1bb7ab4c55a59a0"><div class="ttname"><a href="../../de/dc3/a02256.html#af2f5618e7817dc88a1bb7ab4c55a59a0">RtlOffsetToPointer</a></div><div class="ttdeci">#define RtlOffsetToPointer(B, O)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc3/a02256_source.html#l05664">ntrtl.h:5664</a></div></div>
<div class="ttc" id="a02285_html_adfcbc9779e90e656630eab7a9e1a2173"><div class="ttname"><a href="../../df/d4d/a02285.html#adfcbc9779e90e656630eab7a9e1a2173">RtlObjectAceInheritedObjectType</a></div><div class="ttdeci">#define RtlObjectAceInheritedObjectType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00257">seopaque.h:257</a></div></div>
<div class="ttc" id="a02125_html_ac4f0427f782e5bfd15644bc30afc1805"><div class="ttname"><a href="../../d8/db2/a02125.html#ac4f0427f782e5bfd15644bc30afc1805">ExFreePool</a></div><div class="ttdeci">VOID ExFreePool(__in PVOID P)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/db2/a02125_source.html#l05027">pool.c:5027</a></div></div>
<div class="ttc" id="a02259_html_a411b6515ba148a094881e66e79cfe44f"><div class="ttname"><a href="../../d3/d3a/a02259.html#a411b6515ba148a094881e66e79cfe44f">ACCESS_SYSTEM_SECURITY</a></div><div class="ttdeci">#define ACCESS_SYSTEM_SECURITY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00151">ntseapi.h:151</a></div></div>
<div class="ttc" id="a02259_html_ae7a3106c6bef5edbff79f9e203c7ccf4"><div class="ttname"><a href="../../d3/d3a/a02259.html#ae7a3106c6bef5edbff79f9e203c7ccf4">GENERIC_WRITE</a></div><div class="ttdeci">#define GENERIC_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00164">ntseapi.h:164</a></div></div>
<div class="ttc" id="a02285_html_a63eebbbf41ac0a1f0001273f954797f1"><div class="ttname"><a href="../../df/d4d/a02285.html#a63eebbbf41ac0a1f0001273f954797f1">Propagate</a></div><div class="ttdeci">#define Propagate(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00217">seopaque.h:217</a></div></div>
<div class="ttc" id="a00533_html"><div class="ttname"><a href="../../db/d44/a00533.html">_GUID</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dc3/a02190_source.html#l00025">guiddef.h:25</a></div></div>
<div class="ttc" id="a02230_html_ab27e8a5903617bec9d037e4039ac00a7"><div class="ttname"><a href="../../dd/d67/a02230.html#ab27e8a5903617bec9d037e4039ac00a7">PVOID</a></div><div class="ttdeci">void * PVOID</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00245">ntdef.h:245</a></div></div>
<div class="ttc" id="a02665_html_aca9d2d6e5e92dfba581e9b618fbc7aa2"><div class="ttname"><a href="../../d3/d32/a02665.html#aca9d2d6e5e92dfba581e9b618fbc7aa2">RtlCreateSecurityDescriptorRelative</a></div><div class="ttdeci">NTSTATUS RtlCreateSecurityDescriptorRelative(IN PISECURITY_DESCRIPTOR_RELATIVE SecurityDescriptor, IN ULONG Revision)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01869">sertl.c:1869</a></div></div>
<div class="ttc" id="a02260_html_af0ac76339079fd1133253822f542f093"><div class="ttname"><a href="../../dc/d18/a02260.html#af0ac76339079fd1133253822f542f093">STATUS_LOGON_FAILURE</a></div><div class="ttdeci">#define STATUS_LOGON_FAILURE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02523">ntstatus.h:2523</a></div></div>
<div class="ttc" id="a02259_html_a28a40ba853d20ecf9ac183c572c2cace"><div class="ttname"><a href="../../d3/d3a/a02259.html#a28a40ba853d20ecf9ac183c572c2cace">NtOpenProcessToken</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtOpenProcessToken(__in HANDLE ProcessHandle, __in ACCESS_MASK DesiredAccess, __out PHANDLE TokenHandle)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc1/a02706_source.html#l00182">tokenopn.c:182</a></div></div>
<div class="ttc" id="a01587_html_ab1b034a228453e3f05652446180272a3"><div class="ttname"><a href="../../d6/d91/a01587.html#ab1b034a228453e3f05652446180272a3">_SECURITY_DESCRIPTOR_RELATIVE::Dacl</a></div><div class="ttdeci">ULONG Dacl</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01170">ntseapi.h:1170</a></div></div>
<div class="ttc" id="a02259_html_a923cbf88fdb4b0381d8e3c837656c0b2"><div class="ttname"><a href="../../d3/d3a/a02259.html#a923cbf88fdb4b0381d8e3c837656c0b2">SECURITY_INFORMATION</a></div><div class="ttdeci">ULONG SECURITY_INFORMATION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01771">ntseapi.h:1771</a></div></div>
<div class="ttc" id="a02259_html_ae3bf1a31d65e4d15c09a8cd24dc0c0c2"><div class="ttname"><a href="../../d3/d3a/a02259.html#ae3bf1a31d65e4d15c09a8cd24dc0c0c2">SECURITY_CREATOR_SID_AUTHORITY</a></div><div class="ttdeci">#define SECURITY_CREATOR_SID_AUTHORITY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00315">ntseapi.h:315</a></div></div>
<div class="ttc" id="a01625_html"><div class="ttname"><a href="../../d3/d2d/a01625.html">_SID_AND_ATTRIBUTES</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00286">ntseapi.h:286</a></div></div>
<div class="ttc" id="a02284_html_a1e26855b314a730c9adf39f1c9681a28"><div class="ttname"><a href="../../d3/d81/a02284.html#a1e26855b314a730c9adf39f1c9681a28">SePrivilegedServiceAuditAlarm</a></div><div class="ttdeci">VOID SePrivilegedServiceAuditAlarm(__in_opt PUNICODE_STRING ServiceName, __in PSECURITY_SUBJECT_CONTEXT SubjectSecurityContext, __in PPRIVILEGE_SET Privileges, __in BOOLEAN AccessGranted)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d50/a02694_source.html#l00944">seaudit.c:944</a></div></div>
<div class="ttc" id="a01585_html_aed1f892c4fab4b52b60ac0e13a412036"><div class="ttname"><a href="../../da/de2/a01585.html#aed1f892c4fab4b52b60ac0e13a412036">_SECURITY_DESCRIPTOR::Group</a></div><div class="ttdeci">PSID Group</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01178">ntseapi.h:1178</a></div></div>
<div class="ttc" id="a02259_html_af61ec68f6a67fc6167e4eabd117b2b3b"><div class="ttname"><a href="../../d3/d3a/a02259.html#af61ec68f6a67fc6167e4eabd117b2b3b">GENERIC_EXECUTE</a></div><div class="ttdeci">#define GENERIC_EXECUTE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00165">ntseapi.h:165</a></div></div>
<div class="ttc" id="a00889_html"><div class="ttname"><a href="../../de/dc8/a00889.html">_LUID</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00710">ntdef.h:710</a></div></div>
<div class="ttc" id="a01587_html_aae3a91931713ea8423d18fd741958388"><div class="ttname"><a href="../../d6/d91/a01587.html#aae3a91931713ea8423d18fd741958388">_SECURITY_DESCRIPTOR_RELATIVE::Sbz1</a></div><div class="ttdeci">UCHAR Sbz1</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01165">ntseapi.h:1165</a></div></div>
<div class="ttc" id="a00789_html"><div class="ttname"><a href="../../d8/d7d/a00789.html">_KNOWN_ACE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00037">seopaque.h:37</a></div></div>
<div class="ttc" id="a02285_html_a04acd8f53b74f93ad3d3ca6d0fee9d09"><div class="ttname"><a href="../../df/d4d/a02285.html#a04acd8f53b74f93ad3d3ca6d0fee9d09">SEP_ACL_PROTECTED</a></div><div class="ttdeci">#define SEP_ACL_PROTECTED</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00285">seopaque.h:285</a></div></div>
<div class="ttc" id="a02295_html_ac9437f211fcbadca93fa8eb40727b2ae"><div class="ttname"><a href="../../dd/da4/a02295.html#ac9437f211fcbadca93fa8eb40727b2ae">wcscpy</a></div><div class="ttdeci">#define wcscpy</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/da4/a02295_source.html#l07630">strsafe.h:7630</a></div></div>
<div class="ttc" id="a02306_html_a127027368b7a96197888884e97578e12"><div class="ttname"><a href="../../d3/dc5/a02306.html#a127027368b7a96197888884e97578e12">SEC_E_INVALID_HANDLE</a></div><div class="ttdeci">#define SEC_E_INVALID_HANDLE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22334">winerror.h:22334</a></div></div>
<div class="ttc" id="a02285_html_a3913167c97d0ee8d8a425cc0bcfc32eb"><div class="ttname"><a href="../../df/d4d/a02285.html#a3913167c97d0ee8d8a425cc0bcfc32eb">SEP_ACL_PRESENT</a></div><div class="ttdeci">#define SEP_ACL_PRESENT</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00282">seopaque.h:282</a></div></div>
<div class="ttc" id="a00817_html_a8d85c43a1b619b2007d193acce0f1d55"><div class="ttname"><a href="../../dc/d5e/a00817.html#a8d85c43a1b619b2007d193acce0f1d55">_LARGE_INTEGER::LowPart</a></div><div class="ttdeci">ULONG LowPart</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00672">ntdef.h:672</a></div></div>
<div class="ttc" id="a02665_html_a52107cd63fea68e76ce730007c6657a8"><div class="ttname"><a href="../../d3/d32/a02665.html#a52107cd63fea68e76ce730007c6657a8">RtlGetDaclSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlGetDaclSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PBOOLEAN DaclPresent, OUT PACL *Dacl, OUT PBOOLEAN DaclDefaulted)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02409">sertl.c:2409</a></div></div>
<div class="ttc" id="a02230_html_a6a08ef8cc8945e56aaba56e0c8f194eb"><div class="ttname"><a href="../../dd/d67/a02230.html#a6a08ef8cc8945e56aaba56e0c8f194eb">NTSTATUS</a></div><div class="ttdeci">LONG NTSTATUS</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00534">ntdef.h:534</a></div></div>
<div class="ttc" id="a01235_html_a9fe901e278495c5490b3288d26636482"><div class="ttname"><a href="../../dd/dad/a01235.html#a9fe901e278495c5490b3288d26636482">_OBJECT_ATTRIBUTES::SecurityQualityOfService</a></div><div class="ttdeci">PVOID SecurityQualityOfService</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01219">ntdef.h:1219</a></div></div>
<div class="ttc" id="a02285_html_ae331f8cb230765ba3962c1fbeb6776f6"><div class="ttname"><a href="../../df/d4d/a02285.html#ae331f8cb230765ba3962c1fbeb6776f6">RtlpIsEqualGuid</a></div><div class="ttdeci">#define RtlpIsEqualGuid(rguid1, rguid2)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00267">seopaque.h:267</a></div></div>
<div class="ttc" id="a00012_html_a842f42715e3dc03478cc15e7b3f6fb51"><div class="ttname"><a href="../../df/d86/a00012.html#a842f42715e3dc03478cc15e7b3f6fb51">_ACE_HEADER::AceSize</a></div><div class="ttdeci">USHORT AceSize</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00690">ntseapi.h:690</a></div></div>
<div class="ttc" id="a02665_html_a9d96ec468d2cb368fef87dfecedbd132"><div class="ttname"><a href="../../d3/d32/a02665.html#a9d96ec468d2cb368fef87dfecedbd132">RtlCopyLuidAndAttributesArray</a></div><div class="ttdeci">VOID RtlCopyLuidAndAttributesArray(IN ULONG ArrayLength, IN PLUID_AND_ATTRIBUTES Source, OUT PLUID_AND_ATTRIBUTES Target)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01761">sertl.c:1761</a></div></div>
<div class="ttc" id="a01776_html_afbc2ba2b7be88d0118e683a2eb289795"><div class="ttname"><a href="../../dd/d00/a01776.html#afbc2ba2b7be88d0118e683a2eb289795">_UNICODE_STRING::Buffer</a></div><div class="ttdeci">PWSTR Buffer</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01049">ntdef.h:1049</a></div></div>
<div class="ttc" id="a00013_html_af0530f532005a2073a721e492f92afd1"><div class="ttname"><a href="../../d7/dd4/a00013.html#af0530f532005a2073a721e492f92afd1">_ACL::AclRevision</a></div><div class="ttdeci">UCHAR AclRevision</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00659">ntseapi.h:659</a></div></div>
<div class="ttc" id="a02259_html_aa3ccd781d22af696976f185ecefa0f47"><div class="ttname"><a href="../../d3/d3a/a02259.html#aa3ccd781d22af696976f185ecefa0f47">SECURITY_DESCRIPTOR_REVISION</a></div><div class="ttdeci">#define SECURITY_DESCRIPTOR_REVISION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01045">ntseapi.h:1045</a></div></div>
<div class="ttc" id="a02259_html_a2e2488a35875361c69e64f983bdbcbe2"><div class="ttname"><a href="../../d3/d3a/a02259.html#a2e2488a35875361c69e64f983bdbcbe2">NtQueryInformationToken</a></div><div class="ttdeci">NTSYSCALLAPI NTSTATUS NTAPI NtQueryInformationToken(__in HANDLE TokenHandle, __in TOKEN_INFORMATION_CLASS TokenInformationClass, __out_bcount_part_opt(TokenInformationLength,*ReturnLength) PVOID TokenInformation, __in ULONG TokenInformationLength, __out PULONG ReturnLength)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d73/a02708_source.html#l00034">tokenqry.c:34</a></div></div>
<div class="ttc" id="a02230_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="../../dd/d67/a02230.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01270">ntdef.h:1270</a></div></div>
<div class="ttc" id="a01587_html_a5766dc6ae7409fedf88a0e7a263cb8ca"><div class="ttname"><a href="../../d6/d91/a01587.html#a5766dc6ae7409fedf88a0e7a263cb8ca">_SECURITY_DESCRIPTOR_RELATIVE::Owner</a></div><div class="ttdeci">ULONG Owner</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01167">ntseapi.h:1167</a></div></div>
<div class="ttc" id="a02259_html_a32d3148156b1ae54bcc5a68c59cc27e7"><div class="ttname"><a href="../../d3/d3a/a02259.html#a32d3148156b1ae54bcc5a68c59cc27e7">TOKEN_ADJUST_PRIVILEGES</a></div><div class="ttdeci">#define TOKEN_ADJUST_PRIVILEGES</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01474">ntseapi.h:1474</a></div></div>
<div class="ttc" id="a02665_html_a82c0b2b867d832998adbf9018b8cab95"><div class="ttname"><a href="../../d3/d32/a02665.html#a82c0b2b867d832998adbf9018b8cab95">EFFECTIVE_ACE</a></div><div class="ttdeci">#define EFFECTIVE_ACE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06489">sertl.c:6489</a></div></div>
<div class="ttc" id="a01406_html_a3df45b81acf2a35fe9ed114238adc49b"><div class="ttname"><a href="../../dc/d25/a01406.html#a3df45b81acf2a35fe9ed114238adc49b">_PRIVILEGE_SET::Control</a></div><div class="ttdeci">ULONG Control</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01308">ntseapi.h:1308</a></div></div>
<div class="ttc" id="a02259_html_a0841cdb9e3ad77ad9a0fe50e05026401"><div class="ttname"><a href="../../d3/d3a/a02259.html#a0841cdb9e3ad77ad9a0fe50e05026401">SECURITY_IMPERSONATION_LEVEL</a></div><div class="ttdeci">enum _SECURITY_IMPERSONATION_LEVEL SECURITY_IMPERSONATION_LEVEL</div></div>
<div class="ttc" id="a02306_html_a4ef54e5314157491ca49e206b87a2913"><div class="ttname"><a href="../../d3/dc5/a02306.html#a4ef54e5314157491ca49e206b87a2913">SEC_E_UNKNOWN_CREDENTIALS</a></div><div class="ttdeci">#define SEC_E_UNKNOWN_CREDENTIALS</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22442">winerror.h:22442</a></div></div>
<div class="ttc" id="a02259_html_a28ecb45729f526c980a209c524cb8eb2"><div class="ttname"><a href="../../d3/d3a/a02259.html#a28ecb45729f526c980a209c524cb8eb2">ACE_INHERITED_OBJECT_TYPE_PRESENT</a></div><div class="ttdeci">#define ACE_INHERITED_OBJECT_TYPE_PRESENT</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00989">ntseapi.h:989</a></div></div>
<div class="ttc" id="a02285_html_aad434d64fabed59aebb1581338b289b2"><div class="ttname"><a href="../../df/d4d/a02285.html#aad434d64fabed59aebb1581338b289b2">SeControlGenericToDacl</a></div><div class="ttdeci">#define SeControlGenericToDacl(_Generic)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00296">seopaque.h:296</a></div></div>
<div class="ttc" id="a02665_html_a1260d74eed143f5ac73b7028c66d6fef"><div class="ttname"><a href="../../d3/d32/a02665.html#a1260d74eed143f5ac73b7028c66d6fef">RtlImpersonateSelf</a></div><div class="ttdeci">NTSTATUS RtlImpersonateSelf(IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l03284">sertl.c:3284</a></div></div>
<div class="ttc" id="a01587_html_a231977cf2e132d03efed8c0829cc1ef1"><div class="ttname"><a href="../../d6/d91/a01587.html#a231977cf2e132d03efed8c0829cc1ef1">_SECURITY_DESCRIPTOR_RELATIVE::Sacl</a></div><div class="ttdeci">ULONG Sacl</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01169">ntseapi.h:1169</a></div></div>
<div class="ttc" id="a02665_html_ae287d11feff6112c5228b7d654f16fed"><div class="ttname"><a href="../../d3/d32/a02665.html#ae287d11feff6112c5228b7d654f16fed">RtlpCompareAces</a></div><div class="ttdeci">BOOLEAN RtlpCompareAces(IN PKNOWN_ACE InheritedAce, IN PKNOWN_ACE ChildAce, IN PSID OwnerSid, IN PSID GroupSid)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l06496">sertl.c:6496</a></div></div>
<div class="ttc" id="a02285_html_a98554c18dfa57f50b0f0a83aa790a773"><div class="ttname"><a href="../../df/d4d/a02285.html#a98554c18dfa57f50b0f0a83aa790a773">SEP_ACL_DEFAULTED</a></div><div class="ttdeci">#define SEP_ACL_DEFAULTED</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00283">seopaque.h:283</a></div></div>
<div class="ttc" id="a02285_html_ac8e0a4c85a16a9dc80eecaa9f1ad4139"><div class="ttname"><a href="../../df/d4d/a02285.html#ac8e0a4c85a16a9dc80eecaa9f1ad4139">IsKnownAceType</a></div><div class="ttdeci">#define IsKnownAceType(Ace)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/a02285_source.html#l00148">seopaque.h:148</a></div></div>
<div class="ttc" id="a01625_html_a65626cb95688165a5d004e32a6e48d48"><div class="ttname"><a href="../../d3/d2d/a01625.html#a65626cb95688165a5d004e32a6e48d48">_SID_AND_ATTRIBUTES::Sid</a></div><div class="ttdeci">PSID Sid</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00287">ntseapi.h:287</a></div></div>
<div class="ttc" id="a02230_html_a4e5982714d855e34fa8dd0ad6b0f3682"><div class="ttname"><a href="../../dd/d67/a02230.html#a4e5982714d855e34fa8dd0ad6b0f3682">SECURITY_STATUS</a></div><div class="ttdeci">long SECURITY_STATUS</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00599">ntdef.h:599</a></div></div>
<div class="ttc" id="a02230_html_a24942bbad7305d37494f03b13e6d4471"><div class="ttname"><a href="../../dd/d67/a02230.html#a24942bbad7305d37494f03b13e6d4471">FIELD_OFFSET</a></div><div class="ttdeci">#define FIELD_OFFSET(type, field)    </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01321">ntdef.h:1321</a></div></div>
<div class="ttc" id="a02306_html_aba38e12cb68a39555dd1642be58713cd"><div class="ttname"><a href="../../d3/dc5/a02306.html#aba38e12cb68a39555dd1642be58713cd">SEC_E_NO_CREDENTIALS</a></div><div class="ttdeci">#define SEC_E_NO_CREDENTIALS</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22451">winerror.h:22451</a></div></div>
<div class="ttc" id="a02286_html_a68f9703a2b7229281827e1d5bc9a530a"><div class="ttname"><a href="../../db/d2d/a02286.html#a68f9703a2b7229281827e1d5bc9a530a">RtlpOwnerAddrSecurityDescriptor</a></div><div class="ttdeci">#define RtlpOwnerAddrSecurityDescriptor(SD)                                                                </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00059">sertlp.h:59</a></div></div>
<div class="ttc" id="a02244_html_a78212918c5b09e3304c1d3c041ba3a1a"><div class="ttname"><a href="../../d8/d51/a02244.html#a78212918c5b09e3304c1d3c041ba3a1a">OPTIONAL</a></div><div class="ttdeci">IN PLSA_DISPATCH_TABLE IN PLSA_STRING Database OPTIONAL</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d51/a02244_source.html#l01130">ntlsa.h:1130</a></div></div>
<div class="ttc" id="a02286_html"><div class="ttname"><a href="../../db/d2d/a02286.html">sertlp.h</a></div></div>
<div class="ttc" id="a02259_html_a221dec3e6c6a013ff8f7025db178ef27"><div class="ttname"><a href="../../d3/d3a/a02259.html#a221dec3e6c6a013ff8f7025db178ef27">SE_SACL_PROTECTED</a></div><div class="ttdeci">#define SE_SACL_PROTECTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01071">ntseapi.h:1071</a></div></div>
<div class="ttc" id="a02259_html_a2c99dbbbae1f21757cf867d6ba243e30"><div class="ttname"><a href="../../d3/d3a/a02259.html#a2c99dbbbae1f21757cf867d6ba243e30">SE_DACL_AUTO_INHERITED</a></div><div class="ttdeci">#define SE_DACL_AUTO_INHERITED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01068">ntseapi.h:1068</a></div></div>
<div class="ttc" id="a01745_html"><div class="ttname"><a href="../../d0/d78/a01745.html">_TOKEN_OWNER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01567">ntseapi.h:1567</a></div></div>
<div class="ttc" id="a02259_html_a39e75889cffac1a2830c354f27ea1b43"><div class="ttname"><a href="../../d3/d3a/a02259.html#a39e75889cffac1a2830c354f27ea1b43">SE_SERVER_SECURITY</a></div><div class="ttdeci">#define SE_SERVER_SECURITY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01064">ntseapi.h:1064</a></div></div>
<div class="ttc" id="a01776_html_ae0487ecc173e55918bcee834bd3d107b"><div class="ttname"><a href="../../dd/d00/a01776.html#ae0487ecc173e55918bcee834bd3d107b">_UNICODE_STRING::MaximumLength</a></div><div class="ttdeci">USHORT MaximumLength</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l01045">ntdef.h:1045</a></div></div>
<div class="ttc" id="a02259_html_a0d38ac1ff4d6cc3b7f3b7bb1243db7c7"><div class="ttname"><a href="../../d3/d3a/a02259.html#a0d38ac1ff4d6cc3b7f3b7bb1243db7c7">SE_OWNER_DEFAULTED</a></div><div class="ttdeci">#define SE_OWNER_DEFAULTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01056">ntseapi.h:1056</a></div></div>
<div class="ttc" id="a02665_html_ae8c3c728ed523a360f4bc63995385074"><div class="ttname"><a href="../../d3/d32/a02665.html#ae8c3c728ed523a360f4bc63995385074">RtlLengthRequiredSid</a></div><div class="ttdeci">ULONG RtlLengthRequiredSid(IN ULONG SubAuthorityCount)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01032">sertl.c:1032</a></div></div>
<div class="ttc" id="a02230_html_aec78e7a9e90a406a56f859ee456e8eae"><div class="ttname"><a href="../../dd/d67/a02230.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a></div><div class="ttdeci">#define OUT</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00035">ntdef.h:35</a></div></div>
<div class="ttc" id="a02260_html_ad61c566fa6f03ba2aa2d05700cdc5ea5"><div class="ttname"><a href="../../dc/d18/a02260.html#ad61c566fa6f03ba2aa2d05700cdc5ea5">STATUS_INVALID_PRIMARY_GROUP</a></div><div class="ttdeci">#define STATUS_INVALID_PRIMARY_GROUP</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l02359">ntstatus.h:2359</a></div></div>
<div class="ttc" id="a02665_html_a7709180d5aabe3a5e90ddb1baed750d5"><div class="ttname"><a href="../../d3/d32/a02665.html#a7709180d5aabe3a5e90ddb1baed750d5">RtlGetOwnerSecurityDescriptor</a></div><div class="ttdeci">NTSTATUS RtlGetOwnerSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSID *Owner, OUT PBOOLEAN OwnerDefaulted)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l02803">sertl.c:2803</a></div></div>
<div class="ttc" id="a02259_html_a835b909110f55ce5de0cb58fbf9bdf94"><div class="ttname"><a href="../../d3/d3a/a02259.html#a835b909110f55ce5de0cb58fbf9bdf94">OBJECT_INHERIT_ACE</a></div><div class="ttdeci">#define OBJECT_INHERIT_ACE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00740">ntseapi.h:740</a></div></div>
<div class="ttc" id="a02260_html_ae56fdb340b23940f7a64ed2e37c1774a"><div class="ttname"><a href="../../dc/d18/a02260.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a></div><div class="ttdeci">#define STATUS_SUCCESS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l00049">ntstatus.h:49</a></div></div>
<div class="ttc" id="a02665_html_aac77f8c085cee324134056c01f2a53db"><div class="ttname"><a href="../../d3/d32/a02665.html#aac77f8c085cee324134056c01f2a53db">RtlEraseUnicodeString</a></div><div class="ttdeci">VOID RtlEraseUnicodeString(PUNICODE_STRING String)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00616">sertl.c:616</a></div></div>
<div class="ttc" id="a02259_html_aee2bff13c4932aa2d9ae985b2a1f5875"><div class="ttname"><a href="../../d3/d3a/a02259.html#aee2bff13c4932aa2d9ae985b2a1f5875">SECURITY_CREATOR_GROUP_RID</a></div><div class="ttdeci">#define SECURITY_CREATOR_GROUP_RID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00324">ntseapi.h:324</a></div></div>
<div class="ttc" id="a02259_html_a911c5eb0d303a067bfbf304139b90bec"><div class="ttname"><a href="../../d3/d3a/a02259.html#a911c5eb0d303a067bfbf304139b90bec">GENERIC_READ</a></div><div class="ttdeci">#define GENERIC_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00163">ntseapi.h:163</a></div></div>
<div class="ttc" id="a02259_html_ad0a23f15b31cfde28fd99cd0cee99d20"><div class="ttname"><a href="../../d3/d3a/a02259.html#ad0a23f15b31cfde28fd99cd0cee99d20">SID_MAX_SUB_AUTHORITIES</a></div><div class="ttdeci">#define SID_MAX_SUB_AUTHORITIES</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00264">ntseapi.h:264</a></div></div>
<div class="ttc" id="a02260_html_a977e3e5c6f2215f7aff3763d08ad0442"><div class="ttname"><a href="../../dc/d18/a02260.html#a977e3e5c6f2215f7aff3763d08ad0442">STATUS_BAD_NETWORK_PATH</a></div><div class="ttdeci">#define STATUS_BAD_NETWORK_PATH</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l03279">ntstatus.h:3279</a></div></div>
<div class="ttc" id="a02665_html_abbcf18c127f373737f0718995a2467fc"><div class="ttname"><a href="../../d3/d32/a02665.html#abbcf18c127f373737f0718995a2467fc">CREATOR_SID_SIZE</a></div><div class="ttdeci">#define CREATOR_SID_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l00329">sertl.c:329</a></div></div>
<div class="ttc" id="a02259_html_a8d0e3871ec8a12b6bcda7c0858ba64be"><div class="ttname"><a href="../../d3/d3a/a02259.html#a8d0e3871ec8a12b6bcda7c0858ba64be">SE_DACL_UNTRUSTED</a></div><div class="ttdeci">#define SE_DACL_UNTRUSTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01063">ntseapi.h:1063</a></div></div>
<div class="ttc" id="a01589_html"><div class="ttname"><a href="../../d7/d29/a01589.html">_SECURITY_QUALITY_OF_SERVICE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01707">ntseapi.h:1707</a></div></div>
<div class="ttc" id="a02259_html_a198a439317e2511cd5f3e09472e903eaa13321ee2555d06f3c7dee5fdf2fc36aa"><div class="ttname"><a href="../../d3/d3a/a02259.html#a198a439317e2511cd5f3e09472e903eaa13321ee2555d06f3c7dee5fdf2fc36aa">TokenImpersonation</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01515">ntseapi.h:1515</a></div></div>
<div class="ttc" id="a02306_html_a6eb360050ffcd1576d48120c77249c3c"><div class="ttname"><a href="../../d3/dc5/a02306.html#a6eb360050ffcd1576d48120c77249c3c">SEC_E_BAD_PKGID</a></div><div class="ttdeci">#define SEC_E_BAD_PKGID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22523">winerror.h:22523</a></div></div>
<div class="ttc" id="a02286_html_a16277294a616a48692ab4f2913fa1834"><div class="ttname"><a href="../../db/d2d/a02286.html#a16277294a616a48692ab4f2913fa1834">RtlpSetControlBits</a></div><div class="ttdeci">#define RtlpSetControlBits(SD, Bits)                                                                                      </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00137">sertlp.h:137</a></div></div>
<div class="ttc" id="a02259_html_a028070e7db6ceff42020d0021d503f92"><div class="ttname"><a href="../../d3/d3a/a02259.html#a028070e7db6ceff42020d0021d503f92">SPECIFIC_RIGHTS_ALL</a></div><div class="ttdeci">#define SPECIFIC_RIGHTS_ALL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l00145">ntseapi.h:145</a></div></div>
<div class="ttc" id="a02306_html_a3e9be4fa173e288f3f5b2674c6e6c218"><div class="ttname"><a href="../../d3/dc5/a02306.html#a3e9be4fa173e288f3f5b2674c6e6c218">SEC_E_CANNOT_INSTALL</a></div><div class="ttdeci">#define SEC_E_CANNOT_INSTALL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22388">winerror.h:22388</a></div></div>
<div class="ttc" id="a01585_html_a4e7f873aebc6462ff1e07b387b11c782"><div class="ttname"><a href="../../da/de2/a01585.html#a4e7f873aebc6462ff1e07b387b11c782">_SECURITY_DESCRIPTOR::Sbz1</a></div><div class="ttdeci">UCHAR Sbz1</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01175">ntseapi.h:1175</a></div></div>
<div class="ttc" id="a02665_html_ad2ade6a49301fb4ec6e67d9ed18d2012"><div class="ttname"><a href="../../d3/d32/a02665.html#ad2ade6a49301fb4ec6e67d9ed18d2012">RtlpSetSecurityObject</a></div><div class="ttdeci">NTSTATUS RtlpSetSecurityObject(IN PVOID Object OPTIONAL, IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN ULONG AutoInheritFlags, IN ULONG PoolType, IN PGENERIC_MAPPING GenericMapping, IN HANDLE Token OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l09280">sertl.c:9280</a></div></div>
<div class="ttc" id="a02230_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="../../dd/d67/a02230.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00392">ntdef.h:392</a></div></div>
<div class="ttc" id="a02665_html_aa7894911d24d33ceed9f7b781bbe81ca"><div class="ttname"><a href="../../d3/d32/a02665.html#aa7894911d24d33ceed9f7b781bbe81ca">RtlValidRelativeSecurityDescriptor</a></div><div class="ttdeci">BOOLEAN RtlValidRelativeSecurityDescriptor(IN PSECURITY_DESCRIPTOR SecurityDescriptorInput, IN ULONG SecurityDescriptorLength, IN SECURITY_INFORMATION RequiredInformation)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l10066">sertl.c:10066</a></div></div>
<div class="ttc" id="a02259_html_afc7989ff9142b3067e6580ffdfdc5ee0"><div class="ttname"><a href="../../d3/d3a/a02259.html#afc7989ff9142b3067e6580ffdfdc5ee0">PSECURITY_DESCRIPTOR_CONTROL</a></div><div class="ttdeci">USHORT * PSECURITY_DESCRIPTOR_CONTROL</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01054">ntseapi.h:1054</a></div></div>
<div class="ttc" id="a02665_html_aaffde88bf4e473523c3f45c208dd97b3"><div class="ttname"><a href="../../d3/d32/a02665.html#aaffde88bf4e473523c3f45c208dd97b3">RtlpGenerateInheritedAce</a></div><div class="ttdeci">NTSTATUS RtlpGenerateInheritedAce(IN PACE_HEADER OldAce, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID **pNewObjectType OPTIONAL, IN ULONG GuidCount, OUT PULONG NewAceLength, OUT PACL NewAcl, OUT PULONG NewAceExtraLength, OUT PBOOLEAN ObjectAceInherited)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l04949">sertl.c:4949</a></div></div>
<div class="ttc" id="a01589_html_ac099321a3499f22a14c36b43ae5fcaf1"><div class="ttname"><a href="../../d7/d29/a01589.html#ac099321a3499f22a14c36b43ae5fcaf1">_SECURITY_QUALITY_OF_SERVICE::EffectiveOnly</a></div><div class="ttdeci">BOOLEAN EffectiveOnly</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01711">ntseapi.h:1711</a></div></div>
<div class="ttc" id="a02286_html_a52b78c0ccc1a141bb2f0912ae90fb1be"><div class="ttname"><a href="../../db/d2d/a02286.html#a52b78c0ccc1a141bb2f0912ae90fb1be">RtlpDaclAddrSecurityDescriptor</a></div><div class="ttdeci">#define RtlpDaclAddrSecurityDescriptor(SD)                                                                  </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d2d/a02286_source.html#l00086">sertlp.h:86</a></div></div>
<div class="ttc" id="a02665_html_a235054d7359a2e66ba38689cb2793f31"><div class="ttname"><a href="../../d3/d32/a02665.html#a235054d7359a2e66ba38689cb2793f31">RtlLengthSidAsUnicodeString</a></div><div class="ttdeci">NTSTATUS RtlLengthSidAsUnicodeString(PSID Sid, PULONG StringLength)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01393">sertl.c:1393</a></div></div>
<div class="ttc" id="a02306_html_a7d6ef79476c5e09375033be85404a66b"><div class="ttname"><a href="../../d3/dc5/a02306.html#a7d6ef79476c5e09375033be85404a66b">SEC_E_SECPKG_NOT_FOUND</a></div><div class="ttdeci">#define SEC_E_SECPKG_NOT_FOUND</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22370">winerror.h:22370</a></div></div>
<div class="ttc" id="a02306_html_abbbdcce8a976349b4e60a751d797bf1f"><div class="ttname"><a href="../../d3/dc5/a02306.html#abbbdcce8a976349b4e60a751d797bf1f">SEC_E_QOP_NOT_SUPPORTED</a></div><div class="ttdeci">#define SEC_E_QOP_NOT_SUPPORTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc5/a02306_source.html#l22415">winerror.h:22415</a></div></div>
<div class="ttc" id="a02230_html_aad61bc3eae1804d8784adebdce0721d3"><div class="ttname"><a href="../../dd/d67/a02230.html#aad61bc3eae1804d8784adebdce0721d3">WCHAR</a></div><div class="ttdeci">wchar_t WCHAR</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d67/a02230_source.html#l00298">ntdef.h:298</a></div></div>
<div class="ttc" id="a01406_html_acf053936624411d4a0b7370693299e9e"><div class="ttname"><a href="../../dc/d25/a01406.html#acf053936624411d4a0b7370693299e9e">_PRIVILEGE_SET::PrivilegeCount</a></div><div class="ttdeci">ULONG PrivilegeCount</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d3a/a02259_source.html#l01307">ntseapi.h:1307</a></div></div>
<div class="ttc" id="a02260_html_ace23dcb864057a35543fff393324c3f3"><div class="ttname"><a href="../../dc/d18/a02260.html#ace23dcb864057a35543fff393324c3f3">STATUS_BUFFER_OVERFLOW</a></div><div class="ttdeci">#define STATUS_BUFFER_OVERFLOW</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d18/a02260_source.html#l01101">ntstatus.h:1101</a></div></div>
<div class="ttc" id="a02665_html_a1cd820410584c7e025a9433b91ea2143"><div class="ttname"><a href="../../d3/d32/a02665.html#a1cd820410584c7e025a9433b91ea2143">RtlInitializeSid</a></div><div class="ttdeci">NTSTATUS RtlInitializeSid(IN PSID Sid, IN PSID_IDENTIFIER_AUTHORITY IdentifierAuthority, IN UCHAR SubAuthorityCount)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l01063">sertl.c:1063</a></div></div>
<div class="ttc" id="a02665_html_afde17e8941f81fff1936c74ed0f7371c"><div class="ttname"><a href="../../d3/d32/a02665.html#afde17e8941f81fff1936c74ed0f7371c">RtlSetSecurityDescriptorRMControl</a></div><div class="ttdeci">VOID RtlSetSecurityDescriptorRMControl(IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN PUCHAR RMControl OPTIONAL)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d32/a02665_source.html#l10396">sertl.c:10396</a></div></div>
<div class="ttc" id="a02259_html_ad30a32f32e06e7bb16b53e0a443eb289"><div class="ttname"><a href="../../d3/d3a/a02259.html#ad30a32f32e06e7bb16b53e0a443eb289">PISID</a></div><div class="ttdeci">struct _SID * PISID</div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_f22a2235bfed9e7f28226e9ee4e6031c.html">Windows Research Kernel</a></li><li class="navelem"><a class="el" href="../../dir_eeefa60baf8e41a16f58bd86296afaa1.html">rtl</a></li><li class="navelem"><a class="el" href="../../d3/d32/a02665.html">sertl.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
